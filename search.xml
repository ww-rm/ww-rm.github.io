<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>åº</title>
    <url>//posts/2021/05/21/prologue/</url>
    <content><![CDATA[<blockquote class="blockquote-center">
<p>å­”å­äº‘ï¼šä½•é™‹ä¹‹æœ‰ï¼Ÿ</p>

</blockquote>
]]></content>
      <categories>
        <category>åº</category>
      </categories>
      <tags>
        <tag>åº</tag>
      </tags>
  </entry>
  <entry>
    <title>å®‰å“ APK é‡æ‰“åŒ…</title>
    <url>//posts/2024/07/09/apkrepack/</url>
    <content><![CDATA[<p>ä¸ºäº†ç”¨ Simpleperf åœ¨é root æœºä¸Šè¿›è¡Œæ€§èƒ½åˆ†æ, éœ€è¦åœ¨ apk çš„æ¸…å•æ–‡ä»¶ä¸­è®¾ç½® <code>android:debuggable=&quot;true&quot;</code> çš„æ ‡è®°, å› æ­¤ç ”ç©¶äº†ä¸€ä¸‹æ€ä¹ˆå¯¹ apk è¿›è¡Œé‡æ‰“åŒ…, å¯¹ä¿®æ”¹åçš„åŒ…è¿›è¡Œæ€§èƒ½åˆ†æ.</p>
<p>æœ¬æ–‡å‚è€ƒ<span class="exturl" data-url="aHR0cHM6Ly9jcmlmYW4uZ2l0aHViLmlvL2FuZHJvaWRfcmVfcmVwYWNrX2Fway93ZWJzaXRlL3JlcGFja19wcm9jZXNzLw==">é‡æ–°æ‰“åŒ…apkæµç¨‹<i class="fa fa-external-link-alt"></i></span>.</p>
<span id="more"></span>

<h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><p>é‡æ‰“åŒ…å¤§æ¦‚åˆ†æˆå‡ ä¸ªæ­¥éª¤:</p>
<ol>
<li>è§£åŒ…</li>
<li>ä¿®æ”¹åŒ…ä½“</li>
<li>é‡æ‰“åŒ…</li>
<li>å¯¹é½</li>
<li>é‡ç­¾å</li>
</ol>
<p>é¡ºåºå¾ˆé‡è¦, ç­¾åçš„æ­¥éª¤ä¸€å®šæ˜¯æœ€åå®Œæˆ.</p>
<p>å…¶ä¸­è§£åŒ…å’Œé‡æ‰“åŒ…ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9hcGt0b29sLm9yZy8=">apktool<i class="fa fa-external-link-alt"></i></span> è§£å†³.</p>
<p>ä¿®æ”¹åŒ…ä½“å¯ä»¥è‡ªå·±æŒ‰éœ€æ‰‹åŠ¨æˆ–è€…è„šæœ¬ä¿®æ”¹.</p>
<p>å¯¹é½å’Œé‡ç­¾ååˆ†åˆ«ç”¨ Android Sdk çš„ build-tools é‡Œçš„ <code>zipalign.exe</code> å’Œ <code>apksigner.jar</code> å®Œæˆ.</p>
<p>ä¸Šè¿°æåˆ°çš„å·¥å…·éƒ½å¯ä»¥é€šè¿‡ <code>--help</code> æŸ¥çœ‹ç”¨æ³•, æ¯”è¾ƒç®€å•.</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯é‡ç­¾åçš„æ—¶å€™éœ€è¦ç”¨ java è‡ªå¸¦çš„å·¥å…· <code>keytool</code> ç”Ÿæˆä¸€ä»½è‡ªç­¾åçš„è¯ä¹¦æ–‡ä»¶, å¯ä»¥ç”¨ç±»ä¼¼ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">keytool -genkeypair -v -keystore repacker.keystore -keyalg RSA -keysize 4096 -validity 10000</span><br></pre></td></tr></table></figure>

<p>è¦å¡«å¾ˆå¤šä¿¡æ¯, å¯ä»¥éšä¾¿å¡«, æ¯”å¦‚éƒ½å¡« <code>repacker</code>, æœ€åè¾“å…¥ <code>y</code> ç¡®è®¤, ä½†æ˜¯å¼€å¤´çš„å£ä»¤å¯ä»¥æ€ä¹ˆç®€å•æ€ä¹ˆæ¥, æ¯”å¦‚ <code>123456</code>.</p>
<h2 id="ä¸€é”®è„šæœ¬"><a href="#ä¸€é”®è„šæœ¬" class="headerlink" title="ä¸€é”®è„šæœ¬"></a>ä¸€é”®è„šæœ¬</h2><p>å†™äº†ä¸ªä¸€é”®é‡æ‰“åŒ…è„šæœ¬, å¹¶ä¸”å¯ä»¥é€‰æ‹©å¢åŠ è°ƒè¯•æ ‡å¿—.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess <span class="keyword">as</span> sp</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"><span class="keyword">from</span> xml.dom <span class="keyword">import</span> minidom</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DEFAULT_ANDROID_SDK_DIR = Path(os.getenv(<span class="string">&quot;LOCALAPPDATA&quot;</span>), <span class="string">&quot;Android&quot;</span>, <span class="string">&quot;Sdk&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_bin_path</span>(<span class="params">filename: <span class="built_in">str</span>, *extra_search_dirs: <span class="built_in">list</span>[os.PathLike]</span>) -&gt; <span class="type">Optional</span>[Path]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Try to find bin file in system path and return full file path.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    search_dirs = os.get_exec_path()</span><br><span class="line">    search_dirs.extend(extra_search_dirs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">map</span>(Path, search_dirs):</span><br><span class="line">        exec_path = p.joinpath(filename)</span><br><span class="line">        <span class="keyword">if</span> exec_path.is_file():</span><br><span class="line">            <span class="keyword">return</span> exec_path.resolve()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidSdkBuildTool</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, tool_dir</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self._<span class="built_in">dir</span> = Path(tool_dir).resolve()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">version</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._<span class="built_in">dir</span>.name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">apksigner</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._<span class="built_in">dir</span>.joinpath(<span class="string">&quot;lib&quot;</span>, <span class="string">&quot;apksigner.jar&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">zipalign</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._<span class="built_in">dir</span>.joinpath(<span class="string">&quot;zipalign.exe&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidSdk</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, sdk_dir: os.PathLike</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self._<span class="built_in">dir</span> = Path(sdk_dir).resolve()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_build_tools</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> [AndroidSdkBuildTool(p) <span class="keyword">for</span> p <span class="keyword">in</span> self._<span class="built_in">dir</span>.joinpath(<span class="string">&quot;build-tools&quot;</span>).iterdir()]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidManifest</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path: os.PathLike</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self._tree = minidom.parse(<span class="built_in">str</span>(path))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">enable_debuggable</span>(<span class="params">self, flag: <span class="built_in">bool</span> = <span class="literal">True</span></span>):</span><br><span class="line">        application_node = self._tree.getElementsByTagName(<span class="string">&quot;application&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        application_node.setAttribute(<span class="string">&quot;android:debuggable&quot;</span>, (<span class="string">&quot;true&quot;</span> <span class="keyword">if</span> flag <span class="keyword">else</span> <span class="string">&quot;false&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, path: os.PathLike</span>):</span><br><span class="line">        path = Path(path)</span><br><span class="line">        path.write_bytes(self._tree.toxml(encoding=<span class="string">&quot;utf-8&quot;</span>, standalone=<span class="literal">False</span>))</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APKRepacker</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        *extra_bin_dirs,</span></span><br><span class="line"><span class="params">        android_sdk_dir: <span class="type">Optional</span>[Path] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        ks_file: <span class="type">Optional</span>[os.PathLike] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        ks_pwd: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> android_sdk_dir <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            android_sdk_dir = DEFAULT_ANDROID_SDK_DIR</span><br><span class="line">        self._java_path = find_bin_path(<span class="string">&quot;java.exe&quot;</span>, *extra_bin_dirs)</span><br><span class="line">        self._apktool_path = find_bin_path(<span class="string">&quot;apktool.jar&quot;</span>, *extra_bin_dirs)</span><br><span class="line">        self._android_sdk = AndroidSdk(android_sdk_dir)</span><br><span class="line">        self._android_build_tool = self._android_sdk.get_build_tools()[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        self._ks_file = <span class="literal">None</span> <span class="keyword">if</span> ks_file <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> Path(ks_file)</span><br><span class="line">        self._ks_pwd = ks_pwd</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_exec</span>(<span class="params">self, bin_path: os.PathLike, *args</span>):</span><br><span class="line">        args = [<span class="built_in">str</span>(Path(bin_path).resolve()), *<span class="built_in">map</span>(<span class="built_in">str</span>, args)]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Exec: <span class="subst">&#123;args&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> sp.run(args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_exec_jar</span>(<span class="params">self, jar_path: os.PathLike, *args</span>):</span><br><span class="line">        <span class="keyword">return</span> self._<span class="built_in">exec</span>(self._java_path, <span class="string">&quot;-jar&quot;</span>, jar_path, args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">print_executables</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;java: <span class="subst">&#123;self._java_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;apktool: <span class="subst">&#123;self._apktool_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;zipalign: <span class="subst">&#123;self._android_build_tool.zipalign&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;apksigner: <span class="subst">&#123;self._android_build_tool.apksigner&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unpack</span>(<span class="params">self, apk_path: os.PathLike, output_dir: os.PathLike</span>):</span><br><span class="line">        self._exec_jar(self._apktool_path, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="built_in">str</span>(apk_path), <span class="string">&quot;-o&quot;</span>, <span class="built_in">str</span>(output_dir))</span><br><span class="line">        <span class="keyword">return</span> Path(output_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pack</span>(<span class="params">self, apk_dir: os.PathLike, output_path: os.PathLike</span>):</span><br><span class="line">        self._exec_jar(self._apktool_path, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="built_in">str</span>(apk_dir), <span class="string">&quot;-o&quot;</span>, <span class="built_in">str</span>(output_path))</span><br><span class="line">        <span class="keyword">return</span> Path(output_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">align</span>(<span class="params">self, apk_path: os.PathLike, output_path: os.PathLike</span>):</span><br><span class="line">        <span class="comment"># MUST use absolute path</span></span><br><span class="line">        apk_path = Path(apk_path).resolve()</span><br><span class="line">        output_path = Path(output_path).resolve()</span><br><span class="line">        self._<span class="built_in">exec</span>(self._android_build_tool.zipalign, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;-p&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="built_in">str</span>(apk_path), <span class="built_in">str</span>(output_path))</span><br><span class="line">        <span class="keyword">return</span> Path(output_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">self, apk_path: os.PathLike, output_path: os.PathLike</span>):</span><br><span class="line">        <span class="keyword">if</span> self._ks_file <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> self._ks_pwd <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;apksigner needs ks file and ks password&quot;</span>)</span><br><span class="line"></span><br><span class="line">        p = sp.Popen(</span><br><span class="line">            [<span class="built_in">str</span>(self._java_path), <span class="string">&quot;-jar&quot;</span>,</span><br><span class="line">             <span class="built_in">str</span>(self._android_build_tool.apksigner), <span class="string">&quot;sign&quot;</span>,</span><br><span class="line">             <span class="string">&quot;--ks&quot;</span>, <span class="built_in">str</span>(self._ks_file), <span class="string">&quot;--out&quot;</span>, <span class="built_in">str</span>(output_path), <span class="built_in">str</span>(apk_path)],</span><br><span class="line">            stdin=sp.PIPE</span><br><span class="line">        )</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(self._ks_pwd, file=p.stdin, end=<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> Path(output_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_debuggable_flag</span>(<span class="params">self, apk_dir: os.PathLike</span>):</span><br><span class="line">        manifest_path = Path(apk_dir).joinpath(<span class="string">&quot;AndroidManifest.xml&quot;</span>)</span><br><span class="line">        manifest = AndroidManifest(manifest_path)</span><br><span class="line">        manifest.enable_debuggable(<span class="literal">True</span>)</span><br><span class="line">        manifest.save(manifest_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-p&quot;</span>, <span class="string">&quot;--apk&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;è¦ä¿®æ”¹çš„ APK æ–‡ä»¶è·¯å¾„&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;é‡æ–°æ‰“åŒ…å APK çš„è¾“å‡ºè·¯å¾„&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--sdk-dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;Android Sdk ç›®å½•&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--extra-search-dir&quot;</span>, nargs=<span class="string">&quot;+&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;å¯æ‰§è¡Œæ–‡ä»¶æˆ–è€… jar åŒ…çš„é¢å¤–æœç´¢è·¯å¾„&quot;</span>, default=())</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--ks-file&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;keytool ç”Ÿæˆçš„è‡ªç­¾åè¯ä¹¦æ–‡ä»¶&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--ks-pwd&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;ks æ–‡ä»¶çš„å£ä»¤&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--enable-debuggable&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;åœ¨ AndroidManifest.xml å¢åŠ å¯è°ƒè¯•æ ‡è®°&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    tmp = Path(<span class="string">&quot;./tmp&quot;</span>).resolve()</span><br><span class="line">    tmp.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    repacker = APKRepacker(</span><br><span class="line">        *args.extra_search_dir,</span><br><span class="line">        android_sdk_dir=args.sdk_dir,</span><br><span class="line">        ks_file=args.ks_file,</span><br><span class="line">        ks_pwd=args.ks_pwd</span><br><span class="line">    )</span><br><span class="line">    repacker.print_executables()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># apk paths and dirs</span></span><br><span class="line">    apk_path = Path(args.apk)</span><br><span class="line">    apk_name = apk_path.stem</span><br><span class="line">    apk_dir = tmp.joinpath(apk_name)</span><br><span class="line">    apk_repack_path = tmp.joinpath(<span class="string">f&quot;<span class="subst">&#123;apk_name&#125;</span>_repack.apk&quot;</span>)</span><br><span class="line">    apk_align_path = tmp.joinpath(<span class="string">f&quot;<span class="subst">&#123;apk_name&#125;</span>_align.apk&quot;</span>)</span><br><span class="line">    apk_output_path = Path(args.output)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unpack apk to dir</span></span><br><span class="line">    repacker.unpack(apk_path, apk_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do some modifications</span></span><br><span class="line">    <span class="keyword">if</span> args.enable_debuggable:</span><br><span class="line">        repacker.add_debuggable_flag(apk_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pack and resign</span></span><br><span class="line">    repacker.pack(apk_dir, apk_repack_path)</span><br><span class="line">    repacker.align(apk_repack_path, apk_align_path)</span><br><span class="line">    repacker.sign(apk_align_path, apk_output_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>ä¼šè‡ªåŠ¨æœç´¢æœ¬æœºä¸Šå­˜åœ¨çš„å¯æ‰§è¡Œæ–‡ä»¶, ä¹Ÿå¯ä»¥æä¾›é¢å¤–çš„æ–‡ä»¶æœç´¢è·¯å¾„.</p>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>å®‰å“</tag>
        <tag>APK</tag>
        <tag>é‡æ‰“åŒ…</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¢§è“èˆªçº¿ç«‹ç»˜æå–ä¸æ‰¹é‡è¿˜åŸ</title>
    <url>//posts/2023/04/11/blhx-painting/</url>
    <content><![CDATA[<p>å› ä¸ºç½‘ä¸Šæ²¡çœ‹åˆ°å¤ªå¥½çš„æ ¸å¿ƒæ­¥éª¤ä»‹ç»å’Œè„šæœ¬, æ‰€ä»¥è‡ªå·±é€ äº†ä¸€ä¸‹è½®å­, æ–¹ä¾¿è‡ªå·±è®°å½•å­¦ä¹ è¿‡ç¨‹.</p>
<p>æœ¬æ–‡ä»‹ç»ç¢§è“èˆªçº¿ç«‹ç»˜æå–å’Œè¿˜åŸåŸºæœ¬æ€è·¯, æ–‡æœ«é™„æœ‰å®Œæ•´çš„æ‰¹é‡è¿˜åŸ <code>python</code> è„šæœ¬.</p>
<span id="more"></span>

<h2 id="èµ„æºæå–"><a href="#èµ„æºæå–" class="headerlink" title="èµ„æºæå–"></a>èµ„æºæå–</h2><p>æå–çš„æ–¹æ³•ç½‘ä¸Šå¾ˆå¤š, ä¸å†èµ˜è¿°, ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BlcmZhcmUvQXNzZXRTdHVkaW8vcmVsZWFzZXM=">AssetStudio<i class="fa fa-external-link-alt"></i></span> å¯¼å‡ºå®‰è£…åŒ…å’Œçƒ­æ›´æ–°é‡Œçš„ <code>painting</code> å†…å®¹, å¾—åˆ° é‡Œé¢çš„ <code>Mesh</code> å’Œ <code>Texture2D</code> èµ„æºå³å¯è¿›è¡Œä¸‹ä¸€æ­¥è¿˜åŸ.</p>
<h2 id="æ–‡ä»¶æ ¼å¼"><a href="#æ–‡ä»¶æ ¼å¼" class="headerlink" title="æ–‡ä»¶æ ¼å¼"></a>æ–‡ä»¶æ ¼å¼</h2><p><code>Texture2D</code> ä¸‹é¢çš„å†…å®¹æ˜¯æ‰€æœ‰æ‰“åŒ…åçš„ç«‹ç»˜çº¹ç†å›¾ç‰‡, ç›®æµ‹éƒ½æ˜¯ <code>åå­—</code> + <code>.png</code> çš„æ–‡ä»¶å.</p>
<p><code>Mesh</code> ä¸‹é¢æ˜¯ 3D æ¨¡å‹è´´å›¾æ ¼å¼, å¤§éƒ¨åˆ†éƒ½æ˜¯ <code>åå­—</code> + <code>-mesh.obj</code> çš„æ–‡ä»¶å, å°éƒ¨åˆ†è¦ç‰¹æ®Šå¤„ç†, åå­—å’Œå‰é¢çº¹ç†å›¾åå­—ä¸€ä¸€å¯¹åº”.</p>
<ul>
<li><code>g</code> å¼€å¤´çš„è¡Œæ˜¯æ ‡è¯†è¡Œ, å¯ä»¥å¿½ç•¥;</li>
<li><code>v</code> å¼€å¤´çš„æ˜¯æ¨¡å‹é¡¶ç‚¹åæ ‡, å¯¹åº”è¿˜åŸåçš„å›¾çš„åæ ‡;</li>
<li><code>vt</code> æ˜¯çº¹ç†å›¾çš„é¡¶ç‚¹åæ ‡, å¯¹åº”æ‰“åŒ…åå›¾ç‰‡çš„åæ ‡;</li>
<li><code>f</code> æ˜¯ <code>v</code> å’Œ <code>vt</code> çš„å¯¹åº”å…³ç³», æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªä¸‰è§’é¢, ç”¨ä¸‰ç»„ç‚¹æ¥è®°å½•, åˆ†åˆ«æ˜¯ <code>v/vt/vn</code> çš„åºå·, ä» 1 å¼€å§‹.</li>
</ul>
<p>æ›´ä¸ºè¯¦ç»†çš„å†…å®¹å¯ä»¥è‡ªè¡Œè°·æ­Œ <code>Mesh</code> çš„æ–‡ä»¶æ ¼å¼.</p>
<h2 id="è¿˜åŸæ€è·¯"><a href="#è¿˜åŸæ€è·¯" class="headerlink" title="è¿˜åŸæ€è·¯"></a>è¿˜åŸæ€è·¯</h2><h3 id="åŸºæœ¬æµç¨‹"><a href="#åŸºæœ¬æµç¨‹" class="headerlink" title="åŸºæœ¬æµç¨‹"></a>åŸºæœ¬æµç¨‹</h3><p><code>Mesh</code> ä¸­æ¯ä¸€ä¸ª <code>f</code> è¡Œä»£è¡¨ä¸€ä¸ªå°ä¸‰è§’å½¢, å®æµ‹ç›¸é‚»çš„ä¸¤è¡Œå°±æ˜¯ä¸€æ•´ä¸ªçŸ©å½¢, å› æ­¤åªéœ€è¦è¯»å– <code>Mesh</code> æ–‡ä»¶è®°å½•ä¹‹å, ä¸¤è¡Œä¸¤è¡Œå»å¤„ç† <code>f</code> è®°å½•, å°±å¯ä»¥åƒæ‹¼å›¾ä¸€æ ·ä»çº¹ç†å›¾æŠŠåŸå›¾æ‹¼å‡ºæ¥.</p>
<h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul>
<li>æ¨¡å‹åæ ‡çš„ <code>x</code> å–å€¼éœ€è¦å–ç»å¯¹å€¼è¿›è¡Œé•œåƒ (åŸå› ä¸çŸ¥).</li>
<li>åŸå§‹åæ ‡ç³»çš„åŸç‚¹éƒ½åœ¨å›¾ç‰‡çš„å·¦ä¸‹è§’, éœ€è¦è°ƒæ•´æˆå·¦ä¸Šè§’ (ç¿»è½¬ <code>y</code> è½´).</li>
<li>éœ€è¦å°†åæ ‡ç³»é‡Œçš„ç‚¹è½¬æ¢åˆ°å›¾ç‰‡é‡Œçš„åƒç´ è¡Œåˆ—å€¼ (æ¯”è¾ƒç„å­¦, åæ ‡é‡Œçš„ç‚¹å¯¹åº”å›¾ç‰‡åƒç´ ä¸€ä¸ª <code>2x2</code> åƒç´ çš„ä¸­å¿ƒç‚¹)</li>
<li>æ‰“åŒ…çš„çº¹ç†å›¾å›¾å—å’ŒåŸå›¾å›¾å—å¯èƒ½å­˜åœ¨æŸä¸€äº›å—å¤§å°ä¸ä¸€è‡´, å®æµ‹éƒ½æ˜¯çº¹ç†å›¾å¯èƒ½æ¯”åŸå›¾å¤š 1 è¡Œ/åˆ—é€æ˜åƒç´ , å› æ­¤æ‹¼çš„æ—¶å€™éœ€è¦å¯¹æ¯”å¤§å°, å‰”é™¤å¤šä½™çš„é€æ˜è¡Œ/åˆ—<del>æƒ³æƒ³ä¹ŸçŸ¥é“æ€ä¹ˆå¯èƒ½æ‹†åˆ†æˆè¿™ä¹ˆå¤šå—åè¿˜åˆšå¥½èƒ½é‡æ–°æ‹¼æˆä¸€ä¸ªå¤§å—</del>. è€Œä¸”ç”±äºç»˜å›¾è¯¯å·®, å…¨é€æ˜ç‚¹çš„ RGB ä¸ä¸€å®šæ˜¯å…¨ 0, å¹¶ä¸” alpha é€šé“ä¹Ÿå¯èƒ½æœ‰ä¸€äº›å€¼, æ‰€ä»¥å‡¡æ˜¯é€æ˜åº¦å°äºæŸä¸ªé˜ˆå€¼å°±å¯ä»¥è®¤ä¸ºæ˜¯é€æ˜çš„äº†.</li>
<li>ç“œæ¸¸çš„ 0.125 ä¸ªç¨‹åºå‘˜å¯¼è‡´å¾ˆå¤šç«‹ç»˜å°±æ˜¯åŸå›¾, ç„¶åå¯¹åº”çš„ <code>Mesh</code> æ–‡ä»¶æ²¡æœ‰; ä¹Ÿå¯èƒ½çƒ­æ›´æ–°å¾ˆå¤šæ¬¡, åŒä¸€ä¸ªçº¹ç†å›¾æœ‰å¾ˆå¤šä¸ª <code>Mesh</code> æ–‡ä»¶, éœ€è¦éƒ½å°è¯•ä¸€ä¸‹.</li>
</ul>
<h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>å®‰è£…ä¸€ä¸‹å¿…è¦çš„åº“, è¿è¡Œçš„æ—¶å€™éœ€è¦è®¾å®šèµ„æºæ–‡ä»¶å¤¹å’Œå¯¼å‡ºæ–‡ä»¶å¤¹.</p>
<p>å½“é‡åˆ°æ— æ³•é€šè¿‡ <code>Mesh</code> æ–‡ä»¶æ¥è¿˜åŸçš„çº¹ç†å›¾æ—¶, ä¼šå¼¹çª—æ˜¾ç¤ºå›¾ç‰‡çš„ç¼©ç•¥å›¾, å¯ä»¥æ‰‹åŠ¨é€‰æ‹©æ˜¯ç›´æ¥å¤åˆ¶åŸå›¾è¿‡å»è¿˜æ˜¯æ”¾å¼ƒè¿™å¼ å›¾, æ¯”å¦‚ä¸‹é¢:</p>
<p><img data-src="/static/image/blhx-painting/ppLHg1I.png" alt="ppLHg1I.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageTk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_mesh_obj</span>(<span class="params">path</span>):</span><br><span class="line">    vertex = []  <span class="comment"># x, y, x</span></span><br><span class="line">    vertex_texture = []  <span class="comment"># u, v</span></span><br><span class="line">    vector_normal = []  <span class="comment"># x, y, z # 2D æ²¡æœ‰æ³•å‘é‡</span></span><br><span class="line">    face = []  <span class="comment"># v/vt/vn</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            type_, *values = line.strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> type_ == <span class="string">&quot;v&quot;</span>:</span><br><span class="line">                vertex.append(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, values[:<span class="number">2</span>])))</span><br><span class="line">            <span class="keyword">elif</span> type_ == <span class="string">&quot;vt&quot;</span>:</span><br><span class="line">                vertex_texture.append(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">float</span>, values)))</span><br><span class="line">            <span class="keyword">elif</span> type_ == <span class="string">&quot;f&quot;</span>:</span><br><span class="line">                face.append([<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, value.split(<span class="string">&quot;/&quot;</span>))) <span class="keyword">for</span> value <span class="keyword">in</span> values])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> vertex, vertex_texture, face</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">restore_painting</span>(<span class="params">texture: np.ndarray, v, vt, f</span>) -&gt; np.ndarray:</span><br><span class="line">    v = np.array(v)[:, <span class="number">0</span>:<span class="number">2</span>]  <span class="comment"># å»é™¤ z è½´</span></span><br><span class="line">    vt = np.array(vt)</span><br><span class="line">    f = np.array(f)[:, :, <span class="number">0</span>:<span class="number">2</span>]  <span class="comment"># å»é™¤æ³•å‘é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç† v</span></span><br><span class="line">    v = np.<span class="built_in">abs</span>(v)  <span class="comment"># æ°´å¹³é•œåƒ, åŸå› ä¸æ˜</span></span><br><span class="line">    v[:, <span class="number">1</span>] = np.<span class="built_in">max</span>(v[:, <span class="number">1</span>]) - v[:, <span class="number">1</span>]  <span class="comment"># ç¿»è½¬ y è½´, x å¯¹åº”åˆ—æ•°, y å¯¹åº”è¡Œæ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç† vt</span></span><br><span class="line">    vt = vt * np.array(texture.shape[<span class="number">1</span>::-<span class="number">1</span>]).reshape(<span class="number">1</span>, <span class="number">2</span>)  <span class="comment"># è½¬æ¢åˆ°åƒç´ </span></span><br><span class="line">    vt[:, <span class="number">1</span>] = texture.shape[<span class="number">0</span>] - vt[:, <span class="number">1</span>]  <span class="comment"># ç¿»è½¬ y è½´</span></span><br><span class="line">    vt = np.<span class="built_in">round</span>(vt, <span class="number">0</span>).astype(<span class="built_in">int</span>)  <span class="comment"># è½¬æ¢æ•´æ•°åæ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ–°å»ºç©ºå›¾</span></span><br><span class="line">    width, height = np.<span class="built_in">max</span>(v, axis=<span class="number">0</span>) + <span class="number">2</span>  <span class="comment"># ä¸Šä¸‹å·¦å³å„æ‰©å±• 1 ä¸ªä½ç½®</span></span><br><span class="line">    png = np.zeros((height, width, <span class="number">4</span>), dtype=texture.dtype)</span><br><span class="line">    <span class="comment"># print(png.shape)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(f), <span class="number">2</span>):</span><br><span class="line">        v_rect_pts: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]] = []</span><br><span class="line">        vt_rect_pts: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]] = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> v_idx, vt_idx <span class="keyword">in</span> f[i]:</span><br><span class="line">            v_rect_pts.append(v[v_idx - <span class="number">1</span>])  <span class="comment"># ä¸‹æ ‡éœ€è¦åºå· -1</span></span><br><span class="line">            vt_rect_pts.append(vt[vt_idx - <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> v_idx, vt_idx <span class="keyword">in</span> f[i + <span class="number">1</span>]:</span><br><span class="line">            v_rect_pts.append(v[v_idx - <span class="number">1</span>])</span><br><span class="line">            vt_rect_pts.append(vt[vt_idx - <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ’åºå¾—åˆ°å·¦ä¸Šå’Œå³ä¸‹åæ ‡</span></span><br><span class="line">        leftup_v, *_, rightdown_v = <span class="built_in">sorted</span>(v_rect_pts, key=<span class="built_in">list</span>)</span><br><span class="line">        leftup_vt, *_, rightdown_vt = <span class="built_in">sorted</span>(vt_rect_pts, key=<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è½¬æ¢åƒç´ è¡Œåˆ—åæ ‡, å·¦é—­å³å¼€</span></span><br><span class="line">        leftup_v = (leftup_v + <span class="number">1</span>) - <span class="number">1</span>  <span class="comment"># +1 æ˜¯ä¸ºäº†æŠŠå›¾å¾€ä¸¤ä¸ªæ­£æ–¹å‘ç§»åŠ¨ä¸€æ ¼, ä¿®æ­£åæ ‡</span></span><br><span class="line">        rightdown_v = (rightdown_v + <span class="number">1</span>) + <span class="number">1</span></span><br><span class="line">        leftup_vt = leftup_vt - <span class="number">1</span></span><br><span class="line">        rightdown_vt = rightdown_vt + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆ¤æ–­åŒºåŸŸæ˜¯å¦å¤§å°ç›¸ç­‰</span></span><br><span class="line">        size1 = rightdown_v - leftup_v</span><br><span class="line">        size2 = rightdown_vt - leftup_vt</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(size1 == size2):</span><br><span class="line">            <span class="comment"># å¤„ç†ä¸ç›¸ç­‰æƒ…å†µ, ç›®å‰åªå‘ç°çº¹ç†åŒºåŸŸä¼šå¯èƒ½å¤šä¸€è¡Œ/åˆ—, æƒ³åŠæ³•å»æ‰ç©ºç™½</span></span><br><span class="line">            <span class="comment"># ç©ºç™½çš„æ¡ä»¶æ˜¯æŸä¸€è¡Œ/åˆ—é€æ˜åº¦å‡å°äºä¸€ä¸ªé˜ˆå€¼</span></span><br><span class="line">            texture_region = texture[leftup_vt[<span class="number">1</span>]:rightdown_vt[<span class="number">1</span>], leftup_vt[<span class="number">0</span>]:rightdown_vt[<span class="number">0</span>]]</span><br><span class="line">            alpha_value = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">            row_delta = size2[<span class="number">1</span>] - size1[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> row_delta == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> np.<span class="built_in">all</span>(texture_region[-<span class="number">1</span>, :, -<span class="number">1</span>] &lt; alpha_value):</span><br><span class="line">                    rightdown_vt[<span class="number">1</span>] -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> np.<span class="built_in">all</span>(texture_region[<span class="number">0</span>, :, -<span class="number">1</span>] &lt; alpha_value):</span><br><span class="line">                    leftup_vt[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">&quot;Empty row not found!&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> row_delta &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;<span class="subst">&#123;row_delta&#125;</span> extra rows found.&quot;</span>)</span><br><span class="line"></span><br><span class="line">            col_delta = size2[<span class="number">0</span>] - size1[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> col_delta == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> np.<span class="built_in">all</span>(texture_region[:, -<span class="number">1</span>, -<span class="number">1</span>] &lt; alpha_value):</span><br><span class="line">                    rightdown_vt[<span class="number">0</span>] -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> np.<span class="built_in">all</span>(texture_region[:, <span class="number">0</span>, -<span class="number">1</span>] &lt; alpha_value):</span><br><span class="line">                    leftup_vt[<span class="number">0</span>] += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">&quot;Empty col not found!&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> col_delta &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;<span class="subst">&#123;col_delta&#125;</span> extra cols found.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        png[leftup_v[<span class="number">1</span>]:rightdown_v[<span class="number">1</span>], leftup_v[<span class="number">0</span>]:rightdown_v[<span class="number">0</span>]] = texture[leftup_vt[<span class="number">1</span>]:rightdown_vt[<span class="number">1</span>], leftup_vt[<span class="number">0</span>]:rightdown_vt[<span class="number">0</span>]]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> png</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose_image</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_confirm</span>():</span><br><span class="line">        root.result = <span class="literal">True</span></span><br><span class="line">        root.destroy()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_cancel</span>():</span><br><span class="line">        root.result = <span class="literal">False</span></span><br><span class="line">        root.destroy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ– tkinter çª—å£</span></span><br><span class="line">    root = tk.Tk()</span><br><span class="line">    root.title(<span class="string">&quot;é€‰æ‹©ä¿ç•™&quot;</span>)</span><br><span class="line">    root.result = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½å›¾ç‰‡å¹¶è°ƒæ•´å¤§å°</span></span><br><span class="line">    image = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    max_size = (<span class="number">300</span>, <span class="number">300</span>)</span><br><span class="line">    image.thumbnail(max_size)</span><br><span class="line">    photo = ImageTk.PhotoImage(image)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºå›¾ç‰‡æ ‡ç­¾å¹¶æ”¾ç½®åœ¨çª—å£ä¸Š</span></span><br><span class="line">    label = tk.Label(root, image=photo)</span><br><span class="line">    label.pack(padx=<span class="number">5</span>, pady=<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®å¹¶æ”¾ç½®åœ¨çª—å£ä¸Š</span></span><br><span class="line">    confirm_button = tk.Button(root, text=<span class="string">&quot;å¤åˆ¶&quot;</span>, command=on_confirm)</span><br><span class="line">    confirm_button.pack(side=tk.LEFT, padx=(<span class="number">20</span>, <span class="number">10</span>), pady=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    cancel_button = tk.Button(root, text=<span class="string">&quot;æ”¾å¼ƒ&quot;</span>, command=on_cancel)</span><br><span class="line">    cancel_button.pack(side=tk.RIGHT, padx=(<span class="number">10</span>, <span class="number">20</span>), pady=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿è¡Œçª—å£å¹¶ç­‰å¾…ç”¨æˆ·æ“ä½œ</span></span><br><span class="line">    root.mainloop()</span><br><span class="line">    <span class="keyword">return</span> root.result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PNG_DIR = Path(<span class="string">&quot;./Texture2D&quot;</span>)</span><br><span class="line">OBJ_DIR = Path(<span class="string">&quot;./Mesh&quot;</span>)</span><br><span class="line"></span><br><span class="line">EXPORT_DIR = Path(<span class="string">&quot;./paintings&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> png <span class="keyword">in</span> PNG_DIR.iterdir():</span><br><span class="line">        char_name = png.stem</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(char_name)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        painting_path = EXPORT_DIR.joinpath(png.name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> mesh <span class="keyword">in</span> OBJ_DIR.glob(<span class="string">f&quot;<span class="subst">&#123;char_name&#125;</span>-mesh*.obj&quot;</span>):</span><br><span class="line">            v, vt, f = read_mesh_obj(mesh)</span><br><span class="line">            texture: np.ndarray = cv2.imread(png.as_posix(), cv2.IMREAD_UNCHANGED)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                painting = restore_painting(texture, v, vt, f)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                traceback.print_exc()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Restore Error: <span class="subst">&#123;char_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># è¿˜åŸå¤±è´¥ç»§ç»­è¯•ä¸‹ä¸€ä¸ªå¯èƒ½çš„ mesh æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># è¿˜åŸæˆåŠŸè·³å‡ºå¾ªç¯</span></span><br><span class="line">            cv2.imwrite(painting_path.as_posix(), painting)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;No valid mesh file found for <span class="subst">&#123;png&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> choose_image(png):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Copy: <span class="subst">&#123;png&#125;</span>&quot;</span>)</span><br><span class="line">                shutil.copy(png, painting_path)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Discard: <span class="subst">&#123;png&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Total: <span class="subst">&#123;count&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">input</span>(<span class="string">&quot;Press &lt;Enter&gt; to exit...&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="è¿˜åŸæ•ˆæœ"><a href="#è¿˜åŸæ•ˆæœ" class="headerlink" title="è¿˜åŸæ•ˆæœ"></a>è¿˜åŸæ•ˆæœ</h2><p>æ”¾ä¸€äº›è¿˜åŸå‰å’Œè¿˜åŸåçš„å›¾ä½œå¯¹æ¯”<del>å¤¹å¸¦ç§è´§</del>.</p>
<details class="note danger"><summary><p>guanghui_h.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLI7y8.png" alt="ppLI7y8.png"><br><img data-src="/static/image/blhx-painting/ppLIDRx.png" alt="ppLIDRx.png"><br>ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹ğŸŒ¹</p>
<div style="text-align:center;">ğŸŒ¹<span class="black-curtain">ä¸ºå…‰è¾‰è€å©†çŒ®ä¸Š 99 æœµç«ç‘°!</span>ğŸŒ¹</div>
</details>

<details class="note info"><summary><p>guanghui.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLITQf.png" alt="ppLITQf.png"><br><img data-src="/static/image/blhx-painting/ppLIBJ1.png" alt="ppLIBJ1.png"></p>

</details>

<details class="note info"><summary><p>guanghui_2.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLIoSP.png" alt="ppLIoSP.png"><br><img data-src="/static/image/blhx-painting/ppLI0iR.png" alt="ppLI0iR.png"></p>

</details>

<details class="note info"><summary><p>guanghui_3.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLI5Wt.png" alt="ppLI5Wt.png"><br><img data-src="/static/image/blhx-painting/ppLIdo9.png" alt="ppLIdo9.png"></p>

</details>

<details class="note info"><summary><p>guanghui_4.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLIhFA.png" alt="ppLIhFA.png"><br><img data-src="/static/image/blhx-painting/ppLIadJ.png" alt="ppLIadJ.png"></p>

</details>

<details class="note info"><summary><p>guanghui_5.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLIHOS.png" alt="ppLIHOS.png"><br><img data-src="/static/image/blhx-painting/ppLIrz6.png" alt="ppLIrz6.png"></p>

</details>

<details class="note info"><summary><p>guanghui_idol.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLHstH.png" alt="ppLHstH.png"><br><img data-src="/static/image/blhx-painting/ppLI6sO.png" alt="ppLI6sO.png"></p>

</details>

<details class="note info"><summary><p>guanghui_idol_n.png</p>
</summary>
<p><img data-src="/static/image/blhx-painting/ppLIqeg.png" alt="ppLIqeg.png"><br><img data-src="/static/image/blhx-painting/ppLIyQK.png" alt="ppLIyQK.png"></p>

</details>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>å·¥å…·</tag>
        <tag>ç¢§è“èˆªçº¿</tag>
        <tag>ç«‹ç»˜è¿˜åŸ</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸€)</title>
    <url>//posts/2023/10/13/cnn-numpy-1/</url>
    <content><![CDATA[<p>&quot;åŸºäº numpy çš„æ‰‹å†™æ•°å­—è¯†åˆ«&quot;, è¿™ä¸€ç»å…¸é—®é¢˜é™¤äº†ç”¨ä½œæ·±åº¦å­¦ä¹ å…¥é—¨å†…å®¹, è¿˜è¢«å¹¿æ³›ä½œä¸ºå„å¤§è¯¾ç¨‹çš„è¯¾ç¨‹ä½œä¸š, å› æ­¤åœ¨å„å¤§æœç´¢å¼•æ“ä¸Šæœç´¢ç‡ä¹Ÿæ˜¯ç›¸å½“ä¹‹é«˜<del>(ä»£ç å¤ç”¨ç‡ä¹Ÿæ˜¯ç›¸å½“ä¹‹é«˜)</del>. ç½‘ä¸Šç¡®å®æœ‰æŒºå¤šç°æˆçš„å¯ä½¿ç”¨ä»£ç , ä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯é€ çš„å…¨è¿æ¥ç½‘ç»œ, å¹¶ä¸”å¾ˆå¤šæ—¶å€™å†…éƒ¨åŸç†ä¸æ˜¯ç‰¹åˆ«æ¸…æ™°. å› æ­¤å†³å®šè‡ªå·±ä¹Ÿæ¥é€ ä¸€æ¬¡è½®å­, ä½¿ç”¨ <code>numpy</code> å®ç°ä¸€ä¸ªç®€å•çš„å·ç§¯ç¥ç»ç½‘ç»œè¿›è¡Œæ‰‹å†™æ•°å­—è¯†åˆ«, æ­£å¥½ä¹Ÿèƒ½å€Ÿæ­¤æœºä¼šæ¢³ç†ä¸€ä¸‹ç¥ç»ç½‘ç»œçš„åŸºæœ¬åŸç†.</p>
<p>å…¨æ–‡åŒ…å«å®Œæ•´çš„å·ç§¯ç½‘ç»œå®ç°, ä»¥åŠçŸ©é˜µæ¢¯åº¦å’Œå·ç§¯çŸ©é˜µåŒ–çš„æ¨å¯¼è¿‡ç¨‹, ç”±äºå…¨æ–‡è¿‡é•¿, å› æ­¤åˆ†æˆäº†ä¸‰éƒ¨åˆ†, å†…å®¹ä¸Šæ˜¯å®Œå…¨è¿ç€çš„.</p>
<p>æœ¬æ–‡ä¸ºç¬¬ä¸€ç¯‡, ç®€å•ä»‹ç»äº†ç¥ç»ç½‘ç»œçš„åŸºæœ¬å­¦ä¹ åŸç†å’Œä¸€äº›æ— å‚æ•°ç½‘ç»œå±‚çš„å®ç°.</p>
<span id="more"></span>

<p>æœ¬ç³»åˆ—æ–‡ç« ä¼ é€é—¨:</p>
<ul>
<li><a href="/posts/2023/10/13/cnn-numpy-1/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸€)</a></li>
<li><a href="/posts/2023/10/14/cnn-numpy-2/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (äºŒ)</a></li>
<li><a href="/posts/2023/10/15/cnn-numpy-3/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸‰)</a></li>
</ul>
<h2 id="å¿…è¦çš„ç†è®ºçŸ¥è¯†"><a href="#å¿…è¦çš„ç†è®ºçŸ¥è¯†" class="headerlink" title="å¿…è¦çš„ç†è®ºçŸ¥è¯†"></a>å¿…è¦çš„ç†è®ºçŸ¥è¯†</h2><p>æœ¬èŠ‚æ˜¯å¯¹ç¥ç»ç½‘ç»œæ‰€éœ€çš„æ•°å­¦çŸ¥è¯†è¿›è¡Œç®€å•ä»‹ç», åªæ¶‰åŠåŸºæœ¬çš„é«˜æ•°çŸ¥è¯†. <del>å…¨æ–‡å¯èƒ½æœ‰ä¸€äº›ä¸ä¸¥è°¨çš„æ•°å­¦å¼å­, ä¼šæ„å³å¯.</del></p>
<h3 id="å‰å‘ä¼ æ’­"><a href="#å‰å‘ä¼ æ’­" class="headerlink" title="å‰å‘ä¼ æ’­"></a>å‰å‘ä¼ æ’­</h3><p>ç¥ç»ç½‘ç»œçš„æœ¬è´¨æ˜¯ä¸€ä¸ªå¤šå…ƒå¤åˆå‡½æ•°, å› æ­¤åœ¨ç»™å®šè¾“å…¥çš„æƒ…å†µä¸‹è®¡ç®—ç½‘ç»œçš„è¾“å‡º, å°±æ˜¯ç½‘ç»œçš„å‰å‘ä¼ æ’­è¿‡ç¨‹.</p>
<p><img data-src="/static/image/cnn-numpy-1/forward.jpg" alt="forward.jpg"></p>
<p>å¦‚æœæœ‰ä¸Šå›¾æ‰€ç¤ºçš„ä¸€ä¸ªç®€å•ç½‘ç»œ, å…¶ä¸­:</p>
<p>$$<br>\begin{aligned}<br>  y_1 &amp;= y_1(x_1, x_2) \\<br>  y_2 &amp;= y_2(x_2, x_3) \\<br>  z &amp;= z(y_1, y_2) = z(y_1(x_1, x_2), y_2(x_2, x_3))<br>\end{aligned}<br>$$</p>
<p>åˆ™ç§° $y_1$ æ˜¯å…³äº $x_1, x_2$ çš„å‡½æ•°, $y_2$ æ˜¯å…³äº $x_2, x_3$ çš„å‡½æ•°, $z$ æ˜¯å…³äº $x_1, x_2, x_3$ çš„å‡½æ•°, ä¸”ç”± $y_1, y_2$ å¤åˆè€Œæˆ.</p>
<p>åˆ™é€šè¿‡ $x_1, x_2, x_3$ æŒ‰ç…§å›¾ä¸­å¤åˆå‡½æ•°ä¸€æ­¥ä¸€æ­¥è®¡ç®— $z$ çš„è¿‡ç¨‹å°±æ˜¯ç½‘ç»œçš„å‰å‘ä¼ æ’­è¿‡ç¨‹.</p>
<h3 id="æ¢¯åº¦ä¸‹é™"><a href="#æ¢¯åº¦ä¸‹é™" class="headerlink" title="æ¢¯åº¦ä¸‹é™"></a>æ¢¯åº¦ä¸‹é™</h3><p>ä»ä¸Šé¢çš„å›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ $z$ æœ‰ä¸‰ä¸ªè¾“å…¥å‚æ•°, å‡è®¾ $z$ å°±æ˜¯ç½‘ç»œæœ€ç»ˆçš„æŸå¤±å‡½æ•°, æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯ä¸æ–­è°ƒæ•´è¿™äº›å‚æ•°, ä½¿å¾—æŸå¤±å‡å°, ä¹Ÿå°±æ˜¯ $z$ å‡å°.</p>
<p>é‚£ä¹ˆ, å›å¿†é«˜æ•°æœ€åŸºæœ¬çš„çŸ¥è¯†, å¦‚æœä¸€ä¸ªå‡½æ•°å­˜åœ¨æœ€ (æ) å°å€¼, é‚£ä¹ˆè¯¥ç‚¹çš„å¯¼æ•°ç­‰äº 0. æ‰€ä»¥çº¯ç†è®ºè®¡ç®—æœ€æš´åŠ›çš„æ–¹å¼å°±æ˜¯å¯¹ $z$ å…³äºæ‰€æœ‰å‚æ•°æ±‚å¯¼, ç„¶åçœ‹æ‰€æœ‰å‚æ•°æå€¼ç‚¹çš„ç»„åˆ, æœ€åå¾—åˆ° $z$ çš„æœ€å°å€¼.</p>
<p>ä½†æ˜¯ä¸Šè¿°æ–¹æ³•ä¸èƒ½å……åˆ†åˆ©ç”¨è®¡ç®—æœºçš„ä¼˜åŠ¿, å°±æ˜¯æ•°å€¼è®¡ç®—, å¹¶ä¸”å¾ˆå¤šæ—¶å€™å‡½æ•°ååˆ†å¤æ‚æ— æ³•æ¨å¯¼, è€Œä¸”æˆ‘ä»¬ä¹Ÿä¸éœ€è¦ç²¾ç¡®æ±‚å‡ºæœ€å°å€¼, åªè¦æ¥è¿‘æŸä¸ªæå°å€¼å°±è¡Œäº†, å› æ­¤æœ‰äº†æ¢¯åº¦ä¸‹é™æ³•.</p>
<p>æ‰€è°“æ¢¯åº¦, ç®€å•ç†è§£å°±æ˜¯å‡½æ•°çš„å¯¼æ•°, åªä¸è¿‡æ˜¯å¯¹æ¯ä¸ªå‚æ•°éƒ½æ±‚åå¯¼æ•°, æ‰€æœ‰å‚æ•°çš„åå¯¼æ•°ç»„åˆåœ¨ä¸€èµ·å°±å«æ¢¯åº¦. è€Œæ¢¯åº¦æ‰€æŒ‡å‘çš„å‚æ•°å˜åŒ–æ–¹å‘æ°¸è¿œä½¿å¾—æ•´ä¸ªå‡½æ•°å€¼å˜å¤§, å› æ­¤å¦‚æœæœç€æ¢¯åº¦çš„åæ–¹å‘æ›´æ–°å‚æ•°, å°±ä¼šä½¿å¾—å‡½æ•°å€¼å‡å°.</p>
<p>ä¾‹å¦‚æˆ‘ä»¬çŸ¥é“äº† $z$ å…³äºä¸‰ä¸ªå‚æ•°çš„æ¢¯åº¦æ˜¯ $(\frac{\partial{z}}{\partial{x_1}}, \frac{\partial{z}}{\partial{x_2}}, \frac{\partial{z}}{\partial{x_3}})$, é‚£ä¹ˆ $z(x_1 - \eta\frac{\partial{z}}{\partial{x_1}}, x_2 - \eta\frac{\partial{z}}{\partial{x_2}}, x_3 - \eta\frac{\partial{z}}{\partial{x_3}})$ å°äº $z(x_1, x_2, x_3)$, å…¶ä¸­ $\eta$ å¯ä»¥è§†ä½œ&quot;å­¦ä¹ ç‡&quot;, å–ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„å€¼.</p>
<h3 id="é“¾å¼æ³•åˆ™ä¸åå‘ä¼ æ’­"><a href="#é“¾å¼æ³•åˆ™ä¸åå‘ä¼ æ’­" class="headerlink" title="é“¾å¼æ³•åˆ™ä¸åå‘ä¼ æ’­"></a>é“¾å¼æ³•åˆ™ä¸åå‘ä¼ æ’­</h3><p>çŸ¥é“äº†æ¢¯åº¦ä¸‹é™çš„åŸºæœ¬åŸç†ä¹‹å, æˆ‘ä»¬ä¸‹ä¸€æ­¥ç›®æ ‡å°±æ˜¯é«˜æ•ˆçš„æ±‚è§£æ¢¯åº¦.</p>
<p>å…ˆè¯´é“¾å¼æ³•åˆ™, è¿™ä¸ªå†…å®¹ä¹Ÿæ˜¯é«˜æ•°çš„åŸºæœ¬çŸ¥è¯†, åœ¨æ­¤å›é¡¾ä¸€ä¸‹.</p>
<p>ä¾‹å¦‚è¦æ±‚ $z$ çš„æ‰€æœ‰åå¯¼æ•°, åˆ™:</p>
<p>$$<br>\begin{aligned}<br>  \frac{\partial{z}}{\partial{x_1}} &amp;= \frac{\partial{z}}{\partial{y_1}}\frac{\partial{y_1}}{\partial{x_1}} \\<br>  \frac{\partial{z}}{\partial{x_2}} &amp;= \frac{\partial{z}}{\partial{y_1}}\frac{\partial{y_1}}{\partial{x_2}} + \frac{\partial{z}}{\partial{y_2}}\frac{\partial{y_2}}{\partial{x_2}} \\<br>  \frac{\partial{z}}{\partial{x_3}} &amp;= \frac{\partial{z}}{\partial{y_2}}\frac{\partial{y_2}}{\partial{x_3}}<br>\end{aligned}<br>$$</p>
<p>å’Œä¸Šé¢çš„å‡½æ•°å¤åˆå…³ç³»å¯¹åº”ä¸€ä¸‹, å¾ˆå®¹æ˜“å°±èƒ½çœ‹å‡ºé“¾å¼æ±‚å¯¼é€»è¾‘, ç„¶åå¯ä»¥æŒ‰ä¸‹å›¾æ ‡è®°åå¯¼æ•°.</p>
<p><img data-src="/static/image/cnn-numpy-1/backward.jpg" alt="backward.jpg"></p>
<p>å¯ä»¥çœ‹å‡ºæ¥æ•´ä¸ªç½‘ç»œå›¾å½¢æˆäº†ä¸€ä¸ªæ ‘å½¢ç»“æ„, ä¹Ÿå¯ç§°ä¹‹ä¸ºè®¡ç®—å›¾, å…¶ä¸­æ ‘çš„æ ¹éƒ¨æ˜¯æŸå¤±å€¼, è€Œå‡½æ•°æ‰€æœ‰çš„è¾“å…¥å‚æ•°æ˜¯æ ‘çš„å¶èŠ‚ç‚¹.</p>
<p>æ˜¾ç„¶, ä»ç®—æ³•è§’åº¦è€ƒè™‘, å¦‚æœè¦å¤ç”¨ä¸­é—´ç»“æœ, å‡å°‘è®¡ç®—é‡, æœ€ä½³æ–¹å¼å°±æ˜¯æ€»æ ‘çš„æ ¹éƒ¨å¼€å§‹éå†æ¯ä¸€ä¸ªå¶èŠ‚ç‚¹, ä¸­é€”ä¸æ–­æŒ‰ç…§é“¾å¼æ³•åˆ™è¿›è¡Œç´¯åŠ å’Œç´¯ä¹˜, å¾—åˆ°æ ¹èŠ‚ç‚¹å…³äºæ¯ä¸€ä¸ªå¶èŠ‚ç‚¹çš„åå¯¼å€¼.</p>
<p>ç”±äºè¿™ç§æ¢¯åº¦è®¡ç®—æ–¹å¼å’Œå‰å‘è®¡ç®— $z$ çš„è¿‡ç¨‹åˆšå¥½ç›¸å, å› æ­¤å¾—ååå‘ä¼ æ’­ç®—æ³•. åªè¦åœ¨å‰å‘è®¡ç®—æ—¶æ„é€ å¥½è®¡ç®—å›¾, åˆ™è®¡ç®—æ¢¯åº¦æ—¶åªéœ€è¦åæ–¹å‘ä»è®¡ç®—å›¾æ ¹éƒ¨éå†å¶èŠ‚ç‚¹å³å¯ç®—å‡ºæ‰€æœ‰å‚æ•°çš„æ¢¯åº¦å€¼.</p>
<h2 id="å¯¼å…¥ä½¿ç”¨çš„åº“"><a href="#å¯¼å…¥ä½¿ç”¨çš„åº“" class="headerlink" title="å¯¼å…¥ä½¿ç”¨çš„åº“"></a>å¯¼å…¥ä½¿ç”¨çš„åº“</h2><p>ä¸‹é¢çš„å†…å®¹å°†ä½¿ç”¨ <code>numpy</code> åº“æ‰‹æ“ä¸€ä¸ªç®€å•çš„å·ç§¯ç¥ç»ç½‘ç»œ, å¹¶è¿›è¡Œè®­ç»ƒå’Œè¯„ä¼°. å…¨ç¯‡ä»£ç éœ€è¦å¯¼å…¥çš„åº“å¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> PIL.Image</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report</span><br></pre></td></tr></table></figure>

<p><code>matplotlib.pyplot</code> ç”¨æ¥ç»˜åˆ¶æŸå¤±æ›²çº¿, <code>numpy</code> æä¾›ç¥ç»ç½‘ç»œæ‰€éœ€è¦çš„çŸ©é˜µè®¡ç®—, <code>PIL</code> ç”¨æ¥è¯»å–æ•°æ®é›†, <code>sklearn.metrics</code> é‡Œæœ‰ä¸€äº›è¯„ä»·åˆ†ç±»ä»»åŠ¡çš„æŒ‡æ ‡å‡½æ•°, å€Ÿç”¨ä¸€ä¸‹.</p>
<p>æœ¬æ–‡ä½¿ç”¨çš„ <code>python</code> ç‰ˆæœ¬ä¸º <code>3.9.13</code>, å„ä¾èµ–åº“çš„ç‰ˆæœ¬å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">numpy==1.24.3</span><br><span class="line">Pillow==10.0.0</span><br><span class="line">scikit-learn==1.2.2</span><br><span class="line">matplotlib==3.7.2</span><br></pre></td></tr></table></figure>

<h2 id="åŠ è½½æ•°æ®é›†"><a href="#åŠ è½½æ•°æ®é›†" class="headerlink" title="åŠ è½½æ•°æ®é›†"></a>åŠ è½½æ•°æ®é›†</h2><p>æ•°æ®é›†ä½¿ç”¨ä¸€ä¸ªè¾ƒå°çš„æ‰‹å†™æ•°å­—åˆ†ç±»å›¾ç‰‡æ•°æ®é›†, ä¹‹å‰æ–‡ç« é‡Œä¹Ÿä¸€ç›´ç”¨è¿™ä¸ªä¸¾ä¾‹, è¿™é‡Œå†è´´ä¸€ä¸‹è“å¥äº‘ä¸‹è½½åœ°å€, <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pVFBrSzA5cGZuaGE=">æ‰‹å†™æ•°å­—åˆ†ç±».zip<i class="fa fa-external-link-alt"></i></span>, é‡Œé¢åŒ…å« 10000 å¼ è®­ç»ƒæ•°æ®å’Œ 5000 å¼ æµ‹è¯•æ•°æ®.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_dataset</span>(<span class="params">folder, shuffle: <span class="built_in">bool</span> = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŠ è½½æ•°æ®é›†</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        inputs: (B, C, H, W)</span></span><br><span class="line"><span class="string">        targets: (B, )</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    inputs = []</span><br><span class="line">    targets = []</span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">for</span> img_path <span class="keyword">in</span> Path(folder, <span class="built_in">str</span>(num)).iterdir():</span><br><span class="line">            inputs.append(np.asarray(PIL.Image.<span class="built_in">open</span>(img_path)))</span><br><span class="line">            targets.append(num)</span><br><span class="line"></span><br><span class="line">    inputs = np.stack(inputs, <span class="number">0</span>, dtype=np.float32) / <span class="number">255</span></span><br><span class="line">    targets = np.stack(targets, <span class="number">0</span>, dtype=np.int32)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(inputs.shape) == <span class="number">3</span>:</span><br><span class="line">        inputs = inputs[:, <span class="literal">None</span>, :, :]  <span class="comment"># (B, C, H, W)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> shuffle:</span><br><span class="line">        rnd_index = np.arange(inputs.shape[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">            np.random.shuffle(rnd_index)</span><br><span class="line">        inputs = inputs[rnd_index]</span><br><span class="line">        targets = targets[rnd_index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inputs, targets</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¦æ³¨æ„çš„åœ°æ–¹æ˜¯, ä¸ºäº†ä¹‹åç½‘ç»œèƒ½ç¨³å®šè®­ç»ƒ, ä¸ä¼šå‡ºç°æ¢¯åº¦çˆ†ç‚¸ç­‰å¥‡æ€ªçš„é—®é¢˜, åƒç´ å€¼è¢«è½¬æ¢åˆ° 0-1 çš„èŒƒå›´.</p>
<h2 id="æ— å‚æ•°ç½‘ç»œå±‚çš„å®ç°"><a href="#æ— å‚æ•°ç½‘ç»œå±‚çš„å®ç°" class="headerlink" title="æ— å‚æ•°ç½‘ç»œå±‚çš„å®ç°"></a>æ— å‚æ•°ç½‘ç»œå±‚çš„å®ç°</h2><p>é¦–å…ˆæ¥å®ç°ç½‘ç»œä¸­ç®€å•å†…å®¹, ä¸€äº›åªæœ‰å•çº¯å‡½æ•°è®¡ç®—çš„å±‚.</p>
<p>å¯¹äºç½‘ç»œä¸­çš„å±‚, æˆ‘ä»¬éœ€è¦å®ç°å‰å‘å’Œåå‘ä¸¤ä¸ªåŠŸèƒ½å³å¯, å› æ­¤å…ˆå£°æ˜åŸºç±» <code>NetworkLayer</code>.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NetworkLayer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure>

<p>åªæœ‰ä¸¤ä¸ªæ–¹æ³•, <code>forward</code> å’Œ <code>bacckward</code>, åˆ†åˆ«ä»£è¡¨å‰å‘å’Œåå‘è®¡ç®—, è€Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„è¾“å…¥è¾“å‡ºæœ‰ä»¥ä¸‹å…³ç³».</p>
<ul>
<li><code>forward</code> çš„è¾“å…¥ <code>x</code> å½¢çŠ¶ç­‰äºåå‘çš„è¾“å‡ºå½¢çŠ¶, è¿”å›å€¼ä¸ºå‡½æ•°è®¡ç®—å€¼.</li>
<li><code>backward</code> çš„è¾“å…¥ <code>last_x_grad</code> å½¢çŠ¶ç­‰äºå‰å‘çš„è¾“å‡ºå½¢çŠ¶, è¿”å›å€¼ä¸ºä¸Šä¸€å±‚è¾“å…¥çš„æ¢¯åº¦.</li>
</ul>
<div class="note info"><p>å…¶å®æ›´å®Œå¤‡çš„åå‘ä¼ æ’­åšæ³•å¹¶ä¸æ˜¯ç›´æ¥è¿”å› $x$ çš„æ¢¯åº¦, å› ä¸ºè®¡ç®—å›¾ä¸­å¯èƒ½å­˜åœ¨éœ€è¦æ¢¯åº¦ç´¯åŠ çš„æƒ…å†µ, æ„å»ºå®Œæ•´çš„å›¾ç„¶åéå†æ‰æ˜¯æ­£ç¡®çš„åšæ³•.</p>
<p>ä½†æ˜¯ç”±äºæœ¬æ–‡è¦å®ç°çš„å·ç§¯ç¥ç»ç½‘ç»œ, æ•´ä¸ªè®¡ç®—å›¾åªæœ‰ä¸€æ¡è·¯å¾„, å¹¶ä¸”ä»¥ $x$ ä¸ºä¸»çº¿è·¯, æ‰€ä»¥å…³äº $x$ çš„æ¢¯åº¦å¯ä»¥ç›´æ¥è¢«è¿”å›ä¾æ¬¡å‘å‰ä¼ é€’, åŒæ—¶åœ¨æ¯æ¬¡æ±‚è§£å„ä¸ªå‚æ•°çš„æ¢¯åº¦æ—¶, ä¹Ÿä¸å¿…è¿›è¡Œç´¯åŠ , ç›´æ¥æ¸…ç©ºé‡æ–°èµ‹å€¼å³å¯, è¿™ä¸€ç‚¹åœ¨åç»­çš„ä»£ç å®ç°ä¸­å¯ä»¥çœ‹åˆ°.</p></div>

<h3 id="Pooling"><a href="#Pooling" class="headerlink" title="Pooling"></a>Pooling</h3><p>åœ¨å·ç§¯ç¥ç»ç½‘ç»œä¸­, æˆ‘ä»¬éœ€è¦ç”¨åˆ°æœ€å¤§æ± åŒ–å±‚, è¿™é‡Œæˆ‘ä»¬ç®€å•èµ·è§, åªå®ç°æ ¸å¤§å°ç­‰äºä¸¤ä¸ªæ–¹å‘ä¸Šæ­¥é•¿ä¸”èƒ½æ•´é™¤å›¾ç‰‡å®½é«˜çš„æƒ…å†µ. ä»¥å›¾ç‰‡å¤§å° $6 \times 4$, æ ¸å¤§å°ä¸º $3 \times 2$ ä¸¾ä¾‹, æ± åŒ–è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º.</p>
<p><img data-src="/static/image/cnn-numpy-1/pooling.jpg" alt="pooling.jpg"></p>
<p>å¯¹äºå‰å‘ä¼ æ’­, è™šçº¿æ˜¯ä½¿ç”¨å¾ªç¯éå†çš„æ–¹å¼æ±‚è§£, è€Œå®çº¿åˆ™æ˜¯é€šè¿‡æ•°ç»„å˜å½¢ä½¿ç”¨çŸ©é˜µæ–¹å¼æ±‚è§£.</p>
<p>æˆ‘ä»¬æœ¬ç¯‡ä»£ç å®ç°é‡Œ, å¯¹äºæ‰€æœ‰è®¡ç®—å‡é‡‡ç”¨çŸ©é˜µåŒ–å½¢å¼å®ç°, æ¯ä¸€å°èŠ‚éƒ½æœ‰è¯¦ç»†çš„è®²è§£. å› æ­¤åªçœ‹å®çº¿éƒ¨åˆ†å³å¯.</p>
<p>é‡ç‚¹å…³æ³¨åå‘ä¼ æ’­, å¯¹äºæ± åŒ–æ“ä½œè€Œè¨€, æ± åŒ–åçš„å€¼è¢«åŸå°ä¸åŠ¨çš„ä¼ é€’åˆ°ä¸‹ä¸€å±‚, ç›¸å½“äºæ˜¯ $y = x$ å‡½æ•°, å› æ­¤è¿™äº›å€¼åœ¨è¿™ä¸€å±‚çš„æ¢¯åº¦ä¸º 1. è€Œæ²¡æœ‰è¢«ä¼ é€’çš„å€¼, ç›¸å½“äºæ˜¯å¸¸æ•°å‡½æ•° $y = 0$, å› æ­¤æ¢¯åº¦å€¼ä¸º 0.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MaxPoolingLayer</span>(<span class="title class_ inherited__">NetworkLayer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ­¥é•¿ä¸æ ¸å¤§å°ç›¸åŒçš„æœ€å¤§æ± åŒ–å±‚&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, k1: <span class="built_in">int</span>, k2: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.k1 = k1</span><br><span class="line">        self.k2 = k2</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, C, H, W)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x: (B, C, H / k1, W / k2)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        _, c, h, w = x.shape</span><br><span class="line">        k1 = self.k1</span><br><span class="line">        k2 = self.k2</span><br><span class="line">        o1 = h // k1</span><br><span class="line">        o2 = w // k2</span><br><span class="line"></span><br><span class="line">        x = x.reshape(-<span class="number">1</span>, o1, k1, o2, k2).transpose(<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>).reshape(-<span class="number">1</span>, k1 * k2)</span><br><span class="line">        ridx = np.arange(x.shape[<span class="number">0</span>])</span><br><span class="line">        cidx = np.argmax(x, axis=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        x = x[ridx, cidx].reshape(-<span class="number">1</span>, c, o1, o2)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, C, H, W)</span></span><br><span class="line"><span class="string">            last_x_grad: (B, C, H / k1, W / k2)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x_grad: (B, C, H, W)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        _, c, h, w = x.shape</span><br><span class="line">        k1 = self.k1</span><br><span class="line">        k2 = self.k2</span><br><span class="line">        o1 = h // k1</span><br><span class="line">        o2 = w // k2</span><br><span class="line"></span><br><span class="line">        x = x.reshape(-<span class="number">1</span>, o1, k1, o2, k2).transpose(<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>).reshape(-<span class="number">1</span>, k1 * k2)</span><br><span class="line">        ridx = np.arange(x.shape[<span class="number">0</span>])</span><br><span class="line">        cidx = np.argmax(x, axis=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        x_grad: np.ndarray = np.zeros_like(x).reshape(-<span class="number">1</span>, k1 * k2)</span><br><span class="line">        x_grad[ridx, cidx] = last_x_grad.reshape(-<span class="number">1</span>)</span><br><span class="line">        x_grad = x_grad.reshape((-<span class="number">1</span>, o1, o2, k1, k2)).transpose((<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">4</span>)).reshape((-<span class="number">1</span>, c, h, w))</span><br><span class="line">        <span class="keyword">return</span> x_grad</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡Œçš„è¾“å…¥è¾“å‡ºéƒ½æ˜¯åŒ…å«æ ·æœ¬æ•°å’Œé€šé“æ•°çš„, ä½†æ˜¯æ²¡å…³ç³», æˆ‘ä»¬å½“ä½œæœ‰ $B \times C$ å¼ äºŒç»´å›¾ç‰‡å³å¯, <code>numpy</code> ä¼šè‡ªåŠ¨æŠŠæˆ‘ä»¬çš„æ­¥éª¤æŒ‰å•å¼ å›¾ç‰‡è¿›è¡Œæ‰¹é‡æ“ä½œ.</p>
<h3 id="ReLU"><a href="#ReLU" class="headerlink" title="ReLU"></a>ReLU</h3><p>ReLU æ˜¯æœ¬æ–‡å·ç§¯ç¥ç»ç½‘ç»œä¸­å°†è¦ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°, å®ƒçš„è¡¨è¾¾å¼ä¸º:</p>
<p>$$<br>ReLU(x) = \left\{<br>  \begin{aligned}<br>    x \quad x &gt; 0 \\<br>    0 \quad x \leq 0<br>  \end{aligned}<br>  \right.<br>$$</p>
<p>ç„¶åå¯¹åº”çš„å¯¼æ•°è¡¨è¾¾å¼ä¸º:</p>
<p>$$<br>ReLU&#39;(x) = \left\{<br>  \begin{aligned}<br>    1 \quad x &gt; 0 \\<br>    0 \quad x \leq 0<br>  \end{aligned}<br>  \right.<br>$$</p>
<p>å¯ä»¥çœ‹åˆ°, æ— è®ºæ˜¯å‡½æ•°è¿˜æ˜¯å¯¼å‡½æ•°, å°±æ˜¯ä¸€ä¸ªåˆ†æ®µå‡½æ•°, å› æ­¤å®ç°èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“çš„.</p>
<p>å¯¹äºå‰å‘è¿‡ç¨‹, å°†å°äºç­‰äº 0 çš„éƒ¨åˆ†ç½®é›¶, å¯¹äºåå‘éƒ¨åˆ†, å°†è¾“å…¥ä¸­å°äºç­‰äº 0 éƒ¨åˆ†çš„æ¢¯åº¦ç½®é›¶, å…¶ä½™æ¢¯åº¦æŒ‰åŸå€¼ä¼ é€’å³å¯.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReLULayer</span>(<span class="title class_ inherited__">NetworkLayer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ReLU&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> x * (x &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> last_x_grad * (x &gt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten"></a>Flatten</h3><p>åœ¨æˆ‘ä»¬ç½‘ç»œçš„æœ«å°¾, å…¨è¿æ¥å±‚çš„ä¹‹å‰, éœ€è¦ä¸€ä¸ª Flatten å±‚, å®ƒèƒ½å¤Ÿå°†äºŒç»´çš„æ ·æœ¬å±•å¹³æˆä¸€ç»´, ä»è€Œé€è¿›å…¨è¿æ¥å±‚è¿›è¡Œæœ€åçš„åˆ†ç±».</p>
<p>è¿™é‡Œçš„å‰å‘å’Œåå‘å°±ååˆ†ç®€å•äº†, è¿™æ˜¯ä¸€ä¸ªç­‰å€¼å‡½æ•°, åªéœ€è¦å¯¹è¾“å…¥è¾“å‡ºè¿›è¡Œç»´åº¦å˜æ¢å°±èƒ½å®Œæˆæ­£ç¡®çš„è®¡ç®—è¿‡ç¨‹.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FlattenLayer</span>(<span class="title class_ inherited__">NetworkLayer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Flatten&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, start: <span class="built_in">int</span> = <span class="number">1</span>, end: <span class="built_in">int</span> = -<span class="number">1</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.start = start</span><br><span class="line">        self.end = end</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">        shape = x.shape</span><br><span class="line">        shapen_len = <span class="built_in">len</span>(shape)</span><br><span class="line">        start = (self.start + shapen_len) % shapen_len</span><br><span class="line">        end = (self.end + shapen_len) % shapen_len</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x.reshape(shape[:start] + (-<span class="number">1</span>, ) + shape[end + <span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> last_x_grad.reshape(x.shape)</span><br></pre></td></tr></table></figure>

<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å—é™äºç¯‡å¹…é—®é¢˜, æœ¬æ–‡åˆ°æ­¤å°±æš‚å‘Šä¸€æ®µè½äº†. åœ¨æœ¬ç¯‡ä¸­, æˆ‘ä»¬å®Œæˆäº†å¯¹æ•°æ®é›†çš„åŠ è½½å’Œç®€å•çš„é¢„å¤„ç†, åŒæ—¶å›é¡¾äº†ç¥ç»ç½‘ç»œçš„åŸºæœ¬åŸç†å¹¶å®ç°äº†ç®€å•çš„æ— å‚æ•°ç½‘ç»œå±‚, åŒ…æ‹¬ä¸€äº›å˜æ¢å’Œæ¿€æ´»å‡½æ•°ç­‰ç­‰.</p>
<p>ä¸‹ä¸€ç¯‡ä¸­, æˆ‘ä»¬å°†å®ç°å·ç§¯ç¥ç»ç½‘ç»œä¸­ç”¨åˆ°çš„ä¸¤ä¸ªæœ‰å‚æ•°ç½‘ç»œå±‚, çº¿æ€§å±‚å’Œå·ç§¯å±‚, å¹¶ä¸”å®Œæˆå¯¹å®ƒä»¬å‰å‘å’Œåå‘è¿‡ç¨‹çš„æ¨å¯¼, ä»¥åŠç½‘ç»œçš„æœ€åä¸€å±‚, æŸå¤±å‡½æ•°çš„æ¨å¯¼å’Œå®ç°.</p>
<p>æœ¬ç³»åˆ—æ–‡ç« ä¼ é€é—¨:</p>
<ul>
<li><a href="/posts/2023/10/13/cnn-numpy-1/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸€)</a></li>
<li><a href="/posts/2023/10/14/cnn-numpy-2/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (äºŒ)</a></li>
<li><a href="/posts/2023/10/15/cnn-numpy-3/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸‰)</a></li>
</ul>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>numpy</tag>
        <tag>æ‰‹å†™æ•°å­—è¯†åˆ«</tag>
        <tag>å·ç§¯ç¥ç»ç½‘ç»œ</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (äºŒ)</title>
    <url>//posts/2023/10/14/cnn-numpy-2/</url>
    <content><![CDATA[<blockquote>
<p>&quot;åŸºäº numpy çš„æ‰‹å†™æ•°å­—è¯†åˆ«&quot;, è¿™ä¸€ç»å…¸é—®é¢˜é™¤äº†ç”¨ä½œæ·±åº¦å­¦ä¹ å…¥é—¨å†…å®¹, è¿˜è¢«å¹¿æ³›ä½œä¸ºå„å¤§è¯¾ç¨‹çš„è¯¾ç¨‹ä½œä¸š, å› æ­¤åœ¨å„å¤§æœç´¢å¼•æ“ä¸Šæœç´¢ç‡ä¹Ÿæ˜¯ç›¸å½“ä¹‹é«˜<del>(ä»£ç å¤ç”¨ç‡ä¹Ÿæ˜¯ç›¸å½“ä¹‹é«˜)</del>. ç½‘ä¸Šç¡®å®æœ‰æŒºå¤šç°æˆçš„å¯ä½¿ç”¨ä»£ç , ä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯é€ çš„å…¨è¿æ¥ç½‘ç»œ, å¹¶ä¸”å¾ˆå¤šæ—¶å€™å†…éƒ¨åŸç†ä¸æ˜¯ç‰¹åˆ«æ¸…æ™°. å› æ­¤å†³å®šè‡ªå·±ä¹Ÿæ¥é€ ä¸€æ¬¡è½®å­, ä½¿ç”¨ <code>numpy</code> å®ç°ä¸€ä¸ªç®€å•çš„å·ç§¯ç¥ç»ç½‘ç»œè¿›è¡Œæ‰‹å†™æ•°å­—è¯†åˆ«, æ­£å¥½ä¹Ÿèƒ½å€Ÿæ­¤æœºä¼šæ¢³ç†ä¸€ä¸‹ç¥ç»ç½‘ç»œçš„åŸºæœ¬åŸç†.</p>
<p>å…¨æ–‡åŒ…å«å®Œæ•´çš„å·ç§¯ç½‘ç»œå®ç°, ä»¥åŠçŸ©é˜µæ¢¯åº¦å’Œå·ç§¯çŸ©é˜µåŒ–çš„æ¨å¯¼è¿‡ç¨‹, ç”±äºå…¨æ–‡è¿‡é•¿, å› æ­¤åˆ†æˆäº†ä¸‰éƒ¨åˆ†, å†…å®¹ä¸Šæ˜¯å®Œå…¨è¿ç€çš„.</p>
</blockquote>
<p>æœ¬æ–‡ä¸ºç¬¬äºŒç¯‡, ä»‹ç»å«å‚æ•°ç½‘ç»œå±‚å’ŒæŸå¤±å‡½æ•°çš„å®ç°, ä»¥åŠåå‘ä¼ æ’­æ—¶çš„æ¢¯åº¦æ¨å¯¼.</p>
<span id="more"></span>

<p>æœ¬ç³»åˆ—æ–‡ç« ä¼ é€é—¨:</p>
<ul>
<li><a href="/posts/2023/10/13/cnn-numpy-1/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸€)</a></li>
<li><a href="/posts/2023/10/14/cnn-numpy-2/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (äºŒ)</a></li>
<li><a href="/posts/2023/10/15/cnn-numpy-3/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸‰)</a></li>
</ul>
<h2 id="å«å‚æ•°ç½‘ç»œå±‚"><a href="#å«å‚æ•°ç½‘ç»œå±‚" class="headerlink" title="å«å‚æ•°ç½‘ç»œå±‚"></a>å«å‚æ•°ç½‘ç»œå±‚</h2><p>ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬ç»“æŸäº†æ— å‚æ•°ç½‘ç»œå±‚çš„å†…å®¹, æˆ‘ä»¬æ¥åˆ°ç½‘ç»œçš„é‡ç‚¹éƒ¨åˆ†, å«å‚æ•°å±‚. è¿™ä¸€ç±»å±‚ä¾ç„¶éœ€è¦å®ç° <code>forward</code> å’Œ <code>backward</code> æ–¹æ³•, ä½†æ˜¯åœ¨ <code>backward</code> æ–¹æ³•ä¸­éœ€è¦è®¡ç®—è‡ªå·±æ‹¥æœ‰çš„å‚æ•°çš„æ¢¯åº¦å€¼å¹¶å­˜èµ·æ¥, åŒæ—¶éœ€è¦æ–°å¢ <code>update</code> æ–¹æ³•, ç”¨äºæŒ‰ç…§æ¢¯åº¦å€¼æ›´æ–°è‡ªå·±çš„å‚æ•°.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ParamLayer</span>(<span class="title class_ inherited__">NetworkLayer</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, lr: <span class="built_in">float</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure>

<p>ç»§æ‰¿ä¸€ä¸‹ <code>NetworkLayer</code> ç±», å¹¶ä¸”å¢åŠ ä¸€ä¸ª <code>update</code> æ–¹æ³•, è¯¥æ–¹æ³•æ¥æ”¶å­¦ä¹ ç‡ <code>lr</code> ä½œä¸ºå‚æ•°.</p>
<h3 id="Linear"><a href="#Linear" class="headerlink" title="Linear"></a>Linear</h3><p>é¦–å…ˆæ˜¯çº¿æ€§å±‚, ä¹Ÿæ˜¯å«å­¦ä¹ å‚æ•°ä¸­æœ€ç®€å•çš„å±‚, å…ˆä¸Šå›¾.</p>
<p><img data-src="/static/image/cnn-numpy-2/linear.jpg" alt="linear.jpg"></p>
<p>æ–¹ä¾¿èµ·è§, è¿™é‡Œæˆ‘ä»¬çš„è¾“å…¥éƒ½æ˜¯è¡Œå‘é‡çš„å½¢å¼, å› æ­¤ç¬¬ä¸€ç»´æ˜¯æ ·æœ¬æ•°, ç¬¬äºŒç»´æ˜¯ç‰¹å¾æ•°.</p>
<p>ä¸€èˆ¬çš„, è®¾ $\mathbf{X}$ ä¸ºä¸€ä¸ª $n \times d_1$ çš„çŸ©é˜µ, æƒé‡ $\mathbf{W}$ ä¸ºä¸€ä¸ª $d_1 \times d_2$ çš„çŸ©é˜µ, $\mathbf{b}$ ä¸ºé•¿åº¦ $d_2$ çš„åç½®å‘é‡, åˆ™ $\mathbf{Y}, \mathbf{Z}$ å‡ä¸º $n \times d_2$. çº¿æ€§å±‚çš„å¯å­¦ä¹ å‚æ•°å°±æ˜¯ $\mathbf{W}$ å’Œ $\mathbf{b}$.</p>
<p>å›¾ä¸Šé«˜äº®éƒ¨åˆ†è¡¨ç¤ºå¯¹æœ€ç»ˆè¾“å‡º $z_{11}$ çš„è®¡ç®—è¿‡ç¨‹, è€Œå¯¹ $z_{ik}$ çš„è®¡ç®—è¿‡ç¨‹ç”¨å…¬å¼è¡¨ç¤ºå¦‚ä¸‹:</p>
<p>$$<br>z_{ik} = \sum_{j=1}^{d_1}{x_{ij}w_{jk}} + b_k<br>$$</p>
<p>å†™æˆçŸ©é˜µå½¢å¼å°±æ˜¯:</p>
<p>$$<br>\mathbf{Z} = \mathbf{X}\mathbf{W} + \mathbf{b}<br>$$</p>
<p>å…¶ä¸­ $\mathbf{b}$ éœ€è¦é‡å¤æ¯ä¸€è¡Œæ‰©å±•æˆçŸ©é˜µ.</p>
<p>å‰å‘è®¡ç®—å°±åˆ°æ­¤ç»“æŸäº†, ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹åå‘ä¸­æ¢¯åº¦æ˜¯å¦‚ä½•è®¡ç®—çš„.</p>
<p>é¦–å…ˆæ˜¯ $\mathbf{b}$ çš„, è¿™ä¸€å±‚ä¸­, å¯¹äº $b_k$ è€Œè¨€, å› ä¸ºæ˜¯åŠ ä¸Šå¸¸æ•°, æ‰€ä»¥éƒ½æ˜¯ 1, å› æ­¤åªéœ€è¦ç›´æ¥ç­‰äºä¸Šä¸€å±‚ä¼ è¿›æ¥çš„æ¢¯åº¦å³å¯. å†ç”±é“¾å¼æ³•åˆ™é‡Œçš„åŠ æ³•æ³•åˆ™å¯çŸ¥, åŒä¸€ä¸ª $b_k$ æ¯ä¸ªæ ·æœ¬ä¸­éƒ½å‚ä¸äº†è¿ç®—, å› æ­¤éœ€è¦æŠŠåä¸€å±‚ä¼ è¿‡æ¥çš„æ¢¯åº¦è¿›è¡Œç´¯åŠ .</p>
<p>è®¾æœ€ç»ˆæŸå¤±ä¸º $L$, åˆ™:</p>
<p>$$<br>\begin{aligned}<br>  \frac{\partial{L}}{\partial{b_k}} &amp;= \sum_{i=1}^{n}{\frac{\partial{L}}{\partial{z_{ik}}}\frac{\partial{z_{ik}}}{\partial{b_k}}} \\<br>  ~ &amp;= \sum_{i=1}^{n}{\frac{\partial{L}}{\partial{z_{ik}}}} \cdot 1<br>\end{aligned}<br>$$</p>
<p>æ‰€ä»¥ $\mathbf{b}$ çš„æ¢¯åº¦å°±æ˜¯æŠŠåä¸€å±‚ä¼ è¿›æ¥å…³äº $z$ çš„æ¢¯åº¦æŒ‰è¡Œç´¯åŠ å³å¯.</p>
<p>ä¸‹é¢æ¥çœ‹å…³äº $\mathbf{W}$ çš„æ¢¯åº¦. åœ¨ $z_{ik}$ çš„è¡¨è¾¾å¼ä¸­, $b_k$ ä½œä¸ºå¸¸æ•°å­˜åœ¨, å› æ­¤å¯ä»¥å¿½ç•¥, æ‰€ä»¥æ¢¯åº¦åªä¸ $x_{ij}$ æœ‰å…³, æ‰€ä»¥æˆ‘ä»¬ç¬¬ä¸€æ­¥æ˜¯æ‰¾å‡ºæ¥å«æœ‰ $w_{jk}$ çš„ç»“æœæœ‰å“ªäº›.</p>
<p>æ³¨æ„åˆ° $w_{jk}$ æ˜¯ä¸åŒ…å«ä¸‹æ ‡ $i$ çš„, å› æ­¤åœ¨ $z_{1k}, z_{2k}, \ldots, z_{nk}$ ä¸­éƒ½æ˜¯æœ‰ $w_{jk}$ çš„. æ‰€ä»¥:</p>
<p>$$<br>\begin{aligned}<br>  \frac{\partial{L}}{\partial{w_{jk}}} &amp;= \sum_{i=1}^{n}{\frac{\partial{L}}{\partial{z_{ik}}}\frac{\partial{z_{ik}}}{\partial{w_{jk}}}} \\<br>  ~ &amp;= \sum_{i=1}^{n}{\frac{\partial{L}}{\partial{z_{ik}}}x_{ij}}<br>\end{aligned}<br>$$</p>
<p>æ¢æˆçŸ©é˜µå½¢å¼åˆ™æ˜¯:</p>
<p>$$<br>\frac{\partial{L}}{\partial{\mathbf{W}}} = \mathbf{X}^\top\frac{\partial{L}}{\partial{\mathbf{Z}}}<br>$$</p>
<p>å…¶ä¸­ $\frac{\partial{L}}{\partial{\mathbf{Z}}}$ æ˜¯æœ€ç»ˆæŸå¤± $L$ å¯¹ $z_{ik}$ çš„æ¢¯åº¦çŸ©é˜µ, å½¢çŠ¶ä¸ $\mathbf{Z}$ ç›¸åŒ.</p>
<p>æœ€åæˆ‘ä»¬æ¥çœ‹å…³äº $\mathbf{X}$ çš„æ¢¯åº¦, æœ‰äº†æ±‚ $\mathbf{W}$ æ¢¯åº¦çš„ç»éªŒ, æˆ‘ä»¬å¾ˆå®¹æ˜“å†™å‡ºä¸‹åˆ—æ¨å¯¼:</p>
<p>$$<br>\begin{aligned}<br>  \frac{\partial{L}}{\partial{x_{ij}}} &amp;= \sum_{k=1}^{d_2}{\frac{\partial{L}}{\partial{z_{ik}}}\frac{\partial{z_{ik}}}{\partial{x_{ij}}}} \\<br>  ~ &amp;= \sum_{k=1}^{d_2}{\frac{\partial{L}}{\partial{z_{ik}}}w_{jk}}<br>\end{aligned}<br>$$</p>
<p>åŒæ ·å¯ä»¥æ¢æˆçŸ©é˜µå½¢å¼:</p>
<p>$$<br>\frac{\partial{L}}{\partial{\mathbf{X}}} = \frac{\partial{L}}{\partial{\mathbf{Z}}}\mathbf{W}^\top<br>$$</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å®Œæˆå¯¹çº¿æ€§å±‚çš„å‰å‘å’Œåå‘è¿‡ç¨‹æ¨å¯¼, çŸ©é˜µå½¢å¼çš„å…¬å¼æ€»ç»“å°±æ˜¯:</p>
<p>å‰å‘:</p>
<p>$$<br>\mathbf{Z} = \mathbf{X}\mathbf{W} + \mathbf{b}<br>$$</p>
<p>åå‘:</p>
<p>$$<br>\begin{aligned}<br>    \frac{\partial{L}}{\partial{b_k}} &amp;= \sum_{i=1}^{n}{\frac{\partial{L}}{\partial{z_{ik}}}} \\<br>    \frac{\partial{L}}{\partial{\mathbf{W}}} &amp;= \mathbf{X}^\top\frac{\partial{L}}{\partial{\mathbf{Z}}} \\<br>    \frac{\partial{L}}{\partial{\mathbf{X}}} &amp;= \frac{\partial{L}}{\partial{\mathbf{Z}}}\mathbf{W}^\top<br>\end{aligned}<br>$$</p>
<p>è¿™ä¸ªç»“è®ºå¾ˆé‡è¦, åœ¨å·ç§¯å±‚ä¸­è¿˜ä¼šç”¨åˆ°.</p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥æŒ‰ç…§å…¬å¼å®Œæˆçº¿æ€§å±‚çš„ä»£ç .</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LinearLayer</span>(<span class="title class_ inherited__">ParamLayer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;çº¿æ€§å±‚&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d1: <span class="built_in">int</span>, d2: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.w = np.random.random((d1, d2)) * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line">        self.b = np.random.random((<span class="number">1</span>, d2)) * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self.w_grad = np.zeros_like(self.w)</span><br><span class="line">        self.b_grad = np.zeros_like(self.b)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, d1)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x: (B, d2)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x @ self.w + self.b</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, d1)</span></span><br><span class="line"><span class="string">            last_grad: (B, d2)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x_grad: (B, d1)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.b_grad = last_x_grad.<span class="built_in">sum</span>(<span class="number">0</span>, keepdims=<span class="literal">True</span>)</span><br><span class="line">        self.w_grad = x.T @ last_x_grad</span><br><span class="line"></span><br><span class="line">        x_grad = last_x_grad @ self.w.T</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x_grad</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, lr: <span class="built_in">float</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.w -= lr * self.w_grad</span><br><span class="line">        self.b -= lr * self.b_grad</span><br></pre></td></tr></table></figure>

<p><code>update</code> æ–¹æ³•å°±æ˜¯æŒ‰å­¦ä¹ ç‡ <code>lr</code> ç»™æ¯ä¸ªå‚æ•°å‡å»ç›¸åº”çš„æ¢¯åº¦å°±è¡Œäº†.</p>
<p>ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹æ˜¯ <code>__init__</code> ä¸­, å¯¹ <code>w</code> å’Œ <code>b</code> çš„åˆå§‹åŒ–æ˜¯ä½¿ç”¨äº† -1 åˆ° 1 ä¹‹é—´çš„å‡åŒ€åˆ†å¸ƒ, è¿™æœ‰åŠ©äºè®­ç»ƒçš„ç¨³å®šæ€§, é˜²æ­¢å‡ºç°æ¢¯åº¦çˆ†ç‚¸.</p>
<h3 id="Convolution"><a href="#Convolution" class="headerlink" title="Convolution"></a>Convolution</h3><p>è¿™é‡Œæˆ‘ä»¬åªå®ç°æ­¥é•¿ä¸º 1 çš„æ— å¡«å……å·ç§¯æ“ä½œ.</p>
<h4 id="å·ç§¯åŠå…¶å‚æ•°ç»´åº¦"><a href="#å·ç§¯åŠå…¶å‚æ•°ç»´åº¦" class="headerlink" title="å·ç§¯åŠå…¶å‚æ•°ç»´åº¦"></a>å·ç§¯åŠå…¶å‚æ•°ç»´åº¦</h4><p>å·ç§¯å±‚æ˜¯æ•´ä¸ªç½‘ç»œçš„æ ¸å¿ƒå±‚, ç½‘ç»œä¹Ÿå› æ­¤å¾—åå·ç§¯ç¥ç»ç½‘ç»œ, ç”¨ä¸‹å›¾æ¥ç®€å•å›é¡¾ä¸€ä¸‹ç½‘ç»œé‡Œçš„å·ç§¯æ“ä½œ.</p>
<p><img data-src="/static/image/cnn-numpy-2/conv.jpg" alt="conv.jpg"></p>
<p>å·ç§¯æ ¸ $\mathbf{K}$ åœ¨è¾“å…¥ $\mathbf{X}$ ä¸Šé€æ­¥ç§»åŠ¨, å°†æ¯ä¸ªä½ç½®ä¸Šçš„å€¼ç›¸ä¹˜å¹¶æ±‚å’Œ, å¾—åˆ°å·ç§¯åçš„ç»“æœ $\mathbf{Y}$, ç„¶åå¯¹äºæ¯ä¸€æ¬¡å·ç§¯éƒ½åŠ ä¸Šä¸€ä¸ªåç½®å¸¸æ•° $b$, å¾—åˆ°ç½‘ç»œä¸­å¯¹äºå•å¼ å›¾ç‰‡å•é€šé“çš„å®Œæ•´å·ç§¯è¿‡ç¨‹.</p>
<p>å¦‚æœæ˜¯å¤šé€šé“çš„æƒ…å†µ, è®¾è¾“å…¥ $\mathbf{X}$ çš„é€šé“æ•°æ˜¯ $c_1$, è¾“å‡ºé€šé“æ•°æ˜¯ $c_2$.</p>
<p>è¾“å…¥ $\mathbf{X}$ çš„å½¢çŠ¶å˜ä¸º $n \times c_1 \times h_\mathbf{X} \times w_\mathbf{X}$, å…¶ä¸­ $n$ æ˜¯æ ·æœ¬æ•°, $h_\mathbf{X}, w_\mathbf{X}$ åˆ†åˆ«æ˜¯å›¾ç‰‡çš„é«˜å®½.</p>
<p>é‚£ä¹ˆå¯¹äº $\mathbf{K}$ è€Œè¨€, è¾“å…¥é€šé“æ•°ä» $1$ å˜æˆ $c_1$, æ‰€ä»¥æ¯ä¸€æ¬¡å·ç§¯éƒ½éœ€è¦ $c_1$ ä¸ªå•å±‚çš„ $\mathbf{K}$. è¿›ä¸€æ­¥, è¾“å‡ºé€šé“æ•°ä» $1$ å˜æˆ $c_2$, å› æ­¤æ€»å…±éœ€è¦ $c_2 \times c_1$ ä¸ªå•å±‚å·ç§¯æ ¸. æ‰€ä»¥æœ€ç»ˆå·ç§¯æ ¸ $\mathbf{K}$ çš„å½¢çŠ¶ä¸º $c_2 \times c_1 \times h_\mathbf{K} \times w_\mathbf{K}$, å…¶ä¸­ $h_\mathbf{K}, w_\mathbf{K}$ åˆ†åˆ«è¡¨ç¤ºå·ç§¯æ ¸çš„é«˜å®½.</p>
<p>å¯¹äº $b$ è€Œè¨€, åªå’Œè¾“å‡ºé€šé“æ•°æœ‰å…³, å› æ­¤å˜æˆäº†ä¸€ä¸ªé•¿åº¦ä¸º $c_2$ å‘é‡ $\mathbf{b}$, åœ¨å…¶ä»–ç»´åº¦ä¸Šé‡å¤æ•°å€¼å³å¯.</p>
<p>åœ¨å·ç§¯å±‚ä¸­, $\mathbf{K}$ å’Œ $\mathbf{b}$ å°±æ˜¯éœ€è¦è¢«å­¦ä¹ çš„å‚æ•°.</p>
<h4 id="å·ç§¯çŸ©é˜µåŒ–"><a href="#å·ç§¯çŸ©é˜µåŒ–" class="headerlink" title="å·ç§¯çŸ©é˜µåŒ–"></a>å·ç§¯çŸ©é˜µåŒ–</h4><p>åŸºæœ¬çš„å·ç§¯æ“ä½œéœ€è¦å¤šé‡å¾ªç¯, æ— æ³•å……åˆ†åˆ©ç”¨ GPU ç­‰ç¡¬ä»¶è®¾å¤‡çš„åŠ é€Ÿæ•ˆæœ, å› æ­¤éœ€è¦å°†å¸¸è§„çš„å·ç§¯æ“ä½œè½¬åŒ–æˆçŸ©é˜µå½¢å¼, ä»è€Œæ‰¹é‡è¿ç®—.</p>
<p>æœ‰ä¸¤ç§æ•°æ®é‡ç»„æ–¹å¼å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœ, åˆ†åˆ«æ˜¯å¯¹è¾“å…¥ $\mathbf{X}$ å’Œå·ç§¯æ ¸ $\mathbf{K}$ è¿›è¡Œæ•°æ®é‡ç»„. é¦–å…ˆä»‹ç»ç¬¬ä¸€ç§æ–¹å¼, å¯¹ $\mathbf{X}$ è¿›è¡Œæ•°æ®é‡ç»„, è€Œ $\mathbf{K}$ åªéœ€è¦ä¿æŒæ•°æ®ä¸å˜, ç»´åº¦å˜æ¢å³å¯.</p>
<p><img data-src="/static/image/cnn-numpy-2/unfold_x.jpg" alt="unfold_x.jpg"></p>
<p>ä¸Šå›¾å±•ç¤ºçš„æ˜¯å¯¹äºä¸€ä¸ªæ ·æœ¬ä¸‹çŸ©é˜µåŒ–è¿ç®—, å¦‚æœæ˜¯ $n$ ä¸ªæ ·æœ¬, $\mathbf{X&#39;}$ å’Œ $\mathbf{Y&#39;}$ åœ¨è¡Œä¸Šå˜æˆ $n$ å€å³å¯.</p>
<p>è¿™é‡Œ, $h_{\mathbf{Y}} = h_{\mathbf{X}} - h_{\mathbf{K}} + 1$, $w_{\mathbf{Y}} = w_{\mathbf{X}} - w_{\mathbf{K}} + 1$, æ˜¯å·ç§¯åçš„å›¾åƒé«˜å®½.</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹, å˜å½¢åçš„ $\mathbf{K}&#39;$ å’ŒåŸå§‹çš„ $\mathbf{K}$ æ•°æ®ç›¸åŒ, å‰å‘å…¬å¼ä¸º:</p>
<p>$$<br>\mathbf{Y}&#39; = \mathbf{X}&#39;\mathbf{K}&#39;^\top<br>$$</p>
<p>ç¬¬äºŒç§æ–¹å¼åˆ™æ˜¯åªå¯¹è¾“å…¥æ•°æ® $\mathbf{X}$ è¿›è¡Œå˜å½¢, å¯¹å·ç§¯æ ¸ $\mathbf{K}$ è¿›è¡Œæ•°æ®é‡ç»„.</p>
<p><img data-src="/static/image/cnn-numpy-2/unfold_k.jpg" alt="unfold_k.jpg"></p>
<p>å›¾å¤ªå¤§ç”»ä¸ä¸‹, æ‰€ä»¥ä¸­é—´éƒ¨åˆ†ç”¨çœç•¥å·çœå», åªä¿ç•™äº†ä¸€äº›å…³é”®å†…å®¹å’Œç»´åº¦ä¿¡æ¯.</p>
<p>åŒæ ·çš„, è¿™é‡Œä¹Ÿæ˜¯å±•ç¤ºäº†å¯¹äºä¸€ä¸ªæ ·æœ¬çš„çŸ©é˜µåŒ–è¿ç®—.</p>
<p>å›¾ç‰‡è¢«å®Œå…¨å±•å¹³, è€Œå·ç§¯æ ¸è¢«é‡ç»„æˆä¸­é—´åŒ…å«ä¸€äº› 0 å€¼çš„çŸ©é˜µ. åœ¨è¿™ç§æƒ…å†µä¸‹, $\mathbf{X}&#39;&#39;$ å’ŒåŸæœ¬çš„ $\mathbf{X}$ å†…å®¹å®Œå…¨ç›¸åŒ. å‰å‘å…¬å¼ä¸º:</p>
<p>$$<br>\mathbf{Y}&#39;&#39; = \mathbf{X}&#39;&#39;\mathbf{K}&#39;&#39;^\top<br>$$</p>
<h4 id="æ¢¯åº¦è®¡ç®—"><a href="#æ¢¯åº¦è®¡ç®—" class="headerlink" title="æ¢¯åº¦è®¡ç®—"></a>æ¢¯åº¦è®¡ç®—</h4><p>å·ç§¯å±‚çš„æ¢¯åº¦è®¡ç®—éƒ½æ˜¯åŸºäºçŸ©é˜µåŒ–ä¹‹åçš„å·ç§¯æ“ä½œ. é¦–å…ˆæ˜¯åç½®å‘é‡ $\mathbf{b}$ çš„æ¢¯åº¦è®¡ç®—, å‰å‘ä¸­æœ‰ä¸¤ç§æ–¹å¼èƒ½ç®—å‡º $\mathbf{Y}$, ä½†æ˜¯é€šè¿‡æ•°æ®å˜å½¢å, ä¸ $\mathbf{b}$ çš„ç›¸åŠ æ–¹å¼ç›¸åŒ, ç»“åˆå‰é¢çº¿æ€§å±‚çš„ç»“è®º, $\mathbf{b}$ çš„æ¢¯åº¦å°±æ˜¯å°†é™¤äº† $c_2$ çš„å…¶ä»–ç»´åº¦æ±‚å’Œå³å¯.</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹æœ€å…³é”®çš„ $\mathbf{K}$ å’Œ $\mathbf{X}$ çš„æ¢¯åº¦æ€ä¹ˆæ±‚, é¦–å…ˆå›å¿†çº¿æ€§å±‚å¾—åˆ°çš„ç»“è®º.</p>
<div class="note info"><p>è®¾æœ€ç»ˆçš„æŸå¤±ä¸º $L$, å½“å‰å‘ä¼ æ’­ä¸º:</p>
<p>$$<br>\mathbf{Y} = \mathbf{X}\mathbf{W}<br>$$</p>
<p>æ—¶, åˆ™åå‘ä¼ æ’­ $\mathbf{X}$ å’Œ $\mathbf{W}$ çš„æ¢¯åº¦ä¸º:</p>
<p>$$<br>\begin{aligned}<br>    \frac{\partial{L}}{\partial{\mathbf{W}}} &amp;= \mathbf{X}^\top\frac{\partial{L}}{\partial{\mathbf{Y}}} \\<br>    \frac{\partial{L}}{\partial{\mathbf{X}}} &amp;= \frac{\partial{L}}{\partial{\mathbf{Y}}}\mathbf{W}^\top<br>\end{aligned}<br>$$</p>
<p>å…¶ä¸­ $\frac{\partial{L}}{\partial{\mathbf{Y}}}$ æ˜¯æŸå¤± $L$ å¯¹è¾“å‡º $\mathbf{Y}$ çš„æŸå¤±çŸ©é˜µ, å½¢çŠ¶ä¸ $\mathbf{Y}$ ç›¸åŒ.</p></div>

<p>è¿™æ˜¯ä¸€ä¸ªé€šç”¨ç»“è®º, å¯ä»¥ç”¨äºä»»æ„çš„ä¸¤ä¸ªçŸ©é˜µç›¸ä¹˜. ç»“åˆæˆ‘ä»¬å‰é¢å¾—åˆ°äº†ä¸¤ç§ä¸åŒçš„å‰å‘è®¡ç®—æ–¹å¼:</p>
<p>$$<br>\begin{aligned}<br>  \mathbf{Y}&#39; &amp;= \mathbf{X}&#39;\mathbf{K}&#39;^\top \\<br>  \mathbf{Y}&#39;&#39; &amp;= \mathbf{X}&#39;&#39;\mathbf{K}&#39;&#39;^\top<br>\end{aligned}<br>$$</p>
<p>åœ¨è¿™ä¸¤ä¸ªä¸åŒçš„è®¡ç®—ä¸­, $\mathbf{K}&#39;$ ä¸åŸå§‹çš„ $\mathbf{K}$ ç›¸åŒ, $\mathbf{X}&#39;&#39;$ ä¸åŸå§‹çš„ $\mathbf{X}$ æ•°æ®ç›¸åŒ, åªæ˜¯è¿›è¡Œäº†æ•°æ®å˜å½¢. å› æ­¤åªè¦åˆ†åˆ«æ±‚å‡º $\mathbf{K}&#39;$ å’Œ $\mathbf{X}&#39;&#39;$ çš„æ¢¯åº¦, å†é€šè¿‡å˜å½¢å°±èƒ½å¾—åˆ°åŸå§‹ $\mathbf{K}$ å’Œ $\mathbf{X}$ çš„æ¢¯åº¦. ç»“åˆç»“è®º, æœ‰:</p>
<p>$$<br>\begin{aligned}<br>    \frac{\partial{L}}{\partial{\mathbf{K}&#39;}} &amp;= \mathbf{X}&#39;^\top\frac{\partial{L}}{\partial{\mathbf{Y}&#39;}} \\<br>    \frac{\partial{L}}{\partial{\mathbf{X}&#39;&#39;}} &amp;= \frac{\partial{L}}{\partial{\mathbf{Y}&#39;&#39;}}\mathbf{K}&#39;&#39;^\top<br>\end{aligned}<br>$$</p>
<p>å…¶ä¸­, $\frac{\partial{L}}{\partial{\mathbf{Y}&#39;}}$ å’Œ $\frac{\partial{L}}{\partial{\mathbf{Y}&#39;&#39;}}$ éƒ½å¯ä»¥é€šè¿‡å¯¹åä¸€å±‚ä¼ è¿›æ¥çš„ $\frac{\partial{L}}{\partial{\mathbf{Y}}}$ è¿›è¡Œæ•°æ®å˜å½¢å¾—åˆ°.</p>
<h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å·ç§¯å±‚çš„å‰å‘å’Œåå‘æ¨å¯¼, æŒ‰ç…§å‰é¢çš„å†…å®¹ä¾¿å¯å®Œæˆä»£ç .</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConvolutionLayer</span>(<span class="title class_ inherited__">ParamLayer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ­¥é•¿ä¸º 1 çš„å·ç§¯å±‚&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, c1: <span class="built_in">int</span>, c2: <span class="built_in">int</span>, k1: <span class="built_in">int</span>, k2: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            c1: è¾“å…¥é€šé“æ•°</span></span><br><span class="line"><span class="string">            c2: è¾“å‡ºé€šé“æ•°</span></span><br><span class="line"><span class="string">            k1: å·ç§¯æ ¸é«˜</span></span><br><span class="line"><span class="string">            k2: å·ç§¯æ ¸å®½</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.k = np.random.random((c2, c1, k1, k2)) * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line">        self.b = np.random.random((<span class="number">1</span>, c2, <span class="number">1</span>, <span class="number">1</span>)) * <span class="number">2</span> - <span class="number">1</span></span><br><span class="line">        self.k_grad = np.zeros_like(self.k)</span><br><span class="line">        self.b_grad = np.zeros_like(self.b)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unfold_k</span>(<span class="params">self, h: <span class="built_in">int</span>, w: <span class="built_in">int</span>, c1: <span class="built_in">int</span>, c2: <span class="built_in">int</span>, k1: <span class="built_in">int</span>, k2: <span class="built_in">int</span>, o1: <span class="built_in">int</span>, o2: <span class="built_in">int</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å±•å¼€å·ç§¯æ ¸ k, èƒ½å¤Ÿä¸å±•å¹³çš„å¤šé€šé“å›¾åƒç›´æ¥ç›¸ä¹˜</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            k: (c2 * o1 * o2, c1 * H * W)</span></span><br><span class="line"><span class="string">                æœ‰ c2 ä¸ª (o1 * o2, c1 * H * W) çš„å±•å¹³å·ç§¯æ ¸, æ¯ä¸€ä¸ªæ ¸å¤§å°æ˜¯ c1 * H * W, å°†åœ¨ä¸€å¼  c1 é€šé“çš„ä¸€ç»´å›¾ç‰‡ä¸Šè¿›è¡Œ o1 * o2 æ¬¡å·ç§¯</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        ridx = np.arange(o1 * o2).reshape(-<span class="number">1</span>, <span class="number">1</span>).repeat(k1 * k2, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        cidx1 = np.arange(o2).reshape(<span class="number">1</span>, -<span class="number">1</span>).repeat(k1 * k2, <span class="number">1</span>).repeat(o1, <span class="number">0</span>).reshape(o1 * o2, k1 * k2)</span><br><span class="line">        cidx2 = np.arange(k2).reshape(<span class="number">1</span>, -<span class="number">1</span>).repeat(o1 * o2 * k1, <span class="number">0</span>).reshape(o1 * o2, k1 * k2)</span><br><span class="line">        cidx3 = np.arange(<span class="number">0</span>, k1 * w, w).reshape(<span class="number">1</span>, -<span class="number">1</span>).repeat(k2, <span class="number">1</span>).repeat(o1 * o2, <span class="number">0</span>)</span><br><span class="line">        cidx4 = np.arange(<span class="number">0</span>, o1 * w, w).reshape(-<span class="number">1</span>, <span class="number">1</span>).repeat(o2, <span class="number">0</span>).repeat(k1 * k2, <span class="number">1</span>)</span><br><span class="line">        cidx = cidx1 + cidx2 + cidx3 + cidx4</span><br><span class="line"></span><br><span class="line">        k = np.zeros((c2, c1, o1 * o2, h * w))</span><br><span class="line">        k[:, :, ridx, cidx] = self.k.reshape(c2, c1, <span class="number">1</span>, k1 * k2).repeat(o1 * o2, <span class="number">2</span>)</span><br><span class="line">        k = k.transpose(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>).reshape(c2 * o1 * o2, c1 * h * w)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> k</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_unfold_x</span>(<span class="params">self, x: np.ndarray, c1: <span class="built_in">int</span>, k1: <span class="built_in">int</span>, k2: <span class="built_in">int</span>, o1: <span class="built_in">int</span>, o2: <span class="built_in">int</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å±•å¼€è¾“å…¥ x, èƒ½å¤Ÿä¸å±•å¹³çš„å·ç§¯æ ¸ç›´æ¥ç›¸ä¹˜</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, c1, H, W)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x: (B, o1 * o2, c1 * k1 * k2)</span></span><br><span class="line"><span class="string">                æ¯å¼ å›¾ç‰‡å°†ä¸ c1 é€šé“çš„ä¸€ç»´å·ç§¯æ ¸è¿›è¡Œ o1 * o2 æ¬¡å·ç§¯</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        ridx_r = np.arange(k1).reshape(<span class="number">1</span>, k1).repeat(k2, <span class="number">1</span>).repeat(o1 * o2, <span class="number">0</span>)</span><br><span class="line">        ridx_c = np.arange(o1).reshape(o1, <span class="number">1</span>).repeat(o2, <span class="number">0</span>).repeat(k1 * k2, <span class="number">1</span>)</span><br><span class="line">        ridx = ridx_r + ridx_c</span><br><span class="line"></span><br><span class="line">        cidx_r = np.arange(k2).reshape(<span class="number">1</span>, k2).repeat(k1, <span class="number">0</span>).reshape(<span class="number">1</span>, -<span class="number">1</span>).repeat(o1 * o2, <span class="number">0</span>)</span><br><span class="line">        cidx_c = np.arange(o2).reshape(<span class="number">1</span>, o2).repeat(o1, <span class="number">0</span>).reshape(-<span class="number">1</span>, <span class="number">1</span>).repeat(k1 * k2, <span class="number">1</span>)</span><br><span class="line">        cidx = cidx_r + cidx_c</span><br><span class="line"></span><br><span class="line">        x = x[:, :, ridx, cidx].transpose(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>).reshape(-<span class="number">1</span>, o1 * o2, c1 * k1 * k2)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, c1, H, W)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x: (B, c2, o1, o2)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        _, _, h, w = x.shape</span><br><span class="line">        c2, c1, k1, k2 = self.k.shape</span><br><span class="line">        o1 = h - k1 + <span class="number">1</span></span><br><span class="line">        o2 = w - k2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å±•å¼€å·ç§¯æ ¸</span></span><br><span class="line">        output = x.reshape(-<span class="number">1</span>, c1 * h * w) @ self._unfold_k(h, w, c1, c2, k1, k2, o1, o2).T</span><br><span class="line">        output = output.reshape(-<span class="number">1</span>, c2, o1, o2) + self.b</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # å±•å¼€è¾“å…¥ (B, o1 * o2, c1 * k1 * k2) @ (c1 * k1 * k2, c2) = (B, o1 * o2, c2)</span></span><br><span class="line">        <span class="comment"># output = self._unfold_x(x, c1, k1, k2, o1, o2) @ self.k.reshape(c2, c1 * k1 * k2).T</span></span><br><span class="line">        <span class="comment"># output = output.transpose(0, 2, 1).reshape(-1, c2, o1, o2) + self.b</span></span><br><span class="line">        <span class="comment"># return output</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, c1, H, W)</span></span><br><span class="line"><span class="string">            last_x_grad: (B, c2, o1, o2)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x_grad: (B, c1, H, W)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        _, _, h, w = x.shape</span><br><span class="line">        c2, c1, k1, k2 = self.k.shape</span><br><span class="line">        o1 = h - k1 + <span class="number">1</span></span><br><span class="line">        o2 = w - k2 + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        unfold_x = self._unfold_x(x, c1, k1, k2, o1, o2)</span><br><span class="line">        unfold_k = self._unfold_k(h, w, c1, c2, k1, k2, o1, o2)</span><br><span class="line"></span><br><span class="line">        self.b_grad = last_x_grad.<span class="built_in">sum</span>((<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>), keepdims=<span class="literal">True</span>)</span><br><span class="line">        self.k_grad = unfold_x.reshape(-<span class="number">1</span>, c1 * k1 * k2).T @ last_x_grad.transpose(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).reshape(-<span class="number">1</span>, c2)</span><br><span class="line">        self.k_grad = self.k_grad.transpose().reshape(c2, c1, k1, k2)</span><br><span class="line"></span><br><span class="line">        x_grad = last_x_grad.reshape(-<span class="number">1</span>, c2 * o1 * o2) @ unfold_k</span><br><span class="line">        x_grad = x_grad.reshape(-<span class="number">1</span>, c1, h, w)</span><br><span class="line">        <span class="keyword">return</span> x_grad</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, lr: <span class="built_in">float</span></span>):</span><br><span class="line">        self.k -= lr * self.k_grad</span><br><span class="line">        self.b -= lr * self.b_grad</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ <code>_unfold_k</code> å’Œ <code>_unfold_x</code> å°±æ˜¯å¯¹å·ç§¯æ ¸ $\mathbf{K}$ å’Œè¾“å…¥ $\mathbf{X}$ è¿›è¡Œæ•°æ®é‡ç»„çš„æ–¹æ³•, å¯ä»¥ç”¨äºä¸åŒçš„å‰å‘å’Œåå‘æ¢¯åº¦è®¡ç®—. å‰å‘ä¸­å®ç°ä¸¤ç§çŸ©é˜µåŒ–æ–¹æ³•çš„ä¸€ç§å°±è¡Œ, è€Œåå‘ä¸­åˆ™éœ€è¦åŒæ—¶ä½¿ç”¨ä¸¤ä¸ªæ–¹æ³•æ¥è®¡ç®—å‚æ•°æ¢¯åº¦.</p>
<h2 id="æŸå¤±å‡½æ•°å±‚"><a href="#æŸå¤±å‡½æ•°å±‚" class="headerlink" title="æŸå¤±å‡½æ•°å±‚"></a>æŸå¤±å‡½æ•°å±‚</h2><p>æœ€åæ˜¯ç½‘ç»œçš„æŸå¤±å‡½æ•°, ä» <code>Linear</code> å±‚å¾€å, å°†ç½‘ç»œçš„è¾“å‡ºä¸çœŸå®æ ‡ç­¾è¿›è¡ŒæŸå¤±è®¡ç®—.</p>
<p>è¿™é‡Œæˆ‘ä»¬å®ç°åˆ†ç±»ä»»åŠ¡æœ€å¸¸ç”¨çš„æŸå¤±å‡½æ•°, äº¤å‰ç†µæŸå¤±å‡½æ•°, å®ƒçš„å‰å‘å’Œåå‘æ‰€éœ€è¦çš„å‚æ•°ä¸å‰é¢çš„ç½‘ç»œå±‚æœ‰ä¸€äº›å°çš„åŒºåˆ«, å‡éœ€è¦è¾“å…¥çœŸå®æ ‡ç­¾å€¼.</p>
<h3 id="CrossEntropy"><a href="#CrossEntropy" class="headerlink" title="CrossEntropy"></a>CrossEntropy</h3><p>é¦–å…ˆä¸Šäº¤å‰ç†µæŸå¤±çš„å…¬å¼. æŸå¤±è®¡ç®—ä»çº¿æ€§å±‚çš„è¾“å‡ºå¼€å§‹, è®¾å‡½æ•°è¾“å…¥ä¸º $\mathbf{X}$, å½¢çŠ¶ä¸º $n \times C$, çœŸå®æ ‡ç­¾ $\mathbf{y}$ ä¸ºé•¿åº¦æ˜¯ $n$ , å–å€¼èŒƒå›´ $[1, C]$ çš„å‘é‡, åˆ™æŸå¤± $L$:</p>
<p>$$<br>\begin{aligned}<br>  L &amp;= \frac{1}{n} \sum_{i=1}^{n} {\left( -\log\left( \frac{\exp\left( {x_{i y_i}} \right)}{\sum_{j=1}^{C}{\exp\left(x_{ij}\right)}} \right) \right)} \\<br>  ~ &amp;= \frac{1}{n} \sum_{i=1}^{n} {\left( -\log\left( \frac{\exp\left({x_{i y_i} - \max_{j=1}^{C}{x_{ij}}}\right)}{\sum_{j=1}^{C}{\exp\left(x_{ij} - \max_{j=1}^{C}{x_{ij}} \right)}} \right) \right)} \\<br>  ~ &amp;= \frac{1}{n} \sum_{i=1}^{n} {\left( \log\left( \sum_{j=1}^{C}{\exp\left(x_{ij} - \max_{j=1}^{C}{x_{ij}} \right)} \right) - \left({x_{i y_i} - \max_{j=1}^{C}{x_{ij}}}\right) \right)} \\<br>  ~ &amp;= \frac{1}{n} \sum_{i=1}^{n} {\left( \log\left( \sum_{j=1}^{C}{\exp\left(x_{ij}&#39; \right)} \right) - x_{i y_i}&#39; \right)}<br>\end{aligned}<br>$$</p>
<p>è¯¦ç»†çš„åŸç†å°±ä¸è¯´äº†, ç½‘ä¸Šéƒ½æœ‰, è¿™é‡Œè¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦ç»™æ¯ä¸ª $x$ å‡å» $\max_{j=1}^{C}{x_{ij}}$, å› ä¸ºä¸­é—´ç”¨åˆ°äº†æŒ‡æ•°å‡½æ•°, æ‰€ä»¥ä¸ºäº†é˜²æ­¢æ•°æ®æº¢å‡º, å°†æ•°æ®éƒ½å˜æ¢åˆ°å°äºç­‰äº 0 çš„åŒºé—´, è¿™æ ·æŒ‡æ•°å‡½æ•°çš„å€¼åŸŸå°±åœ¨ $(0, 1]$, å®¹æ˜“çœ‹å‡ºæ¥è¿™ç§å˜æ¢æ˜¯ç­‰ä»·ä¸å½±å“è®¡ç®—ç»“æœçš„.</p>
<p>å‰å‘è®¡ç®—å°±è¿™æ ·äº†, ç„¶åçœ‹åå‘æ¢¯åº¦è®¡ç®—. æ³¨æ„åˆ°æœ€å¤–å±‚æ˜¯å°†æ¯ä¸ªæ ·æœ¬çš„ &quot;å°æŸå¤± $L_i$&quot; è¿›è¡Œäº†æ±‚å’Œå¹³å‡, æ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹æ±‚å’Œç¬¦å·å†…æ¯ä¸€ä¸ªæ ·æœ¬çš„å€¼å¦‚ä½•æ±‚æ¢¯åº¦.</p>
<p>æå‡ºé«˜ä¸­æ±‚å¯¼çŸ¥è¯†, å¾ˆå®¹æ˜“å¾—åˆ°:</p>
<p>$$<br>\frac{\partial{L_i}}{\partial{x_{ij}}} = \left\{<br>  \begin{aligned}<br>    &amp; \frac{\exp{(x_{ij}&#39;)}}{\sum_{j=1}^{C}{\exp\left(x_{ij}&#39; \right)}}     &amp; , ~ &amp; j \neq y_i \\<br>    &amp; \frac{\exp{(x_{ij}&#39;)}}{\sum_{j=1}^{C}{\exp\left(x_{ij}&#39; \right)}} - 1 &amp; , ~ &amp; j = y_i<br>  \end{aligned}<br>\right.<br>$$</p>
<p>è¿™é‡Œä¸ºäº†é˜²æ­¢æ•°æ®æº¢å‡º, åŒæ ·ä½¿ç”¨ $x&#39;_{ij}$ è€Œä¸æ˜¯åŸå§‹è¾“å…¥å€¼.</p>
<p>æœ€å, ç”±äºæ±‚å’Œå¹³å‡çš„å…³ç³», æ•´ä¸ªæ¢¯åº¦ä¹Ÿéœ€è¦ä¹˜ä¸Šä¸€ä¸ªç³»æ•°, å› æ­¤æœ‰æœ€ç»ˆçš„æ¢¯åº¦è®¡ç®—å…¬å¼:</p>
<p>$$<br>\begin{aligned}<br>  \frac{\partial{L}}{\partial{x_{ij}}} &amp;= \frac{\partial{L}}{\partial{L_i}}\frac{\partial{L_i}}{\partial{x_{ij}}} \\<br>  ~ &amp;= \frac{1}{n}\frac{\partial{L_i}}{\partial{x_{ij}}} \\<br>  ~ &amp;= \left\{<br>  \begin{aligned}<br>    &amp; \frac{1}{n}\left( \frac{\exp{(x_{ij}&#39;)}}{n\sum_{j=1}^{C}{\exp\left(x_{ij}&#39; \right)}} \right) &amp; , ~ &amp; j \neq y_i \\<br>    &amp; \frac{1}{n}\left( \frac{\exp{(x_{ij}&#39;)}}{n\sum_{j=1}^{C}{\exp\left(x_{ij}&#39; \right)}} - 1 \right) &amp; , ~ &amp; j = y_i<br>  \end{aligned}<br>\right.<br>\end{aligned}<br>$$</p>
<p>è‡³æ­¤, æŸå¤±å‡½æ•°çš„å‰å‘å’Œåå‘éƒ½å·²ç»æ¨å¯¼å®Œæˆ, ç„¶åå®Œæˆä»£ç å®ç°.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CrossEntropyLoss</span>(<span class="title class_ inherited__">NetworkLayer</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray, y: np.ndarray</span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, C)</span></span><br><span class="line"><span class="string">            y: (B, )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            loss: float number</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        x = x - x.<span class="built_in">max</span>(-<span class="number">1</span>, keepdims=<span class="literal">True</span>)</span><br><span class="line">        loss = np.log(np.exp(x).<span class="built_in">sum</span>(-<span class="number">1</span>)) - x[np.arange(x.shape[<span class="number">0</span>]), y]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">float</span>(loss.mean())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, x: np.ndarray, y: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, C)</span></span><br><span class="line"><span class="string">            y: (B, )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x_grad: (B, C)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        exp_x = np.exp(x - x.<span class="built_in">max</span>(-<span class="number">1</span>, keepdims=<span class="literal">True</span>))</span><br><span class="line">        x_grad = exp_x / exp_x.<span class="built_in">sum</span>(-<span class="number">1</span>, keepdims=<span class="literal">True</span>)</span><br><span class="line">        x_grad[np.arange(x.shape[<span class="number">0</span>]), y] -= <span class="number">1</span></span><br><span class="line">        x_grad /= x.shape[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x_grad</span><br></pre></td></tr></table></figure>

<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æœ¬ç¯‡åˆ°æ­¤ç»“æŸ, æˆ‘ä»¬ç»ˆäºå®Œæˆäº†ç½‘ç»œéœ€è¦çš„æ‰€æœ‰åŸºç¡€ç»“æ„. è€Œä¸‹ä¸€ç¯‡, ä¹Ÿæ˜¯æœ€åä¸€ç¯‡, æˆ‘ä»¬å°†æŠŠè¿™äº›é›¶ä»¶æ‹¼æ¥èµ·æ¥, ç»„åˆå‡ºæœ€ç»ˆçš„å·ç§¯ç¥ç»ç½‘ç»œ, å¹¶å®Œæˆå¯¹ç½‘ç»œçš„è®­ç»ƒå’Œè¯„ä¼°.</p>
<p>æœ¬ç³»åˆ—æ–‡ç« ä¼ é€é—¨:</p>
<ul>
<li><a href="/posts/2023/10/13/cnn-numpy-1/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸€)</a></li>
<li><a href="/posts/2023/10/14/cnn-numpy-2/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (äºŒ)</a></li>
<li><a href="/posts/2023/10/15/cnn-numpy-3/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸‰)</a></li>
</ul>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>çŸ©é˜µæ±‚å¯¼</tag>
        <tag>å·ç§¯çŸ©é˜µåŒ–</tag>
        <tag>äº¤å‰ç†µæŸå¤±å‡½æ•°</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸‰)</title>
    <url>//posts/2023/10/15/cnn-numpy-3/</url>
    <content><![CDATA[<blockquote>
<p>&quot;åŸºäº numpy çš„æ‰‹å†™æ•°å­—è¯†åˆ«&quot;, è¿™ä¸€ç»å…¸é—®é¢˜é™¤äº†ç”¨ä½œæ·±åº¦å­¦ä¹ å…¥é—¨å†…å®¹, è¿˜è¢«å¹¿æ³›ä½œä¸ºå„å¤§è¯¾ç¨‹çš„è¯¾ç¨‹ä½œä¸š, å› æ­¤åœ¨å„å¤§æœç´¢å¼•æ“ä¸Šæœç´¢ç‡ä¹Ÿæ˜¯ç›¸å½“ä¹‹é«˜<del>(ä»£ç å¤ç”¨ç‡ä¹Ÿæ˜¯ç›¸å½“ä¹‹é«˜)</del>. ç½‘ä¸Šç¡®å®æœ‰æŒºå¤šç°æˆçš„å¯ä½¿ç”¨ä»£ç , ä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯é€ çš„å…¨è¿æ¥ç½‘ç»œ, å¹¶ä¸”å¾ˆå¤šæ—¶å€™å†…éƒ¨åŸç†ä¸æ˜¯ç‰¹åˆ«æ¸…æ™°. å› æ­¤å†³å®šè‡ªå·±ä¹Ÿæ¥é€ ä¸€æ¬¡è½®å­, ä½¿ç”¨ <code>numpy</code> å®ç°ä¸€ä¸ªç®€å•çš„å·ç§¯ç¥ç»ç½‘ç»œè¿›è¡Œæ‰‹å†™æ•°å­—è¯†åˆ«, æ­£å¥½ä¹Ÿèƒ½å€Ÿæ­¤æœºä¼šæ¢³ç†ä¸€ä¸‹ç¥ç»ç½‘ç»œçš„åŸºæœ¬åŸç†.</p>
<p>å…¨æ–‡åŒ…å«å®Œæ•´çš„å·ç§¯ç½‘ç»œå®ç°, ä»¥åŠçŸ©é˜µæ¢¯åº¦å’Œå·ç§¯çŸ©é˜µåŒ–çš„æ¨å¯¼è¿‡ç¨‹, ç”±äºå…¨æ–‡è¿‡é•¿, å› æ­¤åˆ†æˆäº†ä¸‰éƒ¨åˆ†, å†…å®¹ä¸Šæ˜¯å®Œå…¨è¿ç€çš„.</p>
</blockquote>
<p>æœ¬æ–‡ä¸ºç¬¬ä¸‰ç¯‡, ä¹Ÿæ˜¯æœ€åä¸€ç¯‡, ç»“åˆå‰ä¸¤ç¯‡çš„å†…å®¹æ­å»ºå®Œæ•´çš„å·ç§¯ç¥ç»ç½‘ç»œå¹¶å®Œæˆè®­ç»ƒå’Œè¯„ä¼°.</p>
<span id="more"></span>

<p>æœ¬ç³»åˆ—æ–‡ç« ä¼ é€é—¨:</p>
<ul>
<li><a href="/posts/2023/10/13/cnn-numpy-1/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸€)</a></li>
<li><a href="/posts/2023/10/14/cnn-numpy-2/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (äºŒ)</a></li>
<li><a href="/posts/2023/10/15/cnn-numpy-3/">åŸºäº NumPy çš„æ‰‹å†™æ•°å­—è¯†åˆ« (å·ç§¯ç¥ç»ç½‘ç»œ) (ä¸‰)</a></li>
</ul>
<h2 id="å·ç§¯ç¥ç»ç½‘ç»œ"><a href="#å·ç§¯ç¥ç»ç½‘ç»œ" class="headerlink" title="å·ç§¯ç¥ç»ç½‘ç»œ"></a>å·ç§¯ç¥ç»ç½‘ç»œ</h2><h3 id="æ¨¡å‹ç»“æ„"><a href="#æ¨¡å‹ç»“æ„" class="headerlink" title="æ¨¡å‹ç»“æ„"></a>æ¨¡å‹ç»“æ„</h3><p>å› ä¸ºåªæ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹, æ‰€ä»¥å¼„ä¸€ä¸ªå°ä¸€ç‚¹çš„ç½‘ç»œ, å¤§æ¦‚é•¿è¿™æ ·.</p>
<p><img data-src="/static/image/cnn-numpy-3/cnn.jpg" alt="cnn.jpg"></p>
<p>ç„¶åå°±æ˜¯æŒ‰ç…§è¿™ä¸ªç»“æ„ç”¨ä»£ç æŠŠå‰é¢å®ç°çš„å±‚ä¸²èµ·æ¥.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConvolutionNeuralNetwork</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Conv -&gt; Pool -&gt; ReLU -&gt; Conv -&gt; Pool -&gt; ReLU -&gt; Flatten -&gt; Linear -&gt; CrossEntropy</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.layers = [</span><br><span class="line">            ConvolutionLayer(<span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>),  <span class="comment"># 24 * 24</span></span><br><span class="line">            MaxPoolingLayer(<span class="number">2</span>, <span class="number">2</span>),  <span class="comment"># 12 * 12</span></span><br><span class="line">            ReLULayer(),</span><br><span class="line">            ConvolutionLayer(<span class="number">4</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">3</span>),  <span class="comment"># 10 * 10</span></span><br><span class="line">            MaxPoolingLayer(<span class="number">2</span>, <span class="number">2</span>),  <span class="comment"># 5 * 5</span></span><br><span class="line">            ReLULayer(),</span><br><span class="line">            FlattenLayer(),</span><br><span class="line">            LinearLayer(<span class="number">16</span> * <span class="number">5</span> * <span class="number">5</span>, <span class="number">10</span>)</span><br><span class="line">        ]</span><br><span class="line">        self.loss_func = CrossEntropyLoss()</span><br><span class="line">        self.layer_inputs = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray, keepgrad: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, C_ch, H, W), images</span></span><br><span class="line"><span class="string">            keepgrad: whether keep temp layer inputs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x: (B, C_cls), logits</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            <span class="keyword">if</span> keepgrad:</span><br><span class="line">                self.layer_inputs.append(x)</span><br><span class="line">            x = layer.forward(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, last_x_grad: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            last_x_grad: (B, C_cls), computed by loss function</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            last_x_grad: (B, C_ch, H, W)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x, layer <span class="keyword">in</span> <span class="built_in">zip</span>(self.layer_inputs[::-<span class="number">1</span>], self.layers[::-<span class="number">1</span>]):</span><br><span class="line">            last_x_grad = layer.backward(x, last_x_grad)</span><br><span class="line">        <span class="keyword">return</span> last_x_grad</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, lr: <span class="built_in">float</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(layer, ParamLayer):</span><br><span class="line">                layer.update(lr)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç½‘ç»œåŒæ ·éœ€è¦å®ç° <code>forward</code> å’Œ <code>backward</code> æ–¹æ³•, ä½†æ˜¯å¢åŠ äº† <code>layer_inputs</code> æˆå‘˜, ç”¨äºä¿å­˜ç½‘ç»œçš„è®¡ç®—å›¾ä¸­é—´èŠ‚ç‚¹, åœ¨åå‘ä¼ æ’­æ—¶èƒ½ç›´æ¥è¯»å–æ•°æ®è®¡ç®—.</p>
<p>è‡³äºç½‘ç»œæ¯å±‚çš„å‚æ•°å¡«å¤šå¤§, å¾—è§†æ•°æ®é‡å’Œç½‘ç»œæ·±åº¦å†³å®š<del>ç„å­¦é—®é¢˜</del>, è¿™é‡Œå°±å¡«äº†å‡ ä¸ªæ¯”è¾ƒå°çš„å€¼, æ–¹ä¾¿ä¸‹ä¸€æ­¥è®­ç»ƒ.</p>
<h3 id="è®­ç»ƒ"><a href="#è®­ç»ƒ" class="headerlink" title="è®­ç»ƒ"></a>è®­ç»ƒ</h3><p>ç„¶åå®ç°ç½‘ç»œçš„è®­ç»ƒä»£ç .</p>
<p>è®­ç»ƒåˆ†å‡ ä¸ªå›ºå®šæ­¥éª¤:</p>
<ol>
<li>å‰å‘ä¼ æ’­</li>
<li>è®¡ç®—æŸå¤±</li>
<li>åå‘ä¼ æ’­</li>
<li>æ›´æ–°å‚æ•°</li>
<li>æ¸…ç©ºæœ¬æ¬¡è®¡ç®—çš„ä¸­é—´å€¼å’Œæ¢¯åº¦</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConvolutionNeuralNetwork</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Conv -&gt; Pool -&gt; ReLU -&gt; Conv -&gt; Pool -&gt; ReLU -&gt; Flatten -&gt; Linear -&gt; CrossEntropy</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray, keepgrad: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; np.ndarray: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, last_x_grad: np.ndarray</span>) -&gt; np.ndarray: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, lr: <span class="built_in">float</span></span>) -&gt; <span class="literal">None</span>: ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self, train_x: np.ndarray, train_y: np.ndarray, batch_size: <span class="built_in">int</span>, epochs: <span class="built_in">int</span>, lr: <span class="built_in">float</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            loss: mean loss for train_x</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        losses = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, train_x.shape[<span class="number">0</span>], batch_size):</span><br><span class="line">            inputs, targets = train_x[i:i+batch_size], train_y[i:i+batch_size]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># forward</span></span><br><span class="line">            logits = self.forward(inputs, <span class="literal">True</span>)</span><br><span class="line">            loss = self.loss_func.forward(logits, targets)</span><br><span class="line">            losses.append(loss)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># backward</span></span><br><span class="line">            last_x_grad = self.loss_func.backward(logits, targets)</span><br><span class="line">            self.backward(last_x_grad)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># update</span></span><br><span class="line">            self.update(lr)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># clear temp values</span></span><br><span class="line">            self.layer_inputs.clear()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(losses) / <span class="built_in">len</span>(losses)</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•å’Œé¢„æµ‹"><a href="#æµ‹è¯•å’Œé¢„æµ‹" class="headerlink" title="æµ‹è¯•å’Œé¢„æµ‹"></a>æµ‹è¯•å’Œé¢„æµ‹</h3><p>æµ‹è¯•å’Œè®­ç»ƒæ­¥éª¤æ˜¯ç±»ä¼¼çš„, ä½†æ˜¯ä¸éœ€è¦è®¡ç®—æŸå¤±å’Œæ¢¯åº¦, åŒæ—¶ä¹Ÿä¸éœ€è¦ä¿ç•™ä¸­é—´è®¡ç®—ç»“æœ.</p>
<p>è€Œé¢„æµ‹åˆ™æ˜¯åœ¨ <code>forward</code> çš„åŸºç¡€ä¸Š, å°†è¾“å‡ºç»“æœä½¿ç”¨ <code>Softmax</code> å‡½æ•°è½¬æ¢æˆæ¦‚ç‡å€¼, å…¬å¼å¦‚ä¸‹:</p>
<p>$$<br>\begin{aligned}<br>  Softmax(x_{ij}) &amp;= \frac{\exp\left( {x_{ij}} \right)}{\sum_{j=1}^{C}{\exp\left(x_{ij}\right)}} \\<br>  ~ &amp;= \frac{\exp\left( {x_{ij} - \max_{j=1}^{C}{x_{ij}}} \right)}{\sum_{j=1}^{C}{\exp\left(x_{ij} - \max_{j=1}^{C}{x_{ij}}\right)}} \\<br>  ~ &amp;= \frac{\exp\left( {x_{ij}&#39;} \right)}{\sum_{j=1}^{C}{\exp\left(x_{ij}&#39;\right)}}<br>\end{aligned}<br>$$</p>
<p>å…¶å®å°±æ˜¯åœ¨è®¡ç®—äº¤å‰ç†µæŸå¤±ä¸­é—´ $\log$ æ‹¬å·å†…çš„å†…å®¹, å¹¶ä¸”åŒæ ·å¯ä»¥å‡å»æœ€å¤§å€¼æ¥é˜²æ­¢æ•°æ®æº¢å‡º.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConvolutionNeuralNetwork</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Conv -&gt; Pool -&gt; ReLU -&gt; Conv -&gt; Pool -&gt; ReLU -&gt; Flatten -&gt; Linear -&gt; CrossEntropy</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: np.ndarray, keepgrad: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; np.ndarray: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">backward</span>(<span class="params">self, last_x_grad: np.ndarray</span>) -&gt; np.ndarray: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, lr: <span class="built_in">float</span></span>) -&gt; <span class="literal">None</span>: ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self, train_x: np.ndarray, train_y: np.ndarray, batch_size: <span class="built_in">int</span>, epochs: <span class="built_in">int</span>, lr: <span class="built_in">float</span></span>) -&gt; <span class="built_in">float</span>: ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">self, test_x: np.ndarray, test_y: np.ndarray, batch_size: <span class="built_in">int</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            loss: mean loss for test_x</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        losses = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, test_x.shape[<span class="number">0</span>], batch_size):</span><br><span class="line">            inputs, targets = test_x[i:i+batch_size], test_y[i:i+batch_size]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># forward</span></span><br><span class="line">            logits = self.forward(inputs)</span><br><span class="line">            loss = self.loss_func.forward(logits, targets)</span><br><span class="line">            losses.append(loss)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(losses) / <span class="built_in">len</span>(losses)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, x: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: (B, C_ch, H, W), images</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x: (B, C_cls), probs by softmax</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        x = self.forward(x)</span><br><span class="line">        exp_x = np.exp(x - x.<span class="built_in">max</span>(-<span class="number">1</span>, keepdims=<span class="literal">True</span>))</span><br><span class="line">        outputs = exp_x / exp_x.<span class="built_in">sum</span>(-<span class="number">1</span>, keepdims=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>

<h2 id="è®­ç»ƒå¹¶è¯„ä¼°ç½‘ç»œ"><a href="#è®­ç»ƒå¹¶è¯„ä¼°ç½‘ç»œ" class="headerlink" title="è®­ç»ƒå¹¶è¯„ä¼°ç½‘ç»œ"></a>è®­ç»ƒå¹¶è¯„ä¼°ç½‘ç»œ</h2><p>å®Œæˆç½‘ç»œæ­å»ºå, æ¥ä¸‹æ¥å°±æ˜¯è¿›è¡Œè®­ç»ƒå’Œè¯„ä¼°. å…ˆè´´ä¸Šå®Œæ•´çš„ä»£ç .</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    np.random.seed(<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">    train_x, train_y = load_dataset(<span class="string">&quot;./cv-data/train&quot;</span>, <span class="literal">True</span>)</span><br><span class="line">    test_x, test_y = load_dataset(<span class="string">&quot;./cv-data/test&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(train_x.shape, train_y.shape)</span><br><span class="line">    <span class="built_in">print</span>(test_x.shape, test_y.shape)</span><br><span class="line"></span><br><span class="line">    batch_size = <span class="number">100</span></span><br><span class="line">    epochs = <span class="number">200</span></span><br><span class="line">    lr = <span class="number">0.1</span></span><br><span class="line">    cnn = ConvolutionNeuralNetwork()</span><br><span class="line"></span><br><span class="line">    train_losses = []</span><br><span class="line">    test_losses = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=============== Begin Train ===============&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">        train_loss = cnn.train(train_x, train_y, batch_size, epochs, lr)</span><br><span class="line">        test_loss = cnn.test(test_x, test_y, batch_size)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Epoch: <span class="subst">&#123;i + <span class="number">1</span>:3d&#125;</span> Train Loss: <span class="subst">&#123;train_loss:<span class="number">.4</span>f&#125;</span> Test Loss: <span class="subst">&#123;test_loss:<span class="number">.4</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        train_losses.append(train_loss)</span><br><span class="line">        test_losses.append(test_loss)</span><br><span class="line"></span><br><span class="line">    time_elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;=============== End Train: <span class="subst">&#123;time_elapsed / <span class="number">60</span>:<span class="number">.2</span>f&#125;</span> min ===============&quot;</span>)</span><br><span class="line"></span><br><span class="line">    train_losses = np.array(train_losses)</span><br><span class="line">    test_losses = np.array(test_losses)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç»˜åˆ¶æŸå¤±å˜åŒ–æ›²çº¿, å¿½ç•¥ç¬¬ä¸€è½®æŸå¤±</span></span><br><span class="line">    plt.plot(np.arange(train_losses.shape[<span class="number">0</span>]-<span class="number">1</span>), train_losses[<span class="number">1</span>:], label=<span class="string">&quot;train&quot;</span>)</span><br><span class="line">    plt.plot(np.arange(test_losses.shape[<span class="number">0</span>]-<span class="number">1</span>), test_losses[<span class="number">1</span>:], label=<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.savefig(<span class="string">&quot;loss.png&quot;</span>)</span><br><span class="line"></span><br><span class="line">    y_true = train_y</span><br><span class="line">    y_pred = cnn.predict(train_x).argmax(-<span class="number">1</span>)</span><br><span class="line">    report = classification_report(y_true, y_pred, digits=<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=============== Classification Report: Train ===============&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(report)</span><br><span class="line"></span><br><span class="line">    y_true = test_y</span><br><span class="line">    y_pred = cnn.predict(test_x).argmax(-<span class="number">1</span>)</span><br><span class="line">    report = classification_report(y_true, y_pred, digits=<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=============== Classification Report: Test ===============&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(report)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸ºäº†ç¨³å®šç»“æœ, å›ºå®šäº†ä¸€ä¸‹éšæœºç§å­ä¸º <code>1234</code>.</p>
<p>æœ‰ä¸‰ä¸ªè®­ç»ƒçš„è¶…å‚æ•°:</p>
<ul>
<li><code>batch_size</code>: æ¯ä¸€è½® mini-batch çš„å¤§å°.</li>
<li><code>epochs</code>: å…±è®­ç»ƒå¤šå°‘è½®.</li>
<li><code>lr</code>: ç½‘ç»œå­¦ä¹ ç‡.</li>
</ul>
<p>å…·ä½“å¡«å¤šå°‘å¾—åå¤å°è¯•<del>ä¹Ÿæ˜¯ç‚¼ä¸¹çš„ç²¾é«“</del>, è¿™é‡Œå­¦ä¹ ç‡æ˜¯å°è¯•åæ”¶æ•›æ¯”è¾ƒå¿«è€Œä¸”æ¯”è¾ƒç¨³å®šçš„ä¸€ä¸ªå€¼.</p>
<p>ä¸­é€”æŠŠæ¯ä¸€è½®çš„æŸå¤±è®°å½•ä¸€ä¸‹, å¹¶ä¸”ç”¨ <code>matplotlib.pyplot</code> ç”»ä¸ªç®€å•çš„æ›²çº¿å›¾, å¯¹æ¯”ä¸€ä¸‹è®­ç»ƒé›†å’Œæµ‹è¯•é›†æŸå¤±éšè½®æ•°çš„å˜åŒ–å…³ç³».</p>
<p>æœ€åå€Ÿç”¨ä¸€ä¸‹ <code>classification_report</code> æ¥çœ‹çœ‹ç½‘ç»œåœ¨è®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¸Šçš„åˆ†ç±»æ€§èƒ½æŠ¥å‘Š.</p>
<p>200 è½®çš„è®­ç»ƒå¤§æ¦‚è·‘äº† 20 åˆ†é’Ÿå·¦å³, æŒºä¹…çš„.</p>
<p>æŸå¤±æ›²çº¿å›¾:</p>
<p><img data-src="/static/image/cnn-numpy-3/loss.png" alt="loss.jpg"></p>
<p>åˆ†ç±»æ€§èƒ½æŠ¥å‘Š:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=============== Classification Report: Train ===============</span><br><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0     0.9970    0.9900    0.9935       999</span><br><span class="line">           1     0.9955    0.9928    0.9941      1106</span><br><span class="line">           2     0.9871    0.9765    0.9818      1020</span><br><span class="line">           3     0.9814    0.9786    0.9800      1027</span><br><span class="line">           4     0.9958    0.9712    0.9834       973</span><br><span class="line">           5     0.9821    0.9854    0.9838       891</span><br><span class="line">           6     0.9959    0.9939    0.9949       977</span><br><span class="line">           7     0.9750    0.9887    0.9818      1063</span><br><span class="line">           8     0.9567    0.9888    0.9725       984</span><br><span class="line">           9     0.9781    0.9771    0.9776       960</span><br><span class="line"></span><br><span class="line">    accuracy                         0.9844     10000</span><br><span class="line">   macro avg     0.9845    0.9843    0.9843     10000</span><br><span class="line">weighted avg     0.9845    0.9844    0.9844     10000</span><br><span class="line"></span><br><span class="line">=============== Classification Report: Test ===============</span><br><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0     0.9517    0.9848    0.9679       460</span><br><span class="line">           1     0.9723    0.9825    0.9774       571</span><br><span class="line">           2     0.9618    0.9491    0.9554       530</span><br><span class="line">           3     0.9298    0.9540    0.9418       500</span><br><span class="line">           4     0.9630    0.9360    0.9493       500</span><br><span class="line">           5     0.9538    0.9518    0.9528       456</span><br><span class="line">           6     0.9581    0.9416    0.9498       462</span><br><span class="line">           7     0.9384    0.9219    0.9300       512</span><br><span class="line">           8     0.9039    0.9427    0.9229       489</span><br><span class="line">           9     0.9324    0.9019    0.9169       520</span><br><span class="line"></span><br><span class="line">    accuracy                         0.9466      5000</span><br><span class="line">   macro avg     0.9465    0.9466    0.9464      5000</span><br><span class="line">weighted avg     0.9468    0.9466    0.9466      5000</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœè¿˜ä¸é”™, æŸå¤±æ›²çº¿ä¹Ÿå¾ˆç»å…¸, å¤§çº¦ä» 15 è½®å¼€å§‹æ”¶æ•›, 120 è½®å·¦å³æµ‹è¯•é›†æŸå¤±å°±å·®ä¸å¤šåˆ°åº•äº†. ä¸­é€”è¯•è¿‡ä¸€äº›åˆ«çš„éšæœºç§å­, æ”¶æ•›é€Ÿåº¦æœ‰å·®å¼‚, ä½†æ˜¯æœ€ç»ˆçš„æŸå¤±å€¼éƒ½å·®ä¸å¤š.</p>
<p>åˆ†ç±»æ€§èƒ½çš„è¯, è®­ç»ƒé›†çš„ F1 å€¼å’Œæµ‹è¯•é›†å·®äº† 4% å·¦å³, çœ‹ç€ä¹Ÿè¿˜ä¸é”™, æ­£å¸¸è¡¨ç°.</p>
<h2 id="è¿›ä¸€æ­¥æ¢ç´¢"><a href="#è¿›ä¸€æ­¥æ¢ç´¢" class="headerlink" title="è¿›ä¸€æ­¥æ¢ç´¢"></a>è¿›ä¸€æ­¥æ¢ç´¢</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»å½»åº•å®Œæˆäº†åŸºäºçº¯ NumPy æ‰‹å·¥æ­å»ºçš„å·ç§¯ç¥ç»ç½‘ç»œäº†, ä»è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å¾ˆå¤šåº•å±‚åŸç†ä»¥åŠä¸€äº›ç»†èŠ‚é—®é¢˜, æ¯”å¦‚å‚æ•°çš„åˆå§‹åŒ–å’Œè®­ç»ƒè¶…å‚æ•°çš„è°ƒèŠ‚. å¤§éƒ¨åˆ†æ—¶é—´æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¡†æ¶æ¥å®Œæˆè¿™äº›äº‹æƒ…, æˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºæ­ç§¯æœ¨å³å¯. è¿™é‡Œè”ç³»ä¸€ä¸‹æˆ‘å¸¸ç”¨çš„ PyTorch åº“, é‡Œé¢å†…ç½®äº†å¾ˆå¤šä¸åŒçš„æ¨¡å—, åˆ†åˆ«å¯¹åº”æ•´ä¸ªç½‘ç»œæ­å»ºå’Œè®­ç»ƒè¿‡ç¨‹ä¸­çš„åŸºæœ¬ç¯èŠ‚.</p>
<ul>
<li><code>torch.utils.data</code>: æ•°æ®å¤„ç†æ¨¡å—, æ§åˆ¶æ•°æ®çš„è¯»å–å’Œè¿­ä»£æ–¹å¼.</li>
<li><code>torch.nn</code>: å¸¸ç”¨çš„ç½‘ç»œæ¨¡å—, ä¾‹å¦‚ <code>Linear</code> å’Œ <code>Conv2d</code>.</li>
<li><code>torch.nn.functional</code>: <code>torch.nn</code> ä¸­æ¨¡å—çš„å‡½æ•°å½¢å¼, éœ€è¦æ‰‹åŠ¨ä¼ å…¥è®¡ç®—çš„å‚æ•°.</li>
<li><code>torch.nn.init</code>: ä¸åŒçš„ç½‘ç»œå‚æ•°åˆå§‹åŒ–æ–¹æ³•.</li>
<li><code>torch.optim</code>: ä¼˜åŒ–å™¨æ¨¡å—, åŒ…å«ä¸åŒçš„å­¦ä¹ ç‡è°ƒæ•´ç®—æ³•, æ§åˆ¶ç½‘ç»œçš„ä¼˜åŒ–è¿‡ç¨‹.</li>
</ul>
<p>è¿™æ˜¯ä¸€äº›å¸¸ç”¨çš„, è¿˜æœ‰å¾ˆå¤š, å¯ä»¥å»çœ‹çœ‹ <span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy9kb2NzL3N0YWJsZS9pbmRleC5odG1s">PyTorch æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span>å¹¶åŠ ä»¥å®è·µ.</p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>è¿™ä»½æ–‡æ¡£å†™äº†å¾ˆä¹…, èµ·å› æ˜¯è§‰å¾—è¦æ˜¯ä¸‹æ¬¡å†ç¢°åˆ°ç›¸å…³çš„é—®é¢˜, è‡ªå·±æœ‰è½®å­å’Œå†…å®¹å°±ä¸ç”¨ä¸Šç½‘æ‰¾äº†<del>å±å®æ˜¯é—²ç€æ²¡äº‹</del>. å‰åèŠ±äº†ä¸€ä¸¤å‘¨çš„æ—¶é—´, å› ä¸ºè¦ä»å¤´è·‘ä¸€ä»½ä»£ç , ç„¶ååˆæ˜¯è°ƒå…¬å¼åˆæ˜¯ç”»å›¾, ä¸è¿‡ç®—æ˜¯å½»åº•å¤ä¹ äº†ä¸€éç¥ç»ç½‘ç»œ, æŠŠå¾ˆå¤šæ·±åº¦å­¦ä¹ æ¡†æ¶çš„ä½¿ç”¨åŸç†éƒ½ä¸²èµ·æ¥äº†, è¿˜æ˜¯æŒºå¥½çš„.</p>
<p>è¿™ä¸ªç³»åˆ—å°±æ­¤åœ†æ»¡ç»“æŸ<del>ä½œä¸šæŠ¥å‘Šä»æ­¤ä¸€åŠ³æ°¸é€¸</del>.</p>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>æ‰‹å†™æ•°å­—è¯†åˆ«</tag>
        <tag>å·ç§¯ç¥ç»ç½‘ç»œ</tag>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»é›¶å¼€å§‹çš„ DDPM åŠ¨æ¼«å¤´åƒç”Ÿæˆ</title>
    <url>//posts/2024/02/16/ddpm/</url>
    <content><![CDATA[<p>Stable Diffusion å·²ç»ç«äº†å¾ˆä¹…äº†, åœ¨æ­¤ä¹‹å‰ä¹Ÿæ˜¯åœ¨è‡ªå·±ç”µè„‘ä¸Šéƒ¨ç½²è¿‡ Github ä¸Šé‚£ä¸ª <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FVVE9NQVRJQzExMTEvc3RhYmxlLWRpZmZ1c2lvbi13ZWJ1aQ==">stable-diffusion-webui<i class="fa fa-external-link-alt"></i></span>. ä½œä¸ºä¸€ä¸ªæŠ˜è…¾åˆ†å­, æœ¬ç€æ›´æ·±å…¥äº†è§£ä¸€ä¸‹æ¦‚ç‡æ‰©æ•£æ¨¡å‹çš„æƒ³æ³•, å†³å®šåœ¨å‚è€ƒå…¶ä»–æ•™ç¨‹çš„åŸºç¡€ä¸Šä»é›¶å¼€å§‹ç‚¼åˆ¶ä¸€ä¸ªåŸºäº DDPM çš„åŠ¨æ¼«å¤´åƒç”Ÿæˆæ¨¡å‹.</p>
<span id="more"></span>

<h2 id="åŸºç¡€è®¾æ–½"><a href="#åŸºç¡€è®¾æ–½" class="headerlink" title="åŸºç¡€è®¾æ–½"></a>åŸºç¡€è®¾æ–½</h2><p>æ²¡é’±æ²¡ç²¾åŠ›æŠ˜è…¾æœåŠ¡å™¨, ç”¨çš„è‡ªå·±çš„ç¬”è®°æœ¬.</p>
<ul>
<li>Win11</li>
<li>CPU <code>i7-13700H</code></li>
<li>å†…å­˜ 16 GB</li>
<li>æ˜¾å¡ <code>NVIDIA GeForce RTX 4060 Laptop GPU</code>, 8 GB æ˜¾å­˜.</li>
<li>æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬ <code>551.23</code></li>
<li>CUDA ç‰ˆæœ¬ <code>12.4</code></li>
<li>python <code>3.9.13</code></li>
<li>torch <code>2.0.1+cu118</code></li>
</ul>
<h2 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h2><p>æœ‰ä¸¤ä¸ªæ•°æ®é›†, éƒ½æ˜¯ä» <span class="exturl" data-url="aHR0cHM6Ly93d3cua2FnZ2xlLmNvbS8=">Kaggle<i class="fa fa-external-link-alt"></i></span> ä¸Šä¸‹çš„.</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cua2FnZ2xlLmNvbS9kYXRhc2V0cy9zb3VtaWtyYWtzaGl0L2FuaW1lLWZhY2Vz">Anime Faces<i class="fa fa-external-link-alt"></i></span>, 21551 å¼ .</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cua2FnZ2xlLmNvbS9kYXRhc2V0cy9zcGxjaGVyL2FuaW1lZmFjZWRhdGFzZXQ=">Anime Face Dataset<i class="fa fa-external-link-alt"></i></span>, 63632 å¼ .</li>
</ul>
<p>åˆèµ·æ¥æœ‰ 8 ä¸‡å¤šå¼  (å‰ä¸€ä¸ªè²Œä¼¼æ˜¯ç¬¬äºŒä¸ªçš„å­é›†?).</p>
<p>ä½†æ˜¯æœ€ååªç”¨äº† 2 ä¸‡å¼ é‚£ä¸ª, å› ä¸º 6 ä¸‡çš„è´¨é‡ä¸æ˜¯å¤ªé«˜, è®­ç»ƒå‡ºæ¥ä¸æ˜¯å¾ˆç¨³å®š.</p>
<h2 id="ä¾èµ–åº“"><a href="#ä¾èµ–åº“" class="headerlink" title="ä¾èµ–åº“"></a>ä¾èµ–åº“</h2><p>ä¸»è¦ç”¨çš„åŸç”Ÿ PyTorch, è®­ç»ƒå’Œæµ‹è¯•éƒ½æ˜¯æ‰‹å†™çš„, å…¶ä»–åº“åªæ˜¯è¾…åŠ©è¾“å‡ºå’Œä½¿ç”¨.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Sequence</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> rich.progress</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.nn <span class="keyword">import</span> functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.optim.adam <span class="keyword">import</span> Adam</span><br><span class="line"><span class="keyword">from</span> torch.utils.data.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> torch.utils.data.dataset <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms <span class="keyword">as</span> T</span><br><span class="line"><span class="keyword">from</span> torchvision.utils <span class="keyword">import</span> make_grid</span><br></pre></td></tr></table></figure>

<h2 id="æ¨¡å‹ç»“æ„"><a href="#æ¨¡å‹ç»“æ„" class="headerlink" title="æ¨¡å‹ç»“æ„"></a>æ¨¡å‹ç»“æ„</h2><p>è¿™éƒ¨åˆ†å†…å®¹ä¸»è¦å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhYm1sYWkvYW5ub3RhdGVkX2RlZXBfbGVhcm5pbmdfcGFwZXJfaW1wbGVtZW50YXRpb25z">annotated_deep_learning_paper_implementations<i class="fa fa-external-link-alt"></i></span> è¿™ä¸ªä»“åº“, ä¸€ä¸ªå¼€æºçš„å¤ç°å„ç§è®ºæ–‡æ¨¡å‹çš„åº“, ä½†æ˜¯å‚è€ƒçš„æ—¶å€™å‘ç°è¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜, æ‰€ä»¥ä»…ä¾›å‚è€ƒ.</p>
<p>å¦å¤–ä¸€ä¸ªåº“åˆ™æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1Y2lkcmFpbnMvZGVub2lzaW5nLWRpZmZ1c2lvbi1weXRvcmNo">denoising-diffusion-pytorch<i class="fa fa-external-link-alt"></i></span>, æ˜¯åŸè®ºæ–‡çš„ PyTorch å®ç°, ä½†æ˜¯å’ŒåŸè®ºæ–‡çš„å®ç°ç»†èŠ‚æœ‰å¾ˆå¤§ä¸åŒ, æ‰€ä»¥ä¹Ÿä»…ä»…ç”¨äºå‚è€ƒ.</p>
<p>æ­¤å¤–æ¨¡å‹ç»“æ„ä¸Šè¿˜å‚è€ƒäº†ä¸€ç¯‡çŸ¥ä¹å¸–å­, <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82NTU1Njg5MTA=">æ·±å…¥æµ…å‡ºæ‰©æ•£æ¨¡å‹(Diffusion Model)ç³»åˆ—ï¼šåŸºçŸ³DDPMï¼ˆæºç è§£è¯»ç¯‡ï¼‰<i class="fa fa-external-link-alt"></i></span>, è¿™ç¯‡å¸–å­æ˜¯å¯¹ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhYm1sYWkvYW5ub3RhdGVkX2RlZXBfbGVhcm5pbmdfcGFwZXJfaW1wbGVtZW50YXRpb25z">annotated_deep_learning_paper_implementations<i class="fa fa-external-link-alt"></i></span> æºç çš„åˆ†æ, çœå»äº†ä¸å°‘è‡ªå·±è¯»ä»£ç çš„æ—¶é—´.</p>
<details class="note "><summary><p><strong>[ç‚¹å‡»å±•å¼€]</strong> æ¨¡å‹ä»£ç </p>
</summary>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TimeEmbedding</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Sinusoidal Time Embedding.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, fourier_channels: <span class="built_in">int</span>, time_channels: <span class="built_in">int</span>, theta: <span class="built_in">int</span> = <span class="number">10000</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Sinusoidal Time Embedding.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            t: (B, )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            time_embedding: (B, time_c)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.fourier_channels = fourier_channels</span><br><span class="line">        self.time_channels = time_channels</span><br><span class="line">        self.theta = theta</span><br><span class="line">        self.half_dim = self.fourier_channels // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        self.mlp = nn.Sequential(</span><br><span class="line">            nn.Linear(self.fourier_channels, self.time_channels),</span><br><span class="line">            nn.SiLU(),</span><br><span class="line">            nn.Linear(self.time_channels, self.time_channels),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        emb_coef = math.log(self.theta) / (self.half_dim - <span class="number">1</span>)</span><br><span class="line">        emb_coef = torch.exp(torch.arange(self.half_dim) * -emb_coef)</span><br><span class="line"></span><br><span class="line">        self.emb_coef: torch.Tensor</span><br><span class="line">        self.register_buffer(<span class="string">&quot;emb_coef&quot;</span>, emb_coef, <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, t: torch.Tensor</span>):</span><br><span class="line">        emb = t[:, <span class="literal">None</span>] * self.emb_coef[<span class="literal">None</span>, :]</span><br><span class="line">        emb = torch.cat((emb.sin(), emb.cos()), dim=<span class="number">1</span>)</span><br><span class="line">        emb = self.mlp(emb)</span><br><span class="line">        <span class="keyword">return</span> emb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResidualBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Residual block.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    A residual block has two convolution layers with group normalization.</span></span><br><span class="line"><span class="string">        Each resolution is processed with two residual blocks.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels: <span class="built_in">int</span>, out_channels: <span class="built_in">int</span>, time_channels: <span class="built_in">int</span>, num_groups: <span class="built_in">int</span> = <span class="number">32</span>, dropout: <span class="built_in">float</span> = <span class="number">0.1</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Residual block.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, in_c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, time_c)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, out_c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Sequential(</span><br><span class="line">            nn.GroupNorm(num_groups, in_channels),</span><br><span class="line">            nn.SiLU(),</span><br><span class="line">            nn.Conv2d(in_channels, out_channels, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.time_emb = nn.Sequential(</span><br><span class="line">            nn.SiLU(),</span><br><span class="line">            nn.Linear(time_channels, out_channels),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.conv2 = nn.Sequential(</span><br><span class="line">            nn.GroupNorm(num_groups, out_channels),</span><br><span class="line">            nn.SiLU(),</span><br><span class="line">            nn.Dropout(dropout),</span><br><span class="line">            nn.Conv2d(out_channels, out_channels, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> in_channels != out_channels:</span><br><span class="line">            self.shortcut = nn.Conv2d(in_channels, out_channels, kernel_size=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.shortcut = nn.Identity()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, t: torch.Tensor</span>):</span><br><span class="line">        h = self.conv1(x)</span><br><span class="line">        h = h + self.time_emb(t)[:, :, <span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">        h = self.conv2(h)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> h + self.shortcut(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AttentionBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Multihead Attention block&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_channels: <span class="built_in">int</span>, num_heads: <span class="built_in">int</span> = <span class="number">1</span>, num_groups: <span class="built_in">int</span> = <span class="number">32</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Multihead Attention block</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h, w)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.norm = nn.GroupNorm(num_groups, num_channels)</span><br><span class="line">        self.attn = nn.MultiheadAttention(num_channels, num_heads)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>):</span><br><span class="line">        B, C, H, W = x.shape</span><br><span class="line"></span><br><span class="line">        x = self.norm(x)</span><br><span class="line">        x = x.view(B, C, -<span class="number">1</span>).permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        res, _ = self.attn(x, x, x, need_weights=<span class="literal">False</span>)</span><br><span class="line">        x = x + res</span><br><span class="line"></span><br><span class="line">        x = x.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>).view(B, C, H, W)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Down block</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This combines `ResidualBlock` and `AttentionBlock`. These are used in the first half of U-Net at each resolution.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels: <span class="built_in">int</span>, out_channels: <span class="built_in">int</span>, time_channels: <span class="built_in">int</span>, has_attn: <span class="built_in">bool</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Down block.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, in_c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, time_c)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, out_c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.res = ResidualBlock(in_channels, out_channels, time_channels)</span><br><span class="line">        <span class="keyword">if</span> has_attn:</span><br><span class="line">            self.attn = AttentionBlock(out_channels)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.attn = nn.Identity()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, t: torch.Tensor</span>):</span><br><span class="line">        x = self.res(x, t)</span><br><span class="line">        x = self.attn(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MiddleBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Middle block</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    It combines a `ResidualBlock`, `AttentionBlock`, followed by another `ResidualBlock`.</span></span><br><span class="line"><span class="string">        This block is applied at the lowest resolution of the U-Net.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_channels: <span class="built_in">int</span>, time_channels: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Middle block</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, time_c)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.res1 = ResidualBlock(num_channels, num_channels, time_channels)</span><br><span class="line">        self.attn = AttentionBlock(num_channels)</span><br><span class="line">        self.res2 = ResidualBlock(num_channels, num_channels, time_channels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, t: torch.Tensor</span>):</span><br><span class="line">        x = self.res1(x, t)</span><br><span class="line">        x = self.attn(x)</span><br><span class="line">        x = self.res2(x, t)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UpBlock</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Up block</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This combines `ResidualBlock` and `AttentionBlock`. These are used in the second half of U-Net at each resolution.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, in_channels: <span class="built_in">int</span>, out_channels: <span class="built_in">int</span>, time_channels: <span class="built_in">int</span>, has_attn: <span class="built_in">bool</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Up block.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, in_c, h, w)</span></span><br><span class="line"><span class="string">            x_left: (B, out_c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, time_c)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, out_c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.res = ResidualBlock(in_channels + out_channels, out_channels, time_channels)</span><br><span class="line">        <span class="keyword">if</span> has_attn:</span><br><span class="line">            self.attn = AttentionBlock(out_channels)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.attn = nn.Identity()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, x_left: torch.Tensor, t: torch.Tensor</span>):</span><br><span class="line">        x = torch.cat([x, x_left], <span class="number">1</span>)</span><br><span class="line">        x = self.res(x, t)</span><br><span class="line">        x = self.attn(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownSample</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Scale down the feature map by 1/2&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, n_channels</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Down Sample</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h, w)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h // 2, w // 2)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.conv = nn.Conv2d(n_channels, n_channels, (<span class="number">3</span>, <span class="number">3</span>), (<span class="number">2</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>):</span><br><span class="line">        <span class="keyword">return</span> self.conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UpSample</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Scale up the feature map by 2x&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_channels</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Up Sample</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h, w)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, num_c, h * 2, w * 2)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.conv = nn.ConvTranspose2d(num_channels, num_channels, (<span class="number">4</span>, <span class="number">4</span>), (<span class="number">2</span>, <span class="number">2</span>), (<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>):</span><br><span class="line">        <span class="keyword">return</span> self.conv(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UNet</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;U-Net used to predict noise.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        img_channels: <span class="built_in">int</span> = <span class="number">3</span>,</span></span><br><span class="line"><span class="params">        num_channels: <span class="built_in">int</span> = <span class="number">64</span>,</span></span><br><span class="line"><span class="params">        channel_multiples: <span class="type">Sequence</span>[<span class="built_in">int</span>] = (<span class="params"><span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span></span>),</span></span><br><span class="line"><span class="params">        has_attn: <span class="type">Sequence</span>[<span class="built_in">bool</span>] = (<span class="params"><span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">True</span></span>),</span></span><br><span class="line"><span class="params">        num_blocks: <span class="built_in">int</span> = <span class="number">2</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;U-Net</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            img_channels: the number of channels in the image. 3 for RGB.</span></span><br><span class="line"><span class="string">            num_channels: number of channels in the initial feature map that we transform the image into.</span></span><br><span class="line"><span class="string">            channel_multiples: the list of channel multiple number at each resolution.</span></span><br><span class="line"><span class="string">            has_attn: a list of booleans that indicate whether to use attention at each resolution.</span></span><br><span class="line"><span class="string">            num_blocks: the number of `DownBlock` and `UpBlock` at each resolution.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Inputs:</span></span><br><span class="line"><span class="string">            x: (B, img_c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Outputs:</span></span><br><span class="line"><span class="string">            x: (B, img_c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        num_resolutions = <span class="built_in">len</span>(channel_multiples)</span><br><span class="line">        time_channels = num_channels * <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        self.time_emb = TimeEmbedding(num_channels, time_channels)</span><br><span class="line">        self.in_conv = nn.Conv2d(img_channels, num_channels, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), padding=(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        self.out_conv = nn.Sequential(</span><br><span class="line">            nn.GroupNorm(<span class="number">32</span>, num_channels),</span><br><span class="line">            nn.SiLU(),</span><br><span class="line">            nn.Conv2d(num_channels, img_channels, kernel_size=(<span class="number">3</span>, <span class="number">3</span>), padding=(<span class="number">1</span>, <span class="number">1</span>)),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Down and Up</span></span><br><span class="line">        self.down = nn.ModuleList()</span><br><span class="line">        self.up = nn.ModuleList()</span><br><span class="line">        in_c = num_channels</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_resolutions):</span><br><span class="line">            out_c = num_channels * channel_multiples[i]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># down blocks</span></span><br><span class="line">            self.down.append(DownBlock(in_c, out_c, time_channels, has_attn[i]))</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks - <span class="number">1</span>):</span><br><span class="line">                self.down.append(DownBlock(out_c, out_c, time_channels, has_attn[i]))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># up blocks</span></span><br><span class="line">            self.up.append(UpBlock(out_c, in_c, time_channels, has_attn[i]))</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_blocks):</span><br><span class="line">                self.up.append(UpBlock(out_c, out_c, time_channels, has_attn[i]))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># up/down sample</span></span><br><span class="line">            <span class="keyword">if</span> i &lt; num_resolutions - <span class="number">1</span>:</span><br><span class="line">                self.down.append(DownSample(out_c))</span><br><span class="line">                self.up.append(UpSample(out_c))</span><br><span class="line"></span><br><span class="line">            in_c = out_c</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Middle</span></span><br><span class="line">        self.middle = MiddleBlock(num_channels * channel_multiples[-<span class="number">1</span>], time_channels)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, t: torch.Tensor</span>):</span><br><span class="line">        t = self.time_emb(t)</span><br><span class="line"></span><br><span class="line">        x = self.in_conv(x)</span><br><span class="line"></span><br><span class="line">        h = [x]</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> self.down:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, DownBlock):</span><br><span class="line">                x = m(x, t)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                x = m(x)</span><br><span class="line">            h.append(x)</span><br><span class="line"></span><br><span class="line">        x = self.middle(x, t)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> <span class="built_in">reversed</span>(self.up):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, UpBlock):</span><br><span class="line">                x = m(x, h.pop(), t)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                x = m(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(h) == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        x = self.out_conv(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GaussianDiffusion</span>(nn.Module):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Gaussian Diffusion&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, eps_model: nn.Module, timesteps: <span class="built_in">int</span> = <span class="number">1000</span>, beta_min: <span class="built_in">float</span> = <span class="number">0.0001</span>, beta_max: <span class="built_in">float</span> = <span class="number">0.02</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Gaussian Diffusion</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            eps_model: epsilon theta model</span></span><br><span class="line"><span class="string">            timesteps: T.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.eps_model = eps_model</span><br><span class="line">        self.timesteps = timesteps</span><br><span class="line"></span><br><span class="line">        beta: torch.Tensor = torch.linspace(beta_min, beta_max, timesteps, dtype=torch.float32)</span><br><span class="line">        alpha: torch.Tensor = <span class="number">1.0</span> - beta</span><br><span class="line">        alpha_bar: torch.Tensor = torch.cumprod(alpha, dim=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># forward parameters</span></span><br><span class="line">        self.q_mu_coef: torch.Tensor</span><br><span class="line">        self.register_buffer(<span class="string">&quot;q_mu_coef&quot;</span>, alpha_bar.sqrt(), <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        self.q_sigma: torch.Tensor</span><br><span class="line">        self.register_buffer(<span class="string">&quot;q_sigma&quot;</span>, (<span class="number">1.0</span> - alpha_bar).sqrt(), <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># reverse parameters</span></span><br><span class="line">        self.p_mu_coef: torch.Tensor</span><br><span class="line">        self.register_buffer(<span class="string">&quot;p_mu_coef&quot;</span>, <span class="number">1.0</span> / alpha.sqrt(), <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        self.p_eps_coef: torch.Tensor</span><br><span class="line">        self.register_buffer(<span class="string">&quot;p_eps_coef&quot;</span>, beta / (<span class="number">1.0</span> - alpha_bar).sqrt(), <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        self.p_sigma: torch.Tensor</span><br><span class="line">        self.register_buffer(<span class="string">&quot;p_sigma&quot;</span>, beta.sqrt(), <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">q_sample</span>(<span class="params">self, x0: torch.Tensor, t: torch.Tensor, eps: <span class="type">Optional</span>[torch.Tensor] = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Forward from x0 to xt.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x0: (B, c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            xt: (B, c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eps <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            eps = torch.randn_like(x0)</span><br><span class="line"></span><br><span class="line">        mu = self.q_mu_coef.gather(-<span class="number">1</span>, t).view(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>) * x0</span><br><span class="line">        sigma = self.q_sigma.gather(-<span class="number">1</span>, t).view(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mu + sigma * eps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">p_sample</span>(<span class="params">self, xt: torch.Tensor, t: torch.Tensor, eps: <span class="type">Optional</span>[torch.Tensor] = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Reverse from xt to xt_1.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            xt: (B, c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            xt_1: (B, c, h, w)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> eps <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            eps = torch.randn_like(xt)</span><br><span class="line"></span><br><span class="line">        eps_theta = self.eps_model(xt, t)</span><br><span class="line"></span><br><span class="line">        mu_coef = self.p_mu_coef.gather(-<span class="number">1</span>, t).view(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        eps_coef = self.p_eps_coef.gather(-<span class="number">1</span>, t).view(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        mu = mu_coef * (xt - eps_coef * eps_theta)</span><br><span class="line">        sigma = self.p_sigma.gather(-<span class="number">1</span>, t).view(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mu + sigma * eps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x0: torch.Tensor, t: <span class="type">Optional</span>[torch.Tensor] = <span class="literal">None</span>, noise: <span class="type">Optional</span>[torch.Tensor] = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Compute losses for x0.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x0: (B, c, h, w)</span></span><br><span class="line"><span class="string">            t: (B, )</span></span><br><span class="line"><span class="string">            noise: (B, c, h, w)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            loss: MSE loss value</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> t <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            t = torch.randint(<span class="number">0</span>, self.timesteps, x0.shape[<span class="number">0</span>:<span class="number">1</span>], device=x0.device, dtype=torch.long)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> noise <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            noise = torch.randn_like(x0)</span><br><span class="line"></span><br><span class="line">        xt = self.q_sample(x0, t, eps=noise)</span><br><span class="line">        eps_theta = self.eps_model(xt, t)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> F.mse_loss(noise, eps_theta)</span><br></pre></td></tr></table></figure>

</details>

<p>ä¸»è¦æ˜¯å®ç°ä¸€ä¸ª UNet, å¹¶ä¸”ç»“æ„å¦‚ä¸‹.</p>
<p><img data-src="https://nn.labml.ai/unet/unet.png" alt="UNet"></p>
<p><img data-src="https://pic3.zhimg.com/80/v2-f396d21e0cfdfe324a2dc7a8636ac88e_1440w.webp" alt="UNet-DDPM"></p>
<p>ç¬¬ä¸€ä¸ªæ˜¯åŸå§‹ UNet ç»“æ„, ç¬¬äºŒä¸ªæ˜¯å¯¹åº”äº DDPM çš„ UNet ç»“æ„, å‚è€ƒä¸€ä¸‹ç†è§£åŸç†å³å¯.</p>
<p>å¯¹äºæ‰©æ•£éƒ¨åˆ†çš„ä»£ç , å¯ä»¥å‚è€ƒå¾ˆä¹…ä¹‹å‰çš„æ€»ç»“<a href="/posts/2022/10/29/diffusion-model/">æ‰©æ•£æ¨¡å‹é˜…è¯»ç¬”è®°</a>, é‡Œé¢æœ‰å‰å‘å’Œåå‘çš„è®¡ç®—å…¬å¼, å¯¹ç€å†™å°±å¥½äº†.</p>
<h2 id="ä¸»ç¨‹åº"><a href="#ä¸»ç¨‹åº" class="headerlink" title="ä¸»ç¨‹åº"></a>ä¸»ç¨‹åº</h2><p>åŒ…å«è®­ç»ƒå’Œç”Ÿæˆéƒ¨åˆ†ä»£ç , ä»¥åŠå‘½ä»¤è¡Œå‚æ•°é€‰é¡¹.</p>
<details class="note "><summary><p><strong>[ç‚¹å‡»å±•å¼€]</strong> è®­ç»ƒå’Œé‡‡æ ·ä»£ç </p>
</summary>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ProgressBar</span>(rich.progress.Progress):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(</span><br><span class="line">            rich.progress.SpinnerColumn(),</span><br><span class="line">            rich.progress.TextColumn(<span class="string">&quot;[progress.description]&#123;task.description&#125;&quot;</span>),</span><br><span class="line">            rich.progress.BarColumn(),</span><br><span class="line">            rich.progress.TaskProgressColumn(<span class="string">&quot;[progress.percentage]&#123;task.completed:d&#125;/&#123;task.total:d&#125;&quot;</span>),</span><br><span class="line">            rich.progress.TimeElapsedColumn(),</span><br><span class="line">            rich.progress.TimeRemainingColumn(),</span><br><span class="line">            **kwargs</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ImageDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Image Dataset.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *folders: <span class="built_in">str</span>, img_size: <span class="built_in">int</span> = <span class="number">64</span>, img_mode: <span class="built_in">str</span> = <span class="string">&quot;RGB&quot;</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Anime Faces Dataset.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            folders: dataset folders, containing pictures.</span></span><br><span class="line"><span class="string">            img_size: to resize images to (img_size, img_size)</span></span><br><span class="line"><span class="string">            img_mode: image mode, same as PIL options.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        self.paths = [<span class="built_in">str</span>(p) <span class="keyword">for</span> f <span class="keyword">in</span> folders <span class="keyword">for</span> p <span class="keyword">in</span> Path(f).iterdir()]</span><br><span class="line">        self.trans = T.Compose([</span><br><span class="line">            T.ToTensor(),</span><br><span class="line">            T.Resize(img_size, antialias=<span class="literal">True</span>),</span><br><span class="line">            T.CenterCrop(img_size),</span><br><span class="line">            T.Normalize([<span class="number">0.5</span>], [<span class="number">0.5</span>])</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        self.random_flip = T.RandomHorizontalFlip()</span><br><span class="line"></span><br><span class="line">        self.img_mode = img_mode</span><br><span class="line"></span><br><span class="line">        <span class="comment"># load in memory to avoid io operations</span></span><br><span class="line">        self.imgs = [self.trans(Image.<span class="built_in">open</span>(p).convert(self.img_mode)) <span class="keyword">for</span> p <span class="keyword">in</span> self.paths]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.paths)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="keyword">return</span> self.random_flip(self.imgs[index])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Program</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Diffusion Program&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, args</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">        self.img_mode: <span class="built_in">str</span> = &#123;<span class="number">1</span>: <span class="string">&quot;L&quot;</span>, <span class="number">3</span>: <span class="string">&quot;RGB&quot;</span>&#125;[args.img_channels]</span><br><span class="line">        self.imgtrans = T.Compose([</span><br><span class="line">            T.Normalize([-<span class="number">1</span>], [<span class="number">2</span>]),</span><br><span class="line">            T.ToPILImage(self.img_mode),</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        self.model = GaussianDiffusion(</span><br><span class="line">            UNet(args.img_channels,</span><br><span class="line">                 args.num_channels,</span><br><span class="line">                 args.channel_multiples,</span><br><span class="line">                 args.has_attn,</span><br><span class="line">                 args.num_blocks),</span><br><span class="line">            args.timesteps,</span><br><span class="line">            args.beta_min,</span><br><span class="line">            args.beta_max</span><br><span class="line">        ).to(args.device)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.args.train:</span><br><span class="line">            self.dataset = ImageDataset(*args.data_folders, img_size=args.img_size, img_mode=self.img_mode)</span><br><span class="line">            self.dataloader = DataLoader(self.dataset, args.batch_size, <span class="literal">True</span>)</span><br><span class="line">            self.optim = Adam(self.model.parameters(), args.lr)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @torch.inference_mode()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ddpm</span>(<span class="params">self, n: <span class="built_in">int</span>, return_steps: <span class="built_in">bool</span> = <span class="literal">False</span>, step: <span class="built_in">int</span> = <span class="number">100</span></span>) -&gt; <span class="type">List</span>[torch.Tensor]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;DDPM Sample</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            n: n samples.</span></span><br><span class="line"><span class="string">            return_steps: if return steps.</span></span><br><span class="line"><span class="string">            step: if return steps, steps between steps.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            x_steps: List of x, the last is the final result, each one has shape of (B, c, h, w).</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        self.model.<span class="built_in">eval</span>()</span><br><span class="line">        n_steps = self.args.timesteps</span><br><span class="line"></span><br><span class="line">        x_steps = []</span><br><span class="line"></span><br><span class="line">        x = torch.randn([n, self.args.img_channels, self.args.img_size, self.args.img_size], device=self.args.device)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> return_steps:</span><br><span class="line">            x_steps.append(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> ProgressBar() <span class="keyword">as</span> progress:</span><br><span class="line">            task_sample = progress.add_task(<span class="string">&quot;[red]DDPM Sample&quot;</span>, total=n_steps)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> torch.autocast(self.args.device):</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(n_steps)):</span><br><span class="line">                    x = self.model.p_sample(x, x.new_full((n,), t, dtype=torch.long))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (n_steps - t) % step == <span class="number">0</span>:</span><br><span class="line">                        x_steps.append(x)</span><br><span class="line"></span><br><span class="line">                    progress.advance(task_sample)</span><br><span class="line"></span><br><span class="line">        x_steps.append(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x_steps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_image</span>(<span class="params">self, x: torch.Tensor, path: <span class="built_in">str</span></span>):</span><br><span class="line">        x: Image.Image = self.imgtrans(x.clamp(-<span class="number">1.0</span>, <span class="number">1.0</span>))</span><br><span class="line">        x.save(path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_ckpt</span>(<span class="params">self, path: <span class="built_in">str</span></span>):</span><br><span class="line">        torch.save(self.model.state_dict(), path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_ckpt</span>(<span class="params">self, path: <span class="built_in">str</span></span>):</span><br><span class="line">        self.model.load_state_dict(torch.load(path, self.args.device))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self</span>) -&gt; <span class="type">List</span>[<span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Train model.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            losses: Losses of each epoch.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        losses = []</span><br><span class="line">        self.model.train()</span><br><span class="line">        save_dir = Path(self.args.ckpt_save_dir)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> ProgressBar() <span class="keyword">as</span> progress:</span><br><span class="line">            task_epoch = progress.add_task(<span class="string">&quot;[#00DEF2]Epochs&quot;</span>, total=self.args.epochs)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(self.args.epochs):</span><br><span class="line">                task_batch = progress.add_task(<span class="string">&quot;[#00DF75]Batches&quot;</span>, total=<span class="built_in">len</span>(self.dataset))</span><br><span class="line"></span><br><span class="line">                epoch_losses = []</span><br><span class="line">                start_t = time.time()</span><br><span class="line">                <span class="keyword">for</span> i, data <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.dataloader):</span><br><span class="line">                    data = data.to(args.device)</span><br><span class="line">                    self.optim.zero_grad()</span><br><span class="line">                    loss = self.model(data)</span><br><span class="line">                    loss.backward()</span><br><span class="line">                    self.optim.step()</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                        epoch_losses.append(loss.item())</span><br><span class="line"></span><br><span class="line">                    progress.advance(task_batch, <span class="built_in">len</span>(data))</span><br><span class="line"></span><br><span class="line">                end_t = time.time()</span><br><span class="line">                epoch_mean_loss = <span class="built_in">sum</span>(epoch_losses) / <span class="built_in">len</span>(epoch_losses)</span><br><span class="line">                progress.<span class="built_in">print</span>(<span class="string">f&quot;[Epoch <span class="subst">&#123;epoch&#125;</span>] Loss: <span class="subst">&#123;epoch_mean_loss:<span class="number">.6</span>f&#125;</span> Elapsed: <span class="subst">&#123;(end_t - start_t) / <span class="number">60</span>:<span class="number">.2</span>f&#125;</span> min&quot;</span>)</span><br><span class="line">                losses.append(epoch_mean_loss)</span><br><span class="line"></span><br><span class="line">                self.save_ckpt(save_dir.joinpath(<span class="string">f&quot;ckpt-<span class="subst">&#123;epoch % <span class="number">5</span>&#125;</span>.pth&quot;</span>))</span><br><span class="line"></span><br><span class="line">                progress.remove_task(task_batch)</span><br><span class="line">                progress.advance(task_epoch)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> losses</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, n: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Generate random images.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        imgs = self.ddpm(n)[-<span class="number">1</span>]</span><br><span class="line">        save_dir = Path(self.args.save_dir)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(imgs)):</span><br><span class="line">            self.save_image(imgs[i], save_dir.joinpath(<span class="string">f&quot;ddpm-<span class="subst">&#123;i&#125;</span>.png&quot;</span>))</span><br><span class="line"></span><br><span class="line">        all_img = make_grid(imgs)</span><br><span class="line">        <span class="keyword">if</span> self.args.img_channels == <span class="number">1</span>:</span><br><span class="line">            all_img = all_img[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line">        self.save_image(all_img, save_dir.joinpath(<span class="string">f&quot;ddpm-all.png&quot;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_forward_steps</span>(<span class="params">self, path: <span class="built_in">str</span></span>):</span><br><span class="line">        batch = <span class="built_in">next</span>(<span class="built_in">iter</span>(self.dataloader)).to(self.args.device)</span><br><span class="line">        n = <span class="built_in">len</span>(batch)</span><br><span class="line">        forward_steps = [batch]</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">99</span>, self.args.timesteps, <span class="number">100</span>):</span><br><span class="line">            x_t = self.model.q_sample(batch, batch.new_full((n,), t, dtype=torch.long))</span><br><span class="line">            forward_steps.append(x_t)</span><br><span class="line">        self.save_image(torch.cat([torch.cat(v.unbind(), <span class="number">1</span>) <span class="keyword">for</span> v <span class="keyword">in</span> forward_steps], <span class="number">2</span>), path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_reverse_steps</span>(<span class="params">self, path: <span class="built_in">str</span></span>):</span><br><span class="line">        self.save_image(torch.cat([torch.cat(v.unbind(), <span class="number">1</span>) <span class="keyword">for</span> v <span class="keyword">in</span> self.ddpm(<span class="number">8</span>, <span class="literal">True</span>)], <span class="number">2</span>), path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.args.loadckpt:</span><br><span class="line">            self.load_ckpt(self.args.loadckpt)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.args.train:</span><br><span class="line">            <span class="comment"># self.save_forward_steps(&quot;run-forward.png&quot;)</span></span><br><span class="line">            self.save_reverse_steps(<span class="string">&quot;run-before.png&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.train()</span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[*] Stopped by user.&quot;</span>)</span><br><span class="line">            self.save_reverse_steps(<span class="string">&quot;run-after.png&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.generate(self.args.batch_size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = ArgumentParser()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># data args</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--data-folders&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, nargs=<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--img-channels&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">3</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--img-size&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># model args</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--num-channels&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">64</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--channel-multiples&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, nargs=<span class="string">&quot;+&quot;</span>, default=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>])</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--has-attn&quot;</span>, <span class="built_in">type</span>=<span class="keyword">lambda</span> x: x.lower() == <span class="string">&quot;t&quot;</span>, nargs=<span class="string">&quot;+&quot;</span>, default=[<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">True</span>])</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--num-blocks&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># diffusion args</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--timesteps&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1000</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--beta-min&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">0.0001</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--beta-max&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">0.02</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># train args</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--train&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--lr&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">1e-4</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--epochs&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">5</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--ckpt-save-dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;ckpt&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># inference args</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--save-dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;output&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># run args</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--seed&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="literal">None</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--device&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=(<span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--loadckpt&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--batch-size&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="built_in">print</span>(args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.seed:</span><br><span class="line">        torch.manual_seed(args.seed)</span><br><span class="line">        torch.cuda.manual_seed(args.seed)</span><br><span class="line"></span><br><span class="line">    Program(args).run()</span><br></pre></td></tr></table></figure>

</details>

<h2 id="è®­ç»ƒå‚æ•°"><a href="#è®­ç»ƒå‚æ•°" class="headerlink" title="è®­ç»ƒå‚æ•°"></a>è®­ç»ƒå‚æ•°</h2><p>æ¨¡å‹å‚æ•°éƒ½ç”¨çš„é»˜è®¤å€¼, ä¸åŸè®ºæ–‡éå¸¸æ¥è¿‘, ä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥æ¨¡å‹ä½“ç§¯æ¯”é¢„æœŸå¤§äº†ä¸€ç‚¹.</p>
<p>å­¦ä¹ ç‡å¯èƒ½éœ€è¦è°ƒæ•´ä¸€ä¸¤æ¬¡, å®æµ‹å¯ä»¥å…ˆæŒ‰ <code>1e-3</code> è·‘ä¸ª 10 ~ 20 è½®, ç„¶åæŒ‰ <code>1e-4</code> è·‘åˆ°æŸå¤±å·®ä¸å¤šç¨³å®š (30 ~ 40 è½®), æœ‰å‡ºå›¾æ•ˆæœä¹‹å, å†æŒ‰ <code>1e-5</code> å’Œ <code>1e-6</code> ä¸€ç›´è·‘åˆ°æ”¶æ•›.</p>
<p>å­¦ä¹ ç‡ä¸€å®šä¸èƒ½å¤ªå¤§äº†, å¦åˆ™å¾ˆå®¹æ˜“å´©.</p>
<p>ç”¨å…¨éƒ¨çš„ 8 ä¸‡æ•°æ®é›†è´¨é‡ä¸æ˜¯å¾ˆé«˜, æ‰€ä»¥åªç”¨äº† 2 ä¸‡é‚£ä¸ª, å¹¶ä¸”åœ¨è¯»å–æ•°æ®é›†çš„æ—¶å€™åŠ äº†éšæœºæ°´å¹³ç¿»è½¬å›¾åƒ.</p>
<p>å½“ç„¶äº†, æ¯•ç«Ÿæ˜¯ç‚¼ä¸¹, è¯´ä¸å®šæœ‰æ›´ç„ä¹çš„å‚æ•°è®¾ç½®å’”å’”å°±æ”¶æ•›æ•ˆæœè¿˜å¥½.</p>
<h2 id="ç‚¼ä¸¹ç»“æœ"><a href="#ç‚¼ä¸¹ç»“æœ" class="headerlink" title="ç‚¼ä¸¹ç»“æœ"></a>ç‚¼ä¸¹ç»“æœ</h2><p>é‡‡æ ·çš„æ—¶å€™ä¸ºäº†å¿«ä¸€ç‚¹, åŠ äº† <code>inference_mode</code> å’Œ <code>autocast</code>, PyTorch æä¾›çš„æ¨ç†æ¨¡å¼å’Œè‡ªåŠ¨æ··åˆç²¾åº¦.</p>
<p>å®æµ‹åŠ äº†æ··åˆç²¾åº¦ååªéœ€è¦åŸæœ¬ 60% å·¦å³çš„æ—¶é—´, ç¡®å®æœ‰æ˜æ˜¾çš„åŠ é€Ÿä¼˜åŠ¿.</p>
<p>æ”¾å‡ å¼ åå‘å»å™ªçš„ç»“æœå›¾, æ•ˆæœè¿˜è¡Œ, é¢‡æœ‰æ¯•åŠ ç´¢çš„ç¾æœ¯é£æ ¼.</p>
<details class="note success"><summary><p><strong>[ç‚¹å‡»å±•å¼€]</strong> æœªæ”¶æ•›æ—¶åå‘æ‰©æ•£ç»“æœ</p>
</summary>
<p><img data-src="/static/image/ddpm/ckpt-1e03x10.png" alt="ckpt-1e03x10.png"><br><img data-src="/static/image/ddpm/ckpt-1e03x15.png" alt="ckpt-1e03x15.png"><br><img data-src="/static/image/ddpm/ckpt-1e03x20.png" alt="ckpt-1e03x20.png"><br><img data-src="/static/image/ddpm/ckpt-1e04x05.png" alt="ckpt-1e04x05.png"><br><img data-src="/static/image/ddpm/ckpt-1e04x10.png" alt="ckpt-1e04x10.png"><br><img data-src="/static/image/ddpm/ckpt-1e04x15.png" alt="ckpt-1e04x15.png"><br><img data-src="/static/image/ddpm/ckpt-1e03x20.png" alt="ckpt-1e04x20.png"><br><img data-src="/static/image/ddpm/ckpt-1e04x25.png" alt="ckpt-1e04x25.png"></p>

</details>

<details class="note success"><summary><p><strong>[ç‚¹å‡»å±•å¼€]</strong> æ”¶æ•›ä¹‹ååå‘æ‰©æ•£ç»“æœ</p>
</summary>
<p><img data-src="/static/image/ddpm/ckpt-1e07x10.png" alt="ckpt-1e07x10.png"><br><img data-src="/static/image/ddpm/ckpt-1e07x20.png" alt="ckpt-1e07x20.png"><br><img data-src="/static/image/ddpm/ckpt-1e08x10.png" alt="ckpt-1e08x10.png"><br><img data-src="/static/image/ddpm/ckpt-1e08x20.png" alt="ckpt-1e08x20.png"><br><img data-src="/static/image/ddpm/ckpt-1e09x10.png" alt="ckpt-1e09x10.png"><br><img data-src="/static/image/ddpm/ckpt-1e09x20.png" alt="ckpt-1e09x20.png"><br><img data-src="/static/image/ddpm/ckpt-1e10x10.png" alt="ckpt-1e10x10.png"><br><img data-src="/static/image/ddpm/ckpt-1e10x20.png" alt="ckpt-1e10x20.png"></p>

</details>

<details class="note success"><summary><p><strong>[ç‚¹å‡»å±•å¼€]</strong> åŒä¸€ç»„é«˜æ–¯å™ªå£°éšæ¨¡å‹æ”¶æ•›é‡‡æ ·ç»“æœ</p>
</summary>
<p><img data-src="/static/image/ddpm/ckpt-all.png" alt="ckpt-all.png"></p>

</details>

<p>æœ€åæ”¾ä¸€ä¸ªæŠ½å¡ç»“æœ, éšæœºæŠ½ 64 å¼ .</p>
<p><img data-src="/static/image/ddpm/sample-64.png" alt="sample-64.png"></p>
<p>è¯´å®è¯, ç‚¼ä¸¹æ•ˆæœå’Œæ•°æ®é›†æœ‰ç›¸å½“å¤§å…³ç³», è¶Šé«˜è´¨é‡çš„æ•°æ®é›†ç‚¼å‡ºæ¥çš„æ¨¡å‹è¶Šå¥½, è¶Šä¸å®¹æ˜“å‡ºé—®é¢˜, å¹¶ä¸”æ•°æ®é‡è¶Šå¤§ç”Ÿæˆçš„ç»“æœä¹Ÿè¶Šä¸°å¯Œ<del>æ¨¡å‹å…¶å®éƒ½ä¸æ˜¯ä»€ä¹ˆç‰¹åˆ«é‡è¦çš„äº‹æƒ…, åæ­£éƒ½æ˜¯ä¹±æ‹Ÿåˆä¸€ä¸ª</del>.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9hcnhpdi5vcmcvcGRmLzIwMDYuMTEyMzkucGRm">Denoising Diffusion Probabilistic Models<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hvam9uYXRoYW5oby9kaWZmdXNpb24=">diffusion<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82NTU1Njg5MTA=">æ·±å…¥æµ…å‡ºæ‰©æ•£æ¨¡å‹(Diffusion Model)ç³»åˆ—ï¼šåŸºçŸ³DDPMï¼ˆæºç è§£è¯»ç¯‡ï¼‰<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xhYm1sYWkvYW5ub3RhdGVkX2RlZXBfbGVhcm5pbmdfcGFwZXJfaW1wbGVtZW50YXRpb25z">annotated_deep_learning_paper_implementations<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2x1Y2lkcmFpbnMvZGVub2lzaW5nLWRpZmZ1c2lvbi1weXRvcmNo">denoising-diffusion-pytorch<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>DDPM</tag>
        <tag>åŠ¨æ¼«å¤´åƒç”Ÿæˆ</tag>
        <tag>æ¦‚ç‡æ‰©æ•£æ¨¡å‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ OpenCV è¿›è¡Œå›¾åƒå¯¹æ¯”</title>
    <url>//posts/2024/08/02/imgcmp/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹æœ€è¿‘å†™çš„ä¸€ä¸ªå°å·¥å…·æ¨¡å—, ç”¨æ¥æ¯”è¾ƒä¸¤å¼ å›¾åƒä¹‹é—´çš„ç›¸ä¼¼åº¦, å¹¶ä¸”è¾“å‡ºç›´æ–¹å›¾å·®å¼‚ä»¥åŠåƒç´ å·®å¼‚.</p>
<span id="more"></span>

<h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p>ç›®æ ‡æ˜¯æ¯”è¾ƒä¸¤å¼ ç›¸åŒ RGB å›¾åƒçš„ç›¸ä¼¼åº¦, çœ‹å®ƒä»¬ä¹‹é—´æ˜¯å¦å­˜åœ¨è‰²å½©é˜´å½±äº®åº¦ä¹‹ç±»çš„åŒºåˆ«.</p>
<p>å› æ­¤é¦–å…ˆå°†å›¾åƒè¯»å–åè½¬æ¢æˆ HLS é€šé“æ ¼å¼, å†ä¾æ¬¡æ±‚è§£æ¯ä¸ªé€šé“ä¸Šçš„ç›´æ–¹å›¾å·®å¼‚ä»¥åŠåƒç´ å·®åˆ†å›¾.</p>
<h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">HlsSimilarity = namedtuple(<span class="string">&quot;HlsSimilarity&quot;</span>, [<span class="string">&quot;H&quot;</span>, <span class="string">&quot;L&quot;</span>, <span class="string">&quot;S&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_image_as_hls</span>(<span class="params">path: <span class="built_in">str</span>, blur_ksize: <span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; np.ndarray:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¯»å–å›¾åƒå¹¶è½¬æ¢æˆ HLS æ ¼å¼.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ç”±äºå¯¹æ¯”çš„æ—¶å€™è¿‡äºçµæ•, æ‰€ä»¥æœ‰å¿…è¦åŠ ä¸€å®šç¨‹åº¦çš„æ¨¡ç³Š.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        image: å½¢çŠ¶ä¸º (H, W, 3)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(path, cv2.IMREAD_COLOR)</span><br><span class="line">    <span class="keyword">if</span> blur_ksize &gt; <span class="number">0</span>:</span><br><span class="line">        img = cv2.blur(img, (blur_ksize, blur_ksize))</span><br><span class="line">    img = cv2.cvtColor(img, cv2.COLOR_BGR2HLS_FULL)</span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_image_hist_delta</span>(<span class="params">img1: <span class="built_in">str</span>, img2: <span class="built_in">str</span></span>) -&gt; <span class="type">Tuple</span>[np.ndarray, np.ndarray, np.ndarray]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—ä¸¤å¼ ç›´æ–¹å›¾å·®å¼‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        delta: (H, L, S) ä¸‰ä¸ªåˆ†é‡çš„ç›´æ–¹å›¾å·®å¼‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img1 = read_image_as_hls(img1)</span><br><span class="line">    img2 = read_image_as_hls(img2)</span><br><span class="line"></span><br><span class="line">    hist_delta = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        h1 = cv2.calcHist([img1], [i], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]).flatten()</span><br><span class="line">        h2 = cv2.calcHist([img2], [i], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]).flatten()</span><br><span class="line">        hist_delta.append(h1 - h2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(hist_delta)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_colors</span>(<span class="params">cname: <span class="built_in">str</span> = <span class="string">&quot;hsv&quot;</span>, size: <span class="built_in">int</span> = <span class="number">256</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è·å¾—è¿ç»­çš„è°ƒè‰²æ¿é¢œè‰²åºåˆ—&quot;&quot;&quot;</span></span><br><span class="line">    cmap = plt.get_cmap(cname, size)</span><br><span class="line">    <span class="keyword">return</span> [cmap(i)[:<span class="number">3</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc_image_similarity</span>(<span class="params">img1: <span class="built_in">str</span>, img2: <span class="built_in">str</span>, blur_ksize: <span class="built_in">int</span> = <span class="number">15</span></span>) -&gt; HlsSimilarity:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è®¡ç®—ä¸¤å¼ å›¾åƒçš„ç›¸ä¼¼åº¦, å…·ä½“ç®—æ³•è§ https://docs.opencv.org/4.5.5/d8/dc8/tutorial_histogram_comparison.html</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    æ­¤å¤„ä½¿ç”¨ Bhattacharyya distance, å¹¶ä¸”åŠ äº†ä¸€å®šé‡çš„æ¨¡ç³Šå¤„ç†.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        similarities: (H, L, S) ä¸‰ä¸ªåˆ†é‡çš„ç›¸ä¼¼åº¦</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img1 = read_image_as_hls(img1, blur_ksize)</span><br><span class="line">    img2 = read_image_as_hls(img2, blur_ksize)</span><br><span class="line"></span><br><span class="line">    similarities = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">    similarities[<span class="number">0</span>] = <span class="number">1</span> - cv2.compareHist(</span><br><span class="line">        cv2.calcHist([img1], [<span class="number">0</span>], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]), cv2.calcHist([img2], [<span class="number">0</span>], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]), <span class="number">3</span></span><br><span class="line">    )</span><br><span class="line">    similarities[<span class="number">1</span>] = <span class="number">1</span> - cv2.compareHist(</span><br><span class="line">        cv2.calcHist([img1], [<span class="number">1</span>], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]), cv2.calcHist([img2], [<span class="number">1</span>], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]), <span class="number">3</span></span><br><span class="line">    )</span><br><span class="line">    similarities[<span class="number">2</span>] = <span class="number">1</span> - cv2.compareHist(</span><br><span class="line">        cv2.calcHist([img1], [<span class="number">2</span>], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]), cv2.calcHist([img2], [<span class="number">2</span>], <span class="literal">None</span>, [<span class="number">256</span>], [<span class="number">0</span>, <span class="number">255</span>]), <span class="number">3</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HlsSimilarity(*similarities)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_image_hist_delta</span>(<span class="params">img1: <span class="built_in">str</span>, img2: <span class="built_in">str</span>, path: <span class="built_in">str</span>, title: <span class="built_in">str</span> = <span class="string">&quot;Hist Delta of HLS Image (First - Second)&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ç»˜åˆ¶å·®å¼‚ç›´æ–¹å›¾æƒ…å†µ&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    delta_H, delta_L, delta_S = calc_image_hist_delta(img1, img2)</span><br><span class="line"></span><br><span class="line">    fig, axes = plt.subplots(<span class="number">3</span>, <span class="number">1</span>, squeeze=<span class="literal">True</span>, figsize=(<span class="number">12</span>, <span class="number">16</span>), dpi=<span class="number">300</span>)</span><br><span class="line">    fig.subplots_adjust(left=<span class="number">0.1</span>, right=<span class="number">0.9</span>, top=<span class="number">0.93</span>, bottom=<span class="number">0.07</span>)</span><br><span class="line">    fig.suptitle(title)</span><br><span class="line">    fig.supxlabel(<span class="string">&quot;Pixel Value&quot;</span>)</span><br><span class="line">    fig.supylabel(<span class="string">&quot;Pixel Count&quot;</span>)</span><br><span class="line"></span><br><span class="line">    axes: <span class="built_in">list</span>[plt.Axes]</span><br><span class="line">    ax_H, ax_L, ax_S = axes</span><br><span class="line"></span><br><span class="line">    x_len = <span class="built_in">len</span>(delta_H)</span><br><span class="line">    ax_H.bar(np.arange(x_len), delta_H, color=get_colors(<span class="string">&quot;hsv&quot;</span>, x_len))</span><br><span class="line">    ax_H.set_title(<span class="string">&quot;Delta of H Channel&quot;</span>)</span><br><span class="line">    ax_H.set_xticks(np.arange(<span class="number">0</span>, x_len, <span class="number">10</span>), np.arange(<span class="number">0</span>, x_len, <span class="number">10</span>), rotation=-<span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">    x_len = <span class="built_in">len</span>(delta_L)</span><br><span class="line">    ax_L.bar(np.arange(x_len), delta_L, color=get_colors(<span class="string">&quot;gray&quot;</span>, x_len))</span><br><span class="line">    ax_L.set_title(<span class="string">&quot;Delta of L Channel&quot;</span>)</span><br><span class="line">    ax_L.set_xticks(np.arange(<span class="number">0</span>, x_len, <span class="number">10</span>), np.arange(<span class="number">0</span>, x_len, <span class="number">10</span>), rotation=-<span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">    x_len = <span class="built_in">len</span>(delta_S)</span><br><span class="line">    ax_S.bar(np.arange(x_len), delta_S, color=get_colors(<span class="string">&quot;gray&quot;</span>, x_len))</span><br><span class="line">    ax_S.set_title(<span class="string">&quot;Delta of S Channel&quot;</span>)</span><br><span class="line">    ax_S.set_xticks(np.arange(<span class="number">0</span>, x_len, <span class="number">10</span>), np.arange(<span class="number">0</span>, x_len, <span class="number">10</span>), rotation=-<span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">    fig.savefig(path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_diff_image</span>(<span class="params">img1: <span class="built_in">str</span>, img2: <span class="built_in">str</span>, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å å›¾æŸ¥çœ‹å·®å¼‚, å¦‚æœå°ºå¯¸ä¸ä¸€æ ·æˆ–è€…ä¿å­˜å¤±è´¥è¿”å› False.&quot;&quot;&quot;</span></span><br><span class="line">    img1 = read_image_as_hls(img1)</span><br><span class="line">    img2 = read_image_as_hls(img2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> img1.shape != img2.shape:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    img1_H, img1_L, img1_S = cv2.split(img1)</span><br><span class="line">    img2_H, img2_L, img2_S = cv2.split(img2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è‰²ç›¸æ˜¯ [0, 255] çš„ç¯å½¢å–å€¼, å› æ­¤è®¡ç®—çš„æ—¶å€™è¦å–ç¯ä¸ŠçŸ­ä¾§çš„è·ç¦»</span></span><br><span class="line">    diff_H = np.<span class="built_in">min</span>([img1_H - img2_H, img2_H - img1_H], axis=<span class="number">0</span>)</span><br><span class="line">    diff_H = cv2.normalize(diff_H, <span class="literal">None</span>, <span class="number">0</span>, <span class="number">255</span>, cv2.NORM_MINMAX)</span><br><span class="line">    diff_L = cv2.absdiff(img1_L, img2_L)</span><br><span class="line">    diff_S = cv2.absdiff(img1_S, img2_S)</span><br><span class="line">    diff_img = np.concatenate([diff_H, diff_L, diff_S], axis=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> cv2.imwrite(path, diff_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;img1&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;img2&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--out-hist&quot;</span>, default=<span class="string">&quot;hist.png&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--out-diff&quot;</span>, default=<span class="string">&quot;diff.png&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    sim = calc_image_similarity(args.img1, args.img2)</span><br><span class="line">    <span class="built_in">print</span>(sim)</span><br><span class="line">    draw_image_hist_delta(args.img1, args.img2, args.out_hist)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> make_diff_image(args.img1, args.img2, args.out_diff):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å°ºå¯¸ä¸åŒ, æ— æ³•è®¡ç®—å·®åˆ†&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="è¿è¡Œæ•ˆæœ"><a href="#è¿è¡Œæ•ˆæœ" class="headerlink" title="è¿è¡Œæ•ˆæœ"></a>è¿è¡Œæ•ˆæœ</h2><p>è¾“å…¥ä¸¤å¼ å›¾ç‰‡, ä¾‹å¦‚:</p>
<div class="group-picture"><div class="group-picture-row"><div class="group-picture-column"><img data-src="/static/image/imgcmp/lenna1.png" alt="lenna1.png"></div><div class="group-picture-column"><img data-src="/static/image/imgcmp/lenna2.png" alt="lenna2.png"></div></div></div>

<p>å¯ä»¥å¾—åˆ°ç›¸ä¼¼åº¦: HlsSimilarity(H=0.32851660966060825, L=0.6765325641597513, S=0.6573630520719462)</p>
<p>å¹¶ä¸”æœ‰å·®å¼‚å›¾:</p>
<p><img data-src="/static/image/imgcmp/hist.png" alt="hist.png"></p>
<p><img data-src="/static/image/imgcmp/diff.png" alt="diff.png"></p>
<p>å¯ä»¥çœ‹å‡ºæ¥å·¦å›¾æ¯”å³å›¾å¤šäº†å¾ˆå¤šçº¢è‰²éƒ¨åˆ†, å¹¶ä¸”å°‘ä¸€ä¸€ä¸¢ä¸¢çš„è“è‰².</p>
<p>å¹¶ä¸”å·¦å›¾æ›´äº®, ä¸”é¢œè‰²é¥±å’Œåº¦æ›´é«˜.</p>
]]></content>
      <categories>
        <category>ä»£ç å—</category>
      </categories>
      <tags>
        <tag>OpenCV</tag>
        <tag>å›¾åƒæ¯”å¯¹</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäº Spine çš„ç¢§è“èˆªçº¿æ¡Œå® </title>
    <url>//posts/2023/08/30/desktopsprite/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ä¸ªäººé¡¹ç›® <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Rlc2t0b3BTcHJpdGU=">DesktopSprite<i class="fa fa-external-link-alt"></i></span> çš„ä»‹ç», ä¸€ä¸ªä½¿ç”¨ <code>C++</code> å®ç°çš„åŸç”Ÿæ¡Œå® ç¨‹åº, åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Vzb3RlcmljU29mdHdhcmUvc3BpbmUtcnVudGltZXMvcmVsZWFzZXMvdGFnLzMuNi41Mw==">spine-runtimes v3.6.53<i class="fa fa-external-link-alt"></i></span> è¿è¡Œåº“, å¯ä»¥æ”¯æŒç¢§è“èˆªçº¿å¯¼å‡ºçš„å°äººåŠ¨ç”»èµ„æº.</p>
<span id="more"></span>

<h2 id="é¡¹ç›®ç®€ä»‹"><a href="#é¡¹ç›®ç®€ä»‹" class="headerlink" title="é¡¹ç›®ç®€ä»‹"></a>é¡¹ç›®ç®€ä»‹</h2><p>é¡¹ç›®åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Rlc2t0b3BTcHJpdGU=">https://github.com/ww-rm/DesktopSprite<i class="fa fa-external-link-alt"></i></span></p>
<p>è¿™æ˜¯ä¸€ä¸ªé€‚ç”¨äº <code>Windows</code> ç³»ç»Ÿä¸‹çš„æ¡Œé¢ç²¾çµ, ç›®å‰å·²åœ¨ <code>Win10</code>, <code>Win11</code> ä¸‹åŸºæœ¬æµ‹è¯•é€šè¿‡.</p>
<ul>
<li>è½»é‡çš„æ€§èƒ½ç›‘è§†å™¨: å¯ä»¥æ˜¾ç¤ºç”µè„‘å ç”¨å’Œç½‘é€Ÿç›‘è§†æµ®çª—</li>
</ul>
<p><img data-src="/static/image/desktopsprite/perfmonitor.gif" alt="æ€§èƒ½æµ®çª—åŠ¨å›¾"></p>
<ul>
<li>å¯è‡ªå®šä¹‰æ¡Œå® : æ”¯æŒåŸºäº <code>spine v3.6.53</code> å¯¼å‡ºçš„ç¢§è“èˆªçº¿å…¨è§’è‰²å°äººåŠ¨ç”»</li>
</ul>
<p><img data-src="/static/image/desktopsprite/guanghui_2.gif" alt="guanghui_2 åŠ¨å›¾"><br><img data-src="/static/image/desktopsprite/biaoqiang_h.gif" alt="biaoqiang_h åŠ¨å›¾"><br><img data-src="/static/image/desktopsprite/lafei_h.gif" alt="lafei_h åŠ¨å›¾"><br><img data-src="/static/image/desktopsprite/z23_h.gif" alt="z23_h åŠ¨å›¾"></p>
<h2 id="å®‰è£…ä¸ä½¿ç”¨"><a href="#å®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="å®‰è£…ä¸ä½¿ç”¨"></a>å®‰è£…ä¸ä½¿ç”¨</h2><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å‰å¾€ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Rlc2t0b3BTcHJpdGUvcmVsZWFzZXM=">Release<i class="fa fa-external-link-alt"></i></span> ä¸‹è½½ <code>Latest</code> ç‰ˆæœ¬çš„ <code>zip</code> å‹ç¼©åŒ…, è§£å‹ååŒå‡»è¿è¡Œé‡Œé¢çš„ <code>DesktopSprite.msi</code> å®‰è£…æ–‡ä»¶è¿›è¡Œå®‰è£…, å¯ä»¥è‡ªå®šä¹‰å®‰è£…ä½ç½®.</p>
<p>å®‰è£…å®Œæˆå, å¼€å§‹èœå•å’Œæ¡Œé¢éƒ½ä¼šå‡ºç°ç¨‹åºå¯åŠ¨å›¾æ ‡. åŒå‡»è¿è¡Œ, é€šçŸ¥æ ä¼šæœ‰ç¨‹åºå›¾æ ‡, é¦–æ¬¡è¿è¡Œæ¡Œé¢é»˜è®¤ä¼šæ˜¾ç¤ºè‡ªå¸¦çš„ç¢§è“å°äººè§’è‰², ä¸”æœ‰ä¸€ä¸ªæ€§èƒ½æµ®çª—.</p>
<h3 id="æ›´æ¢è§’è‰²"><a href="#æ›´æ¢è§’è‰²" class="headerlink" title="æ›´æ¢è§’è‰²"></a>æ›´æ¢è§’è‰²</h3><p>å³é”®é€šçŸ¥åŒºåŸŸç¨‹åºå›¾æ ‡, å¯ä»¥è¿›å…¥è®¾ç½®ç•Œé¢, è®¾ç½®å¯¹åº”çš„ <code>atlas</code> å’Œ <code>skel/json</code> æ–‡ä»¶, ç„¶ååº”ç”¨/ç¡®å®šè®¾ç½®å³å¯å®Œæˆæ›´æ¢.</p>
<p>éœ€è¦æ³¨æ„ <code>*.atlas</code>, <code>*.png</code>, <code>*.skel/*.json</code> ä¸‰ä»½æ–‡ä»¶éœ€è¦äº’ç›¸åŒ¹é…, ä¸” <code>*.atlas</code> å’Œ <code>*.png</code> æ–‡ä»¶åå¿…é¡»ç›¸åŒ (é€‰æ‹© <code>atlas</code> çš„æ—¶å€™ä¼šè‡ªåŠ¨å¡«å…¥ <code>png</code> æ–‡ä»¶).</p>
<p><img data-src="/static/image/desktopsprite/atlasconfig.png" alt="atlasconfig"></p>
<h3 id="è¯¦ç»†ä½¿ç”¨è¯´æ˜"><a href="#è¯¦ç»†ä½¿ç”¨è¯´æ˜" class="headerlink" title="è¯¦ç»†ä½¿ç”¨è¯´æ˜"></a>è¯¦ç»†ä½¿ç”¨è¯´æ˜</h3><h4 id="è®¾ç½®é¢æ¿"><a href="#è®¾ç½®é¢æ¿" class="headerlink" title="è®¾ç½®é¢æ¿"></a>è®¾ç½®é¢æ¿</h4><p><img data-src="/static/image/desktopsprite/config.png" alt="config.png"></p>
<h5 id="ç³»ç»Ÿè®¾ç½®"><a href="#ç³»ç»Ÿè®¾ç½®" class="headerlink" title="ç³»ç»Ÿè®¾ç½®"></a>ç³»ç»Ÿè®¾ç½®</h5><ul>
<li>å¼€æœºå¯åŠ¨: ç¨‹åºæ˜¯å¦å¼€æœºå¯åŠ¨</li>
<li>æ•´ç‚¹æŠ¥æ—¶: ä¸€ä¸ªå°åŠŸèƒ½, å¯ä»¥åœ¨æ•´ç‚¹æ—¶é—´å¼¹å‡ºé€šçŸ¥æé†’</li>
<li>æç¤ºå£°éŸ³: æ•´ç‚¹æŠ¥æ—¶æ˜¯å¦æœ‰å£°éŸ³</li>
<li>æ°”æ³¡å›¾æ ‡è·¯å¾„: æ•´ç‚¹æŠ¥æ—¶æ°”æ³¡é€šçŸ¥ä½¿ç”¨çš„å›¾æ ‡</li>
</ul>
<h5 id="æ˜¾ç¤ºè®¾ç½®"><a href="#æ˜¾ç¤ºè®¾ç½®" class="headerlink" title="æ˜¾ç¤ºè®¾ç½®"></a>æ˜¾ç¤ºè®¾ç½®</h5><p>è¿™éƒ¨åˆ†çš„è®¾ç½®æ˜¯é’ˆå¯¹æ€§èƒ½æµ®çª—çš„.</p>
<ul>
<li>æ˜¾ç¤ºæµ®çª—: æ˜¯åœ¨æ¡Œé¢æ˜¾ç¤ºæµ®çª—è¿˜æ˜¯éšè—åˆ°é€šçŸ¥åŒºåŸŸå›¾æ ‡ä½¿ç”¨é¼ æ ‡æ‚¬åœæ˜¾ç¤º</li>
<li>æ˜¾ç¤ºå ç”¨: æ˜¯å¦åœ¨æµ®çª—ä¸Šæ˜¾ç¤ºå¤„ç†å™¨å’Œå†…å­˜å ç”¨ç™¾åˆ†æ¯”</li>
<li>æ˜¾ç¤ºç½‘é€Ÿ: æ˜¯å¦åœ¨æµ®çª—ä¸Šæ˜¾ç¤ºä¸Šä¼ å’Œä¸‹è½½é€Ÿåº¦</li>
<li>æ·±è‰²ä¸»é¢˜: è®¾ç½®æµ®çª—ä¸»é¢˜é¢œè‰²</li>
<li>é€æ˜åº¦: è®¾ç½®æµ®çª—é€æ˜åº¦ç™¾åˆ†æ¯”, 0 ä¸ºå®Œå…¨é€æ˜, 100 ä¸ºå®Œå…¨ä¸é€æ˜</li>
</ul>
<h5 id="ç²¾çµè®¾ç½®"><a href="#ç²¾çµè®¾ç½®" class="headerlink" title="ç²¾çµè®¾ç½®"></a>ç²¾çµè®¾ç½®</h5><p>è¿™éƒ¨åˆ†çš„è®¾ç½®æ˜¯é’ˆå¯¹æ¡Œå® çš„</p>
<ul>
<li>atlas, png, skel è·¯å¾„: é€‰æ‹©è¦ä½¿ç”¨çš„ SD å°äººæ¨¡å‹, ä¸‰ä¸ªæ–‡ä»¶è¦äº’ç›¸åŒ¹é…</li>
<li>æ˜¾ç¤ºç²¾çµ: æ˜¯å¦åœ¨æ¡Œé¢ä¸Šæ˜¾ç¤ºæ¡Œå® , ä¸æ˜¾ç¤ºçš„æƒ…å†µä¸‹ä¸ä¼šæœ‰æ¡Œå® çš„èµ„æºå ç”¨</li>
<li>é¼ æ ‡ç©¿é€: æ˜¯å¦è®©æ¡Œå® é¼ æ ‡ç©¿é€, ç©¿é€æƒ…å†µä¸‹æ¡Œå® æ— è§†é¼ æ ‡å’Œé”®ç›˜è¾“å…¥</li>
<li>æœ€å¤§å¸§ç‡: è®¾ç½®æ¡Œå® çš„æ¸²æŸ“å¸§ç‡, å¯¹ç”µè„‘æ€§èƒ½æœ‰è¾ƒé«˜å½±å“</li>
<li>é€æ˜åº¦: è®¾ç½®æ¡Œå® é€æ˜åº¦, é…åˆé¼ æ ‡ç©¿é€å¯ä»¥è®¾ç½®æŒ‚ä»¶æ•ˆæœ</li>
<li>ç¼©æ”¾: è®¾ç½®æ¡Œå® çš„å¤§å°</li>
</ul>
<h5 id="Spine-è®¾ç½®"><a href="#Spine-è®¾ç½®" class="headerlink" title="Spine è®¾ç½®"></a>Spine è®¾ç½®</h5><p>è¯¥éƒ¨åˆ†è®¾ç½®æ¡Œå® åŠ¨ç”»å°äººä¸åŒäº‹ä»¶å’ŒåŠ¨ç”»çš„æ˜ å°„å…³ç³», å¯é€‰å†…å®¹ç”±åŠ è½½çš„ spine æ¨¡å‹å†³å®š.</p>
<ul>
<li>å¾…æœº: æ— æ“ä½œçš„æ™®é€šæƒ…å†µ</li>
<li>æ‹–åŠ¨: é¼ æ ‡æ‹–åŠ¨æ¡Œå® æ—¶è§¦å‘</li>
<li>ä»»åŠ¡ä¸­: æ²¡æƒ³å¥½</li>
<li>ç¡è§‰: ç”µè„‘æ— è¾“å…¥é—²ç½®ä¸€æ®µæ—¶é—´åè§¦å‘</li>
<li>é—²ç½®: ç”µè„‘ä½è´Ÿè½½æ—¶éšæœºè§¦å‘</li>
<li>è§¦æ‘¸: å•å‡»æ¡Œå® è§¦å‘</li>
<li>æ‘¸å¤´: é¼ æ ‡ä¸­é”®ä¸‹æ»š</li>
<li>ä»»åŠ¡å®Œæˆ: ä»»åŠ¡ç»“æŸå, å’Œä»»åŠ¡ä¸­æ˜¯è¿ç€çš„</li>
<li>è·³èˆ: é¼ æ ‡ä¸­é”®ä¸Šæ»š</li>
<li>è¿‡è½½: ç”µè„‘é«˜è´Ÿè½½æ—¶éšæœºè§¦å‘</li>
</ul>
<h5 id="æŒ‰é’®"><a href="#æŒ‰é’®" class="headerlink" title="æŒ‰é’®"></a>æŒ‰é’®</h5><ul>
<li>æ‰“å¼€æ•°æ®æ–‡ä»¶å¤¹: æ‰“å¼€ç¨‹åºæ•°æ®æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹</li>
</ul>
<h4 id="å¿«æ·æ“ä½œ"><a href="#å¿«æ·æ“ä½œ" class="headerlink" title="å¿«æ·æ“ä½œ"></a>å¿«æ·æ“ä½œ</h4><ul>
<li>å³é”®èœå•: æœ‰ä¸¤ä¸ª, ä¸€ä¸ªæ˜¯æµ®çª—/é€šçŸ¥åŒºåŸŸå›¾æ ‡çš„, å¦ä¸€ä¸ªæ˜¯æ¡Œå® çš„, å¤§éƒ¨åˆ†é€‰é¡¹éƒ½æ˜¯è®¾ç½®é¢æ¿é‡Œæœ‰çš„, æ˜¯å¿«æ·æ“ä½œ</li>
<li>ç²¾çµå¤ä½: ç”¨æ¥é¢„é˜²ä¸€äº›æœªçŸ¥çš„ç‰¹æ®Šæƒ…å†µ, å¦‚ä¸€äº›ä¸å¯çŸ¥çš„æ˜¾ç¤ºå™¨åˆ†è¾¨ç‡é—®é¢˜å¯¼è‡´çš„ç²¾çµé”™ä½æ¶ˆå¤±, ç‚¹å‡»ä¹‹åç²¾çµä¼šå›åˆ°åŸç‚¹, å±å¹•çš„æ­£ä¸‹æ–¹</li>
<li>åŒå‡»æ¡Œå® : è®©è§’è‰²è½¬å‘</li>
</ul>
<h4 id="é€šçŸ¥åŒºåŸŸå›¾æ ‡"><a href="#é€šçŸ¥åŒºåŸŸå›¾æ ‡" class="headerlink" title="é€šçŸ¥åŒºåŸŸå›¾æ ‡"></a>é€šçŸ¥åŒºåŸŸå›¾æ ‡</h4><ul>
<li>å³é”®å•å‡»: æ˜¾ç¤ºå³é”®èœå•</li>
<li>å·¦é”®åŒå‡»: æ˜¾ç¤ºæ¡Œå® </li>
</ul>
<h2 id="ä¸€äº›å¼€å‘ç»†èŠ‚"><a href="#ä¸€äº›å¼€å‘ç»†èŠ‚" class="headerlink" title="ä¸€äº›å¼€å‘ç»†èŠ‚"></a>ä¸€äº›å¼€å‘ç»†èŠ‚</h2><h3 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h3><ul>
<li><code>Win10+</code></li>
<li><code>Visual Studio 2022</code></li>
<li><code>C++14</code></li>
<li><a href="https://github.com/EsotericSoftware/spine-runtimes/tree/3.6"><code>spine-runtime</code></a></li>
<li><a href="https://github.com/open-source-parsers/jsoncpp"><code>jsoncpp</code></a></li>
</ul>
<p>å…¶ä¸­ <code>spine-runtime</code> å’Œ <code>jsoncpp</code> å‡æ˜¯ä»¥æºç æ–¹å¼å¼•å…¥å¹¶ç¼–è¯‘çš„, å†…éƒ¨æœ‰ä¸€äº›ç›¸åº”çš„é€‚é…æ€§ä¿®æ”¹.</p>
<p><code>spine-runtime</code> ç‰ˆæœ¬å›ºå®šäº†æ˜¯ <code>v3.6.53</code>, æ‰€ä»¥å‡ ä¹åªæ”¯æŒç¢§è“èˆªçº¿å¯¼å‡ºçš„å°äººèµ„æº.</p>
<h3 id="åŠ¨ç”»æ¸²æŸ“"><a href="#åŠ¨ç”»æ¸²æŸ“" class="headerlink" title="åŠ¨ç”»æ¸²æŸ“"></a>åŠ¨ç”»æ¸²æŸ“</h3><p>æ¡Œå® ä½¿ç”¨ 2D å›¾å½¢åº“ç»˜åˆ¶, å…·ä½“å®ç°åŸç†å‚è€ƒ <span class="exturl" data-url="aHR0cDovL3poLmVzb3Rlcmljc29mdHdhcmUuY29tL3NwaW5lLWM=">spine-c è¿è¡Œæ—¶æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span>, æ ‡å‡†å®ç°éœ€è¦ä½¿ç”¨çº¹ç†æ˜ å°„ç­‰è®¡ç®—æœºå›¾å½¢å­¦æ“ä½œ<del>ä½†æ˜¯æˆ‘ä¸ä¼š</del>, æ‰€ä»¥çº¹ç†æ˜ å°„æ˜¯é€šè¿‡ 2D åº“çš„çº¹ç†ç¬”åˆ·æ¥å®ç°çš„.</p>
<p>åˆ›å»ºçº¹ç†ç¬”åˆ·ä¹‹å, åœ¨ç»˜åˆ¶é¡¶ç‚¹ä¸‰è§’å½¢æ—¶, éœ€è¦è‡ªå·±æ‰‹åŠ¨è®¡ç®—çº¹ç†åˆ°æ¨¡å‹çš„ä»¿å°„çŸ©é˜µ, ç„¶åè®¾ç½®ç¬”åˆ·çš„å˜æ¢çŸ©é˜µ, å°±èƒ½å®Œæˆçº¹ç†æ˜ å°„. å…³é”®å‡½æ•°æ˜¯è¿™ä¸ª <code>GetAffineMatrix</code>:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GetAffineMatrix</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">float</span> x1, <span class="type">float</span> y1, <span class="type">float</span> x2, <span class="type">float</span> y2, <span class="type">float</span> x3, <span class="type">float</span> y3, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">float</span> u1, <span class="type">float</span> v1, <span class="type">float</span> u2, <span class="type">float</span> v2, <span class="type">float</span> u3, <span class="type">float</span> v3, </span></span></span><br><span class="line"><span class="params"><span class="function">    Matrix* m</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>èƒ½å¤Ÿè®¡ç®—ä¸¤ä¸ªå¹³é¢ä¸‰è§’å½¢ <code>UV</code> åˆ° <code>XY</code> çš„ä»¿å°„çŸ©é˜µ. ä¸æ¸²æŸ“æœ‰å…³çš„è¯¦ç»†å®ç°è§ <a href="https://github.com/ww-rm/DesktopSprite/blob/main/DesktopSprite/src/ds/spinechar.cpp"><code>spinechar.cpp</code></a>.</p>
<h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><h3 id="å…³äºé…ç½®æ–‡ä»¶"><a href="#å…³äºé…ç½®æ–‡ä»¶" class="headerlink" title="å…³äºé…ç½®æ–‡ä»¶"></a>å…³äºé…ç½®æ–‡ä»¶</h3><p>âš ï¸ä¸å»ºè®®ç›´æ¥æ“ä½œé…ç½®æ–‡ä»¶! âš ï¸</p>
<p>âš ï¸ä¸å»ºè®®ç›´æ¥æ“ä½œé…ç½®æ–‡ä»¶! âš ï¸</p>
<p>âš ï¸ä¸å»ºè®®ç›´æ¥æ“ä½œé…ç½®æ–‡ä»¶! âš ï¸</p>
<p>ç‚¹å‡» &quot;æ‰“å¼€æ•°æ®æ–‡ä»¶å¤¹&quot; å, å¯ä»¥çœ‹åˆ°æ•°æ®æ–‡ä»¶å¤¹é‡Œæœ‰ä¸€ä»½ <code>config.json</code>, é‡Œé¢ä»¥ <code>json</code> æ ¼å¼å­˜å‚¨äº†æ‰€æœ‰çš„è®¾ç½®é¢æ¿å¯è§çš„é…ç½®ä¿¡æ¯.</p>
<h3 id="ä½¿ç”¨ä¸Šçš„é—®é¢˜"><a href="#ä½¿ç”¨ä¸Šçš„é—®é¢˜" class="headerlink" title="ä½¿ç”¨ä¸Šçš„é—®é¢˜"></a>ä½¿ç”¨ä¸Šçš„é—®é¢˜</h3><ul>
<li>ä¸å»ºè®®å¸§ç‡è°ƒå¤ªé«˜, ä¼šä½¿ç”µè„‘è€—ç”µæ˜¾è‘—å¢åŠ , æˆ–è€…é£æ‰‡æŠ½é£</li>
<li>å¦‚æœä¸æ…å‡ºäº†ä¸€äº›å’Œé…ç½®æœ‰å…³çš„é—®é¢˜, æ¯”å¦‚è®¾ç½®äº†é”™è¯¯çš„å†…å®¹å¯¼è‡´ç¨‹åºå´©äº†/æ‰“ä¸å¼€, ç›´æ¥æ‰“å¼€æ•°æ®æ–‡ä»¶å¤¹, å…³é—­ç¨‹åºå¹¶åˆ é™¤ <code>config.json</code> åé‡å¯ç¨‹åº, å³å¯è®©ç¨‹åºä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ</li>
</ul>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p>æ­¤å¤„é™„ä¸€ä¸‹è‡ªå·±å¯¼å‡ºçš„è§’è‰²å°äººèµ„æº, ä¸ä¸€å®šåŒ…å«æœ€æ–°è§’è‰², <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0F6dXJMYW5lU0Q=">AzurLaneSD<i class="fa fa-external-link-alt"></i></span>.</p>
<p>å¦‚æœæ— æ³•ä¸‹è½½åˆ™å¯ä»¥è¯•ä¸€ä¸‹ä¸‹é¢çš„é“¾æ¥:</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMXRTYUJ6WlRXQ3l2Y3JnYkdoX21ncmc/cHdkPWJsaHg=">å•è§’è‰²ä¸‹è½½<i class="fa fa-external-link-alt"></i></span>, æå–ç : <code>blhx</code>.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMXFwWm5KUkI0UGFDOUViM3RrWmRBQ3c/cHdkPWJsaHg=">å…¨è§’è‰²ä¸‹è½½<i class="fa fa-external-link-alt"></i></span>, æå–ç : <code>blhx</code>.</li>
</ul>
<p>å¦‚æœ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Rlc2t0b3BTcHJpdGUvcmVsZWFzZXM=">Release<i class="fa fa-external-link-alt"></i></span> ç•Œé¢è¿›ä¸å» (å¯èƒ½éœ€è¦é­”æ³•æ‰èƒ½è®¿é—®), è¿™é‡Œè´´ä¸€ä¸‹ç¨‹åºçš„ç½‘ç›˜é“¾æ¥.</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMXZERnIwS1lSa25EakdESDFIYUVYNmc/cHdkPWJsaHg=">å®‰è£…åŒ… - ç™¾åº¦ç½‘ç›˜<i class="fa fa-external-link-alt"></i></span>, æå–ç : <code>blhx</code>.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMVR4c3ZIYmsyVFZqbHZ2OUx2LUM3eWc/cHdkPWJsaHg=">å…å®‰è£… - ç™¾åº¦ç½‘ç›˜<i class="fa fa-external-link-alt"></i></span>, æå–ç : <code>blhx</code>.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9peUtXZTE3NGNycmU=">å®‰è£…åŒ… - è“å¥äº‘<i class="fa fa-external-link-alt"></i></span>.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pRlVNTDE3NGNybGk=">å…å®‰è£… - è“å¥äº‘<i class="fa fa-external-link-alt"></i></span>.</li>
</ul>
]]></content>
      <categories>
        <category>ä¸ªäººé¡¹ç›®</category>
      </categories>
      <tags>
        <tag>ç¢§è“èˆªçº¿</tag>
        <tag>æ¡Œå® </tag>
        <tag>Spine</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯¹è¯æƒ…ç»ªæ£€æµ‹</title>
    <url>//posts/2021/09/11/emodetection/</url>
    <content><![CDATA[<p>æœ¬ç¯‡æ˜¯å¤§ä¸‰æ—¶è‡ªç„¶è¯­è¨€å¤„ç†è¯¾ç¨‹çš„å¤§ä½œä¸š, é¢˜ç›®é€‰äº† &quot;å¯¹è¯æƒ…ç»ªæ£€æµ‹&quot; (Emotion Detection in Conversations), ç›®æ ‡æ˜¯å¯¹å¯¹è¯ä¸­çš„æ¯ä¸ªå¥å­è¿›è¡Œæƒ…ç»ªçš„åˆ†ç±»ï¼Œä»¥æ­¤æ¥è¯†åˆ«è¯´è¯è€…å½“æ—¶çš„æƒ…ç»ª.</p>
<p>æœ¬æ–‡æ•´ç†ä¸€ä¸‹è‡ªå·±çš„è¯¾ç¨‹æŠ¥å‘Šå†…å®¹, å¹¶å°†ä»£ç æ•´ç†è‡³ Github ä¸Š, æ–‡æœ«é™„æœ‰é¡¹ç›®åœ°å€.</p>
<span id="more"></span>

<h2 id="è½¯ç¡¬ä»¶ç¯å¢ƒ"><a href="#è½¯ç¡¬ä»¶ç¯å¢ƒ" class="headerlink" title="è½¯ç¡¬ä»¶ç¯å¢ƒ"></a>è½¯ç¡¬ä»¶ç¯å¢ƒ</h2><p>è½¯ä»¶: <code>python 3.7</code>, <code>pytorch 1.6.0</code>, <code>pytorch-nlp</code></p>
<p>ç¡¬ä»¶: <code>GeForce RTX 2080 Ti</code></p>
<h2 id="æ•°æ®é›†"><a href="#æ•°æ®é›†" class="headerlink" title="æ•°æ®é›†"></a>æ•°æ®é›†</h2><p>ä½¿ç”¨çš„æ•°æ®é›†ä¸º <span class="exturl" data-url="aHR0cDovL3lhbnJhbi5saS9kYWlseWRpYWxvZw==">DailyDialog<i class="fa fa-external-link-alt"></i></span> å¯¹è¯æ•°æ®é›†, åœ¨è¿™é‡Œæˆ‘ä»¬åªç”¨åˆ°å¯¹è¯æ–‡æœ¬æ•°æ®å’Œæƒ…ç»ªæ ‡ç­¾æ–‡ä»¶.</p>
<p>å¯¹è¯æ•°æ®ä¸ºå¤šè¡Œæ–‡æœ¬, æ¯ä¸€è¡Œæ˜¯ä¸€æ®µå¯¹è¯, æ¯ä¸€å¥è¯ç”¨ <code>__eou__</code> ä½œä¸ºç»“æŸç¬¦. æ¯ä¸€æ®µå¯¹è¯åªæœ‰ä¸¤ä¸ªè¯´è¯äºº, ä¸”äº¤æ›¿å‡ºç°.</p>
<p>åœ¨æ ‡ç­¾æ–‡ä»¶ä¸­, æ¯ä¸€è¡Œä¸å¯¹è¯æ•°æ®ä¸€ä¸€å¯¹åº”, ä½†æ˜¯æ¯å¥è¯æ¢æˆæ ‡ç­¾å€¼, å–å€¼èŒƒå›´ 0-6, å…±7ç§ä¸åŒçš„æƒ…ç»ªç±»åˆ«.</p>
<h2 id="ç½‘ç»œæ¨¡å‹"><a href="#ç½‘ç»œæ¨¡å‹" class="headerlink" title="ç½‘ç»œæ¨¡å‹"></a>ç½‘ç»œæ¨¡å‹</h2><p>æ¨¡å‹è®¾è®¡ä¸»è¦å‚è€ƒè®ºæ–‡: <span class="exturl" data-url="aHR0cHM6Ly9kb2kub3JnLzEwLjE2MDkvYWFhaS52MzNpMDEuMzMwMTY4MTg=">DialogueRNN: An Attentive RNN for Emotion Detection in Conversations<i class="fa fa-external-link-alt"></i></span>.</p>
<p>æ•´ä¸ªç½‘ç»œå¤§è‡´åˆ†ä¸ºç‰¹å¾æå–å’Œæƒ…ç»ªåˆ†ç±»ä¸¤éƒ¨åˆ†.</p>
<h3 id="ç‰¹å¾æå–"><a href="#ç‰¹å¾æå–" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h3><p>é¦–å…ˆæ˜¯æ–‡æœ¬çš„åµŒå…¥è¡¨ç¤º, ä½¿ç”¨ <code>GloVe</code> é¢„è®­ç»ƒè¯å‘é‡æ¥è½¬æ¢åŸå§‹æ–‡æœ¬, è¯å‘é‡ç»´åº¦å¤§å°ä¸º 300.</p>
<p>åœ¨ä½¿ç”¨é¢„è®­ç»ƒè¯å‘é‡ä¹‹å, å¯¹äºæ¯æ®µå¯¹è¯ä¸­çš„æ¯ä¸ªå‘è¨€, é‡‡ç”¨ <code>BiLSTM</code> è¿›è¡Œè¯­ä¹‰æå–, å–æ­£å‘å’Œåå‘çš„æœ€åæ—¶åˆ»è¾“å‡ºæ‹¼æ¥åœ¨ä¸€èµ·, æœ€ç»ˆå°†æ¯å¥è¯è½¬æ¢ä¸ºç­‰é•¿å‘é‡.</p>
<h3 id="æƒ…ç»ªæ£€æµ‹"><a href="#æƒ…ç»ªæ£€æµ‹" class="headerlink" title="æƒ…ç»ªæ£€æµ‹"></a>æƒ…ç»ªæ£€æµ‹</h3><p>è¿™ä¸€éƒ¨åˆ†å­˜åœ¨ 4 ä¸ªçŠ¶æ€å˜é‡:</p>
<ul>
<li>å…¨å±€ä¸Šä¸‹æ–‡ä¿¡æ¯: ç”¨äºè®°å½•å½“å‰å¯¹è¯çš„è¿›è¡Œä½ç½®ä»¥åŠå¯¹è¯çš„æ•´ä¸ªå†å²ä¿¡æ¯.</li>
<li>ä¸¤ä¸ªè¯´è¯äººçŠ¶æ€: ç”¨äºè®°å½•æ¯ä¸ªè¯´è¯äººåœ¨æœ€æ–°å‘è¨€ä¹‹å‰çš„çŠ¶æ€.</li>
<li>æƒ…ç»ªçŠ¶æ€: ç”¨äºè®°å½•æœ€è¿‘ä¸€æ¬¡å‘è¨€çš„æƒ…ç»ªçŠ¶æ€, ç”¨äºè¾“å‡ºæ¯å¥è¯çš„æƒ…ç»ªå‘é‡è¡¨è¾¾.</li>
</ul>
<p>æ•´ä¸ªç»“æ„å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤º:</p>
<p><img data-src="/static/image/emodetection/detection_model.jpg" alt="detection_model"></p>
<p>å…¶ä¸­ $U_t$ å°±æ˜¯æ¯ä¸€å¥è¯, $t$ ä»£è¡¨æ—¶åˆ».</p>
<p>æ³¨æ„åŠ›ç»“æ„ä½¿ç”¨äº†ç®€å•çš„ä¹˜æ€§æ³¨æ„åŠ›, å…·ä½“å¯ä»¥çœ‹ä»£ç , å°±æ˜¯æ±‚ç‚¹ç§¯ç„¶å softmax.</p>
<p>æœ€åå°†æ¯ä¸ªå¥å­å¯¹åº”çš„ $E_t$ æ”¾è¿›çº¿æ€§å±‚è¿›è¡Œåˆ†ç±».</p>
<h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p>æœ€ç»ˆçš„è®­ç»ƒå‚æ•°å¦‚ä¸‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Namespace(</span><br><span class="line">   batch_size=<span class="number">16</span>, </span><br><span class="line">   embedding_size=<span class="number">300</span>, </span><br><span class="line">   lstm_size=<span class="number">256</span>, </span><br><span class="line">   hidden_size=<span class="number">256</span>, </span><br><span class="line">   learning_rate=<span class="number">0.001</span>, </span><br><span class="line">   epochs=<span class="number">50</span>, </span><br><span class="line">   seed=<span class="number">1</span>, </span><br><span class="line">   istrain=<span class="literal">True</span>, </span><br><span class="line">   dev_data_path=<span class="string">&#x27;./data/Emotion Detection in Conversations/validation/dialogues_validation.txt&#x27;</span>, </span><br><span class="line">   dev_label_path=<span class="string">&#x27;./data/Emotion Detection in Conversations/validation/dialogues_emotion_validation.txt&#x27;</span>, </span><br><span class="line">   model_save_path=<span class="string">&#x27;attn.pt&#x27;</span>, </span><br><span class="line">   test_data_path=<span class="string">&#x27;./data/Emotion Detection in Conversations/test/dialogues_test.txt&#x27;</span>, </span><br><span class="line">   test_label_path=<span class="string">&#x27;./data/Emotion Detection in Conversations/test/dialogues_emotion_test.txt&#x27;</span>, </span><br><span class="line">   train_data_path=<span class="string">&#x27;./data/Emotion Detection in Conversations/train/dialogues_train.txt&#x27;</span>, </span><br><span class="line">   train_label_path=<span class="string">&#x27;./data/Emotion Detection in Conversations/train/dialogues_emotion_train.txt&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>åœ¨æµ‹è¯•é›†ä¸Šçš„ç»“æœå¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0       0.91      0.91      0.91      6321</span><br><span class="line">           1       0.43      0.25      0.31       118</span><br><span class="line">           2       0.46      0.23      0.31        47</span><br><span class="line">           3       0.71      0.29      0.42        17</span><br><span class="line">           4       0.60      0.62      0.61      1019</span><br><span class="line">           5       0.28      0.27      0.28       102</span><br><span class="line">           6       0.48      0.43      0.45       116</span><br><span class="line"></span><br><span class="line">    accuracy                           0.84      7740</span><br><span class="line">   macro avg       0.55      0.43      0.47      7740</span><br><span class="line">weighted avg       0.84      0.84      0.84      7740</span><br></pre></td></tr></table></figure>

<p>å’‹è¯´å‘¢, è°ƒè¿‡å¾ˆå¤šå‚æ•°äº†, ä½†æ˜¯æ•ˆæœéƒ½ä¸æ˜¯å¾ˆå¥½, ä¸ªäººæ„Ÿè§‰æ˜¯æ•°æ®é›†å¤ªå°äº†, æ ·æœ¬æ•°ä¸å¤Ÿ, æˆ–è€…æ˜¯ç‚¼ä¸¹æ‰‹æ³•ä¸è¡Œ, æœ‰å“ªé‡Œä¸å¯¹, çœ‹äººå®¶è®ºæ–‡é‡Œä¹Ÿä¸æ˜¯ç‰¹åˆ«é«˜å°±æ˜¯äº†. <del>æ•™è¾…è¯´å¯èƒ½å°±æ˜¯è¿™ä¸ªä»»åŠ¡ä¸é€‚åˆæ·±åº¦å­¦ä¹ , ä½†æ˜¯æˆ‘è§‰å¾—æ•°æ®é‡ç®¡å¤Ÿå•¥éƒ½èƒ½æ·±åº¦å­¦ä¹ .</del></p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä½œä¸ºä¸€ä¸ªç»“è¯¾ä½œä¸šé¡¹ç›®, æ²¡æœ‰å¤ªå¤šåˆ›æ–°ä¹‹å¤„, åªæ˜¯å¤ç°äº†ä¸€ä¸‹è®ºæ–‡é‡Œçš„æ¨¡å‹ç»“æ„, ç„¶ååœ¨ä¸åŒçš„æ•°æ®é›†ä¸Šåšäº†å®éªŒ, æ•ˆæœè¯´ä¸ä¸Šå¤šå¥½.</p>
<p>ä¸»è¦æ”¶è·å°±æ˜¯å¢å¼ºåŠ¨æ‰‹èƒ½åŠ›å§, æ¯•ç«Ÿæ˜¯çº¯æ‰‹æ“çš„ç½‘ç»œä»£ç , è®©è‡ªå·±èƒ½æ›´åŠ ç†Ÿæ‚‰ä¸€äº›åŸºç¡€ç½‘ç»œç»“æ„å’Œ <code>pytorch</code> æ¡†æ¶çš„ä½¿ç”¨æ–¹æ³•.</p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p>é¡¹ç›®åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Vtb3Rpb24tRGV0ZWN0aW9uLWluLUNvbnZlcnNhdGlvbnM=">Emotion Detection in Conversations<i class="fa fa-external-link-alt"></i></span></p>
<p>å‚è€ƒè®ºæ–‡: <span class="exturl" data-url="aHR0cHM6Ly9kb2kub3JnLzEwLjE2MDkvYWFhaS52MzNpMDEuMzMwMTY4MTg=">DialogueRNN: An Attentive RNN for Emotion Detection in Conversations<i class="fa fa-external-link-alt"></i></span></p>
<p>æ•°æ®é›†åœ°å€: <span class="exturl" data-url="aHR0cDovL3lhbnJhbi5saS9kYWlseWRpYWxvZw==">DailyDialog<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>ä¸ªäººé¡¹ç›®</category>
      </categories>
      <tags>
        <tag>æƒ…ç»ªæ£€æµ‹</tag>
        <tag>nlp</tag>
        <tag>è‡ªç„¶è¯­è¨€å¤„ç†</tag>
      </tags>
  </entry>
  <entry>
    <title>å›½å¯†ç®—æ³•çš„çº¯ Python å®ç°</title>
    <url>//posts/2023/12/14/gmalg/</url>
    <content><![CDATA[<p>è¿‘æœŸèŠ±äº†ç‚¹æ—¶é—´å­¦ä¹ å›½å¯†ç®—æ³•, å¹¶ä¸”æŒ‰å›½æ ‡æ–‡æ¡£ç”¨çº¯ Python å®ç°äº†ä¸€ä¸ªå°çš„å›½å¯†ç®—æ³•åº“, è¿™é‡Œè´´ä¸€ä¸‹é¡¹ç›®çš„ç®€ä»‹å’Œç”¨æ³•.</p>
<p>Github åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL2dtYWxn">https://github.com/ww-rm/gmalg<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight bat"><table><tr><td class="code"><pre><span class="line">pip install gmalg</span><br></pre></td></tr></table></figure>

<h2 id="å®ç°çš„æ ¸å¿ƒç®—æ³•"><a href="#å®ç°çš„æ ¸å¿ƒç®—æ³•" class="headerlink" title="å®ç°çš„æ ¸å¿ƒç®—æ³•"></a>å®ç°çš„æ ¸å¿ƒç®—æ³•</h2><ul>
<li>ç¥–å†²ä¹‹åºåˆ—å¯†ç ç®—æ³•</li>
<li>SM2 æ¤­åœ†æ›²çº¿å…¬é’¥å¯†ç ç®—æ³•<ul>
<li>ç­¾åéªŒç­¾</li>
<li>å¯†é’¥äº¤æ¢</li>
<li>åŠ å¯†è§£å¯†</li>
</ul>
</li>
<li>SM3 å¯†ç æ‚å‡‘ç®—æ³•</li>
<li>SM4 åˆ†ç»„å¯†ç ç®—æ³•</li>
<li>SM9 æ ‡è¯†å¯†ç ç®—æ³•<ul>
<li>ç­¾åéªŒç­¾</li>
<li>å¯†é’¥äº¤æ¢</li>
<li>å¯†é’¥å°è£…</li>
<li>åŠ å¯†è§£å¯†</li>
</ul>
</li>
</ul>
<h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><h3 id="ZUC-ç”Ÿæˆä¼ªéšæœºå¯†é’¥æµ"><a href="#ZUC-ç”Ÿæˆä¼ªéšæœºå¯†é’¥æµ" class="headerlink" title="ZUC ç”Ÿæˆä¼ªéšæœºå¯†é’¥æµ"></a>ZUC ç”Ÿæˆä¼ªéšæœºå¯†é’¥æµ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">zuc = gmalg.ZUC(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;3d4c4be96a82fdaeb58f641db17b455b&quot;</span>),</span><br><span class="line">                <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;84319aa8de6915ca1f6bda6bfbd8c766&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(zuc.generate().<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(zuc.generate().<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<h3 id="SM3-è®¡ç®—å“ˆå¸Œå€¼"><a href="#SM3-è®¡ç®—å“ˆå¸Œå€¼" class="headerlink" title="SM3 è®¡ç®—å“ˆå¸Œå€¼"></a>SM3 è®¡ç®—å“ˆå¸Œå€¼</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">sm3 = gmalg.SM3()</span><br><span class="line"><span class="built_in">print</span>(sm3.value().<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">sm3.update(<span class="string">b&quot;I&#x27;m SM3 algorithm.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(sm3.value().<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<h3 id="SM4-åŠ å¯†-è§£å¯†"><a href="#SM4-åŠ å¯†-è§£å¯†" class="headerlink" title="SM4 åŠ å¯†/è§£å¯†"></a>SM4 åŠ å¯†/è§£å¯†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">sm4 = gmalg.SM4(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0123456789ABCDEFFEDCBA9876543210&quot;</span>))</span><br><span class="line">cipher = sm4.encrypt(<span class="string">b&quot;0102030405060708&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(cipher.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(sm4.decrypt(cipher))</span><br></pre></td></tr></table></figure>

<h3 id="SM2-ç­¾å-éªŒç­¾"><a href="#SM2-ç­¾å-éªŒç­¾" class="headerlink" title="SM2 ç­¾å/éªŒç­¾"></a>SM2 ç­¾å/éªŒç­¾</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">sm2 = gmalg.SM2(</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;3945208F 7B2144B1 3F36E38A C6D39F95 88939369 2860B51A 42FB81EF 4DF7C5B8&quot;</span>),</span><br><span class="line">    <span class="string">b&quot;1234567812345678&quot;</span>,</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04 09F9DF31 1E5421A1 50DD7D16 1E4BC5C6 72179FAD 1833FC07 6BB08FF3 56F35020&quot;</span></span><br><span class="line">                  <span class="string">&quot;CCEA490C E26775A5 2DC6EA71 8CC1AA60 0AED05FB F35E084A 6632F607 2DA9AD13&quot;</span>),</span><br><span class="line">)</span><br><span class="line">msg = <span class="string">b&quot;I&#x27;m SM2 sign/verify algorithm.&quot;</span></span><br><span class="line">r, s = sm2.sign(msg)</span><br><span class="line"><span class="built_in">print</span>(r.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(s.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(sm2.verify(msg, r, s))</span><br></pre></td></tr></table></figure>

<h3 id="SM2-åŠ å¯†-è§£å¯†"><a href="#SM2-åŠ å¯†-è§£å¯†" class="headerlink" title="SM2 åŠ å¯†/è§£å¯†"></a>SM2 åŠ å¯†/è§£å¯†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">sm2 = gmalg.SM2(</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;3945208F 7B2144B1 3F36E38A C6D39F95 88939369 2860B51A 42FB81EF 4DF7C5B8&quot;</span>),</span><br><span class="line">    P=<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04 09F9DF31 1E5421A1 50DD7D16 1E4BC5C6 72179FAD 1833FC07 6BB08FF3 56F35020&quot;</span></span><br><span class="line">                    <span class="string">&quot;CCEA490C E26775A5 2DC6EA71 8CC1AA60 0AED05FB F35E084A 6632F607 2DA9AD13&quot;</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">cipher = sm2.encrypt(<span class="string">b&quot;I&#x27;m SM2 encrypt/decrypt algorithm.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(cipher.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(sm2.decrypt(cipher))</span><br></pre></td></tr></table></figure>

<h3 id="SM2-å¯†é’¥äº¤æ¢"><a href="#SM2-å¯†é’¥äº¤æ¢" class="headerlink" title="SM2 å¯†é’¥äº¤æ¢"></a>SM2 å¯†é’¥äº¤æ¢</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">PA = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04 160E1289 7DF4EDB6 1DD812FE B96748FB D3CCF4FF E26AA6F6 DB9540AF 49C94232&quot;</span></span><br><span class="line">                   <span class="string">&quot;4A7DAD08 BB9A4595 31694BEB 20AA489D 6649975E 1BFCF8C4 741B78B4 B223007F&quot;</span>)</span><br><span class="line">sm2A = gmalg.SM2(</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;81EB26E9 41BB5AF1 6DF11649 5F906952 72AE2CD6 3D6C4AE1 678418BE 48230029&quot;</span>),</span><br><span class="line">    <span class="string">b&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>, PA</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">PB = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04 6AE848C5 7C53C7B1 B5FA99EB 2286AF07 8BA64C64 591B8B56 6F7357D5 76F16DFB&quot;</span></span><br><span class="line">                   <span class="string">&quot;EE489D77 1621A27B 36C5C799 2062E9CD 09A92643 86F3FBEA 54DFF693 05621C4D&quot;</span>)</span><br><span class="line">sm2B = gmalg.SM2(</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;78512991 7D45A9EA 5437A593 56B82338 EAADDA6C EB199088 F14AE10D EFA229B5&quot;</span>),</span><br><span class="line">    <span class="string">b&quot;1234567812345678&quot;</span>, PB</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">RA, tA = sm2A.begin_key_exchange()</span><br><span class="line">RB, tB = sm2B.begin_key_exchange()</span><br><span class="line"></span><br><span class="line">KB = sm2B.end_key_exchange(<span class="number">16</span>, tB, RA, <span class="string">b&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>, PA, gmalg.KEYXCHG_MODE.RESPONDER)</span><br><span class="line">KA = sm2A.end_key_exchange(<span class="number">16</span>, tA, RB, <span class="string">b&quot;1234567812345678&quot;</span>, PB, gmalg.KEYXCHG_MODE.INITIATOR)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(KA == KB)</span><br><span class="line"><span class="built_in">print</span>(KA.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<h3 id="SM9-ç­¾å-éªŒç­¾"><a href="#SM9-ç­¾å-éªŒç­¾" class="headerlink" title="SM9 ç­¾å/éªŒç­¾"></a>SM9 ç­¾å/éªŒç­¾</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">hid_s = <span class="string">b&quot;\x01&quot;</span></span><br><span class="line">msk_s = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0130E7 8459D785 45CB54C5 87E02CF4 80CE0B66 340F319F 348A1D5B 1F2DC5F4&quot;</span>)</span><br><span class="line">mpk_s = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04&quot;</span></span><br><span class="line">                      <span class="string">&quot;9F64080B 3084F733 E48AFF4B 41B56501 1CE0711C 5E392CFB 0AB1B679 1B94C408&quot;</span></span><br><span class="line">                      <span class="string">&quot;29DBA116 152D1F78 6CE843ED 24A3B573 414D2177 386A92DD 8F14D656 96EA5E32&quot;</span></span><br><span class="line">                      <span class="string">&quot;69850938 ABEA0112 B57329F4 47E3A0CB AD3E2FDB 1A77F335 E89E1408 D0EF1C25&quot;</span></span><br><span class="line">                      <span class="string">&quot;41E00A53 DDA532DA 1A7CE027 B7A46F74 1006E85F 5CDFF073 0E75C05F B4E3216D&quot;</span>)</span><br><span class="line">kgc = gmalg.SM9KGC(hid_s=hid_s, msk_s=msk_s, mpk_s=mpk_s)</span><br><span class="line"></span><br><span class="line">uid = <span class="string">b&quot;Alice&quot;</span></span><br><span class="line">sk_s = kgc.generate_sk_sign(uid)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sk_s.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">sm9 = gmalg.SM9(hid_s=hid_s, mpk_s=mpk_s, sk_s=sk_s, uid=uid)</span><br><span class="line"></span><br><span class="line">message = <span class="string">b&quot;Chinese IBS standard&quot;</span></span><br><span class="line">h, S = sm9.sign(message)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(h.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(S.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sm9.verify(message, h, S))</span><br></pre></td></tr></table></figure>

<h3 id="SM9-å¯†é’¥äº¤æ¢"><a href="#SM9-å¯†é’¥äº¤æ¢" class="headerlink" title="SM9 å¯†é’¥äº¤æ¢"></a>SM9 å¯†é’¥äº¤æ¢</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">hid_e = <span class="string">b&quot;\x02&quot;</span></span><br><span class="line">msk_e = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;02E65B 0762D042 F51F0D23 542B13ED 8CFA2E9A 0E720636 1E013A28 3905E31F&quot;</span>)</span><br><span class="line">mpk_e = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04&quot;</span></span><br><span class="line">                      <span class="string">&quot;91745426 68E8F14A B273C094 5C3690C6 6E5DD096 78B86F73 4C435056 7ED06283&quot;</span></span><br><span class="line">                      <span class="string">&quot;54E598C6 BF749A3D ACC9FFFE DD9DB686 6C50457C FC7AA2A4 AD65C316 8FF74210&quot;</span>)</span><br><span class="line">kgc = gmalg.SM9KGC(hid_e=hid_e, msk_e=msk_e, mpk_e=mpk_e)</span><br><span class="line"></span><br><span class="line">uid_A = <span class="string">b&quot;Alice&quot;</span></span><br><span class="line">sk_e_A = kgc.generate_sk_encrypt(uid_A)</span><br><span class="line"><span class="built_in">print</span>(sk_e_A.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">uid_B = <span class="string">b&quot;Bob&quot;</span></span><br><span class="line">sk_e_B = kgc.generate_sk_encrypt(uid_B)</span><br><span class="line"><span class="built_in">print</span>(sk_e_B.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">sm9_A = gmalg.SM9(hid_e=hid_e, mpk_e=mpk_e, sk_e=sk_e_A, uid=uid_A)</span><br><span class="line">sm9_B = gmalg.SM9(hid_e=hid_e, mpk_e=mpk_e, sk_e=sk_e_B, uid=uid_B)</span><br><span class="line"></span><br><span class="line">rA, RA = sm9_A.begin_key_exchange(uid_B)</span><br><span class="line">rB, RB = sm9_B.begin_key_exchange(uid_A)</span><br><span class="line"></span><br><span class="line">KB = sm9_B.end_key_exchange(<span class="number">16</span>, rB, RB, uid_A, RA, gmalg.KEYXCHG_MODE.RESPONDER)</span><br><span class="line">KA = sm9_A.end_key_exchange(<span class="number">16</span>, rA, RA, uid_B, RB, gmalg.KEYXCHG_MODE.INITIATOR)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(KA == KB)</span><br><span class="line"><span class="built_in">print</span>(KA.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<h3 id="SM9-å¯†é’¥å°è£…"><a href="#SM9-å¯†é’¥å°è£…" class="headerlink" title="SM9 å¯†é’¥å°è£…"></a>SM9 å¯†é’¥å°è£…</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">hid_e = <span class="string">b&quot;\x03&quot;</span></span><br><span class="line">msk_e = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;01EDEE 3778F441 F8DEA3D9 FA0ACC4E 07EE36C9 3F9A0861 8AF4AD85 CEDE1C22&quot;</span>)</span><br><span class="line">mpk_e = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04&quot;</span></span><br><span class="line">                      <span class="string">&quot;787ED7B8 A51F3AB8 4E0A6600 3F32DA5C 720B17EC A7137D39 ABC66E3C 80A892FF&quot;</span></span><br><span class="line">                      <span class="string">&quot;769DE617 91E5ADC4 B9FF85A3 1354900B 20287127 9A8C49DC 3F220F64 4C57A7B1&quot;</span>)</span><br><span class="line">kgc = gmalg.SM9KGC(hid_e=hid_e, msk_e=msk_e, mpk_e=mpk_e)</span><br><span class="line"></span><br><span class="line">uid = <span class="string">b&quot;Bob&quot;</span></span><br><span class="line"></span><br><span class="line">sk_e = kgc.generate_sk_encrypt(uid)</span><br><span class="line"><span class="built_in">print</span>(sk_e.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">sm9 = gmalg.SM9(hid_e=hid_e, mpk_e=mpk_e, sk_e=sk_e, uid=uid)</span><br><span class="line"></span><br><span class="line">K, C = sm9.encapsulate(<span class="number">32</span>, uid)  <span class="comment"># encapsulate key to self</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(K.<span class="built_in">hex</span>())</span><br><span class="line"><span class="built_in">print</span>(C.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sm9.decapsulate(C, <span class="number">32</span>) == K)</span><br></pre></td></tr></table></figure>

<h3 id="SM9-åŠ å¯†-è§£å¯†"><a href="#SM9-åŠ å¯†-è§£å¯†" class="headerlink" title="SM9 åŠ å¯†/è§£å¯†"></a>SM9 åŠ å¯†/è§£å¯†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"></span><br><span class="line">hid_e = <span class="string">b&quot;\x03&quot;</span></span><br><span class="line">msk_e = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;01EDEE 3778F441 F8DEA3D9 FA0ACC4E 07EE36C9 3F9A0861 8AF4AD85 CEDE1C22&quot;</span>)</span><br><span class="line">mpk_e = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;04&quot;</span></span><br><span class="line">                      <span class="string">&quot;787ED7B8 A51F3AB8 4E0A6600 3F32DA5C 720B17EC A7137D39 ABC66E3C 80A892FF&quot;</span></span><br><span class="line">                      <span class="string">&quot;769DE617 91E5ADC4 B9FF85A3 1354900B 20287127 9A8C49DC 3F220F64 4C57A7B1&quot;</span>)</span><br><span class="line">kgc = gmalg.SM9KGC(hid_e=hid_e, msk_e=msk_e, mpk_e=mpk_e)</span><br><span class="line"></span><br><span class="line">uid = <span class="string">b&quot;Bob&quot;</span></span><br><span class="line"></span><br><span class="line">sk_e = kgc.generate_sk_encrypt(uid)</span><br><span class="line"><span class="built_in">print</span>(sk_e.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line">sm9 = gmalg.SM9(hid_e=hid_e, mpk_e=mpk_e, sk_e=sk_e, uid=uid)</span><br><span class="line"></span><br><span class="line">plain = <span class="string">b&quot;Chinese IBE standard&quot;</span></span><br><span class="line">cipher = sm9.encrypt(plain, uid)  <span class="comment"># encrypt data to self</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(cipher.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sm9.decrypt(cipher))</span><br></pre></td></tr></table></figure>

<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å…¶å®å¤§éƒ¨åˆ†ç®—æ³•ä»¥å‰éƒ½æ¥è§¦è¿‡, å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•, ä½†æ˜¯ SM9 çœŸçš„æ˜¯ç¬¬ä¸€æ¬¡çœ‹, é‡Œé¢çš„æ•°å­¦åŸç†å•¥çš„ä¸€çªä¸é€š, å› æ­¤è€—è´¹äº†å¤§é‡æ—¶é—´, ä¸­é€”æœ‰å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯å¡åœ¨æ•°å­¦å…¬å¼ä¸Š, å¯¹æ–‡æ¡£çš„æè¿°ç†è§£æœ‰è¯¯, å¯¼è‡´è°ƒè¯•äº†åŠå¤©ä¹Ÿä¸å¯¹, ä¹‹åæ€»ç»“ä¸€ä¸‹åœ¨å®ç° SM9 ä¸­æ¶‰åŠçš„ä¸€äº›å…³é”®æ¦‚å¿µå’Œå‘ç‚¹.</p>
]]></content>
      <categories>
        <category>ä¸ªäººé¡¹ç›®</category>
      </categories>
      <tags>
        <tag>å›½å¯†</tag>
        <tag>SM2</tag>
        <tag>SM3</tag>
        <tag>SM4</tag>
        <tag>SM9</tag>
        <tag>ZUC</tag>
        <tag>gmalg</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ C# å†™ä¸€ä¸ªå“ˆå¸Œè®¡ç®—å°å·¥å…·</title>
    <url>//posts/2022/04/17/hashtool/</url>
    <content><![CDATA[<p>ä¹‹å‰ç”µè„‘ä¸Šæœ‰ä¸€ä¸ªç”¨æ¥è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼çš„è¿·ä½ å°å·¥å…·, å¸¦ç•Œé¢èƒ½ç›´æ¥æ‹–æ–‡ä»¶è®¡ç®—, æŒºæ–¹ä¾¿çš„. æ­£å¥½æœ€è¿‘é—²ç€äº†, äºæ˜¯æƒ³ç€è‡ªå·±ä»¿é€ ä¸€ä¸ªå·®ä¸å¤šçš„å°å·¥å…·, é¡ºä¾¿å†è¡¥å……ä¸€äº›ç¼ºå°‘çš„å“ˆå¸Œç®—æ³•è¿›å», åŒæ—¶ä¹Ÿèƒ½å…¥é—¨ä¸€ä¸‹ <code>C#</code> è¿™é—¨è¯­è¨€.</p>
<p>æ–‡æœ«é™„æœ‰ Github é¡¹ç›®åœ°å€.</p>
<span id="more"></span>

<h2 id="è¿è¡Œç¯å¢ƒ"><a href="#è¿è¡Œç¯å¢ƒ" class="headerlink" title="è¿è¡Œç¯å¢ƒ"></a>è¿è¡Œç¯å¢ƒ</h2><p>ç¯å¢ƒé€‰äº† <code>.NET Framework 4.6</code> åŠä»¥ä¸Š, ä¼°è®¡ç»å¤§éƒ¨åˆ† Windows ç³»ç»Ÿéƒ½å·²ç»è‡ªå¸¦äº†, èƒ½ç›´æ¥è¿è¡Œè½¯ä»¶.</p>
<h2 id="è½¯ä»¶åŠŸèƒ½"><a href="#è½¯ä»¶åŠŸèƒ½" class="headerlink" title="è½¯ä»¶åŠŸèƒ½"></a>è½¯ä»¶åŠŸèƒ½</h2><p>ç•Œé¢å¤§æ¦‚é•¿è¿™æ ·:</p>
<p><img data-src="/static/image/hashtool/hashtool.png" alt="hashtool.png"></p>
<p>æ”¯æŒä¸‹åˆ—ç®—æ³•:</p>
<ul>
<li>MD5</li>
<li>SHA1</li>
<li>SHA2-256</li>
<li>SHA2-512</li>
<li>SHA3-256</li>
<li>SHA3-512</li>
<li>SM3</li>
<li>CRC32</li>
</ul>
<p>æ”¯æŒä»¥ä¸‹åŠŸèƒ½:</p>
<ul>
<li>æ‹–åŠ¨æˆ–è€…ä½¿ç”¨æ‰“å¼€æŒ‰é’®å¯¹å¤šä¸ªæ–‡ä»¶è¿›è¡ŒæŒ‡å®šçš„å“ˆå¸Œå€¼è®¡ç®—</li>
<li>å®æ—¶æ˜¾ç¤ºå½“å‰æ–‡ä»¶è®¡ç®—è¿›åº¦ä¸æ€»ä»»åŠ¡è®¡ç®—è¿›åº¦</li>
<li>å¯ä»¥æŒ‡å®šè®¡ç®—æ–‡ä»¶å“ˆå¸Œæ—¶æ˜¯å¦å¯¹æ¯ä¸ªç®—æ³•ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹è¿›è¡ŒåŠ é€Ÿ</li>
</ul>
<h2 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h2><h3 id="çª—å£ç•Œé¢"><a href="#çª—å£ç•Œé¢" class="headerlink" title="çª—å£ç•Œé¢"></a>çª—å£ç•Œé¢</h3><p>è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡ç”¨ <code>C#</code> å†™çª—å£ç¨‹åº, å­¦ä¹ äº†ä¸€ä¸‹å†³å®šç”¨ <code>WinForms</code> è¿™ä¸ªæ¡†æ¶, å› ä¸ºä½œä¸ºå…¥é—¨ç¨‹åºæ¥è¯´, å®ƒè¶³å¤Ÿç®€å•, å®¹æ˜“ä¸Šæ‰‹.</p>
<p>VS æ–°å»ºä¸€ä¸ª WinForms é¡¹ç›®, é¡¹ç›®ç»“æ„ä¸å¤æ‚, æœ‰ä¸€ä¸ªä¸»ç¨‹åºæ–‡ä»¶å’ŒåŸºæœ¬çš„çª—å£æ–‡ä»¶, æˆ‘ä»¬çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯è¡¥å……çª—å£æ–‡ä»¶çš„ä»£ç .</p>
<p>æ€è·¯ä¹Ÿå¾ˆç®€å•, VS æä¾›äº†ç®€å•çš„çª—å£è®¾è®¡ç•Œé¢, èƒ½å¤Ÿç”¨é”®é¼ ç›´æ¥è®¾è®¡çª—å£å…ƒç´ å’Œçª—å£æ˜¾ç¤ºçš„å†…å®¹, ç„¶åæˆ‘ä»¬è‡ªå·±å†™å¯¹åº”çš„äº‹ä»¶å“åº”å‡½æ•°, å¹¶æŠŠå¯¹åº”çš„å‡½æ•°å’Œå“åº”äº‹ä»¶åœ¨è®¾è®¡çª—å£é‡Œç»‘å®šå³å¯.</p>
<p>è¿™é‡Œå°†ä¸»çª—å£ <code>MainWnd</code> çš„ä»£ç åˆ†ä½œäº†ä¸¤ä»½:</p>
<ul>
<li><code>MainWnd.cs</code>: å®ç°äº‹ä»¶å“åº”å‡½æ•°.</li>
<li><code>MainWnd.Func.cs</code>: å®ç°ä¸»çª—å£çœŸæ­£è¦ç”¨åˆ°çš„è®¡ç®—åŠŸèƒ½å‡½æ•°.</li>
</ul>
<p>ä¸¤ä»½æ–‡ä»¶ç”¨ <code>partial</code> ç±»å°†åŠŸèƒ½ç»„åˆåˆ°ä¸€èµ·.</p>
<p>æœ€åé¢å¤–è¡¥å……äº†ä¸€ä¸ª <code>About</code> çª—å£, åœ¨ VS èœå•é‡Œæ·»åŠ çª—å£å°±èƒ½ç›´æ¥ç”Ÿæˆéœ€è¦çš„æ¨¡æ¿æ–‡ä»¶.</p>
<h3 id="å¤šçº¿ç¨‹ä¸è¿›åº¦æ¡"><a href="#å¤šçº¿ç¨‹ä¸è¿›åº¦æ¡" class="headerlink" title="å¤šçº¿ç¨‹ä¸è¿›åº¦æ¡"></a>å¤šçº¿ç¨‹ä¸è¿›åº¦æ¡</h3><p>ä½œä¸ºä¸€ä¸ªçª—å£ç¨‹åº, ä¸ºäº†é¿å…çª—å£å“åº”å¡æ­», æ‰€æœ‰è€—æ—¶çš„è®¡ç®—è¿‡ç¨‹éƒ½å¿…é¡»ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ”¾åˆ°åå°æ‰§è¡Œ. å†å°±æ˜¯ç¨‹åºæ”¯æŒç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¤šä¸ªç®—æ³•ä¹‹é—´çš„è®¡ç®—, å› æ­¤å¤šçº¿ç¨‹çš„ä½¿ç”¨å’ŒåŒæ­¥é—®é¢˜æ˜¯ç¬¬ä¸€ä¸ªéº»çƒ¦ä¹‹å¤„.</p>
<p>ç¬¬äºŒä¸ªæœ‰ç‚¹éº»çƒ¦çš„åœ°æ–¹å°±æ˜¯æ˜¾ç¤ºè¿›åº¦æ¡, ç”±äºå¯ä»¥ä¸€æ¬¡æ€§è®¡ç®—å¤šä¸ªæ–‡ä»¶, æ‰€ä»¥åˆ†äº†å½“å‰æ–‡ä»¶è¿›åº¦å’Œæ€»è¿›åº¦, åœ¨å¤šçº¿ç¨‹æ—¶ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘åŒæ­¥é—®é¢˜çš„.</p>
<p>é¦–å…ˆå¤šçº¿ç¨‹ç”¨çš„ <code>System.Threading.Tasks.Task</code> ç±», è¿™æ˜¯è‡ªå¸¦å°è£…å¥½çš„å¤šçº¿ç¨‹ API, å¦‚æœå‹¾é€‰äº†å¤šçº¿ç¨‹é€‰é¡¹, é‚£ä¹ˆå°±å°†æ¯ä¸ªç®—æ³•çš„è®¡ç®—éƒ½åˆ†é…ä¸€ä¸ª <code>Task</code>, æœ€åå°†ç»“æœæ±‡æ€»åˆ°ä¸€èµ·.</p>
<p>æœ‰å…³çš„å‡ ä¸ªæ–¹æ³•å®ç°å¦‚ä¸‹:</p>
<ul>
<li><code>TaskCompHash</code>: å¯¹æŒ‡å®šæ–‡ä»¶è®¡ç®—æŒ‡å®šå“ˆå¸Œç®—æ³•çš„ç»“æœ, å¹¶ç´¯åŠ è®¡ç®—è¿›åº¦å€¼.</li>
<li><code>ComputeWithOneTask</code> å’Œ <code>ComputeWithMultiTask</code>: æ¯ä¸ªæ–‡ä»¶çš„ä¸åŒå“ˆå¸Œç®—æ³•è®¡ç®—ä»»åŠ¡. ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šåˆ›å»ºå­ä»»åŠ¡, åŒºåˆ«æ˜¯å‰è€…æ¯æ¬¡åªå¯¹ 1 ä¸ªç®—æ³•åˆ›å»º 1 ä¸ªä»»åŠ¡è®¡ç®—, åè€…æ ¹æ®ç®—æ³•æ•°é‡åˆ›å»ºå¤šä¸ªåŒæ—¶è®¡ç®—. ç„¶åè½®è¯¢ä»»åŠ¡æ˜¯å¦è®¡ç®—å®Œæˆ, å¹¶æ›´æ–°è¿›åº¦æ¡.</li>
<li><code>TaskCompute</code>: å¯¹æ¯ä¸ªæ–‡ä»¶è®¡ç®—æ¯ä¸€ç§å“ˆå¸Œç®—æ³•çš„å€¼.</li>
<li><code>BeginCompute</code>: åˆ›å»ºåå°è®¡ç®—ä»»åŠ¡, åˆ›å»ºå®Œåç«‹å³è¿”å›, ä¸ä¼šä½¿çª—å£å‡æ­».</li>
</ul>
<p>è°ƒç”¨å…³ç³»ä¸º:</p>
<p><code>BeginCompute</code> -&gt; <code>TaskCompute</code> -&gt; <code>ComputeWithOneTask | ComputeWithMultiTask</code> -&gt; <code>TaskCompHash</code></p>
<p>å…¶ä¸­ <code>Task</code> å¼€å¤´çš„æ˜¯è¦è¢« <code>Task</code> ç±»åˆ›å»ºä»¥å¤šçº¿ç¨‹æ–¹å¼åœ¨åå°æ‰§è¡Œçš„æ–¹æ³•. å¦‚æ­¤ä¸€æ¥ä¾¿å®Œæˆäº†å¯¹æ¯ä¸ªæ–‡ä»¶çš„æ¯ç§å“ˆå¸Œå€¼çš„è®¡ç®—è¿‡ç¨‹.</p>
<p>è€Œè¿›åº¦æ¡çš„å®ç°, åˆ™æ˜¯é  <code>pbValueSingle</code> å’Œ <code>pbValueTotal</code> ä¸¤ä¸ªæˆå‘˜æ¥è®°å½•. æ¯æ¬¡ä½¿ç”¨å“ˆå¸Œç®—æ³•è®¡ç®—æ—¶, ç´¯åŠ è®¡ç®—é‡ç›¸å¯¹äºæ–‡ä»¶å¤§å°çš„ç™¾åˆ†æ¯”å€¼, è¿™æ ·å¯¹äºä¸€ä¸ªæ–‡ä»¶çš„ä¸€ç§ç®—æ³•å°±æœ‰ä¸€ä¸ªå®Œæ•´çš„å•ä½ 1, æ‰€ä»¥æ€»è®¡ç®—é‡å°±æ˜¯æ–‡ä»¶æ•°ä¹˜ä»¥ç®—æ³•æ•°.</p>
<h3 id="å“ˆå¸Œç®—æ³•å®ç°"><a href="#å“ˆå¸Œç®—æ³•å®ç°" class="headerlink" title="å“ˆå¸Œç®—æ³•å®ç°"></a>å“ˆå¸Œç®—æ³•å®ç°</h3><p><code>C#</code> çš„ç³»ç»Ÿåº“é‡Œå·²ç»æä¾›äº†å¤§éƒ¨åˆ†å¸¸è§çš„å“ˆå¸Œç®—æ³•, éƒ½åœ¨ <code>System.Security.Cryptography</code> å‘½åç©ºé—´ä¸­, æˆ‘ä»¬éœ€è¦é¢å¤–å®ç°ä¸€ä¸‹SM3 å’Œ SHA3 ç­‰ç®—æ³•.</p>
<p>å…·ä½“çš„ç®—æ³•åŸç†å¦å†™ä¸€ç¯‡è®°å½•, è¿™é‡Œä¸»è¦çœ‹çœ‹å®ç°æ€è·¯.</p>
<p>æŸ¥é˜…ä¸€ä¸‹ API æ–‡æ¡£, å¯ä»¥çœ‹åˆ° <code>System.Security.Cryptography</code> æä¾›äº†ä¸€ä¸ªå“ˆå¸Œç®—æ³•çš„åŸºç±» <code>HashAlgorithm</code> ç»™æˆ‘ä»¬ç”¨æ¥ç»§æ‰¿, å¹¶ä¸”éœ€è¦é‡å†™ä¸‹åˆ—æ–¹æ³•:</p>
<ul>
<li><code>Initialize</code>: åˆå§‹åŒ–æ–¹æ³•, ä¹Ÿå°±æ˜¯è®¡ç®—ä¸€ä¸ªå“ˆå¸Œçš„åˆå§‹å‡†å¤‡å·¥ä½œ, ä¾‹å¦‚ä¸€äº›ç¼“å†²åŒºçš„åˆå§‹å€¼å¯ä»¥åœ¨è¿™é‡Œè®¾ç½®.</li>
<li><code>HashCore</code>: æ ¸å¿ƒè®¡ç®—è¿‡ç¨‹, æœ‰ä¸‰ä¸ªå‚æ•°, æ¥æ”¶ä»»æ„é•¿åº¦çš„å­—èŠ‚æ•°ç»„è¾“å…¥, å¹¶å®Œæˆè¿™ä¸€éƒ¨åˆ†å†…å®¹çš„è®¡ç®—. è¿™ä¸ªæ–¹æ³•å¯ä»¥å®Œæˆå¯¹å¤§æ–‡ä»¶çš„åˆ†å—å“ˆå¸Œå€¼è®¡ç®—.</li>
<li><code>HashFinal</code>: ç»“æŸè®¡ç®—æ–¹æ³•, æ¯”å¦‚ä¸€äº›å°¾éƒ¨å¡«å……æ“ä½œå¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œ.</li>
</ul>
<p>ç»§æ‰¿å¹¶é‡å†™å, æˆ‘ä»¬çš„å“ˆå¸Œç®—æ³•å°±æœ‰ç»Ÿä¸€çš„åŸºç±»å’Œæ¥å£, è¿™ä¹Ÿæ–¹ä¾¿æˆ‘ä»¬åç»­çš„æ–¹æ³•è°ƒç”¨.</p>
<h3 id="ç¼–è¯‘ä¸å‘å¸ƒ"><a href="#ç¼–è¯‘ä¸å‘å¸ƒ" class="headerlink" title="ç¼–è¯‘ä¸å‘å¸ƒ"></a>ç¼–è¯‘ä¸å‘å¸ƒ</h3><p>ç¼–è¯‘çš„æ–¹å¼å’Œæ™®é€šé¡¹ç›®ä¸€æ ·, åœ¨èœå•çš„ &quot;ç”Ÿæˆ&quot; é¡¹é‡Œè¿›è¡Œç”Ÿæˆå³å¯.</p>
<p>å€¼å¾—å…³æ³¨çš„æ˜¯ç”Ÿæˆæ—¶çš„é…ç½®, å³é”®æŸ¥çœ‹é¡¹ç›®å±æ€§, é‡Œé¢å¯ä»¥è®¾ç½®ç›®æ ‡æ¡†æ¶, å¦‚æœè€ƒè™‘å…¼å®¹æ€§, é€‰ä½ä¸€ç‚¹æ¯”è¾ƒå¥½, è¿™é‡Œæˆ‘é€‰äº† 4.6 çš„ç‰ˆæœ¬.</p>
<p>å†å°±æ˜¯ç”Ÿæˆé‡Œå¯ä»¥è®¾ç½®ç›®æ ‡å¹³å°, å°½é‡é€‰æˆ <code>x64</code>, é€Ÿåº¦ä¸Šæœ‰ä¸€äº›å°çš„ä¼˜åŒ–.</p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p>Github é¡¹ç›®åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0hhc2h0b29s">https://github.com/ww-rm/Hashtool<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>ä¸ªäººé¡¹ç›®</category>
      </categories>
      <tags>
        <tag>hashtool</tag>
        <tag>C#</tag>
        <tag>winforms</tag>
      </tags>
  </entry>
  <entry>
    <title>NCM æ–‡ä»¶æ‰¹é‡è½¬æ¢ (ä¿ç•™ä¸“è¾‘å’Œå°é¢ä¿¡æ¯)</title>
    <url>//posts/2023/11/04/ncmdump/</url>
    <content><![CDATA[<p>è¿™æ®µæ—¶é—´æ‰“ç®—ç”¨ç½‘æ˜“äº‘éŸ³ä¹å›¤ç‚¹èµ„æº, ä½†æ˜¯ä¸‹è½½ä¹‹åæ‰å‘ç°å†…å®¹å·²ç»å…¨éƒ¨åŠ å¯†, å˜æˆäº† <code>ncm</code> åç¼€çš„æ–‡ä»¶. æœç´¢ä¸€ç•ª, æ‰¾åˆ°äº†ä¸€äº›ç°æˆçš„è½¬æ¢å·¥å…·å’Œæºç . ä½†æ˜¯åŠŸèƒ½éƒ½ååˆ†æœ‰é™, è€Œä¸”è½¬æ¢å‡ºæ¥ä¹‹åçš„æ–‡ä»¶éƒ½æ²¡æœ‰ä¸“è¾‘å’Œå°é¢ä¿¡æ¯<del>å¼ºè¿«ç—‡å¤§æ€’</del>. çœ‹äº†çœ‹æœ‰å…³çš„åˆ†æå’Œæºç ä¹‹å, å†³å®šè‡ªå·±é‡æ–°æ•´ç†ä¸€ä¸‹è½¬æ¢åŠŸèƒ½, å¹¶ä¸”æŠŠä¸“è¾‘å’Œå°é¢ä¿¡æ¯ä¹ŸåŠ è¿›å», åšä¸ªå®Œå–„çš„å‘½ä»¤è¡Œå·¥å…·è‡ªç”¨, é¡ºä¾¿æ‰“åŒ…æˆ Python åº“, ä¸Šä¼ åˆ° PyPI ä¸Š.</p>
<p>æœ¬æ–‡åŒ…æ‹¬ä»¥ä¸‹å†…å®¹, é¦–å…ˆæ•´ç†ä¸€ä¸‹ç½‘ä¸Šå·²æœ‰çš„ <code>ncm</code> æ ¼å¼è½¬æ¢ä»£ç , ç„¶åå¢åŠ è¡¥å……ä¸“è¾‘å’Œå°é¢ä¿¡æ¯çš„åŠŸèƒ½, å¹¶å®ç°æ‰¹é‡è½¬æ¢å’Œç•Œé¢å‹å¥½, æœ€åæ‰“åŒ…æˆäºŒè¿›åˆ¶æ–‡ä»¶å’Œ Python åº“, å¹¶ä¸Šä¼ åˆ° PyPI ä¸Š.</p>
<p>æ–‡æœ«é™„æœ‰é¡¹ç›®çš„ Github åœ°å€, ä»¥åŠä½¿ç”¨ PyInstaller æ‰“åŒ…çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€å’Œ PyPI é¡¹ç›®åœ°å€.</p>
<span id="more"></span>

<h2 id="å¿«é€Ÿä¸Šæ‰‹"><a href="#å¿«é€Ÿä¸Šæ‰‹" class="headerlink" title="å¿«é€Ÿä¸Šæ‰‹"></a>å¿«é€Ÿä¸Šæ‰‹</h2><p>å®‰è£…:</p>
<p><code>pip install ncmdump-py</code></p>
<p>å‘½ä»¤è¡Œä½¿ç”¨:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python -m ncmdump [-h] [--in-folder IN_FOLDER] [--out-folder OUT_FOLDER] [--dump-metadata] [--dump-cover] [files ...]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usage: ncmdump [-h] [--in-folder IN_FOLDER] [--out-folder OUT_FOLDER] [--dump-metadata] [--dump-cover] [files ...]</span><br><span class="line"></span><br><span class="line">Dump ncm files with progress bar and logging info, only process files with suffix &#x27;.ncm&#x27;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  files                 Files to dump, can follow multiple files.</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  --in-folder IN_FOLDER</span><br><span class="line">                        Input folder of files to dump.</span><br><span class="line">  --out-folder OUT_FOLDER</span><br><span class="line">                        Output folder of files dumped.</span><br><span class="line">  --dump-metadata       Whether dump metadata.</span><br><span class="line">  --dump-cover          Whether dump album cover.</span><br></pre></td></tr></table></figure>

<p>å¯¼å…¥ä»£ç ä½¿ç”¨:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> ncmdump <span class="keyword">import</span> NeteaseCloudMusicFile</span><br><span class="line"></span><br><span class="line">ncmfile = NeteaseCloudMusicFile(<span class="string">&quot;filename.ncm&quot;</span>)</span><br><span class="line">ncmfile.decrypt()</span><br><span class="line"></span><br><span class="line">ncmfile.dump_music(<span class="string">&quot;filename.mp3&quot;</span>)  <span class="comment"># auto detect correct suffix</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Maybe you need metadata or cover image</span></span><br><span class="line"><span class="comment"># ncmfile.dump_metadata(&quot;filename.json&quot;)  </span></span><br><span class="line"><span class="comment"># ncmfile.dump_cover(&quot;filename.jpeg&quot;)</span></span><br></pre></td></tr></table></figure>

<h2 id="NCM-æ ¼å¼åˆ†æ"><a href="#NCM-æ ¼å¼åˆ†æ" class="headerlink" title="NCM æ ¼å¼åˆ†æ"></a>NCM æ ¼å¼åˆ†æ</h2><p>Github ä¸Šæœ <code>ncmdump</code>, æœ‰å¾ˆå¤šç°æˆçš„é¡¹ç›®, é€šè¿‡æºç å’Œè‡ªå·±å°è¯•åæ€»ç»“ä¸€ä¸‹ <code>ncm</code> æ ¼å¼å¦‚ä¸‹è¡¨:</p>
<table>
<thead>
<tr>
<th align="center">å­—æ®µ</th>
<th align="center">é•¿åº¦</th>
<th align="center">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>MAGIC_HEADER</code></td>
<td align="center">8 å­—èŠ‚</td>
<td align="center">ncm æ–‡ä»¶çš„æ–‡ä»¶å¤´æ ‡è¯†, å†…å®¹ä¸º <code>b&quot;CTENFDAM&quot;</code></td>
</tr>
<tr>
<td align="center"><code>gap1</code></td>
<td align="center">2 å­—èŠ‚</td>
<td align="center">ä¸ç¡®å®š, æ®è§‚å¯Ÿæ‰€æœ‰çš„æ–‡ä»¶éƒ½ç›¸åŒ, ä¸º <code>b&quot;\x01\x61&quot;</code>, çŒœæµ‹ä¹Ÿæ˜¯æ–‡ä»¶å¤´ä¸€éƒ¨åˆ†</td>
</tr>
<tr>
<td align="center"><code>rc4_key_enc_size</code></td>
<td align="center">4 å­—èŠ‚</td>
<td align="center"><code>int</code> æ•´æ•°</td>
</tr>
<tr>
<td align="center"><code>rc4_key_enc</code></td>
<td align="center"><code>rc4_key_enc_size</code></td>
<td align="center">åŠ å¯†åçš„ RC4 ç®—æ³•å¯†é’¥</td>
</tr>
<tr>
<td align="center"><code>metadata_enc_size</code></td>
<td align="center">4 å­—èŠ‚</td>
<td align="center"><code>int</code> æ•´æ•°</td>
</tr>
<tr>
<td align="center"><code>metadata_enc</code></td>
<td align="center"><code>metadata_enc_size</code></td>
<td align="center">åŠ å¯†åçš„ <code>metadata</code>, åŒ…å«éŸ³ä¹çš„ä¸“è¾‘å’Œå°é¢ä¿¡æ¯</td>
</tr>
<tr>
<td align="center"><code>crc32</code></td>
<td align="center">4 å­—èŠ‚</td>
<td align="center">ä¸ç¡®å®š, æ®ç½‘ä¸Šæµä¼ ä¸º CRC32 æ ¡éªŒç , ä½†æ˜¯æ²¡æ‰¾åˆ°æ˜¯ç®—å“ªä¸ªå€¼çš„</td>
</tr>
<tr>
<td align="center"><code>gap2</code></td>
<td align="center">5 å­—èŠ‚</td>
<td align="center">ä¸ç¡®å®š, æ®è§‚å¯Ÿéƒ½ä¸º <code>b&quot;\x01&quot;</code> å¼€å¤´, <code>b&quot;\x00&quot;</code> ç»“å°¾</td>
</tr>
<tr>
<td align="center"><code>cover_data_size</code></td>
<td align="center">4 å­—èŠ‚</td>
<td align="center"><code>int</code> æ•´æ•°</td>
</tr>
<tr>
<td align="center"><code>cover_data</code></td>
<td align="center"><code>cover_data_size</code></td>
<td align="center">ä¸“è¾‘å°é¢å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td align="center"><code>music_data_enc</code></td>
<td align="center">ä»»æ„é•¿åº¦</td>
<td align="center">åŠ å¯†åçš„éŸ³ä¹äºŒè¿›åˆ¶æ•°æ®, å¤„äº <code>ncm</code> æ–‡ä»¶çš„æœ€æœ«å°¾</td>
</tr>
</tbody></table>
<p>æ ¼å¼å¾ˆæ¸…æ™°, è™½ç„¶æœ‰ä¸€äº›æœªçŸ¥é¡¹, ä½†æ˜¯ä¸å½±å“æ ¸å¿ƒå†…å®¹. å…¶ä¸­ <code>rc4_key_enc</code>, <code>metadata_enc</code>, <code>music_data_enc</code> æ˜¯åŠ å¯†è¿‡çš„, åªè¦å…¨éƒ¨è§£å¯†å°±èƒ½è¿˜åŸå‡ºåŸæœ¬å®Œæ•´çš„éŸ³ä¹æ–‡ä»¶.</p>
<h2 id="NCM-æ–‡ä»¶è§£å¯†"><a href="#NCM-æ–‡ä»¶è§£å¯†" class="headerlink" title="NCM æ–‡ä»¶è§£å¯†"></a>NCM æ–‡ä»¶è§£å¯†</h2><p>è¿™éƒ¨åˆ†å†…å®¹ä¹Ÿæ˜¯æ€»ç»“å·²æœ‰çš„æºç .</p>
<p><code>ncm</code> æ–‡ä»¶ä¸­ä½¿ç”¨äº†ä¸¤ç§å¯†ç ç®—æ³•:</p>
<ul>
<li>ä¸€ç§æ˜¯ç»è¿‡é­”æ”¹çš„ <code>RC4</code> ç®—æ³•, åæ–‡ç§°å®ƒä¸º <code>NCMRC4</code></li>
<li>å¦ä¸€ç§æ˜¯æ ‡å‡†çš„ <code>AES</code> ç®—æ³•, åˆ†ç»„é•¿åº¦ <code>128</code> æ¯”ç‰¹, å·¥ä½œæ¨¡å¼ <code>ECB</code>, å¡«å……ç®—æ³•ä¸º <code>PKCS7</code>, åæ–‡ç§°å®ƒä¸º <code>NCMAES</code></li>
</ul>
<p><code>ncm</code> æ–‡ä»¶çš„åŠ å¯†æ–¹å¼å¦‚ä¸‹:</p>
<ul>
<li><code>music_data_enc = NCMRC4.encrypt(music_data, rc4_key)</code></li>
<li><code>metadata_enc = NCMAES.encrypt(metadata_enc, AES_KEY_METADATA)</code></li>
<li><code>rc4_key_enc = NCMAES.encrypt(rc4_key, AES_KEY_RC4_KEY)</code></li>
</ul>
<p>è¾ƒå¤§çš„ <code>music_data</code> ç”¨é­”æ”¹åçš„æµå¯†ç åŠ å¯†, èŠ‚çœæ—¶é—´; è¾ƒçŸ­çš„ <code>metadata</code> å’Œ <code>rc4_key</code> ç”¨å¯¹ç§°å¯†ç åŠ å¯†, æé«˜å®‰å…¨æ€§.</p>
<p>è¿™é‡Œ <code>AES_KEY_RC4_KEY</code> å’Œ <code>AES_KEY_METADATA</code> æ˜¯ä¸¤ä¸ªå…³é”®çš„å¯¹ç§°å¯†ç å¯†é’¥, å‰äººå·²ç»é€šè¿‡é€†å‘ç­‰æ‰‹æ®µæŒ–å‡ºæ¥äº†, è¿™é‡Œå°±ä¸æ”¾å‡ºæ¥äº†, å¯ä»¥å»çœ‹çœ‹åˆ«äººçš„åˆ†ææˆ–è€…çœ‹æœ¬æ–‡çš„æºç , é‡Œé¢éƒ½æœ‰.</p>
<p>é™¤äº†ä½¿ç”¨åŠ å¯†æ‰‹æ®µ, è¿˜æœ‰ä¸€äº›ç®€å•çš„æ··æ·†æ“ä½œ, ä»¥åŠå»é™¤è§£å¯†åå†…å®¹å¤šä½™çš„å¤´éƒ¨å­—æ®µç­‰, è¿™é‡Œä¹Ÿä¸è¯¦ç»†å†™äº†, æºç é‡Œé¢å†™çš„å¾ˆæ¸…æ¥š, å¯ä»¥ç›´æ¥çœ‹æºç .</p>
<h2 id="æ·»åŠ ä¸“è¾‘å’Œå°é¢ä¿¡æ¯"><a href="#æ·»åŠ ä¸“è¾‘å’Œå°é¢ä¿¡æ¯" class="headerlink" title="æ·»åŠ ä¸“è¾‘å’Œå°é¢ä¿¡æ¯"></a>æ·»åŠ ä¸“è¾‘å’Œå°é¢ä¿¡æ¯</h2><p>æ¥åˆ°æœ¬æ–‡çš„é‡ç‚¹éƒ¨åˆ†, å‰é¢å¯¹ <code>ncm</code> æ ¼å¼å’ŒåŠ å¯†æ–¹å¼çš„åˆ†æéƒ½æ˜¯å·²æœ‰çš„, æˆ‘ä»¬ä¸»è¦æƒ³æ‰©å±•åŠŸèƒ½, è‡ªåŠ¨æ·»åŠ ä¸“è¾‘å’Œå°é¢ä¿¡æ¯åˆ°è§£å¯†åçš„æ–‡ä»¶é‡Œ, è¿™é‡Œä¸»è¦ç”¨åˆ° <code>mutagen</code> è¿™ä¸ªåº“, æ”¯æŒå‘ <code>mp3</code> å’Œ <code>flac</code> æ–‡ä»¶å†…åŠ å…¥ä¸“è¾‘ç­‰ä¿¡æ¯.</p>
<p>è§£å¯†åçš„ <code>metadata</code> æ˜¯ä¸€ä»½ <code>json</code> æ•°æ®, æ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flac&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;musicId&quot;</span><span class="punctuation">:</span> <span class="number">431259256</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;musicName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ã‚«ã‚¿ã‚ªãƒ¢ã‚¤&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;artist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">[</span><span class="string">&quot;Aimer&quot;</span><span class="punctuation">,</span> <span class="number">16152</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;album&quot;</span><span class="punctuation">:</span> <span class="string">&quot;daydream&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;albumId&quot;</span><span class="punctuation">:</span> <span class="number">34826361</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;albumPicDocId&quot;</span><span class="punctuation">:</span> <span class="number">109951165052089697</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;albumPic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://p1.music.126.net/2QRYxUqXfW0zQpm2_DVYRA==/109951165052089697.jpg&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;mvId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;bitrate&quot;</span><span class="punctuation">:</span> <span class="number">876923</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">207866</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;transNames&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;å•ç›¸æ€&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<details class="note info"><summary><p>v1.1.0 ä¸­çš„æ”¹åŠ¨</p>
</summary>
<p><code>metadata</code> å¯èƒ½å­˜åœ¨å¤šç§ç±»å‹, ä¸Šé¢æ˜¯æœ€ç®€å•çš„ <code>music</code> ç±»å‹, æ–°å¢äº† <code>dj</code> ç±»å‹, æ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;programId&quot;</span><span class="punctuation">:</span> <span class="number">2506516081</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;programName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;03 è¸éä¸‡æ°´åƒå±±&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mainMusic&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;musicId&quot;</span><span class="punctuation">:</span> <span class="number">1957438579</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;musicName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;03 è¸éä¸‡æ°´åƒå±±&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;artist&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;album&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[DJèŠ‚ç›®]åŒ—æ–¹æ–‡è‰ºå‡ºç‰ˆç¤¾çš„DJèŠ‚ç›® ç¬¬8æœŸ&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;albumId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;albumPicDocId&quot;</span><span class="punctuation">:</span> <span class="number">109951167551086981</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;albumPic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://p1.music.126.net/M48NPuT591tIqqUdQyKZlg==/109951167551086981.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;mvId&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bitrate&quot;</span><span class="punctuation">:</span> <span class="number">320000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;duration&quot;</span><span class="punctuation">:</span> <span class="number">1222948</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transNames&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;djId&quot;</span><span class="punctuation">:</span> <span class="number">7891086863</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;djName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;åŒ—æ–¹æ–‡è‰ºå‡ºç‰ˆç¤¾&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;djAvatarUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://p1.music.126.net/DQr2q_S23tYY8vU_C-kAYw==/109951167535553901.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span> <span class="number">1655691020376</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;brand&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ—å¾½å› ä¼ ï¼šå€¾æˆ‘æ‰€èƒ½å»åšå¼º&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serial&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;programDesc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è¿™æ˜¯ä¸€æœ¬æœ‰æ¸©åº¦ã€æœ‰æ€åº¦çš„ä¼ è®°ï¼Œè®°å½•äº†çœŸæ­£æ„ä¹‰ä¸Šçš„æ°‘å›½å¥³ç¥â€”â€”æ—å¾½å› ï¼Œä»å®¹åšå¼ºã€ä¼ å¥‡ä¸°æ²›çš„ä¸€ç”Ÿã€‚&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;programFeeType&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;programBuyed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioId&quot;</span><span class="punctuation">:</span> <span class="number">977264730</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ—å¾½å› ä¼ ï¼šå€¾æˆ‘æ‰€èƒ½å»åšå¼º&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioCategory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ–‡å­¦å‡ºç‰ˆ&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioCategoryId&quot;</span><span class="punctuation">:</span> <span class="number">3148096</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioDesc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;è¿™æ˜¯ä¸€æœ¬æœ‰æ¸©åº¦ã€æœ‰æ€åº¦çš„ä¼ è®°ï¼Œè®°å½•äº†çœŸæ­£æ„ä¹‰ä¸Šçš„æ°‘å›½å¥³ç¥â€”â€”æ—å¾½å› ï¼Œä»å®¹åšå¼ºã€ä¼ å¥‡ä¸°æ²›çš„ä¸€ç”Ÿã€‚&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioFeeType&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioFeeScope&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioBuyed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioPrice&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;radioPurchaseCount&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</details>

<p>æˆ‘ä»¬éœ€è¦æŠŠ <code>musicName</code>, <code>artist</code>, <code>album</code> è¿™ä¸‰ä¸ªå­—æ®µçš„å†…å®¹ä¿ç•™, åŒæ—¶æŠŠ <code>ncm</code> ä¸­é™„å¸¦çš„å°é¢å›¾ç‰‡ä¹Ÿä¿ç•™.</p>
<p>æˆ‘ä»¬å¯¼å…¥ä¸€ä¸‹è¦ç”¨åˆ°çš„åº“:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mutagen <span class="keyword">import</span> flac, id3, mp3</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br></pre></td></tr></table></figure>

<p>å¯¹äº <code>mp3</code>, å¦‚ä¸‹æ“ä½œ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_addinfo_mp3</span>(<span class="params">self, path: <span class="type">Union</span>[<span class="built_in">str</span>, PathLike]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Add info for mp3 format.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    audio = mp3.MP3(path)</span><br><span class="line"></span><br><span class="line">    audio[<span class="string">&quot;TIT2&quot;</span>] = id3.TIT2(text=self.name, encoding=id3.Encoding.UTF8)  <span class="comment"># title</span></span><br><span class="line">    audio[<span class="string">&quot;TALB&quot;</span>] = id3.TALB(text=self.album, encoding=id3.Encoding.UTF8)  <span class="comment"># album</span></span><br><span class="line">    audio[<span class="string">&quot;TPE1&quot;</span>] = id3.TPE1(text=<span class="string">&quot;/&quot;</span>.join(self.artists), encoding=id3.Encoding.UTF8)  <span class="comment"># artists</span></span><br><span class="line">    audio[<span class="string">&quot;TPE2&quot;</span>] = id3.TPE2(text=<span class="string">&quot;/&quot;</span>.join(self.artists), encoding=id3.Encoding.UTF8)  <span class="comment"># album artists</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self._cover_data_size &gt; <span class="number">0</span>:</span><br><span class="line">        audio[<span class="string">&quot;APIC&quot;</span>] = id3.APIC(<span class="built_in">type</span>=id3.PictureType.COVER_FRONT, mime=self.cover_mime, data=self._cover_data)  <span class="comment"># cover</span></span><br><span class="line"></span><br><span class="line">    audio.save()</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ <code>cover_mime</code> å°±æ˜¯å›¾åƒçš„å†…å®¹ç±»å‹, ä¾‹å¦‚ <code>image/jpeg</code> è¿™ç§, å¯ä»¥é€šè¿‡ <code>mimetypes</code> åº“è·å–.</p>
<p>è€Œå¯¹äº <code>flac</code>, å¦‚ä¸‹æ“ä½œ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_addinfo_flac</span>(<span class="params">self, path: <span class="type">Union</span>[<span class="built_in">str</span>, PathLike]</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Add info for flac format.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    audio = flac.FLAC(path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add music info</span></span><br><span class="line">    audio[<span class="string">&quot;title&quot;</span>] = self.name</span><br><span class="line">    audio[<span class="string">&quot;artist&quot;</span>] = self.artists</span><br><span class="line">    audio[<span class="string">&quot;album&quot;</span>] = self.album</span><br><span class="line">    audio[<span class="string">&quot;albumartist&quot;</span>] = <span class="string">&quot;/&quot;</span>.join(self.artists)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add cover</span></span><br><span class="line">    <span class="keyword">if</span> self._cover_data_size &gt; <span class="number">0</span>:</span><br><span class="line">        cover = flac.Picture()</span><br><span class="line">        cover.<span class="built_in">type</span> = id3.PictureType.COVER_FRONT</span><br><span class="line">        cover.data = self._cover_data</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> BytesIO(self._cover_data) <span class="keyword">as</span> data:</span><br><span class="line">            <span class="keyword">with</span> Image.<span class="built_in">open</span>(data) <span class="keyword">as</span> f:</span><br><span class="line">                cover.mime = self.cover_mime</span><br><span class="line">                cover.width = f.width</span><br><span class="line">                cover.height = f.height</span><br><span class="line">                cover.depth = <span class="built_in">len</span>(f.getbands()) * <span class="number">8</span></span><br><span class="line"></span><br><span class="line">        audio.add_picture(cover)</span><br><span class="line"></span><br><span class="line">    audio.save()</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ ä¸“è¾‘å°é¢å›¾ç‰‡çš„æ—¶å€™ç¨å¾®å¤æ‚ä¸€ç‚¹, éœ€è¦ä½¿ç”¨ <code>Pillow</code> åº“è¯»å–ä¸€ä¸‹å›¾åƒçš„åŸºæœ¬ä¿¡æ¯, ç„¶åå¡«è¿›å».</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯, <code>ncm</code> æ–‡ä»¶é‡Œå¯èƒ½æ²¡æœ‰å­˜æ”¾ä¸“è¾‘å°é¢å›¾ç‰‡, è¿™ç§æ—¶å€™å¯ä»¥å€ŸåŠ© <code>metadata</code> é‡Œçš„ <code>albumPic</code> å­—æ®µ, å®ƒä»£è¡¨ä¸“è¾‘å°é¢å›¾ç‰‡çš„ä¸€ä¸ª url, æˆ‘ä»¬å¯ä»¥ç”¨ <code>urllib</code> å°è¯•è”ç½‘è·å–å†…å®¹, ä»£ç ç‰‡æ®µå¦‚ä¸‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># if no cover data, try get cover data by url in metadata</span></span><br><span class="line"><span class="keyword">if</span> self._cover_data_size &lt;= <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> request.urlopen(self._metadata.get(<span class="string">&quot;albumPic&quot;</span>, <span class="string">&quot;&quot;</span>)) <span class="keyword">as</span> res:</span><br><span class="line">            <span class="keyword">if</span> res.status &lt; <span class="number">400</span>:</span><br><span class="line">                self._cover_data = res.read()</span><br><span class="line">                self._cover_data_size = <span class="built_in">len</span>(self._cover_data)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯, ä»£ç é‡Œéœ€è¦åˆ¤æ–­, å¦‚æœæœ€ç»ˆå°±æ˜¯æ²¡æœ‰åŠæ³•è·å¾—å›¾ç‰‡æ•°æ®, é‚£ä¹ˆå°±æ”¾å¼ƒæ·»åŠ å›¾ç‰‡ä¿¡æ¯, é¿å…æŠ¥é”™.</p>
<h2 id="å‘½ä»¤è¡Œå·¥å…·"><a href="#å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="å‘½ä»¤è¡Œå·¥å…·"></a>å‘½ä»¤è¡Œå·¥å…·</h2><p>åˆ°è¿™é‡Œ, æˆ‘ä»¬çš„åŒ…ç›®å½•ç»“æ„é•¿è¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ncmdump</span><br><span class="line">  â”œâ”€â”€ core.py</span><br><span class="line">  â”œâ”€â”€ crypto.py</span><br><span class="line">  â”œâ”€â”€ __init__.py</span><br><span class="line">  â””â”€â”€ __main__.py</span><br></pre></td></tr></table></figure>

<p>å…±æœ‰å››ä»½æ–‡ä»¶, ä¸ºäº†èƒ½å¤Ÿåœ¨å‘½ä»¤è¡Œé‡Œè¿è¡Œè¿™ä¸ªåŒ…, æˆ‘ä»¬éœ€è¦åœ¨ <code>__main__.py</code> é‡Œæ·»åŠ ä¸€äº›å†…å®¹.</p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>ArgumentParser</code> è§£æå‘½ä»¤è¡Œè¾“å…¥, <code>rich</code> åº“æ˜¾ç¤ºè¿›åº¦æ¡å’Œæ—¥å¿—è¾“å‡º, å®Œæ•´ä»£ç å¦‚ä¸‹.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> argparse <span class="keyword">import</span> ArgumentParser</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rich.progress <span class="keyword">import</span> Progress, SpinnerColumn, TimeElapsedColumn</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ncmdump <span class="keyword">import</span> NeteaseCloudMusicFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = ArgumentParser(<span class="string">&quot;ncmdump&quot;</span>, description=<span class="string">&quot;Dump ncm files with progress bar and logging info, only process files with suffix &#x27;.ncm&#x27;&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;files&quot;</span>, nargs=<span class="string">&quot;*&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Files to dump, can follow multiple files.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--in-folder&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Input folder of files to dump.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--out-folder&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Output folder of files dumped.&quot;</span>, default=<span class="string">&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--dump-metadata&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Whether dump metadata.&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--dump-cover&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Whether dump album cover.&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    out_folder = Path(args.out_folder)</span><br><span class="line">    out_folder.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    dump_metadata = args.dump_metadata</span><br><span class="line">    dump_cover = args.dump_cover</span><br><span class="line"></span><br><span class="line">    files = args.files</span><br><span class="line">    <span class="keyword">if</span> args.in_folder:</span><br><span class="line">        files.extend(Path(args.in_folder).iterdir())</span><br><span class="line">    files = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> p: p.suffix == <span class="string">&quot;.ncm&quot;</span>, <span class="built_in">map</span>(Path, files)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> files:</span><br><span class="line">        parser.print_help()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">with</span> Progress(SpinnerColumn(), *Progress.get_default_columns(), TimeElapsedColumn()) <span class="keyword">as</span> progress:</span><br><span class="line">            task = progress.add_task(<span class="string">&quot;[#d75f00]Dumping files&quot;</span>, total=<span class="built_in">len</span>(files))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> ncm_path <span class="keyword">in</span> files:</span><br><span class="line">                output_path = out_folder.joinpath(ncm_path.stem)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    ncmfile = NeteaseCloudMusicFile(ncm_path).decrypt()</span><br><span class="line">                    music_path = ncmfile.dump_music(output_path)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> dump_metadata:</span><br><span class="line">                        ncmfile.dump_metadata(output_path)</span><br><span class="line">                    <span class="keyword">if</span> dump_cover:</span><br><span class="line">                        ncmfile.dump_cover(output_path)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    progress.log(<span class="string">f&quot;[red]ERROR[/red]: <span class="subst">&#123;ncm_path&#125;</span> -&gt; <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> ncmfile.metadata:</span><br><span class="line">                        progress.log(<span class="string">f&quot;[yellow]WARNING[/yellow]: <span class="subst">&#123;ncm_path&#125;</span> -&gt; <span class="subst">&#123;music_path&#125;</span>, no metadata found&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> ncmfile.cover_data:</span><br><span class="line">                        progress.log(<span class="string">f&quot;[yellow]WARNING[/yellow]: <span class="subst">&#123;ncm_path&#125;</span> -&gt; <span class="subst">&#123;music_path&#125;</span>, no cover data found&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">finally</span>:</span><br><span class="line">                    progress.advance(task)</span><br></pre></td></tr></table></figure>

<p>è¯¥å‘½ä»¤è¡Œå¯ä»¥æ¥æ”¶è‹¥å¹²æ•°é‡çš„ <code>.ncm</code> æ–‡ä»¶ä½œä¸ºè¾“å…¥, å¯ä»¥ç”¨ <code>--in-folder</code> æŒ‡å®šä¸€æ•´ä¸ªæ–‡ä»¶å¤¹, ä¼šå’Œè¾“å…¥çš„å•ä¸ªæ–‡ä»¶åˆå¹¶ä¸€èµ·å¤„ç†, æ¯”å¦‚æœ‰ä¸‹é¢å‡ ç§ä½¿ç”¨ç¤ºä¾‹.</p>
<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="comment">REM æŒ‡å®šæŸäº›æ–‡ä»¶</span></span><br><span class="line">python -m ncmdump file1.ncm file2.ncm</span><br></pre></td></tr></table></figure>

<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="comment">REM æŒ‡å®šä¸€æ•´ä¸ªæ–‡ä»¶å¤¹, åŒæ—¶æŒ‡å®šè¾“å‡ºç›®å½•</span></span><br><span class="line">python -m ncmdump --<span class="keyword">in</span>-folder ncmfiles --out-folder musicfolder</span><br></pre></td></tr></table></figure>

<figure class="highlight bat"><table><tr><td class="code"><pre><span class="line"><span class="comment">REM åŒæ—¶æŒ‡å®š</span></span><br><span class="line">python -m ncmdump file1.ncm file2.ncm --<span class="keyword">in</span>-folder ncmfiles --out-folder musicfolder</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºæ–‡ä»¶çš„æ–‡ä»¶åå’ŒåŸæœ¬çš„ <code>.ncm</code> æ–‡ä»¶åç›¸åŒ, ä½†æ˜¯åç¼€ä¼šè‡ªåŠ¨æ›¿æ¢æˆå¯¹åº”æ ¼å¼çš„åç¼€ (<code>.mp3</code> æˆ–è€… <code>.flac</code>).</p>
<h2 id="æ‰“åŒ…åˆ°-PyPI"><a href="#æ‰“åŒ…åˆ°-PyPI" class="headerlink" title="æ‰“åŒ…åˆ° PyPI"></a>æ‰“åŒ…åˆ° PyPI</h2><p>æœ€åå°±æ˜¯æ‰“åŒ…ä¸Šä¼ <del>é€ ç¦å¤§ä¼—çš„æ—¶é—´</del>, è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡åœ¨ PyPI ä¸Šä¸Šä¼ è‡ªå·±çš„åŒ…, ä¹‹åä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è¯´è¯´ä¸­é€”é‡åˆ°çš„ä¸€äº›é—®é¢˜.</p>
<p>ä¸Šä¼ å®Œæˆä¹‹å, å°±å¯ä»¥é€šè¿‡å‘½ä»¤ <code>pip install ncmdump-py</code> å®‰è£…ä½¿ç”¨äº†~</p>
<p>PS: è™½ç„¶åº“åå­—å« <code>ncmdump-py</code>, ä½†æ˜¯å¯¼å…¥çš„æ—¶å€™è¿˜æ˜¯ <code>import ncmdump</code>, å› ä¸º <code>ncmdump</code> è¿™ä¸ªé¡¹ç›®åå­—åœ¨ PyPI ä¸Šå·²ç»è¢«å‰äººæ³¨å†Œäº†, åªå¥½åŠ ç‚¹ä¸œè¥¿åŒºåˆ†ä¸€ä¸‹.</p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p>Github åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL25jbWR1bXAtcHk=">https://github.com/ww-rm/ncmdump-py/<i class="fa fa-external-link-alt"></i></span></p>
<p>PyPI é¡¹ç›®é¡µ: <span class="exturl" data-url="aHR0cHM6Ly9weXBpLm9yZy9wcm9qZWN0L25jbWR1bXAtcHkv">https://pypi.org/project/ncmdump-py/<i class="fa fa-external-link-alt"></i></span></p>
<p>PyInstaller æ‰“åŒ…çš„å‘½ä»¤è¡Œå·¥å…·: <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pdEdRcjFlemE1YWI=">ncmdump v1.1.0.zip<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>ä¸ªäººé¡¹ç›®</category>
      </categories>
      <tags>
        <tag>ncm</tag>
        <tag>æ ¼å¼è½¬æ¢</tag>
        <tag>ncmdump</tag>
        <tag>python åº“</tag>
        <tag>PyPI</tag>
        <tag>ç½‘æ˜“äº‘éŸ³ä¹</tag>
      </tags>
  </entry>
  <entry>
    <title>SpineViewer ç®€å•å¥½ç”¨çš„ Spine æŸ¥çœ‹&amp;å¯¼å‡ºå·¥å…·</title>
    <url>//posts/2025/03/04/spineviewer/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ä¸ªäººé¡¹ç›® <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL1NwaW5lVmlld2Vy">SpineViewer<i class="fa fa-external-link-alt"></i></span> çš„ä»‹ç», ä¸€ä¸ªä½¿ç”¨ <code>C#</code> å®ç°çš„æ¡Œé¢å·¥å…·, æ”¯æŒå¤šç‰ˆæœ¬å¤šéª¨éª¼çš„ Spine åŠ¨ç”»æŸ¥çœ‹å’Œå¯¼å‡º, å¹¶ä¸”æ”¯æŒæ–¹ä¾¿çš„é¢æ¿å‚æ•°è°ƒæ•´.</p>
<span id="more"></span>

<p><img data-src="/static/image/spineviewer/preview.jpg" alt="preview.jpg"></p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>å‰å¾€ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL1NwaW5lVmlld2VyL3JlbGVhc2Vz">Release<i class="fa fa-external-link-alt"></i></span> ç•Œé¢ä¸‹è½½å‹ç¼©åŒ….</p>
<p>è½¯ä»¶éœ€è¦å®‰è£…ä¾èµ–æ¡†æ¶ <span class="exturl" data-url="aHR0cHM6Ly9kb3RuZXQubWljcm9zb2Z0LmNvbS96aC1jbi9kb3dubG9hZC9kb3RuZXQvOC4w">.NET æ¡Œé¢è¿è¡Œæ—¶ 8.0.x<i class="fa fa-external-link-alt"></i></span>.</p>
<p>ä¹Ÿå¯ä»¥ä¸‹è½½å¸¦æœ‰ <code>SelfContained</code> åç¼€çš„å‹ç¼©åŒ…, å¯ä»¥ç‹¬ç«‹è¿è¡Œ.</p>
<h2 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><ul>
<li>æ”¯æŒä¸åŒç‰ˆæœ¬ Spine æŸ¥çœ‹<ul>
<li><input checked="" disabled="" type="checkbox"> <code>v3.6.x</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>v3.7.x</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>v3.8.x</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>v4.0.x</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>v4.1.x</code></li>
<li><input checked="" disabled="" type="checkbox"> <code>v4.2.x</code></li>
<li><input disabled="" type="checkbox"> <code>v4.3.x</code></li>
</ul>
</li>
<li>æ”¯æŒå¤šéª¨éª¼æ–‡ä»¶åŠ¨ç”»é¢„è§ˆ</li>
<li>æ”¯æŒæ¯ä¸ªéª¨éª¼ç‹¬ç«‹å‚æ•°è®¾ç½®</li>
<li>æ”¯æŒåŠ¨ç”»PNGå¸§åºåˆ—å¯¼å‡º</li>
<li>æ”¯æŒç¼©æ”¾æ—‹è½¬ç­‰å¯¼å‡ºç”»é¢è®¾ç½®</li>
<li>Coming soon...</li>
</ul>
<h2 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h2><h3 id="éª¨éª¼å¯¼å…¥"><a href="#éª¨éª¼å¯¼å…¥" class="headerlink" title="éª¨éª¼å¯¼å…¥"></a>éª¨éª¼å¯¼å…¥</h3><p><strong>æ–‡ä»¶</strong>èœå•å¯ä»¥é€‰æ‹©<strong>æ‰“å¼€</strong>æˆ–è€…<strong>æ‰¹é‡æ‰“å¼€</strong>è¿›è¡Œéª¨éª¼æ–‡ä»¶å¯¼å…¥.</p>
<h3 id="éª¨éª¼è°ƒæ•´"><a href="#éª¨éª¼è°ƒæ•´" class="headerlink" title="éª¨éª¼è°ƒæ•´"></a>éª¨éª¼è°ƒæ•´</h3><p>åœ¨<strong>æ¨¡å‹åˆ—è¡¨</strong>ä¸­é€‰æ‹©ä¸€é¡¹æˆ–å¤šé¡¹, å°†ä¼šåœ¨<strong>æ¨¡å‹å‚æ•°</strong>é¢æ¿æ˜¾ç¤ºå¯ä¾›è°ƒèŠ‚çš„å‚æ•°.</p>
<p><strong>æ¨¡å‹åˆ—è¡¨</strong>å³é”®èœå•å¯ä»¥å¯¹åˆ—è¡¨é¡¹è¿›è¡Œå¢åˆ è°ƒæ•´, ä¹Ÿå¯ä»¥ä½¿ç”¨é¼ æ ‡å·¦é”®æ‹–åŠ¨è°ƒæ•´é¡ºåº.</p>
<h3 id="ç”»é¢è°ƒæ•´"><a href="#ç”»é¢è°ƒæ•´" class="headerlink" title="ç”»é¢è°ƒæ•´"></a>ç”»é¢è°ƒæ•´</h3><p><strong>é¢„è§ˆç”»é¢</strong>æ”¯æŒçš„é¼ æ ‡æ“ä½œ:</p>
<ul>
<li>å·¦é”®å¯ä»¥å¯¹éª¨éª¼è¿›è¡Œæ‹–åŠ¨</li>
<li>å³é”®å¯¹ç”»é¢è¿›è¡Œæ‹–åŠ¨</li>
<li>æ»šè½®è¿›è¡Œç”»é¢ç¼©æ”¾</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–, ä¹Ÿå¯ä»¥é€šè¿‡<strong>ç”»é¢å‚æ•°</strong>é¢æ¿è°ƒèŠ‚å¯¼å‡ºå’Œé¢„è§ˆæ—¶çš„ç”»é¢å‚æ•°.</p>
<p>åœ¨<strong>åŠŸèƒ½</strong>èœå•ä¸­, å¯ä»¥é‡ç½®åŒæ­¥æ‰€æœ‰éª¨éª¼åŠ¨ç”»æ—¶é—´.</p>
<h3 id="åŠ¨ç”»å¯¼å‡º"><a href="#åŠ¨ç”»å¯¼å‡º" class="headerlink" title="åŠ¨ç”»å¯¼å‡º"></a>åŠ¨ç”»å¯¼å‡º</h3><p><strong>æ–‡ä»¶</strong>èœå•ä¸­é€‰æ‹©<strong>å¯¼å‡º</strong>å¯ä»¥å°†ç›®å‰åŠ è½½çš„æ‰€æœ‰éª¨éª¼åŠ¨ç”»æŒ‰ç…§é¢„è§ˆæ—¶çš„ç”»é¢è¿›è¡ŒPNGå¸§åºåˆ—å¯¼å‡º.</p>
<p>å¯ä»¥åœ¨æ¯ä¸ªéª¨éª¼çš„<strong>æ¨¡å‹å‚æ•°</strong>ä¸­æŸ¥çœ‹åŠ¨ç”»å®Œæ•´æ—¶é•¿.</p>
<h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>ç®—æ˜¯ç¬¬äºŒæ¬¡å†™ Winforms åº”ç”¨äº†<del>äºæ¯•è®¾çš„ç™¾å¿™ä¹‹ä¸­æŠ½ç©ºå®Œæˆ</del>, ä¸å¾—ä¸æ„Ÿæ¦‚, GPT çœŸçš„å¤§å¤§æ”¹å–„ä»£ç ä½“éªŒ, ä»¥å‰æ‰¾ä¸ªæ–‡æ¡£å¯ä»¥è¦ç¿»è€åŠå¤©, è€Œä¸”ä¸ç†Ÿæ‚‰çš„è¯æ‰¾åˆ°çš„è¿˜ä¸è§„èŒƒ, æå®¹æ˜“æ‰å‘, ç°åœ¨æœ‰ GPT ä¹‹ç±»çš„åŠ æˆ, æ‹¿ç€ä»£ç ç‰‡æ®µå’Œéœ€æ±‚ä¸€é—®, å‡ ä¹ç›´æ¥å°±èƒ½è·‘äº†, åªèƒ½è¯´ç§‘æŠ€æ”¹å˜ç”Ÿæ´»å•Š, å¯¹ä¸€äº›ç®€å•çš„å¼€æºé¡¹ç›®å¤ªæœ‰å¸®åŠ©äº†.</p>
<p>è¿™æ˜¯åœ¨åŸæœ‰é¡¹ç›® <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Rlc2t0b3BTcHJpdGU=">DesktopSprite<i class="fa fa-external-link-alt"></i></span> ä¸Šæ”¹å‡ºæ¥çš„, èµ·å› æ˜¯æœ‰äººç•™ Issue è¯´æ˜¯å¦å¯ä»¥å¢åŠ éª¨éª¼æ•°é‡ä¸Šé™. å…¶å®è‡ªå·±ä¹Ÿä¸€ç›´å¾ˆè†ˆåº”è¿™ä»¶äº‹, å› ä¸ºä¹‹å‰ç¬¬ä¸€æ¬¡å†™ Winforms åº”ç”¨, å‹æ ¹ä¸æ€ä¹ˆä¼šå†™, å¯¹æ§ä»¶åº“ç”šè‡³è¯­æ³•éƒ½ä¸æ˜¯å¾ˆç†Ÿæ‚‰, æ‰€ä»¥å¾ˆå¤šåœ°æ–¹å†™çš„å¾ˆæ­», éƒ½æ˜¯æ‰‹åŠ¨æ‘†å‡ºæ¥äº†å¤šå°‘ä¸ªæ§ä»¶ç„¶åæ”¯æŒæ“ä½œ.</p>
<p>ä¸è¿‡è¿™æ¬¡ç”¨ä¸Š <code>PropertyGrid</code> å’Œ <code>ListView</code> ä¹‹å, ä¸ç®¡æ˜¯ä½¿ç”¨ä¸Šè¿˜æ˜¯ä»£ç ä¸Šä½“éªŒéƒ½å¥½äº†å¾ˆå¤š, è€Œä¸”ä¹Ÿåšäº†ä¸åŒæ§ä»¶å’Œå¯¹è¯æ¡†çš„å°è£…, é¡¹ç›®ç»“æ„ç¡®å®è¿œå¥½äºä¹‹å‰<del>æœç„¶ä»£ç è¿˜æ˜¯å¾—å¤šå†™</del>, å¸Œæœ›èƒ½æ”¶è·å‡ ä¸ª star å§.</p>
]]></content>
      <categories>
        <category>ä¸ªäººé¡¹ç›®</category>
      </categories>
      <tags>
        <tag>Spine</tag>
        <tag>SpineViewer</tag>
        <tag>Winforms</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³ Github SSH è¿æ¥è¶…æ—¶</title>
    <url>//posts/2024/01/17/githubssh-timeout/</url>
    <content><![CDATA[<p>è§£å†³ Github SSH è¿æ¥è¶…æ—¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh -T git@github.com</span><br><span class="line">ssh: connect to host github.com port 22: Connection timed out</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>ä¼—æ‰€å‘¨çŸ¥ Github çš„ç½‘é¡µç«¯è®¿é—®æå…¶ä¸ç¨³å®š, ç”¨ http åè®® clone ä»“åº“çš„æ—¶å€™éå¸¸éš¾å—, ä½†æ˜¯ç”¨å…¬é’¥èµ° ssh åè®®è¿›è¡Œè¿æ¥ä½“æ„Ÿç¨³å®šå¾ˆå¤š.</p>
<p>ä½†æ˜¯æœ€è¿‘ ssh ä¹Ÿä¸è¡Œäº†, ç¨³å®šè¿æ¥è¶…æ—¶, æœ¬åœ°ä¸€å †ä»“åº“éƒ½æ²¡åŠæ³•è¿›è¡Œæ¨é€.</p>
<p>ç½‘ä¸Šæœäº†ä¸€å¤§åœˆ, å‘ç°éƒ½æ˜¯åŠ  ssh é…ç½®, å¢åŠ ä¸‹é¢çš„å†…å®¹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">  Hostname ssh.github.com</span><br><span class="line">  Port 443</span><br></pre></td></tr></table></figure>

<p>æ„æ€æ˜¯åŸå…ˆçš„ 22 ç«¯å£è¢«å¢™äº†, æ¢ä¸ª 443 çš„ç«¯å£å°±å¥½äº†.</p>
<p>è¿™ä¹ˆè¯•äº†ä¹‹åç¡®å®å¥½äº†, ä½†æ˜¯æ€»æ„Ÿè§‰å“ªé‡Œä¸å¯¹åŠ², å› ä¸ºæˆ‘çš„å°è±¡é‡Œ, åœ¨æŒ‡å®š <code>Hostname</code> çš„æƒ…å†µä¸‹, <code>Host</code> çš„ä½œç”¨æ˜¯åˆ«å.</p>
<p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªé…ç½®é¡¹çš„ä½œç”¨å…¶å®æ˜¯å°†æ‰€æœ‰è¿æ¥åˆ° <code>github.com</code> çš„æ¢åˆ°äº† <code>ssh.github.com</code>.</p>
<p>ç„¶åæˆ‘æŠŠ <code>Port 443</code> ç»™æ³¨é‡Šäº†, ç»“æœå‘ç°ä¹Ÿèƒ½è·‘é€š, è¿™è¯´æ˜å’Œç«¯å£å‹æ ¹æ²¡å•¥å…³ç³», çº¯ç²¹æ˜¯åŸŸåçš„é—®é¢˜.</p>
<p>åˆ†åˆ« ping ä¸€ä¸‹ä¸¤ä¸ªåŸŸå, å¯ä»¥å‘ç° <code>github.com</code> å®Œå…¨ä¸é€š, ä½†æ˜¯ <code>ssh.github.com</code> æ˜¯é€šçš„.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping github.com</span><br><span class="line"></span><br><span class="line">æ­£åœ¨ Ping github.com [20.205.243.166] å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:</span><br><span class="line">è¯·æ±‚è¶…æ—¶ã€‚</span><br><span class="line">è¯·æ±‚è¶…æ—¶ã€‚</span><br><span class="line">è¯·æ±‚è¶…æ—¶ã€‚</span><br><span class="line">è¯·æ±‚è¶…æ—¶ã€‚</span><br><span class="line"></span><br><span class="line">20.205.243.166 çš„ Ping ç»Ÿè®¡ä¿¡æ¯:</span><br><span class="line">    æ•°æ®åŒ…: å·²å‘é€ = 4ï¼Œå·²æ¥æ”¶ = 0ï¼Œä¸¢å¤± = 4 (100% ä¸¢å¤±)ï¼Œ</span><br><span class="line"></span><br><span class="line">$ ping ssh.github.com</span><br><span class="line"></span><br><span class="line">æ­£åœ¨ Ping ssh.github.com [20.205.243.160] å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:</span><br><span class="line">æ¥è‡ª 20.205.243.160 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´=95ms TTL=98</span><br><span class="line">æ¥è‡ª 20.205.243.160 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´=98ms TTL=98</span><br><span class="line">æ¥è‡ª 20.205.243.160 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´=111ms TTL=98</span><br><span class="line">æ¥è‡ª 20.205.243.160 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´=98ms TTL=98</span><br><span class="line"></span><br><span class="line">20.205.243.160 çš„ Ping ç»Ÿè®¡ä¿¡æ¯:</span><br><span class="line">    æ•°æ®åŒ…: å·²å‘é€ = 4ï¼Œå·²æ¥æ”¶ = 4ï¼Œä¸¢å¤± = 0 (0% ä¸¢å¤±)ï¼Œ</span><br><span class="line">å¾€è¿”è¡Œç¨‹çš„ä¼°è®¡æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½):</span><br><span class="line">    æœ€çŸ­ = 95msï¼Œæœ€é•¿ = 111msï¼Œå¹³å‡ = 100ms</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤, å¯ä»¥ç¡®å®šå°±æ˜¯æœ€è¿‘è§£æçš„ä¸»åŸŸå <code>github.com</code> çš„ IP è¢«å½»åº•å¢™äº†, ä½†æ˜¯ä¾› ssh è¿æ¥çš„å­åŸŸå <code>ssh.github.com</code> IP è¿˜æ´»ç€.</p>
<p>å› æ­¤, è§£å†³æ–¹æ¡ˆå°±æ˜¯æ·»åŠ ä¸‹é¢çš„é…ç½®:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">  Hostname 20.205.243.160</span><br></pre></td></tr></table></figure>

<p>å°†ç°æœ‰çš„ <code>github.com</code> ä¸»æœºåæ¢ä¸€ä¸ªå¯ä»¥ç”¨çš„ IP.</p>
<p>å¦å¤–, æ‰¾åˆ°äº† Github å®˜æ–¹çš„æ–‡æ¡£ <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vYXV0aGVudGljYXRpb24vdHJvdWJsZXNob290aW5nLXNzaC91c2luZy1zc2gtb3Zlci10aGUtaHR0cHMtcG9ydA==">Using SSH over the HTTPS port<i class="fa fa-external-link-alt"></i></span>.</p>
<p>è¿™é‡Œé¢æ•™ä½ å¦‚ä½•åœ¨ 22 ç«¯å£ä¸å¯ç”¨æ—¶, è½¬ç”¨ 443 ç«¯å£, ä½†æ˜¯ 443 ç«¯å£å¿…é¡»ä½¿ç”¨ <code>ssh.github.com</code>. è¿™ä¹Ÿæ˜¯ç½‘ä¸Šå¤§éƒ¨åˆ†æ•™ç¨‹çš„å‡ºå¤„. ä½†æ˜¯ç”±äºè¿™ä¸ªé—®é¢˜ä¸æ˜¯ç«¯å£å¯¼è‡´çš„, å› æ­¤æ–¹æ³•æœ‰æ•ˆåªæ˜¯å·§åˆç½¢äº†.</p>
<p>æœ€å, Github å®˜æ–¹æä¾›äº†å®ƒä»¬çš„æœåŠ¡ IP èŒƒå›´, <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vYXV0aGVudGljYXRpb24va2VlcGluZy15b3VyLWFjY291bnQtYW5kLWRhdGEtc2VjdXJlL2Fib3V0LWdpdGh1YnMtaXAtYWRkcmVzc2Vz">About GitHub&#39;s IP addresses<i class="fa fa-external-link-alt"></i></span>, ä»é‡Œé¢å¯ä»¥æ‰¾ä¸€ä¸ª ssh è¿æ¥æˆåŠŸ, ç„¶åå†™åˆ°é…ç½®é‡Œ.</p>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>SSH</tag>
        <tag>Github</tag>
      </tags>
  </entry>
  <entry>
    <title>çœ‹é›ª 2023Â·KCTF ç¬¬åä¸€é¢˜è®¾è®¡æ€è·¯ä¸é¢˜è§£</title>
    <url>//posts/2023/10/07/kctf-2023/</url>
    <content><![CDATA[<p>åœ¨æˆ‘å¯¼å®‰æ’ä¸‹ä½œä¸ºé˜²å®ˆæ–¹å‡ºäº†ä¸ªé¢˜åˆ°<span class="exturl" data-url="aHR0cHM6Ly9jdGYua2FueHVlLmNvbS9nYW1lLXRlYW1fbGlzdC0xOS0zMy5odG0=">çœ‹é›ª 2023Â·KCTF<i class="fa fa-external-link-alt"></i></span> ä¸Š, <span class="exturl" data-url="aHR0cHM6Ly9jdGYua2FueHVlLmNvbS9nYW1lLXNlYXNvbl9maWdodC0yMzYuaHRt">ç¬¬åä¸€é¢˜ æ­¥æ­¥é€¼è¿‘<i class="fa fa-external-link-alt"></i></span>, æœ‰å¹¸æ‹¿äº†ç²¾è‡´å¥–, ç¬¬ä¸€æ¬¡å‚åŠ è¿™ç±»æ¯”èµ›, å±å®æ˜¯èµ°å¤§è¿äº†. è¿™é‡ŒæŠŠå‡ºé¢˜æ€è·¯å’Œé¢˜è§£è´´ä¸€ä¸‹, å’Œçœ‹é›ªçš„æ˜¯ä¸€æ ·çš„, åŸæ–‡é“¾æ¥ <span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc4NDc4Lmh0bQ==">https://bbs.kanxue.com/thread-278478.htm<i class="fa fa-external-link-alt"></i></span>.</p>
<span id="more"></span>

<h2 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h2><h3 id="è¾“å…¥ä¸ç»“æœ"><a href="#è¾“å…¥ä¸ç»“æœ" class="headerlink" title="è¾“å…¥ä¸ç»“æœ"></a>è¾“å…¥ä¸ç»“æœ</h3><p>ç®€å•è¯•é”™ä»¥åŠä½¿ç”¨ IDA è·å–ä¼ªä»£ç å¯ä»¥çŸ¥é“é¢˜ç›®çš„è¾“å…¥æ˜¯ä¸€ä¸ªä¸è¶…è¿‡ 10 ä½çš„åè¿›åˆ¶æ•°å­—, å¹¶ä¸”å°†èŒƒå›´é™åˆ¶åœ¨äº† 4K (0x1000) è‡³ 4G (0x100000000) ä¹‹é—´ (åŒ…å«ä¸¤å¤´ç«¯ç‚¹). æ‰€ä»¥è§£å‡ºæ­¤é¢˜çš„å…³é”®åœ¨äºå¼„æ¸…æ¥šé¢˜ç›®å¦‚ä½•å¯¹è¾“å…¥çš„æ•°å­—è¿›è¡ŒéªŒè¯.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***** çœç•¥å‰æ–‡ *****/</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input: &quot;</span>);</span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = _getchar();</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = v0 + <span class="number">1</span>;</span><br><span class="line">    _Buffer[v0] = v1;</span><br><span class="line">    <span class="keyword">if</span> ( v0 + <span class="number">1</span> &gt;= <span class="number">0xB</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">    _Buffer[v2] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v0 == <span class="number">9</span> &amp;&amp; _getchar() != <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_41;</span><br><span class="line">    ++v0;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt;= <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v0 &gt;= <span class="number">0xB</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_43:</span><br><span class="line">    __report_rangecheckfailure();</span><br><span class="line">    __debugbreak();</span><br><span class="line">    JUMPOUT(*(_DWORD *)__security_check_cookie);</span><br><span class="line">  &#125;</span><br><span class="line">  _Buffer[v0] = <span class="number">0</span>;</span><br><span class="line">LABEL_10:</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( _Buffer[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( ++v3 &lt;= <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !_Buffer[v3] )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_15:</span><br><span class="line">  <span class="keyword">if</span> ( sscanf_s(_Buffer, <span class="string">&quot;%lld&quot;</span>, &amp;x) == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = sprintf_s(v18, <span class="number">0xB</span>u, <span class="string">&quot;%lld&quot;</span>, x);</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">0</span> &amp;&amp; v4 &gt; <span class="number">0</span> &amp;&amp; v3 == v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( _Buffer[v5] == v18[v5] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( ++v5 &gt;= v3 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( SHIDWORD(x) &gt;= <span class="number">0</span> &amp;&amp; (SHIDWORD(x) &gt; <span class="number">0</span> || (_DWORD)x) )</span><br><span class="line">          &#123;</span><br><span class="line">            v6 = FindWindowW(<span class="string">L&quot;OLLYDBG&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            v7 = HIDWORD(x);</span><br><span class="line">            v8 = x;</span><br><span class="line">            <span class="keyword">if</span> ( v6 )</span><br><span class="line">            &#123;</span><br><span class="line">              v8 = x | <span class="number">0xFFFF</span>;</span><br><span class="line">              LODWORD(x) = x | <span class="number">0xFFFF</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( __PAIR__(HIDWORD(x), v8) - <span class="number">4096</span> &lt;= <span class="number">0xFFFFF000</span> )</span><br><span class="line"><span class="comment">/***** çœç•¥åæ–‡ *****/</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¾“å…¥é”™è¯¯, åˆ™å¼¹æ¡†æç¤º <code>Wrong answer!</code>, è¾“å…¥æ­£ç¡®åˆ™å¼¹æ¡†æç¤º <code>Accepted!</code>.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***** çœç•¥å‰æ–‡ *****/</span></span><br><span class="line">                    MessageBoxW(<span class="number">0</span>, <span class="string">L&quot;Accepted!&quot;</span>, <span class="string">L&quot;Result&quot;</span>, <span class="number">0x40</span>u);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_41:</span><br><span class="line">  MessageBoxW(<span class="number">0</span>, <span class="string">L&quot;Wrong answer!&quot;</span>, <span class="string">L&quot;Result&quot;</span>, <span class="number">0x10</span>u);</span><br><span class="line"><span class="comment">/***** çœç•¥åæ–‡ *****/</span></span><br></pre></td></tr></table></figure>

<h3 id="éªŒè¯æœºåˆ¶"><a href="#éªŒè¯æœºåˆ¶" class="headerlink" title="éªŒè¯æœºåˆ¶"></a>éªŒè¯æœºåˆ¶</h3><p>ç¨‹åºåªæœ‰ä¸€äº›ç®€å•çš„åè°ƒè¯•æ£€æµ‹, æ²¡æœ‰å¤ªå¤š anti, ä¸»è¦éš¾åº¦è¿˜æ˜¯åœ¨ç®—æ³•åŸç†ä¸Š, å› æ­¤å¯ä»¥æ¯”è¾ƒå®¹æ˜“é€†å‘å‡ºç®—æ³•æµç¨‹å’Œå¯¹åº”çš„ä¼ªä»£ç .</p>
<p>æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸€ä¸ªç¼–ç ç®—æ³•å’Œä¸€ä¸ªè§£ç ç®—æ³•, è€Œè¾“å…¥çš„åºåˆ—å·æ˜¯ä¸¤ä¸ªç®—æ³•çš„å‚æ•°, ç¨‹åºé€šè¿‡å¯¹éšæœºè¾“å…¥è¿›è¡Œç¼–ç ä¸è§£ç æ“ä½œ, å¹¶æ£€æµ‹æ˜¯å¦èƒ½æ­£ç¡®è¿˜åŸå‡ºåŸå§‹è¾“å…¥åºåˆ—æ¥åˆ¤æ–­åºåˆ—å·æ˜¯å¦æ­£ç¡®.</p>
<p>ç”¨ IDA å¯ä»¥è¿˜åŸå‡ºç¼–ç å’Œè§£ç ç®—æ³•çš„ä¼ªä»£ç å¦‚ä¸‹:</p>
<p>ç¼–ç éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***** çœç•¥å‰æ–‡ *****/</span></span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v51 = v16;</span><br><span class="line">      v43 = v15;</span><br><span class="line">      <span class="keyword">if</span> ( v18 &gt;= <span class="number">10000</span> &amp;&amp; (v15 &lt; <span class="number">0</span> || v15 &lt;= <span class="number">0</span> &amp;&amp; !v16) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v19 &gt;= <span class="number">20000</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_38:</span><br><span class="line">        WaitForSingleObject(g_worker_mutex, <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        g_has_error = <span class="number">1</span>;</span><br><span class="line">        ReleaseMutex(g_worker_mutex);</span><br><span class="line">        v2 = v49;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_39;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v18 &gt;= <span class="number">10000</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = *(_DWORD *)&amp;v14[<span class="number">4</span> * v19];</span><br><span class="line">        v23 = __PAIR__(v15, v16) % v22;</span><br><span class="line">        HIDWORD(v53) = HIDWORD(v23);</span><br><span class="line">        v24 = __PAIR__(v15, v51) / v22;</span><br><span class="line">        v15 = (<span class="type">unsigned</span> __int64)(__PAIR__(v15, v51) / v22) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        v16 = v24;</span><br><span class="line">        v14 = v45;</span><br><span class="line">        *(_DWORD *)&amp;v50[<span class="number">4</span> * v19++] = v23;</span><br><span class="line">        v18 = v46;</span><br><span class="line">        v17 = (<span class="type">int</span>)v40;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v20 = *v40 + *(_DWORD *)(v17 + v54) * __PAIR__(v15, v16);</span><br><span class="line">        v15 = HIDWORD(v20);</span><br><span class="line">        v55 = v20;</span><br><span class="line">        v39 = *(_DWORD *)&amp;v45[<span class="number">4</span> * v19];</span><br><span class="line">        v16 = v20;</span><br><span class="line">        v53 = (<span class="type">signed</span> __int64)__PAIR__(v43, v51) % v39;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">signed</span> __int64)((<span class="type">signed</span> __int64)__PAIR__(v43, v51) / v39 * v20) &lt; (<span class="type">signed</span> __int64)__PAIR__(v56, v58) )</span><br><span class="line">        &#123;</span><br><span class="line">          v18 = v46 + <span class="number">1</span>;</span><br><span class="line">          v14 = v45;</span><br><span class="line">          v17 = (<span class="type">int</span>)(v40 + <span class="number">1</span>);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">        &#125;</span><br><span class="line">        v21 = (<span class="type">signed</span> __int64)__PAIR__(v43, v51) / v39;</span><br><span class="line">        v15 = v21 &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        v16 = v21;</span><br><span class="line">        v14 = v45;</span><br><span class="line">        *(_DWORD *)&amp;v50[<span class="number">4</span> * v19++] = v53;</span><br><span class="line">        v18 = v46;</span><br><span class="line">        v17 = (<span class="type">int</span>)v40;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/***** çœç•¥åæ–‡ *****/</span></span><br></pre></td></tr></table></figure>

<p>è§£ç éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***** çœç•¥å‰æ–‡ *****/</span></span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v54 = v30;</span><br><span class="line">      v52 = v27;</span><br><span class="line">      <span class="keyword">if</span> ( v25 &lt; <span class="number">0</span> &amp;&amp; (v27 &lt; <span class="number">0</span> || v27 &lt;= <span class="number">0</span> &amp;&amp; !v30) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v28 &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_38;</span><br><span class="line">      <span class="keyword">if</span> ( v25 &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v34 = *((_DWORD *)in_r + v28);</span><br><span class="line">        HIDWORD(v53) = (<span class="type">unsigned</span> __int64)(__PAIR__(v27, v54) % v34) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        v35 = __PAIR__(v27, v54) / v34;</span><br><span class="line">        v27 = (<span class="type">unsigned</span> __int64)(__PAIR__(v27, v54) / v34) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        v30 = v35;</span><br><span class="line">        v33 = (<span class="type">unsigned</span> <span class="type">int</span>)(__PAIR__(v52, v54) % v34) == v49[v28];</span><br><span class="line">LABEL_34:</span><br><span class="line">        <span class="keyword">if</span> ( !v33 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_38;</span><br><span class="line">        v25 = v47;</span><br><span class="line">        --v28;</span><br><span class="line">        v29 = (<span class="type">int</span>)v41;</span><br><span class="line">        v26 = v44;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v31 = *(_DWORD *)v41 + *(_DWORD *)(v26 + v29) * __PAIR__(v27, v30);</span><br><span class="line">        v27 = HIDWORD(v31);</span><br><span class="line">        LODWORD(v53) = v31;</span><br><span class="line">        v32 = *((_DWORD *)in_r + v28);</span><br><span class="line">        v30 = v31;</span><br><span class="line">        v55 = __PAIR__(v52, v54) % v32;</span><br><span class="line">        b_high = (<span class="type">unsigned</span> __int64)(__PAIR__(v52, v54) / v32) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        b_low = __PAIR__(v52, v54) / v32;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">signed</span> __int64)(__PAIR__(v52, v54) / v32 * v31) &gt;= *(_QWORD *)parameters )</span><br><span class="line">        &#123;</span><br><span class="line">          v30 = b_low;</span><br><span class="line">          v27 = b_high;</span><br><span class="line">          v33 = v55 == v49[v28];</span><br><span class="line">          <span class="keyword">goto</span> LABEL_34;</span><br><span class="line">        &#125;</span><br><span class="line">        v25 = v47 - <span class="number">1</span>;</span><br><span class="line">        v26 = v44;</span><br><span class="line">        v29 = (<span class="type">int</span>)(v41 - <span class="number">4</span>);</span><br><span class="line">        --v47;</span><br><span class="line">        v41 -= <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/***** çœç•¥åæ–‡ *****/</span></span><br></pre></td></tr></table></figure>

<p>ç®—æ³•æµç¨‹ä¸æ˜¯å¤ªå¤æ‚, å¯ä»¥çœ‹å‡ºæ˜¯ä¸€ç§è‡ªå®šä¹‰çš„æ··åˆè¿›åˆ¶ç¼–è§£ç ç®—æ³•, è€Œè¾“å…¥çš„åºåˆ—å·ä½œä¸ºå‚æ•°æ¥æ§åˆ¶ç®—æ³•æ­£ç¡®è¿è¡Œ, ç®—æ³•æ¶‰åŠåˆ°çš„å…³é”®å‚æ•°å¦‚ä¸‹å›¾:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***** çœç•¥å‰æ–‡ *****/</span></span><br><span class="line">  in_r = _calloc(<span class="number">10000u</span>, <span class="number">4u</span>);</span><br><span class="line">  in = _calloc(<span class="number">10000u</span>, <span class="number">4u</span>);</span><br><span class="line">  v2 = in;</span><br><span class="line">  v49 = in;</span><br><span class="line">  out_r = (<span class="type">char</span> *)_calloc(<span class="number">20000u</span>, <span class="number">4u</span>);</span><br><span class="line">  v4 = out_r;</span><br><span class="line">  v45 = out_r;</span><br><span class="line">  out = (<span class="type">char</span> *)_calloc(<span class="number">20000u</span>, <span class="number">4u</span>);</span><br><span class="line"><span class="comment">/***** çœç•¥ç‰‡æ®µ *****/</span></span><br><span class="line">    b_low = *(_DWORD *)parameters;</span><br><span class="line">    v17 = (<span class="type">int</span>)v49;</span><br><span class="line">    b_high = *((_DWORD *)parameters + <span class="number">1</span>);</span><br><span class="line"><span class="comment">/***** çœç•¥åæ–‡ *****/</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>b</code>: è¾“å…¥çš„åºåˆ—å·æ•´æ•°.</li>
<li><code>in</code>: éšæœºè¾“å…¥åºåˆ—.</li>
<li><code>in_r</code>: éšæœºè¾“å…¥åºåˆ—çš„è¿›åˆ¶åºåˆ—.</li>
<li><code>out_</code> å¼€å¤´çš„åˆ™æ˜¯è¾“å‡ºç»“æœ.</li>
</ul>
<p>è§£ç ç®—æ³•æµç¨‹ä¸ç¼–ç ç®—æ³•å‡ ä¹ä¸€è‡´, ä½†æ˜¯æŠŠç¼–ç çš„è¾“å…¥å’Œè¾“å‡ºäº¤æ¢äº†ä¸€ä¸‹, åŒæ—¶è¿›è¡Œäº†å€’åºå¤„ç†, å¹¶å¯¹è§£ç åºåˆ—ä¸åŸå§‹éšæœºè¾“å…¥åºåˆ—è¿›è¡Œæ¯”è¾ƒ, åˆ¤æ–­æ˜¯å¦è¿˜åŸæˆåŠŸ.</p>
<p>è€ŒéªŒè¯æ­¥éª¤çš„å…³é”®ä¼ªä»£ç è¿˜åŸå¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***** çœç•¥å‰æ–‡ ******/</span></span><br><span class="line">                  g_has_error = <span class="number">0</span>;</span><br><span class="line">                  v9 = <span class="number">0</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( check_error_in_x(__PAIR__(v7, v8)) )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="keyword">if</span> ( !g_has_error )</span><br><span class="line">                    &#123;</span><br><span class="line">                      g_has_error = <span class="number">0</span>;</span><br><span class="line">                      <span class="keyword">if</span> ( check_error_in_x(__PAIR__(v7, v8) - <span class="number">1</span>) )</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( g_has_error )</span><br><span class="line">                          v9 = <span class="number">1</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line"><span class="comment">/***** çœç•¥åæ–‡ ******/</span></span><br></pre></td></tr></table></figure>

<p>è¦æ±‚å¯¹äºè¾“å…¥çš„ <code>b</code> èƒ½å¤Ÿä½¿ç®—æ³•æ­£ç¡®å·¥ä½œ, ä½†æ˜¯ <code>b - 1</code> ä¸èƒ½ä½¿ç®—æ³•æ­£ç¡®å·¥ä½œ.</p>
<h2 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h2><h3 id="æš´åŠ›æšä¸¾"><a href="#æš´åŠ›æšä¸¾" class="headerlink" title="æš´åŠ›æšä¸¾"></a>æš´åŠ›æšä¸¾</h3><p>æ­¤é¢˜çš„è¾“å…¥æ•°æ®èŒƒå›´æ˜¯ä»‹äº 4K åˆ° 4G ä¹‹é—´çš„ä¸€ä¸ªæ•´æ•°, å¯ä»¥è€ƒè™‘æŠŠæ ¸å¿ƒç®—æ³•å•ç‹¬æ‘˜å‡ºæ¥æ•´ç†é‡å†™, ç„¶åè¿›è¡Œæš´åŠ›æšä¸¾.</p>
<p>ä½†æ˜¯æšä¸¾çš„éš¾åº¦åœ¨äº, åŸç¨‹åºä½¿ç”¨çš„éšæœºè¾“å…¥åºåˆ—é•¿åº¦ä¸º <code>10000</code>, ä¸”ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œäº†çº¦ <code>10000</code> è½®æµ‹è¯•, ä¹Ÿå°±æ˜¯è¯´çº¯éšæœºæƒ…å†µä¸‹, å¦‚æœæ•°æ®é‡ä¸å¤Ÿå¤§, å¾ˆå¯èƒ½é€ æˆè¯¯åˆ¤, ä»è€Œæ— æ³•æšä¸¾å‡ºæ­£ç¡®çš„åºåˆ—å·, å› æ­¤æšä¸¾çš„æ—¶é—´æˆæœ¬å¾ˆé«˜, åªæ˜¯ä¸€ä¸ªä¿åº•ä¸‹ç­–.</p>
<h3 id="å…¬å¼æšä¸¾"><a href="#å…¬å¼æšä¸¾" class="headerlink" title="å…¬å¼æšä¸¾"></a>å…¬å¼æšä¸¾</h3><p>ç¨‹åºçš„ç®—æ³•æ˜¯ä¸€ä¸ªç”¨äºæ··åˆè¿›åˆ¶åºåˆ—çš„ç¼–è§£ç ç®—æ³•, ä¸”éœ€è¦ä¸€ä¸ªæ§åˆ¶å‚æ•°æ¥ä½¿ç®—æ³•æ­£ç¡®å·¥ä½œ. è€Œç¨‹åºçš„éªŒè¯æœºåˆ¶æ˜¯ <code>b</code> æ­£ç¡®ä¸” <code>b - 1</code> é”™è¯¯, å¯ä»¥åˆç†æ¨æµ‹èƒ½å¤Ÿä½¿ç®—æ³•æ­£ç¡®å·¥ä½œçš„å‚æ•°ä¸æ­¢ä¸€ä¸ª, åº”è¯¥æ˜¯ä¸€ä¸ªè¿ç»­åŒºé—´, ä¸”é¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆæ˜¯è¿™ä¸ªåŒºé—´çš„å·¦ç«¯ç‚¹, å› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾å‡ºå‚æ•°çš„å–å€¼è§„å¾‹, ä»è€Œå¿«é€Ÿæ±‚è§£ç­”æ¡ˆ.</p>
<p>ç¿»ä¸€ä¸‹é€†å‘åçš„ä»£ç , å¯ä»¥æ‰¾åˆ°ç¨‹åºä½¿ç”¨çš„è¿›åˆ¶é›†æ˜¯ <code>&#123; 2, 4, 5, 6, 7, 8, 13 &#125;</code>, ä¸”è¾“å…¥å’Œè¾“å‡ºä½¿ç”¨äº†åŒä¸€ç»„è¿›åˆ¶.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.rdata:004031C8 _TEST_RADIX_LEN:</span><br><span class="line">.rdata:004031C8                 dw 7, 0</span><br><span class="line">.rdata:004031CC ; int TEST_RADIX[]</span><br><span class="line">.rdata:004031CC _TEST_RADIX     dd 2, 4, 5, 6, 7, 8, 13 ; DATA XREF: do_error_check(x)+114</span><br><span class="line">.rdata:004031CC                                         ; do_error_check(x)+15E</span><br></pre></td></tr></table></figure>

<p>çŒœæƒ³ <code>b</code> çš„å–å€¼ä¸è¿›åˆ¶ç»„åˆæœ‰å…³, å› æ­¤å¯ä»¥ä»ç®€å•çš„å…¥æ‰‹, æš´åŠ›æšä¸¾å°åŒºé—´, å¯»æ‰¾è§„å¾‹.</p>
<p>åˆ†åˆ«è®¾ç½®ä»¥ä¸‹å‡ ç§æ–¹å¼å»è¿›è¡Œæšä¸¾, å¯ä»¥å¾—åˆ°æ­£ç¡®çš„å–å€¼åŒºé—´å¦‚ä¸‹:</p>
<ul>
<li>è¾“å…¥è¿›åˆ¶ <code>&#123; 2 &#125;</code>, è¾“å‡ºè¿›åˆ¶ <code>&#123; 2 &#125;</code>: <code>[1, 5], [7, 18], [21, 39], [43, 68], [73, 105], ...</code></li>
<li>è¾“å…¥è¿›åˆ¶ <code>&#123; 2 &#125;</code>, è¾“å‡ºè¿›åˆ¶ <code>&#123; 3 &#125;</code>: <code>[1, 7], [11, 26], [33, 57], [67, 100], [113, 155], ...</code></li>
<li>è¾“å…¥è¿›åˆ¶ <code>&#123; 3 &#125;</code>, è¾“å‡ºè¿›åˆ¶ <code>&#123; 3 &#125;</code>: <code>[1, 10], [17, 38], [51, 84], [103, 148], ...</code></li>
<li>è¾“å…¥è¿›åˆ¶ <code>&#123; 2 &#125;</code>, è¾“å‡ºè¿›åˆ¶ <code>&#123; 2, 3 &#125;</code>: <code>[1, 5], [7, 7], [11, 18], [21, 26], [33, 39], [43, 57], [67, 68], [73, 100], [113, 150], ...</code></li>
<li>è¾“å…¥è¿›åˆ¶ <code>&#123; 2, 3 &#125;</code>, è¾“å‡ºè¿›åˆ¶ <code>&#123; 2, 3 &#125;</code>: <code>[1, 5], [7, 7], [17, 18], [21, 26], [33, 38], [51, 57], [67, 68], [73, 84], [113, 148], ...</code></li>
</ul>
<p>è§‚å¯Ÿä¸€ä¸‹å¯ä»¥å‘ç°, å¯¹äºæ··åˆè¿›åˆ¶çš„æƒ…å†µ, æ­£ç¡®çš„å–å€¼åŒºé—´æ˜¯é€šè¿‡å•ä¸ªçš„è¾“å…¥è¾“å‡ºè¿›åˆ¶çš„å–å€¼åŒºé—´å–äº¤é›†å¾—åˆ°çš„:</p>
<ul>
<li><code>&#123; 2 &#125;_&#123; 2, 3 &#125; = &#123; 2 &#125;_&#123; 2 &#125; &amp; &#123; 2 &#125;_&#123; 3 &#125;</code></li>
<li><code>&#123; 2, 3 &#125;_&#123; 2, 3 &#125; = &#123; 2 &#125;_&#123; 2, 3 &#125; &amp; &#123; 3 &#125;_&#123; 3 &#125;</code></li>
</ul>
<p>å› æ­¤, åªè¦èƒ½æ‰¾å‡ºå•ä¸ªçš„è¾“å…¥è¾“å‡ºè¿›åˆ¶çš„å–å€¼åŒºé—´è§„å¾‹å°±èƒ½è§£å‡ºé¢˜ç›®.</p>
<p>ç»§ç»­è§‚å¯Ÿå¯»æ‰¾è§„å¾‹, å¯ä»¥å‘ç°è§„å¾‹:</p>
<ul>
<li><code>&#123; 2 &#125;_&#123; 2 &#125;</code>: <code>[4 * n^2 - (4 + 2) * n + 3, 4 * n^2 + n]</code></li>
<li><code>&#123; 2 &#125;_&#123; 3 &#125;</code>: <code>[6 * n^2 - (6 + 2) * n + 3, 6 * n^2 + n]</code></li>
<li><code>&#123; 3 &#125;_&#123; 3 &#125;</code>: <code>[9 * n^2 - (9 + 2) * n + 3, 9 * n^2 + n]</code></li>
</ul>
<p>å› æ­¤å¯ä»¥å¾—åˆ°é€šé¡¹å…¬å¼ä¸º: <code>[r1 * r2 * n^2 - (r1 * r2 + 2) * n + 3, r1 * r2 * n^2 + n]</code></p>
<p>è€Œé¢˜ç›®ä½¿ç”¨äº† 7 ç§ä¸åŒçš„è¿›åˆ¶, ä¸”è¾“å…¥è¾“å‡ºè¿›åˆ¶ç›¸åŒ, å› æ­¤å…±éœ€è¦æšä¸¾ 21 ç§æƒ…å†µ, ç„¶åå–äº¤é›†æœ€ç»ˆå¾—åˆ°é¢˜ç›®é‡Œæ­£ç¡®çš„å–å€¼èŒƒå›´, å¹¶å–å·¦ç«¯ç‚¹ä½œä¸ºåºåˆ—å·.</p>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯, å–äº¤é›†è¿™ä¸ªæ“ä½œå¹¶ä¸é«˜æ•ˆ, ä½†æ˜¯å¯ä»¥ç¿»è¿‡æ¥æ“ä½œ, æ¯æ¬¡å°†é”™è¯¯å–å€¼åŒºé—´ç­›å», èƒ½å¤Ÿæ›´å¿«é€Ÿçš„è®¡ç®—å‡ºæ­£ç¡®ç­”æ¡ˆ, è¿™é‡Œè´´ä¸€ä¸‹æ ¸å¿ƒè®¡ç®—ä»£ç .</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">search_b</span><span class="params">(<span class="type">long</span> <span class="type">long</span> start, <span class="type">long</span> <span class="type">long</span> end)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> p = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> n_s = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> n_e = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> b1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> b2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> b_count = end - start + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>* full_set = <span class="built_in">calloc</span>((<span class="type">size_t</span>)b_count, <span class="keyword">sizeof</span>(<span class="type">bool</span>));</span><br><span class="line">    <span class="keyword">if</span> (!full_set)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(full_set, <span class="number">1</span>, (<span class="type">size_t</span>)b_count * <span class="keyword">sizeof</span>(<span class="type">bool</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; in_r_len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = i; j &lt; out_r_len; j++) &#123;</span><br><span class="line">            p = in_r[i] * out_r[j];</span><br><span class="line">            n_s = left_floor(p, start);</span><br><span class="line">            n_e = right_ceil(p, end);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="type">long</span> n = n_s; n &lt;= n_e; n++) &#123;</span><br><span class="line">                b1 = left(p, n);</span><br><span class="line">                b2 = right(p, n);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (b1 &lt; start)</span><br><span class="line">                    b1 = start;</span><br><span class="line">                <span class="keyword">if</span> (b2 &gt; end)</span><br><span class="line">                    b2 = end;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (<span class="type">long</span> <span class="type">long</span> b_idx = b1 - start; b_idx &lt;= b2 - start; b_idx++) &#123;</span><br><span class="line">                    full_set[b_idx] = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> <span class="type">long</span> b_s = <span class="number">0</span>; b_s &lt; b_count; b_s++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (full_set[b_s]) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="type">long</span> b_e = b_s; b_e &lt; b_count; b_e++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!full_set[b_e]) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;Valid: [%lld, %lld] Count: %lld\n&quot;</span>, b_s + start, b_e - <span class="number">1</span> + start, b_e - b_s);</span><br><span class="line">                    b_s = b_e;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (full_set)</span><br><span class="line">        <span class="built_in">free</span>(full_set);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æœ€ç»ˆç­”æ¡ˆ"><a href="#æœ€ç»ˆç­”æ¡ˆ" class="headerlink" title="æœ€ç»ˆç­”æ¡ˆ"></a>æœ€ç»ˆç­”æ¡ˆ</h3><p>æœ€åç®—å‡ºæ¥é¢˜ç›®çš„è¿›åˆ¶ç»„åˆä¸‹ 100 äº¿èŒƒå›´å†…åªæœ‰è¿™äº›æ­£ç¡®åŒºé—´:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Valid: [1, 5] Count: 5</span><br><span class="line">Valid: [7, 9] Count: 3</span><br><span class="line">Valid: [1898766093, 1898766391] Count: 299</span><br><span class="line">Valid: [79233213543, 79233230703] Count: 17161</span><br></pre></td></tr></table></figure>

<p>é¢˜ç›®è¦æ±‚èŒƒå›´åœ¨ 4K åˆ° 4G çš„èŒƒå›´, å› æ­¤åºåˆ—å·ä¸º <code>1898766093</code>, è¾“å…¥ä¹‹åå¾—åˆ°æ­£ç¡®ç»“æœ <code>Accepted!</code>.</p>
<h2 id="é¢˜ç›®åŠæºä»£ç "><a href="#é¢˜ç›®åŠæºä»£ç " class="headerlink" title="é¢˜ç›®åŠæºä»£ç "></a>é¢˜ç›®åŠæºä»£ç </h2><p>çœ‹é›ªçš„å¸–å­é‡Œæœ‰ä¸‹è½½åœ°å€, è¿™é‡Œä¹Ÿè´´ä¸€ä¸‹è“å¥äº‘çš„ä¸‹è½½é“¾æ¥.</p>
<p>è“å¥äº‘: <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pTnM5bzFiZHBnMGg=">2023KCTFç«èµ›.zip<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>çœ‹é›ª</tag>
        <tag>KCTF</tag>
        <tag>é€†å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³å­¦ä¹ é“è·¯ä¸Šçš„ &quot;æœ€å 1 KB&quot;</title>
    <url>//posts/2022/08/14/kxsw/</url>
    <content><![CDATA[<p><code>Github</code> æ—¶æ–­æ—¶è¿? <code>git clone</code> è€æ˜¯å¤±è´¥? è°·æ­Œå­¦æœ¯æ— æ³•ä½¿ç”¨? ......</p>
<p>æ²¡æœ‰å…³ç³»! çœ‹äº†æœ¬ç¯‡ä»¥å, ä»æ­¤ä¸åœ¨æ‹…å¿§, è®©ä½ åœ¨äº’è”ç½‘çš„ä¸–ç•Œé‡Œç•…é€šæ— é˜».</p>
<p>æœ¬ç¯‡ä¸ºä¸€ç¯‡å°ç™½å…¥é—¨, æ—¨åœ¨ç®€å•ä»‹ç»è§£å†³ä¸Šè¿°é—®é¢˜çš„åŸºæœ¬æ–¹æ¡ˆ, è®©ä½ æ‰«æ¸…ä¸Šç½‘æ—¶çš„ &quot;æœ€å 1 KB&quot;.</p>
<span id="more"></span>

<h2 id="å·¥å…·ä¸‹è½½"><a href="#å·¥å…·ä¸‹è½½" class="headerlink" title="å·¥å…·ä¸‹è½½"></a>å·¥å…·ä¸‹è½½</h2><p>è¿™é‡Œåªè¯´åŸºäº <code>V2Ray</code> çš„ä¸¤ä¸ªå·¥å…·, åˆ†åˆ«ç”¨äº PC ç«¯å’Œå®‰å“ç«¯. å…ˆé™„ä¸Šä¸¤ä¸ªå·¥å…·çš„ Github å®˜æ–¹åœ°å€.</p>
<p>PC ç«¯ <code>V2RayN</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzJkdXN0L3YycmF5Ti8=">Github é¡¹ç›®åœ°å€<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzJkdXN0L3YycmF5Ti9yZWxlYXNlcy8=">ä¸‹è½½é¡µé¢<i class="fa fa-external-link-alt"></i></span></p>
<p>å®‰å“ç«¯ <code>V2RayNG</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzJkdXN0L3YycmF5Tkcv">Github é¡¹ç›®åœ°å€<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLzJkdXN0L3YycmF5TkcvcmVsZWFzZXMv">ä¸‹è½½é¡µé¢<i class="fa fa-external-link-alt"></i></span></p>
<p>è€ƒè™‘åˆ°å¾ˆå¤šäººä¸€å¼€å§‹æ˜¯æ²¡æœ‰è¿™äº›å·¥å…·çš„, è€Œè¿™äº›å·¥å…·çš„ä¸‹è½½åˆå¯èƒ½éœ€è¦å·¥å…·æœ¬èº«æ”¯æŒ, æ‰€ä»¥é¢å¤–æ”¾ä¸€ä¸ª <code>V2RayN-Core v5.32</code> çš„ç½‘ç›˜<span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pUG0wUzA5ajZ2cWgv">ä¸‹è½½åœ°å€<i class="fa fa-external-link-alt"></i></span> (å‹ç¼©åŒ…å“ˆå¸Œæ ¡éªŒä¼šä¸å®˜ç½‘ä¸‹è½½ä¸åŒ, å› ä¸ºé‡æ–°æ‰“åŒ…è¿‡å†ä¸Šä¼ çš„).</p>
<p><img data-src="/static/image/kxsw/vUBwJU.jpg" alt="vUBwJU.jpg"></p>
<h2 id="å·¥å…·ä½¿ç”¨"><a href="#å·¥å…·ä½¿ç”¨" class="headerlink" title="å·¥å…·ä½¿ç”¨"></a>å·¥å…·ä½¿ç”¨</h2><p>ç½‘ä¸Šæ•™ç¨‹å¾ˆå¤š, è¿™é‡Œç›´æ¥æ”¾ä¸€ä¸‹çœ‹èµ·æ¥æ˜¯å®˜æ–¹çš„<span class="exturl" data-url="aHR0cHM6Ly92MnJheW4ub3JnLw==">æ•™ç¨‹ç½‘ç«™<i class="fa fa-external-link-alt"></i></span>.</p>
<p>åœ¨è¿™é‡Œåªç®€å•ç§‘æ™®ä¸€ä¸‹åŸºæœ¬æ¦‚å¿µ.</p>
<p>æ—¢ç„¶ç”±äºä¸å¯æŠ—åŠ›å¯¼è‡´ç›´æ¥è¿æ¥ç½‘ç«™çš„æ•ˆæœå¾ˆå·®, ç”šè‡³æ— æ³•è¿æ¥, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ‰¾äººå¸®å¿™, æ‰¾é‚£äº›è®¿é—®é€Ÿåº¦è¾ƒå¥½çš„ &quot;ä¸­é—´äºº&quot; å¸®æˆ‘ä»¬è®¿é—®, æˆ‘ä»¬å†ä»ä¸­é—´äººé‚£é‡Œé—´æ¥è·å¾—éœ€è¦çš„ä¿¡æ¯, è¿™ç§ &quot;ä¸­é—´äºº&quot; å°±ç§°ä¸º &quot;èŠ‚ç‚¹&quot;.</p>
<p>ä½†æ˜¯æˆ‘ä»¬è‡ªå·±æ˜¯æ— æ³•ç›´æ¥å’ŒèŠ‚ç‚¹è¿›è¡Œäº¤äº’çš„, æ‰€ä»¥éœ€è¦å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬ä¼ é€’éœ€æ±‚, è€Œå¯¹äº <code>V2Ray</code> è¿™ä¸€ç±»å·¥å…·å®¢æˆ·ç«¯, å…¶å·¥ä½œæ–¹å¼æ˜¯åœ¨ä½ è‡ªå·±çš„æœºå™¨ä¸Šæ­å»ºä¸€ä¸ªæœ¬åœ°çš„ &quot;ä»£ç†æœåŠ¡å™¨&quot;, ä»è€Œæˆ‘ä»¬å¯ä»¥è®¿é—®æœ¬åœ°çš„ä»£ç†æœåŠ¡å™¨, è¿›è€Œè®¿é—®åˆ°èŠ‚ç‚¹, ä¸‹é¢æ”¾ä¸€ä¸ªå¯¹æ¯”.</p>
<p>ä¸ä½¿ç”¨å·¥å…·å‰:</p>
<p><code>ç”¨æˆ· --|--&gt; ç›®æ ‡ç½‘ç«™</code></p>
<p>ä½¿ç”¨å·¥å…·å:</p>
<p><code>ç”¨æˆ· --&gt; æœ¬åœ°ä»£ç† --&gt; èŠ‚ç‚¹ --&gt; ç›®æ ‡ç½‘ç«™</code></p>
<p>æ‰€ä»¥å¯¹ä½¿ç”¨å·¥å…·æ¥è¯´, æ¯”è¾ƒé‡è¦çš„ä¿¡æ¯æ˜¯, ä»£ç†æœåŠ¡å™¨è®¾ç½®æ˜¯ä»€ä¹ˆ, ä»¥åŠä½¿ç”¨çš„èŠ‚ç‚¹æ˜¯ä»€ä¹ˆ.</p>
<h3 id="ä½¿ç”¨ä»£ç†"><a href="#ä½¿ç”¨ä»£ç†" class="headerlink" title="ä½¿ç”¨ä»£ç†"></a>ä½¿ç”¨ä»£ç†</h3><p>PC ç«¯ä¸Š, <code>V2RayN</code> çš„æœ¬åœ°ä»£ç†é»˜è®¤ç›‘å¬åœ°å€æ˜¯ <code>127.0.0.1</code>, å…¶ä¸­ <code>http</code> åè®®çš„ç«¯å£æ˜¯ <code>10809</code>, <code>socks</code> åè®®çš„ç«¯å£æ˜¯ <code>10808</code>.</p>
<p>å¯åŠ¨ <code>V2RayN</code> å®¢æˆ·ç«¯ä¹‹å, å³é”®ç‚¹å‡»é€šçŸ¥æ çš„å›¾æ ‡, åœ¨ç³»ç»Ÿä»£ç†å†…æœ‰ä¸‰ä¸ªé€‰é¡¹.</p>
<ul>
<li>æ¸…é™¤ç³»ç»Ÿä»£ç†: æ¸…é™¤æ‰åœ¨ç³»ç»Ÿè®¾ç½®å†…çš„ä»£ç†è®¾ç½®.</li>
<li>è‡ªåŠ¨é…ç½®ç³»ç»Ÿä»£ç†: å°†ç³»ç»Ÿè®¾ç½®å†…çš„ä»£ç†è®¾ç½®ä¸º <code>V2RayN</code> çš„ä»£ç†æœåŠ¡å™¨.</li>
<li>ä¸æ”¹å˜ç³»ç»Ÿä»£ç†: ä¿æŒåŸæœ‰ç³»ç»Ÿä»£ç†è®¾ç½®ä¸å˜.</li>
</ul>
<p>è¿™æ˜¯ä¸ªè®©æˆ‘ä»¬å¿«é€Ÿæ›´æ”¹ç³»ç»Ÿä»£ç†è®¾ç½®çš„é€‰é¡¹, é™¤æ­¤ä¹‹å¤–, æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å»ç³»ç»Ÿè®¾ç½®é‡Œçš„ <code>ç½‘ç»œå’Œ Internet -&gt; ä»£ç† -&gt; æ‰‹åŠ¨è®¾ç½®ä»£ç†</code> è°ƒæ•´ç³»ç»Ÿè¦ä½¿ç”¨çš„ä»£ç†æœåŠ¡å™¨.</p>
<p>å½“ç³»ç»Ÿä»£ç†è¢«è®¾ç½®ä¹‹å, å‡¡æ˜¯åªèƒ½é€šè¿‡ç³»ç»Ÿä»£ç†çš„è½¯ä»¶ <code>http</code> åè®®æµé‡, æ¯”å¦‚ <code>Edge</code> å’Œ <code>Chrome</code> æµè§ˆå™¨ç­‰, éƒ½ä¼šç»è¿‡ <code>V2RayN</code> æ¥è½¬å‘ç»™èŠ‚ç‚¹, ä»è€Œè®¿é—®åˆ°ç›®æ ‡ç½‘ç«™.</p>
<p>ä½†æ˜¯æŸäº›ç¨‹åºæ˜¯å¯ä»¥å•ç‹¬è®¾ç½®ä½¿ç”¨ä»£ç†æœåŠ¡å™¨çš„, æ¯”å¦‚ <code>Firefox</code> æµè§ˆå™¨, è¿™ç§å°±éœ€è¦è‡ªå·±å»æµè§ˆå™¨è®¾ç½®é‡Œæ‰‹åŠ¨è®¾ç½®ä»£ç†.</p>
<p><img data-src="/static/image/kxsw/vUyCmd.png" alt="vUyCmd.png"></p>
<p>ä¸ªäººæ¨èå¤‡ä¸€ä¸ª <code>Firefox</code> æµè§ˆå™¨, è¿™æ ·å­å¯ä»¥å•ç‹¬æŠŠä»£ç†æŒ‚ç»™æµè§ˆå™¨è€Œä¸æ˜¯å½±å“å…¨å±€, æ—¢å¯ä»¥è®¿é—®å›½å¤–ç½‘ç«™ä¹Ÿä¸å½±å“ä½¿ç”¨ <code>Edge</code> ç­‰æµè§ˆå™¨è®¿é—®å›½å†…ç½‘ç«™.</p>
<h3 id="ä½¿ç”¨èŠ‚ç‚¹ä¸è®¢é˜…"><a href="#ä½¿ç”¨èŠ‚ç‚¹ä¸è®¢é˜…" class="headerlink" title="ä½¿ç”¨èŠ‚ç‚¹ä¸è®¢é˜…"></a>ä½¿ç”¨èŠ‚ç‚¹ä¸è®¢é˜…</h3><p>ä¸€ä¸ªèŠ‚ç‚¹é€šå¸¸é•¿è¿™æ ·.</p>
<p><code>&lt;åè®®&gt;://&lt;å†…å®¹&gt;</code></p>
<p><code>vmess://55yL5ZWl5ZGi77yf5rKh5pyJ6IqC54K55L+h5oGv77yB</code></p>
<p>ç›´æ¥ <code>Ctrl + C</code> å¤åˆ¶å†…å®¹ç„¶åè¿›å…¥å®¢æˆ·ç«¯ <code>Ctrl + V</code> å°±å¯ä»¥å¯¼å…¥èŠ‚ç‚¹ä¿¡æ¯äº†.</p>
<p>è¿™ç§æ—¶å€™å°±ä¼šæœ‰äººè¯´äº†, ä¸€ä¸ªä¸ªèŠ‚ç‚¹å¯¼å…¥å¤ªéº»çƒ¦, è€Œä¸”èŠ‚ç‚¹è¯´ä¸å®šä»€ä¹ˆæ—¶å€™å°±ä¼šå¤±æ•ˆ, è¿˜å¾—é‡æ–°ä¸€ä¸ªä¸ªæ‰¾. æ‰€ä»¥, è®¢é˜…åœ°å€å®ƒå‡ºç°äº†.</p>
<p>æ¯”å¦‚æœ‰ä¸ªç™½å«–è®¢é˜…åœ°å€ <span class="exturl" data-url="aHR0cHM6Ly9qaWFuZy5uZXRsaWZ5LmNvbS8=">https://jiang.netlify.com/<i class="fa fa-external-link-alt"></i></span>, ä½ ç‚¹å¼€äº†ç›´æ¥çœ‹å°±ä¼šå‘ç°æ˜¯ä¸€å¤§å †çš„å­—ç¬¦, å…¶å®æ˜¯ä¸€ä¸ªä¸ªçš„èŠ‚ç‚¹ä¿¡æ¯, å¹¶ä¸”æ¯éš”ä¸€æ®µæ—¶é—´å†…å®¹è¿˜ä¸ä¸€æ ·, ä¹Ÿå°±æ˜¯èŠ‚ç‚¹ä¿¡æ¯è¢«æ›´æ–°äº†.</p>
<p>é‚£ä¹ˆ, åªè¦å¾€ <code>V2RayN</code> å®¢æˆ·ç«¯å†…æ·»åŠ è¿™ä¸ªè®¢é˜…åœ°å€, ä»¥åå†ä½¿ç”¨ &quot;æ›´æ–°è®¢é˜…&quot; çš„åŠŸèƒ½, å®¢æˆ·ç«¯å°±ä¼šè‡ªåŠ¨ä»è¿™ä¸ªåœ°å€è·å–èŠ‚ç‚¹ä¿¡æ¯å¹¶ä¸”æ›´æ–°è¯¥è®¢é˜…ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹, ä¸ºæˆ‘ä»¬æ‡’äººå¸¦æ¥ç¦éŸ³.</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>So, ä¸ºäº†è§£å†³ä¸Šç½‘çš„æœ€å &quot;1 KB&quot;, æˆ‘ä»¬éœ€è¦é¦–å…ˆè·å¾—å·¥å…·, ç„¶åè·å¾—èŠ‚ç‚¹ (æˆ–è€…è·å¾—è®¢é˜…åœ°å€), å†ç„¶åå¼€å¯è½¯ä»¶è®¾ç½®èŠ‚ç‚¹ä¸ä»£ç†, ä¹‹åå°±å¯ä»¥åœ¨å­¦ä¹ çš„é“è·¯ä¸Šç•…é€šæ— é˜»äº†<del>å¤©ç¿¼ 3G å¤ªå¿«äº†</del>.</p>
<p>è¿™é‡Œè´´ä¸€ä¸ªå¯ä»¥ç™½å«–çš„æœºåœºåœ°å€ <span class="exturl" data-url="aHR0cHM6Ly9wZXBzaWNvbGEubWUv">https://pepsicola.me<i class="fa fa-external-link-alt"></i></span> , æœ‰å…è´¹è®¢é˜…å¯ä»¥æ»¡è¶³æ—¥å¸¸åŸºæœ¬ä½¿ç”¨éœ€æ±‚<del>ä¸çŸ¥é“çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„æ—¶å€™æ˜¯å¦è¿˜è¿›å¾—å»</del>.</p>
<p>å°è¯•ä½¿ç”¨è°·æ­Œå­¦æœ¯æœç´¢ä¸€ç¯‡è®ºæ–‡, å¾ˆ nice, é¡·åˆ»ä¹‹é—´, å·²å°½æ•°åˆ—å‡º.</p>
<p><img data-src="/static/image/kxsw/vUc2TA.png" alt="vUc2TA.png"></p>
<p>PS: å°±è¿™ä¹ˆå¤šäº†(ã€‚_ã€‚), æœ‰å…´è¶£çš„åŒå­¦è¿˜è¯·å–„ç”¨æœç´¢å¼•æ“, å‘æŒ¥äº’è”ç½‘è‡ªä¸»æ¢ç´¢ç²¾ç¥.</p>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>ç§‘å­¦ä¸Šç½‘</tag>
      </tags>
  </entry>
  <entry>
    <title>PCA ç®—æ³•åŸç†ä¸å®ç°</title>
    <url>//posts/2023/02/18/pca/</url>
    <content><![CDATA[<p>PCA ç®—æ³•, ä¹Ÿå°±æ˜¯ä¸»æˆåˆ†åˆ†ææ³• (Principal Component Analysis), æ˜¯ä¸€ç§æ•°æ®é™ç»´ç®—æ³•, èƒ½å¤Ÿåœ¨å°½å¯èƒ½ä¿ç•™æ•°æ®ç‰¹å¾çš„åŒæ—¶å‹ç¼©æ•°æ®, é™ä½æ•°æ®å¤æ‚åº¦, ä¾¿äºæ•°æ®åˆ†æçš„è¿›è¡Œ.</p>
<p>æœ¬æ–‡ç®€è¦ä»‹ç» PCA ç®—æ³•çš„åŸºæœ¬æ€æƒ³ä¸æ•°å­¦æ¨å¯¼, å¹¶åœ¨æ–‡æœ«æä¾›å¯¹åº”çš„ <code>python</code> å®ç°.</p>
<span id="more"></span>

<h2 id="é—®é¢˜å®šä¹‰"><a href="#é—®é¢˜å®šä¹‰" class="headerlink" title="é—®é¢˜å®šä¹‰"></a>é—®é¢˜å®šä¹‰</h2><p>æœ‰ä¸€ç»„ $p$ ç»´å‘é‡ $X_{n \times p} = \begin{bmatrix}<br>  \boldsymbol{x}_1 \\<br>  \boldsymbol{x}_2 \\<br>  \vdots \\<br>  \boldsymbol{x}_n<br>\end{bmatrix} = \begin{bmatrix}<br>  x_{11} &amp; x_{12} &amp; \ldots &amp; x_{1p} \\<br>  x_{21} &amp; x_{22} &amp; \ldots &amp; x_{2p} \\<br>  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\<br>  x_{n1} &amp; x_{n2} &amp; \ldots &amp; x_{np}<br>\end{bmatrix}$, éœ€è¦é€šè¿‡ä¸€ç§æ–¹æ³•ä½¿å¾—å®ƒä»¬å˜æˆä¸€ç»„ $q~(q &lt; p)$ ç»´å‘é‡ $Y_{n \times q} = \begin{bmatrix}<br>  \boldsymbol{y}_1 \\<br>  \boldsymbol{y}_2 \\<br>  \vdots \\<br>  \boldsymbol{y}_n<br>\end{bmatrix} = \begin{bmatrix}<br>  y_{11} &amp; y_{12} &amp; \ldots &amp; y_{1q} \\<br>  y_{21} &amp; y_{22} &amp; \ldots &amp; y_{2q} \\<br>  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\<br>  y_{n1} &amp; y_{n2} &amp; \ldots &amp; y_{nq}<br>\end{bmatrix}$, åœ¨é™ä½ç»´æ•°çš„åŒæ—¶, å°½å¯èƒ½å‡å°‘ä¿¡æ¯æŸå¤±.</p>
<h2 id="åŸºæœ¬æ€æƒ³"><a href="#åŸºæœ¬æ€æƒ³" class="headerlink" title="åŸºæœ¬æ€æƒ³"></a>åŸºæœ¬æ€æƒ³</h2><h3 id="ä¿¡æ¯é‡åˆ†é…"><a href="#ä¿¡æ¯é‡åˆ†é…" class="headerlink" title="ä¿¡æ¯é‡åˆ†é…"></a>ä¿¡æ¯é‡åˆ†é…</h3><p>å¯¹äºä¸€ä¸ªå‘é‡ $\boldsymbol{x}_i = \begin{pmatrix}x_{i1}, x_{i2}, \ldots, x_{ip}\end{pmatrix}$, $p$ ä¸ªå€¼ä»£è¡¨äº†è¯¥å‘é‡åœ¨ $p$ ä¸ªæ–¹å‘ä¸Šçš„ä¸åŒç‰¹å¾, è€Œä¿¡æ¯é‡å¤§å°çš„ç›´æ¥è¡¨ç°å°±æ˜¯å¯¹æ•°æ®çš„åŒºåˆ†ç¨‹åº¦. å¦‚æœè¯´åœ¨æŸä¸€ç»´ä¸Šçš„å€¼è¶Šèƒ½å¯¹ä¸åŒçš„ $\boldsymbol{x}$ è¿›è¡ŒåŒºåˆ†, åˆ™æ•°æ®çš„<strong>ç¦»æ•£ç¨‹åº¦</strong>å°±è¶Šå¤§, å®ƒæ‰€åŒ…å«çš„ä¿¡æ¯é‡å°±è¶Šå¤š, æœ€ç»ˆè¿™ $p$ ç»´å…±åŒå®Œæˆäº†å¯¹ $X$ æ‰€æœ‰æ•°æ®çš„åŒºåˆ†.</p>
<p>å¯¹äºä¸€ç»„æ•°æ® $X$ æ¥è¯´, ä¿¡æ¯æ€»é‡æ˜¯ç¡®å®šçš„, åŸå§‹çš„ $X$ ä¸­ä¿¡æ¯çš„åˆ†é…æ–¹å¼æ˜¯æŒ‰æŸç§åˆ†å¸ƒåˆ†æ‘Šåœ¨ $p$ ä¸ªç»´åº¦ä¸­.</p>
<p>å› æ­¤, åœ¨ PCA æ–¹æ³•ä¸­, æˆ‘ä»¬å¸Œæœ›:</p>
<ul>
<li>ç»è¿‡å˜æ¢ä¹‹åçš„æ•°æ® $Y$, èƒ½å¤Ÿå¯¹æ¯ä¸€ç»´çš„ä¿¡æ¯å«é‡è¿›è¡Œè°ƒæ•´, å¯ä»¥å°†æ•´ä½“æ•°æ®çš„ä¿¡æ¯é‡å…ˆå°½å¯èƒ½çš„åˆ†é…åˆ°ç¬¬ 1 ç»´, ç„¶ååˆ†é…åˆ°ç¬¬ 2 ç»´, ç¬¬ 3 ç»´, ..., ç›´åˆ°æœ€åä¸€ç»´</li>
<li>åœ¨æ–°çš„æ•°æ® $Y$ ä¸­, æ¯ä¸€ç»´ä¹‹é—´çš„<strong>å…³è”æ€§</strong>å°½å¯èƒ½å°, æœ€å¥½æ˜¯ä¸ç›¸å…³, è¿™æ ·å­å°±èƒ½è®©ä¿¡æ¯ç‹¬ç«‹çš„è¢«åˆ†é…åˆ°æ¯ä¸€ç»´ä¸­, ä¸ä¼šåœ¨ä¸åŒç»´ä¹‹é—´äº§ç”Ÿç»´é—´ä¿¡æ¯.</li>
</ul>
<p>ä¸Šè¿°æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦è§£å†³, åŒä¸€ç»´ä¹‹é—´çš„ç¦»æ•£ç¨‹åº¦å’Œä¸åŒç»´ä¹‹é—´çš„å…³è”æ€§. è€Œåœ¨æ•°å­¦ä¸Š, æ–¹å·®å’Œåæ–¹å·®å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜.</p>
<h3 id="é™ç»´"><a href="#é™ç»´" class="headerlink" title="é™ç»´"></a>é™ç»´</h3><p>$X$ æ˜¯ä¸€ä¸ª $n \times p$ çš„çŸ©é˜µ, å¦‚æœèƒ½æ‰¾åˆ°ä¸€ä¸ª $q \times p$ çš„çŸ©é˜µ $W$ æ»¡è¶³å¯¹ä¿¡æ¯åˆ†é…çš„è¦æ±‚, å¯¹ $X$ è¿›è¡Œçº¿æ€§å˜æ¢, ä½¿å¾— $Y^T = WX^T$, å°±å¯ä»¥å¾—åˆ°é™ç»´å $n \times q$ çš„æ•°æ®è¡¨ç¤º $Y$.</p>
<p>$$<br>\begin{aligned}<br>  Y^T &amp;= \begin{bmatrix}{\boldsymbol{y}_1}^T &amp; {\boldsymbol{y}_2}^T &amp; \ldots &amp; {\boldsymbol{y}_n}^T\end{bmatrix} \\<br>  ~&amp;= WX^T \\<br>  ~&amp;= \begin{bmatrix}<br>    \boldsymbol{w}_1 \\<br>    \boldsymbol{w}_2 \\<br>    \vdots \\<br>    \boldsymbol{w}_q<br>  \end{bmatrix} \begin{bmatrix}{\boldsymbol{x}_1}^T &amp; {\boldsymbol{x}_2}^T &amp; \ldots &amp; {\boldsymbol{x}_n}^T\end{bmatrix}<br>\end{aligned}<br>$$</p>
<h2 id="æ•°å­¦æ¨å¯¼"><a href="#æ•°å­¦æ¨å¯¼" class="headerlink" title="æ•°å­¦æ¨å¯¼"></a>æ•°å­¦æ¨å¯¼</h2><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯, å¯»æ‰¾ä¸€ä¸ª $W$ , ä½¿å¾—æ–°æ•°æ® $Y^T$ åŒä¸€ç»´ä¸Šçš„æ–¹å·®æœ€å¤§åŒ–, ä¸åŒç»´ä¹‹é—´çš„åæ–¹å·®æœ€å°åŒ–.</p>
<p>ä¸ºäº†æ–¹ä¾¿æ•°æ®å¤„ç†, æˆ‘ä»¬å‡è®¾ $X$ å·²ç»ç»è¿‡å‡å€¼å’Œæ–¹å·®çš„å½’ä¸€åŒ–å¤„ç†, å³ $X = \frac{X - E(X)}{\sqrt{D(X)}}$, è¿™æ ·å­å‡å€¼ä¸º 0, æ–¹ä¾¿åç»­è®¡ç®—.</p>
<p>é¦–å…ˆæ˜¯æ–¹å·®ä¸åæ–¹å·®çš„å…¬å¼:</p>
<p>$$<br>\begin{aligned}<br>  Cov(X, Y) &amp;= E(XY) - E(X)E(Y) \\<br>  D(X) &amp;= E(X^2) - E^2(X)<br>\end{aligned}<br>$$</p>
<p>å› ä¸ºæ•°æ®å·²ç»ç»è¿‡å½’ä¸€åŒ–å¤„ç†, æ‰€ä»¥å¯ä»¥ç®€åŒ–æˆ:</p>
<p>$$<br>\begin{aligned}<br>  Cov(X, Y) &amp;= E(XY) = \frac{1}{n}\sum_{i=1}^{n}x_iy_i \\<br>  D(X) &amp;= E(X^2) = \frac{1}{n}\sum_{i=1}^{n}x_i^2<br>\end{aligned}<br>$$</p>
<p>ç°åœ¨, éœ€è¦æŠŠæ•°æ® $Y$ çš„æ–¹å·®ä¸åæ–¹å·®è¿›è¡Œè¡¨ç¤º, å®šä¹‰çŸ©é˜µ $Y_{Cov}$ ä¸º $Y$ çš„åæ–¹å·®çŸ©é˜µ, æœ‰:</p>
<p>$$<br>\begin{aligned}<br>  Y_{Cov} &amp;= \frac{1}{n}Y^TY \\<br>  ~&amp;= \frac{1}{n} \begin{bmatrix}<br>    y_{11} &amp; y_{21} &amp; \ldots &amp; y_{n1} \\<br>    y_{12} &amp; y_{22} &amp; \ldots &amp; y_{n2} \\<br>    \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\<br>    y_{1q} &amp; y_{2q} &amp; \ldots &amp; y_{nq}<br>  \end{bmatrix} \begin{bmatrix}<br>    y_{11} &amp; y_{12} &amp; \ldots &amp; y_{1q} \\<br>    y_{21} &amp; y_{22} &amp; \ldots &amp; y_{2q} \\<br>    \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\<br>    y_{n1} &amp; y_{n2} &amp; \ldots &amp; y_{nq}<br>  \end{bmatrix} \\<br>  ~&amp;= \begin{bmatrix}<br>    \frac{1}{n}\sum_{i=1}^{n}y_{i1}^2 &amp; \frac{1}{n}\sum_{i=1}^{n}y_{i1}y_{i2} &amp; \ldots &amp; \frac{1}{n}\sum_{i=1}^{n}y_{i1}y_{iq} \\<br>    \frac{1}{n}\sum_{i=1}^{n}y_{i2}y_{i1} &amp; \frac{1}{n}\sum_{i=1}^{n}y_{i2}^2 &amp; \ldots &amp; \frac{1}{n}\sum_{i=1}^{n}y_{i2}y_{iq} \\<br>    \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\<br>    \frac{1}{n}\sum_{i=1}^{n}y_{iq}y_{i1} &amp; \frac{1}{n}\sum_{i=1}^{n}y_{iq}y_{i2} &amp; \ldots &amp; \frac{1}{n}\sum_{i=1}^{n}y_{iq}^2<br>  \end{bmatrix}<br>\end{aligned}<br>$$</p>
<p>å¯ä»¥çœ‹åˆ°åæ–¹å·®çŸ©é˜µçš„ä¸»å¯¹è§’çº¿ä¸Šæ˜¯ $q$ ä¸ªç»´åº¦ä¸Šçš„æ–¹å·®, è€Œå…¶ä½™ä½ç½®åˆ™æ˜¯ä¸¤ä¸¤ä¹‹é—´çš„åæ–¹å·®, å¹¶ä¸”åæ–¹å·®çŸ©é˜µè¿˜æ˜¯ä¸€ä¸ªå®å¯¹ç§°çŸ©é˜µ. æ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯è®© $Y_{Cov}$ é™¤äº†ä¸»å¯¹è§’çº¿ä»¥å¤–çš„éƒ¨åˆ†å°½é‡æ¥è¿‘ 0.</p>
<p>åŒç†å¯ä»¥å¾—åˆ° $X_{Cov} = \frac{1}{n}X^TX$.</p>
<p>ä¸‹é¢æ¨å¯¼ $Y_{Cov}$ ä¸åŸå§‹æ•°æ® $X$ ä¹‹é—´çš„å…³ç³».</p>
<p>$$<br>\begin{aligned}<br>  Y_{Cov} &amp;= \frac{1}{n}Y^TY \\<br>    ~&amp;= \frac{1}{n}(WX^T)(WX^T)^T \\<br>    ~&amp;= \frac{1}{n}WX^TXW^T \\<br>    ~&amp;= WX_{Cov}W^T<br>\end{aligned}<br>$$</p>
<p>ç»“åˆæˆ‘ä»¬çš„ç›®æ ‡å¯ä»¥å‘ç°, $Y_{Cov}$ çš„æœ€ä¼˜æƒ…å†µå…¶å®å°±æ˜¯å®å¯¹ç§°çŸ©é˜µ $X_{Cov}$ çš„å¯¹è§’åŒ–çŸ©é˜µ, è€Œ $W$ å°±æ˜¯èƒ½å¤Ÿæ»¡è¶³ $X_{Cov}$ å¯¹è§’åŒ–çš„çŸ©é˜µ.</p>
<p>å…³äºå®å¯¹ç§°çŸ©é˜µçš„å¯¹è§’åŒ–, çº¿ä»£é‡Œé¢æœ‰è¯¦ç»†çš„ä»‹ç», è¿™é‡Œç®€å•æä¸€ä¸‹ç»“è®º.</p>
<div class="note info"><p>å¯¹äºä¸€ä¸ª $n \times n$ çš„å®å¯¹ç§°çŸ©é˜µ $D$, ä¸€å®šå¯ä»¥æ‰¾åˆ° $n$ ä¸ªå•ä½æ­£äº¤ç‰¹å¾å‘é‡, ç»„æˆçŸ©é˜µ $E = \begin{bmatrix}<br>\boldsymbol{e}_1 \\<br>  \boldsymbol{e}_2 \\<br>  \vdots \\<br>  \boldsymbol{e}_n<br>\end{bmatrix}$, ä½¿å¾— $\Lambda = EDE^T = \begin{bmatrix}<br>  \lambda_1 &amp; ~ &amp; ~ &amp; ~ \\<br>  ~ &amp; \lambda_2 &amp; ~ &amp; ~ \\<br>  ~ &amp; ~ &amp; \ddots &amp; ~ \\<br>  ~ &amp; ~ &amp; ~ &amp;\lambda_n<br>\end{bmatrix}$, å…¶ä¸­ $\Lambda$ æ˜¯å¯¹è§’çŸ©é˜µ, å¯¹è§’å…ƒç´ æ˜¯ç‰¹å¾å‘é‡å¯¹åº”çš„ç‰¹å¾å€¼.</p>
</div>

<p>å› æ­¤, å¯¹äºå®å¯¹ç§°çŸ©é˜µ $X_{Cov}$, æ€»èƒ½é€šè¿‡æ±‚å…¶ç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡, å¾—åˆ°ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„ $W$ ä½¿å…¶å¯¹è§’åŒ–, å¾—åˆ° $Y_{Cov}$.</p>
<p>åˆ°è¿™é‡Œè¿˜æ²¡æœ‰å®Œå…¨ç»“æŸ, $X_{Cov}$ æ˜¯ $p$ ç»´å®å¯¹ç§°çŸ©é˜µ, å› æ­¤ä¸€å®šå­˜åœ¨ $p$ ä¸ªç‰¹å¾å€¼ä¸ç‰¹å¾å‘é‡, è€Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯é™ç»´, å› æ­¤ $W$ åªéœ€è¦é€‰æ‹©å…¶ä¸­çš„ $q$ ä¸ªç‰¹å¾å‘é‡ç»„æˆä¸€ä¸ª $q \times p$ çš„çŸ©é˜µå³å¯.</p>
<p>ä»æœ€åå¯¹è§’åŒ–çš„ç»“æœæ¥çœ‹, $Y_{Cov}$ çš„å¯¹è§’çº¿ä¸Š, ä¹Ÿå°±æ˜¯æ–°æ•°æ®æ¯ä¸€ç»´çš„æ–¹å·®å€¼, å…¶å®å°±æ˜¯ $W$ æŒ‰é¡ºåºç‰¹å¾å‘é‡å¯¹åº”çš„ç‰¹å¾å€¼. é‚£ä¹ˆä¸ºäº†å……åˆ†ä¿ç•™åŸæ•°æ®é‡Œçš„ä¿¡æ¯, éœ€è¦å°†ç‰¹å¾å‘é‡æŒ‰ç‰¹å¾å€¼å¤§å°è¿›è¡Œé™åºæ’åˆ—, ç„¶åä¾æ¬¡é€‰å–å‰ $q$ ä¸ªç‰¹å¾å‘é‡å»ç»„æˆæœ€ç»ˆçš„ $W$ çŸ©é˜µ.</p>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="ç®—æ³•æµç¨‹"><a href="#ç®—æ³•æµç¨‹" class="headerlink" title="ç®—æ³•æµç¨‹"></a>ç®—æ³•æµç¨‹</h3><p>è¾“å…¥: $X_{n \times p}$, $q~(q \leq p)$</p>
<p>è¾“å‡º: $Y_{n \times q}$</p>
<ol>
<li>å¯¹ $X$ è¿›è¡Œå‡å€¼æ–¹å·®å½’ä¸€åŒ–.</li>
<li>æ±‚è§£ $X_{Cov} = \frac{1}{n}X^TX$.</li>
<li>æ±‚å‡º $X_{Cov}$ çš„ $p$ ä¸ªç‰¹å¾å€¼ $\lambda_1, \lambda_2, \ldots, \lambda_p$, åŠå…¶å¯¹åº”çš„ç‰¹å¾å‘é‡ $\boldsymbol{w}_1, \boldsymbol{w}_2, \ldots, \boldsymbol{w}_p$.</li>
<li>å°† $\boldsymbol{w}_1, \boldsymbol{w}_2, \ldots, \boldsymbol{w}_p$ æŒ‰ $\lambda_1, \lambda_2, \ldots, \lambda_p$ é™åºæ’åˆ—, å¾—åˆ° $\boldsymbol{w}&#39;_1, \boldsymbol{w}&#39;_2, \ldots, \boldsymbol{w}&#39;_p$.</li>
<li>é€‰å– $\boldsymbol{w}&#39;_1, \boldsymbol{w}&#39;_2, \ldots, \boldsymbol{w}&#39;_q$, ç»„æˆå˜æ¢çŸ©é˜µ $W = \begin{bmatrix}<br> \boldsymbol{w}&#39;_1 \\<br> \boldsymbol{w}&#39;_2 \\<br> \vdots \\<br> \boldsymbol{w}&#39;_q<br>\end{bmatrix}$</li>
<li>è®¡ç®— $Y^T = WX^T$, å¾—åˆ°é™ç»´åçš„æ–°æ•°æ® $Y$.</li>
</ol>
<h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pca</span>(<span class="params">X: np.ndarray, n_compnents: <span class="built_in">int</span></span>) -&gt; np.ndarray:</span><br><span class="line">    n, p = X.shape</span><br><span class="line">    q = n_compnents</span><br><span class="line"></span><br><span class="line">    <span class="comment"># normalization</span></span><br><span class="line">    X = (X - np.mean(X, axis=<span class="number">0</span>, keepdims=<span class="literal">True</span>)) / np.std(X, axis=<span class="number">0</span>, keepdims=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># covariance of x</span></span><br><span class="line">    X_cov = (<span class="number">1</span> / n) * X.T @ X</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute eigenwerts and eigenvectors</span></span><br><span class="line">    w, v = np.linalg.eigh(X_cov)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sort by descending order</span></span><br><span class="line">    w = w[::-<span class="number">1</span>]</span><br><span class="line">    v = v[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># choose top q vectors</span></span><br><span class="line">    W = v[:q]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compute Y</span></span><br><span class="line">    Y = (W @ X.T).T</span><br><span class="line">    <span class="keyword">return</span> Y</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9vdXJhcmNoaXZlLm90YWdvLmFjLm56L2JpdHN0cmVhbS9oYW5kbGUvMTA1MjMvNzUzNC9PVUNTLTIwMDItMTIucGRm">A tutorial on principal components analysis<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>æ•°æ®é™ç»´</tag>
      </tags>
  </entry>
  <entry>
    <title>NJ æ ‘ç®—æ³•åŸç†ä¸å®ç°</title>
    <url>//posts/2023/03/08/njtree/</url>
    <content><![CDATA[<p>é‚»æ¥æ³• (Neighbor-Joining Method), æ˜¯ä¸€ç§åˆ©ç”¨è¿›åŒ–è·ç¦»æ•°æ®é‡å»ºç³»ç»Ÿè¿›åŒ–æ ‘çš„æ–¹æ³•, ç”¨è¿™ä¸ªæ–¹æ³•å¾—åˆ°çš„è¿›åŒ–æ ‘é€šå¸¸ç§°ä¸º NJ æ ‘. è¿™æ˜¯ä¸€ç§è‡ªåº•å‘ä¸Šçš„èšç±»æ–¹æ³•, å°†æ¯ä¸ªä¸ªä½“çœ‹ä½œä¸€ä¸ªç±»åˆ«, ç„¶åä¾æ¬¡ä¸¤ä¸¤èšåˆ, æœ€ç»ˆå¾—åˆ°ä¸€æ•´ä¸ªèšåˆåçš„è¿›åŒ–æ ‘.</p>
<p>æœ¬æ–‡ç®€è¦ä»‹ç» NJ æ ‘ç®—æ³•çš„åŸºæœ¬æµç¨‹ä¸è®¡ç®—æ–¹æ³•, å¹¶åœ¨æ–‡æœ«æä¾›å¯¹åº”çš„ <code>python</code> å®ç°.</p>
<span id="more"></span>

<h2 id="åŸºæœ¬å®šä¹‰"><a href="#åŸºæœ¬å®šä¹‰" class="headerlink" title="åŸºæœ¬å®šä¹‰"></a>åŸºæœ¬å®šä¹‰</h2><h3 id="é‚»å±…"><a href="#é‚»å±…" class="headerlink" title="é‚»å±…"></a>é‚»å±…</h3><p><img data-src="/static/image/njtree/ppVbSaR.png" alt="ppVbSaR.png"></p>
<p>é¦–å…ˆæ˜¯å…³äº&quot;é‚»å±…&quot;çš„å®šä¹‰, åœ¨ NJ æ ‘ä¸­, ä¸€å¯¹&quot;é‚»å±…&quot;æŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªæ— æ ¹åˆ†å‰æ ‘ä¸­ä»…ä»…é€šè¿‡ä¸€ä¸ªå†…éƒ¨ç»“ç‚¹è¿æ¥èµ·æ¥ä¸€å¯¹åˆ†ç±»å•å…ƒ (OTU).</p>
<p>ä¾‹å¦‚åœ¨ä¸Šå›¾ä¸­, $1$ å’Œ $2$ å¯ä»¥è§†ä¸ºä¸€å¯¹é‚»å±…, å®ƒä»¬é€šè¿‡å†…éƒ¨ç»“ç‚¹ $A$ è¿›è¡Œè¿ç»“.</p>
<p>è¿›ä¸€æ­¥, å¯ä»¥å¯¹åˆ†ç±»å•å…ƒè¿›è¡Œç»„åˆ, å½¢æˆæ–°çš„æ›´å¤§çš„åˆ†ç±»å•å…ƒä¸é‚»å±…å¯¹, ä¾‹å¦‚, $&lt;1, 2&gt;$ å’Œ $3$ å¯ä»¥ä½œä¸ºä¸€å¯¹é‚»å±…, å®ƒä»¬é€šè¿‡å†…éƒ¨ç»“ç‚¹ $B$ è¿›è¡Œè¿ç»“, $&lt;5, 6&gt;$ å’Œ $&lt;7, 8&gt;$ å¯ä»¥ä½œä¸ºä¸€å¯¹é‚»å±…, å®ƒä»¬é€šè¿‡å†…éƒ¨ç»“ç‚¹ $D$ è¿›è¡Œè¿ç»“.</p>
<h3 id="è¿›åŒ–æ ‘æ„å»ºæµç¨‹"><a href="#è¿›åŒ–æ ‘æ„å»ºæµç¨‹" class="headerlink" title="è¿›åŒ–æ ‘æ„å»ºæµç¨‹"></a>è¿›åŒ–æ ‘æ„å»ºæµç¨‹</h3><p><img data-src="/static/image/njtree/ppVqOHJ.png" alt="ppVqOHJ.png"></p>
<p>å‡è®¾åˆå§‹æ—¶æ²¡æœ‰ä»»ä½•åˆ†ç±»å•å…ƒèšé›†åœ¨ä¸€èµ·, ç®—æ³•èµ·å§‹äºä¸€ä¸ªæ˜ŸçŠ¶æ ‘, å¦‚ä¸Šå›¾å·¦ä¾§æ‰€ç¤º. ç®—æ³•çš„ä¸€æ­¥å˜æ¢åˆ™æ˜¯å°†å·¦å›¾å˜æˆäº†å³å›¾.</p>
<p>åœ¨è¿™äº›åˆ†ç±»å•å…ƒä¸­, åˆ†ç±»å•å…ƒä¹‹é—´æœ‰ç€ä¸åŒçš„è·ç¦»è¿œè¿‘, å³ä¾§çš„å›¾å°† $1$ å’Œ $2$ èšåˆåœ¨äº†ä¸€èµ·, å¹¶å½¢æˆäº†ä¸€ä¸ªæ–°ç»“ç‚¹ $Y$, å°† $1$, $2$ è§†ä½œä¸€ä¸ªæ•´ä½“, åˆ™ç›¸æ¯”äºå·¦å›¾, $&lt;1, 2&gt;$ ä½œä¸ºæ–°åˆ†ç±»å•å…ƒæ•´ä½“æ›¿æ¢äº†å·¦å›¾é‡Œçš„åˆ†ç±»å•å…ƒ $1$ å’Œ $2$, æ•´ä¸ªæ˜ŸçŠ¶æ ‘å‡å°‘äº† 1 ä¸ªåˆ†ç±»å•å…ƒ, å¢åŠ äº† 1 æ¡å†…éƒ¨åˆ†æ”¯, æ¯æ¬¡é€‰æ‹©è¦èšåˆçš„é‚»å±…æ—¶, éƒ½æ˜¯ä½¿å¾—èšåˆåçš„æ–°æ ‘æ€»æé•¿æœ€çŸ­. å¦‚æ­¤å¾ªç¯, åˆ™å¯ä»¥ä¸€æ­¥ä¸€æ­¥å‡å°‘æ˜ŸçŠ¶æ ‘çš„åˆ†ç±»å•å…ƒ, ç›´è‡³åˆ†ç±»å•å…ƒåªå‰©ä¸‹ 3 ä¸ª, å†…éƒ¨åˆ†æ”¯å¢åŠ è‡³ $N - 3$ ä¸ª.</p>
<p><img data-src="/static/image/njtree/ppVX9mD.png" alt="ppVX9mD.png"></p>
<h2 id="ç®—æ³•æµç¨‹"><a href="#ç®—æ³•æµç¨‹" class="headerlink" title="ç®—æ³•æµç¨‹"></a>ç®—æ³•æµç¨‹</h2><p><img data-src="/static/image/njtree/ppVqOHJ.png" alt="ppVqOHJ.png"></p>
<h3 id="è®¡ç®—æ€»æé•¿"><a href="#è®¡ç®—æ€»æé•¿" class="headerlink" title="è®¡ç®—æ€»æé•¿"></a>è®¡ç®—æ€»æé•¿</h3><p>è¿˜æ˜¯ä»¥è¿™å¼ å›¾ä¸ºä¾‹, è®¾åˆå§‹æ—¶å…±æœ‰ $N$ ä¸ªåˆ†ç±»å•å…ƒ, è®¾ $D_{ij}$ æŒ‡åˆ†ç±»å•å…ƒ $i$ å’Œ $j$ ä¹‹é—´çš„è·ç¦», $L_{ab}$ æŒ‡ç»“ç‚¹ $a$ å’Œ $b$ ä¹‹é—´çš„æé•¿. æ•´ä¸ªæ ‘çš„æ€»æé•¿ä¸º:</p>
<p>$$<br>S_O = \sum_{i=1}^{N}L_{iX}=\frac{1}{N-1}\sum_{i&lt;j}^{N}D_{ij}<br>$$</p>
<p>ä¹Ÿå°±æ˜¯æ¯ä¸ªç»“ç‚¹åˆ° $X$ çš„æé•¿æ€»å’Œ, ç­‰ä»·äºåˆ†ç±»å•å…ƒä¸¤ä¸¤ä¹‹é—´è·ç¦»æ±‚å’Œåé™¤ä»¥ $N-1$, å› ä¸ºæ¯ä¸ªæç›¸å½“äºæ•°äº† $N-1$ æ¬¡.</p>
<details class="note info"><summary><p>ä¸ºä»€ä¹ˆæ˜¯ $N-1$ ?</p>
</summary>
<p>$1$ åˆ° $X$ çš„è·ç¦»é€šè¿‡ $D_{ij}$ æ•°äº† $N-1$ æ¬¡; $2$ åˆ° $X$ çš„è·ç¦»é€šè¿‡ $D_{12}$ æ•°äº† $1$ æ¬¡, é€šè¿‡ $D_{2j}$ æ•°äº† $N-2$ æ¬¡, ä»¥æ­¤ç±»æ¨.</p>

</details>

<h3 id="è®¡ç®—æ–°å¢æé•¿åçš„æ€»æé•¿"><a href="#è®¡ç®—æ–°å¢æé•¿åçš„æ€»æé•¿" class="headerlink" title="è®¡ç®—æ–°å¢æé•¿åçš„æ€»æé•¿"></a>è®¡ç®—æ–°å¢æé•¿åçš„æ€»æé•¿</h3><p>å¦ä¸€æ–¹é¢, å³ä¾§å›¾ä¸­ $X$ å’Œ $Y$ ç»“ç‚¹ä¹‹é—´çš„æé•¿è®¡ç®—æ–¹æ³•ä¸º:</p>
<p>$$<br>\begin{aligned}<br>  L_{XY} &amp;= \frac{1}{2(N-2)}\left[\sum_{k=3}^{N}{(D_{1k}+D_{2k})} - {(N-2)(L_{1X}+L_{2X})} - {2\sum_{i=3}^{N}{L_{iY}}} \right] \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[\sum_{k=3}^{N}{(D_{1k}+D_{2k})} - {(N-2)D_{12}} - {\frac{2}{N-3}\sum_{3 \leq i&lt;j}^{N}D_{ij}} \right]<br>\end{aligned}<br>$$</p>
<p>ç¬¬ä¸€é¡¹ $\sum_{k=3}^{N}{(D_{1k}+D_{2k})}$ ä»£è¡¨ä»ç»“ç‚¹ $1,2$ åˆ°å…¶ä½™æ‰€æœ‰ç»“ç‚¹çš„è·ç¦», åŒ…æ‹¬ $L_{XY}$. å…¬å¼çš„åä¸¤é¡¹æ˜¯ä¸ºäº†å‡å»å¤šç®—çš„é‚£éƒ¨åˆ†è·ç¦», $(L_{1X}+L_{2X})$ æ˜¯ $1,2$ åˆ° $X$ çš„è·ç¦», $\sum_{i=3}^{N}{L_{iY}}$ æ˜¯å…¶ä½™ç‚¹åˆ° $Y$ çš„è·ç¦».</p>
<details class="note info"><summary><p>å‰é¢çš„é‚£äº›ç³»æ•°æ€ä¹ˆæ¥çš„ ?</p>
</summary>
<p>åœ¨ç¬¬ä¸€é¡¹ä¸­, $\sum_{k=3}^{N}{(D_{1k}+D_{2k})}$ å°† $1,2$ åˆ° $X$ çš„è¾¹å„æ•°äº† $N-2$ æ¬¡, $X$ åˆ° $Y$ çš„è¾¹æ•°äº† $2(N-2)$ æ¬¡, $Y$ åˆ°å…¶ä½™ç»“ç‚¹å„æ•°äº† $2$ æ¬¡, å› æ­¤å‡å»å¯¹åº”çš„æ¬¡æ•°åå†é™¤ä»¥ $2(N-2)$ å°±æ˜¯ $L_{XY}$ çš„è·ç¦».</p>

</details>

<p>å¾—åˆ° $L_{XY}$ ä¹‹å, å¯ä»¥è®¡ç®—å³ä¾§æ–°å›¾çš„æ€»æé•¿:</p>
<p>$$<br>\begin{aligned}<br>  S_{12} &amp;= L_{XY} + (L_{1X} + L_{2X}) + \sum_{i=3}^{N}L_{iY} \\<br>  ~ &amp;= \frac{1}{2(N-2)}\sum_{k=3}^{N}(D_{1k} + D_{2k}) + \frac{1}{2}D_{12} + \frac{1}{N-2}\sum_{3 \leq i&lt;j}^{N}D_{ij}<br>\end{aligned}<br>$$</p>
<h3 id="æ„é€ æ–°å›¾"><a href="#æ„é€ æ–°å›¾" class="headerlink" title="æ„é€ æ–°å›¾"></a>æ„é€ æ–°å›¾</h3><p>é€šå¸¸æ¥è¯´, å¹¶ä¸ä¼šçŸ¥é“å³å›¾ä¸­ $1,2$ ç©¶ç«Ÿé€‰æ‹©å“ªä¸€å¯¹åˆ†ç±»å•å…ƒä½œä¸ºé‚»å±…, å› æ­¤éœ€è¦è®¡ç®—æ‰€æœ‰çš„ $S_{ij}$, å¹¶é€‰æ‹©æœ€å°çš„é‚£ä¸€å¯¹ä½œä¸ºè¿™ä¸€è½®çš„é€‰æ‹©.</p>
<p>å‡è®¾ $1,2$ å°±æ˜¯è¿™ä¸€è½®é€‰æ‹©å‡ºæ¥çš„é‚»å±…, åˆ™å®ƒä»¬ä¸¤ä¸ªå’Œ $X$ ä¼šå½¢æˆæ–°çš„åˆ†ç±»å•å…ƒ $&lt;1,2&gt;$, ç„¶åè®¡ç®—æ–°åˆ†ç±»å•å…ƒä¸å…¶ä½™åˆ†ç±»å•å…ƒçš„è·ç¦»:</p>
<p>$$<br>D_{&lt;1,2&gt;j} = \frac{1}{2}(D_{1j} + D_{2j}) \quad (3 \leq j \leq N)<br>$$</p>
<p>å¾—åˆ°æ–°è·ç¦»ä¹‹å, è¿˜éœ€è¦è®¡ç®—æ–°åˆ†ç±»å•å…ƒ $&lt;1,2&gt;$ å†…éƒ¨çš„è·ç¦» $L_{1X}, L_{2X}$.</p>
<p>$$<br>\begin{aligned}<br>  L_{1X} &amp;= \frac{1}{2}(D_{12} + D_{1Z} - D_{2Z}) \\<br>  L_{2X} &amp;= \frac{1}{2}(D_{12} + D_{2Z} - D_{1Z})<br>\end{aligned}<br>$$</p>
<p>å…¶ä¸­:</p>
<p>$$<br>\begin{aligned}<br>  D_{1Z} &amp;= \frac{1}{N-2}\sum_{i=3}^{N}D_{1i} \\<br>  D_{2Z} &amp;= \frac{1}{N-2}\sum_{i=3}^{N}D_{2i}<br>\end{aligned}<br>$$</p>
<p>åœ¨è¿™ä¸€ç»„å…¬å¼é‡Œé¢, $Z$ ä»£è¡¨é™¤å» $1,2$ çš„æ‰€æœ‰ç»“ç‚¹å½¢æˆçš„&quot;å‡æƒ³ç»“ç‚¹&quot;, å³ $1$ é€šè¿‡ $Z$ è¿™ä¸ªæ•´ä½“ä¸ $2$ ç›¸è¿. åˆ™ $1,2$ ä¸ $Z$ çš„è·ç¦»åˆ†åˆ«ä¸ºå„è‡ªåˆ° $Z$ ä¸­å…¶ä½™ç»“ç‚¹è·ç¦»çš„å¹³å‡å€¼.</p>
<h3 id="å¾ªç¯æ­¥éª¤"><a href="#å¾ªç¯æ­¥éª¤" class="headerlink" title="å¾ªç¯æ­¥éª¤"></a>å¾ªç¯æ­¥éª¤</h3><p>æ¯é€‰æ‹©ä¸€å¯¹åˆé€‚çš„é‚»å±…, åˆ™å›¾ä¸Šçš„åˆ†ç±»å•å…ƒå°±ä¼šå‡å°‘ 1 ä¸ª, ç›´åˆ°å›¾ä¸Šçš„åˆ†ç±»å•å…ƒæ•°é‡å˜æˆ 3, ç®—æ³•ç»“æŸ.</p>
<h2 id="å…¬å¼åŒ–ç®€"><a href="#å…¬å¼åŒ–ç®€" class="headerlink" title="å…¬å¼åŒ–ç®€"></a>å…¬å¼åŒ–ç®€</h2><p>åœ¨å®é™…è®¡ç®—ä¹‹å‰, éœ€è¦å¯¹åŸå§‹å…¬å¼è¿›è¡Œä¸€äº›åŒ–ç®€å˜å½¢.</p>
<p>é¦–å…ˆæ˜¯å¯¹æ¯ä¸€è½®éƒ½éœ€è¦è®¡ç®—çš„æ–°å›¾æ€»æé•¿å…¬å¼è¿›è¡Œå˜å½¢, ä»¥å‰æ–‡çš„ $S_{12}$ ä¸ºä¾‹:</p>
<p>$$<br>\begin{aligned}<br>  S_{12} &amp;= \frac{1}{2(N-2)}\sum_{k=3}^{N}(D_{1k} + D_{2k}) + \frac{1}{2}D_{12} + \frac{1}{N-2}\sum_{3 \leq i&lt;j}^{N}D_{ij} \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[\sum_{k=3}^{N}D_{1k} + \sum_{k=3}^{N}D_{2k} + (N-2)D_{12} + \sum_{3 \leq i&lt;j}^{N}D_{ij} + \sum_{3 \leq i&lt;j}^{N}D_{ij}\right] \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[(N-2)D_{12} - \left(D_{12} + \sum_{k=3}^{N}D_{1k}\right) - \left(D_{21} + \sum_{k=3}^{N}D_{2k}\right) + \left(D_{12} + \sum_{k=3}^{N}D_{1k} + \sum_{3 \leq i&lt;j}^{N}D_{ij}\right) + \left(D_{21} + \sum_{k=3}^{N}D_{2k} + \sum_{3 \leq i&lt;j}^{N}D_{ij}\right)\right] \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[(N-2)D_{12} - \sum_{k \ne 1}^{N}D_{1k} - \sum_{k \ne 2}^{N}D_{2k} + 2\sum_{i&lt;j}^{N}D_{ij}\right] \\<br>  ~ &amp;= \frac{1}{2}\left[D_{12} - \frac{1}{(N-2)}\sum_{k \ne 1}^{N}D_{1k} - \frac{1}{(N-2)}\sum_{k \ne 2}^{N}D_{2k}\right] + \frac{1}{(N-2)}\sum_{i&lt;j}^{N}D_{ij} \\<br>  ~ &amp;= C_1\left[D_{12} - \frac{1}{(N-2)}\sum_{k \ne 1}^{N}D_{1k} - \frac{1}{(N-2)}\sum_{k \ne 2}^{N}D_{2k}\right] + C_2<br>\end{aligned}<br>$$</p>
<p>ç»è¿‡åŒ–ç®€ä¹‹å, å¯ä»¥çœ‹åˆ°, åªæœ‰æ–¹æ‹¬å·é‡Œçš„å†…å®¹ä¸è¦è®¡ç®—çš„é‚»å±…å¯¹ $1,2$ æœ‰å…³, å…¶ä»–é‡éƒ½å¯ä»¥çœ‹ä½œè¿™ä¸€è½®çš„å¸¸é‡.</p>
<p>å› ä¸ºæœ€ç»ˆ $S_{ij}$ æ˜¯ç”¨äºæ¯”è¾ƒæœ€å°å€¼, æ‰€ä»¥åªéœ€è¦ä¿è¯ $S_{ij}$ çš„ç›¸å¯¹å¤§å°ä¸å˜, åˆ $C_1, C_2$ å‡å¤§äº $0$, äºæ˜¯å¯ä»¥åœ¨å®é™…è®¡ç®—ä¸­å¿½ç•¥æ‰å¸¸æ•°é¡¹, ä»è€Œç®€åŒ–è®¡ç®—, ä»è€Œæœ‰:</p>
<p>$$<br>S_{ij} = D_{ij} - D_{iZ} - D_{jZ}<br>$$</p>
<p>å…¶ä¸­:</p>
<p>$$<br>D_{iZ} = \frac{1}{(N-2)}\sum_{k \ne i}^{N}D_{ik}<br>$$</p>
<p>ä»ä»¥å‰æ–‡çš„å›¾ä¸ºä¾‹, åœ¨é€‰æ‹©å‡ºæœ€åˆé€‚çš„é‚»å±… $1,2$ å, ä¼šåˆå¹¶æˆæ–°çš„åˆ†ç±»å•å…ƒ $&lt;1,2&gt;$, éœ€è¦åœ¨æ–°å›¾é‡Œè®¡ç®— $&lt;1,2&gt;$ å’Œå…¶ä½™ç‚¹çš„è·ç¦»å€¼, ä»¥åŠå†…éƒ¨è·ç¦» $L_{1X}, L_{2X}$.</p>
<p>æ–°è·ç¦»å€¼å°±æ˜¯ $D_{&lt;i,j&gt;k} = \frac{1}{2}(D_{ik} + D_{jk})$, è¿™é‡Œå¯¹ $L_{1X}, L_{2X}$ è¿›è¡Œå˜å½¢åŒ–ç®€.</p>
<p>$$<br>\begin{aligned}<br>  L_{1X} &amp;= \frac{1}{2}(D_{12} + D_{1Z} - D_{2Z}) \\<br>  ~ &amp;= \frac{1}{2}\left(D_{12} + \frac{1}{N-2}\sum_{i=3}^{N}D_{1i} - \frac{1}{N-2}\sum_{i=3}^{N}D_{2i}\right) \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[(N-2)D_{12} + \sum_{i=3}^{N}D_{1i} - \sum_{i=3}^{N}D_{2i}\right] \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[(N-2)D_{12} + \left(D_{12} + \sum_{i=3}^{N}D_{1i}\right) - \left(D_{21} + \sum_{i=3}^{N}D_{2i}\right)\right] \\<br>  ~ &amp;= \frac{1}{2(N-2)}\left[(N-2)D_{12} + \sum_{k \ne 1}^{N}D_{1k} - \sum_{k \ne 2}^{N}D_{2k}\right] \\<br>  ~ &amp;= \frac{1}{2}\left(D_{12} + \frac{1}{(N-2)}\sum_{k \ne 1}^{N}D_{1k} - \frac{1}{(N-2)}\sum_{k \ne 2}^{N}D_{2k}\right) \\<br>  L_{2X} &amp;= \frac{1}{2}\left(D_{12} + \frac{1}{(N-2)}\sum_{k \ne 2}^{N}D_{2k} - \frac{1}{(N-2)}\sum_{k \ne 1}^{N}D_{1k} \right)<br>\end{aligned}<br>$$</p>
<p>å› æ­¤æœ‰:</p>
<p>$$<br>\begin{aligned}<br>  L_{iX} &amp;= \frac{1}{2}\left(D_{ij} + D_{iZ} - D_{jZ}\right) \\<br>  L_{jX} &amp;= \frac{1}{2}\left(D_{ij} + D_{jZ} - D_{iZ}\right)<br>\end{aligned}<br>$$</p>
<p>å˜å½¢æˆè¿™æ ·æœ‰ä¸ªå¥½å¤„, å°±æ˜¯èƒ½å¤Ÿå¤ç”¨å‰é¢ç®— $S_{ij}$ æ—¶è®¡ç®—çš„ $D_{iZ}$ ç»“æœ.</p>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><ol>
<li>ä¾æ¬¡è®¡ç®—å½“å‰è½®æ¬¡çš„ $M_i$ å€¼, å¾—åˆ° $M$ å‘é‡ $(M_1, M_2, \ldots, M_N)$.</li>
<li>è®¡ç®—æ‰€æœ‰çš„ $S_{ij} ~ (1 \leq i &lt; j \leq N)$, é€‰æ‹©ä½¿ $S_{ij}$ æœ€å°çš„ $i,j$ ä½œä¸ºè¿™ä¸€è½®çš„é‚»å±….</li>
<li>è®¡ç®—æ–°åˆ†ç±»å•å…ƒ $&lt;i,j&gt;$ å¯¹å…¶ä½™ç‚¹çš„æ–°è·ç¦» $D_{&lt;i,j&gt;k} ~ (1 \leq k \leq N, k \ne i, j)$.</li>
<li>è®¡ç®—å†…éƒ¨è·ç¦» $L_{iX}$ å’Œ $L_{jX}$.</li>
<li>æ›´æ–°å½“å‰åˆ†ç±»å•å…ƒæ•° $N = N-1$, å¦‚æœ $N &gt; 3$, åˆ™è½¬æ­¥éª¤ 1 ç»§ç»­, å¦åˆ™ç»“æŸè®¡ç®—.</li>
</ol>
<h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> rich <span class="keyword">import</span> progress</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">neighbor_joining</span>(<span class="params">_otu: <span class="type">List</span>[<span class="built_in">str</span>], _dist: <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">float</span>]]</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        _otu: names of otus</span></span><br><span class="line"><span class="string">        _dist: distances dict for otus, (i, j) -&gt; dist, i less than j</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># init</span></span><br><span class="line">    nodes = [&#123;<span class="string">&quot;name&quot;</span>: e, <span class="string">&quot;parent&quot;</span>: <span class="literal">None</span>&#125; <span class="keyword">for</span> e <span class="keyword">in</span> _otu]</span><br><span class="line">    n = <span class="built_in">len</span>(nodes)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># otu_distances: used to record otu distances</span></span><br><span class="line">    otu_distances: np.ndarray = np.array(_dist, dtype=np.float_)</span><br><span class="line">    otu_distances = np.concatenate([otu_distances, np.zeros((n - <span class="number">2</span>, n))], axis=<span class="number">0</span>)</span><br><span class="line">    otu_distances = np.concatenate([otu_distances, np.zeros((<span class="number">2</span> * n - <span class="number">2</span>, n - <span class="number">2</span>))], axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># branch_lengths: used to record branch lengths</span></span><br><span class="line">    branch_lengths = np.zeros_like(otu_distances)</span><br><span class="line"></span><br><span class="line">    current_otus = <span class="built_in">list</span>(<span class="built_in">range</span>(n))</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> progress.track(<span class="built_in">range</span>(n - <span class="number">3</span>)):</span><br><span class="line">        n = <span class="built_in">len</span>(current_otus)</span><br><span class="line">        otu_dists = otu_distances[current_otus, ...][..., current_otus]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># calc D to Z</span></span><br><span class="line">        otu_dists_to_others: np.ndarray = np.<span class="built_in">sum</span>(otu_dists, axis=<span class="number">0</span>) / (n - <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># calc S</span></span><br><span class="line">        graph_branch_length = otu_dists - otu_dists_to_others.reshape(-<span class="number">1</span>, <span class="number">1</span>) - otu_dists_to_others.reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># choose min (i, j)</span></span><br><span class="line">        otu1, otu2 = <span class="built_in">min</span>(((i, j) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>, n)), key=<span class="keyword">lambda</span> x: graph_branch_length[x])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># make new otu and node</span></span><br><span class="line">        n1, n2, n3 = current_otus[otu1], current_otus[otu2], <span class="built_in">len</span>(nodes)</span><br><span class="line">        new_node = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">f&quot;#<span class="subst">&#123;n3&#125;</span>&quot;</span>, <span class="string">&quot;parent&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;children&quot;</span>: (n1, n2)&#125;</span><br><span class="line">        nodes[n1][<span class="string">&quot;parent&quot;</span>] = n3</span><br><span class="line">        nodes[n2][<span class="string">&quot;parent&quot;</span>] = n3</span><br><span class="line"></span><br><span class="line">        <span class="comment"># update otu distances</span></span><br><span class="line">        otu_distances[n3, ...] = (otu_distances[n1, ...] + otu_distances[n2, ...]) / <span class="number">2</span></span><br><span class="line">        otu_distances[..., n3] = (otu_distances[..., n1] + otu_distances[..., n2]) / <span class="number">2</span></span><br><span class="line">        otu_distances[n3, [n1, n2, n3]] = <span class="number">0</span></span><br><span class="line">        otu_distances[[n1, n2, n3], n3] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># update branch lengths</span></span><br><span class="line">        branch_lengths[n1, n3] = branch_lengths[n3, n1] = (</span><br><span class="line">            otu_distances[n1, n2] + otu_dists_to_others[otu1] - otu_dists_to_others[otu2]</span><br><span class="line">            - otu_distances[nodes[n1].get(<span class="string">&quot;children&quot;</span>, (n1, n1))]</span><br><span class="line">        ) / <span class="number">2</span></span><br><span class="line">        branch_lengths[n2, n3] = branch_lengths[n3, n2] = (</span><br><span class="line">            otu_distances[n2, n1] + otu_dists_to_others[otu2] - otu_dists_to_others[otu1]</span><br><span class="line">            - otu_distances[nodes[n2].get(<span class="string">&quot;children&quot;</span>, (n2, n2))]</span><br><span class="line">        ) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># remove n1 &amp; n2</span></span><br><span class="line">        current_otus.remove(n1)</span><br><span class="line">        current_otus.remove(n2)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add n3</span></span><br><span class="line">        nodes.append(new_node)</span><br><span class="line">        current_otus.append(n3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># join rest three otus</span></span><br><span class="line">    n3 = current_otus.pop()</span><br><span class="line">    n2 = current_otus.pop()</span><br><span class="line">    n1 = current_otus.pop()</span><br><span class="line"></span><br><span class="line">    nr = <span class="built_in">len</span>(nodes)</span><br><span class="line">    root_node = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">f&quot;#<span class="subst">&#123;nr&#125;</span>&quot;</span>, <span class="string">&quot;parent&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;children&quot;</span>: (n1, n2, n3)&#125;</span><br><span class="line">    nodes[n1][<span class="string">&quot;parent&quot;</span>] = nr</span><br><span class="line">    nodes[n2][<span class="string">&quot;parent&quot;</span>] = nr</span><br><span class="line">    nodes[n3][<span class="string">&quot;parent&quot;</span>] = nr</span><br><span class="line"></span><br><span class="line">    branch_lengths[n1, nr] = branch_lengths[nr, n1] = (</span><br><span class="line">        otu_distances[n1, n2] + otu_distances[n1, n3] - otu_distances[n2, n3]</span><br><span class="line">        - otu_distances[nodes[n1].get(<span class="string">&quot;children&quot;</span>, (n1, n1))]</span><br><span class="line">    ) / <span class="number">2</span></span><br><span class="line">    branch_lengths[n2, nr] = branch_lengths[nr, n2] = (</span><br><span class="line">        otu_distances[n2, n1] + otu_distances[n2, n3] - otu_distances[n1, n3]</span><br><span class="line">        - otu_distances[nodes[n2].get(<span class="string">&quot;children&quot;</span>, (n2, n2))]</span><br><span class="line">    ) / <span class="number">2</span></span><br><span class="line">    branch_lengths[n3, nr] = branch_lengths[nr, n3] = (</span><br><span class="line">        otu_distances[n3, n1] + otu_distances[n3, n2] - otu_distances[n1, n2]</span><br><span class="line">        - otu_distances[nodes[n3].get(<span class="string">&quot;children&quot;</span>, (n3, n3))]</span><br><span class="line">    ) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    nodes.append(root_node)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nodes, branch_lengths</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_njtree</span>(<span class="params">nodes: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]], branch_lengths: np.ndarray</span>):</span><br><span class="line">    lines = []</span><br><span class="line"></span><br><span class="line">    stack = []</span><br><span class="line">    <span class="keyword">for</span> i, node <span class="keyword">in</span> <span class="built_in">enumerate</span>(nodes):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> node[<span class="string">&quot;parent&quot;</span>]:</span><br><span class="line">            stack.append((<span class="number">0</span>, <span class="number">0</span>, i, node))</span><br><span class="line">    <span class="keyword">while</span> stack:</span><br><span class="line">        level, count, idx, top = stack.pop()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> level &gt; <span class="number">0</span>:</span><br><span class="line">            level_branchs = []</span><br><span class="line">            pre_level = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> _level, _, _, _ <span class="keyword">in</span> stack[:<span class="built_in">len</span>(stack)-count]:</span><br><span class="line">                <span class="keyword">if</span> _level &gt; pre_level:</span><br><span class="line">                    level_branchs.append(<span class="string">&quot;    &quot;</span> * (_level - pre_level - <span class="number">1</span>) + <span class="string">&quot;â”‚   &quot;</span>)</span><br><span class="line">                    pre_level = _level</span><br><span class="line">            level_branchs.append(<span class="string">&quot;    &quot;</span> * (level - pre_level - <span class="number">1</span>) + (<span class="string">&quot;â”œâ”€â”€&quot;</span> <span class="keyword">if</span> count &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">&quot;â””â”€â”€&quot;</span>))</span><br><span class="line">            edge_length = <span class="string">f&quot;(<span class="subst">&#123;branch_lengths[idx, top[<span class="string">&#x27;parent&#x27;</span>]]:<span class="number">.6</span>f&#125;</span>)&quot;</span></span><br><span class="line">            lines.append(<span class="string">&quot;&quot;</span>.join((*level_branchs, top[<span class="string">&quot;name&quot;</span>], edge_length)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            lines.append(top[<span class="string">&quot;name&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, child <span class="keyword">in</span> <span class="built_in">enumerate</span>(top.get(<span class="string">&quot;children&quot;</span>, [])):</span><br><span class="line">            stack.append((level + <span class="number">1</span>, i, child, nodes[child]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n&quot;</span>.join(lines)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    r = neighbor_joining(</span><br><span class="line">        <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">str</span>, <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">9</span>))),</span><br><span class="line">        [[<span class="number">0</span>,  <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">11</span>, <span class="number">13</span>, <span class="number">16</span>, <span class="number">13</span>, <span class="number">17</span>],</span><br><span class="line">         [<span class="number">7</span>,  <span class="number">0</span>,  <span class="number">5</span>,  <span class="number">8</span>,  <span class="number">10</span>, <span class="number">13</span>, <span class="number">10</span>, <span class="number">14</span>],</span><br><span class="line">         [<span class="number">8</span>,  <span class="number">5</span>,  <span class="number">0</span>,  <span class="number">5</span>,  <span class="number">7</span>,  <span class="number">10</span>, <span class="number">7</span>,  <span class="number">11</span>],</span><br><span class="line">         [<span class="number">11</span>, <span class="number">8</span>,  <span class="number">5</span>,  <span class="number">0</span>,  <span class="number">8</span>,  <span class="number">11</span>, <span class="number">8</span>,  <span class="number">12</span>],</span><br><span class="line">         [<span class="number">13</span>, <span class="number">10</span>, <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">0</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">10</span>],</span><br><span class="line">         [<span class="number">16</span>, <span class="number">13</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">5</span>,  <span class="number">0</span>,  <span class="number">9</span>,  <span class="number">13</span>],</span><br><span class="line">         [<span class="number">13</span>, <span class="number">10</span>, <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">6</span>,  <span class="number">9</span>,  <span class="number">0</span>,  <span class="number">8</span>],</span><br><span class="line">         [<span class="number">17</span>, <span class="number">14</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">10</span>, <span class="number">13</span>, <span class="number">8</span>,  <span class="number">0</span>]]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    tree = draw_njtree(r[<span class="number">0</span>], r[<span class="number">1</span>])</span><br><span class="line">    <span class="built_in">print</span>(tree)</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå†…å®¹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#13</span><br><span class="line">â”œâ”€â”€#12(1.000000)</span><br><span class="line">â”‚   â”œâ”€â”€8(6.000000)</span><br><span class="line">â”‚   â””â”€â”€7(2.000000)</span><br><span class="line">â”œâ”€â”€#11(2.000000)</span><br><span class="line">â”‚   â”œâ”€â”€#10(1.000000)</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€#8(2.000000)</span><br><span class="line">â”‚   â”‚   â”‚   â”œâ”€â”€2(2.000000)</span><br><span class="line">â”‚   â”‚   â”‚   â””â”€â”€1(5.000000)</span><br><span class="line">â”‚   â”‚   â””â”€â”€3(1.000000)</span><br><span class="line">â”‚   â””â”€â”€4(3.000000)</span><br><span class="line">â””â”€â”€#9(2.000000)</span><br><span class="line">    â”œâ”€â”€6(4.000000)</span><br><span class="line">    â””â”€â”€5(1.000000)</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9hY2FkZW1pYy5vdXAuY29tL21iZS9hcnRpY2xlLzQvNC80MDYvMTAyOTY2NA==">The Neighbor-joining Method: A New Method for Reconstructing Phylogenetic Trees<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>èšç±»ç®—æ³•</tag>
        <tag>ç”Ÿä¿¡</tag>
        <tag>NJ æ ‘</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•åœ¨ PyPI ä¸Šå‘å¸ƒä¸€ä¸ªåŒ…</title>
    <url>//posts/2023/11/05/pypi/</url>
    <content><![CDATA[<p>åŸºäºä¸Šä¸€ç¯‡<a href="/posts/2023/11/04/ncmdump/">NCM æ–‡ä»¶æ‰¹é‡è½¬æ¢ (ä¿ç•™ä¸“è¾‘å’Œå°é¢ä¿¡æ¯)</a>, è®°å½•ä¸€ä¸‹è‡ªå·±ç¬¬ä¸€æ¬¡å¾€ PyPI ä¸Šå‘å¸ƒåŒ…çš„è¿‡ç¨‹.</p>
<p>æœ¬æ–‡ç»“åˆ Python å®˜æ–¹æ•™ç¨‹ <span class="exturl" data-url="aHR0cHM6Ly9wYWNrYWdpbmcucHl0aG9uLm9yZy9lbi9sYXRlc3QvdHV0b3JpYWxzL3BhY2thZ2luZy1wcm9qZWN0cy8=">Packaging Python Projects<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L2luZGV4Lmh0bWw=">Setuptools<i class="fa fa-external-link-alt"></i></span> çš„ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS8=">User guide<i class="fa fa-external-link-alt"></i></span> è¿›è¡Œæ‰“åŒ…å’Œå‘å¸ƒ.</p>
<span id="more"></span>

<h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ncmdump-py</span><br><span class="line">  â”œâ”€ ncmdump</span><br><span class="line">  â”‚   â”œâ”€ core.py</span><br><span class="line">  â”‚   â”œâ”€ crypto.py</span><br><span class="line">  â”‚   â”œâ”€ __init__.py</span><br><span class="line">  â”‚   â””â”€ __main__.py</span><br><span class="line">  â”œâ”€ .gitignore</span><br><span class="line">  â”œâ”€ LICENSE</span><br><span class="line">  â”œâ”€ pyproject.toml</span><br><span class="line">  â””â”€ README.md</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯æœ¬é¡¹ç›®çš„ç›®å½•ç»“æ„, å…¶ä¸­ <code>ncmdump-py</code> æ˜¯é¡¹ç›®æ ¹ç›®å½•, è€Œ <code>ncmdump</code> æ˜¯æˆ‘ä»¬è¦å‘å¸ƒçš„åŒ…, å…¶ä»–æ–‡ä»¶æ˜¯ä¸€äº›é¡¹ç›®æ–‡ä»¶.</p>
<p>è¿™ç§ç»“æ„è¢«ç§°ä¸º <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9wYWNrYWdlX2Rpc2NvdmVyeS5odG1sI2ZsYXQtbGF5b3V0">flat-layout<i class="fa fa-external-link-alt"></i></span> å¸ƒå±€, ä¹Ÿå°±æ˜¯ç›´æ¥å°†è¦æ„å»ºçš„åŒ…æ”¾åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹.</p>
<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9wYWNrYWdlX2Rpc2NvdmVyeS5odG1sI3NyYy1sYXlvdXQ=">src-layout<i class="fa fa-external-link-alt"></i></span> å’Œç”¨äºå•æ¨¡å—æ„å»ºçš„ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9wYWNrYWdlX2Rpc2NvdmVyeS5odG1sI3NpbmdsZS1tb2R1bGUtZGlzdHJpYnV0aW9u">single-module-distribution<i class="fa fa-external-link-alt"></i></span>. æ­¤å¤– <code>Setuptools</code> è¿˜æ”¯æŒå„ç§è¯¦ç»†çš„è‡ªå®šä¹‰åŠŸèƒ½, å…·ä½“å¯ä»¥çœ‹ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9wYWNrYWdlX2Rpc2NvdmVyeS5odG1s">Package Discovery and Namespace Packages<i class="fa fa-external-link-alt"></i></span> é¡µé¢.</p>
<h2 id="å®‰è£…å¿…è¦çš„å·¥å…·åº“"><a href="#å®‰è£…å¿…è¦çš„å·¥å…·åº“" class="headerlink" title="å®‰è£…å¿…è¦çš„å·¥å…·åº“"></a>å®‰è£…å¿…è¦çš„å·¥å…·åº“</h2><p>ä½¿ç”¨ <code>pip install build</code> å®‰è£… <code>build</code> åº“. è¿™æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·, èƒ½å¤Ÿè‡ªåŠ¨ä¸‹è½½ <code>setuptools</code> å’Œå…¶ä»–æ„å»ºæ—¶çš„å¿…è¦ä¾èµ–, ä¹‹åé€šè¿‡ <code>python -m build</code> å³å¯å®Œæˆé¡¹ç›®æ„å»º.</p>
<p>å¦ä¸€ä¸ªå·¥å…·æ˜¯ <code>twine</code>, ä½¿ç”¨ <code>pip install twine</code> å®‰è£…, è¯¥å·¥å…·ç”¨æ¥å°†æˆ‘ä»¬æ„å»ºåçš„æ–‡ä»¶ä¸Šä¼ è‡³ PyPI ä¸­.</p>
<h2 id="ç¼–å†™é¡¹ç›®é…ç½®æ–‡ä»¶"><a href="#ç¼–å†™é¡¹ç›®é…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–å†™é¡¹ç›®é…ç½®æ–‡ä»¶"></a>ç¼–å†™é¡¹ç›®é…ç½®æ–‡ä»¶</h2><p><code>setuptools</code> æ”¯æŒä¸‰ç§æ–¹å¼ç¼–å†™é¡¹ç›®é…ç½®æ–‡ä»¶, åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º <code>pyproject.toml</code>, <code>setup.cfg</code> æˆ–è€… <code>setup.py</code>.</p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ¨èçš„ <code>pyproject.toml</code> æ–¹å¼, å¹¶ä¸”å°½é‡é¿å…ä½¿ç”¨ <code>setup.py</code> (<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmdhbnNzbGUuaW8vYXJ0aWNsZXMvMjAyMS8xMC9zZXR1cC1weS1kZXByZWNhdGVkLmh0bWw=">Why you shouldnâ€™t invoke setup.py directly<i class="fa fa-external-link-alt"></i></span>).</p>
<p>ä¸‹é¢è´´å‡ºæœ¬é¡¹ç›®çš„ <code>pyproject.toml</code>, å¹¶å¯¹å…¶è¿›è¡Œè§£é‡Š.</p>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="section">[build-system]</span></span><br><span class="line"><span class="attr">requires</span> = [<span class="string">&quot;setuptools&quot;</span>]</span><br><span class="line"><span class="attr">build-backend</span> = <span class="string">&quot;setuptools.build_meta&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[project]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;ncmdump-py&quot;</span></span><br><span class="line"><span class="attr">authors</span> = [</span><br><span class="line">    &#123;name = <span class="string">&quot;ww-rm&quot;</span>, email = <span class="string">&quot;ww-rm@qq.com&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"><span class="attr">description</span> = <span class="string">&quot;Dump ncm files to mp3 or flac files.&quot;</span></span><br><span class="line"><span class="attr">requires-python</span> = <span class="string">&quot;&gt;=3.7&quot;</span></span><br><span class="line"><span class="attr">dependencies</span> = [</span><br><span class="line">    <span class="string">&quot;mutagen&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Pillow&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pycryptodome&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rich&quot;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="attr">dynamic</span> = [<span class="string">&quot;version&quot;</span>, <span class="string">&quot;readme&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[project.urls]</span></span><br><span class="line"><span class="attr">&quot;Homepage&quot;</span> = <span class="string">&quot;https://github.com/ww-rm/ncmdump-py&quot;</span></span><br><span class="line"><span class="attr">&quot;Bug Tracker&quot;</span> = <span class="string">&quot;https://github.com/ww-rm/ncmdump-py/issues&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[tool.setuptools]</span></span><br><span class="line"><span class="attr">packages</span> = [<span class="string">&quot;ncmdump&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="section">[tool.setuptools.dynamic]</span></span><br><span class="line"><span class="attr">version</span> = &#123;attr = <span class="string">&quot;ncmdump.__version__&quot;</span>&#125;</span><br><span class="line"><span class="attr">readme</span> = &#123;file = [<span class="string">&quot;README.md&quot;</span>], content-type = <span class="string">&quot;text/markdown&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯ <code>build-system</code>, å¿…å¡«é¡¹, è¯¥é”®ä¸‹é¢å®šä¹‰äº†ä½¿ç”¨ä»€ä¹ˆæ–¹å¼è¿›è¡Œæ„å»º, è¿™é‡Œä½¿ç”¨ <code>setuptools</code>, ä¸€èˆ¬ä¸éœ€è¦æ›´æ”¹.</p>
<p>æ¥ç€ä¸‹é¢çš„æ˜¯ <code>project</code> é”®, è¿™ä¸‹é¢æœ‰å¾ˆå¤šå…³äºé¡¹ç›®çš„é…ç½®, å¹¶ä¸”å’Œ PyPI é¡¹ç›®é¡µé¢ä¸Šæœ‰å¯¹åº”å…³ç³», è¿™é‡ŒæŒ‘ä¸€äº›å…³é”®çš„æ¥è§£é‡Š.</p>
<p><code>name</code> æ˜¯åŒ…çš„åå­—, æŒ‡çš„æ˜¯ç”¨ <code>pip</code> å®‰è£…æ—¶æŒ‡å®šçš„åå­—, åœ¨ä»£ç å¯¼å…¥çš„æ—¶å€™è¿˜æ˜¯å’ŒåŒ…æœ¬èº«æ–‡ä»¶å¤¹åå­—ç›¸åŒ. æ¯”å¦‚è¿™ä¸ªé¡¹ç›®, å®‰è£…çš„å‘½ä»¤æ˜¯ <code>pip install ncmdump-py</code>, ä½†æ˜¯ä»£ç å¯¼å…¥çš„æ—¶å€™æ˜¯ <code>import ncmdump</code>.</p>
<p><code>dependencies</code> å®šä¹‰äº†é¡¹ç›®çš„ä¾èµ–åº“, è¯­æ³•å’Œ <code>requirements.txt</code> ä¸€æ ·, åˆ—è¡¨é‡Œæ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªä¾èµ–, è¯¦ç»†è¯­æ³•å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9kZXBlbmRlbmN5X21hbmFnZW1lbnQuaHRtbA==">Dependencies Management in Setuptools<i class="fa fa-external-link-alt"></i></span>.</p>
<p><code>dynamic</code> å®šä¹‰äº†ä¸€äº›å˜é‡, å¸¸è§çš„å°±æ˜¯å®šä¹‰ç‰ˆæœ¬å·å’Œé¡¹ç›®æ–‡æ¡£, æ¯•ç«Ÿæ‰‹åŠ¨å¡«å†™ç¹çä¸”å®¹æ˜“å‡ºé”™. å®ƒéœ€è¦ä¸åé¢ <code>tool.setuptools.dynamic</code> è¿›è¡Œå¯¹åº”. è¯¦ç»†è¯­æ³•å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9weXByb2plY3RfY29uZmlnLmh0bWwjZHluYW1pYy1tZXRhZGF0YQ==">Dynamic Metadata<i class="fa fa-external-link-alt"></i></span> é¡µé¢å†…å®¹.</p>
<p>æ›´å¤šä¸ <code>pyproject.toml</code> æœ‰å…³çš„å†…å®¹å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L3VzZXJndWlkZS9weXByb2plY3RfY29uZmlnLmh0bWw=">Configuring setuptools using pyproject.toml files<i class="fa fa-external-link-alt"></i></span>, ä»¥åŠ Python å®˜æ–¹ <span class="exturl" data-url="aHR0cHM6Ly9wYWNrYWdpbmcucHl0aG9uLm9yZy9lbi9sYXRlc3Qvc3BlY2lmaWNhdGlvbnMvZGVjbGFyaW5nLXByb2plY3QtbWV0YWRhdGEv">Declaring project metadata<i class="fa fa-external-link-alt"></i></span> é¡µé¢è§„å®šçš„é¡¹ç›®é…ç½®é¡¹.</p>
<h2 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h2><p>é¦–å…ˆç¡®ä¿å·²ç»å®‰è£…äº†å‰æ–‡è¯´çš„ <code>build</code> åº“, ä»¥åŠå‡†å¤‡äº†ä¸€ä¸ªåˆé€‚çš„ç‰ˆæœ¬å·å’Œ <code>LICENSE</code> æ–‡ä»¶, å¯ä»¥å‚è€ƒ <span class="exturl" data-url="aHR0cHM6Ly9zZW12ZXIub3JnLw==">Semantic Versioning<i class="fa fa-external-link-alt"></i></span> ä¸ <span class="exturl" data-url="aHR0cHM6Ly9jaG9vc2VhbGljZW5zZS5jb20v">Choose an open source license<i class="fa fa-external-link-alt"></i></span> è®©è‡ªå·±çš„é¡¹ç›®çœ‹èµ·æ¥æ›´è§„èŒƒä¸€ç‚¹.</p>
<p>ç„¶åå°±æ˜¯å‚»ç“œå¼æ„å»º, åœ¨å½“å‰æ ¹ç›®å½•ä¸‹è¿è¡Œ:</p>
<p><code>python -m build</code></p>
<p>ç„¶åå°±ä¼šç”Ÿæˆä¸€ä¸ª <code>dist</code> æ–‡ä»¶å¤¹, é‡Œé¢åŒ…å«æ‰“åŒ…å¥½çš„é¡¹ç›®æ–‡ä»¶.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ncmdump-py</span><br><span class="line">  â””â”€ dist</span><br><span class="line">      â”œâ”€ ncmdump_py-1.0.1-py3-none-any.whl</span><br><span class="line">      â””â”€ ncmdump-py-1.0.1.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h2><p>é¦–å…ˆç¡®ä¿å·²ç»å®‰è£…äº†å‰æ–‡è¯´çš„ <code>twine</code> åº“, ç„¶åéœ€è¦å» <span class="exturl" data-url="aHR0cHM6Ly90ZXN0LnB5cGkub3JnLw==">TestPyPI<i class="fa fa-external-link-alt"></i></span> å’Œ <span class="exturl" data-url="aHR0cHM6Ly9weXBpLm9yZy8=">PyPI<i class="fa fa-external-link-alt"></i></span> åˆ†åˆ«æ³¨å†Œè‡ªå·±çš„è´¦å·.</p>
<p>å…¶ä¸­ <code>TestPyPI</code> æ˜¯ç”¨æ¥æµ‹è¯•çš„, è€Œ <code>PyPI</code> æ˜¯çœŸå®å‘å¸ƒé¡µ, å»ºè®®ç¬¬ä¸€æ¬¡å°è¯•è¿˜æ˜¯ç”¨ <code>TestPyPI</code> å…ˆæµ‹è¯•ç†Ÿæ‚‰ä¸€ä¸‹æµç¨‹, é¿å…å‡ºé”™æ— æ³•ä¿®æ”¹. ä¸‹é¢çš„å†…å®¹å°†åˆ†åˆ«è¯´æ˜åœ¨ <code>TestPyPI</code> å’Œ <code>PyPI</code> ä¸Šçš„å‘½ä»¤å·®å¼‚.</p>
<p>è¿™é‡Œå…ˆè¯´è¯´é‡åˆ°çš„å°é—®é¢˜, åœ¨å†™æœ¬æ–‡æ—¶, <code>TestPyPI</code> å’Œ <code>PyPI</code> åœ¨æ³¨å†Œè´¦å·å, å·²ç»å¼ºåˆ¶è¦æ±‚å¼€å¯åŒå› ç´ è®¤è¯ (2FA), ä½†æ˜¯å¼€å¯äº†åŒå› ç´ è®¤è¯çš„è´¦å·ä¸èƒ½ä½¿ç”¨è´¦å¯†çš„å½¢å¼ä¸Šä¼ æ–‡ä»¶, å› æ­¤æˆåŠŸæ³¨å†Œè´¦å·å, æˆ‘ä»¬è¿˜éœ€è¦å»ç”³è¯·ä¸€ä¸ªé€šç”¨çš„ API token.</p>
<p>åœ¨ <code>Account settings</code> ä¸­å¾€ä¸‹ç¿», å¯ä»¥æ‰¾åˆ° <code>API tokens</code> è®¾ç½®é¡¹, æˆ‘ä»¬é€‰æ‹© <code>Add API token</code>, å¹¶ä¸”å°† <code>Scope</code> é€‰æ‹©ä¸º <code>Entire account (all projects)</code> (ç¬¬ä¸€æ¬¡å‘å¸ƒè‚¯å®šåªèƒ½é€‰æˆå…¨å±€çš„).</p>
<p>æ·»åŠ å®Œæˆä¹‹å, æˆ‘ä»¬éœ€è¦åŠæ—¶çš„<strong>å°† token å¤åˆ¶å¹¶ä¿å­˜</strong>ä¸‹æ¥, ä¹‹åå†è¿›æ¥å°±<strong>ä¸ä¼šæ˜¾ç¤º</strong> token äº†.</p>
<p>ç„¶åä½¿ç”¨ <code>twine</code> è¿›è¡Œä¸Šä¼ .</p>
<div class="tabs" id="upload-by-twine"><ul class="nav-tabs"><li class="tab active"><a href="#upload-by-twine-1">TestPyPI</a></li><li class="tab"><a href="#upload-by-twine-2">PyPI</a></li></ul><div class="tab-content"><div class="tab-pane active" id="upload-by-twine-1"><p><code>python -m twine upload --repository testpypi dist/*</code></p></div><div class="tab-pane" id="upload-by-twine-2"><p><code>python -m twine upload dist/*</code></p></div></div></div>

<p>è¿è¡Œä¹‹å, ä¼šè¦æ±‚ä½ è¾“å…¥ <code>username</code> å’Œ <code>password</code>. åœ¨ä½¿ç”¨ token çš„æƒ…å†µä¸‹, <code>username</code> å¡« <code>__token__</code>, è€Œ <code>password</code> å¡«åˆšåˆšå¤åˆ¶å¹¶ä¿å­˜ä¸‹æ¥çš„ token å­—ç¬¦ä¸².</p>
<p>æˆåŠŸä¸Šä¼ ä¹‹å, ä¼šæ˜¾ç¤ºä¸Šä¼ åçš„é¡µé¢é“¾æ¥.</p>
<p>ç„¶åå¯ä»¥é€šè¿‡ <code>pip</code> æµ‹è¯•ä¸€ä¸‹æ˜¯å¦å¯ä»¥æ­£å¸¸å®‰è£…:</p>
<div class="tabs" id="install-by-pip"><ul class="nav-tabs"><li class="tab active"><a href="#install-by-pip-1">TestPyPI</a></li><li class="tab"><a href="#install-by-pip-2">PyPI</a></li></ul><div class="tab-content"><div class="tab-pane active" id="install-by-pip-1"><p><code>pip install -i https://test.pypi.org/simple/ ncmdump-py</code></p></div><div class="tab-pane" id="install-by-pip-2"><p><code>pip install ncmdump-py</code></p></div></div></div>

<p>æœ€åçš„æœ€å, å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥ç”¨æˆ·åå’Œå¯†ç , æˆ‘ä»¬å¯ä»¥å†™ä¸€ä»½ <code>~/.pypirc</code> é…ç½®æ–‡ä»¶.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[testpypi]</span><br><span class="line">username = __token__</span><br><span class="line">password = &lt;token value&gt;</span><br><span class="line"></span><br><span class="line">[pypi]</span><br><span class="line">username = __token__</span><br><span class="line">password = &lt;token value&gt;</span><br></pre></td></tr></table></figure>

<p>Windows ä¸‹æŠŠæ–‡ä»¶æ”¾åœ¨ç”¨æˆ·ä¸»ç›®å½• <code>%USERPROFILE%</code> (<code>C:\Users\&lt;UserName&gt;</code>) ä¸‹å³å¯, ä¹‹åæ¯æ¬¡è¿è¡Œ <code>twine upload</code> å°±ä¼šè‡ªåŠ¨è¯»å– token å®Œæˆä¸Šä¼ .</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9wYWNrYWdpbmcucHl0aG9uLm9yZy9lbi9sYXRlc3QvdHV0b3JpYWxzL3BhY2thZ2luZy1wcm9qZWN0cy8=">Packaging Python Projects<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zZXR1cHRvb2xzLnB5cGEuaW8vZW4vbGF0ZXN0L2luZGV4Lmh0bWw=">Setuptools<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zZW12ZXIub3JnLw==">Semantic Versioning<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9jaG9vc2VhbGljZW5zZS5jb20v">Choose an open source license<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>pypi</tag>
        <tag>setuptools</tag>
        <tag>python åŒ…å‘å¸ƒ</tag>
      </tags>
  </entry>
  <entry>
    <title>ECC ç®—æ³•åŸç†ç®€ä»‹ä¸å®ç°</title>
    <url>//posts/2022/12/07/simple-ecc/</url>
    <content><![CDATA[<p>æœ¬æ–‡è®°äºæŸæ¬¡å¯†ç ä½œä¸šè¯¾ä½™, æä¾›å¯¹ ECC ç®—æ³•çš„ç®€è¦ä»‹ç»ä¸ç®€å•å®ç°, æ–‡æœ«é™„æœ‰ä»£ç .</p>
<span id="more"></span>

<h2 id="ç†è®ºä»‹ç»"><a href="#ç†è®ºä»‹ç»" class="headerlink" title="ç†è®ºä»‹ç»"></a>ç†è®ºä»‹ç»</h2><h3 id="ç´ åŸŸä¸Šçš„ç¦»æ•£æ¤­åœ†æ›²çº¿"><a href="#ç´ åŸŸä¸Šçš„ç¦»æ•£æ¤­åœ†æ›²çº¿" class="headerlink" title="ç´ åŸŸä¸Šçš„ç¦»æ•£æ¤­åœ†æ›²çº¿"></a>ç´ åŸŸä¸Šçš„ç¦»æ•£æ¤­åœ†æ›²çº¿</h3><p>å½¢å¦‚ $y^2 = x^3 + ax + b \bmod p$ çš„æ›²çº¿å«æ¤­åœ†æ›²çº¿, å…¶ä¸­éœ€æ»¡è¶³ $p$ æ˜¯å¤§äº $3$ çš„ç´ æ•°, ä¸” $4a^3 + 27b^2 \ne 0 \bmod p$.</p>
<p>å…ˆä¸çœ‹ $\bmod$ è®°å·, é‚£ä¹ˆè¿™å°±æ˜¯ä¸€æ¡æ™®é€šçš„è¿ç»­æ›²çº¿, å¯ä»¥æŒ‰ç…§æ™®é€šçš„æ–¹ç¨‹æ±‚è§£, ç»™å®šä¸€ä¸ª $x$, å°±å¯ä»¥æ±‚å‡ºæ¥å¯¹åº”çš„ $y$. å®¹æ˜“çœ‹å‡ºæ¥, è¿™æ¡æ›²çº¿æ˜¯å…³äº $x$ è½´å¯¹ç§°çš„, å› æ­¤å®ƒçš„å›¾åƒå¤§æ¦‚é•¿ä¸‹é¢è¿™ç§æ ·å­.</p>
<p><img data-src="/static/image/simple-ecc/zcG6gI.png" alt="zcG6gI.png"></p>
<p>å¯ä»¥æœ‰å‡ ç§ä¸åŒçš„å½¢å¼, ä½†æ˜¯åŸºæœ¬ä¸Šå·®ä¸å¤š.</p>
<p>é‚£ä¹ˆåŠ äº† $\bmod$ è®°å·ä¹‹åæœ‰ä»€ä¹ˆä¸åŒå‘¢? åˆšåˆšæ˜¯æ ¹æ®å®æ•°åŸŸç”»å‡ºæ¥çš„è¿ç»­æ›²çº¿, é‚£ä¹ˆåŠ ä¸Š $\bmod$ ä¹‹å, æ›²çº¿è¿˜æ˜¯è¿™æ¡æ›²çº¿, ä½†æ˜¯åæ ‡å–å€¼èŒƒå›´å˜æˆäº†æ•´æ•°èŒƒå›´, ä¸”å–å€¼åœ¨ $[0, p-1]$ ä¹‹é—´.</p>
<p>ä¹Ÿå°±æ˜¯ä»è¿™æ¡æ›²çº¿ä¸ŠæŒ‘å‡ºäº†ä¸€äº›ç¦»æ•£çš„æ•´æ•°è§£, ä¸ä»…èƒ½å¤Ÿæ»¡è¶³è¿™ä¸ªæ›²çº¿æ–¹ç¨‹, åŒæ—¶ $x$ å’Œ $y$ çš„å–å€¼èŒƒå›´åœ¨ $[0, p-1]$, ä¹Ÿå°±æ˜¯å¯¹ $p$ å–æ¨¡, æ‰€æœ‰çš„æ•°æ®è¿ç®—éƒ½åœ¨æ¨¡ $p$ ä¸‹è¿›è¡Œ, å› æ­¤å°†è¿™ç§æ›²çº¿è®°ä¸º $y^2 = x^3 + ax + b \bmod p$.</p>
<p>æ‰€ä»¥, ECC ä¸­ä½¿ç”¨çš„æ¤­åœ†æ›²çº¿å¹¶ä¸æ˜¯ä¸€æ¡çœŸæ­£è¿ç»­çš„æ›²çº¿, è€Œæ˜¯ç”±å¾ˆå¤šç¦»æ•£çš„ç‚¹ç»„æˆçš„.</p>
<h3 id="æ¤­åœ†æ›²çº¿ä¸Šçš„è¿ç®—"><a href="#æ¤­åœ†æ›²çº¿ä¸Šçš„è¿ç®—" class="headerlink" title="æ¤­åœ†æ›²çº¿ä¸Šçš„è¿ç®—"></a>æ¤­åœ†æ›²çº¿ä¸Šçš„è¿ç®—</h3><p>æ—¢ç„¶è¦ä½¿ç”¨æ¤­åœ†æ›²çº¿è¿›è¡Œè®¡ç®—, é‚£ä¹ˆå…ˆå¾—å®šä¹‰åœ¨æ¤­åœ†æ›²çº¿ä¸Šçš„è¿ç®—.</p>
<p>æˆ‘ä»¬éƒ½å­¦è¿‡å‘é‡çš„è¿ç®—, å…¶ä¸­æœ€åŸºæœ¬çš„ä¸¤ç§è¿ç®—æ˜¯åŠ æ³•å’Œæ•°ä¹˜.</p>
<p>å¦‚æœè®¾ $\vec{a}$, $\vec{b}$ æ˜¯ä¸¤ä¸ªå‘é‡, é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¡ç®— $\vec{a}+\vec{b}$ çš„å€¼, è¿™ç§°ä¸º<strong>å‘é‡åŠ æ³•</strong>.</p>
<p>æˆ‘è¿˜å¯ä»¥è®¡ç®— $\vec{a}$ ä¸è‡ªå·±çš„ç›¸åŠ è¿ç®—, è®¡ç®— $k$ ä¸ª $\vec{a}$ è¿ç»­ç›¸åŠ , å¹¶ç®€è®°ä¸º $k\vec{a}$, è¿™ç§°ä¸º<strong>å‘é‡æ•°ä¹˜</strong>.</p>
<p>å¯ä»¥çœ‹å‡º, ç¬¬äºŒç§æƒ…å†µè™½ç„¶æœ‰ä¸ª&quot;ä¹˜&quot;å­—, ä½†æ˜¯ä»ç„¶å±äºåŠ æ³•è¿ç®—çš„ä¸€ç§, è‡³æ­¤, å‘é‡å…³äºåŠ æ³•çš„è¿ç®—å·²ç»åŸºæœ¬ä¸Šé½å…¨äº†, ä½†æ˜¯è¿˜ç¼ºå°‘ä¸€äº›ç‰¹æ®Šæƒ…å†µå®šä¹‰.</p>
<p>é¦–å…ˆæ˜¯ $0$ çš„å®šä¹‰, æ­¤å¤„æŒ‡çš„æ˜¯æŠ½è±¡çš„ $0$, ä¸æ˜¯æ•°å­— $0$, ä¹Ÿå°±æ˜¯å¯¹äºå‘é‡è¿ç®—æ¥è¯´, éœ€è¦æœ‰ä¸€ä¸ª $0$ å€¼çš„æ¦‚å¿µ, å®ƒåœ¨åŠ æ³•è¿ç®—ä¸­ä¸ä¼šå½±å“è¿ç®—æœ¬èº«, é€šå¸¸å°±å°†å…¶å®šä¹‰ä¸ºå…¨é›¶å‘é‡ $\vec{0}$, ä¹Ÿå¯ç§°å…¶ä¸º<strong>å•ä½å…ƒ</strong>.</p>
<p>è€Œåœ¨å®šä¹‰å®Œå•ä½å…ƒä¹‹å, å¯ä»¥å®šä¹‰å‘é‡å–è´Ÿ, ä¾é äº $\vec{0}$ æ¥è¿›è¡Œçš„, å¦‚æœæœ‰ $-\vec{a}$, åˆ™ $\vec{a} + (-\vec{a}) = \vec{0}$, è¿™æ ·å°±é€šè¿‡å•ä½å…ƒå®šä¹‰äº†åŠ æ³•çš„é€†è¿ç®—å‡æ³•çš„è§„åˆ™, å› ä¸ºå‡å»ä¸€ä¸ªåŸå‘é‡ç­‰äºåŠ ä¸ŠåŸå‘é‡çš„ç›¸åå‘é‡, è€Œç›¸åå‘é‡æ»¡è¶³ä¸Šè¿°å…³äºå•ä½å…ƒçš„ç­‰å¼, å› è€Œå¯ä»¥æ±‚å‡ºç›¸åå‘é‡çš„å…·ä½“å–å€¼. åœ¨è¿™é‡Œ, ç›¸åå‘é‡ç§°ä¹‹ä¸ºåŸå‘é‡çš„<strong>é€†å…ƒ</strong>.</p>
<p>è‡³æ­¤, æˆ‘ä»¬æˆåŠŸåœ¨å‘é‡ä¸­å®šä¹‰äº†è¿™äº›åŸºæœ¬æ¦‚å¿µ:</p>
<ul>
<li>åŠ æ³• ($\vec{a} + \vec{b}$)</li>
<li>æ•°ä¹˜ ($k\vec{a}$)</li>
<li>å•ä½å…ƒ ($\vec{0}$)</li>
<li>é€†å…ƒ ($-\vec{a}$)</li>
</ul>
<p>é‚£ä¹ˆ, æŠŠä¸Šè¿°ä¸­çš„&quot;å‘é‡&quot;å…¨éƒ¨æ¢æˆåˆ«çš„ä¸œè¥¿, æˆ‘ä»¬å°±å¯ä»¥å®šä¹‰å‡ºä¸€å¥—æ–°çš„æ•°æ®è¿ç®—, è€Œå¯¹äºæ¤­åœ†æ›²çº¿, æˆ‘ä»¬å°†&quot;å‘é‡&quot;æ¢æˆæ‰€æœ‰æ»¡è¶³æ¤­åœ†æ›²çº¿æ–¹ç¨‹çš„ç‚¹, å®šä¹‰äº†æ¤­åœ†æ›²çº¿ä¸Šçš„ç‚¹è¿ç®—è§„åˆ™.</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯å¯¹äºç‚¹åŠ æ³•å…·ä½“è¿‡ç¨‹çš„å®šä¹‰, ç”¨ä¸€å¼ å›¾æ¥ç›´è§‚è§£é‡Šæ¤­åœ†æ›²çº¿ä¸Šç‚¹æ˜¯å¦‚ä½•è¿›è¡Œ&quot;ç›¸åŠ &quot;çš„.</p>
<p><img data-src="/static/image/simple-ecc/zcYiWj.png" alt="zcYiWj.png"></p>
<p>è®¾ $P$, $Q$ ä¸ºæ¤­åœ†æ›²çº¿ä¸Šçš„ä¸¤ç‚¹, åˆ™ $P+Q$ å°±æ˜¯ $P$, $Q$ è¿çº¿ä¸æ›²çº¿çš„äº¤ç‚¹å…³äº $x$ è½´çš„å¯¹ç§°ç‚¹.</p>
<p>å½“ $P$, $Q$ é‡åˆæ—¶, å–åˆ‡çº¿ä¸æ›²çº¿çš„äº¤ç‚¹çš„å¯¹ç§°ç‚¹ä½œä¸ºåŠ æ³•ç»“æœ, ä¹Ÿå°±æ˜¯ $2P$.</p>
<p>å½“ $P$, $Q$ å…³äº $x$ è½´å¯¹ç§°æ—¶, å®šä¹‰ç›¸åŠ ç»“æœä¸ºæ— ç©·è¿œç‚¹, è§†ä½œåŠ æ³•çš„å•ä½å…ƒç‚¹, è®°ä¸º $O$, åŒæ—¶æ˜“å¾—æ­¤æ—¶ $P$, $Q$ äº’ä¸ºå¯¹æ–¹çš„é€†å…ƒ.</p>
<h3 id="æ¤­åœ†æ›²çº¿è¿ç®—å…¬å¼"><a href="#æ¤­åœ†æ›²çº¿è¿ç®—å…¬å¼" class="headerlink" title="æ¤­åœ†æ›²çº¿è¿ç®—å…¬å¼"></a>æ¤­åœ†æ›²çº¿è¿ç®—å…¬å¼</h3><p>è¿ç®—å…¬å¼æŒ‰ç…§æ™®é€šçš„è§£æå‡ ä½•å»æ±‚è§£å³å¯, åœ¨æ­¤ç›´æ¥ç»™å‡ºå…¬å¼, åˆ†ä¸ºä¸¤ç‚¹ä¸é‡åˆå’Œé‡åˆçš„æƒ…å†µ.</p>
<p>è®¾æ›²çº¿æ–¹ç¨‹æ˜¯ $y^2 = x^3 + ax + b$, $R(x_3, y_3)=P(x_1, y_1) + Q(x_2, y_2)$, åˆ™:</p>
<p>$$<br>\left\{<br>  \begin{align*}<br>    x_3 &amp;= \lambda^2 - x_1 - x_2 \\<br>    y_3 &amp;= \lambda(x_1 - x_3) - y_1<br>  \end{align*}<br>\right.<br>$$</p>
<p>å…¶ä¸­, å½“ $P(x_1, y_1) \ne Q(x_2, y_2)$, å³ä¸¤ç‚¹ä¸é‡åˆæ—¶,</p>
<p>$$<br>\lambda = \frac{y_2 - y_1}{x_2 - x_1}<br>$$</p>
<p>å½“ $P(x_1, y_1) = Q(x_2, y_2)$, å³ä¸¤ç‚¹é‡åˆæ—¶,</p>
<p>$$<br>\lambda = \frac{3x_1^2+a}{2y_1}<br>$$</p>
<h3 id="å…¶ä»–æ¦‚å¿µ"><a href="#å…¶ä»–æ¦‚å¿µ" class="headerlink" title="å…¶ä»–æ¦‚å¿µ"></a>å…¶ä»–æ¦‚å¿µ</h3><p>ä¸€äº›ä»£ç å®ç°æ—¶éœ€è¦çŸ¥é“çš„æ¦‚å¿µ, åœ¨æ­¤ç®€å•è®°å½•.</p>
<ul>
<li>å¾ªç¯ç¾¤: å¾ªç¯ç¾¤æ˜¯ä¸€äº›ç‚¹çš„é›†åˆ, ç¾¤å†…å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šç‚¹ $G$, åœ¨è¿™ä¸ªç¾¤å†…çš„ä»»ä½•ä¸€ä¸ªç‚¹, éƒ½å¯ä»¥ç”± $G, 2G, ..., nG$ è¡¨ç¤º, å¯¹ $G$ çš„ $n$ æ¬¡åŠ æ³•è¿ç®—èƒ½å¤Ÿéå†ç¾¤ä¸­çš„æ¯ä¸ªç‚¹, ç¾¤çš„å¤§å°æ˜¯ $n$.</li>
<li>ç”Ÿæˆå…ƒ: å¾ªç¯ç¾¤ä¸­çš„ $G$ ç§°ä¸ºè¿™ä¸ªå¾ªç¯ç¾¤çš„ç”Ÿæˆå…ƒ.</li>
<li>é˜¶: æŒ‡å¾ªç¯ç¾¤æˆ–è€…ç”Ÿæˆå…ƒçš„é˜¶, å°±æ˜¯ç”Ÿæˆå…ƒæ‰€åœ¨å¾ªç¯ç¾¤çš„å¤§å° $n$.</li>
<li>æ¨¡é€†è¿ç®—: æŒ‡æ±‚è§£æ–¹ç¨‹ $ax \equiv 1 \bmod p$, å³ $a$ åœ¨æ¨¡ $p$ è¿ç®—ä¸‹çš„&quot;å€’æ•°&quot;.</li>
</ul>
<h2 id="æ¤­åœ†æ›²çº¿ä»£ç å®ç°"><a href="#æ¤­åœ†æ›²çº¿ä»£ç å®ç°" class="headerlink" title="æ¤­åœ†æ›²çº¿ä»£ç å®ç°"></a>æ¤­åœ†æ›²çº¿ä»£ç å®ç°</h2><h3 id="æ›²çº¿ä¸ç‚¹çš„å®šä¹‰"><a href="#æ›²çº¿ä¸ç‚¹çš„å®šä¹‰" class="headerlink" title="æ›²çº¿ä¸ç‚¹çš„å®šä¹‰"></a>æ›²çº¿ä¸ç‚¹çš„å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> x;</span><br><span class="line">    <span class="type">int64_t</span> y;</span><br><span class="line">&#125; EccPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int64_t</span> a;</span><br><span class="line">    <span class="type">int64_t</span> b;</span><br><span class="line">    <span class="type">int64_t</span> p;</span><br><span class="line">&#125; EC; <span class="comment">// y^2 = x^3 + ax + b (mod p)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    EccPoint pt;</span><br><span class="line">    <span class="type">int64_t</span> n;</span><br><span class="line">&#125; GenPoint;</span><br></pre></td></tr></table></figure>

<h3 id="è¾…åŠ©è¿ç®—"><a href="#è¾…åŠ©è¿ç®—" class="headerlink" title="è¾…åŠ©è¿ç®—"></a>è¾…åŠ©è¿ç®—</h3><p>æ¨¡ $p$ è¿ç®—å’Œæ¨¡é€†è¿ç®—.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int64_t</span> <span class="title function_">modp</span><span class="params">(<span class="type">int64_t</span> x, <span class="type">int64_t</span> p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (x &lt; <span class="number">0</span>) x += p;</span><br><span class="line">    x %= p;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int64_t</span> <span class="title function_">inverse</span><span class="params">(<span class="type">int64_t</span> x, <span class="type">int64_t</span> p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int64_t</span> q = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> r1 = p;</span><br><span class="line">    <span class="type">int64_t</span> r2 = x;</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> t1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int64_t</span> t2 = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int64_t</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (r2 &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        q = r1 / r2, r = r1 % r2;</span><br><span class="line">        r1 = r2, r2 = r;</span><br><span class="line"></span><br><span class="line">        t = t1 - q * t2;</span><br><span class="line">        t1 = t2, t2 = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t1 = modp(t1, p);</span><br><span class="line">    <span class="keyword">return</span> t1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç‚¹åŠ ä¸æ•°ä¹˜"><a href="#ç‚¹åŠ ä¸æ•°ä¹˜" class="headerlink" title="ç‚¹åŠ ä¸æ•°ä¹˜"></a>ç‚¹åŠ ä¸æ•°ä¹˜</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">addpt</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">const</span> EC* ec,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> EccPoint* pt1, <span class="type">const</span> EccPoint* pt2,</span></span><br><span class="line"><span class="params">    EccPoint* new_pt</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (pt1-&gt;x == <span class="number">-1</span> &amp;&amp; pt1-&gt;y == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        new_pt-&gt;x = pt2-&gt;x;</span><br><span class="line">        new_pt-&gt;y = pt2-&gt;y;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pt2-&gt;x == <span class="number">-1</span> &amp;&amp; pt2-&gt;y == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        new_pt-&gt;x = pt1-&gt;x;</span><br><span class="line">        new_pt-&gt;y = pt1-&gt;y;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int64_t</span> lambda = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int64_t</span> new_x = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int64_t</span> new_y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pt1-&gt;x == pt2-&gt;x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Unit</span></span><br><span class="line">            <span class="keyword">if</span> (pt1-&gt;y + pt2-&gt;y == ec-&gt;p)</span><br><span class="line">            &#123;</span><br><span class="line">                new_pt-&gt;x = <span class="number">-1</span>;</span><br><span class="line">                new_pt-&gt;y = <span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Same</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (pt1-&gt;y == pt2-&gt;y)</span><br><span class="line">            &#123;</span><br><span class="line">                lambda = (<span class="number">3</span> * pt1-&gt;x * pt1-&gt;x + ec-&gt;a) * inverse(<span class="number">2</span> * pt1-&gt;y, ec-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Different</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int64_t</span> delta_x = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int64_t</span> delta_y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            delta_x = modp((pt2-&gt;x - pt1-&gt;x), ec-&gt;p);</span><br><span class="line">            delta_y = modp((pt2-&gt;y - pt1-&gt;y), ec-&gt;p);</span><br><span class="line">            lambda = delta_y * inverse(delta_x, ec-&gt;p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lambda %= ec-&gt;p;</span><br><span class="line"></span><br><span class="line">        new_x = modp((lambda * lambda - pt1-&gt;x - pt2-&gt;x), ec-&gt;p);</span><br><span class="line">        new_y = modp((lambda * (pt1-&gt;x - new_x) - pt1-&gt;y), ec-&gt;p);</span><br><span class="line"></span><br><span class="line">        new_pt-&gt;x = new_x;</span><br><span class="line">        new_pt-&gt;y = new_y;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">mulpt</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">const</span> EC* ec,</span></span><br><span class="line"><span class="params">    <span class="type">uint64_t</span> k, <span class="type">const</span> EccPoint* pt,</span></span><br><span class="line"><span class="params">    EccPoint* new_pt</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    new_pt-&gt;x = <span class="number">-1</span>;</span><br><span class="line">    new_pt-&gt;y = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">64</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        addpt(ec, new_pt, new_pt, new_pt);</span><br><span class="line">        <span class="keyword">if</span> (k &amp; <span class="number">0x8000000000000000</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            addpt(ec, new_pt, pt, new_pt);</span><br><span class="line">        &#125;</span><br><span class="line">        k &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è®¡ç®—æ¤­åœ†æ›²çº¿çš„æ‰€æœ‰ç‚¹åŠå…¶é˜¶"><a href="#è®¡ç®—æ¤­åœ†æ›²çº¿çš„æ‰€æœ‰ç‚¹åŠå…¶é˜¶" class="headerlink" title="è®¡ç®—æ¤­åœ†æ›²çº¿çš„æ‰€æœ‰ç‚¹åŠå…¶é˜¶"></a>è®¡ç®—æ¤­åœ†æ›²çº¿çš„æ‰€æœ‰ç‚¹åŠå…¶é˜¶</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint8_t</span> <span class="title function_">isprime</span><span class="params">(<span class="type">int64_t</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">2</span>; i &lt; (<span class="type">int64_t</span>)sqrtl((<span class="type">long</span> <span class="type">double</span>)x); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x % i == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int64_t</span> <span class="title function_">compute_ptrank</span><span class="params">(<span class="type">const</span> EC* ec, <span class="type">const</span> EccPoint* pt)</span></span><br><span class="line">&#123;</span><br><span class="line">    EccPoint tmp = &#123; pt-&gt;x, pt-&gt;y &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> rank = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        addpt(ec, &amp;tmp, pt, &amp;tmp);</span><br><span class="line">        <span class="keyword">if</span> (tmp.x == pt-&gt;x &amp;&amp; tmp.y == pt-&gt;y)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rank++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rank;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_points</span><span class="params">(EC* ec)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;EC: &#123; a = %lld, b = %lld, p = %lld &#125;\n&quot;</span>, ec-&gt;a, ec-&gt;b, ec-&gt;p);</span><br><span class="line">    <span class="keyword">if</span> (modp(<span class="number">4</span> * ec-&gt;a * ec-&gt;a * ec-&gt;a + <span class="number">27</span> * ec-&gt;b * ec-&gt;b, ec-&gt;p) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Params Invalid!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int64_t</span> pt_count = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int64_t</span> y_sqr = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int64_t</span> y = <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint8_t</span> find = <span class="number">0</span>;</span><br><span class="line">        EccPoint pt_tmp = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="type">int64_t</span> pt_rank = <span class="number">0</span>;</span><br><span class="line">        <span class="type">char</span> prime_rank = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int64_t</span> x = <span class="number">0</span>; x &lt; ec-&gt;p; x++)</span><br><span class="line">        &#123;</span><br><span class="line">            y_sqr = modp((x * x * x + ec-&gt;a * x + ec-&gt;b), ec-&gt;p);</span><br><span class="line">            find = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (y_sqr &lt; (ec-&gt;p - <span class="number">1</span>) * (ec-&gt;p - <span class="number">1</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                y = (<span class="type">int64_t</span>)sqrtl((<span class="type">long</span> <span class="type">double</span>)y_sqr);</span><br><span class="line">                <span class="keyword">if</span> (y * y == y_sqr)</span><br><span class="line">                &#123;</span><br><span class="line">                    find = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                y_sqr += ec-&gt;p;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (find)</span><br><span class="line">            &#123;</span><br><span class="line">                pt_tmp.x = x;</span><br><span class="line">                pt_tmp.y = y;</span><br><span class="line">                pt_rank = compute_ptrank(ec, &amp;pt_tmp);</span><br><span class="line">                prime_rank = (isprime(pt_rank) ? <span class="string">&#x27;P&#x27;</span> : <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">                pt_count++;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;(%5lld, %5lld)[%5lld][%c], &quot;</span>, pt_tmp.x, pt_tmp.y, pt_rank, prime_rank);</span><br><span class="line">                <span class="keyword">if</span> (pt_count % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (y != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    pt_tmp.y = ec-&gt;p - y;</span><br><span class="line">                    pt_count++;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;(%5lld, %5lld)[%5lld][%c], &quot;</span>, pt_tmp.x, pt_tmp.y, pt_rank, prime_rank);</span><br><span class="line">                    <span class="keyword">if</span> (pt_count % <span class="number">4</span> == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;(%5d, %5d)[%5d][%c]\n&quot;</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">1</span>, <span class="string">&#x27;C&#x27;</span>);</span><br><span class="line">        pt_count++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;EccPoints Count: %lld\n&quot;</span>, pt_count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨æ¤­åœ†æ›²çº¿è¿›è¡Œæ•°æ®åŠ å¯†"><a href="#ä½¿ç”¨æ¤­åœ†æ›²çº¿è¿›è¡Œæ•°æ®åŠ å¯†" class="headerlink" title="ä½¿ç”¨æ¤­åœ†æ›²çº¿è¿›è¡Œæ•°æ®åŠ å¯†"></a>ä½¿ç”¨æ¤­åœ†æ›²çº¿è¿›è¡Œæ•°æ®åŠ å¯†</h2><p>å‰é¢åªæ˜¯å®ç°äº†å…³äºæ¤­åœ†æ›²çº¿çš„è¿ç®—, ç°åœ¨éœ€è¦ä½¿ç”¨è¿™ä¸ªè¿ç®—æ¥æ„å»ºä¸€ä¸ªå¯†ç ç®—æ³•, è¿™å…¶ä¸­ä½¿ç”¨åˆ°çš„é—®é¢˜ç§°ä¸ºæ¤­åœ†æ›²çº¿ä¸Šçš„ç¦»æ•£å¯¹æ•°é—®é¢˜.</p>
<h3 id="ECDLP"><a href="#ECDLP" class="headerlink" title="ECDLP"></a>ECDLP</h3><p>è®¾æ›²çº¿ä¸º $y^2 = x^3 + ax + b \bmod p$, $p$ ä¸ºå¤§äº $3$ çš„ç´ æ•°, ä¸” $4a^3 + 27b^2 \ne 0 \bmod p$.</p>
<p>æ›²çº¿ä¸Šçš„ä¸€ä¸ªå¾ªç¯ç¾¤è®°ä¸º $&lt;G, n&gt;$, $G$ æ˜¯ç¾¤çš„ç”Ÿæˆå…ƒ, $n$ æ˜¯ç¾¤çš„é˜¶, ä¸” $n$ ä¸ºç´ æ•°.</p>
<p>è®¾ $P$, $Q$ æ˜¯ç¾¤ä¸Šçš„ä¸¤ç‚¹, ä¸” $Q = tP$, $t$ ä¸ºæ­£æ•´æ•°ä¸” $t \in [1, n-1]$.</p>
<p>åˆ™å·²çŸ¥ $t$, $P$, è¦è®¡ç®— $Q$ æ˜¯ç®€å•çš„, ä½†æ˜¯åè¿‡æ¥, å·²çŸ¥ $P$, $Q$, è¦è®¡ç®— $t$ æ˜¯å›°éš¾çš„, è¿™å°±æ˜¯æ¤­åœ†æ›²çº¿ä¸Šçš„ç¦»æ•£å¯¹æ•°é—®é¢˜.</p>
<h3 id="å…¬ç§é’¥çš„é€‰å–"><a href="#å…¬ç§é’¥çš„é€‰å–" class="headerlink" title="å…¬ç§é’¥çš„é€‰å–"></a>å…¬ç§é’¥çš„é€‰å–</h3><p>æ ¹æ®å‰é¢ ECDLP çš„å®šä¹‰, å®šä¹‰ç”¨æˆ·çš„ç§é’¥ä¸º $d$, å¯ä»¥ä¸ºé›†åˆ $\{1, 2, ..., n-1\}$ ä¸­çš„ä¸€ä¸ªéšæœºæ•°, å…¬é’¥ä¸º $Q$, ä¸” $Q = dG$, $G$ æ˜¯å¾ªç¯ç¾¤ $&lt;G, n&gt;$ çš„ç”Ÿæˆå…ƒ. å…¶ä½™æ‰€æœ‰å’Œæ¤­åœ†æ›²çº¿æœ‰å…³çš„å‚æ•°å‡æ˜¯å…¬å¼€å·²çŸ¥, åªæœ‰ $d$ çš„å€¼æ˜¯ç§˜å¯†ä¿ç•™çš„, å½“ $p$ è¶³å¤Ÿå¤§æ—¶, æ±‚è§£ $d$ æ˜¯å›°éš¾çš„.</p>
<h3 id="ä¸€ä¸ªç®€å•çš„åŠ è§£å¯†æ–¹æ¡ˆ"><a href="#ä¸€ä¸ªç®€å•çš„åŠ è§£å¯†æ–¹æ¡ˆ" class="headerlink" title="ä¸€ä¸ªç®€å•çš„åŠ è§£å¯†æ–¹æ¡ˆ"></a>ä¸€ä¸ªç®€å•çš„åŠ è§£å¯†æ–¹æ¡ˆ</h3><p>è®¾ $d$ ä¸ºç”¨æˆ·ç§é’¥, $Q$ ä¸ºç”¨æˆ·å…¬é’¥, æ˜æ–‡æ•°æ®ä¸º $M$, ä¸” $0 \leq M \leq n-1$.</p>
<p>åŠ å¯†:</p>
<ol>
<li>é€‰æ‹©ä¸€ä¸ªéšæœºæ•° $k$, ä¸” $k \in \{1, 2, ..., n-1\}$.</li>
<li>è®¡ç®—ç‚¹ $X_1(x_1, y_1) = kQ$, å¦‚æœ $x_1 = 0$, åˆ™è½¬æ­¥éª¤ 1.</li>
<li>è®¡ç®—ç‚¹ $X_2(x_2, y_2) = kG$.</li>
<li>è®¡ç®—å¯†æ–‡ $C \equiv Mx_1 \bmod n$.</li>
<li>ä»¥ $(X_2, C)$ ä½œä¸º $M$ çš„æœ€ç»ˆå¯†æ–‡.</li>
</ol>
<p>è§£å¯†:</p>
<ol>
<li>è®¡ç®— $X_1(x_1, y_1) = dX_2 = d(kG) = k(dG) = kQ$.</li>
<li>è®¡ç®—æ˜æ–‡ $M \equiv Cx_1^{-1} \bmod n$.</li>
</ol>
<h2 id="åŠ è§£å¯†ç®—æ³•çš„å®ç°"><a href="#åŠ è§£å¯†ç®—æ³•çš„å®ç°" class="headerlink" title="åŠ è§£å¯†ç®—æ³•çš„å®ç°"></a>åŠ è§£å¯†ç®—æ³•çš„å®ç°</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    EC ec;</span><br><span class="line">    GenPoint genpt;</span><br><span class="line">&#125; ECDLP;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">encrypt_blk</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">const</span> ECDLP* ecdlp,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> EccPoint* pubkey,</span></span><br><span class="line"><span class="params">    <span class="type">int64_t</span> plain,</span></span><br><span class="line"><span class="params">    EccPoint* cipher_pt, <span class="type">int64_t</span>* cipher</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int64_t</span> rndk = <span class="number">0</span>;</span><br><span class="line">    EccPoint x1 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        rndk = rand() % (ecdlp-&gt;genpt.n - <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        mulpt(&amp;ecdlp-&gt;ec, rndk, pubkey, &amp;x1);</span><br><span class="line">    &#125; <span class="keyword">while</span> (x1.x == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    mulpt(&amp;ecdlp-&gt;ec, rndk, &amp;ecdlp-&gt;genpt.pt, cipher_pt);</span><br><span class="line">    *cipher = (plain * x1.x) % ecdlp-&gt;genpt.n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt_blk</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">const</span> ECDLP* ecdlp,</span></span><br><span class="line"><span class="params">    <span class="type">int64_t</span> prikey,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> EccPoint* cipher_pt, <span class="type">int64_t</span> cipher,</span></span><br><span class="line"><span class="params">    <span class="type">int64_t</span>* plain</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    EccPoint x1 = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    mulpt(&amp;ecdlp-&gt;ec, prikey, cipher_pt, &amp;x1);</span><br><span class="line">    *plain = (cipher * inverse(x1.x, ecdlp-&gt;genpt.n)) % ecdlp-&gt;genpt.n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åŒ…å«æ–‡ä»¶ä¸ä¸»ç¨‹åº"><a href="#åŒ…å«æ–‡ä»¶ä¸ä¸»ç¨‹åº" class="headerlink" title="åŒ…å«æ–‡ä»¶ä¸ä¸»ç¨‹åº"></a>åŒ…å«æ–‡ä»¶ä¸ä¸»ç¨‹åº</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    srand((<span class="type">uint32_t</span>)time(<span class="literal">NULL</span>));</span><br><span class="line">    ECDLP ecdlp = &#123; &#123; <span class="number">2</span>, <span class="number">11</span>, <span class="number">49177</span> &#125;, &#123;&#123;<span class="number">1</span>, <span class="number">14445</span>&#125;, <span class="number">49031</span>&#125; &#125;;</span><br><span class="line">    <span class="comment">// print_points(&amp;ecdlp.ec);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Curve Params: &#123; a = %lld, b = %lld, p = %lld &#125;\n&quot;</span>, ecdlp.ec.a, ecdlp.ec.b, ecdlp.ec.p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;GenPoint: &#123; pt: (%lld, %lld), n: %lld &#125;\n&quot;</span>, ecdlp.genpt.pt.x, ecdlp.genpt.pt.y, ecdlp.genpt.n);</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> prikey = <span class="number">149</span>;</span><br><span class="line">    EccPoint pubkey = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    mulpt(&amp;ecdlp.ec, prikey, &amp;ecdlp.genpt.pt, &amp;pubkey);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Prikey: %lld Pubkey: (%lld, %lld)\n&quot;</span>, prikey, pubkey.x, pubkey.y);</span><br><span class="line"></span><br><span class="line">    <span class="type">int64_t</span> plain = <span class="number">23456</span>;</span><br><span class="line">    <span class="type">int64_t</span> cipher = <span class="number">-1</span>;</span><br><span class="line">    EccPoint cipher_pt = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Plain: %lld\n&quot;</span>, plain);</span><br><span class="line"></span><br><span class="line">    encrypt_blk(&amp;ecdlp, &amp;pubkey, plain, &amp;cipher_pt, &amp;cipher);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Cipher: (%lld, %lld), %lld\n&quot;</span>, cipher_pt.x, cipher_pt.y, cipher);</span><br><span class="line"></span><br><span class="line">    decrypt_blk(&amp;ecdlp, prikey, &amp;cipher_pt, cipher, &amp;plain);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Plain: %lld\n&quot;</span>, plain);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>å…¬é’¥ç®—æ³•</tag>
        <tag>æ¤­åœ†æ›²çº¿å¯†ç </tag>
      </tags>
  </entry>
  <entry>
    <title>SM9 ç®—æ³•ä¸­ $g_{U, V}(Q)$ çš„å±•å¼€ä¼˜åŒ–</title>
    <url>//posts/2024/06/16/sm9gfn/</url>
    <content><![CDATA[<p>æœ¬ç¯‡è®°å½•ä¸€ä¸‹åœ¨å®ç° SM9 ç®—æ³•æ—¶å¯¹å‡½æ•° $g_{U, V}(Q)$ ç¨€ç–ä¹˜æ³•çš„å…¬å¼æ¨å¯¼ä¸ä¼˜åŒ–å®ç°.</p>
<span id="more"></span>

<h2 id="åäºŒæ¬¡æ‰©åŸŸä¸Šçš„ç¨€ç–ä¹˜æ³•"><a href="#åäºŒæ¬¡æ‰©åŸŸä¸Šçš„ç¨€ç–ä¹˜æ³•" class="headerlink" title="åäºŒæ¬¡æ‰©åŸŸä¸Šçš„ç¨€ç–ä¹˜æ³•"></a>åäºŒæ¬¡æ‰©åŸŸä¸Šçš„ç¨€ç–ä¹˜æ³•</h2><p>$$<br>\begin{align*}<br>     U &amp;= (x_U, y_U, z_U) \rightarrow (x_1, y_1) \\<br>     V &amp;= (x_V, y_V, z_V) \rightarrow (x_2, y_2) \\<br>     Q &amp;= (x_Q, y_Q, z_Q) \rightarrow (x_3, y_3) \\<br>     U&#39; &amp;= (x&#39;_U, y&#39;_U, z&#39;_U) \rightarrow (x&#39;_1, y&#39;_1) \\<br>     V&#39; &amp;= (x&#39;_V, y&#39;_V, z&#39;_V) \rightarrow (x&#39;_2, y&#39;_2)<br>\end{align*}<br>$$</p>
<p>$U, V, Q$ æ˜¯ $E(F_{q^{12}})$ ä¸Šçš„ç‚¹, $U&#39;, V&#39;$ æ˜¯æ‰­æ›²çº¿ä¸Šçš„ç‚¹, ä¹Ÿæ˜¯å‡½æ•°çš„ç›´æ¥è¾“å…¥å€¼.</p>
<p>$Q$ è¾“å…¥æ—¶åœ¨ $E(F_{q})$ ä¸Š, ä½†æ˜¯å¯ä»¥ç›´æ¥é€šè¿‡å¡”å¼æ‰©å¼ è½¬æ¢åˆ° $E(F_{q^{12}})$ ä¸Š.</p>
<p>æ ¹æ®é›…å„æ¯”åŠ é‡åæ ‡ç³»è½¬æ¢å…¬å¼å’Œæ‰­æ›²çº¿è½¬æ¢å…¬å¼å¯å¾—:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>    x_1 &amp;= \frac{x_U}{z_U^2} = \frac{x_U&#39;}{\omega^2} = \frac{x_U&#39;}{\omega^2 z_U&#39;^2} \\<br>    y_1 &amp;= \frac{y_U}{z_U^3} = \frac{y_U&#39;}{\omega^3} = \frac{y_U&#39;}{\omega^3 z_U&#39;^3}<br>\end{align*}<br>\right.<br>$$</p>
<p>å¯ä»¥çœ‹åˆ°æ ¹æ® $z$ çš„æ¬¡æ•°, åˆ†æ¯ä¼šä¹˜ä¸ŠåŒæ¬¡æ•°çš„ $\omega$, è¿™åœ¨ $F_{q^{12}}$ ä¸Šç›¸å½“äºæ˜¯æŠŠè¿™ä¸ª $F_{q^{2}}$ å…ƒç´ æ¬¡æ•°åŠ ä¸€, ä¹Ÿå°±æ˜¯æ”¹å˜è¿™ä¸ªå…ƒç´ çš„ä½ç½®.</p>
<p>åŒç†æœ‰:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>    x_2 &amp;= \frac{x_V}{z_V^2} \\<br>    y_2 &amp;= \frac{y_V}{z_V^3}<br>\end{align*}<br>\right.<br>$$</p>
<p>$$<br>\left\{<br>\begin{align*}<br>    x_3 &amp;= \frac{x_Q}{z_Q^2} \\<br>    y_3 &amp;= \frac{y_Q}{z_Q^3}<br>\end{align*}<br>\right.<br>$$</p>
<p>æ ¹æ®å…¬å¼æœ‰:</p>
<p>$$<br>\begin{align*}<br>     \lambda_1 &amp;= \frac{3x_2^2}{2y_2} \\<br>     \lambda_2 &amp;= \frac{y_1 - y_2}{x_1 - x_2}<br>\end{align*}<br>$$</p>
<p>åˆ™:</p>
<p>$$<br>\begin{align*}<br>g_{V, V}(Q) &amp;= \lambda_1(x_3 - x_2) + y_2 - y_3 \\<br>~ &amp;= \frac{3x_2^2(x_3-x_2)}{2y_2} + y_2 - y_3 \\<br>~ &amp;= \frac{3x_3}{2}\frac{x_2^2}{y_2} - \frac{3}{2}\frac{x_2^3}{y_2} + y_2 - y_3 \\<br>~ &amp;= \frac{\frac{3}{2} x_3 x_V^2}{y_V z_V} - \frac{\frac{3}{2}x_V^3}{y_V z_V^3} + \frac{y_V}{z_V^3} - y_3 \\<br>~ &amp;= \frac{\frac{3}{2} x_Q x_V^2}{z_Q^2 y_V z_V} - \frac{\frac{3}{2}x_V^3}{y_V z_V^3} + \frac{y_V} {z_V^3} - \frac{y_Q} {z_Q^3} \\<br>~ &amp;= \frac{\frac{3}{2} x_Q z_Q x_V^2 z_V^2 + z_Q^3(y_V^2 - \frac{3}{2}x_V^3) - y_Q y_V z_V^3}{z_Q^3 y_V z_V^3}<br>\end{align*}<br>$$</p>
<p>$$<br>\begin{align*}<br>g_{U, V}(Q) &amp;= \lambda_2(x_3 - x_2) + y_2 - y_3 \\<br>~ &amp;= \frac{y_1 - y_2}{x_1 - x_2}(x_3 - x_2) + y_2 - y_3 \\<br>~ &amp;= \frac{\frac{y_U}{z_U^3} - \frac{y_V}{z_V^3}}{\frac{x_U}{z_U^2} - \frac{x_V}{z_V^2}}(x_3 - \frac{x_V}{z_V^2}) + \frac{y_V}{z_V^3} - y_3 \\<br>~ &amp;= \frac{y_U z_V^3 - y_V z_U^3}{z_Uz_V(x_U z_V^2 - x_V z_U^2)}(x_3 - \frac{x_V}{z_V^2}) + \frac{y_V}{z_V^3} - y_3 \\<br>~ &amp;= \frac{y_U z_V^3 - y_V z_U^3} {z_Uz_V(x_U z_V^2 - x_V z_U^2)}\frac{x_3 z_V^2 - x_V}{z_V^2} + \frac{y_V - y_3 z_V^3}{z_V^3} \\<br>~ &amp;= \frac{z_V(y_U z_V^3 - y_V z_U^3)(x_3 z_V^2 - x_V) + z_Uz_V(x_U z_V^2 - x_V z_U^2)(y_V - y_3 z_V^3)}{z_Uz_V(x_U z_V^2 - x_V z_U^2)z_V^3} \\<br>~ &amp;= \frac{t_2 x_3 z_V^2 + t_1 y_V - t_2 x_V - t_1 y_3 z_V^3}{t_1 z_V^3} \\<br>~ &amp;= \frac{t_2 \frac{x_Q}{z_Q^2} z_V^2 + t_1 y_V - t_2 x_V - t_1 \frac{y_Q}{z_Q^3} z_V^3} {t_1 z_V^3} \\<br>~ &amp;= \frac{x_Q z_Q t_2 z_V^2 + z_Q^3(t_1 y_V - t_2 x_V) - y_Q t_1 z_V^3} {z_Q^3 t_1 z_V^3}<br>\end{align*}<br>$$</p>
<p>å…¶ä¸­:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>    t_1 &amp;= z_Uz_V(x_U z_V^2 - x_V z_U^2) \\<br>    t_2 &amp;= z_V(y_U z_V^3 - y_V z_U^3)<br>\end{align*}<br>\right.<br>$$</p>
<p>å½“ $U, V$ ä¸ºç›¸åç‚¹, å³ $x_1 = x_2, y_1 + y_2 = 0$ æ—¶:</p>
<p>$$<br>\begin{align*}<br>g_{V, -V}(Q) &amp;= x_3 - x_2 \\<br>~ &amp;= \frac{x_Q}{z_Q^2} - \frac{x_V}{z_V^2} \\<br>~ &amp;= \frac{x_Q z_V^2 - z_Q^2 x_V}{z_Q^2 z_V^2}<br>\end{align*}<br>$$</p>
<p>åœ¨ä»£ç å®ç°æ—¶, é€šè¿‡å±•å¼€, å¯ä»¥å°†è®¡ç®—æ§åˆ¶åœ¨ $F_{q^{2}}$ ä¸Š, ä¸”åˆ†å¼€ç®—åˆ†å­åˆ†æ¯, å¯ä»¥æœ‰æ•ˆé¿å…æ±‚é€†, å»¶è¿Ÿåˆ°åœ¨æœ€åè®¡ç®— $FinalExp$ æ—¶å¯¹æ€»çš„åˆ†æ¯è®¡ç®—ä¸€æ¬¡é€†.</p>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>SM9</tag>
        <tag>SM9ä¼˜åŒ–</tag>
        <tag>ç¨€ç–ä¹˜æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>SM9 ç®—æ³•ä¸­çš„å¡”å¼æ‰©å¼ å…¬å¼æ¨å¯¼</title>
    <url>//posts/2023/12/04/sm9fpex/</url>
    <content><![CDATA[<p>æœ¬ç¯‡è®°å½•ä¸€ä¸‹åœ¨å®ç° SM9 ç®—æ³•æ—¶å¡”å¼æ‰©å¼ éƒ¨åˆ†çš„å…¬å¼æ¨å¯¼ä¸ä»£ç å®ç°. ç”±äºæ²¡æœ‰ç³»ç»Ÿå­¦ä¹ è¿‡ç›¸å…³æ•°å­¦ç†è®º, å› æ­¤åªæ˜¯æ ¹æ®æœ‰é™çš„è®¤è¯†å®Œæˆäº†æ¨å¯¼, å¯èƒ½å­˜åœ¨ä¸ä¸¥è°¨ä¹‹å¤„.</p>
<span id="more"></span>

<h2 id="SM9-æ‰©åŸŸå…ƒç´ çš„è¡¨ç¤º"><a href="#SM9-æ‰©åŸŸå…ƒç´ çš„è¡¨ç¤º" class="headerlink" title="SM9 æ‰©åŸŸå…ƒç´ çš„è¡¨ç¤º"></a>SM9 æ‰©åŸŸå…ƒç´ çš„è¡¨ç¤º</h2><p>ä»¥ä¸‹æ¥è‡ª GB/T 38635.1-2020 A.2 éƒ¨åˆ† &quot;æ‰©åŸŸå…ƒç´ çš„è¡¨ç¤º&quot; å°èŠ‚åŸæ–‡å†…å®¹.</p>
<p>$F_{q^{12}}$ çš„ $1\text{-}2\text{-}4\text{-}12$ å¡”å¼æ‰©å¼ :</p>
<p>$$<br>\begin{align*}<br>  &amp; F_{q^{2}}[u] = F_{q}[u]/(u^2 - \alpha), &amp;&amp; \alpha = -2 \\<br>  &amp; F_{q^{4}}[v] = F_{q^{2}}[v]/(v^2 - \xi), &amp;&amp; \xi = u \\<br>  &amp; F_{q^{12}}[w] = F_{q^{4}}[w]/(w^3 - v), &amp;&amp; v^2 = \xi<br>\end{align*}<br>$$</p>
<p>å…¶ä¸­, ç¬¬ä¸€æ¬¡çš„ 2 æ¬¡æ‰©å¼ çº¦åŒ–å¤šé¡¹å¼ä¸º: $x^2 - \alpha, \alpha=-2$;</p>
<p>ç¬¬äºŒæ¬¡è¿›è¡Œ 2 æ¬¡æ‰©å¼ çš„çº¦åŒ–å¤šé¡¹å¼ä¸º: $x^2 - u, u^2 = \alpha, u = \sqrt{-2}$;</p>
<p>ç¬¬ä¸‰æ¬¡è¿›è¡Œ 3 æ¬¡æ‰©å¼ çš„çº¦åŒ–å¤šé¡¹å¼ä¸º: $x^3-v, v^2=u, v = \sqrt{\sqrt{-2}}$.</p>
<p>$u$ å±äº $F_{q^{2}}$, è¡¨ç¤ºä¸º $(1, 0)$.</p>
<p>$v$ å±äº $F_{q^{4}}$, è¡¨ç¤ºä¸º $(0, 1, 0, 0)$, ä¹Ÿå¯ä»¥ç”¨ $F_{q^{2}}$ å…ƒç´ è¡¨ç¤ºä¸º $((0, 1), (0, 0))$.</p>
<h2 id="å…¬å¼æ¨å¯¼"><a href="#å…¬å¼æ¨å¯¼" class="headerlink" title="å…¬å¼æ¨å¯¼"></a>å…¬å¼æ¨å¯¼</h2><p>åŠ æ³•å’Œå‡æ³•å°±æ˜¯ç±»ä¼¼äºå‘é‡è¿ç®—, æ¯ä¸ªä½ç½®è¿›è¡ŒåŠ å‡å¹¶æ¨¡ $p$ å³å¯, å› æ­¤åªéœ€è¦æ¨å¯¼ä¹˜æ³•å’Œæ¨¡é€†è¿ç®—.</p>
<h3 id="2-æ¬¡æ‰©åŸŸ"><a href="#2-æ¬¡æ‰©åŸŸ" class="headerlink" title="2 æ¬¡æ‰©åŸŸ"></a>2 æ¬¡æ‰©åŸŸ</h3><p>è®¾ $X = (x_1, x_0), Y = (y_1, y_0), Z = (z_1, z_0)$, ä¸” $Z = X \cdot Y$, çº¦åŒ–å¤šé¡¹å¼ä¸º: $u^2 - \alpha, \alpha=-2$.</p>
<p>åˆ™ $Z$ å¯ä»¥è¡¨ç¤ºä¸º:</p>
<p>$$<br>\begin{align*}<br>  (z_1, z_0) &amp;= (x_1, x_0) \cdot (y_1, y_0) \\<br>  ~ &amp;= (x_1u + x_0)(y_1u + y_0) \\<br>  ~ &amp;= x_1y_1u^2 + (x_1y_0 + x_0y_1)u + x_0y_0 \\<br>  ~ &amp;= (x_1y_0 + x_0y_1)u + (\alpha x_1y_1 + x_0y_0) \\<br>  ~ &amp;= (x_1y_0 + x_0y_1, \alpha x_1y_1 + x_0y_0)<br>\end{align*}<br>$$</p>
<p>æ‰€ä»¥:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  z_1 &amp;= x_1y_0 + x_0y_1 \\<br>  z_0 &amp;= \alpha x_1y_1 + x_0y_0<br>\end{align*}<br>\right.<br>$$</p>
<p>ç„¶åè®¾ $Y = X^{-1}$, ä¹Ÿå°±æ˜¯æ±‚ $X$ çš„æ¨¡é€†:</p>
<p>$$<br>(0, 1) = (x_1, x_0) \cdot (y_1, y_0)<br>$$</p>
<p>å³è§£äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹ç»„:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  0 &amp;= x_1y_0 + x_0y_1 \\<br>  1 &amp;= \alpha x_1y_1 + x_0y_0<br>\end{align*}<br>\right.<br>$$</p>
<p>è§£å¾—:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  y_1 &amp;= \frac{x_1}{\alpha x_1^2 - x_0^2} \\<br>  y_0 &amp;= \frac{-x_0}{\alpha x_1^2 - x_0^2}<br>\end{align*}<br>\right.<br>$$</p>
<p>ä¸Šè¿°å…¬å¼å°† $F_{q^{2}}$ ä¸­çš„è¿ç®—å…¨éƒ¨å˜æˆ $F_{q}$ ä¸­çš„è¿ç®—, æ‰€æœ‰å…ƒç´ è®¡ç®—åå‡éœ€è¦æ¨¡ $p$.</p>
<h3 id="4-æ¬¡æ‰©åŸŸ"><a href="#4-æ¬¡æ‰©åŸŸ" class="headerlink" title="4 æ¬¡æ‰©åŸŸ"></a>4 æ¬¡æ‰©åŸŸ</h3><p>è®¾ $X = (X_1, X_0), Y = (Y_1, Y_0), Z = (Z_1, Z_0)$, ä¸” $Z = X \cdot Y$, çº¦åŒ–å¤šé¡¹å¼ä¸º: $v^2 - u, u^2 = \alpha, u = \sqrt{-2}$.</p>
<p>å…¶ä¸­ $X = (X_1, X_0) = (x_3, x_2, x_1, x_0)$ æ˜¯ $F_{q^{4}}$ ä¸Šçš„å…ƒç´ , $X_1, X_0$ éƒ½æ˜¯ $F_{q^{2}}$ ä¸Šçš„å…ƒç´ , $Y$ å’Œ $Z$ åŒç†.</p>
<p>ä»¿ç…§ç¬¬ä¸€æ¬¡ 2 æ¬¡æ‰©å¼ çš„è¿‡ç¨‹, åˆ™ $Z$ å¯ä»¥è¡¨ç¤ºä¸º:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  Z_1 &amp;= X_1Y_0 + X_0Y_1 \\<br>  Z_0 &amp;= u X_1Y_1 + X_0Y_0<br>\end{align*}<br>\right.<br>$$</p>
<p>å…¶ä¸­ $u X_1Y_1 = (1, 0) \cdot X_1 \cdot Y_1$, å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸Šä¸€èŠ‚ä¸­ $F_{q^{2}}$ ä¸Šçš„è¿ç®—å®Œæˆ.</p>
<p>åŒç†å¯å¾—æ¨¡é€†è¿ç®—ä¸º:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  Y_1 &amp;= \frac{X_1}{u X_1^2 - X_0^2} \\<br>  Y_0 &amp;= \frac{-X_0}{u X_1^2 - X_0^2}<br>\end{align*}<br>\right.<br>$$</p>
<p>å…¶ä¸­ $u X_1^2 = (1, 0) \cdot X_1 \cdot X_1$.</p>
<h3 id="12-æ¬¡æ‰©åŸŸ"><a href="#12-æ¬¡æ‰©åŸŸ" class="headerlink" title="12 æ¬¡æ‰©åŸŸ"></a>12 æ¬¡æ‰©åŸŸ</h3><p>è®¾ $X = (X_2, X_1, X_0), Y = (Y_2, Y_1, Y_0), Z = (Z_2, Z_1, Z_0)$, ä¸” $Z = X \cdot Y$, çº¦åŒ–å¤šé¡¹å¼ä¸º: $w^3-v, v^2=u, v = \sqrt{\sqrt{-2}}$.</p>
<p>å…¶ä¸­ $X = (X_2, X_1, X_0) = (x_{11}, x_{10}, \ldots, x_0)$ æ˜¯ $F_{q^{12}}$ ä¸Šçš„å…ƒç´ , $X_2, X_1, X_0$ éƒ½æ˜¯ $F_{q^{4}}$ ä¸Šçš„å…ƒç´ , $Y$ å’Œ $Z$ åŒç†.</p>
<p>åˆ™ $Z$ å¯ä»¥è¡¨ç¤ºä¸º:</p>
<p>$$<br>\begin{align*}<br>  (Z_2, Z_1, Z_0) &amp;= (X_2, X_1, X_0) \cdot (Y_2, Y_1, Y_0) \\<br>  ~ &amp;= (X_2 w^2 + X_1w + X_0)(Y_2 w^2 + Y_1w + Y_0) \\<br>  ~ &amp;= X_2Y_2w^4 + (X_2Y_1 + X_1Y_2)w^3 + (X_2Y_0 + X_1Y_1 + X_0Y_2)w^2 + (X_1Y_0 + X_0Y_1)w + X_0Y_0 \\<br>  ~ &amp;= (X_2Y_0 + X_1Y_1 + X_0Y_2)w^2 + (vX_2Y_2 + X_1Y_0 + X_0Y_1)w + (vX_2Y_1 + vX_1Y_2 + X_0Y_0) \\<br>  ~ &amp;= (X_2Y_0 + X_1Y_1 + X_0Y_2, vX_2Y_2 + X_1Y_0 + X_0Y_1, v(X_2Y_1 + X_1Y_2) + X_0Y_0)<br>\end{align*}<br>$$</p>
<p>æ‰€ä»¥:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  Z_2 &amp;= X_2Y_0 + X_1Y_1 + X_0Y_2 \\<br>  Z_1 &amp;= vX_2Y_2 + X_1Y_0 + X_0Y_1 \\<br>  Z_0 &amp;= v(X_2Y_1 + X_1Y_2) + X_0Y_0<br>\end{align*}<br>\right.<br>$$</p>
<p>å…¶ä¸­ $v = ((0, 1), (0, 0)) = (0, 1, 0, 0)$, å¯ä»¥ç”¨ $F_{q^{4}}$ å®Œæˆè®¡ç®—.</p>
<p>è®¾ $Y = X^{-1}$, æ±‚ $X$ çš„æ¨¡é€†:</p>
<p>$$<br>(\mathbf{0}_{F_{q^4}}, \mathbf{0}_{F_{q^4}}, \mathbf{1}_{F_{q^4}}) = (X_2, X_1, X_0) \cdot (Y_2, Y_1, Y_0)<br>$$</p>
<p>å³è§£ä¸‰å…ƒä¸€æ¬¡æ–¹ç¨‹ç»„:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  \mathbf{0}_{F_{q^4}} &amp;= X_2Y_0 + X_1Y_1 + X_0Y_2 \\<br>  \mathbf{0}_{F_{q^4}} &amp;= vX_2Y_2 + X_1Y_0 + X_0Y_1 \\<br>  \mathbf{1}_{F_{q^4}} &amp;= v(X_2Y_1 + X_1Y_2) + X_0Y_0<br>\end{align*}<br>\right.<br>$$</p>
<p>è§£å¾—:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  Y_2 &amp;= \frac{X_1^2 - X_2X_0}{\mathbf{det}_{F_{q^4}}} \\<br>  Y_1 &amp;= \frac{vX_2^2 - X_1X_0}{\mathbf{det}_{F_{q^4}}} \\<br>  Y_0 &amp;= \frac{X_0^2 - vX_2X_1}{\mathbf{det}_{F_{q^4}}}<br>\end{align*}<br>\right.<br>$$</p>
<p>å…¶ä¸­ $\mathbf{det}_{F_{q^4}} = v^2X_2^3 + vX_1^3 + X_0^3 - 3 \cdot (vX_2X_1X_0)$, ç¬¦å· $\cdot$ è¡¨ç¤º $F_{q^4}$ ä¸Šçš„æ ‡é‡ä¹˜æ³•è¿ç®—.</p>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>ç”¨ python ç®€å•å®ç°ä¸€ä¸‹ä¸Šè¿°æ¶‰åŠçš„æ‰€æœ‰è¿ç®—.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line">Fp2Ele = <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]</span><br><span class="line">Fp4Ele = <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>]</span><br><span class="line">Fp12Ele = <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>]</span><br><span class="line">FpExEle = <span class="type">Tuple</span>[<span class="built_in">int</span>, ...]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PrimeFiledEx</span>(<span class="title class_ inherited__">PrimeField</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Fp2, Fp4, Fp12 operations.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, p: <span class="built_in">int</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.p = p</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv</span>(<span class="params">self, x: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">return</span> inverse(x, self.p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addex</span>(<span class="params">self, X: FpExEle, Y: FpExEle</span>) -&gt; FpExEle:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>((i1 + i2) % self.p <span class="keyword">for</span> i1, i2 <span class="keyword">in</span> <span class="built_in">zip</span>(X, Y))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subex</span>(<span class="params">self, X: FpExEle, Y: FpExEle</span>) -&gt; FpExEle:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>((i1 - i2) % self.p <span class="keyword">for</span> i1, i2 <span class="keyword">in</span> <span class="built_in">zip</span>(X, Y))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">negex</span>(<span class="params">self, X: FpExEle</span>) -&gt; FpExEle:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>(self.p - i <span class="keyword">for</span> i <span class="keyword">in</span> X)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">smulex</span>(<span class="params">self, k: <span class="built_in">int</span>, X: FpExEle</span>) -&gt; FpExEle:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">tuple</span>((k * i) % self.p <span class="keyword">for</span> i <span class="keyword">in</span> X)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mul2</span>(<span class="params">self, X: Fp2Ele, Y: Fp2Ele</span>) -&gt; Fp2Ele:</span><br><span class="line">        x1, x0 = X</span><br><span class="line">        y1, y0 = Y</span><br><span class="line">        x1y1 = x1 * y1</span><br><span class="line">        x0y0 = x0 * y0</span><br><span class="line">        z1 = ((x1 + x0) * (y1 + y0) - x1y1 - x0y0) % self.p</span><br><span class="line">        z0 = (x0y0 - <span class="number">2</span> * x1y1) % self.p</span><br><span class="line">        <span class="keyword">return</span> z1, z0</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv2</span>(<span class="params">self, X: Fp2Ele</span>) -&gt; Fp2Ele:</span><br><span class="line">        x1, x0 = X</span><br><span class="line">        invdet = self.inv(<span class="number">2</span> * x1 * x1 + x0 * x0)</span><br><span class="line">        y1 = (-x1 * invdet) % self.p</span><br><span class="line">        y0 = (x0 * invdet) % self.p</span><br><span class="line">        <span class="keyword">return</span> y1, y0</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mul4</span>(<span class="params">self, X: Fp4Ele, Y: Fp4Ele</span>) -&gt; Fp4Ele:</span><br><span class="line">        a, m = self.addex, self.mul2</span><br><span class="line">        X1, X0 = X[:<span class="number">2</span>], X[<span class="number">2</span>:]</span><br><span class="line">        Y1, Y0 = Y[:<span class="number">2</span>], Y[<span class="number">2</span>:]</span><br><span class="line">        U = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        X1mY1 = m(X1, Y1)</span><br><span class="line">        X0mY0 = m(X0, Y0)</span><br><span class="line"></span><br><span class="line">        X1aX0_m_Y1aY0 = m(a(X1, X0), a(Y1, Y0))</span><br><span class="line">        Z1 = <span class="built_in">tuple</span>((i1 - i2 - i3) % self.p <span class="keyword">for</span> i1, i2, i3 <span class="keyword">in</span> <span class="built_in">zip</span>(X1aX0_m_Y1aY0, X1mY1, X0mY0))</span><br><span class="line">        Z0 = a(m(U, X1mY1), X0mY0)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Z1 + Z0</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv4</span>(<span class="params">self, X: Fp4Ele</span>) -&gt; Fp4Ele:</span><br><span class="line">        m, n, s = self.mul2, self.negex, self.subex</span><br><span class="line">        X1, X0 = X[:<span class="number">2</span>], X[<span class="number">2</span>:]</span><br><span class="line">        U = (<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        UmX1mX1_s_X0mX0 = s(m(U, m(X1, X1)), m(X0, X0))</span><br><span class="line">        invdet = self.inv2(UmX1mX1_s_X0mX0)</span><br><span class="line"></span><br><span class="line">        Y1 = m(X1, invdet)</span><br><span class="line">        Y0 = m(n(X0), invdet)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Y1 + Y0</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mul12</span>(<span class="params">self, X: Fp12Ele, Y: Fp12Ele</span>) -&gt; Fp12Ele:</span><br><span class="line">        a, m = self.addex, self.mul4</span><br><span class="line">        X2, X1, X0 = X[:<span class="number">4</span>], X[<span class="number">4</span>:<span class="number">8</span>], X[<span class="number">8</span>:]</span><br><span class="line">        Y2, Y1, Y0 = Y[:<span class="number">4</span>], Y[<span class="number">4</span>:<span class="number">8</span>], Y[<span class="number">8</span>:]</span><br><span class="line">        V = (<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        X2mY2, X1mY1, X0mY0 = m(X2, Y2), m(X1, Y1), m(X0, Y0)</span><br><span class="line">        X2aX1, X2aX0, X1aX0 = a(X2, X1), a(X2, X0), a(X1, X0)</span><br><span class="line">        Y2aY1, Y2aY0, Y1aY0 = a(Y2, Y1), a(Y2, Y0), a(Y1, Y0)</span><br><span class="line"></span><br><span class="line">        X2aX1_m_Y2aY1 = m(X2aX1, Y2aY1)</span><br><span class="line">        X2aX0_m_Y2aY0 = m(X2aX0, Y2aY0)</span><br><span class="line">        X1aX0_m_Y1aY0 = m(X1aX0, Y1aY0)</span><br><span class="line"></span><br><span class="line">        VmX2mY2 = m(V, X2mY2)</span><br><span class="line">        X2mY1_a_X1Y2 = <span class="built_in">tuple</span>((i1 - i2 - i3) % self.p <span class="keyword">for</span> i1, i2, i3 <span class="keyword">in</span> <span class="built_in">zip</span>(X2aX1_m_Y2aY1, X2mY2, X1mY1))</span><br><span class="line"></span><br><span class="line">        Z2 = <span class="built_in">tuple</span>((i1 - i2 - i3 + i4) % self.p <span class="keyword">for</span> i1, i2, i3, i4 <span class="keyword">in</span> <span class="built_in">zip</span>(X2aX0_m_Y2aY0, X2mY2, X0mY0, X1mY1))</span><br><span class="line">        Z1 = <span class="built_in">tuple</span>((i1 + i2 - i3 - i4) % self.p <span class="keyword">for</span> i1, i2, i3, i4 <span class="keyword">in</span> <span class="built_in">zip</span>(VmX2mY2, X1aX0_m_Y1aY0, X1mY1, X0mY0))</span><br><span class="line">        Z0 = a(m(V, X2mY1_a_X1Y2), X0mY0)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Z2 + Z1 + Z0</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">inv12</span>(<span class="params">self, X: Fp12Ele</span>) -&gt; Fp12Ele:</span><br><span class="line">        m, s = self.mul4, self.subex</span><br><span class="line">        X2, X1, X0 = X[:<span class="number">4</span>], X[<span class="number">4</span>:<span class="number">8</span>], X[<span class="number">8</span>:]</span><br><span class="line">        V = (<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        VmX2 = m(V, X2)</span><br><span class="line">        VmX1 = m(V, X1)</span><br><span class="line"></span><br><span class="line">        X1mX1_s_X2mX0 = s(m(X1, X1), m(X2, X0))</span><br><span class="line">        VmX2mX2_s_X1X0 = s(m(VmX2, X2), m(X1, X0))</span><br><span class="line">        X0mX0_s_VmX2mX1 = s(m(X0, X0), m(VmX2, X1))</span><br><span class="line"></span><br><span class="line">        det = <span class="built_in">tuple</span>((i1 + i2 + i3) % self.p <span class="keyword">for</span> i1, i2, i3 <span class="keyword">in</span> <span class="built_in">zip</span>(m(VmX2, VmX2mX2_s_X1X0), m(VmX1, X1mX1_s_X2mX0), m(X0, X0mX0_s_VmX2mX1)))</span><br><span class="line">        invdet = self.inv4(det)</span><br><span class="line"></span><br><span class="line">        Y2 = m(X1mX1_s_X2mX0, invdet)</span><br><span class="line">        Y1 = m(VmX2mX2_s_X1X0, invdet)</span><br><span class="line">        Y0 = m(X0mX0_s_VmX2mX1, invdet)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Y2 + Y1 + Y0</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc3RkLnNhbXIuZ292LmNuL2J6Z2svZ2IvbmV3R2JJbmZvP2hjbm89QjdBMEQ3REZGNDExQ0QwQUFFNzYxMzVBREU5MTg4NkE=">ä¿¡æ¯å®‰å…¨æŠ€æœ¯ SM9æ ‡è¯†å¯†ç ç®—æ³• ç¬¬1éƒ¨åˆ†ï¼šæ€»åˆ™<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaGVzaHVjaGFvL3AvODE5NjMwNy5odG1s">ä¼½ç½—ç“¦åŸŸ(æœ‰é™åŸŸ)GFq^12ä¸Šå…ƒç´ çš„1â†’2â†’4â†’12å¡”å¼æ‰©å¼ (1)------ç¬¬ä¸€æ¬¡æ‰©å¼ <i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaGVzaHVjaGFvL3AvODE5ODQ5NC5odG1s">ä¼½ç½—ç“¦åŸŸ(æœ‰é™åŸŸ)GFq^12ä¸Šå…ƒç´ çš„1â†’2â†’4â†’12å¡”å¼æ‰©å¼ (2)------ç¬¬äºŒæ¬¡æ‰©å¼ <i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>SM9</tag>
        <tag>å¡”å¼æ‰©å¼ </tag>
        <tag>æ‰©åŸŸè¿ç®—</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€æ¬¡æ„å¤–çš„ Github SSH è¿æ¥å¤±è´¥</title>
    <url>//posts/2024/01/15/ssh-github/</url>
    <content><![CDATA[<p>è®°å½•ä¸€æ¬¡å¤±è´¥çš„ Github SSH è¿æ¥é—®é¢˜æ’æŸ¥è¿‡ç¨‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh -T git@github.com</span><br><span class="line">git@github.com: Permission denied (publickey).</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h2><p>è‡ªå·± Windows ç³»ç»Ÿä¸Šå¾ˆæ—©ç”Ÿæˆäº†ä¸€å¯¹ ssh å¯†é’¥ç”¨äº Github ä»“åº“è®¿é—®, ç„¶åæƒ³åœ¨ Ubuntu çš„è™šæ‹Ÿæœºé‡Œä¹Ÿç”¨åŒæ ·çš„å¯†é’¥å»è®¿é—® Github, äºæ˜¯ä¹ç›´æ¥ç”¨ Xftp è¿æ¥è™šæ‹Ÿæœºä¼ äº†ä¸Šå», æ”¾åˆ° <code>~/.ssh/</code> ç›®å½•ä¸‹.</p>
<p>ä½†æ˜¯ clone ä»“åº“æ—¶, å‡ºç°äº†å¦‚ä¸‹æŠ¥é”™:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone git@github.com:ww-rm/&lt;repo&gt;.git</span><br><span class="line">æ­£å…‹éš†åˆ° &#x27;&lt;repo&gt;&#x27;...</span><br><span class="line">sign_and_send_pubkey: signing failed for RSA &quot;/home/&lt;username&gt;/.ssh/id_rsa&quot; from agent: agent refused operation</span><br><span class="line">git@github.com: Permission denied (publickey).</span><br><span class="line">fatal: æ— æ³•è¯»å–è¿œç¨‹ä»“åº“ã€‚</span><br><span class="line"></span><br><span class="line">è¯·ç¡®è®¤æ‚¨æœ‰æ­£ç¡®çš„è®¿é—®æƒé™å¹¶ä¸”ä»“åº“å­˜åœ¨ã€‚</span><br></pre></td></tr></table></figure>

<h2 id="ä¸Šä¸‹æ±‚ç´¢"><a href="#ä¸Šä¸‹æ±‚ç´¢" class="headerlink" title="ä¸Šä¸‹æ±‚ç´¢"></a>ä¸Šä¸‹æ±‚ç´¢</h2><p>å¾ˆè¿·èŒ«, è‡ªå·± Windows ä¸Šä¸€ç›´éƒ½æ˜¯ç”¨çš„è¿™ä¸ªå¯†é’¥, å¤åˆ¶è¿‡å»å’‹å°±ä¸è®¤äº†?</p>
<p>äºæ˜¯æœç´¢ä¸€æ³¢, æ‰¾åˆ°äº† Github Docs çš„ <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vYXV0aGVudGljYXRpb24vdHJvdWJsZXNob290aW5nLXNzaC9lcnJvci1wZXJtaXNzaW9uLWRlbmllZC1wdWJsaWNrZXk=">Error: Permission denied (publickey)<i class="fa fa-external-link-alt"></i></span> é¡µé¢.</p>
<p>æŒ‰ç…§ä¸Šé¢è¯´çš„, ç”¨å‘½ä»¤ <code>ssh -T git@github.com</code> åˆ†åˆ«åœ¨ Windows ä¸Šå’Œ Ubuntu ä¸Šéƒ½æµ‹è¯•ä¸€é.</p>
<p>ç„¶å Windows ç»™äº†ä¸€ä¸ªæ„‰å¿«çš„è¾“å‡º:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hi ww-rm! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ Ubuntu è¿˜æ˜¯å¤±è´¥:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sign_and_send_pubkey: signing failed for RSA &quot;/home/&lt;username&gt;/.ssh/id_rsa&quot; from agent: agent refused operation</span><br><span class="line">git@github.com: Permission denied (publickey).</span><br></pre></td></tr></table></figure>

<p>æˆ‘æŠŠç›®å…‰è½åœ¨ <code>agent refused operation</code> è¿™ä¸ªæç¤ºä¸Š.</p>
<p>ä¸€ç•ªæœç´¢ä¹‹å, å¾—åˆ°çš„ç»“è®ºå¤§éƒ¨åˆ†éƒ½æ˜¯è¯´ key æ²¡æœ‰æ·»åŠ , è¦ä½¿ç”¨ <code>ssh-add</code> å‘½ä»¤. äºæ˜¯å†æ¬¡å°è¯•.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-add ~/.ssh/id_rsa</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">Permissions 0644 <span class="keyword">for</span> <span class="string">&#x27;/home/&lt;username&gt;/.ssh/id_rsa&#x27;</span> are too open.</span><br><span class="line">It is required that your private key files are NOT accessible by others.</span><br><span class="line">This private key will be ignored.</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸‹å­æŠ¥é”™å¾ˆæ˜ç™½äº†, å®ƒå‘Šè¯‰æˆ‘ä»¬ç”±äºç§é’¥æƒé™å¤ªå¼€æ”¾äº†, æ‰€ä»¥å¿½ç•¥äº†è¿™ä¸ªå¯†é’¥. ç”¨ <code>ll</code> çœ‹ä¸€çœ¼ä¹Ÿèƒ½å‘ç°æ–‡ä»¶æƒé™æ˜¯ <code>-rw-r--r--</code>.</p>
<h2 id="çœŸç›¸"><a href="#çœŸç›¸" class="headerlink" title="çœŸç›¸"></a>çœŸç›¸</h2><p>Xftp åœ¨ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™, æ–‡ä»¶æƒé™è‡ªåŠ¨ç»™äº† <code>644</code>, ç„¶å <code>ssh</code> å¿½ç•¥äº†è¿™ç§é«˜æƒé™çš„ä¸å®‰å…¨å¯†é’¥æ–‡ä»¶.</p>
<p>æ‰€ä»¥è§£å†³æ–¹æ¡ˆå°±æ˜¯ç”¨ <code>chmod</code> ä¿®æ”¹ç§é’¥çš„æ–‡ä»¶æƒé™, æŠŠç»„æƒé™å»æ‰, ä¹Ÿå°±æ˜¯å°†åŸæœ¬ <code>644</code> çš„æƒé™æ”¹æˆ <code>600</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 600 ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å®Œä¹‹åå†æ¬¡ä½¿ç”¨ <code>ssh -T git@github.com</code> åœ¨ Ubuntu, å°±èƒ½æˆåŠŸè¿æ¥äº†.</p>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>SSH</tag>
        <tag>Github</tag>
      </tags>
  </entry>
  <entry>
    <title>Unity æ‰‹å·¥ Mod åˆ¶ä½œæ–¹æ³•æ•´ç†</title>
    <url>//posts/2025/01/31/unity-mod/</url>
    <content><![CDATA[<p>æœ€è¿‘åœ¨ DLsite ä¸Šæ‰¾åˆ°äº†<span class="exturl" data-url="aHR0cHM6Ly93d3cuZGxzaXRlLmNvbS9tYW5pYXgvd29yay89L3Byb2R1Y3RfaWQvUkowMTIxMjkyMS5odG1s">ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„éŸ³æ¸¸<i class="fa fa-external-link-alt"></i></span>, äºæ˜¯åœ¨èµ„æºå¹³å°ä¸Šä¸‹è½½ä¸‹æ¥ç©äº†ä¸€ä¸‹. è™½ç„¶è¯´ v1.1 ç‰ˆæœ¬å¢åŠ äº†è‡ªåŠ¨æ¸¸ç©çš„åŠŸèƒ½, ä½†æ˜¯ä¼šå¿½ç•¥ç‰¹æ®ŠéŸ³ç¬¦, æ‰€ä»¥ç©èµ·æ¥æ€»æ„Ÿè§‰å°‘ç‚¹ä»€ä¹ˆ. äºæ˜¯ä¹åœ¨å„å¤§è®ºå›å¸–å­çš„å¸®åŠ©ä¸‹, æˆåŠŸåšå‡ºäº†ç¬¬ä¸€ä¸ª Unity æ¸¸æˆ Mod, é¡ºå¸¦è¿˜äº†è§£äº†ä¸€äº›åŸºç¡€çš„æ±‰åŒ–æ–¹å¼.</p>
<span id="more"></span>

<h2 id="åŠŸèƒ½-Mod"><a href="#åŠŸèƒ½-Mod" class="headerlink" title="åŠŸèƒ½ Mod"></a>åŠŸèƒ½ Mod</h2><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>æˆ‘éœ€è¦å¢åŠ çš„åŠŸèƒ½å¾ˆç®€å•, æ¸¸æˆåŸæœ¬çš„è‡ªåŠ¨æ¸¸ç©åŠŸèƒ½æ˜¯è‡ªåŠ¨ Perfect æ‰€æœ‰çš„å¸¸è§„éŸ³ç¬¦, ä½†æ˜¯å®é™…ä¸ŠéŸ³è½¨ä¸Šä¼šæœ‰å¾ˆå¤šç‰¹æ®ŠéŸ³ç¬¦, å¦‚æœç‚¹å‡»äº†ä¼šè§¦å‘ç‰¹æ®Šæ•ˆæœ<del>æ¶©æ¶©</del>, æ‰€ä»¥æˆ‘å¸Œæœ›åœ¨åŸæœ¬è‡ªåŠ¨æ¸¸ç©åŠŸèƒ½çš„åŸºç¡€ä¸Š, å¢åŠ å¯¹ç‰¹æ®ŠéŸ³ç¬¦çš„ç‚¹å‡»æ“ä½œ.</p>
<p>å¾ˆå¹¸è¿çš„æ˜¯, è¿™ä¸ªæ¸¸æˆæ˜¯ Unity å¼•æ“åˆ¶ä½œçš„, å¹¶ä¸”è„šæœ¬ç¼–è¯‘æ–¹å¼ä¹Ÿæ˜¯ Mono æ¨¡å¼, å› æ­¤æ“ä½œèµ·æ¥éš¾åº¦æ¯”è¾ƒä½, é€‚åˆæˆ‘è¿™ä¸ªå°ç™½å…¥é—¨ç»ƒæ‰‹.</p>
<p>åœ¨æ¸¸æˆæ ¹ç›®å½•ä¸‹çš„ <code>XXX_Data/Managed</code> ç›®å½•ä¸‹å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª <code>Assembly-CSharp.dll</code> æ–‡ä»¶, è¿™æ˜¯ Mono æ–¹å¼ç¼–è¯‘çš„ç‰¹ç‚¹, è€Œæ¸¸æˆé€»è¾‘ä»£ç ä¹Ÿä½äºè¿™ä»½ dll æ–‡ä»¶é‡Œ.</p>
<p>æˆ‘ä»¬éœ€è¦ç”¨åˆ° <span class="exturl" data-url="aHR0cHM6Ly93d3cuamV0YnJhaW5zLmNvbS9kZWNvbXBpbGVyLw==">dotPeek<i class="fa fa-external-link-alt"></i></span>, ä»»æ„ç‰ˆæœ¬ Visual Studio å’Œ <span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL3poLWNuL2RvdG5ldC9mcmFtZXdvcmsvdG9vbHMvaWxkYXNtLWV4ZS1pbC1kaXNhc3NlbWJsZXI=">ildasm/ilasm<i class="fa fa-external-link-alt"></i></span> å‡ ä¸ªå·¥å…·.</p>
<p>dotPeek æ˜¯ä¸€ä¸ª .NET åç¼–è¯‘å·¥å…·, å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¯¼å‡º dll å¯¹åº”çš„ C# æºä»£ç , ç„¶åç†è§£æ¸¸æˆé€»è¾‘, å®šä½åŠŸèƒ½ä»£ç æ‰€å¤„çš„ä½ç½®.</p>
<p>Visual Studio ç”¨æ¥æ‰“å¼€ dotPeek å¯¼å‡ºçš„ dll é¡¹ç›®, æ–¹ä¾¿æŸ¥æ‰¾ä»£ç .</p>
<p>ildasm/ilasm æ˜¯ä¸€ç»„ IL è¯­è¨€åæ±‡ç¼–/æ±‡ç¼–å·¥å…·, å¯ä»¥å°† dll è½¬æ¢æˆèƒ½å¤Ÿæ‰‹å·¥ä¿®æ”¹çš„ IL ä»£ç , å¹¶æŠŠä¿®æ”¹è¿‡çš„ IL ä»£ç é‡æ–°æ‰“åŒ…æˆ dll æ–‡ä»¶, å®Œæˆ Mod. è¯¥å·¥å…·éš Visual Studio ä¸€èµ·å®‰è£….</p>
<p>æ­¤å¤–è¿˜éœ€è¦ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨, æ¨è VSCode.</p>
<p>æˆ‘ä»¬çš„æ€è·¯å¾ˆç®€å•, å°†åŸå§‹ dll å¯¼å‡º IL ä»£ç , ä¿®æ”¹éœ€è¦çš„åŠŸèƒ½, é‡æ–°æŠŠ IL ä»£ç æ‰“åŒ…å› dll å¹¶æ›¿æ¢åŸå§‹ dll, ä»è€Œå¢åŠ  Mod åŠŸèƒ½.</p>
<p>æ‰“å¼€ dotPeek, å¹¶ä¸” Open æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ dll æ–‡ä»¶, åŠ è½½å®Œæˆåå³é”®é¡¹ç›®åé€‰æ‹© <code>Export to Project</code>, å¹¶é€‰æ‹©ä¸€ä¸ªåœ°æ–¹ä¿å­˜å¯¼å‡ºçš„ VS é¡¹ç›®.</p>
<p>ç„¶åæ˜¯ IL ä»£ç çš„åæ±‡ç¼–å’Œæ±‡ç¼–, å¯ä»¥åœ¨ VS å¼€å‘äººå‘˜å‘½ä»¤æç¤ºç¬¦é‡Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åæ±‡ç¼–å¹¶æŒ‡å®šè¾“å‡º, ä¼šå¾—åˆ° il ä»¥åŠä¸€ä»½ res æ–‡ä»¶</span></span><br><span class="line">ildasm Assembly-CSharp.dll /output:Assembly-CSharp.il</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ä¿®æ”¹åçš„ il æ–‡ä»¶å’Œ res é‡æ–°æ‰“åŒ…å› dll, ä¸æŠ¥é”™å³æˆåŠŸ</span></span><br><span class="line">ilasm /dll /resource:Assembly-CSharp.res Assembly-CSharp.il /output:Assembly-CSharp.dll</span><br></pre></td></tr></table></figure>

<p>å¯èƒ½è¿˜æœ‰æ›´å¥½çš„å·¥å…·, ä¾‹å¦‚ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RuU3B5RXgvZG5TcHk=">dnSpy<i class="fa fa-external-link-alt"></i></span>, ä½†æ˜¯ä½œä¸ºå°ç™½, æˆ‘å‚è€ƒçš„å¸–å­å°±æ˜¯ç”¨çš„è¿™å‡ ä¸ª, æ‰€ä»¥æˆåŠŸä¹‹åä¹Ÿæ²¡èŠ±æ—¶é—´å»ç ”ç©¶æ›´å¥½çš„å·¥å…·äº†, æœ‰å…´è¶£çš„å¯ä»¥è¯•è¯•.</p>
<h3 id="å®šä½-C-ä»£ç "><a href="#å®šä½-C-ä»£ç " class="headerlink" title="å®šä½ C# ä»£ç "></a>å®šä½ C# ä»£ç </h3><p>æ‰“å¼€æˆ‘ä»¬å¯¼å‡ºçš„ VS é¡¹ç›®, æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å‘æŒ¥æˆ‘ä»¬çš„èªæ˜æ‰æ™ºå’Œç¼–ç¨‹ç»éªŒ, æ‰¾åˆ°å’Œåˆ¤å®šæœ‰å…³çš„é€»è¾‘, ä»¥åŠä¸€äº›å¥½ç”¨çš„å¯¼èˆªåŠŸèƒ½:</p>
<ul>
<li><code>Ctrl + F</code>: æŸ¥æ‰¾æ‰€æœ‰å•è¯</li>
<li><code>F12</code>: æŸ¥æ‰¾å®šä¹‰</li>
<li><code>Shift + F12</code>: æŸ¥æ‰¾å¼•ç”¨</li>
</ul>
<p>ç»è¿‡ä¸€ç•ªæœå¯», å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªè¿™æ ·çš„å‡½æ•°.</p>
<details class="note info"><summary><p>æ€ä¹ˆæ‰¾çš„?</p>
</summary>
<p>ä½œä¸ºä¸€ä¸ªéŸ³æ¸¸, å¯ä»¥çœ‹åˆ°ä»£ç é‡Œå¾ˆå¤šå’Œ Judge æœ‰å…³çš„å‡½æ•°, ä¸ºäº†æŒ‚æœºè‡ªåŠ¨ Perfect, æˆ‘ä»¬éœ€è¦ä¿®æ”¹æŒ‚æœºåˆ¤å®šéƒ¨åˆ†é€»è¾‘, å› æ­¤å›´ç»• Judge è¿™ä¸ªå•è¯å»æŸ¥æ‰¾æœ‰å…³çš„æ–¹æ³•.</p>

</details>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckTimeLimit</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  NotesData target1;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.NotesQueueLeft.TryPeek(<span class="keyword">ref</span> target1))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (target1.NotesType == RhysmGame.NotesType.Event || target1.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ((<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt;= (<span class="built_in">double</span>) target1.EndTime + (<span class="built_in">double</span>) target1.HitCount * (<span class="built_in">double</span>) <span class="keyword">this</span>.adjustData.ThroughTime)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (target1.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">          <span class="keyword">this</span>.PlayEventNotes(target1);</span><br><span class="line">        <span class="keyword">this</span>.NotesViewer.SetActiveNotes(target1.Id);</span><br><span class="line">        <span class="keyword">this</span>.NotesQueueLeft.Dequeue();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.IsAutoPlay &amp;&amp; (<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt; (<span class="built_in">double</span>) target1.EndTime)</span><br><span class="line">    &#123;</span><br><span class="line">      NotesData targetNotes = <span class="keyword">this</span>.NotesQueueLeft.Dequeue();</span><br><span class="line">      <span class="keyword">this</span>.SetJudgeResult(targetNotes, RhysmGame.JudgeType.Perfect);</span><br><span class="line">      <span class="keyword">this</span>.NotesViewer.SetActiveNotes(targetNotes.Id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt; (<span class="built_in">double</span>) target1.EndTime + (<span class="built_in">double</span>) target1.HitCount * <span class="number">0.10000000149011612</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      NotesData targetNotes = <span class="keyword">this</span>.NotesQueueLeft.Dequeue();</span><br><span class="line">      <span class="keyword">this</span>.SetJudgeResult(targetNotes, RhysmGame.JudgeType.Bad);</span><br><span class="line">      <span class="keyword">this</span>.NotesViewer.SetActiveNotes(targetNotes.Id);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  NotesData target2;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.NotesQueueRight.TryPeek(<span class="keyword">ref</span> target2))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (target2.NotesType == RhysmGame.NotesType.Event || target2.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &lt; (<span class="built_in">double</span>) target2.EndTime + (<span class="built_in">double</span>) target2.HitCount * (<span class="built_in">double</span>) <span class="keyword">this</span>.adjustData.ThroughTime)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (target2.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">      <span class="keyword">this</span>.PlayEventNotes(target2);</span><br><span class="line">    <span class="keyword">this</span>.NotesViewer.SetActiveNotes(target2.Id);</span><br><span class="line">    <span class="keyword">this</span>.NotesQueueRight.Dequeue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.IsAutoPlay &amp;&amp; (<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt; (<span class="built_in">double</span>) target2.EndTime)</span><br><span class="line">  &#123;</span><br><span class="line">    NotesData targetNotes = <span class="keyword">this</span>.NotesQueueRight.Dequeue();</span><br><span class="line">    <span class="keyword">this</span>.SetJudgeResult(targetNotes, RhysmGame.JudgeType.Perfect);</span><br><span class="line">    <span class="keyword">this</span>.NotesViewer.SetActiveNotes(targetNotes.Id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &lt;= (<span class="built_in">double</span>) target2.EndTime + (<span class="built_in">double</span>) target2.HitCount * <span class="number">0.079999998211860657</span>)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.SetJudgeResult(<span class="keyword">this</span>.NotesQueueRight.Dequeue(), RhysmGame.JudgeType.Bad);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°æè¿°çš„æ˜¯åœ¨æŒ‚æœºæ—¶ä»€ä¹ˆéƒ½æ²¡åšéŸ³ç¬¦è¶…æ—¶äº†å¦‚ä½•å¤„ç†, å¯ä»¥çœ‹åˆ°å¯¹ä¸åŒç±»å‹çš„éŸ³ç¬¦æœ‰ä¸åŒçš„å¤„ç†è§„åˆ™.</p>
<p>å¦‚æœæ˜¯è‡ªåŠ¨æ¸¸ç©æ¨¡å¼, åˆ™å¯¹äºè¶…æ—¶çš„éŸ³ç¬¦ä¼šåˆ¤å®šæˆ Perfect, å¦åˆ™ä¼šåˆ¤å®šè¶…æ—¶ 0.1 ç§’å˜æˆ Bad.</p>
<p>æˆ‘ä»¬ç°åœ¨éœ€è¦åœ¨å¯¹ <code>Temptation</code> ç±»å‹çš„éŸ³ç¬¦é‡Œå¢åŠ è§¦å‘æ“ä½œ, åŸé€»è¾‘ç›´æ¥å¿½ç•¥äº†è¯¥ç±»å‹éŸ³ç¬¦.</p>
<p>äºæ˜¯æˆ‘ä»¬é’ˆå¯¹è¿™ä¸ªå…³é”®è¯, å¯»æ‰¾ä¸€ä¸‹éè‡ªåŠ¨æ¨¡å¼ç‚¹å‡»åç‰¹æ®ŠéŸ³ç¬¦çš„è§¦å‘é€»è¾‘.</p>
<p>è¿›ä¸€æ­¥æ‰¾åˆ°æ ¸å¿ƒå‡½æ•° <code>SetJudgeResult</code>, ç”¨äºå¤„ç†æ¯ä¸ªéŸ³ç¬¦ç‚¹å‡»åçš„åˆ¤å®šç»“æœ.</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetJudgeResult</span>(<span class="params">NotesData targetNotes, RhysmGame.JudgeType type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (targetNotes.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">this</span>.NotesViewer.SetActiveNotes(targetNotes.Id);</span><br><span class="line">  <span class="keyword">if</span> (targetNotes.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  &#123;</span><br><span class="line">    SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(<span class="string">&quot;BattleSE&quot;</span>, <span class="string">&quot;Temptation&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.SetActiveTemptation(targetNotes.AnimationId);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">int</span> num = !targetNotes.IsLong ? targetNotes.AnimationType() : <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> type1 = targetNotes.HitType == RhysmGame.HitType.Up ? <span class="number">-1</span> : num;</span><br><span class="line">    <span class="keyword">this</span>.IsPlayLoopAnim |= targetNotes.IsLong;</span><br><span class="line">    <span class="keyword">if</span> (targetNotes.IsLong)</span><br><span class="line">      SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlayLoopSE(<span class="string">&quot;BattleSE&quot;</span>, <span class="string">&quot;Loop&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (targetNotes.HitType == RhysmGame.HitType.Up)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">this</span>.IsPlayLoopAnim = <span class="literal">false</span>;</span><br><span class="line">      SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.StopLoopSE();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.IsPlayLoopAnim)</span><br><span class="line">      type1 = <span class="number">0</span>;</span><br><span class="line">    Action onPlaySe = <span class="keyword">this</span>.OnPlaySe;</span><br><span class="line">    <span class="keyword">if</span> (onPlaySe != <span class="literal">null</span>)</span><br><span class="line">      onPlaySe();</span><br><span class="line">    <span class="keyword">switch</span> (type - <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> RhysmGame.JudgeType.Bad:</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> RhysmGame.JudgeType.Good:</span><br><span class="line">        <span class="keyword">this</span>.ComboMiss();</span><br><span class="line">        <span class="keyword">this</span>.PlayBadAnim();</span><br><span class="line">        <span class="keyword">this</span>.OnPlayBadEffect(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.PlayAnimation(type1, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.JudgeEffect(targetNotes.IsLong, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> RhysmGame.JudgeType.Perfect:</span><br><span class="line">        <span class="keyword">this</span>.AddCombo();</span><br><span class="line">        <span class="keyword">this</span>.OnPlayBadEffect(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.PlayAnimation(type1, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.JudgeEffect(targetNotes.IsLong);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> RhysmGame.JudgeType.Good | RhysmGame.JudgeType.Perfect:</span><br><span class="line">        <span class="keyword">this</span>.AddCombo();</span><br><span class="line">        <span class="keyword">this</span>.OnPlayBadEffect(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>.PlayAnimation(type1, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">this</span>.JudgeEffect(targetNotes.IsLong);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type == RhysmGame.JudgeType.Ready)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.PlaySe(type);</span><br><span class="line">    <span class="keyword">this</span>.ScoreDic[type]++;</span><br><span class="line">    <span class="keyword">this</span>.AddEcstasy(type);</span><br><span class="line">    <span class="built_in">string</span> timingText = (SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() - targetNotes.EndTime).ToString();</span><br><span class="line">    <span class="keyword">this</span>.InstantiateJudgeObject(type, timingText);</span><br><span class="line">    <span class="keyword">if</span> (targetNotes.NotesType != RhysmGame.NotesType.Heart)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">this</span>.PlayHeartSe(type);</span><br><span class="line">    <span class="keyword">this</span>.AddHeartScore(type);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>èµ·ä½œç”¨çš„å°±æ˜¯è¿™ä¸¤å¥:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(<span class="string">&quot;BattleSE&quot;</span>, <span class="string">&quot;Temptation&quot;</span>);</span><br><span class="line"><span class="keyword">this</span>.SetActiveTemptation(targetNotes.AnimationId);</span><br></pre></td></tr></table></figure>

<p>è§¦å‘äº†ç‰¹æ®ŠåŠ¨ç”»æ•ˆæœ, é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨ <code>CheckTimeLimit</code> å‡½æ•°é‡Œå¢åŠ è¿™ä¸¤å¥å°±è¡Œ, ç±»ä¼¼ä¸‹é¢è¿™æ ·:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckTimeLimit</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">  <span class="keyword">if</span> (target1.NotesType == RhysmGame.NotesType.Event || target1.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt; (<span class="built_in">double</span>) target1.EndTime)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (target1.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">        <span class="keyword">this</span>.PlayEventNotes(target1);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.IsAutoPlay &amp;&amp; target1.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">      &#123;</span><br><span class="line">        SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(<span class="string">&quot;BattleSE&quot;</span>, <span class="string">&quot;Temptation&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.SetActiveTemptation(target1.AnimationId);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.NotesViewer.SetActiveNotes(target1.Id);</span><br><span class="line">      <span class="keyword">this</span>.NotesQueueLeft.Dequeue();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">  <span class="keyword">if</span> (target2.NotesType == RhysmGame.NotesType.Event || target2.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">double</span>) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &lt;= (<span class="built_in">double</span>) target2.EndTime)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (target2.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">      <span class="keyword">this</span>.PlayEventNotes(target2);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.IsAutoPlay &amp;&amp; target2.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">    &#123;</span><br><span class="line">      SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(<span class="string">&quot;BattleSE&quot;</span>, <span class="string">&quot;Temptation&quot;</span>);</span><br><span class="line">      <span class="keyword">this</span>.SetActiveTemptation(target2.AnimationId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.NotesViewer.SetActiveNotes(target2.Id);</span><br><span class="line">    <span class="keyword">this</span>.NotesQueueRight.Dequeue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¿®æ”¹-IL-ä»£ç "><a href="#ä¿®æ”¹-IL-ä»£ç " class="headerlink" title="ä¿®æ”¹ IL ä»£ç "></a>ä¿®æ”¹ IL ä»£ç </h3><p>ç¡®è®¤ C# å±‚é¢çš„ä»£ç ä¿®æ”¹é€»è¾‘ä¹‹å, å°±å¯ä»¥å»ä¿®æ”¹ IL ä»£ç äº†.</p>
<div class="note info"><p>ç»è¿‡åç»­æµ‹è¯•, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RuU3B5RXgvZG5TcHk=">dnSpy<i class="fa fa-external-link-alt"></i></span> å¯ä»¥å¾ˆè½»æ¾åœ°ä»¥æºä»£ç å½¢å¼è¿›è¡Œä¿®æ”¹æ–¹æ³•å¹¶æ›´æ–° dll æ–‡ä»¶, ç›´æ¥å†™ C#, éå¸¸æ–¹ä¾¿.</p>
<p>çŒœæµ‹å…¶å†…éƒ¨åŸç†ä¸æ‰‹åŠ¨ä¿®æ”¹ IL ä»£ç ç±»ä¼¼, ä½†æ˜¯æŠŠè¿™äº›ç¹ççš„æ­¥éª¤ç®€åŒ–äº†.</p>
</div>

<p>ç”¨ ildasm å¯¼å‡º <code>Assembly-CSharp.il</code>, ç„¶åç”¨ VSCode æ‰“å¼€, ç›´æ¥æœç´¢è¿™ä¸¤ä¸ªå‡½æ•°å, æ‰¾åˆ° IL ä»£ç çš„å®šä¹‰.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.method public hidebysig instance void </span><br><span class="line">        SetJudgeResult(class NotesData targetNotes,</span><br><span class="line">                        valuetype RhysmGame/JudgeType &#x27;type&#x27;) cil managed</span><br><span class="line">&#123;</span><br><span class="line">  // ä»£ç å¤§å°       461 (0x1cd)</span><br><span class="line">  .maxstack  4</span><br><span class="line">  .locals init (int32 V_0,</span><br><span class="line">            string V_1,</span><br><span class="line">            valuetype RhysmGame/JudgeType V_2,</span><br><span class="line">            int32 V_3,</span><br><span class="line">            float32 V_4)</span><br><span class="line">  // ......</span><br><span class="line"></span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  // if (targetNotes.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  // &#123;</span><br><span class="line">  //   SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(&quot;BattleSE&quot;, &quot;Temptation&quot;);</span><br><span class="line">  //   this.SetActiveTemptation(targetNotes.AnimationId);</span><br><span class="line">  // &#125;</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  IL_001c:  ldarg.1</span><br><span class="line">  IL_001d:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_0022:  ldc.i4.4</span><br><span class="line">  IL_0023:  bne.un.s   IL_0046</span><br><span class="line"></span><br><span class="line">  IL_0025:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_002a:  ldstr      &quot;BattleSE&quot;</span><br><span class="line">  IL_002f:  ldstr      &quot;Temptation&quot;</span><br><span class="line">  IL_0034:  callvirt   instance void SoundManager::PlaySE(string,</span><br><span class="line">                                                          string)</span><br><span class="line">  IL_0039:  ldarg.0</span><br><span class="line">  IL_003a:  ldarg.1</span><br><span class="line">  IL_003b:  ldfld      string NotesData::AnimationId</span><br><span class="line">  IL_0040:  call       instance void RhysmGame::SetActiveTemptation(string)</span><br><span class="line">  IL_0045:  ret</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">  // ......</span><br><span class="line">&#125; // end of method RhysmGame::SetJudgeResult</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.method public hidebysig instance void </span><br><span class="line">        CheckTimeLimit() cil managed</span><br><span class="line">&#123;</span><br><span class="line">  // ä»£ç å¤§å°       511 (0x1ff)</span><br><span class="line">  .maxstack  4</span><br><span class="line">  .locals init (class NotesData V_0,</span><br><span class="line">            class NotesData V_1,</span><br><span class="line">            class NotesData V_2,</span><br><span class="line">            class NotesData V_3,</span><br><span class="line">            class NotesData V_4,</span><br><span class="line">            class NotesData V_5)</span><br><span class="line">  </span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  // if ((double) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt;= (double) target1.EndTime + (double) target1.HitCount * (double) this.adjustData.ThroughTime)</span><br><span class="line">  // &#123;</span><br><span class="line">  //   if (target1.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">  //     this.PlayEventNotes(target1);</span><br><span class="line">  //   this.NotesViewer.SetActiveNotes(target1.Id);</span><br><span class="line">  //   this.NotesQueueLeft.Dequeue();</span><br><span class="line">  // &#125;</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  IL_0024:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_0029:  callvirt   instance float32 SoundManager::GetBGMCurrentTime()</span><br><span class="line">  IL_002e:  ldloc.0</span><br><span class="line">  IL_002f:  ldfld      float32 NotesData::EndTime</span><br><span class="line">  IL_0034:  ldloc.0</span><br><span class="line">  IL_0035:  ldfld      int32 NotesData::HitCount</span><br><span class="line">  IL_003a:  conv.r4</span><br><span class="line">  IL_003b:  ldarg.0</span><br><span class="line">  IL_003c:  ldfld      class AdjustData RhysmGame::adjustData</span><br><span class="line">  IL_0041:  ldfld      float32 AdjustData::ThroughTime</span><br><span class="line">  IL_0046:  mul</span><br><span class="line">  IL_0047:  add</span><br><span class="line">  IL_0048:  blt.un     IL_0108</span><br><span class="line"></span><br><span class="line">  IL_004d:  ldloc.0</span><br><span class="line">  IL_004e:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_0053:  ldc.i4.5</span><br><span class="line">  IL_0054:  bne.un.s   IL_005d</span><br><span class="line"></span><br><span class="line">  IL_0056:  ldarg.0</span><br><span class="line">  IL_0057:  ldloc.0</span><br><span class="line">  IL_0058:  call       instance void RhysmGame::PlayEventNotes(class NotesData)</span><br><span class="line">  IL_005d:  ldarg.0</span><br><span class="line">  IL_005e:  ldfld      class RhysmGameNotesViewer RhysmGame::NotesViewer</span><br><span class="line">  IL_0063:  ldloc.0</span><br><span class="line">  IL_0064:  ldfld      int64 NotesData::Id</span><br><span class="line">  IL_0069:  ldc.i4.0</span><br><span class="line">  IL_006a:  callvirt   instance void RhysmGameNotesViewer::SetActiveNotes(int64,</span><br><span class="line">                                                                          bool)</span><br><span class="line">  IL_006f:  ldarg.0</span><br><span class="line">  IL_0070:  ldfld      class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt; RhysmGame::NotesQueueLeft</span><br><span class="line">  IL_0075:  callvirt   instance !0 class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt;::Dequeue()</span><br><span class="line">  IL_007a:  pop</span><br><span class="line">  IL_007b:  br         IL_0108</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">  // ......</span><br><span class="line"></span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  // if ((double) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &lt; (double) target2.EndTime + (double) target2.HitCount * (double) this.adjustData.ThroughTime)</span><br><span class="line">  //   return;</span><br><span class="line">  // if (target2.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">  //   this.PlayEventNotes(target2);</span><br><span class="line">  // this.NotesViewer.SetActiveNotes(target2.Id);</span><br><span class="line">  // this.NotesQueueRight.Dequeue();</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  IL_012c:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_0131:  callvirt   instance float32 SoundManager::GetBGMCurrentTime()</span><br><span class="line">  IL_0136:  ldloc.1</span><br><span class="line">  IL_0137:  ldfld      float32 NotesData::EndTime</span><br><span class="line">  IL_013c:  ldloc.1</span><br><span class="line">  IL_013d:  ldfld      int32 NotesData::HitCount</span><br><span class="line">  IL_0142:  conv.r4</span><br><span class="line">  IL_0143:  ldarg.0</span><br><span class="line">  IL_0144:  ldfld      class AdjustData RhysmGame::adjustData</span><br><span class="line">  IL_0149:  ldfld      float32 AdjustData::ThroughTime</span><br><span class="line">  IL_014e:  mul</span><br><span class="line">  IL_014f:  add</span><br><span class="line">  IL_0150:  blt.un     IL_01fe</span><br><span class="line"></span><br><span class="line">  IL_0155:  ldloc.1</span><br><span class="line">  IL_0156:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_015b:  ldc.i4.5</span><br><span class="line">  IL_015c:  bne.un.s   IL_0165</span><br><span class="line"></span><br><span class="line">  IL_015e:  ldarg.0</span><br><span class="line">  IL_015f:  ldloc.1</span><br><span class="line">  IL_0160:  call       instance void RhysmGame::PlayEventNotes(class NotesData)</span><br><span class="line">  IL_0165:  ldarg.0</span><br><span class="line">  IL_0166:  ldfld      class RhysmGameNotesViewer RhysmGame::NotesViewer</span><br><span class="line">  IL_016b:  ldloc.1</span><br><span class="line">  IL_016c:  ldfld      int64 NotesData::Id</span><br><span class="line">  IL_0171:  ldc.i4.0</span><br><span class="line">  IL_0172:  callvirt   instance void RhysmGameNotesViewer::SetActiveNotes(int64,</span><br><span class="line">                                                                          bool)</span><br><span class="line">  IL_0177:  ldarg.0</span><br><span class="line">  IL_0178:  ldfld      class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt; RhysmGame::NotesQueueRight</span><br><span class="line">  IL_017d:  callvirt   instance !0 class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt;::Dequeue()</span><br><span class="line">  IL_0182:  pop</span><br><span class="line">  IL_0183:  ret</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">  // ......</span><br><span class="line"></span><br><span class="line">  IL_01fe:  ret</span><br><span class="line">&#125; // end of method RhysmGame::CheckTimeLimit</span><br></pre></td></tr></table></figure>

<p>IL ä»£ç å¤ªé•¿, è´´äº†ä¸€ä¸‹æ ¸å¿ƒä»£ç ç‰‡æ®µçš„å¯¹ç…§. æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠ <code>SetJudgeResult</code> é‡Œçš„ IL ä»£ç ç‰‡æ®µæ·»åŠ åˆ° <code>CheckTimeLimit</code> é‡Œ. ä¸åŒ IL ä»£ç æŒ‡ä»¤å«ä¹‰ç”¨æ³•å¯ä»¥æŸ¥è¯¢æ–‡æ¡£ <span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL2RvdG5ldC9hcGkvc3lzdGVtLnJlZmxlY3Rpb24uZW1pdC5vcGNvZGVz">OpCodes Class<i class="fa fa-external-link-alt"></i></span>.</p>
<p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹æ¯æ¡æŒ‡ä»¤è¿è¡Œæ ¼å¼, æ–¹æ³•è¿è¡Œä¸­ä¼šæœ‰ä¸€ä¸ªè®¡ç®—æ ˆ, æ¯æ¡æŒ‡ä»¤éƒ½è§„å®šäº†æŒ‡ä»¤å¤§å°å’Œå‚æ•°æ•°é‡, è°ƒç”¨å‰å…ˆå°†éœ€è¦çš„å‚æ•°è¿›æ ˆ, ç„¶åè°ƒç”¨æŒ‡ä»¤å, è°ƒç”¨çš„å‚æ•°éƒ½ä¼šè¢«å‡ºæ ˆ, æŒ‡ä»¤çš„è¿”å›ç»“æœè¢«è¿›æ ˆ. å¯ä»¥æŠŠæ¯æ¡æŒ‡ä»¤ç†è§£æˆéµå¾ª stdcall è°ƒç”¨çº¦å®šçš„å‡½æ•°.</p>
<p>åœ¨ IL ä»£ç çš„æ–¹æ³•é‡Œ, æ¯æ¡æŒ‡ä»¤éƒ½æœ‰è‡ªå·±çš„åœ°å€ (åå…­è¿›åˆ¶), å¹¶ä¸”ä¸‹ä¸€è¡Œåœ°å€ç­‰äºä¸Šä¸€è¡Œåœ°å€åŠ ä¸Šä¸Šä¸€è¡ŒæŒ‡ä»¤æ‰€å å­—èŠ‚æ•°. åŒæ—¶å¯¹äºæµç¨‹æ§åˆ¶, ä¼šå­˜åœ¨ä¸€äº›è·³è½¬æŒ‡ä»¤æ¥å®Œæˆç±»ä¼¼äº <code>if/else</code> çš„é€»è¾‘åˆ¤æ–­.</p>
<p>æ˜ç™½ä¸Šè¿°å…³ç³»å, æˆ‘ä»¬å°±å¯ä»¥ä¾è‘«èŠ¦ç”»ç“¢, æ¨¡ä»¿ç°æœ‰çš„ IL ä»£ç è¿›è¡Œä¿®æ”¹, æ”¹å®Œä¹‹åå¤§æ¦‚é•¿è¿™æ ·.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.method public hidebysig instance void </span><br><span class="line">        CheckTimeLimit() cil managed</span><br><span class="line">&#123;</span><br><span class="line">  // ä»£ç å¤§å°       511 (0x1ff)</span><br><span class="line">  .maxstack  4</span><br><span class="line">  .locals init (class NotesData V_0,</span><br><span class="line">            class NotesData V_1,</span><br><span class="line">            class NotesData V_2,</span><br><span class="line">            class NotesData V_3,</span><br><span class="line">            class NotesData V_4,</span><br><span class="line">            class NotesData V_5)</span><br><span class="line">  </span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  // if ((double) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &gt; (double) target1.EndTime)</span><br><span class="line">  // &#123;</span><br><span class="line">  //   if (target1.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">  //     this.PlayEventNotes(target1);</span><br><span class="line">  //   if (this.IsAutoPlay &amp;&amp; target1.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  //   &#123;</span><br><span class="line">  //     SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(&quot;BattleSE&quot;, &quot;Temptation&quot;);</span><br><span class="line">  //     this.SetActiveTemptation(target1.AnimationId);</span><br><span class="line">  //   &#125;</span><br><span class="line">  //   this.NotesViewer.SetActiveNotes(target1.Id);</span><br><span class="line">  //   this.NotesQueueLeft.Dequeue();</span><br><span class="line">  // &#125;</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  IL_0024:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_0029:  callvirt   instance float32 SoundManager::GetBGMCurrentTime()</span><br><span class="line">  IL_002e:  ldloc.0</span><br><span class="line">  IL_002f:  ldfld      float32 NotesData::EndTime</span><br><span class="line">  IL_0034:  ble.un     IL_0125</span><br><span class="line"></span><br><span class="line">  IL_0039:  ldloc.0</span><br><span class="line">  IL_003a:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_003f:  ldc.i4.5</span><br><span class="line">  IL_0040:  bne.un.s   IL_0049</span><br><span class="line"></span><br><span class="line">  IL_0042:  ldarg.0</span><br><span class="line">  IL_0043:  ldloc.0</span><br><span class="line">  IL_0044:  call       instance void RhysmGame::PlayEventNotes(class NotesData)</span><br><span class="line">  IL_0049:  ldarg.0</span><br><span class="line">  IL_004a:  ldfld      bool RhysmGame::IsAutoPlay</span><br><span class="line">  IL_004f:  brfalse.s  IL_007a</span><br><span class="line"></span><br><span class="line">  IL_0051:  ldloc.0</span><br><span class="line">  IL_0052:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_0057:  ldc.i4.4</span><br><span class="line">  IL_0058:  bne.un.s   IL_007a</span><br><span class="line"></span><br><span class="line">  IL_005a:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_005f:  ldstr      &quot;BattleSE&quot;</span><br><span class="line">  IL_0064:  ldstr      &quot;Temptation&quot;</span><br><span class="line">  IL_0069:  callvirt   instance void SoundManager::PlaySE(string,</span><br><span class="line">                                                          string)</span><br><span class="line">  IL_006e:  ldarg.0</span><br><span class="line">  IL_006f:  ldloc.0</span><br><span class="line">  IL_0070:  ldfld      string NotesData::AnimationId</span><br><span class="line">  IL_0075:  call       instance void RhysmGame::SetActiveTemptation(string)</span><br><span class="line">  IL_007a:  ldarg.0</span><br><span class="line">  IL_007b:  ldfld      class RhysmGameNotesViewer RhysmGame::NotesViewer</span><br><span class="line">  IL_0080:  ldloc.0</span><br><span class="line">  IL_0081:  ldfld      int64 NotesData::Id</span><br><span class="line">  IL_0086:  ldc.i4.0</span><br><span class="line">  IL_0087:  callvirt   instance void RhysmGameNotesViewer::SetActiveNotes(int64,</span><br><span class="line">                                                                          bool)</span><br><span class="line">  IL_008c:  ldarg.0</span><br><span class="line">  IL_008d:  ldfld      class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt; RhysmGame::NotesQueueLeft</span><br><span class="line">  IL_0092:  callvirt   instance !0 class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt;::Dequeue()</span><br><span class="line">  IL_0097:  pop</span><br><span class="line">  IL_0098:  br         IL_0125</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">  // ......</span><br><span class="line"></span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  // if ((double) SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.GetBGMCurrentTime() &lt;= (double) target2.EndTime)</span><br><span class="line">  //   return;</span><br><span class="line">  // if (target2.NotesType == RhysmGame.NotesType.Event)</span><br><span class="line">  //   this.PlayEventNotes(target2);</span><br><span class="line">  // if (this.IsAutoPlay &amp;&amp; target2.NotesType == RhysmGame.NotesType.Temptation)</span><br><span class="line">  // &#123;</span><br><span class="line">  //   SingletonMonoBehaviour&lt;SoundManager&gt;.Instance.PlaySE(&quot;BattleSE&quot;, &quot;Temptation&quot;);</span><br><span class="line">  //   this.SetActiveTemptation(target2.AnimationId);</span><br><span class="line">  // &#125;</span><br><span class="line">  // this.NotesViewer.SetActiveNotes(target2.Id);</span><br><span class="line">  // this.NotesQueueRight.Dequeue();</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line">  IL_0149:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_014e:  callvirt   instance float32 SoundManager::GetBGMCurrentTime()</span><br><span class="line">  IL_0153:  ldloc.1</span><br><span class="line">  IL_0154:  ldfld      float32 NotesData::EndTime</span><br><span class="line">  IL_0159:  ble.un     IL_0238</span><br><span class="line"></span><br><span class="line">  IL_015e:  ldloc.1</span><br><span class="line">  IL_015f:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_0164:  ldc.i4.5</span><br><span class="line">  IL_0165:  bne.un.s   IL_016e</span><br><span class="line"></span><br><span class="line">  IL_0167:  ldarg.0</span><br><span class="line">  IL_0168:  ldloc.1</span><br><span class="line">  IL_0169:  call       instance void RhysmGame::PlayEventNotes(class NotesData)</span><br><span class="line">  IL_016e:  ldarg.0</span><br><span class="line">  IL_016f:  ldfld      bool RhysmGame::IsAutoPlay</span><br><span class="line">  IL_0174:  brfalse.s  IL_019f</span><br><span class="line"></span><br><span class="line">  IL_0176:  ldloc.1</span><br><span class="line">  IL_0177:  ldfld      valuetype RhysmGame/NotesType NotesData::NotesType</span><br><span class="line">  IL_017c:  ldc.i4.4</span><br><span class="line">  IL_017d:  bne.un.s   IL_019f</span><br><span class="line"></span><br><span class="line">  IL_017f:  call       !0 class SingletonMonoBehaviour`1&lt;class SoundManager&gt;::get_Instance()</span><br><span class="line">  IL_0184:  ldstr      &quot;BattleSE&quot;</span><br><span class="line">  IL_0189:  ldstr      &quot;Temptation&quot;</span><br><span class="line">  IL_018e:  callvirt   instance void SoundManager::PlaySE(string,</span><br><span class="line">                                                          string)</span><br><span class="line">  IL_0193:  ldarg.0</span><br><span class="line">  IL_0194:  ldloc.1</span><br><span class="line">  IL_0195:  ldfld      string NotesData::AnimationId</span><br><span class="line">  IL_019a:  call       instance void RhysmGame::SetActiveTemptation(string)</span><br><span class="line">  IL_019f:  ldarg.0</span><br><span class="line">  IL_01a0:  ldfld      class RhysmGameNotesViewer RhysmGame::NotesViewer</span><br><span class="line">  IL_01a5:  ldloc.1</span><br><span class="line">  IL_01a6:  ldfld      int64 NotesData::Id</span><br><span class="line">  IL_01ab:  ldc.i4.0</span><br><span class="line">  IL_01ac:  callvirt   instance void RhysmGameNotesViewer::SetActiveNotes(int64,</span><br><span class="line">                                                                          bool)</span><br><span class="line">  IL_01b1:  ldarg.0</span><br><span class="line">  IL_01b2:  ldfld      class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt; RhysmGame::NotesQueueRight</span><br><span class="line">  IL_01b7:  callvirt   instance !0 class [netstandard]System.Collections.Generic.Queue`1&lt;class NotesData&gt;::Dequeue()</span><br><span class="line">  IL_01bc:  pop</span><br><span class="line">  IL_01bd:  ret</span><br><span class="line">  //////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">  // ......</span><br><span class="line"></span><br><span class="line">  IL_0238:  ret</span><br><span class="line">&#125; // end of method RhysmGame::CheckTimeLimit</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹é€»è¾‘æ˜¯æ¯”è¾ƒç®€å•çš„, åªéœ€è¦æ·»åŠ å‡ è¡Œ IL ä»£ç å³å¯, ä½†æ˜¯æ”¹å®Œä¹‹åè¿˜æœ‰<strong>ä¸€ä»¶æœ€é‡è¦çš„äº‹æƒ…</strong>, å°±æ˜¯æ›´æ–°è¯¥æ–¹æ³•ä¸‹é¢æ‰€æœ‰çš„åœ°å€, ç¡®ä¿ä¿®æ”¹åæ¯ä¸€è¡Œåœ°å€ä»¥åŠè·³è½¬æŒ‡ä»¤çš„ç›®æ ‡åœ°å€éƒ½æ˜¯æ–°çš„æ­£ç¡®çš„åœ°å€.</p>
<p>è¿™éƒ¨åˆ†è‡ªå·±æ€ä¹ˆé¡ºæ‰‹æ€ä¹ˆæ¥äº†, åæ­£èƒ½æ­£ç¡®æ”¹å¥½å°±è¡Œ, ç›¸å½“äºæ˜¯äººè‚‰ç¼–è¯‘å™¨äº†.</p>
<p>æ”¹å®Œä¹‹åç”¨ ilasm æŠŠ IL æ–‡ä»¶é‡æ–°ç¼–å› dll æ–‡ä»¶, <strong>å¤‡ä»½ä¸€ä¸‹åŸå§‹çš„ Assembly-CSharp.dll</strong>, ç„¶åç”¨æ–°çš„æ›¿æ¢æ‰å®ƒ, ä¹Ÿå¯ä»¥ç”¨ dotPeek å¯¼å‡ºä¸€ä¸‹æ–°çš„ dll æ–‡ä»¶çœ‹çœ‹æºä»£ç é€»è¾‘æ˜¯ä¸æ˜¯ç¬¦åˆé¢„æœŸ.</p>
<p>è‡³æ­¤ä¸€ä¸ªç®€å•çš„ Mod å°±åˆ¶ä½œå®Œæˆäº†, å¯ä»¥è¿›æ¸¸æˆæ„‰å¿«çš„<del>æ¶©æ¶©</del>æ¸¸ç©äº†.</p>
<h2 id="æ±‰åŒ–-Mod"><a href="#æ±‰åŒ–-Mod" class="headerlink" title="æ±‰åŒ– Mod"></a>æ±‰åŒ– Mod</h2><h3 id="å‡†å¤‡å·¥ä½œ-1"><a href="#å‡†å¤‡å·¥ä½œ-1" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>æ—¢ç„¶éƒ½åšäº†åŠŸèƒ½ Mod, æˆ‘å¯»æ€é¡ºä¾¿ä¹Ÿäº†è§£ä¸€ä¸‹æ±‰åŒ– Mod æ€ä¹ˆæ‰“, å› ä¸ºæ„Ÿè§‰åº”è¯¥ä¸éš¾, æ¯•ç«Ÿä¹‹å‰æœ‰ä¸€äº› Unity æ¸¸æˆçš„æ‹†åŒ…ç»éªŒ, æˆ‘çŒœæµ‹å°±æ˜¯æŠŠæ–‡æœ¬èµ„æºæ‹†å‡ºæ¥, ç„¶åæ›¿æ¢æˆæ±‰åŒ–, å†é‡æ–°è£…å›å»å°±è¡Œäº†.</p>
<p>æ‰€ä»¥å…³é”®è§£å†³ä¸¤ä¸ªé—®é¢˜, æ€ä¹ˆå®šä½èµ„æº, æ€ä¹ˆæ‹†/è£…èµ„æº.</p>
<p>å…³äºèµ„æºå®šä½, æœ€ç®€å•çš„æ–¹å¼æ˜¯å…ˆæ‹†åŒ…ç„¶åæœå­—ç¬¦ä¸².</p>
<p>ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½æ¨è <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BlcmZhcmUvQXNzZXRTdHVkaW8=">AssetStudio<i class="fa fa-external-link-alt"></i></span>, ä½†æ˜¯å·²ç»å¾ˆä¹…æ²¡ç»´æŠ¤äº†, å¯¹æ–°ç‰ˆæœ¬ Unity æ”¯æŒä¼¼ä¹æœ‰é—®é¢˜, å¯ä»¥æ¢æˆ<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3poYW5namllcXVhbi9Bc3NldFN0dWRpbw==">æŸ fork ç‰ˆæœ¬<i class="fa fa-external-link-alt"></i></span>è¯•è¯•.</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Fzc2V0UmlwcGVyL0Fzc2V0UmlwcGVy">AssetRipper<i class="fa fa-external-link-alt"></i></span> å¯¼å‡ºèµ„æº, æ–¹ä¾¿æˆ‘ä»¬å®šä½æ–‡æœ¬ä½ç½®.</p>
<p>ç„¶åæ˜¯èµ„æºæ–‡ä»¶çš„ç¼–è¾‘, ç½‘ä¸Šå¾ˆå¤šæ•™ç¨‹è¿˜æ˜¯ç”¨çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1NlcmlvdXNDYWNoZS9VQUJF">UABE<i class="fa fa-external-link-alt"></i></span>, ä½†æ˜¯ä¹Ÿå·²ç»å¾ˆä¹…æ²¡ç»´æŠ¤äº†, æ–°ç‰ˆæœ¬ä¹Ÿæœ‰é—®é¢˜, å¯ä»¥æ¢æˆ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25lc3JhazEvVUFCRUE=">UABEA<i class="fa fa-external-link-alt"></i></span>.</p>
<h3 id="å®šä½èµ„æº"><a href="#å®šä½èµ„æº" class="headerlink" title="å®šä½èµ„æº"></a>å®šä½èµ„æº</h3><p>è¿™é‡Œæˆ‘ä»¬ç”¨ AssetRipper æŠŠæ•´ä¸ªæ¸¸æˆ Data ç›®å½•ä¸‹é¢çš„ä¸œè¥¿å…¨éƒ¨å¯¼å‡º, åŠ è½½ä¸€æ•´ä¸ªæ–‡ä»¶å¤¹ç„¶åå¯¼å‡ºåŸå§‹å†…å®¹ (Export Primary Content).</p>
<p>æ¥ç€åœ¨å¯¼å‡ºçš„å†…å®¹é‡Œé¢ç›´æ¥æœç´¢æ¸¸æˆå†…æ–‡æœ¬, å¯ä»¥å‘ç°ä½äº <code>MonoBehaviour/ScenarioDataSO.json</code> å†…, è¿›å»æŸ¥çœ‹, å¯ä»¥å‘ç°è¯¥èµ„æºä½äºæ–‡ä»¶ <code>sharedassets0.assets</code> é‡Œ.</p>
<p>æ­¤æ—¶å¯ä»¥åœ¨ AssetRipper é‡Œå·²å¯¼å…¥å†…å®¹é‡Œ View ä¸€ä¸‹, è®°å½•ä¸€ä¸‹ <code>ScenarioDataSO</code> çš„ Path ID.</p>
<h3 id="ä¿®æ”¹èµ„æº"><a href="#ä¿®æ”¹èµ„æº" class="headerlink" title="ä¿®æ”¹èµ„æº"></a>ä¿®æ”¹èµ„æº</h3><p>ç”¨ UABEA æ‰“å¼€æ–‡ä»¶ <code>sharedassets0.assets</code>, æ ¹æ®åç§°æˆ–è€… Path ID æ‰¾åˆ° <code>ScenarioDataSO</code>, ç„¶åä½¿ç”¨ <code>Export Dump</code> æŒ‰é’®å¯¼å‡ºè¯¥èµ„æºå†…å®¹.</p>
<p>æ­¤æ—¶æˆ‘ä»¬å°†è¯¥æ–‡ä»¶é‡Œçš„æ–‡æœ¬è¿›è¡Œæ±‰åŒ–, æ±‰åŒ–å®Œæˆå, å†ä½¿ç”¨åŒæ ·çš„æ“ä½œ, æ‰¾åˆ°åˆšåˆšçš„ <code>ScenarioDataSO</code> å¹¶ä½¿ç”¨ <code>Import Dump</code> å¯¼å…¥ä¿®æ”¹åçš„æ–‡ä»¶è¿›è¡Œæ›¿æ¢, <strong>æ›¿æ¢ä¹‹å‰è¯·å¤‡ä»½ä¸€ä»½åŸæ–‡ä»¶</strong>, ç„¶åä¿å­˜å³å®Œæˆäº†èµ„æºçš„é‡æ–°å°è£…. è¿›å…¥æ¸¸æˆå†…æŸ¥çœ‹, å¯ä»¥å‘ç°å·²ç»æ±‰åŒ–æˆåŠŸ.</p>
<p>éœ€è¦æ³¨æ„ä»”ç»†ç”„åˆ«éœ€è¦æ±‰åŒ–çš„æ–‡æœ¬åˆ°åº•åœ¨å“ª, å› ä¸ºå¼€å‘è€…å¯èƒ½ç”¨éè‹±è¯­ä½œä¸ºç¨‹åºéœ€è¦çš„å†…å®¹ (éæ˜¾ç¤ºæ–‡æœ¬), è¿™äº›å½±å“ç¨‹åºçš„æ–‡æœ¬æ˜¯ä¸èƒ½åŠ¨çš„.</p>
<h3 id="ä¿®æ”¹å­—ä½“"><a href="#ä¿®æ”¹å­—ä½“" class="headerlink" title="ä¿®æ”¹å­—ä½“"></a>ä¿®æ”¹å­—ä½“</h3><p>å¦‚æœè¿½æ±‚å®Œç¾, å®Œæˆæ±‰åŒ–å, è¿˜éœ€è¦åŒæ­¥ä¿®æ”¹æ¸¸æˆå†…çš„å­—ä½“, å¦åˆ™æå¤§æ¦‚ç‡å‡ºç°å£å£æ–‡å­¦, æˆ–è€…æ–‡æœ¬å‚å·®ä¸é½çš„ç°è±¡.</p>
<p>è¿˜æ˜¯ç±»ä¼¼çš„, å¯ä»¥ç”¨ UABEA æ‰“å¼€èµ„æºæ–‡ä»¶, å¹¶ä¸”æ ¹æ®ç±»å‹ç­›é€‰å‡º Font æ–‡ä»¶æœ‰å“ªäº›. ç„¶åæˆ‘ä»¬éœ€è¦è¿›è¡Œ Dump, å»ºè®®é€‰æ‹© <code>json</code> æ ¼å¼, ç„¶åå¯ä»¥ç”¨ Python å»è‡ªåŠ¨æ›¿æ¢.</p>
<p>å› ä¸ºå¯¼å‡ºæ—¶, ä¸æ˜¯å•çº¯å¯¼å‡ºä¸€ä¸ªå­—ä½“æ–‡ä»¶, è€Œæ˜¯è¿™ä¸ªå­—ä½“èµ„æºæ–‡ä»¶, æ‰€ä»¥è¿˜åŒ…å«äº†ä¸€äº›åœ¨æ¸¸æˆå†…å¿…éœ€çš„èµ„æºä¿¡æ¯, ä½†æ˜¯æˆ‘ä»¬åªéœ€è¦æ›¿æ¢è¿™ä¸ªèµ„æºæ–‡ä»¶é‡Œçš„å­—ä½“æ–‡ä»¶æ•°æ®å°±è¡Œ.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;m_Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;YUMIN&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_LineSpacing&quot;</span><span class="punctuation">:</span> <span class="number">25.632812</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_DefaultMaterial&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;m_FileID&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;m_PathID&quot;</span><span class="punctuation">:</span> <span class="number">11</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_FontSize&quot;</span><span class="punctuation">:</span> <span class="number">16.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_Texture&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;m_FileID&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;m_PathID&quot;</span><span class="punctuation">:</span> <span class="number">162</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_AsciiStartOffset&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_Tracking&quot;</span><span class="punctuation">:</span> <span class="number">1.0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_CharacterSpacing&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_CharacterPadding&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_ConvertCase&quot;</span><span class="punctuation">:</span> <span class="number">-2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_CharacterRects&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_KerningValues&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_PixelScale&quot;</span><span class="punctuation">:</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_FontData&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>...<span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_Ascent&quot;</span><span class="punctuation">:</span> <span class="number">14.078125</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_Descent&quot;</span><span class="punctuation">:</span> <span class="number">-3.5546875</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_DefaultStyle&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_FontNames&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;Yu Mincho&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_FallbackFonts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Array&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;m_FileID&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;m_PathID&quot;</span><span class="punctuation">:</span> <span class="number">1798</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_FontRenderingMode&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_UseLegacyBoundsCalculation&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;m_ShouldRoundAdvanceValue&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯¼å‡ºåçš„å†…å®¹å¤§æ¦‚æ˜¯è¿™æ ·çš„, è€Œå­—ä½“æ–‡ä»¶ä»¥çº¯äºŒè¿›åˆ¶æ•°æ®çš„æ–¹å¼è¿›è¡Œè®°å½•, åœ¨ <code>m_FontData.Array</code> é‡Œ, ä»¥ <code>int8</code> ç±»å‹æ•°ç»„è¢«å¯¼å‡º.</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠæ–°çš„å­—ä½“æ–‡ä»¶è½¬æ¢æˆç›¸åŒç±»å‹çš„æ•°ç»„æ›¿æ¢æ‰è¿™éƒ¨åˆ†, ç„¶åä¿å­˜ç”¨ UABEA é‡æ–°å¯¼å…¥.</p>
<p>å¯ä»¥ç”¨ä¸€ä¸ªç®€çŸ­çš„ Python è„šæœ¬å®Œæˆ.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">fontdata = Path(<span class="string">&quot;msyh.ttc&quot;</span>).read_bytes()</span><br><span class="line">fontdata_int8 = [(byte - <span class="number">256</span>) <span class="keyword">if</span> byte &gt; <span class="number">127</span> <span class="keyword">else</span> byte <span class="keyword">for</span> byte <span class="keyword">in</span> fontdata]  <span class="comment"># è¦æ¢æˆ int8 çš„èŒƒå›´, é»˜è®¤æƒ…å†µ Python çš„æ•°å­—å¤§å°æ˜¯æ— é™åˆ¶çš„</span></span><br><span class="line"></span><br><span class="line">old_data = json.loads(Path(<span class="string">&quot;YUMIN-sharedassets0.assets-1799.json&quot;</span>).read_text())</span><br><span class="line">old_data[<span class="string">&quot;m_FontData&quot;</span>][<span class="string">&quot;Array&quot;</span>] = fontdata_int8</span><br><span class="line"></span><br><span class="line">Path(<span class="string">&quot;./out-1799.json&quot;</span>).write_text(json.dumps(old_data, indent=<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82NzQzMjYzMA==">Unityå¼•æ“ç±»æ¸¸æˆMODåˆ¶ä½œé€šç”¨æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMWs1NHkxejdvWS8=">[Unity3D-æ¸¸æˆæ±‰åŒ–æ•™ç¨‹]ç¬¬3æœŸï¼šMonoBehaviour<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ3VvYmFveHUvcC8xMjA2MDAyNy5odG1s">Unityæ‰‹æ¸¸æ±‰åŒ–ç¬”è®°â‘¡ï¼šä½¿ç”¨UABEæ›¿æ¢TTFå­—ä½“<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>æ‚å­¦</category>
      </categories>
      <tags>
        <tag>Mod</tag>
        <tag>æ±‰åŒ–</tag>
        <tag>UABEA</tag>
        <tag>Unity</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨ Windows ä¸Šç¼–è¯‘å®‰è£… NUPACK</title>
    <url>//posts/2024/05/11/py-nupack/</url>
    <content><![CDATA[<p>ä¹‹å‰é¡¹ç›®é‡Œç”¨åˆ°äº† <span class="exturl" data-url="aHR0cHM6Ly9udXBhY2sub3JnLw==">NUPACK<i class="fa fa-external-link-alt"></i></span> è¿™ä¸ªè½¯ä»¶, ç”¨æ¥åšå¼•ç‰©äºŒçº§ç»“æ„é¢„æµ‹, ä½†æ˜¯å°±<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm51cGFjay5vcmcvc3RhcnQv">å®˜æ–¹æ–‡æ¡£<i class="fa fa-external-link-alt"></i></span>ä¸Šæ¥çœ‹, åªæä¾›äº† Linux ä¸‹çš„ Python åº“ä»¥åŠæºç , å¹¶ä¸”å°±ç®—æ˜¯ Windows ä¹Ÿæ˜¯ç›´æ¥æ¨èçš„ WSL2 å­ç³»ç»Ÿ. è™½ç„¶é¡¹ç›®éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šè¿è¡Œç›´æ¥å°±æ˜¯ Linux ç¯å¢ƒ, ä½†æ˜¯å¯Œæœ‰æŠ˜è…¾ç²¾ç¥çš„å’±è¿˜æ˜¯å†³å®šåœ¨ Windows ä¸Šå°è¯•ç¼–è¯‘å®‰è£…ä¸€ä¸‹, å› æ­¤æœ‰äº†æœ¬æ–‡è®°å½•å…¨éƒ¨çš„ç¼–è¯‘è¸©å‘è¿‡ç¨‹.</p>
<p>å¤ªé•¿ä¸çœ‹: ç›´æ¥å‰å¾€ä»“åº“ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL251cGFjay13aW4=">nupack-win<i class="fa fa-external-link-alt"></i></span> ä¸‹è½½å®‰è£…åŒ….</p>
<span id="more"></span>

<h2 id="é¡¹ç›®æ¦‚å†µ"><a href="#é¡¹ç›®æ¦‚å†µ" class="headerlink" title="é¡¹ç›®æ¦‚å†µ"></a>é¡¹ç›®æ¦‚å†µ</h2><p>è¿™æ¬¡ä½¿ç”¨çš„æ˜¯ <code>v4.0.1.8</code> çš„ NUPACK æºç . é¡¹ç›®æ˜¯åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9jbWFrZS5vcmcv">CMake<i class="fa fa-external-link-alt"></i></span> çš„, å¹¶ä¸”ä½¿ç”¨äº† <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC92Y3BrZw==">vcpkg<i class="fa fa-external-link-alt"></i></span> ä½œä¸ºåŒ…ç®¡ç†å™¨, åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœ‰ Mac/Linux ç¯å¢ƒä¸‹çš„æºç å®‰è£…æ­¥éª¤ <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm51cGFjay5vcmcvc3RhcnQvI3NvdXJjZS1pbnN0YWxsYXRpb24=">Source installation<i class="fa fa-external-link-alt"></i></span> å¯ä¾›å‚è€ƒ.</p>
<p>ç”±äº CMake å’Œ vcpkg éƒ½æ˜¯æ¯”è¾ƒå¥½è·¨å¹³å°çš„, å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨ Windows ä¸Šå¤ç°å®ƒçš„è¿™äº›æ­¥éª¤å°±å¤§åŠŸå‘Šæˆ.<del>äº‹å®æ˜¯è¢«ç¼–è¯‘ç¯å¢ƒæš´æ‰“.</del></p>
<h2 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h2><p>é¦–å…ˆæ˜¯å‡†å¤‡ Windows ä¸Šçš„ MinGW + Clang ç¼–è¯‘ç¯å¢ƒ, è¿™é‡Œå‚è€ƒå¾®è½¯å®˜æ–¹çš„ vcpkg æ–‡æ¡£ <span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL3ZjcGtnL3VzZXJzL3BsYXRmb3Jtcy9taW5ndw==">Mingw-w64<i class="fa fa-external-link-alt"></i></span>, ä»¥åŠ <span class="exturl" data-url="aHR0cHM6Ly93d3cubXN5czIub3JnLw==">MSYS2<i class="fa fa-external-link-alt"></i></span> çš„å®‰è£…æ­¥éª¤.</p>
<p>ä¸åŒçš„åœ°æ–¹åœ¨äº, æˆ‘ä»¬éœ€è¦åŒæ—¶å®‰è£… Clang å’Œ GCC ä¸¤å¥—å·¥å…·é“¾, å› ä¸ºéƒ¨åˆ†åº“å¯èƒ½åœ¨ Clang ä¸‹ç¼–è¯‘å¤±è´¥, ä½†æ˜¯ GCC å¯ä»¥.</p>
<p>å®‰è£…å¥½ MSYS2 ä¹‹å, åˆ†åˆ«å¯åŠ¨ <code>MSYS2 CLANG64</code> å’Œ <code>MSYS2 MINGW</code> ä¸¤ä¸ªç»ˆç«¯, ç„¶åç”¨ç”¨å‘½ä»¤åˆ†åˆ«å®‰è£…å¯¹åº”çš„å·¥å…·é“¾ <span class="exturl" data-url="aHR0cHM6Ly9wYWNrYWdlcy5tc3lzMi5vcmcvZ3JvdXBzL21pbmd3LXc2NC1jbGFuZy14ODZfNjQtdG9vbGNoYWlu">mingw-w64-clang-x86_64-toolchain<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9wYWNrYWdlcy5tc3lzMi5vcmcvZ3JvdXBzL21pbmd3LXc2NC14ODZfNjQtdG9vbGNoYWlu">mingw-w64-x86_64-toolchain<i class="fa fa-external-link-alt"></i></span>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman -S mingw-w64-clang-x86_64-toolchain</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman -S mingw-w64-x86_64-toolchain</span><br></pre></td></tr></table></figure>

<p>å®Œäº‹ä¹‹åå¯ä»¥çœ‹çœ‹ <code>clang</code> å’Œ <code>gcc</code> çš„ç‰ˆæœ¬.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ clang --version</span><br><span class="line">clang version 17.0.6</span><br><span class="line">Target: x86_64-w64-windows-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">InstalledDir: D:/Program Files/msys64/clang64/bin</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gcc --version</span><br><span class="line">gcc.exe (Rev3, Built by MSYS2 project) 13.2.0</span><br><span class="line">Copyright (C) 2023 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure>

<p>å¦‚æ— ç‰¹æ®Šè¯´æ˜, åç»­æ­¥éª¤é‡Œçš„å‘½ä»¤é»˜è®¤éƒ½æ˜¯åœ¨ <code>CLANG64</code> ç¯å¢ƒé‡Œæ‰§è¡Œ.</p>
<h2 id="å®‰è£…ä¾èµ–åº“"><a href="#å®‰è£…ä¾èµ–åº“" class="headerlink" title="å®‰è£…ä¾èµ–åº“"></a>å®‰è£…ä¾èµ–åº“</h2><p>è§£å‹ <code>nupack-4.0.1.8.zip</code>, å¯¼èˆªè¿›å…¥ <code>source</code> ç›®å½•.</p>
<p>å…¨ç¯‡æœ€å›°éš¾çš„åœ°æ–¹å½“å±å®‰è£…ä¾èµ–åº“, æˆ‘ä»¬éµå¾ªä¸€ä¸ªåŸåˆ™, é‚£å°±æ˜¯èƒ½ç”¨åŸé¡¹ç›® vcpkg ç‰ˆæœ¬é‡Œçš„å†…å®¹å°±å°½é‡ç”¨åŸé¡¹ç›®çš„, å‡ºé—®é¢˜äº†å†æ¢æˆæ–°çš„.</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¿˜è¦å…ˆ clone ä¸€ä¸ªæœ€æ–°çš„ vcpkg å¤‡ç”¨.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:microsoft/vcpkg.git</span><br><span class="line">Cloning into <span class="string">&#x27;vcpkg&#x27;</span>...</span><br><span class="line">remote: Enumerating objects: 233259, <span class="keyword">done</span>.</span><br><span class="line">remote: Counting objects: 100% (12697/12697), <span class="keyword">done</span>.</span><br><span class="line">remote: Compressing objects: 100% (969/969), <span class="keyword">done</span>.</span><br><span class="line">remote: Total 233259 (delta 12286), reused 11775 (delta 11728), pack-reused 220562</span><br><span class="line">Receiving objects: 100% (233259/233259), 69.10 MiB | 4.18 MiB/s, <span class="keyword">done</span>.</span><br><span class="line">Resolving deltas: 100% (155206/155206), <span class="keyword">done</span>.</span><br><span class="line">Updating files: 100% (11336/11336), <span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> vcpkg &amp;&amp; git show-ref --heads</span><br><span class="line">a1212c93cabaa9c5c36c1ffdb4bddd59fdf31e43 refs/heads/master</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå¾—æŠŠåŸé¡¹ç›® <code>external/vcpkg</code> ä¸‹çš„ <code>scripts</code> æ–‡ä»¶å¤¹ä¸€æ•´ä¸ªæ›¿æ¢æ‰, å› ä¸ºæ—§ç‰ˆæœ¬æœ‰äº›æ“ä½œå®Œæˆä¸äº†, ä¸”ä¸‹è½½çš„ç¼–è¯‘å·¥å…·ä¸æ˜¯æœ€æ–°çš„.</p>
<p>ç„¶åæŒ‰æ­£å¸¸æ­¥éª¤è¿è¡Œ <code>bootstrap-vcpkg.sh</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./external/vcpkg/bootstrap-vcpkg.sh</span><br><span class="line">Downloading https://github.com/microsoft/vcpkg-tool/releases/download/2024-04-23/vcpkg.exe -&gt; D:\Projects\VsProjects\nupack-4.0.1.8\<span class="built_in">source</span>\external\vcpkg\vcpkg.exe (using IE proxy: 127.0.0.1:10809)... <span class="keyword">done</span>.</span><br><span class="line">Validating signature... <span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">vcpkg package management program version 2024-04-23-d6945642ee5c3076addd1a42c331bbf4cfc97457</span><br><span class="line"></span><br><span class="line">See LICENSE.txt <span class="keyword">for</span> license information.</span><br><span class="line">Telemetry</span><br><span class="line">---------</span><br><span class="line">vcpkg collects usage data <span class="keyword">in</span> order to <span class="built_in">help</span> us improve your experience.</span><br><span class="line">The data collected by Microsoft is anonymous.</span><br><span class="line">You can opt-out of telemetry by re-running the bootstrap-vcpkg script with -disableMetrics,</span><br><span class="line">passing --disable-metrics to vcpkg on the <span class="built_in">command</span> line,</span><br><span class="line">or by setting the VCPKG_DISABLE_METRICS environment variable.</span><br><span class="line"></span><br><span class="line">Read more about vcpkg telemetry at docs/about/privacy.md</span><br></pre></td></tr></table></figure>

<p>å®‰è£…ä¹‹å‰è®°å¾—å…ˆåœ¨ç»ˆç«¯é‡Œè®¾ç½®ä¸€ä¸‹é»˜è®¤çš„ triplet.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> VCPKG_DEFAULT_TRIPLET=x64-mingw-dynamic</span><br><span class="line"><span class="built_in">export</span> VCPKG_DEFAULT_HOST_TRIPLET=x64-mingw-dynamic</span><br></pre></td></tr></table></figure>

<p>ç»“åˆå®˜æ–¹æ•™ç¨‹é‡Œçš„æ­¥éª¤ä»¥åŠ <code>cmake/Libraries.cmake</code> å’Œ <code>cmake/BuildCXX.cmake</code> é‡Œçš„å†…å®¹, æ‰€æœ‰è¦å®‰è£…çš„åŒ…å¤§æ¦‚å¯ä»¥åˆ†æˆä¸‹é¢å‡ ç±».</p>
<ol>
<li><p>éœ€è¦å…ˆæ›´æ–° port ç‰ˆæœ¬</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openblas yaml-cpp fmt spdlog</span><br></pre></td></tr></table></figure>

<p> è¿™äº›åº“ç”±äºæ—§ç‰ˆæœ¬æœ‰ä¸€äº› bug, æˆ–è€…ç”±äºæŸäº›ç¥ç§˜é—®é¢˜å¯¼è‡´åœ¨ MinGW ç¯å¢ƒä¸‹å®‰è£…å¤±è´¥, ä½†æ˜¯é€šè¿‡æŠŠ port æ¢æˆæœ€æ–°çš„å°±èƒ½æ­£å¸¸å®‰è£….</p>
<ul>
<li><code>openblas</code>: è¢«ä½œä¸ºä¾èµ–åŒ…å®‰è£…, ä½†æ˜¯è²Œä¼¼å­˜åœ¨æŸäº›ä¸æ­£ç¡®çš„ä¾èµ–å…³ç³», æ¢æˆæ–°ç‰ˆæœ¬åèƒ½æ­£å¸¸å®‰è£….</li>
<li><code>yaml-cpp</code>: æœ€åé“¾æ¥çš„æ—¶å€™æ‰¾ä¸åˆ°æŸä¸ªç¬¦å·, æ–°ç‰ˆæœ¬å·²ç»ä¿®å¤äº†ç¬¦å·æ²¡å¯¼å‡ºçš„é—®é¢˜, è¯¦è§ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2piZWRlci95YW1sLWNwcC9pc3N1ZXMvMTAyNg==">#1026<i class="fa fa-external-link-alt"></i></span>.</li>
<li><code>fmt</code>: æœ€åç¼–è¯‘çš„æ—¶å€™ä¼šæŠ¥é”™æ‰¾ä¸åˆ°æŸä¸ªå¤´æ–‡ä»¶, æ–°ç‰ˆæœ¬ä¿®å¤äº†è¿™ä¸ªé—®é¢˜, è¯¦è§ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZtdGxpYi9mbXQvcHVsbC8zNjYz">#3663<i class="fa fa-external-link-alt"></i></span>.</li>
<li><code>spdlog</code>: ç”±äºä¾èµ– <code>fmt</code> åº“, æ‰€ä»¥å¿…é¡»å’Œ <code>fmt</code> ä¸€èµ·æ›´æ–°.</li>
</ul>
</li>
<li><p>ç›´æ¥è£…, åœ¨ <code>CLANG64</code> ä¸‹å°±èƒ½ä¸€æ­¥åˆ°ä½.</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">taskflow libsimdpp blas lapack armadillo nlohmann-json magic-enum protobuf</span><br></pre></td></tr></table></figure></li>
<li><p>éœ€è¦ GCC ç¯å¢ƒå®‰è£…, åœ¨ <code>MINGW64</code> ä¸‹ä¸€æ­¥åˆ°ä½.</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">boost-core boost-preprocessor boost-functional boost-container boost-variant boost-iterator boost-align boost-sort boost-algorithm boost-serialization boost-multi-index</span><br></pre></td></tr></table></figure></li>
<li><p>ç‰¹æ®Šæƒ…å†µ</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gecode tbb</span><br></pre></td></tr></table></figure>

<p> è¿™ä¸¤ä¸ªåº“åœ¨ MinGW ç¯å¢ƒç¼–è¯‘çš„æ—¶å€™å­˜åœ¨ä¸€äº›é…ç½®é—®é¢˜, ä¼šå¯¼è‡´å®‰è£…çš„æ—¶å€™å‡ºç°ä¸€äº›è¯­æ³•å’Œé“¾æ¥é”™è¯¯, å› æ­¤å•ç‹¬ fork äº†ä»“åº“å¹¶ä¿®æ”¹äº†ä¸€äº›æŠ¥é”™çš„é…ç½®å’Œä»£ç .</p>
<ul>
<li><code>gecode</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL2dlY29kZS9jb21taXQvYjc3ZDIyZTRjNmIzYjY0NDllNGUzN2NiMWJlMmMxNmIyNjlmNGQzOQ==">å¢åŠ äº† ws2_32 çš„é“¾æ¥é€‰é¡¹<i class="fa fa-external-link-alt"></i></span>.</li>
<li><code>tbb</code>: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL29uZVRCQi9jb21taXQvNThhMDNiMDVlNjZhZTNhNGY2OWYwMmVmMjQ0OGI3ZDJiMTcyMmFjNQ==">å»æ‰äº†å¯¹äºå® __MINGW32__ çš„å‰åä¸ä¸€è‡´åˆ¤æ–­<i class="fa fa-external-link-alt"></i></span>.</li>
</ul>
<p> ç„¶åæŠŠå¯¹åº”çš„ port æ–‡ä»¶æ”¹æˆä¿®æ”¹åè‡ªå·±çš„ä»“åº“åœ°å€, å°±èƒ½å®‰è£…æˆåŠŸ.</p>
</li>
</ol>
<h2 id="è¿è¡Œ-CMake"><a href="#è¿è¡Œ-CMake" class="headerlink" title="è¿è¡Œ CMake"></a>è¿è¡Œ CMake</h2><p>åœ¨å‚è€ƒ NUPACK å®˜æ–¹æºç å®‰è£…æ•™ç¨‹çš„åŸºç¡€ä¸Š, ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œ CMake. è¿è¡Œå‰ç¡®ä¿ç›®å½•è¢«æ¸…ç©º.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ -DVCPKG_TARGET_TRIPLET=x64-mingw-dynamic -DREBIND_PYTHON_INCLUDE=<span class="string">&quot;/d/CondaEnvs/py39/include&quot;</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¯”è¾ƒå…³é”®çš„æ˜¯è¦æŒ‡å®š <code>-DVCPKG_TARGET_TRIPLET</code>, å…¶ä½™é€‰é¡¹åŸºæœ¬ç±»ä¼¼.</p>
<p>ç„¶åéœ€è¦ç›´æ¥æŒ‡å®š <code>-DREBIND_PYTHON_INCLUDE</code>, è²Œä¼¼ç”±äºå¹³å°è·¯å¾„æ ¼å¼å·®å¼‚, å¯¼è‡´æ— æ³•æ­£ç¡®åœ°è‡ªåŠ¨æ¢æµ‹ Python å¤´æ–‡ä»¶çš„ä½ç½®.</p>
<p>åœ¨è¿è¡Œä¹‹å‰, è¿˜éœ€è¦è§£å†³ä¸‹é¢è¿™äº›é—®é¢˜.</p>
<h3 id="è§£å†³åº“æŸ¥æ‰¾é”™è¯¯"><a href="#è§£å†³åº“æŸ¥æ‰¾é”™è¯¯" class="headerlink" title="è§£å†³åº“æŸ¥æ‰¾é”™è¯¯"></a>è§£å†³åº“æŸ¥æ‰¾é”™è¯¯</h3><p>ä¹Ÿä¸çŸ¥é“æ˜¯å“ªçš„é…ç½®é—®é¢˜, åœ¨ Windows ä¸‹ç”Ÿæˆçš„ lib æ–‡ä»¶åç¼€éƒ½æ˜¯ <code>.dll.a</code>, ä½†æ˜¯é…ç½®æ–‡ä»¶ä½¿ç”¨ <code>find_library</code> æŒ‰è·¯å¾„ç›´æ¥æŸ¥æ‰¾çš„æ—¶å€™æ‰¾ä¸åˆ°, åªèƒ½æŸ¥æ‰¾ <code>.a</code> æˆ–è€… <code>.so</code> åç¼€çš„, å› æ­¤éœ€è¦å» <code>cmake/Libraries.cmake</code> é‡ŒæŠŠåº“åéƒ½æ”¹ä¸€ä¸‹, è¡¥ä¸€ä¸ª <code>.dll</code> è¿›å».</p>
<p>ç±»ä¼¼è¿™æ ·:</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> LAPACK_LIBRARIES)</span><br><span class="line">    <span class="comment"># find_library(LAPACK_LIBRARIES lapack)</span></span><br><span class="line">    <span class="keyword">find_library</span>(LAPACK_LIBRARIES lapack.dll)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ <code>lapack</code> å’Œ <code>blas</code> è¿™ä¸¤ä¸ªåº“ç”¨åˆ°äº† <code>find_package</code>, ä¸”ç”±äºæŒ‰æœ¬åœ°è·¯å¾„ç›´æ¥æŸ¥æ‰¾, å› æ­¤è¿˜æ˜¯éœ€è¦å» <code>external/vcpkg/installed/x64-mingw-dynamic/lib</code> ä¸‹é¢æ‰‹åŠ¨æ”¹ä¸€ä¸‹åº“æ–‡ä»¶å, å»ºè®®ç›´æ¥å¤åˆ¶ä¸€ä»½, æŠŠå¤åˆ¶çš„æ–‡ä»¶æ”¹ä¸ªåç¼€.</p>
<ul>
<li><code>liblapack.dll.a</code> -&gt; <code>liblapack.a</code></li>
<li><code>libopenblas.dll.a</code> -&gt; <code>libopenblas.a</code></li>
</ul>
<h3 id="è§£å†³-Python-åŒ…å«ç›®å½•é”™è¯¯"><a href="#è§£å†³-Python-åŒ…å«ç›®å½•é”™è¯¯" class="headerlink" title="è§£å†³ Python åŒ…å«ç›®å½•é”™è¯¯"></a>è§£å†³ Python åŒ…å«ç›®å½•é”™è¯¯</h3><p>ç›´æ¥ä½¿ç”¨è‡ªå¸¦çš„ <code>-DREBIND_PYTHON</code> å’Œ <code>-DREBIND_PYTHON_INCLUDE</code> å‚æ•°æ˜¯å­˜åœ¨é—®é¢˜çš„, ä¸€æ˜¯ Windows ä¸‹è·¯å¾„æ ¼å¼ä¸é€‚é…, äºŒæ˜¯é¡¹ç›®æœ¬èº« <code>external/rebind/CMakeLists.txt:12</code> é™„è¿‘çš„ä»£ç å°±å†™çš„æœ‰é—®é¢˜, æ‰€ä»¥æ‰‹åŠ¨æ”¹æ”¹.</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># if ($&#123;REBIND_PYTHON_INCLUDE&#125;) # è¿™é‡Œçš„åŸæœ¬çš„åˆ¤æ–­å­˜åœ¨é—®é¢˜, æ°¸è¿œæ˜¯å‡</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">NOT</span> <span class="string">&quot;$&#123;REBIND_PYTHON_INCLUDE&#125;&quot;</span> <span class="keyword">STREQUAL</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">message</span>(<span class="string">&quot;-- Using specified Python include&quot;</span>)</span><br><span class="line">    <span class="keyword">set</span>(python_include <span class="variable">$&#123;REBIND_PYTHON_INCLUDE&#125;</span>) <span class="comment"># ä»¿ç…§ else éƒ¨åˆ†å¯¹å˜é‡ python_include èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">set_property</span>(GLOBAL PROPERTY rebind_python_include <span class="variable">$&#123;REBIND_PYTHON_INCLUDE&#125;</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    <span class="keyword">execute_process</span>(</span><br><span class="line">        <span class="keyword">COMMAND</span> <span class="variable">$&#123;REBIND_PYTHON&#125;</span> -c <span class="string">&quot;import sys, sysconfig; sys.stdout.write(sysconfig.get_paths()[&#x27;include&#x27;])&quot;</span></span><br><span class="line">        RESULT_VARIABLE python_stat OUTPUT_VARIABLE python_include</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (python_stat)</span><br><span class="line">        <span class="keyword">message</span>(FATAL_ERROR <span class="string">&quot;Failed to deduce include directory from &#x27;$&#123;REBIND_PYTHON&#125;&#x27; executable.\nMaybe specify REBIND_PYTHON_INCLUDE directly.&quot;</span>)</span><br><span class="line">    <span class="keyword">endif</span>()</span><br><span class="line">    <span class="keyword">message</span>(<span class="string">&quot;-- Using Python include directory deduced from REBIND_PYTHON=$&#123;REBIND_PYTHON&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">set_property</span>(GLOBAL PROPERTY rebind_python_include <span class="variable">$&#123;python_include&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;-- Using Python include directory $&#123;python_include&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ä¹‹åå†ç¼–è¯‘å°±ä¸ä¼šæŠ¥ <code>Python.h</code> å¤´æ–‡ä»¶æ‰¾ä¸åˆ°è¿™æ ·çš„é”™è¯¯äº†.</p>
<h3 id="è§£å†³-yaml-cpp-çš„è­¦å‘Š"><a href="#è§£å†³-yaml-cpp-çš„è­¦å‘Š" class="headerlink" title="è§£å†³ yaml-cpp çš„è­¦å‘Š"></a>è§£å†³ yaml-cpp çš„è­¦å‘Š</h3><p>è¿è¡Œä¹‹åå¯èƒ½ä¼šæŠ¥å…³äº <code>yaml-cpp</code> çš„è­¦å‘Š:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CMake Warning (dev) at cmake/BuildCXX.cmake:133 (target_link_libraries):</span><br><span class="line">  The library that is being linked to, yaml-cpp, is marked as being</span><br><span class="line">  deprecated by the owner.  The message provided by the developer is:</span><br><span class="line"></span><br><span class="line">  The target yaml-cpp is deprecated and will be removed in version 0.10.0.</span><br><span class="line">  Use the yaml-cpp::yaml-cpp target instead.</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯æ–°ç‰ˆæœ¬ <code>yaml-cpp</code> çš„å¼€å‘è€…è­¦å‘Š, å¯ä»¥é€‰æ‹©å» <code>cmake/BuildCXX.cmake:133</code> é‡Œé¢æŒ‰ç…§æç¤ºæŠŠ <code>yaml-cpp</code> æ”¹æˆ <code>yaml-cpp::yaml-cpp</code> å†é‡æ–°è¿è¡Œå‘½ä»¤.</p>
<h2 id="ç”Ÿæˆç›®æ ‡æ–‡ä»¶"><a href="#ç”Ÿæˆç›®æ ‡æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆç›®æ ‡æ–‡ä»¶"></a>ç”Ÿæˆç›®æ ‡æ–‡ä»¶</h2><p>å‚è€ƒæ•™ç¨‹çš„åŸºç¡€ä¸Š, ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆç›®æ ‡æ–‡ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmake --build . --target nupack-python --verbose -j8</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>-j8</code> å¯ä»¥è‡ªè¡Œä¿®æ”¹, ç”¨æ¥å¤šçº¿ç¨‹åŠ å¿«ç¼–è¯‘é€Ÿåº¦, å¤ªé«˜å¯èƒ½ä¼šçˆ†å†…å­˜.</p>
<h3 id="è§£å†³å‚æ•°è·¯å¾„é”™è¯¯"><a href="#è§£å†³å‚æ•°è·¯å¾„é”™è¯¯" class="headerlink" title="è§£å†³å‚æ•°è·¯å¾„é”™è¯¯"></a>è§£å†³å‚æ•°è·¯å¾„é”™è¯¯</h3><p>ä¸å‡ºæ„å¤–ä¼šå¾—åˆ°ä¸‹é¢çš„æŠ¥é”™.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ 44%] Running cpp protocol buffer compiler on proto/public.proto</span><br><span class="line">/d/Projects/VsProjects/nupack-4.0.1.8/source/external/vcpkg/installed/x64-mingw-dynamic/tools/protobuf/protoc.exe --cpp_out :/d/Projects/VsProjects/nupack-4.0.1.8/source/build-py39/include/nupack/ -I /d/Projects/VsProjects/nupack-4.0.1.8/source /d/Projects/VsProjects/nupack-4.0.1.8/source/proto/public.proto</span><br><span class="line">/d/Projects/VsProjects/nupack-4.0.1.8/source/build-py39/include/nupack/: No such file or directory</span><br><span class="line">make[3]: *** [CMakeFiles/libnupack.dir/build.make:75: include/nupack/proto/public.pb.h] Error 1</span><br><span class="line">make[3]: Leaving directory &#x27;/d/Projects/VsProjects/nupack-4.0.1.8/source/build-py39&#x27;</span><br><span class="line">make[2]: *** [CMakeFiles/Makefile2:128: CMakeFiles/libnupack.dir/all] Error 2</span><br><span class="line">make[2]: Leaving directory &#x27;/d/Projects/VsProjects/nupack-4.0.1.8/source/build-py39&#x27;</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:280: CMakeFiles/nupack-python.dir/rule] Error 2</span><br><span class="line">make[1]: Leaving directory &#x27;/d/Projects/VsProjects/nupack-4.0.1.8/source/build-py39&#x27;</span><br><span class="line">make: *** [Makefile:234: nupack-python] Error 2</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ç”±äºå…¶ä¸­ä¸€æ¡å‘½ä»¤ä¸­çš„å‚æ•° <code>--cpp_out</code> åé¢è·Ÿçš„è·¯å¾„å‰é¢å¤šäº†ä¸ªå†’å· <code>:</code>, ä¹Ÿä¸çŸ¥é“åœ¨å“ªé…ç½®çš„.</p>
<p>æ‰€ä»¥åœ¨è¿è¡Œå‘½ä»¤ä¹‹å‰, è¿˜å¾—å…ˆæŠŠä¸Šä¸€æ­¥ç”Ÿæˆçš„ç”Ÿæˆæ–‡ä»¶é‡Œçš„å†…å®¹æ”¹ä¸€ä¸‹, ä½äº <code>CMakeFiles/libnupack.dir/build.make:75</code>.</p>
<p>è¿™ä¸€æ­¥æ¯æ¬¡é‡æ–°ç”Ÿæˆçš„æ—¶å€™éƒ½è¦æ‰‹åŠ¨æ”¹<del>çº¯çº¯æŠ˜ç£¨</del>.</p>
<h3 id="è§£å†³-format-security-è­¦å‘Š"><a href="#è§£å†³-format-security-è­¦å‘Š" class="headerlink" title="è§£å†³ format-security è­¦å‘Š"></a>è§£å†³ format-security è­¦å‘Š</h3><p>ç¼–è¯‘é€”ä¸­ä¼šæœ‰ä¸€ä¸ªå…³äºæ ¼å¼å­—ç¬¦ä¸²çš„ä¸å®‰å…¨è­¦å‘Š.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">external/backward-cpp/backward.hpp:3646:14: warning:</span><br><span class="line">      format string is not a string literal (potentially insecure) [-Wformat-security]</span><br><span class="line"> 3646 |       printf(lpMsgBuf);</span><br><span class="line">      |              ^~~~~~~~</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥æ ¹æ®æç¤ºä¿¡æ¯æ”¹æˆ <code>printf(&quot;%s&quot;, lpMsgBuf)</code>.</p>
<h3 id="è§£å†³-simdpp-åŒ…å«ç›®å½•é”™è¯¯"><a href="#è§£å†³-simdpp-åŒ…å«ç›®å½•é”™è¯¯" class="headerlink" title="è§£å†³ simdpp åŒ…å«ç›®å½•é”™è¯¯"></a>è§£å†³ simdpp åŒ…å«ç›®å½•é”™è¯¯</h3><p>é‡æ–°ç”Ÿæˆä¼šæŠ¥é”™æ‰¾ä¸åˆ° <code>simdpp</code> ç›¸å…³çš„å¤´æ–‡ä»¶.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">include/nupack/math/SIMD.h:19:14: fatal error:</span><br><span class="line">      &#x27;simdpp/simd.h&#x27; file not found</span><br><span class="line">   19 | #    include &lt;simdpp/simd.h&gt;</span><br><span class="line">      |              ^~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯åŸé¡¹ç›®è‡ªå·±åŠ çš„ä¸€ä¸ªç§æœ‰ port, ä¼°è®¡æ˜¯æ²¡é…ç½®å¥½, æ‰€ä»¥æˆ‘ä»¬ç›´æ¥åœ¨é¡¶å±‚ <code>CMakeLists.txt</code> é‡Œç”¨ <code>include_directories</code> è‡ªå·±åŠ è¿›å», æ¯”å¦‚è¿™æ ·.</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">    <span class="string">&quot;/d/Projects/VsProjects/nupack-4.0.1.8/source/external/vcpkg/installed/x64-mingw-dynamic/include/libsimdpp-2.1&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³ç±»å‹é”™è¯¯"><a href="#è§£å†³ç±»å‹é”™è¯¯" class="headerlink" title="è§£å†³ç±»å‹é”™è¯¯"></a>è§£å†³ç±»å‹é”™è¯¯</h3><p>é‡æ–°ç”Ÿæˆä¼šæŠ¥é”™æœ‰ä¸€å¤„ç±»å‹ä¸å…¼å®¹.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">external/rebind/source/Module.cc:106:17: error:</span><br><span class="line">      assigning to &#x27;hashfunc&#x27; (aka &#x27;long long (*)(_object *)&#x27;) from incompatible type</span><br><span class="line">      &#x27;long (PyObject *) noexcept&#x27; (aka &#x27;long (_object *) noexcept&#x27;): different return type</span><br><span class="line">      (&#x27;Py_hash_t&#x27; (aka &#x27;long long&#x27;) vs &#x27;long&#x27;)</span><br><span class="line">  106 |     o.tp_hash = type_index_hash;</span><br><span class="line">      |                 ^~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸º Windows ä¸‹ <code>long long</code> å’Œ <code>long</code> ç±»å‹ä½é•¿ä¸ä¸€è‡´å¯¼è‡´çš„, æ‰€ä»¥ç›´æ¥å»æºç  <code>external/rebind/source/Module.cc:80</code> å¤„æŠŠè¿”å›å€¼ç±»å‹ <code>long</code> æ”¹æˆ <code>long long</code>.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">type_index_hash</span><span class="params">(PyObject *o)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">long</span> <span class="type">long</span>&gt;(<span class="built_in">cast_object</span>&lt;TypeIndex&gt;(o).<span class="built_in">hash_code</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³ç¬¦å·é‡å®šä¹‰é”™è¯¯"><a href="#è§£å†³ç¬¦å·é‡å®šä¹‰é”™è¯¯" class="headerlink" title="è§£å†³ç¬¦å·é‡å®šä¹‰é”™è¯¯"></a>è§£å†³ç¬¦å·é‡å®šä¹‰é”™è¯¯</h3><p>åœ¨æœ€åçš„é“¾æ¥ç¯èŠ‚, è¿˜ä¼šå‡ºç°ç¬¦å·é‡å®šä¹‰é”™è¯¯.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ld.lld: error: duplicate symbol: rebind::Holder&lt;rebind::Var&gt;::type</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Python.cc.obj</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Module.cc.obj</span><br><span class="line"></span><br><span class="line">ld.lld: error: duplicate symbol: rebind::Holder&lt;rebind::TypeIndex&gt;::type</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Python.cc.obj</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Module.cc.obj</span><br><span class="line"></span><br><span class="line">ld.lld: error: duplicate symbol: rebind::Holder&lt;rebind::Function&gt;::type</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Python.cc.obj</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Module.cc.obj</span><br><span class="line"></span><br><span class="line">ld.lld: error: duplicate symbol: rebind::Holder&lt;rebind::ArrayBuffer&gt;::type</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Module.cc.obj</span><br><span class="line">&gt;&gt;&gt; defined at CMakeFiles/nupack-python.dir/external/rebind/source/Cast.cc.obj</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡è¿™ä¸ªæˆ‘çœ‹äº†ä¸€ä¸‹æºç , å¤§æ¦‚ç‡æ˜¯å› ä¸ºæ¨¡æ¿çš„å®ä¾‹åŒ–å¯¼è‡´çš„é‡å®šä¹‰. ä½†æ˜¯ç”±äºå¯¹ c++ è¯­æ³•ä¹Ÿä¸æ˜¯å¾ˆæ‡‚, è¯•äº†å¾ˆä¹…æ²¡æ”¹å‡ºæ¥, æ‰€ä»¥æš´åŠ›è§£å†³, ä¸‰åˆä¸€å¤§æ³•, æŠŠæ¶‰åŠé‡å®šä¹‰çš„å‡ ä¸ªæ¨¡å—çš„æºç åˆå¹¶åˆ°ä¸€ä»½æºç é‡Œ, åªç”Ÿæˆä¸€ä¸ª <code>obj</code> æ–‡ä»¶, åœ¨è¿™ä¸€ä»½æ–‡ä»¶é‡Œå°±ä¸ä¼šç”±äºåå¤å®ä¾‹åŒ–æ¨¡æ¿å¯¼è‡´é‡å®šä¹‰äº†.</p>
<p>ç›´æ¥æŠŠ:</p>
<ul>
<li><code>external/rebind/source/Cast.cc</code></li>
<li><code>external/rebind/source/Python.cc</code></li>
<li><code>external/rebind/source/Module.cc</code> (æ³¨æ„ä¹‹å‰ä¿®æ”¹è¿‡ä¸€æ¬¡)</li>
</ul>
<p>å¤åˆ¶åˆ°ä¸€ä»½æ–°çš„ <code>external/rebind/source/Cast_Python_Module.cc</code> æ–‡ä»¶é‡Œ.</p>
<p>ç„¶åä¿®æ”¹ <code>external/rebind/CMakeLists.txt:49</code> é™„è¿‘ä»£ç :</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set_property</span>(GLOBAL PROPERTY rebind_module_files</span><br><span class="line">    <span class="comment"># $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/source/Python.cc</span></span><br><span class="line">    <span class="comment"># $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/source/Module.cc</span></span><br><span class="line">    <span class="comment"># $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/source/Cast.cc</span></span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/source/Globals.cc</span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/source/Cast_Python_Module.cc</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="è§£å†³-Python-ç¬¦å·æœªå®šä¹‰é”™è¯¯"><a href="#è§£å†³-Python-ç¬¦å·æœªå®šä¹‰é”™è¯¯" class="headerlink" title="è§£å†³ Python ç¬¦å·æœªå®šä¹‰é”™è¯¯"></a>è§£å†³ Python ç¬¦å·æœªå®šä¹‰é”™è¯¯</h3><p>æœ€å, ä¹Ÿä¸çŸ¥é“å“ªæ²¡é…ç½®å¥½, ä¼šå¾—åˆ°ä¸€å¤§å †å…³äº Python åº“ç¬¦å·æœªå®šä¹‰çš„é”™è¯¯, åƒè¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ld.lld: error: undefined symbol: __declspec(dllimport) PyObject_CallObject</span><br></pre></td></tr></table></figure>

<p>ä¼¼ä¹åªæ˜¯å› ä¸ºåœ¨ Windows ä¸‹æ²¡æœ‰æŒ‡å®š Python é“¾æ¥åº“, æ‰€ä»¥æ ¹æ®è¦ç»‘å®šçš„ Python ç‰ˆæœ¬, ç›´æ¥åœ¨é¡¶çº§ <code>CMakeLists.txt</code> é‡Œç”¨ <code>link_directories</code> å’Œ <code>link_libraries</code> ç›´æ¥æ‰“è¡¥ä¸ä¿®å¤, ç±»ä¼¼äºä¸‹é¢è¿™æ ·. åº“ç›®å½•å’Œå‘½ä»¤é‡Œçš„ <code>-DREBIND_PYTHON_INCLUDE</code> æŒ‡å®šçš„åŒ…å«ç›®å½•ç›¸äº’åŒ¹é….</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">link_directories</span>(</span><br><span class="line">    <span class="string">&quot;/d/CondaEnvs/py39/libs&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">link_libraries</span>(</span><br><span class="line">    python39</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯, ä¸èƒ½é“¾æ¥ <code>python3</code>, å¿…é¡»é“¾æ¥ç‰¹å®šç‰ˆæœ¬çš„åº“ (æ¯”å¦‚ <code>python39</code>), å¦åˆ™è¿˜æ˜¯ä¼šå‡ºç°ä¸ªåˆ«ç¬¦å·æœªå®šä¹‰.</p>
<h3 id="è§£å†³-ImageHlp-ç¬¦å·æœªå®šä¹‰"><a href="#è§£å†³-ImageHlp-ç¬¦å·æœªå®šä¹‰" class="headerlink" title="è§£å†³ ImageHlp ç¬¦å·æœªå®šä¹‰"></a>è§£å†³ ImageHlp ç¬¦å·æœªå®šä¹‰</h3><p>æœ€åçš„æœ€å, é“¾æ¥çš„æ—¶å€™è¿˜å­˜åœ¨ä¸€äº›ç¬¦å·æœªå®šä¹‰, å¤§æ¦‚é•¿è¿™æ ·.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ld.lld: error: undefined symbol: __declspec(dllimport) SymGetModuleBase64</span><br><span class="line">ld.lld: error: undefined symbol: __declspec(dllimport) StackWalk64</span><br><span class="line">ld.lld: error: undefined symbol: __declspec(dllimport) ImageNtHeader</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯åœ¨ Windows ä¸‹å°‘é“¾æ¥äº†ä¸€äº›åº“, ç»è¿‡ä¸€ç•ªæœç´¢, æ‰¾åˆ°ä¸€ä¸ªå¯è¡Œçš„<span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjY0MDU0MjAvdzY0LW1pbmd3LWxsdm1zdXBwb3J0LWEtdW5kZWZpbmVkLXJlZmVyZW5jZS10by1pbXA=">è§£å†³æ–¹æ¡ˆ<i class="fa fa-external-link-alt"></i></span>, ç›´æ¥åœ¨é¡¶çº§ <code>CMakeLists.txt</code> çš„ <code>link_libraries</code> é‡Œæ·»åŠ å¯¹ <code>imagehlp</code> çš„é“¾æ¥å³å¯.</p>
<h2 id="ç”Ÿæˆ-Python-åŒ…"><a href="#ç”Ÿæˆ-Python-åŒ…" class="headerlink" title="ç”Ÿæˆ Python åŒ…"></a>ç”Ÿæˆ Python åŒ…</h2><p>é¦–å…ˆéœ€è¦ä¿®æ”¹ä¸€ä¸‹ç”Ÿæˆç›®å½•ä¸‹çš„ <code>setup.py</code>, ä¹Ÿå¯ä»¥åœ¨ç”Ÿæˆä¹‹å‰ç›´æ¥ä¿®æ”¹æºç çš„ <code>package/setup.py</code>, å°±ä¸ç”¨æ¯æ¬¡ä¿®æ”¹.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">setup(</span><br><span class="line">    name=<span class="string">&#x27;nupack&#x27;</span>,</span><br><span class="line">    version=<span class="string">&#x27;@PROJECT_VERSION@&#x27;</span>,</span><br><span class="line">    description=<span class="string">&#x27;Nucleic Acid Package&#x27;</span>,</span><br><span class="line">    url=<span class="string">&#x27;www.nupack.org&#x27;</span>,</span><br><span class="line">    <span class="comment"># package_data=&#123;&#x27;nupack&#x27;: [&#x27;cpp.so&#x27;, &#x27;parameters/*&#x27;]&#125;,</span></span><br><span class="line">    package_data=&#123;<span class="string">&#x27;nupack&#x27;</span>: [<span class="string">&#x27;cpp.pyd&#x27;</span>, <span class="string">&#x27;parameters/*&#x27;</span>, <span class="string">&quot;*.dll&quot;</span>]&#125;,</span><br><span class="line">    packages=find_packages(include=(<span class="string">&#x27;nupack**&#x27;</span>,)),</span><br><span class="line">    scripts=[],</span><br><span class="line">    distclass=BinaryDistribution,</span><br><span class="line">    cmdclass=&#123;<span class="string">&#x27;install&#x27;</span>: InstallPlatlib&#125;,</span><br><span class="line">    install_requires=[</span><br><span class="line">        <span class="string">&#x27;pyyaml&gt;=5.0.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;scipy&gt;=1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;numpy&gt;=1.17&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pandas&gt;=1.1.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;jinja2&gt;=2.0&#x27;</span>,</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>åœ¨ Windows ä¸‹ Python çš„æ‰©å±•æ¨¡å—æ–‡ä»¶ååç¼€æ˜¯ <code>.pyd</code>, æ‰€ä»¥å¾—æŠŠç¼–è¯‘åç”Ÿæˆçš„ <code>cpp.so</code> é‡å‘½åæˆ <code>cpp.pyd</code>.</p>
<p>ç„¶ååˆšåˆšç¼–è¯‘ç”Ÿæˆçš„ <code>cpp.pyd</code>, è¿˜ä¾èµ–äºæˆ‘ä»¬ç¼–è¯‘ç¯å¢ƒé‡Œä»¥åŠå®‰è£…çš„ä¸€äº›åº“çš„åŠ¨æ€é“¾æ¥åº“ DLL æ–‡ä»¶, æ‰€ä»¥è¿˜å¾—æŒ¨ä¸ªæŠŠè¿™äº› DLL æ–‡ä»¶å¤åˆ¶è¿‡æ¥å’Œ <code>cpp.pyd</code> æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ä¸€èµ·æ‰“åŒ…è¿›å». å¦‚æœç¼ºå°‘æŸäº›åº“åˆ™åœ¨ <code>import nupack</code> çš„æ—¶å€™ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„æŠ¥é”™ä¿¡æ¯.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ImportError: DLL load failed while importing cpp: æ‰¾ä¸åˆ°æŒ‡å®šçš„æ¨¡å—ã€‚</span><br></pre></td></tr></table></figure>

<details class="note info"><summary><p><em>å¦‚ä½•çŸ¥é“å“ªäº› DLL æ–‡ä»¶æ˜¯å¿…éœ€çš„?</em></p>
</summary>
<p>æœ‰ä¸¤ç§æ–¹æ¡ˆ, é¦–å…ˆè¿™äº›å¿…éœ€çš„ DLL æ¥è‡ªäºä¸¤éƒ¨åˆ†:</p>
<ul>
<li>MSYS2 ç¯å¢ƒå˜é‡é‡Œçš„ç³»ç»Ÿåº“.</li>
<li>é€šè¿‡ vcpkg å®‰è£…çš„ç¬¬ä¸‰æ–¹åº“.</li>
</ul>
<p>å› æ­¤ç¬¬ä¸€ç§æ–¹å¼æ˜¯æŠŠæ‰€æœ‰å¯èƒ½çš„ç³»ç»Ÿåº“å’Œç¬¬ä¸‰æ–¹åº“å®‰è£…åç”Ÿæˆçš„ DLL æ–‡ä»¶éƒ½å¤åˆ¶åˆ° <code>cpp.pyd</code> ä¸€èµ·, ç„¶åå¯åŠ¨ <code>python</code> ä¼šè¯å¹¶ <code>import cpp</code>, æ­¤æ—¶å°†æ‰€æœ‰å¤åˆ¶è¿‡æ¥çš„ DLL æ–‡ä»¶å°è¯•åˆ é™¤, æœ€åç•™ä¸‹æ¥æç¤ºæ­£åœ¨å ç”¨æ— æ³•åˆ é™¤çš„å°±æ˜¯å¿…éœ€ DLL.</p>
<p>ç¬¬äºŒç§æ–¹å¼æ˜¯ä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly93d3cuZGVwZW5kZW5jeXdhbGtlci5jb20v">Dependency Walker<i class="fa fa-external-link-alt"></i></span> æŸ¥çœ‹ <code>cpp.pyd</code> ä¾èµ–çš„ DLL æ–‡ä»¶, å¹¶åœ¨ç³»ç»Ÿç›®å½•å’Œç¬¬ä¸‰æ–¹åº“ç›®å½•é‡Œå¯¹ç…§, çœ‹çœ‹æ¶‰åŠå“ªäº›å°±å¤åˆ¶å“ªäº›, Dependency Walker å¯èƒ½ä¼šæŠŠ VC è¿è¡Œæ—¶çš„ DLL ä¹Ÿç®—è¿›å» (å°±æ˜¯ä¸€å¤§å †åå­—é‡Œå¸¦ <code>api-ms</code> çš„), ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ç”µè„‘ä¸Šéƒ½æ˜¯è£…äº†çš„, å¦‚æœæœ€åçœŸæ²¡æœ‰çš„è¯å¯ä»¥å» <span class="exturl" data-url="aHR0cHM6Ly9sZWFybi5taWNyb3NvZnQuY29tL2VuLXVzL2NwcC93aW5kb3dzL2xhdGVzdC1zdXBwb3J0ZWQtdmMtcmVkaXN0">Microsoft Visual C++ Redistributable latest supported downloads<i class="fa fa-external-link-alt"></i></span> è¿™é‡Œä¸‹è½½å®‰è£…æœ€æ–°çš„è¿è¡Œæ—¶åº“.</p>

</details>

<p>ç³»ç»Ÿä¾èµ–åº“:</p>
<ul>
<li><code>libc++.dll</code>: ä½äº MSYS2 å®‰è£…ç›®å½•çš„ <code>clang64/bin</code> ä¸‹é¢.</li>
</ul>
<p>å…¶ä½™éƒ½æ˜¯æˆ‘ä»¬å®‰è£…çš„åº“åŠå…¶ä¾èµ–çš„åº“, å‡ä½äº <code>external/vcpkg/installed/x64-mingw-dynamic/bin</code> ä¸‹, å…± 16 ä¸ª:</p>
<ul>
<li><code>libgcc_s_seh-1.dll</code></li>
<li><code>libgecodefloat.dll</code></li>
<li><code>libgecodeint.dll</code></li>
<li><code>libgecodekernel.dll</code></li>
<li><code>libgecodeminimodel.dll</code></li>
<li><code>libgecodesearch.dll</code></li>
<li><code>libgecodeset.dll</code></li>
<li><code>libgecodesupport.dll</code></li>
<li><code>libgfortran-5.dll</code></li>
<li><code>liblapack.dll</code></li>
<li><code>libopenblas.dll</code></li>
<li><code>libprotobuf.dll</code></li>
<li><code>libquadmath-0.dll</code></li>
<li><code>libtbb12.dll</code></li>
<li><code>libwinpthread-1.dll</code></li>
<li><code>libyaml-cpp.dll</code></li>
</ul>
<p>ç„¶åå¯¼èˆªè¿›ç”Ÿæˆç›®å½•ä¸‹, ä½¿ç”¨å‘½ä»¤ <code>python -m build</code> è¿›è¡Œæ‰“åŒ…, åˆ™ä¼šåœ¨ <code>dist</code> ä¸‹ç”Ÿæˆæ‰“åŒ…åçš„æºç å’Œ whl å®‰è£…åŒ….</p>
<p>ä¹‹åå¯ä»¥ä½¿ç”¨ <code>pip install</code> ç›´æ¥å®‰è£… <code>whl</code> æ–‡ä»¶, å¹¶è¿è¡Œå‘½ä»¤ <code>python -m pytest -v --pyargs nupack</code> æ¥æµ‹è¯•åŠŸèƒ½æ˜¯å¦æ­£å¸¸, åº”å½“æ˜¯ <code>45</code> ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡, æ— ä»»ä½•è­¦å‘Šå’Œé”™è¯¯.</p>
<h2 id="è§£å†³è·¯å¾„é”™è¯¯"><a href="#è§£å†³è·¯å¾„é”™è¯¯" class="headerlink" title="è§£å†³è·¯å¾„é”™è¯¯"></a>è§£å†³è·¯å¾„é”™è¯¯</h2><p>ç›´æ¥åœ¨æºç ç›®å½•ä¸‹é¢æµ‹è¯•æ²¡æµ‹å‡ºæ¥ bug, ä½†æ˜¯å»åˆ«çš„ç›®å½•ä¸‹å°±ä¼šå‘ç”ŸæŠ¥é”™.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RuntimeError: C++: : &quot;failed to open parameter file &quot; (Model.cc, line 50)</span><br></pre></td></tr></table></figure>

<p>æœ‰é—®é¢˜çš„æºç åœ¨ <code>source/Model.cc:35</code> é™„è¿‘.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">json <span class="title">ParameterFile::open</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    string name = path;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">path_exists</span>(name)) &#123;</span><br><span class="line">        vec&lt;string&gt; defaults;</span><br><span class="line">        <span class="comment">// boost::split(defaults, DefaultParametersPath, [](char c) &#123;return c == &#x27;:&#x27;;&#125;, boost::token_compress_on); // Windows ä¸‹ä¸èƒ½æŒ‰å†’å· : åˆ†å‰², æ¢æˆåˆ†å· ;</span></span><br><span class="line">        boost::<span class="built_in">split</span>(defaults, DefaultParametersPath, [](<span class="type">char</span> c) &#123;<span class="keyword">return</span> c == <span class="string">&#x27;;&#x27;</span>;&#125;, boost::token_compress_on);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span> &amp;d : defaults) &#123;</span><br><span class="line">            name = <span class="built_in">path_join</span>(d, path);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">path_exists</span>(name)) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">path_exists</span>(name)) &#123;</span><br><span class="line">        <span class="keyword">auto</span> s = <span class="built_in">get_env</span>(<span class="string">&quot;NUPACKHOME&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!s.<span class="built_in">empty</span>()) name = <span class="built_in">path_join</span>(<span class="built_in">path_join</span>(s, <span class="string">&quot;parameters&quot;</span>), path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(name)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!file.<span class="built_in">good</span>()) &#123;</span><br><span class="line">        vec&lt;string&gt; directories = &#123;<span class="string">&quot;.&quot;</span>, DefaultParametersPath, <span class="string">&quot;$NUPACKHOME/parameters&quot;</span>&#125;;</span><br><span class="line">        <span class="built_in">NUPACK_ERROR</span>(<span class="string">&quot;failed to open parameter file &quot;</span>, path, directories);</span><br><span class="line">    &#125;</span><br><span class="line">    json j;</span><br><span class="line">    file &gt;&gt; j;</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸä»£ç ç›´æ¥æŒ‰å†’å· <code>:</code> å¯¹é»˜è®¤å‚æ•°æ–‡ä»¶è·¯å¾„è¿›è¡Œåˆ†å‰², ç±»ä¼¼ç¯å¢ƒå˜é‡é‚£ç§, ä½†æ˜¯åœ¨ Windows ä¸Šä¼šé”™è¯¯åœ°æŠŠç›˜ç¬¦åé¢çš„å†’å·åˆ‡äº†, æ‰€ä»¥æ‰¾ä¸åˆ°æ–‡ä»¶. ä¸è¿‡è¿™åœ°æ–¹å¯ä»¥æ›²çº¿ä¸€ä¸‹, å°±æ˜¯æ‰‹åŠ¨è®¾ç½® <code>NUPACKHOME</code> ç¯å¢ƒå˜é‡, è¿™éƒ¨åˆ†çš„å¯»æ‰¾é€»è¾‘å€’æ˜¯æ²¡æœ‰é—®é¢˜.</p>
<p>æ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªåœ°æ–¹è·¯å¾„æ ¼å¼ä¹Ÿæœ‰é—®é¢˜, ä¹Ÿä¸€å¹¶ä¿®æ”¹ä¸€ä¸‹.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OSError: [Errno 22] Invalid argument: &#x27;blah\\0\\checkpoint\\2024-05-13T10:46:49.json&#x27;</span><br><span class="line">OSError: [Errno 22] Invalid argument: &#x27;design-checkpoint\\2024-05-13T10:46:50.json&#x27;</span><br></pre></td></tr></table></figure>

<p>åœ¨ Windows ä¸‹é¢æ–‡ä»¶åä¸èƒ½åŒ…å« <code>:</code>, å› æ­¤å»æºç é‡Œç®€å•ä¿®æ”¹ä¸€ä¸‹å³å¯, ä½äº <code>python/design/components.py:96</code> é™„è¿‘, å¹²è„†æ¢ä¸€ä¸ªæ—¶é—´æ ¼å¼å¾—äº†.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WriteToFileCheckpoint</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path, timespec=<span class="string">&#x27;seconds&#x27;</span></span>):</span><br><span class="line">        self.path = pathlib.Path(path)</span><br><span class="line">        self.timespec = timespec</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, result</span>):</span><br><span class="line">        <span class="comment"># time = datetime.datetime.now().isoformat(timespec=self.timespec)</span></span><br><span class="line">        time = datetime.datetime.now().strftime(<span class="string">&quot;%Y%m%d-%H%M%S&quot;</span>)</span><br><span class="line">        self.path.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        path = self.path/<span class="string">&#x27;&#123;&#125;.json&#x27;</span>.<span class="built_in">format</span>(time)</span><br><span class="line">        path.write_text(result.to_json().dump(indent=<span class="number">4</span>))</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡æ”¹äº†ä¹‹åè¿˜éœ€è¦æŠŠé…å¥—ä½¿ç”¨äº† <code>fromisoformat</code> çš„åœ°æ–¹ä¹Ÿä¸€å¹¶ä¿®æ”¹, ä½äº <code>python/design/trials.py:96</code> é™„è¿‘.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_checkpoints</span>(<span class="params">self, where=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> where <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        where = self.checkpoint/<span class="string">&#x27;checkpoint&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> where.exists():</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(</span><br><span class="line">        (i <span class="keyword">for</span> i <span class="keyword">in</span> where.iterdir() <span class="keyword">if</span> i.suffix == <span class="string">&#x27;.json&#x27;</span>),</span><br><span class="line">        reverse=<span class="literal">True</span>, </span><br><span class="line">        <span class="comment"># key=lambda p: datetime.datetime.fromisoformat(p.stem) # æ­¤å¤„åº”è¯¥æ˜¯å¯ä»¥ç›´æ¥æŒ‰å­—ç¬¦ä¸²å¤§å°è¿›è¡Œæ¯”è¾ƒçš„, å’ŒæŒ‰æ—¶é—´æ¯”è¾ƒåº”è¯¥ç»“æœç›¸åŒ</span></span><br><span class="line">        key=<span class="keyword">lambda</span> p: p.stem</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h2 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h2><p>ç¼–è¯‘æˆåŠŸä¹‹åæ•´ä¸ª <code>cpp.pyd</code> åŠ ä¸Šæ‰€æœ‰çš„ <code>dll</code> æ–‡ä»¶åˆèµ·æ¥æœ‰çº¦è« 67 MB å¤§å°, æ‰“åŒ…ä¹‹åçš„ <code>whl</code> æ–‡ä»¶ä¹Ÿè¿˜æœ‰ 18 MB å·¦å³, æ„Ÿè§‰æœ‰ç‚¹å¤ªå¤§, æ‰€ä»¥ä¹‹ååˆå°è¯•äº†ä¸€ä¸‹æŒ‰é™æ€çš„æ–¹å¼å»é“¾æ¥ç¬¬ä¸‰æ–¹åº“.</p>
<p>æ‰€åšçš„æ”¹åŠ¨ä¹Ÿä¸å¤š, æŠŠå‰é¢ç”¨åˆ°çš„æ‰€æœ‰ <code>x64-mingw-dynamic</code> éƒ½æ¢æˆ <code>x64-mingw-static</code>, è¿™æ ·åœ¨å®‰è£…å’Œé“¾æ¥ç¬¬ä¸‰æ–¹åº“çš„æ—¶å€™å°±ä¼šé»˜è®¤éƒ½ç”¨é™æ€åº“çš„æ–¹å¼, ä¸ªåˆ«ä¸æ”¯æŒé™æ€åº“çš„ä¼šè‡ªåŠ¨åˆ‡æ¢æˆåŠ¨æ€åº“æ¨¡å¼, ç”šè‡³ <code>cmake/Libraries.cmake</code> é‡Œçš„åº“åä¹Ÿéƒ½å¯ä»¥ä¸ç”¨æ”¹äº†, å› ä¸ºå®‰è£…çš„é™æ€åº“åç¼€å°±åªæœ‰ä¸€ä¸ªå•ç‹¬çš„ <code>.a</code>. ä¸è¿‡ <code>lapack</code> è¿™ä¸ªåº“è¿˜æ˜¯å¾—æ‰‹åŠ¨æ”¹åç¼€, å› ä¸ºå®ƒä¸æ”¯æŒé™æ€åº“, ä»ç„¶æ˜¯å®‰è£…çš„åŠ¨æ€åº“.</p>
<p>æœ€åä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“ DLL æ–‡ä»¶ä¹Ÿå‡å°‘åˆ° 6 ä¸ª, æ•´ä¸ª <code>cpp.pyd</code> åŠ ä¸Šæ‰€æœ‰ <code>dll</code> æ–‡ä»¶åˆèµ·æ¥åªæœ‰ 45 MB, æ‰“åŒ…åçš„ <code>whl</code> æ–‡ä»¶é™ä½åˆ° 13 MB å·¦å³.</p>
<p>ç„¶åä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„é—®é¢˜, åŸé¡¹ç›®å…³äº Python æ¨¡å—ç¬¦å·çš„å¯¼å‡ºå†™çš„æœ‰ç‚¹å°é—®é¢˜, å¯¼è‡´æ‰“åŒ…åçš„åº“åœ¨å¯¼å…¥çš„æ—¶å€™ä¼šæŠ¥é”™æ‰¾ä¸åˆ°ç¬¦å·.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ImportError: dynamic module does not define module export function (PyInit_cpp)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªé—®é¢˜ä¹Ÿæ¯”è¾ƒå¥½è§£å†³, åœ¨æ–‡ä»¶ <code>external/rebind/source/Module.cc:203</code> (æœ€åè¢«åˆå¹¶åˆ°äº† <code>external/rebind/source/Cast_Python_Module.cc</code> é‡Œäº†) å¤„é™„è¿‘, æˆ‘ä»¬å¯ä»¥å¢åŠ  Python å¤´æ–‡ä»¶æä¾›çš„å¯¼å‡ºç¬¦å·å®å®šä¹‰ <code>Py_EXPORTED_SYMBOL</code>.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Py_EXPORTED_SYMBOL PyObject* <span class="title">REBIND_CAT</span><span class="params">(PyInit_, REBIND_MODULE)</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">Py_Initialize</span>();</span><br><span class="line">    <span class="keyword">return</span> rebind::<span class="built_in">raw_object</span>([&amp;]() -&gt; rebind::Object &#123;</span><br><span class="line">        rebind::Object mod &#123;<span class="built_in">PyModule_Create</span>(&amp;rebind_definition), <span class="literal">true</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (!mod) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        rebind::<span class="built_in">init</span>(rebind::<span class="built_in">document</span>());</span><br><span class="line">        rebind::Object dict = <span class="built_in">initialize</span>(rebind::<span class="built_in">document</span>());</span><br><span class="line">        <span class="keyword">if</span> (!dict) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        rebind::<span class="built_in">incref</span>(+dict);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">PyModule_AddObject</span>(+mod, <span class="string">&quot;document&quot;</span>, +dict) &lt; <span class="number">0</span>) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        <span class="keyword">return</span> mod;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸éœ€è¦ç”¨ <code>PyMODINIT_FUNC</code>, å› ä¸ºä¼šé‡å¤å®šä¹‰ <code>extern &quot;C&quot;</code>.</p>
<p>ä¸è¿‡æ‡’å¾—å†å…¨éƒ¨é‡æ–°æŒ‰é™æ€æ–¹å¼ç¼–è¯‘é“¾æ¥ä¸€æ¬¡, æ‰€ä»¥ Github ä¸Šéƒ½æ˜¯æ”¾çš„åŠ¨æ€é“¾æ¥çš„ç‰ˆæœ¬<del>ä¸Šä¼ å®Œäº†æ— èŠè¯•è¯•æ‰å‘ç°é™æ€é“¾æ¥ä¸€è·¯ç•…é€šæ— é˜»ä¸”ä½“ç§¯å°æ€§ä»·æ¯”åˆé«˜</del>.</p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æœ¬æ¬¡ç¼–è¯‘è¿‡ç¨‹æ‰€æœ‰ä¿®æ”¹åçš„å·®å¼‚æ–‡ä»¶å‡æ”¾åœ¨è‡ªå·±çš„ Github ä¸Šäº†, åŒ…æ‹¬åœ¨è‡ªå·±ç”µè„‘ä¸Šæ‰“åŒ…å¥½çš„ <code>whl</code> æ–‡ä»¶ (åŠ¨æ€é“¾æ¥ç‰ˆæœ¬) ä¹Ÿä¸€å¹¶æ”¾ä¸Šå»äº†, ä»“åº“åœ°å€æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL251cGFjay13aW4=">nupack-win<i class="fa fa-external-link-alt"></i></span>, ç›´æ¥å» Releases é¡µé¢ä¸‹è½½å³å¯.</p>
<p>ä»äº”ä¸€æ”¾å‡å¼€å§‹æŠ˜è…¾, å‰å‰ååå¤§çº¦æŠ˜è…¾äº†ä¸€å‘¨å¤šæ‰ç¼–è¯‘å‡ºæ¥, å¯ä»¥è¯´æ˜¯æŠŠèƒ½è¸©çš„å‘éƒ½è¸©äº†ä¸ªé, è®©æˆ‘æ·±åˆ»çš„è®¤è¯†åˆ°ä¸åŒæ“ä½œç³»ç»Ÿä¸åŒç¼–è¯‘ç¯å¢ƒçš„å¤©å£¤ä¹‹åˆ«, æœŸé—´ä¹Ÿè¯•è¿‡ç”¨ msvc å’Œ gcc å»ç¼–è¯‘, ä½†æ˜¯ä¸€å¨çš„è­¦å‘Šå’Œé”™è¯¯è®©æˆ‘å½»åº•è½¬å‘ clang. <del>ä¸è¿‡é‚£äº›è­¦å‘Šå’Œé”™è¯¯çœ‹ç€æŒºæœ‰é“ç†çš„, æ€ä¹ˆ clang å°±ä¸ç®¡äº†å‘¢?</del></p>
<p>è™½ç„¶ä¹‹åè‡ªå·±çš„é¡¹ç›®è¦ç”¨è¿™ä¸ªçš„æ—¶å€™å¤§æ¦‚ç‡æ˜¯åœ¨ Linux ç¯å¢ƒè¿è¡Œ, ç”¨ä¸åˆ° Windows çš„åº“äº†, ä½†æ˜¯è¿™ä¹ˆæŠ˜è…¾ä¸€ä¸‹ä¹ŸæŒºæœ‰æ”¶è·, è‡³å°‘æµ…æµ…çš„ä½¿ç”¨äº†ä¸€ä¸‹ä¸‰å¤§ä¸»æµ C ç¼–è¯‘å™¨, ä»¥åŠç†Ÿæ‚‰äº†ä¸€ä¸‹ CMake å’Œ vcpkg çš„ä½¿ç”¨æ–¹æ³•, å¸Œæœ›è¿™æ¬¡è¸©çš„å‘å°†æ¥éƒ½ä¸ä¼šè¸©äº†å§~</p>
]]></content>
      <categories>
        <category>ç è®°</category>
      </categories>
      <tags>
        <tag>NUPACK</tag>
        <tag>MSYS2</tag>
        <tag>MinGW</tag>
        <tag>Clang</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ transformers.Pipeline è¿­ä»£ç”Ÿæˆæ•°æ®</title>
    <url>//posts/2024/05/07/py-transformers-genexpr/</url>
    <content><![CDATA[<p>æœ€è¿‘éœ€è¦ç”¨ <a href="https://huggingface.co/docs/transformers/index"><code>transformers</code></a> è¿™ä¸ªåº“è½½å…¥å¤§æ¨¡å‹è¿›è¡Œç‰¹å¾æå–, ä½†æ˜¯å—é™äºç¡¬ä»¶æ¡ä»¶, ä¸èƒ½å°†æ‰€æœ‰è¾“å…¥æ¨ç†åçš„ç»“æœæ”¾åœ¨å†…å­˜é‡Œ, åªèƒ½é€€è€Œæ±‚å…¶æ¬¡åˆ†æ‰¹æ¨ç†ç„¶åå†™å…¥æœ¬åœ°. äºæ˜¯é¡ºåŠ¿æ¢ç´¢äº†ä¸€ä¸‹ <span class="exturl" data-url="aHR0cHM6Ly9odWdnaW5nZmFjZS5jby9kb2NzL3RyYW5zZm9ybWVycy9tYWluX2NsYXNzZXMvcGlwZWxpbmVz">Pipelines<i class="fa fa-external-link-alt"></i></span> çš„ç”¨æ³•.</p>
<span id="more"></span>

<h2 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h2><p>åŸºæœ¬ç”¨æ³•å‚è€ƒå®˜æ–¹æ–‡æ¡£ <span class="exturl" data-url="aHR0cHM6Ly9odWdnaW5nZmFjZS5jby9kb2NzL3RyYW5zZm9ybWVycy9waXBlbGluZV90dXRvcmlhbA==">Pipelines for inference<i class="fa fa-external-link-alt"></i></span>.</p>
<p>æ¯”å¦‚é€šè¿‡ä¸‹é¢çš„æ–¹å¼åŠ è½½ä¸€ä¸ª <a href="https://huggingface.co/docs/transformers/main_classes/pipelines#transformers.FeatureExtractionPipeline"><code>FeatureExtractionPipeline</code></a>.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fe_pipline = pipeline(</span><br><span class="line">    <span class="string">&quot;feature-extraction&quot;</span>,</span><br><span class="line">    model=AutoModelForTextEncoding.from_pretrained(self.encoder_dir),  <span class="comment"># BERT æ¨¡å‹</span></span><br><span class="line">    tokenizer=AutoTokenizer.from_pretrained(self.encoder_dir),</span><br><span class="line">    device=self.device</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿™æ ·å­è¿›è¡Œæ¨ç†.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">inputs = [ <span class="string">&quot;A B C D E&quot;</span>, <span class="string">&quot;F G H J K&quot;</span> ]  <span class="comment"># ä¸¤æ¡è¾“å…¥</span></span><br><span class="line">outputs = fe_pipline(inputs, batch_size=self.batch_size, return_tensors=<span class="literal">False</span>)  <span class="comment"># (2, L, E)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹å¼å¯ä»¥ä¸€æ¬¡æ€§å¾—åˆ° <code>inputs</code> çš„æ‰€æœ‰æ¨ç†ç»“æœ.</p>
<h2 id="åˆ†æ‰¹è¾“å…¥"><a href="#åˆ†æ‰¹è¾“å…¥" class="headerlink" title="åˆ†æ‰¹è¾“å…¥"></a>åˆ†æ‰¹è¾“å…¥</h2><p>å®˜æ–¹æä¾›äº†ä¸€ä¸ªåˆ†æ‰¹è¾“å…¥çš„ç¤ºä¾‹, <span class="exturl" data-url="aHR0cHM6Ly9odWdnaW5nZmFjZS5jby9kb2NzL3RyYW5zZm9ybWVycy9tYWluX2NsYXNzZXMvcGlwZWxpbmVzI3BpcGVsaW5lLWJhdGNoaW5n">Pipeline batching<i class="fa fa-external-link-alt"></i></span>.</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> pipeline</span><br><span class="line"><span class="keyword">from</span> transformers.pipelines.pt_utils <span class="keyword">import</span> KeyDataset</span><br><span class="line"><span class="keyword">import</span> datasets</span><br><span class="line"></span><br><span class="line">dataset = datasets.load_dataset(<span class="string">&quot;imdb&quot;</span>, name=<span class="string">&quot;plain_text&quot;</span>, split=<span class="string">&quot;unsupervised&quot;</span>)</span><br><span class="line">pipe = pipeline(<span class="string">&quot;text-classification&quot;</span>, device=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> out <span class="keyword">in</span> pipe(KeyDataset(dataset, <span class="string">&quot;text&quot;</span>), batch_size=<span class="number">8</span>, truncation=<span class="string">&quot;only_first&quot;</span>):</span><br><span class="line">    <span class="built_in">print</span>(out)</span><br><span class="line">    <span class="comment"># [&#123;&#x27;label&#x27;: &#x27;POSITIVE&#x27;, &#x27;score&#x27;: 0.9998743534088135&#125;]</span></span><br><span class="line">    <span class="comment"># Exactly the same output as before, but the content are passed</span></span><br><span class="line">    <span class="comment"># as batches to the model</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>è¿™ä¸ªç¤ºä¾‹é‡ŒæŒ‡å®šäº†æ¯æ¬¡å¤„ç†çš„æ‰¹å¤§å°ä¸º <code>8</code>, åŒæ—¶è¿”å›äº†å¯è¿­ä»£ç»“æœ, å¯ä»¥æŒ‰ç…§æ¯æ¬¡ä¸€æ¡çš„æ–¹å¼è·å¾—è¾“å‡ºç»“æœ.</p>
<p>ä¸è¿‡åœ¨å®é™…æµ‹è¯•çš„æ—¶å€™å‘ç°, å½“æˆ‘ç»™å®š <code>list</code> ç±»å‹çš„ <code>inputs</code> æ—¶, æ¨ç†çš„æ—¶å€™ç¡®å®æ˜¯åˆ†æ‰¹æ¨ç†çš„, ä½†æ˜¯æœ€åè¿”å›ç»“æœçš„æ—¶å€™, å…¶å®æ˜¯æŠŠæ‰€æœ‰ç»“æœåˆåœ¨ä¸€èµ·è¿”å›äº†ä¸€ä¸ªå¤§çš„ <code>list</code>.</p>
<p>è¿™å’Œæˆ‘çš„éœ€æ±‚è¿˜æ˜¯æœ‰ä¸€ä¸¢ä¸¢å·®è·çš„, æˆ‘å¸Œæœ›çš„æ˜¯æ¯æ¬¡æ¨ç†ä¸€ä¸ªæ‰¹æ¬¡ä¹‹å, åªè¿”å›ä¸€ä¸ªæ‰¹æ¬¡çš„ç»“æœ, ç„¶åç»§ç»­è¿­ä»£ä¸‹ä¸€ä¸ªæ‰¹æ¬¡, è¿™æ ·å ç”¨çš„å†…å­˜å¤§å°æœ€å¤šä¸è¶…è¿‡ä¸€ä¸ªæ‰¹æ¬¡.</p>
<h2 id="è¿­ä»£è¾“å‡º"><a href="#è¿­ä»£è¾“å‡º" class="headerlink" title="è¿­ä»£è¾“å‡º"></a>è¿­ä»£è¾“å‡º</h2><p>ç»§ç»­æ‰¾ä¸€ä¸‹æ–‡æ¡£, è¿˜èƒ½å‘ç°ä¸€äº›ç¤ºä¾‹ <span class="exturl" data-url="aHR0cHM6Ly9odWdnaW5nZmFjZS5jby9kb2NzL3RyYW5zZm9ybWVycy9tYWluX2NsYXNzZXMvcGlwZWxpbmVzI3RyYW5zZm9ybWVycy5waXBlbGluZQ==">The pipeline abstraction<i class="fa fa-external-link-alt"></i></span>.</p>
<p>å…¶ä¸­æåˆ°äº†:</p>
<blockquote>
<p>For ease of use, a generator is also possible:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> pipeline</span><br><span class="line"></span><br><span class="line">pipe = pipeline(<span class="string">&quot;text-classification&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">data</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># This could come from a dataset, a database, a queue or HTTP request</span></span><br><span class="line">        <span class="comment"># in a server</span></span><br><span class="line">        <span class="comment"># Caveat: because this is iterative, you cannot use `num_workers &gt; 1` variable</span></span><br><span class="line">        <span class="comment"># to use multiple threads to preprocess data. You can still have 1 thread that</span></span><br><span class="line">        <span class="comment"># does the preprocessing while the main runs the big inference</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&quot;This is a test&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> out <span class="keyword">in</span> pipe(data()):</span><br><span class="line">    <span class="built_in">print</span>(out)</span><br><span class="line">    <span class="comment"># &#123;&quot;text&quot;: &quot;NUMBER TEN FRESH NELLY IS WAITING ON YOU GOOD NIGHT HUSBAND&quot;&#125;</span></span><br><span class="line">    <span class="comment"># &#123;&quot;text&quot;: ....&#125;</span></span><br><span class="line">    <span class="comment"># ....</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ <code>Pipeline</code> è¿˜æ”¯æŒæœªçŸ¥é•¿åº¦çš„ç”Ÿæˆå™¨è¾“å…¥, åœ¨è¿™ç§æƒ…å†µä¸‹, å¯¹ <code>pipeline</code> çš„è°ƒç”¨æ²¡æœ‰è¿”å›å…¨éƒ¨ç»“æœ, è€Œæ˜¯ä¸€ä¸ªè¿­ä»£å™¨, æ¯æ¬¡èƒ½è·å–å…¶ä¸­ä¸€æ¡ç»“æœ.</p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>ä¸è¿‡è¿˜æ˜¯ä¸å¤ªæ”¾å¿ƒ, å®˜æ–¹æ–‡æ¡£åªæœ‰ä¸€äº›ç¤ºä¾‹, å¯¹æ¥å£å‚æ•°å’Œè¿”å›å€¼çš„æè¿°å¹¶ä¸æ˜¯å¾ˆæ¸…æ™°, æ‰€ä»¥å¹²è„† F12 çœ‹çœ‹å†…éƒ¨æºç .</p>
<p><code>transformers</code> ç‰ˆæœ¬ä¸º <code>4.31.0</code>.</p>
<p>å…³é”®å‡½æ•°ä¸º <code>transformers.pipelines.base.Pipeline.__call__</code>. è¿™é‡Œæ‘˜å‡ºæ¥ç›¸å…³çš„ä»£ç ç‰‡æ®µ</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@add_end_docstrings(<span class="params">PIPELINE_INIT_ARGS</span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pipeline</span>(<span class="title class_ inherited__">_ScikitCompat</span>):</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, inputs, *args, num_workers=<span class="literal">None</span>, batch_size=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        is_dataset = Dataset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">isinstance</span>(inputs, Dataset)</span><br><span class="line">        is_generator = <span class="built_in">isinstance</span>(inputs, types.GeneratorType)</span><br><span class="line">        is_list = <span class="built_in">isinstance</span>(inputs, <span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">        is_iterable = is_dataset <span class="keyword">or</span> is_generator <span class="keyword">or</span> is_list</span><br><span class="line"></span><br><span class="line">        <span class="comment"># TODO make the get_iterator work also for `tf` (and `flax`).</span></span><br><span class="line">        can_use_iterator = self.framework == <span class="string">&quot;pt&quot;</span> <span class="keyword">and</span> (is_dataset <span class="keyword">or</span> is_generator <span class="keyword">or</span> is_list)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_list:</span><br><span class="line">            <span class="keyword">if</span> can_use_iterator:</span><br><span class="line">                final_iterator = self.get_iterator(</span><br><span class="line">                    inputs, num_workers, batch_size, preprocess_params, forward_params, postprocess_params</span><br><span class="line">                )</span><br><span class="line">                outputs = <span class="built_in">list</span>(final_iterator)</span><br><span class="line">                <span class="keyword">return</span> outputs</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> self.run_multi(inputs, preprocess_params, forward_params, postprocess_params)</span><br><span class="line">        <span class="keyword">elif</span> can_use_iterator:</span><br><span class="line">            <span class="keyword">return</span> self.get_iterator(</span><br><span class="line">                inputs, num_workers, batch_size, preprocess_params, forward_params, postprocess_params</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> is_iterable:</span><br><span class="line">            <span class="keyword">return</span> self.iterate(inputs, preprocess_params, forward_params, postprocess_params)</span><br><span class="line">        <span class="keyword">elif</span> self.framework == <span class="string">&quot;pt&quot;</span> <span class="keyword">and</span> <span class="built_in">isinstance</span>(self, ChunkPipeline):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">next</span>(</span><br><span class="line">                <span class="built_in">iter</span>(</span><br><span class="line">                    self.get_iterator(</span><br><span class="line">                        [inputs], num_workers, batch_size, preprocess_params, forward_params, postprocess_params</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.run_single(inputs, preprocess_params, forward_params, postprocess_params)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°å¯¹è¾“å…¥ <code>inputs</code> çš„è¿›è¡Œäº†ç±»å‹åˆ¤æ–­, ç„¶åè¿”å›å€¼çš„ç±»å‹åˆ™æ ¹æ® <code>inputs</code> çš„ç±»å‹ç”±æœ€åçš„ <code>if ... else ...</code> å†³å®š.</p>
<p>åœ¨ä½¿ç”¨æ¡†æ¶æ˜¯ <code>pytorch</code> çš„æƒ…å†µä¸‹, è¿™é‡Œå¤§è‡´åˆ†æˆä¸¤å¤§ç±»æƒ…å†µ:</p>
<ul>
<li>è¾“å…¥æ˜¯ <code>list</code> ç±»å‹, é‚£ä¹ˆè¿”å›å€¼ä¸€å®šè¢«å¤„ç†æˆå’Œè¾“å…¥æ•°æ®é•¿åº¦ä¸€æ ·çš„ <code>list</code> è¿›è¡Œè¿”å›.</li>
<li>è¾“å…¥æ˜¯å¯è¿­ä»£çš„ (<code>is_iterable</code>), é‚£ä¹ˆè¿”å›ä¸€ä¸ªè¿­ä»£å™¨.</li>
</ul>
<p><code>get_iterator</code> ä¼šè¿”å›ä¸€ä¸ª <code>PipelineIterator</code> å¯¹è±¡, åœ¨æŒ‡å®šäº† <code>batch_size</code> çš„æƒ…å†µä¸‹, å†…éƒ¨ä¼šä¿å­˜ä¸€ä¸ªç»“æœç¼“å†²åŒº, å½“ç¼“å†²åŒºéç©ºåˆ™è¿­ä»£è¾“å‡ºä¸‹ä¸€ä¸ªç»“æœ, ç›´åˆ°ç¼“å†²åŒºç©º, åˆ™è¿›è¡Œä¸‹ä¸€æ‰¹çš„æ¨ç†, å¹¶æ›´æ–°ç¼“å†²åŒº.</p>
<p>è¿™ä¸ªè®¾è®¡å€’æ˜¯å®Œç¾ç¬¦åˆäº†æˆ‘çš„éœ€æ±‚, ä½†æ˜¯å®é™…ä½¿ç”¨çš„æ—¶å€™è¿˜æ˜¯è¸©äº†å‘.</p>
<p>åŸæœ¬ä»¥ä¸ºæŠŠè¾“å…¥æ¢æˆ <code>iter(inputs)</code> å°±å¯ä»¥æŒ‰è¿­ä»£æ–¹å¼è¾“å‡ºäº†, ä½†æ˜¯å´æŠ¥é”™äº†, ä»”ç»†çœ‹çœ‹æºç æ‰å‘ç°, è¿™é‡Œå…¶ä¸­ä¸€ä¸ªåˆ¤æ–­æ˜¯ <code>isinstance(inputs, types.GeneratorType)</code>, ä¹Ÿå°±æ˜¯åˆ¤æ–­è¾“å…¥æ˜¯å¦æ˜¯ç”Ÿæˆå™¨. è€Œåœ¨ Python é‡Œ, <code>Generator</code> æ˜¯ <code>Iterator</code> çš„å­ç±», å› æ­¤äºŒè€…éƒ½æ˜¯å¯è¿­ä»£çš„ (<code>Iterable</code>), ä½†æ˜¯è¾“å…¥æ˜¯ <code>Iterator</code> çš„æ—¶å€™, æ­¤å¤„çš„é€»è¾‘å´æ— æ³•å°†å®ƒåˆ¤æ–­æˆå¯è¿­ä»£çš„å¯¹è±¡.</p>
<p>åˆç¿»äº†ä¸€ä¸‹æºç , çœ‹ä¸Šå»åªéœ€è¦åˆ¤æ–­æ˜¯è¿­ä»£å™¨å°±è¡Œäº†, å¹¶æ²¡æœ‰ç”¨åˆ°ç”Ÿæˆå™¨çš„ç‰¹æ€§, å› æ­¤ä¸¥é‡æ€€ç–‘è¿™é‡Œæ˜¯ä¸æ˜¯å†™ä»£ç çš„äººæ²¡æ³¨æ„è¿™ä¸ªé—®é¢˜æé”™äº†......</p>
<p>ä¸è¿‡é—®é¢˜ä¸å¤§, Python æä¾›äº†å¾ˆä¼˜é›…çš„ç”Ÿæˆå™¨è¡¨è¾¾å¼è¯­æ³•ç³–, ä¸ç”¨å†™ç¹ççš„ç”Ÿæˆå™¨å‡½æ•°, åªéœ€è¦ <code>(v for v in inputs)</code> å°±èƒ½æŠŠå¯è¿­ä»£å¯¹è±¡åŒ…è£…æˆç”Ÿæˆå™¨, ä¹‹åå°±èƒ½æ„‰å¿«çš„ä½¿ç”¨å®ƒçš„ç¼“å†²åŒºè¾“å‡ºåŠŸèƒ½äº†~</p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å½“ç„¶ä¹Ÿæœ‰åˆ«çš„æ›²çº¿æ•‘å›½æ–¹æ¡ˆ, ä»å®ƒçš„é€»è¾‘ä¸Šçœ‹, åªè¦ä¸æ˜¯ <code>list</code> å¹¶ä¸” <code>can_use_iterator</code> å°±å¯ä»¥å¾—åˆ°è¾“å‡ºè¿­ä»£å™¨, é‚£ä¹ˆè¿˜å¯ä»¥æŠŠè¾“å‡ºåŒ…è£…æˆ <code>torch.utils.data.Dataset</code>, ä¸è¿‡è¿™ä¸ªæ˜¾ç„¶æ²¡æœ‰ä½¿ç”¨ç”Ÿæˆå™¨è¡¨è¾¾å¼æ–¹ä¾¿.</p>
]]></content>
      <categories>
        <category>ç è®°</category>
      </categories>
      <tags>
        <tag>transformers</tag>
        <tag>Pipeline</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ç½‘é¡µé¢„è§ˆç¢§è“èˆªçº¿åŠ¨æ€ç«‹ç»˜</title>
    <url>//posts/2024/12/22/spinejs-azurlane/</url>
    <content><![CDATA[<p>æ°é€¢æœ€è¿‘<span class="exturl" data-url="aHR0cHM6Ly93aWtpLmJpbGlnYW1lLmNvbS9ibGh4LzIwMjQlRTUlQjklQjQxMiVFNiU5QyU4ODE5JUU2JTk3JUE1MTA6MDAlRTYlQjglQUYlRTUlOEMlQkElRTYlOTQlQjklRTUlQkIlQkE=">ç¢§è“èˆªçº¿æ–°ç‰ˆæœ¬æ›´æ–°<i class="fa fa-external-link-alt"></i></span>, åˆåŒå’å•å¢åŠ äº†ä¸€æ‰¹æ–°èˆ¹ç«‹ç»˜å’Œè§’è‰²çš®è‚¤, æœ¬äººä½œä¸ºå‰æŒ‡æŒ¥å®˜<del>å…¼LSP</del>, æœ€è¿‘ä¹Ÿæ²¡å•¥äº‹, äºæ˜¯åˆä¸‹å›æ¥ç”¨ä»¥å‰çš„èµ„æºçˆ½æŠ½äº†ä¸€æ³¢.</p>
<p>è™½ç„¶æ°ªé‡‘æ˜¯ä¸å¯èƒ½å†æ°ªäº†, ä½†æ˜¯åŒ…è¿˜æ˜¯èƒ½æ‹†çš„, åˆšå¥½æœ€è¿‘é—²ç€, å†åŠ ä¸Šä¹‹å‰æœ‰ä½¿ç”¨ Spine è¿è¡Œæ—¶çš„ç»éªŒ, å†³å®šå†™ä¸ªåœ¨çº¿é¢„è§ˆåŠ¨ç»˜çš„ç½‘é¡µæŒ‚åœ¨åšå®¢ä¸Š.</p>
<p>æˆå“è§<a href="/azurlane/">ç¢§è“èˆªçº¿åŠ¨æ€ç«‹ç»˜åœ¨çº¿é¢„è§ˆ (æŒç»­æ›´æ–°)</a>, é¡µé¢ä¸Šæœ‰ä½¿ç”¨è¯´æ˜, å¯ä»¥åœ¨çº¿é¢„è§ˆåŠ¨æ€çš®è‚¤ (ä¸æ˜¯ Live2D), çš®è‚¤èµ„æºä¹Ÿä¼šä¸å®šæœŸæ›´æ–°.</p>
<span id="more"></span>

<h2 id="åŸºæœ¬æ€è·¯"><a href="#åŸºæœ¬æ€è·¯" class="headerlink" title="åŸºæœ¬æ€è·¯"></a>åŸºæœ¬æ€è·¯</h2><h3 id="Spine-è¿è¡Œæ—¶"><a href="#Spine-è¿è¡Œæ—¶" class="headerlink" title="Spine è¿è¡Œæ—¶"></a>Spine è¿è¡Œæ—¶</h3><p>ä¸»è¦è¿˜æ˜¯ç”¨å®˜æ–¹çš„è¿è¡Œæ—¶åº“ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Vzb3RlcmljU29mdHdhcmUvc3BpbmUtcnVudGltZXMvdHJlZS8zLjgvc3BpbmUtdHM=">spine-ts<i class="fa fa-external-link-alt"></i></span>, å‰©ä¸‹çš„å°±æ˜¯å†™ä¸€ä¸ªå¤§æ¦‚çš„å‰ç«¯é¡µé¢, æä¾›äº¤äº’åŠŸèƒ½.</p>
<p>å®˜æ–¹ä¾‹å­æŒºè¯¦ç»†çš„, è€Œä¸”æºç ä¹Ÿéƒ½æœ‰, ä¸è¿‡è¿™é‡Œæä¸€å˜´å»ºè®®ç›´æ¥ç”¨ <code>webgl</code> ç‰ˆæœ¬, æœ€å¼€å§‹å†™çš„æ—¶å€™å›¾ç®€å•ç”¨çš„ <code>canvas</code> ç‰ˆæœ¬, ä½†æ˜¯ <code>canvas</code> ç‰ˆæœ¬æ—¢ä¸æ”¯æŒ premultiplyAlpha, ä¹Ÿä¸æ”¯æŒ clipping, è€Œä¸”æ€§èƒ½ä¹Ÿå ªå¿§.</p>
<p>å®˜æ–¹åº“ä¸»è¦æ˜¯å°è£…äº†åˆ©ç”¨ <code>webgl</code> æ¸²æŸ“çš„è¿‡ç¨‹, æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å¤„ç†èµ„æºåŠ è½½ä»¥åŠç”»é¢æ˜¾ç¤ºä½ç½®ç­‰ç­‰.</p>
<h3 id="èµ„æºæ¥å£"><a href="#èµ„æºæ¥å£" class="headerlink" title="èµ„æºæ¥å£"></a>èµ„æºæ¥å£</h3><p>æ‹†åŒ…æ‹†å‡ºæ¥çš„åŠ¨æ€ç«‹ç»˜èµ„æºå°†è¿‘ 1 GB, ä¸è¿‡è¿˜æ˜¯å¯ä»¥è€åŠæ³•, å¼€ä¸ªæ–°ä»“åº“å¹¶ä¸”éƒ¨ç½² pages åŠŸèƒ½, è¿™æ ·å­å°±èƒ½åœ¨ç½‘ç«™åŸŸåå­è·¯å¾„ä¸‹è®¿é—®èµ„æºäº†, ä¹Ÿä¸ä¼šæ±¡æŸ“å…¶ä»–ä»“åº“.</p>
<p>ä»“åº“è§ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL2F6dXJsYW5lX3NwaW5lcGFpbnRpbmc=">azurlane_spinepainting<i class="fa fa-external-link-alt"></i></span>, é‡Œé¢çš„èµ„æºåº”è¯¥æ˜¯å¯ä»¥é€šè¿‡ä»¥ <code>/azurlane_spinepainting/</code> ä¸ºå‰ç¼€çš„é“¾æ¥è®¿é—®åˆ°çš„, å°±æ˜¯é€Ÿåº¦æœ‰ç‚¹æ…¢, åŠ ä¸Šèµ„æºæœ¬èº«ä¹Ÿå¤§, åŠ è½½ä¸€ä¸ªçš®è‚¤å¾ˆå¯èƒ½è¦ä¸ªä¸€ä¸¤åˆ†é’Ÿ, åŒæ—¶ç”±äºä¸å¯æŠ—åŠ›è¿˜å¯èƒ½è®¿é—®å¤±è´¥, å¼ºçƒˆå»ºè®®ç§‘å­¦ä¸Šç½‘è®¿é—®.</p>
<h3 id="å‰ç«¯é¡µé¢"><a href="#å‰ç«¯é¡µé¢" class="headerlink" title="å‰ç«¯é¡µé¢"></a>å‰ç«¯é¡µé¢</h3><p>è¯´å®è¯å‡ ä¹æ²¡æ€ä¹ˆå†™è¿‡å‰ç«¯, å› æ­¤ gpt ç®€ç›´æ•‘æˆ‘ç‹—å‘½, ä¸ç„¶ä¸çŸ¥é“è¦å†™åˆ°çŒ´å¹´é©¬æœˆå»äº†.</p>
<p>ä¸€ç•ªæ€ç´¢å†³å®šåœ¨ç°æœ‰çš„ Markdown æ–‡ä»¶é‡Œå†™ html, ä¸å•ç‹¬å†™é¡µé¢, è¿™æ ·èƒ½æœ‰æ•ˆåˆ©ç”¨åšå®¢ç°æˆçš„ä¸»é¢˜.</p>
<p>é¡µé¢å¤§æ¦‚åˆ†ä¸Šä¸‹ä¸¤éƒ¨åˆ†, ç¬¬ä¸€éƒ¨åˆ†æ˜¯ <code>èˆ¹å_çš®è‚¤å</code> è¿™æ ·çš„é“¾æ¥åˆ—è¡¨, ç¬¬äºŒéƒ¨åˆ†æ˜¯ä¸€ä¸ª <code>canvas</code> å…ƒç´ çš„é¢„è§ˆç”»é¢, ç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»çš®è‚¤é“¾æ¥æ¥åŠ è½½å¹¶åˆ‡æ¢ä¸‹é¢çš„é¢„è§ˆç”»é¢.</p>
<p>çš®è‚¤åˆ—è¡¨ç”¨ js åŠ¨æ€ç”Ÿæˆ, ä¸è¿‡ä¹Ÿè¿˜æ˜¯éœ€è¦è‡ªå·±åœ¨ä»£ç é‡Œå›ºå®šä¸€ä¸ªæ˜ å°„è¡¨, æä¾›åç§°ä»¥åŠèµ„æºä½ç½®å•¥çš„.</p>
<p>é¢„è§ˆç•Œé¢å‡ ä¹æ˜¯åŸå°ä¸åŠ¨ç…§ç€ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Vzb3RlcmljU29mdHdhcmUvc3BpbmUtcnVudGltZXMvYmxvYi8zLjgvc3BpbmUtdHMvd2ViZ2wvZXhhbXBsZS9pbmRleC5odG1s">spine-webgl<i class="fa fa-external-link-alt"></i></span> çš„æ ·ä¾‹å®ç°çš„, ä½†æ˜¯é‡æ–°å°è£…äº†éƒ¨åˆ†åŠŸèƒ½, ä¾‹å¦‚æ”¯æŒå¤šä¸ªéª¨éª¼æŒ‰åºæ¸²æŸ“, å¹¶ä¸”è°ƒæ•´äº†ç”»é¢å‚æ•°.</p>
<p>é¢„è§ˆç”»é¢ä¹Ÿå®ç°äº†ä¸€äº›äº¤äº’åŠŸèƒ½, ä¾‹å¦‚ PC ä¸Šå¯ä»¥ç”¨é¼ æ ‡æ‹–åŠ¨ç¼©æ”¾, ç§»åŠ¨è®¾å¤‡ä¹Ÿå¯ä»¥ç”¨æ‰‹åŠ¿åŠ¨ä½œè¿›è¡Œæ‹–åŠ¨ç¼©æ”¾, ä¹Ÿæ”¯æŒé€‰æ‹©æŸ¥çœ‹æ¨¡å‹ä¸‹ä¸åŒçš„åŠ¨ç”».<del>æ¯•ç«Ÿéƒ¨åˆ†åŠ¨ç»˜çš®è‚¤ä¹Ÿæœ‰ç‰¹è§¦.</del></p>
<h2 id="é¡µé¢æ•ˆæœ"><a href="#é¡µé¢æ•ˆæœ" class="headerlink" title="é¡µé¢æ•ˆæœ"></a>é¡µé¢æ•ˆæœ</h2><p>æœ€åçš„æ•ˆæœå¤§æ¦‚é•¿è¿™æ ·:</p>
<p><img data-src="/static/image/spinejs-azurlane/page-preview.jpg" alt="page-preview.jpg"></p>
<p><img data-src="/static/image/spinejs-azurlane/canvas-preview1.gif" alt="page-preview1.gif"></p>
<p><img data-src="/static/image/spinejs-azurlane/canvas-preview2.gif" alt="page-preview2.gif"></p>
<p><img data-src="/static/image/spinejs-azurlane/canvas-preview3.gif" alt="page-preview3.gif"></p>
<h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><p>ä¹Ÿç®—æ˜¯ä¸ªå°çš„å‰ç«¯é¡¹ç›®? æºç éƒ½åœ¨åšå®¢ä»“åº“çš„ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL3d3LXJtLmdpdGh1Yi5pby90cmVlL21haW4vc291cmNlL2F6dXJsYW5l">source/azurlane<i class="fa fa-external-link-alt"></i></span> è·¯å¾„ä¸‹ (æœªæ¥å¯èƒ½ä¼šæŒªä½ç½®, ä½†æ˜¯åæ­£éƒ½åœ¨è¿™ä¸ªä»“åº“).</p>
<p>åŸºæœ¬ä¸Šéƒ½æ˜¯å’Œ gpt äº¤äº’ç„¶åæ”¹å‡ºæ¥çš„ä»£ç , ä¸å¾—ä¸è¯´ gpt çœŸæ˜¯å†™å‰ç«¯åˆ©å™¨.</p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p>ç«‹ç»˜èµ„æºåœ¨ä»“åº“ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL2F6dXJsYW5lX3NwaW5lcGFpbnRpbmc=">azurlane_spinepainting<i class="fa fa-external-link-alt"></i></span>.</p>
<p>ä¸è¿‡ç½‘é¡µç«¯åŠŸèƒ½å’Œæ€§èƒ½éƒ½æœ‰é™, è¿™é‡Œè¶æœºæ¨é”€ä¸€ä¸‹è‡ªå·±çš„å°é¡¹ç›® <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL0Rlc2tTcGluZQ==">DeskSpine<i class="fa fa-external-link-alt"></i></span>, ç›®å‰è¿˜æ²¡å½»åº•å®Œå·¥<del>å’•å’•å’•</del>, ä½†æ˜¯åŸºæœ¬åŠŸèƒ½å·²ç»å·®ä¸å¤šäº†<del>èƒ½ç”¨</del>, æ˜¯æˆ‘åŸºäºè¿‡å»é¡¹ç›® <a href="/posts/2023/08/30/desktopsprite/">DesktopSprite</a> ç”¨ C# é‡å†™çš„, ä½¿ç”¨æ–¹æ³•ä¸Šä¹Ÿå·®ä¸å¤š, ä½†æ˜¯æ¯”ä¹‹å‰æ€§èƒ½å¥½ä¸Šå¾ˆå¤š<del>bugä¹Ÿå°‘å¾ˆå¤š</del>, ä¹Ÿå¢åŠ äº†ä¸€äº›æ›´å¥½ç”¨çš„åŠŸèƒ½, æ¬¢è¿æœ‰å…´è¶£çš„æŒ‡æŒ¥å®˜å‰æ¥ä½“éªŒ.    </p>
]]></content>
      <categories>
        <category>ç è®°</category>
      </categories>
      <tags>
        <tag>ç¢§è“èˆªçº¿</tag>
        <tag>spine</tag>
        <tag>spine-js</tag>
        <tag>Azur Lane</tag>
        <tag>åŠ¨æ€ç«‹ç»˜</tag>
        <tag>å‰ç«¯</tag>
      </tags>
  </entry>
  <entry>
    <title>è…¾è®¯æµ‹è¯•å¼€å‘å®ä¹ é¢è¯•ç»éªŒåˆ†äº«</title>
    <url>//posts/2024/03/19/tencent-intership-interview/</url>
    <content><![CDATA[<p>è…¾è®¯ IEG 25 å±Šæµ‹è¯•å¼€å‘å®ä¹ ç”Ÿé¢è¯•ç»éªŒåˆ†äº«.</p>
<span id="more"></span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¯’å‡å‰å‘äº†ä¸€ä¸ªè…¾è®¯çš„ä¸“é¡¹å®ä¹ é€šçŸ¥, æ—¶é—´å¾ˆæ—©, 2æœˆåº•å°±å¼€å§‹æŠ•äº†.</p>
<p>ç„¶è€Œå¯’å‡è¿˜æ˜¯æ‘¸äº†ä¸€ä¸ªæœˆçš„é±¼, ä¸è¿‡æŠ±ç€è¯•ä¸€è¯•çš„å¿ƒæ€, æœˆåº•è¿˜æ˜¯æŠ•äº†ä¸€ä¸‹æµ‹è¯•å¼€å‘, æ¯•ç«ŸåŠ›æ‰£æ‰åˆšå¼€å§‹åˆ·, å…«è‚¡ä¸€è¡Œæ²¡çœ‹, å¿ƒé‡Œç€å®æ…Œå¾—å¾ˆ, è€Œä¸”è¿˜æ˜¯ç¬¬ä¸€æ¬¡é¢è¯•. è™½ç„¶åœ¨æ­¤ä¹‹å‰å¶å°”åˆ·åˆ°è¿‡ä¸€äº›é¢ç», ä½†æ˜¯çœŸçš„è½®åˆ°è‡ªå·±çš„æ—¶å€™, è¿˜æ˜¯å¾ˆç´§å¼ çš„.</p>
<p>æŠ•äº†ç®€å†ä¹‹å, è¦å…ˆåšä¸€ä¸ªæµ‹è¯„, å¿…é¡»è¦åšäº†æ‰èƒ½è¿›ä¸‹ä¸€ä¸ªæµç¨‹.</p>
<p>æµ‹è¯„åˆ†ä¸‰éƒ¨åˆ†:</p>
<ol>
<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸€å¤§å †é€‰æ‹©é¢˜åŠ ä¸€é“ç®€ç­”é¢˜, å°±æ˜¯ä¸€äº›èŒåœºåœºæ™¯é¢˜, æŒ‰è‡ªå·±æƒ³æ³•æ…¢æ…¢åšå°±è¡Œäº†.</li>
<li>ç¬¬äºŒéƒ¨åˆ†å’Œç¬¬ä¸€éƒ¨åˆ†å·®ä¸å¤š, ä½†æ˜¯åªæœ‰é€‰æ‹©é¢˜.</li>
<li>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯æ™ºåŠ›é¢˜, å’Œå…¬åŠ¡å‘˜çš„è¡Œæµ‹å·®ä¸å¤š, è¯´å®è¯æˆ‘å‡ ä¹éƒ½æ˜¯è’™çš„, ä½†æ˜¯é—®é¢˜ä¸å¤§.</li>
</ol>
<p>ä¸‰éƒ¨åˆ†å¯ä»¥åˆ†å¼€åš, ä¸è¿‡ç¡®å®è¦ä¸€ç‚¹è€å¿ƒå’Œæ—¶é—´, æ€»å…±åšäº† 30 + 30 + 30 = 90 åˆ†é’Ÿçš„æ—¶é—´.</p>
<p>åšå®Œä¹‹åå°±å¯ä»¥ç­‰ç€é¢è¯•é‚€è¯·å‡½äº†, é‚®ç®±å’ŒçŸ­ä¿¡éƒ½ä¼šæœ‰é€šçŸ¥.</p>
<p>2 æœˆåº•åšçš„æµ‹è¯„, 3 æœˆåˆæ”¶åˆ°çš„é¢è¯•é‚€è¯·å‡½, ä¸­é—´éš”äº† 5 å¤©å·¦å³, æ‰€ä»¥è¿˜æ˜¯è¦ç¨å¾®ç­‰ä¸€ç­‰.</p>
<p>ä¸‹é¢è¿›æ­£æ–‡. ä¿¡æ¯å‘å¸ƒç¾¤é‡Œçš„ç›¸å…³è´Ÿè´£äººè¯´è¿™ä¸€æ¬¡æŠ•é€’ç›¸å½“äºæ˜¯å®ä¹ çš„æå‰æ‰¹, å› æ­¤å¯èƒ½é¢è¯•æµç¨‹çœ‹ä¸Šå»æ¯”ç§‹æ‹›ç´§å‡‘å¾ˆå¤š, æ€»å…± 3 è½®:</p>
<ol>
<li>åˆè¯• (ç¨‹åºé¢). å…¶å®å°±æ˜¯æŠ€æœ¯é¢.</li>
<li>å¤è¯• (åˆè¯•). ä¹Ÿæ˜¯æŠ€æœ¯é¢.</li>
<li>HR é¢è¯• (å¤è¯•). å’Œ HR èŠå¤©ç¯èŠ‚.</li>
</ol>
<h2 id="åˆè¯•"><a href="#åˆè¯•" class="headerlink" title="åˆè¯•"></a>åˆè¯•</h2><p>æ”¶åˆ°é‚€è¯·å‡½åä¸€å¤©è¿›è¡Œä¸€é¢.</p>
<h3 id="ç®—æ³•é¢˜"><a href="#ç®—æ³•é¢˜" class="headerlink" title="ç®—æ³•é¢˜"></a>ç®—æ³•é¢˜</h3><p>å¼€å§‹é¢è¯•ä¹‹å, é¢è¯•å®˜ç®€å•é—®äº†ä¸€ä¸‹å¹³å¸¸ç”¨ä»€ä¹ˆè¯­è¨€å±…å¤š, ç”µè„‘ä¸Šæ˜¯ä¸æ˜¯è£…äº†å¯¹åº”çš„ IDE, ç„¶åå‘äº†ä¸¤é“é¢˜è¯´å…ˆåšä¸€ä¸‹, ç»™äº† 1 ä¸ªå°æ—¶çš„æ—¶é—´.</p>
<p>é¢˜ç›®å¯ä»¥åœ¨è‡ªå·±ç”µè„‘å†™å¹¶ä¸”è°ƒè¯•, è¿™ä¸€ç‚¹ç›¸å½“å‹å¥½, æœ‰ç†Ÿæ‚‰çš„ç¯å¢ƒå’Œå·¥å…·ç¡®å®å†™èµ·æ¥å‹åŠ›å°å¾ˆå¤š.</p>
<p>ä½†æ˜¯è…¾è®¯ä¼šè®®è¿œç¨‹é¢è¯•, è¿™ä¸€é¢æˆ‘å…¨ç¨‹éƒ½æ˜¯å…±äº«æ¡Œé¢å’Œå¼€ç€è§†é¢‘çš„, å› æ­¤å¤§ä¼™ä¹Ÿä¸è¦æœ‰ä»€ä¹ˆä¾¥å¹¸å¿ƒç†, å†·é™ä¸‹æ¥è®¤çœŸå†™ä»£ç å°±è¡Œäº†.</p>
<p>é¢˜ç›®ä¸éš¾, å°±æ˜¯é€‰çš„åŠ›æ‰£ä¸¤é“ä¸­ç­‰é¢˜, ä¸€é“æ˜¯å¾ˆç»å…¸çš„åŠ¨æ€è§„åˆ’, è™½ç„¶ä¹‹å‰æ²¡å†™è¿‡ä½†æ˜¯å¾ˆç†Ÿæ‚‰è§£æ³•, å¾ˆå¿«å°±è§£å†³äº†.</p>
<p>å¦å¤–ä¸€é“æ˜¯ä¸€ä¸ªåŒæŒ‡é’ˆé¢˜, å¥½æ¶ˆæ¯æ˜¯, å®ƒåœ¨æˆ‘ä»…æœ‰çš„åˆ·äº†çš„å‡ åé“é¢˜ç›®é‡Œ. ä¸è¿‡åæ¶ˆæ¯æ˜¯, å½“æ—¶åˆ·çš„æ—¶å€™æ˜¯ä¸´æ—¶æƒ³å‡ºæ¥çš„å¥‡æ€ªæ–¹æ³•, é¢è¯•çš„æ—¶å€™å·²ç»å®Œå…¨å¿˜è®°å½“æ—¶å’‹å†™çš„äº†.<del>å¥½åœ¨æœ€åå‡­å€Ÿæ¨¡ç³Šçš„è®°å¿†åˆä¸´æ—¶æƒ³å‡ºæ¥ä¸€ä¸ªæ–¹æ³•, ä»¥è‡³äºé¢è¯•å®˜ä¸“é—¨è¦æˆ‘è®²äº†ä¸€ä¸‹è¿™é¢˜æ€è·¯.</del></p>
<p>æ€»å…±èŠ±äº†å¤§æ¦‚åŠä¸ªå°æ—¶å§, æŠŠä¸¤é“é¢˜å†™å®Œä¹‹å, é¢è¯•å®˜ä¼šè‡ªå·±é˜…è¯»ä»£ç , å¹¶ä¸éœ€è¦æäº¤ç„¶åæµ‹è¯•æ ·ä¾‹æˆ–è€…è®²è§£æ€è·¯å•¥çš„, ä¸»è¦æ˜¯çœ‹ä½ çš„ä»£ç ä¹¦å†™ä¹ æƒ¯, ä»¥åŠä½ ç®—æ³•æ€è·¯çš„æ­£ç¡®æ€§, å½“ç„¶ä½ è‡ªå·±è‚¯å®šå¾—æŠŠé¢˜é¢é‡Œç»™çš„å‡ ä¸ªç®€å•ä¾‹å­éªŒè¯ä¸€ä¸‹.<del>æµ‹å¼€ä¸æµ‹è¯•è¿™åˆç†å—</del>.</p>
<p>å»ºè®®å¤§å®¶å…»æˆè‰¯å¥½çš„ä»£ç é£æ ¼, å¹³å¸¸å¤šæ³¨é‡ä»£ç çš„å¯é˜…è¯»æ€§, èƒ½è®©äººæ¯”è¾ƒå®¹æ˜“çš„çœ‹æ¸…ä½ çš„ä»£ç æ€è·¯. å…±äº«å±å¹•è®©é¢è¯•å®˜çœ‹ç€å†™ä»£ç è¿˜æ˜¯æœ‰ç‚¹å‹åŠ›çš„<del>ç›¸å½“äºæœ‰äººçœ‹ç€ä½ å†™æ•°å­¦é¢˜</del>, ä»£ç å†™çš„æ¸…æ¥šç‚¹å°±ç®—æœ€åæ²¡åšå‡ºæ¥ä¹Ÿèƒ½å’Œé¢è¯•å®˜äº¤æµè‡ªå·±çš„æ€è·¯, ä¸è‡³äºå•¥å¥½å°è±¡éƒ½æ²¡æœ‰.</p>
<h3 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h3><p>å†™å®Œä»£ç ä¹‹åå¼€å§‹é—®å…«è‚¡äº†, æ€»ç»“ä¸º: çœŸå«äººæ‘¸ä¸ç€å¤´è„‘.jpg</p>
<p>å…¶å®é—®çš„é—®é¢˜éƒ½ä¸éš¾, çœŸä¸éš¾, ä½†æ˜¯æ— å¥ˆæˆ‘ä¹Ÿæ˜¯çœŸæ²¡å‡†å¤‡, ä¸€ä¸ç‚¹éƒ½æ²¡å‡†å¤‡çš„é‚£ç§.</p>
<p>ä¸Šæ¥å°±æ˜¯å‡ ä¸ªæ“ä½œç³»ç»Ÿç›¸å…³çš„é—®é¢˜, æˆ‘æœ€è¿‘ä¸€æ¬¡å­¦æ“ä½œç³»ç»Ÿè¿˜æ˜¯å¤§äºŒçš„æ—¶å€™, å’±å°±æ˜¯è¯´, çœŸä¸è®°å¾—å•¥äº†.</p>
<p>é—®äº†è¿›ç¨‹æ€ä¹ˆç®¡ç†çš„, è¿›ç¨‹å’Œçº¿ç¨‹åŒºåˆ«, è™šæ‹Ÿå†…å­˜æ€ä¹ˆç®¡ç†çš„, å †å’Œæ ˆçš„åŒºåˆ«, çº¿ç¨‹åŒæ­¥çš„æ–¹æ³•.</p>
<p>æˆ‘åªèƒ½å‡­ç€è®°å¿†å‹‰å¼ºç­”ä¸€ä¸‹, ä¹Ÿå°±ä¸€äº›åŸºæœ¬æ¦‚å¿µå§.<del>ç”šè‡³è™šæ‹Ÿå†…å­˜è¿æ¦‚å¿µéƒ½ä¸è®°å¾—äº†.</del></p>
<p>ç„¶åè¿˜é—®äº†ä¸€äº›å…¶ä»–çš„, æ¯”å¦‚å¿«é€Ÿæ’åºæ€ä¹ˆå®ç°çš„, è´Ÿæ•°æ˜¯å¦‚ä½•è¡¨ç¤ºçš„, å…ˆè¿›å…ˆå‡ºå’Œåè¿›å…ˆå‡ºçš„åŒºåˆ«, ç”šè‡³è¿˜é—®äº†ä¸€ä¸‹çŸ¥ä¸çŸ¥é“å…³ç³»æ•°æ®åº“çš„èŒƒå¼æ˜¯ä»€ä¹ˆ.<del>å…«ç™¾å¹´å‰å­¦çš„ä¸œè¥¿äº†, æˆ‘ä»…å­˜çš„è®°å¿†å‘Šè¯‰æˆ‘ä¼¼ä¹æ˜¯ç”¨åœ¨è¡¨è®¾è®¡çš„æ—¶å€™å‡å°‘å†—ä½™æé«˜æ•ˆç‡çš„.</del></p>
<p>ä¸è¿‡è¿™ä¸€é¢æ˜¯æŠ€æœ¯é¢, é¢è¯•å®˜ä¹Ÿæ˜¯æ‡‚çš„, ä¹Ÿä¸ä¼šå¯¹ç€æ ‡å‡†ç­”æ¡ˆæ­»æŠ å®šä¹‰, ä½ æ¸…æ¥šè¿™ä¸ªçŸ¥è¯†ç‚¹çš„è¯, é¢è¯•å®˜å¬äº†è‡ªç„¶æ˜ç™½, å°½é‡æŠŠè‡ªå·±ä¼šçš„å†…å®¹æ¸…æ¥šçš„è¡¨è¿°å‡ºæ¥å°±è¡Œ, ä¸ä¼šçš„ä¹Ÿå°±è¯´è‡ªå·±å¯¹è¿™æ–¹é¢åº”ç”¨çš„å°‘, ä¸æ˜¯å¾ˆäº†è§£.</p>
<h3 id="é¡¹ç›®ç»å†"><a href="#é¡¹ç›®ç»å†" class="headerlink" title="é¡¹ç›®ç»å†"></a>é¡¹ç›®ç»å†</h3><p>ç”±äºæˆ‘æ²¡æœ‰å®ä¹ ç»å†, æ‰€ä»¥æ¥ä¸‹æ¥å°±ç›´æ¥é—®ç®€å†ä¸Šçš„é¡¹ç›®.<del>å®³, ä¹‹å‰çœ‹ç¾¤é‡Œè¯´ä¸€é¢å¯èƒ½å°±æ˜¯æ’•å‡ é“é¢˜, ç»“æœè‡ªå·±å®Œå…¨æ²¡çœ‹ä¸€ä¸‹é¡¹ç›®å†…å®¹, éƒ½å¿˜å¾—å·®ä¸å¤šäº†.</del></p>
<p>æˆ‘å†™äº† 4 ä¸ªä¸Šå», 2 ä¸ªä¸ªäººé¡¹ç›®, 2 ä¸ªå›¢é˜Ÿåˆä½œé¡¹ç›®.</p>
<p>é¢è¯•å®˜é¦–å…ˆé—®è§‰å¾—è¿™å‡ ä¸ªé¡¹ç›®é‡Œéš¾åº¦æœ€é«˜çš„æ˜¯å“ªä¸ª, èƒ½å¦ä»‹ç»ä¸€ä¸‹é¡¹ç›®å†…å®¹.</p>
<p>æˆ‘è¯´äº†ä¸€ä¸ªä¸ªäººé¡¹ç›®, <a href="/posts/2023/08/30/desktopsprite/">åŸºäº Spine çš„ç¢§è“èˆªçº¿æ¡Œå® </a>, è¿™ä¸ªæ˜¯å½“æ—¶è‡ªå·±æ„Ÿå…´è¶£åšçš„, è™½ç„¶æ˜¯åŸºäºå­¦ä¹ çš„å¿ƒæ€åšçš„è‡ªå¨±è‡ªä¹ç¨‹åº, ä½†æ˜¯ç¡®å®å¯¹æˆ‘æ¥è¯´æŒºéš¾çš„, å› ä¸ºä¸“ä¸šä»æœªæ¥è§¦è¿‡è®¡ç®—æœºå›¾å½¢å­¦ç›¸å…³çš„å†…å®¹, è€Œä¸”ä¹Ÿè‡ªå­¦äº†ä¸€ä¸‹åŸç”Ÿçš„ win32 å¼€å‘, æœŸé—´è¿˜é‡åˆ°ä¸€äº›æ•°å­¦é—®é¢˜, éƒ½æŠ˜è…¾äº†æŒºä¹…çš„.</p>
<p>ä»‹ç»äº†ä¸€ä¸‹ä¸ºä»€ä¹ˆåšè¿™ä¸ªé¡¹ç›®, é¡¹ç›®å®ç°äº†äº›å•¥, è§‰å¾—æœ€éš¾çš„åœ°æ–¹åœ¨å“ª, æ€ä¹ˆè§£å†³çš„è¯¸å¦‚æ­¤ç±»çš„.</p>
<p>ä¸»è¦è¿˜æ˜¯è¦ç†Ÿæ‚‰è‡ªå·±çš„é¡¹ç›®, å‘é¢è¯•å®˜å……åˆ†å±•ç¤ºè‡ªå·±çš„èƒ½åŠ›æ°´å¹³, ä¸è¦è®©é¢è¯•å®˜è§‰å¾—å°±æ˜¯ç…§ç€ç½‘ä¸Šçš„æ•™ç¨‹éšä¾¿åšåšäº†äº‹, è¦èƒ½ä½“ç°è‡ªå·±åœ¨åšè¿™ä¸ªé¡¹ç›®é€”ä¸­è§£å†³é—®é¢˜çš„èƒ½åŠ›, ä»¥åŠå¯¹è‡ªå·±çš„æå‡æ”¶è·.</p>
<p>ä¸è¿‡è¿æ°”æ¯”è¾ƒå¥½çš„æ˜¯, ç”±äºè¿™ä¸€é¢è¿œç¨‹é¢è¯•æˆ‘ä¸€å¼€å§‹æ˜¯å…±äº«å±å¹•çš„, åŠ ä¹‹è¿™ä¸ªé¡¹ç›®æ˜¯ä¸ªæ¡Œå® , å¾ˆé€‚åˆå±•ç¤º, è‡ªå·±ç”µè„‘ä¸Šä¹Ÿä¸€ç›´åœ¨ç”¨, æºç ä¹Ÿéƒ½è¿˜åœ¨, æ‰€ä»¥å°±ç›´æ¥ç»™é¢è¯•å®˜å±•ç¤ºé¡¹ç›®æ•ˆæœäº†. é¡ºå¸¦è¿æºç éƒ½ä¸€èµ·è¢«çœ‹äº†ä¸€ä¸‹, é—®äº†ä¸€äº›å…·ä½“é€»è¾‘çš„å®ç°æ–¹æ³•å’Œç±»çš„è®¾è®¡.</p>
<p>è¿™ä¸ªé¡¹ç›®é—®å®Œä¹‹åè¿˜é—®äº†å…¶ä»–çš„é¡¹ç›®, è¿™ä¸ªçœ‹å…·ä½“æƒ…å†µå§, è®¤çœŸç­”å°±å¥½äº†.<del>ä¹Ÿçœ‹è‡ªå·±çš„å¹ç‰›èƒ½åŠ›.</del></p>
<h3 id="åˆè¯•å°¾å£°"><a href="#åˆè¯•å°¾å£°" class="headerlink" title="åˆè¯•å°¾å£°"></a>åˆè¯•å°¾å£°</h3><p>æœ€åæœ‰ä¸€äº›ç»å…¸çš„åé—®ç¯èŠ‚, ä¸è¿‡æˆ‘å½“æ—¶å¤ªç´§å¼ äº†, ä¹Ÿæ²¡é—®å•¥, åå€’æ˜¯é¢è¯•å®˜å¼•å¯¼æˆ‘æ˜¯ä¸æ˜¯è¦äº†è§£ç‚¹ä»€ä¹ˆ.</p>
<p>å…¶å®äº‹åæƒ³æƒ³ä»¥åå¯ä»¥æå‰å‡†å¤‡ä¸€ä¸‹çš„, æ¯•ç«Ÿä½ æŠ•äº†ç®€å†, è‚¯å®šæœ‰ä¸€äº›æƒ³è¦äº†è§£çš„åŸºæœ¬æƒ…å†µå¯¹å§.</p>
<h2 id="å¤è¯•"><a href="#å¤è¯•" class="headerlink" title="å¤è¯•"></a>å¤è¯•</h2><p>ç»“æœå‡ºçš„å¾ˆå¿«, åˆšé¢å®Œæ™šä¸Šå°±æ”¶åˆ°å¤è¯•é‚€è¯·å‡½äº†, äºæ˜¯ç›´æ¥çº¦çš„åä¸€å¤©ç»§ç»­äºŒé¢.</p>
<h3 id="è‡ªæˆ‘ä»‹ç»"><a href="#è‡ªæˆ‘ä»‹ç»" class="headerlink" title="è‡ªæˆ‘ä»‹ç»"></a>è‡ªæˆ‘ä»‹ç»</h3><p>ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±, å­¦æ ¡, ä¸“ä¸š, ç ”ç©¶æ–¹å‘, ä¸ªäººèƒ½åŠ›, å®ä¹ ç»å†, é¡¹ç›®ç»å† (å…¶å®å°±æ˜¯æŠŠè‡ªå·±ç®€å†ä¸Šçš„å†…å®¹è¿‡ä¸€é, åªæ˜¯æˆ‘æ²¡ç»éªŒ, ç»“æœè¢«åŠ¨çš„ç­‰ç€é¢è¯•å®˜é—®ç»å†äº†, æ²¡æŠŠè¯é¢˜èŠå¼€).</p>
<p>ç»å†ç®€å•æè¿°ä¸€ä¸‹å°±å¥½, å¯ä»¥ç­‰å¾…é¢è¯•å®˜åç»­æé—®, ä¹Ÿå¯ä»¥è‡ªå·±ä¸»åŠ¨ä»‹ç»è¯¦ç»†ä¸€ç‚¹, çªå‡ºè‡ªå·±çš„æŠ€æœ¯æ ˆ.</p>
<h3 id="è‡ªç”±äº¤æµ"><a href="#è‡ªç”±äº¤æµ" class="headerlink" title="è‡ªç”±äº¤æµ"></a>è‡ªç”±äº¤æµ</h3><p>å¦‚æœè¯´ä¸€é¢æ³¨é‡ä½ çš„è¡¨é¢èƒ½åŠ›, æ¯”å¦‚å…·ä½“çš„ä»£ç èƒ½åŠ›, é¡¹ç›®ç»å†, é‡åŒ–çš„æŒ‡æ ‡å•¥çš„, é‚£ä¹ˆè¿™ä¸€é¢ä¾§é‡äºä½ çš„ç»¼åˆèƒ½åŠ›.</p>
<p>ä»è‡ªæˆ‘ä»‹ç»å¼€å§‹, æœ€å¥½çš„æ–¹å¼æ˜¯ä½ æœ‰æ‰€ä¾§é‡çš„ä»‹ç»è‡ªå·±, ç„¶åè®©é¢è¯•å®˜èƒ½å¤Ÿè‡ªç„¶è€Œç„¶çš„åˆ‡å…¥åˆ°ä¸€ä¸ªä½ ç†Ÿæ‚‰çš„è¯é¢˜é‡Œ, æ¯”å¦‚ä½ ä»‹ç»åˆ°æŸä¸ªé¡¹ç›®ç»å†æ—¶, å¯ä»¥å…ˆå‘åˆ¶äººè¯´è¯´è‡ªå·±å°è±¡å¾ˆæ·±çš„ç‚¹, é‡‡ç”¨äº†ä»€ä¹ˆæŠ€æœ¯, æŒæ¡äº†ä»€ä¹ˆæŠ€èƒ½, ä¹‹åé¢è¯•å®˜å°±ä¼šä»¥æ­¤ä¸ºè¯é¢˜ç»§ç»­æ·±å…¥äº†è§£ä½ çš„èƒ½åŠ›.<del>åˆ«åƒæˆ‘ä¸€æ ·å‚»ä¸æ‹‰å‡ çš„.</del></p>
<p>ä¸åŒäºä¸€é¢, è¿™ä¸€é¢é—®é¢˜éƒ½æ¯”è¾ƒå‘æ•£å¹¶æ·±å…¥, å…¶å®ä¹Ÿæ›´åŠ æ³¨é‡äºå°†æ¥çš„å·¥ä½œå†…å®¹, ä¾‹å¦‚æˆ‘æŠ•çš„æ˜¯æµ‹è¯•å¼€å‘, é™¤äº†é—®æˆ‘é¡¹ç›®çš„æŠ€æœ¯é—®é¢˜å¤–, è¿˜ä¼šç€é‡é—®æˆ‘é¡¹ç›®çš„æ€§èƒ½ä¼˜åŒ–, å¦‚ä½•å‡å°‘èµ„æºå ç”¨, å¦‚ä½•è®©æ•´ä¸ªé¡¹ç›®ç»“æœæ›´å¥½, è€Œä¸ä»…ä»…æ˜¯å®ç°åŠŸèƒ½.</p>
<p>åŒæ—¶é—®é¢˜ä¹Ÿæ›´åå‘å®é™…å·¥ç¨‹åº”ç”¨, å¹¶ä¸åªæ˜¯å•çº¯å®ç°ä¸€ä¸ªç®—æ³•ç‰‡æ®µ, è€Œæ˜¯è¦å¯¹é¡¹ç›®çš„æ•´ä½“ç»“æ„æœ‰æ¸…æ™°çš„è®¤çŸ¥, çŸ¥é“é¡¹ç›®çš„ç“¶é¢ˆåœ¨å“ª, è‡ªå·±åˆæ˜¯å¦‚ä½•è€ƒè™‘è§£å†³çš„.</p>
<p>æ‹¿æˆ‘å‰é¢é‚£ä¸ªæ¡Œå® é¡¹ç›®æ¥è¯´, é¢è¯•å®˜é™¤äº†é—®åŸºæœ¬çš„é¡¹ç›®é€»è¾‘å¤–, ç€é‡é—®äº†æ˜¯å¦å…³æ³¨è¿‡ç¨‹åºçš„æ€§èƒ½ä¼˜åŒ–, å¦‚ä½•ä¼˜åŒ–æ¸²æŸ“è¿‡ç¨‹ä¸­ CPU, å†…å­˜, GPU çš„å ç”¨é—®é¢˜, å¦‚ä½•æé«˜æ¸²æŸ“çš„æ€§èƒ½. ä¸è¿‡æˆ‘æ²¡æœ‰ç³»ç»Ÿæ€§å­¦ä¹ è¿‡, å¯¹è¿™äº›å†…å®¹åªèƒ½å°½é‡ç­”ä¸€äº›, å¹¶ä¸”æœ‰äº›æ–¹é¢æˆ‘ä¹Ÿç¡®å®ä»æ²¡è€ƒè™‘è¿‡ (ä¾‹å¦‚å†…å­˜å ç”¨, æ¡Œå® å ç”¨å¤ªå°å®Œå…¨æ²¡è€ƒè™‘è¿‡).</p>
<p>æ„Ÿè§‰è¿˜æ˜¯æŒºæ³¨é‡ç¨‹åºæ€§èƒ½çš„, å¯èƒ½æ˜¯æ¸¸æˆæµ‹å¼€çš„åŸå› ?</p>
<p>è¿™éƒ¨åˆ†å†…å®¹å¤ªè‡ªç”±äº†, éƒ½æ˜¯æ€æƒ³ä¸Šçš„äº¤æµ, å¯å‚è€ƒæ€§å¾ˆä½, æ¯”è¾ƒçœ‹é¢è¯•å®˜, è®¤çœŸå›ç­”è‡ªå·±çš„æ€è€ƒç»“æœå°±å¥½äº†.</p>
<h3 id="åœºæ™¯é¢˜"><a href="#åœºæ™¯é¢˜" class="headerlink" title="åœºæ™¯é¢˜"></a>åœºæ™¯é¢˜</h3><p>èŠå®Œç®€å†ä¸Šçš„å†…å®¹ä¹‹å, è¿˜æ˜¯æ¥äº†é“åœºæ™¯é¢˜.</p>
<p>å…·ä½“çš„åœºæ™¯å°±ä¸è¯´äº†, æŠ½è±¡ä¸€ä¸‹å°±æ˜¯, æœ‰ä¸€ç¾¤äºº, ä»–ä»¬ä¹‹é—´å­˜åœ¨å¥½å‹å…³ç³», å‡è®¾è¿™ç¾¤äººä¸€å®šå¯ä»¥è¢«åˆ’åˆ†æˆä¸¤ä¸ªé›†åˆ, å¹¶ä¸”æ¯ä¸ªé›†åˆå†…çš„äººäº’ç›¸ä¸å­˜åœ¨å¥½å‹å…³ç³», è¦å¦‚ä½•å®ç°è¿™ä¸ªåˆ’åˆ†è¿‡ç¨‹.</p>
<p>å®³, è¯´å®è¯æˆ‘ä¸€å¼€å§‹æ¯«æ— å¤´ç»ª, ç„¶åæƒ³äº†åŠå¤©ç»™äº†ä¸€ä¸ªæ—¶é—´å’Œç©ºé—´å¤æ‚åº¦éƒ½å¾ˆé«˜çš„æ–¹æ³•, æ˜¾ç„¶æ˜¯ä¸å¤ªè¡Œçš„. ä¹‹åå°±æ˜¯å’Œé¢è¯•å®˜ç»§ç»­äº¤æµ, æ€ä¹ˆä¼˜åŒ–ç®—æ³•. è¿™æœŸé—´æˆ‘ä¹±æ‰¯äº†å¾ˆå¤š, ä½†æ˜¯ä¼°è®¡éƒ½æ²¡æ‰¾åˆ°æ­£é“. æœ€åæ—¶é—´å¿«åˆ°äº†, æˆ‘è¯´æˆ‘æ„Ÿè§‰æš‚æ—¶æƒ³ä¸å‡ºæ¥æ›´å¥½çš„æ–¹æ¡ˆäº†, é¢è¯•å®˜ä¹Ÿå°±ç»“æŸè¿™éƒ¨åˆ†äº†.</p>
<p>æ„Ÿè§‰è¿™éƒ¨åˆ†æ‹‰äº†, è‡ªå·±å¹³æ—¶ç¡®å®ä¹Ÿæ²¡æ€ä¹ˆå…³æ³¨ä¸€äº›è¿™æ ·çš„ç®—æ³•é—®é¢˜. ä¸è¿‡å°±ç®—ä¸çŸ¥é“ä¹Ÿè¦ç§¯æçš„è¯´å‡ºè‡ªå·±çš„æƒ³æ³•, å’Œé¢è¯•å®˜äº¤æµ, è®©é¢è¯•å®˜çœ‹åˆ°ä½ è§£å†³é—®é¢˜çš„è¿‡ç¨‹.</p>
<p>(äº‹åäº†è§£äº†ä¸€ä¸‹è¿™ç©æ„å«äºŒåˆ†å›¾, æ‰€æœ‰çš„é¡¶ç‚¹å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„é›†åˆ, ä½¿å¾—æ¯æ¡è¾¹çš„ä¸¤ä¸ªé¡¶ç‚¹åˆ†åˆ«å±äºä¸åŒçš„é›†åˆ. å…¶å®æŒºç®€å•çš„, ä½†æ˜¯æ²¡åŠæ³•, é¢è¯•çš„æ—¶å€™è¿˜å®Œå…¨æ²¡çœ‹å›¾è®ºç›¸å…³å†…å®¹.)</p>
<h3 id="å¤è¯•å°¾å£°"><a href="#å¤è¯•å°¾å£°" class="headerlink" title="å¤è¯•å°¾å£°"></a>å¤è¯•å°¾å£°</h3><p>æœ€åä¹Ÿæ˜¯æœ‰ç»å…¸çš„åé—®è¿‡ç¨‹, ä¸è¿‡è¿™æ¬¡æ€»ç»“äº†ä¸€é¢çš„ç»éªŒ, æå‰æƒ³å¥½äº†è¦é—®äº›å•¥, å€’æ˜¯å¾—åˆ°äº†ä¸€äº›è‡ªå·±æƒ³è¦äº†è§£çš„å†…å®¹. æ¯”å¦‚å¼€å‘è¯­è¨€å’Œç”¨çš„æŠ€æœ¯, é¡¹ç›®ç®¡ç†åˆ¶åº¦å•¥çš„. æå‰å‡†å¤‡ä¸€ä¸‹å°±èƒ½è¶ç€è¿™ä¸ªæœºä¼šå‘é¢è¯•å®˜äº†è§£ä¸€ä¸‹è‡ªå·±æ„å‘å·¥ä½œçš„åœ°æ–¹å¦‚ä½•.</p>
<h2 id="HR-é¢è¯•"><a href="#HR-é¢è¯•" class="headerlink" title="HR é¢è¯•"></a>HR é¢è¯•</h2><p>å¤§æ¦‚éš”äº†ä¸€å‘¨æ—¶é—´, ç»ˆäºæ”¶åˆ°ä¸‰é¢é‚€è¯·, å·®ç‚¹ä»¥ä¸ºè¦æŒ‚äº†<del>äºŒé¢å¤ªæ‹‰äº†</del>.</p>
<p>è¿™ä¸€é¢æ˜¯éæŠ€æœ¯é¢, ä¸Šæ¥è‡ªæˆ‘ä»‹ç»ä¸€ä¸‹, ç„¶åä¸»è¦æ˜¯äººäº‹å’Œä½ èŠèŠå¤©, é—®é—®ä½ çš„ä¸ªäººæƒ…å†µ, ç°åœ¨åœ¨åšçš„å†…å®¹, çœ‹çœ‹ä½ å¯¹å·¥ä½œçš„æ€åº¦, é¢å¯¹é—®é¢˜çš„è§£å†³æ€è·¯, ç¡®è®¤ä¸€ä¸‹ä½ çš„ä¸ªäººä¿¡æ¯å’Œå·¥ä½œæ„å‘, æ¯”è¾ƒè½»æ¾çš„æ°›å›´, æ³¨æ„ä¸€ä¸‹è¨€è°ˆä¸¾æ­¢å°±å¥½.</p>
<p>æ—¶é—´ä¹Ÿä¸é•¿, ä¸åˆ°åŠå°æ—¶å°±ç»“æŸäº†, è¿™ä¸€é¢åŸºæœ¬å°±æ˜¯èµ°èµ°æµç¨‹, ä¸å‡ºæ„å¤–é¢å®Œç­‰åç»­å°±å¥½.</p>
<p><del>ä¸ªäººè®¤ä¸º, åªè¦ä¸å’Œé¢è¯•å®˜æ‰“èµ·æ¥è¿™ä¸€é¢éƒ½ä¸è‡³äºæŒ‚.</del></p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>ä¸‰é¢ä¹‹åå¤§æ¦‚ä¸€å‘¨å°±èƒ½æ”¶åˆ°äººäº‹å‘æ¥çš„ Offer äº†, éœ€è¦åœ¨ç³»ç»Ÿæˆ–è€…é‚®ä»¶é‡Œç¡®è®¤æ¥å—å³å¯, å…·ä½“çš„å…¥èŒäº‹é¡¹å¯ä»¥å’Œè·Ÿè‡ªå·±å¯¹æ¥çš„ HR è¿›è¡Œæ²Ÿé€šäº†è§£.</p>
<p>æ€»ç»“ä¸€ä¸‹æ•´ä¸ªé¢è¯•çš„è¯, ç¡®å®æ˜¯æŠ•çš„æ—©åŠ è¿æ°”å¥½å§, æ„Ÿè§‰æœ‰è¿™ä¹ˆä¸€äº›æ¯”è¾ƒä»¤é¢è¯•å®˜æ»¡æ„çš„åœ°æ–¹:</p>
<ul>
<li>ä¸€é¢ä¸¤é“æ‰‹æ’•å¾ˆé¡ºç•…<del>ç”šè‡³é¢è¯•å®˜è¯´æˆ‘å†™æŒºå¿«çš„?</del></li>
<li>ç„¶åç®€å†é‡Œæœ‰ä¸€ä¸ªé¢è¯•å®˜åˆšå¥½æ¯”è¾ƒæ„Ÿå…´è¶£çš„é¡¹ç›®. æ„Ÿè§‰è¿™ä¸ªæ˜¯æœ€é‡è¦çš„, æœ‰ä¸€ä¸ªå¯¹å£çš„é¡¹ç›®çœŸçš„å¾ˆåŠ åˆ†.</li>
</ul>
<p>å½“ç„¶ç”±äºå‡†å¤‡ä¸å……åˆ†, ä¹Ÿå­˜åœ¨å¾ˆå¤šé—®é¢˜, åŒ…æ‹¬ä½†ä¸é™äº:</p>
<ul>
<li>å…«è‚¡å®Œå…¨æ²¡çœ‹, å…¨å‡­è®°å¿†å›ç­”.</li>
<li>ä¹Ÿæ²¡å¥½å¥½å¤ä¹ è‡ªå·±çš„é¡¹ç›®å†…å®¹, é—®çš„æ—¶å€™å¾ˆå¤šä¸œè¥¿è‡ªå·±ä¹Ÿè®°ä¸èµ·æ¥å½“æ—¶å’‹å†™çš„äº†.</li>
<li>åœºæ™¯é¢˜ä¹Ÿç­”çš„ä¸€å¡Œç³Šæ¶‚, åˆšå¼€å§‹ä¸€ç‚¹æ€è·¯éƒ½æ— , ä¹Ÿæ˜¯è‡ªå·±å¹³å¸¸è¿™æ–¹é¢æ¥è§¦å¤ªå°‘.</li>
<li>æ²¡å‡†å¤‡ä¸€ä¸ªè‰¯å¥½çš„è‡ªæˆ‘ä»‹ç», è€æ˜¯ç­‰ç€é¢è¯•å®˜è¢«åŠ¨æé—®.</li>
<li>ç­‰ç­‰ç­‰ç­‰...</li>
</ul>
<p>é€šè¿‡é¢è¯•æ‰èƒ½çŸ¥é“è‡ªå·±æœ‰å¾ˆå¤šéœ€è¦æå‡çš„åœ°æ–¹, åº”è¯¥æœç€å“ªäº›æ–¹é¢æå‡è‡ªå·±, ä¹Ÿåªæœ‰ä¸æ–­é¢è¯•æ‰èƒ½æ¶ˆé™¤è‡ªå·±å¯¹é¢è¯•çš„ç´§å¼ æ„Ÿ, è®©è‡ªå·±èƒ½å¤Ÿåœ¨é¢è¯•ä¸­å……åˆ†çš„å±•ç°è‡ªå·±æœ€å¥½çš„çŠ¶æ€.</p>
<p>æœ€å, ç¥å„ä½åŒå­¦éƒ½èƒ½é¡ºåˆ©é€šè¿‡é¢è¯•, æ”¶åˆ°è‡ªå·±å¿ƒä»ªçš„ Offer~</p>
<p><img data-src="/static/image/tencent-intership-interview/sign_img.png" alt="tencent_offer"></p>
]]></content>
      <categories>
        <category>ç»éªŒåˆ†äº«</category>
      </categories>
      <tags>
        <tag>è…¾è®¯</tag>
        <tag>é¢ç»</tag>
        <tag>å®ä¹ </tag>
        <tag>æµ‹è¯•å¼€å‘</tag>
        <tag>IEG</tag>
      </tags>
  </entry>
  <entry>
    <title>&quot;ç½‘å®‰æœ¬ç§‘é€Ÿé€š&quot; ç³»åˆ—åè®°</title>
    <url>//posts/2022/08/19/wast-afterword/</url>
    <content><![CDATA[<p>ç»ˆäºå†™å®Œäº†æœ€åä¸€ç¯‡! (æ’’èŠ±~), <a href="/categories/%E7%BD%91%E5%AE%89%E6%9C%AC%E7%A7%91%E9%80%9F%E9%80%9A/">ç‚¹æˆ‘æŸ¥çœ‹å…¨ç³»åˆ—å†…å®¹</a>.</p>
<p>è™½ç„¶è¿™ä¸ªç³»åˆ—å°±æ­¤å®Œç»“, ä½†æ˜¯åªæ˜¯å› ä¸ºæˆ‘è§‰å¾—å†å†™ä¸‹å»å·²ç»ä¸ç®—é€Ÿé€šçš„å†…å®¹äº†, æˆ‘åªå†™äº†æœ€åŸºæœ¬çš„å¿…éœ€å†…å®¹.</p>
<p>æˆ‘ç›¸ä¿¡å¦‚æœçœŸçš„å¥½å¥½çœ‹å®Œäº†çš„è¯, åº”ä»˜ä¸€ä¸‹å¹³å¸¸çš„ä½œä¸šåº”è¯¥ç»°ç»°æœ‰ä½™äº†. ä½†æ˜¯å¦‚æœçœŸçš„æƒ³è¦å­¦æœ‰æ‰€è·, è¿™ä¸ªç³»åˆ—é‡Œçš„ä¸œè¥¿çœŸçš„å¤ªæµ…äº†, æ¯ä¸€ç¯‡éƒ½åªæ˜¯å…¥ä¸ªé—¨è€Œå·², ä½ å¾—èŠ±ä¸Šçœ‹è¿™ä¸ªç³»åˆ—çš„åå€ä»¥ä¸Šçš„æ—¶é—´å»å­¦ä¹ , å»å°è¯•.</p>
<p>è¿™ä¸ªç³»åˆ—ä¹Ÿç®—æ˜¯å¯¹æœ¬ç§‘å››å¹´ä¸€äº›çŸ¥è¯†ç‚¹çš„æ€»ç»“å§, éƒ½æ˜¯èœ»èœ“ç‚¹æ°´èˆ¬çš„å¸¦è¿‡, å¸Œæœ›æ—¥åè‡ªå·±å†çœ‹åˆ°æ—¶, è¿˜èƒ½å¤Ÿæƒ³èµ·æ¥éƒ½å­¦äº†äº›å•¥.</p>
<p>å°±è¿™æ ·äº†, ç½‘å®‰æœ¬ç§‘é€Ÿé€š, å®Œæˆ!</p>
<p><img data-src="/static/image/wast-afterword/zzz.gif" alt="zzz.gif"></p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>åè®°</category>
      </categories>
      <tags>
        <tag>æ‚è°ˆ</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäº PyTorch çš„æ‰‹å†™æ•°å­—åˆ†ç±»</title>
    <url>//posts/2022/08/18/wast-dl/</url>
    <content><![CDATA[<p>æœ¬ç¯‡ç®—æ˜¯å¯¹ <code>pytorch</code> è¿™ä¸€ <code>python</code> æ·±åº¦å­¦ä¹ åº“ç¥å™¨çš„å…¥é—¨æ•™ç¨‹, ä»¥æ‰‹å†™æ•°å­—åˆ†ç±»è¿™ä¸€ç»å…¸é—®é¢˜åšç¤ºä¾‹, æ¥æ¦‚æ‹¬ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ <code>pytorch</code> æ¥æ­å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ç½‘ç»œç»“æ„, å¹¶åŠ ä»¥è®­ç»ƒ.</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>æ‰€éœ€çš„ç¬¬ä¸‰æ–¹åº“.</p>
<p><code>scikit-learn</code>: å¹¶æ²¡æœ‰ç”¨åˆ°é‡Œé¢çš„ç®—æ³•, ä½†æ˜¯å°è°ƒä¸€ä¸‹é‡Œé¢ç°æˆçš„æŒ‡æ ‡è¯„ä»·å‡½æ•°, å‡å°‘ä¸å¿…è¦çš„é‡å¤åŠ³åŠ¨.</p>
<p><code>pytorch</code>: æœ¬ç¯‡è¦ä½¿ç”¨çš„æ ¸å¿ƒåº“, å®‰è£…æ–¹å¼éœ€è¦åœ¨<span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy8=">å®˜ç½‘<i class="fa fa-external-link-alt"></i></span>æŸ¥è¯¢, ä¸”æŒ‰éœ€å®‰è£… <code>cuda</code> å·¥å…·.</p>
<h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">example/</span><br><span class="line">    digit_data/</span><br><span class="line">        train/</span><br><span class="line">            0/</span><br><span class="line">                1.jpg</span><br><span class="line">                2.jpg</span><br><span class="line">                ...</span><br><span class="line">            ...</span><br><span class="line">            9/</span><br><span class="line">                ...</span><br><span class="line">                XXX.jpg</span><br><span class="line">        test/</span><br><span class="line">            ...</span><br><span class="line">    main.py</span><br><span class="line">    main.ipynb</span><br></pre></td></tr></table></figure>

<p><img data-src="/static/image/wast-dl/vrAZse.png" alt="vrAZse.png"></p>
<h2 id="å¹¶ä¸å¿«é€Ÿçš„å¿«é€Ÿä¸Šæ‰‹"><a href="#å¹¶ä¸å¿«é€Ÿçš„å¿«é€Ÿä¸Šæ‰‹" class="headerlink" title="å¹¶ä¸å¿«é€Ÿçš„å¿«é€Ÿä¸Šæ‰‹"></a>å¹¶ä¸å¿«é€Ÿçš„å¿«é€Ÿä¸Šæ‰‹</h2><h3 id="å¯¼å…¥æ‰€éœ€è¦çš„æ‰€æœ‰åº“"><a href="#å¯¼å…¥æ‰€éœ€è¦çš„æ‰€æœ‰åº“" class="headerlink" title="å¯¼å…¥æ‰€éœ€è¦çš„æ‰€æœ‰åº“"></a>å¯¼å…¥æ‰€éœ€è¦çš„æ‰€æœ‰åº“</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_files</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score, classification_report, f1_score, precision_score, recall_score</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn, optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, Dataset</span><br><span class="line"><span class="keyword">from</span> torchvision.io <span class="keyword">import</span> read_image</span><br><span class="line"><span class="keyword">from</span> torchvision.io.image <span class="keyword">import</span> ImageReadMode</span><br><span class="line"></span><br><span class="line">DEVICE = <span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span></span><br></pre></td></tr></table></figure>

<p>é™¤äº†å¯¼å…¥å¿…éœ€çš„åº“ä¹‹å¤–, è¿˜è®¾ç½®äº†ä¸€ä¸ªå…¨å±€å˜é‡ <code>DEVICE</code>, åç»­ä»£ç ä¼šä½¿ç”¨å®ƒ, å°†è®¡ç®—æ”¾åœ¨ <code>DEVICE</code> æŒ‡å®šçš„ç¡¬ä»¶ä¸Šè¿›è¡Œè®¡ç®—, æ¨èå°½é‡ç”¨ gpu, é€Ÿåº¦å¿«å¾ˆå¤š, å½“ç„¶å¯¹äºè¿™ä¸ªå°å°çš„ç¤ºä¾‹ç¨‹åº, cpu ä¹Ÿæ˜¯èƒ½ç®—çš„.</p>
<h3 id="æ„å»ºè‡ªå·±çš„æ•°æ®é›†"><a href="#æ„å»ºè‡ªå·±çš„æ•°æ®é›†" class="headerlink" title="æ„å»ºè‡ªå·±çš„æ•°æ®é›†"></a>æ„å»ºè‡ªå·±çš„æ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, path</span>):</span><br><span class="line">        data = load_files(path, load_content=<span class="literal">False</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line">        self.inputs = data[<span class="string">&quot;filenames&quot;</span>]</span><br><span class="line">        self.targets = data[<span class="string">&quot;target&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.targets)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">        input_ = read_image(self.inputs[item], ImageReadMode.GRAY).<span class="built_in">float</span>().to(DEVICE)</span><br><span class="line">        target = torch.tensor([self.targets[item]]).long().to(DEVICE)</span><br><span class="line">        <span class="keyword">return</span> (input_, target)</span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>pytorch</code>, é€šè¿‡ç»§æ‰¿ç±» <code>Dataset</code>, å¹¶ä¸”é‡å†™ <code>__init__</code>, <code>__len__</code> å’Œ <code>__getitem__</code> æ¥æ„å»ºè‡ªå®šä¹‰æ•°æ®é›†.</p>
<p><code>__init__</code>: é€šå¸¸åœ¨æ„é€ å‡½æ•°é‡Œå®šä¹‰å¦‚ä½•è·å–åŸå§‹æ•°æ®é›†.</p>
<p><code>__len__</code>: å®šä¹‰æ•°æ®é›†çš„å¤§å°è®¡ç®—æ–¹å¼.</p>
<p><code>__getitem__</code>: å®šä¹‰å¦‚ä½•é€šè¿‡ç´¢å¼•æ¥è·å–ä¸€ä¸ªæ ·æœ¬.</p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¹‹å‰ç”¨è¿‡çš„ <code>load_files</code> æ¥åŠ è½½æ•°æ®é›†çš„è·¯å¾„, å¹¶ä½¿ç”¨ <code>pytorch</code> æä¾›çš„å›¾åƒè¯»å–å‡½æ•° <code>read_image</code> è¯»å–æ ·æœ¬.</p>
<h3 id="æ­å»ºä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œ"><a href="#æ­å»ºä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œ" class="headerlink" title="æ­å»ºä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œ"></a>æ­å»ºä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyNetwork</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, intput_size=<span class="number">28</span>, input_channels=<span class="number">1</span>, output_size=<span class="number">10</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.convpooling = nn.Sequential(</span><br><span class="line">            nn.Conv2d(input_channels, <span class="number">16</span>, <span class="number">5</span>),           <span class="comment"># 28 - 4 = 24</span></span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),                            <span class="comment"># 24 // 2 = 14</span></span><br><span class="line">            nn.Conv2d(<span class="number">16</span>, <span class="number">64</span>, <span class="number">3</span>),                       <span class="comment"># 14 - 2 = 12</span></span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),                            <span class="comment"># 12 // 2 = 6</span></span><br><span class="line">        )</span><br><span class="line">        _size = ((intput_size - <span class="number">4</span>) // <span class="number">2</span> - <span class="number">2</span>) // <span class="number">2</span></span><br><span class="line">        self.fc = nn.Sequential(</span><br><span class="line">            nn.Flatten(<span class="number">1</span>),</span><br><span class="line">            nn.Dropout(),</span><br><span class="line">            nn.Linear(<span class="number">64</span>*_size*_size, output_size)      <span class="comment"># 64*6*6 -&gt; 10</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        outputs = self.convpooling(inputs)</span><br><span class="line">        outputs = self.fc(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ç»§æ‰¿ <code>Module</code> ç±»å¹¶é‡å†™å…¶ä¸­çš„ <code>__init__</code> å’Œ <code>forward</code> æ¥è‡ªå®šä¹‰ç½‘ç»œç»“æ„ä¸å‰å‘ä¼ æ’­æ–¹å¼.</p>
<p><code>__init__</code>: åœ¨æ„é€ å‡½æ•°é‡Œç»™å‡ºè‡ªå®šä¹‰ç½‘ç»œçš„æ‰€æœ‰å±‚æ¬¡ç»“æ„. ä½¿ç”¨ <code>Module</code> çš„å­ç±»è¿›è¡Œå®šä¹‰, ä¼šè‡ªåŠ¨å°†éœ€è¦å­¦ä¹ çš„å‚æ•°æ³¨å†Œåˆ°æ•´ä¸ªç½‘ç»œç»“æ„ä¸Š.</p>
<p><code>forward</code>: å®šä¹‰è¾“å…¥æ•°æ®å¦‚ä½•è¿›è¡Œå‰å‘ä¼ æ’­, ä¹Ÿå°±æ˜¯å¦‚ä½•ä½¿ç”¨åœ¨æ„é€ å‡½æ•°é‡Œå®šä¹‰çš„å„ä¸ªç½‘ç»œå±‚.</p>
<p>è¿™é‡Œå¯¹äºæ‰‹å†™æ•°å­—åˆ†ç±»é—®é¢˜, æˆ‘ä»¬å†™äº†ä¸€ä¸ªç®€å•çš„ä¸¤å±‚ CNN ç½‘ç»œ, å¹¶åŠ ä¸Šä¸€ä¸ªå…¨è¿æ¥å±‚.</p>
<p>ç½‘ç»œçš„è¾“å…¥æ˜¯ <code>input_size*input_size</code> å¤§å°, é€šé“æ•°ä¸º <code>input_channels</code> çš„å›¾ç‰‡, è€Œè¾“å‡ºåˆ™æ˜¯ <code>output_size</code> çš„ä¸€ä¸ªåˆ†ç±»å‘é‡, æ¯ä¸ªä½ç½®ä»£è¡¨ä¸åŒç±»åˆ«çš„å¾—åˆ†.</p>
<p>ä»£ç æ³¨é‡Šé‡Œç»™å‡ºäº†æ¯ä¸€å±‚æ ·æœ¬å¤§å°çš„å˜åŒ–æƒ…å†µ, æ¯ä¸€å±‚ä¹‹é—´éœ€è¦ç›¸äº’å¯¹é½æ‰èƒ½æ­£ç¡®è®¡ç®—.</p>
<h3 id="å®šä¹‰è¯„ä»·æŒ‡æ ‡å‡½æ•°"><a href="#å®šä¹‰è¯„ä»·æŒ‡æ ‡å‡½æ•°" class="headerlink" title="å®šä¹‰è¯„ä»·æŒ‡æ ‡å‡½æ•°"></a>å®šä¹‰è¯„ä»·æŒ‡æ ‡å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">eval_metrics</span>(<span class="params">y_true, y_pred</span>):</span><br><span class="line">    acc = accuracy_score(y_true, y_pred)</span><br><span class="line">    p = precision_score(y_true, y_pred, average=<span class="string">&quot;macro&quot;</span>, zero_division=<span class="number">0</span>)</span><br><span class="line">    r = recall_score(y_true, y_pred, average=<span class="string">&quot;macro&quot;</span>, zero_division=<span class="number">0</span>)</span><br><span class="line">    f1 = f1_score(y_true, y_pred, average=<span class="string">&quot;macro&quot;</span>, zero_division=<span class="number">0</span>)</span><br><span class="line">    report = classification_report(y_true, y_pred, digits=<span class="number">4</span>, zero_division=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (acc, p, r, f1, report)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè°ƒç”¨äº† <code>scikit-learn</code> çš„ä¸€äº›å¸¸ç”¨æŒ‡æ ‡è®¡ç®—å‡½æ•°, åŒ…æ‹¬å‡†ç¡®ç‡, ç²¾åº¦, å¬å›ç‡, F1 å¾—åˆ†, ä»¥åŠä¸€ä»½æ±‡æ€»ç»“æœ.</p>
<p>è¾“å…¥æ•°æ®å°±æ˜¯çœŸå®æ ‡ç­¾ä¸é¢„æµ‹æ ‡ç­¾.</p>
<h3 id="å®šä¹‰è®­ç»ƒå‡½æ•°"><a href="#å®šä¹‰è®­ç»ƒå‡½æ•°" class="headerlink" title="å®šä¹‰è®­ç»ƒå‡½æ•°"></a>å®šä¹‰è®­ç»ƒå‡½æ•°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">model, train_data_loader, criterion, optimizer</span>):</span><br><span class="line">    model.train()</span><br><span class="line">    loss_list = []</span><br><span class="line">    pred_list = []</span><br><span class="line">    true_list = []</span><br><span class="line">    <span class="keyword">for</span> inputs, targets <span class="keyword">in</span> train_data_loader:</span><br><span class="line">        targets = targets.flatten()</span><br><span class="line">        outputs = model(inputs)</span><br><span class="line">        loss = criterion(outputs, targets)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        loss_list.append(loss.item())</span><br><span class="line">        pred_list.append(outputs.argmax(dim=-<span class="number">1</span>).cpu().numpy())</span><br><span class="line">        true_list.append(targets.cpu().numpy())</span><br><span class="line"></span><br><span class="line">    y_pred = np.concatenate(pred_list)</span><br><span class="line">    y_true = np.concatenate(true_list)</span><br><span class="line"></span><br><span class="line">    loss = np.mean(loss_list)</span><br><span class="line">    result = eval_metrics(y_true, y_pred)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (loss, *result)</span><br></pre></td></tr></table></figure>

<p>è®­ç»ƒå‡½æ•°æœ‰å››ä¸ªå‚æ•°.</p>
<p><code>model</code>: æ¨¡å‹, ä¹Ÿå°±æ˜¯å‰é¢æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ç¥ç»ç½‘ç»œå®ä¾‹.</p>
<p><code>train_data_loader</code>: è®­ç»ƒæ•°æ®é›†åŠ è½½å™¨. æ˜¯ä¸€ä¸ª <code>DataLoader</code> å®ä¾‹, å¯ä»¥è¿›è¡Œè¿­ä»£ä»é‡Œé¢æŒ‰æ‰¹æ¬¡å¤§å°è·å¾—è®­ç»ƒæ•°æ®.</p>
<p><code>criterion</code>: æŸå¤±å‡½æ•°, ç”¨æ¥è®¡ç®—æ¯æ¬¡è¾“å‡ºä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„æŸå¤±å€¼, å¹¶è¿›è¡Œåå‘ä¼ æ’­è®¡ç®—æ¢¯åº¦.</p>
<div class="note info"><p>éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹ <code>targets</code> ä½¿ç”¨äº†ä¸€æ¬¡ <code>flatten</code> æ“ä½œ.<br>å› ä¸ºä½¿ç”¨ <code>DataLoader</code> å¯¹æ•°æ®é›†è¿›è¡ŒåŠ è½½æ—¶, æ¯æ¬¡æ˜¯æŒ‰ç…§ <code>batch_size</code> æ¥æ‰¹é‡è·å–çš„, å› æ­¤ä¼šè‡ªåŠ¨å°†å•ä¸ªæ ·æœ¬è¿›è¡Œæ‹¼æ¥å˜æˆä¸€ä¸ª batch. æ‰€ä»¥ <code>targets</code> æ˜¯ <code>(batch_size, 1)</code> çš„å½¢çŠ¶.<br>ä½†æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨çš„æŸå¤±å‡½æ•°æ˜¯ <code>CrossEntropy</code> äº¤å‰ç†µæŸå¤±å‡½æ•°, å®ƒçš„è¾“å…¥è¦æ±‚çœŸå®æ ‡ç­¾æ˜¯ä¸€ä¸ªä¸€ç»´çš„å‘é‡ <code>(batch_size, )</code>, å› æ­¤ä½¿ç”¨ <code>flatten</code> å¯¹ <code>targets</code> è¿›è¡Œå±•å¹³æ“ä½œ.</p>
</div>

<p><code>optimizer</code>: ä¼˜åŒ–å™¨, åœ¨ä½¿ç”¨ä¹‹å‰å·²ç»å°† <code>model</code> ä¸­éœ€è¦è®­ç»ƒçš„å‚æ•°æ³¨å†Œè¿›å», æ¯æ¬¡è°ƒç”¨ <code>step</code> æ–¹æ³•å¯ä»¥å¯¹ <code>model</code> æ³¨å†Œçš„å‚æ•°é€šè¿‡æ¢¯åº¦è¿›è¡Œæ›´æ–°.</p>
<p>è®­ç»ƒçš„æµç¨‹å…±æœ‰ä»¥ä¸‹å‡ æ­¥.</p>
<ol>
<li>å°† <code>model</code> è½¬ä¸º <code>train</code> æ¨¡å¼.</li>
<li>è¿­ä»£æ•°æ®é›†åŠ è½½å™¨, æŒ‰æ‰¹æ¬¡è·å–æ¯ä¸€æ¬¡è¦å­¦ä¹ çš„æ ·æœ¬.</li>
<li>å°†æ ·æœ¬å–‚è¿› <code>model</code> è¿›è¡Œå‰å‘ä¼ æ’­, å¹¶è®¡ç®—æŸå¤±.</li>
<li>æ¸…ç©ºä¼˜åŒ–å™¨ä¸­ä¸Šä¸€æ¬¡æ¢¯åº¦å€¼.</li>
<li>ä»æŸå¤±å¤„å¼€å§‹åå‘ä¼ æ’­, è®¡ç®—æœ¬æ¬¡å‚æ•°éœ€è¿›è¡Œå­¦ä¹ çš„æ¢¯åº¦.</li>
<li>è°ƒç”¨ä¼˜åŒ–å™¨çš„ <code>step</code>, æ ¹æ®æ¢¯åº¦å€¼å®Œæˆå¯¹ç½‘ç»œå‚æ•°çš„æ›´æ–°.</li>
</ol>
<p>åé¢è¿˜æœ‰ä¸€äº›é¢å¤–çš„ç»Ÿè®¡æ“ä½œ, ç”¨æ¥è®°å½•æœ¬æ¬¡è®­ç»ƒè¿‡ç¨‹æ—¶çš„å¹³å‡æŸå¤±å’Œå‡†ç¡®åº¦ç­‰æƒ…å†µ.</p>
<h3 id="å®šä¹‰è¯„ä¼°å‡½æ•°"><a href="#å®šä¹‰è¯„ä¼°å‡½æ•°" class="headerlink" title="å®šä¹‰è¯„ä¼°å‡½æ•°"></a>å®šä¹‰è¯„ä¼°å‡½æ•°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">model, eval_data_loader, criterion</span>):</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    loss_list = []</span><br><span class="line">    pred_list = []</span><br><span class="line">    true_list = []</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> inputs, targets <span class="keyword">in</span> eval_data_loader:</span><br><span class="line">            targets = targets.flatten()</span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            loss = criterion(outputs, targets)</span><br><span class="line"></span><br><span class="line">            loss_list.append(loss.item())</span><br><span class="line">            pred_list.append(torch.argmax(outputs, dim=-<span class="number">1</span>).cpu().numpy())</span><br><span class="line">            true_list.append(targets.cpu().numpy())</span><br><span class="line"></span><br><span class="line">    y_pred = np.concatenate(pred_list)</span><br><span class="line">    y_true = np.concatenate(true_list)</span><br><span class="line"></span><br><span class="line">    loss = np.mean(loss_list)</span><br><span class="line">    result = eval_metrics(y_true, y_pred)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (loss, *result)</span><br></pre></td></tr></table></figure>

<p>è¯„ä¼°å‡½æ•°çš„è¿‡ç¨‹ä¸è®­ç»ƒå‡½æ•°ç±»ä¼¼, ä¸åŒä¹‹å¤„åœ¨äºå‰è€…çš„å‚æ•°é‡Œæ²¡æœ‰ä¼˜åŒ–å™¨, å› ä¸ºè¯„ä¼°å‡½æ•°ç”¨äºæ¨¡å‹åœ¨æµ‹è¯•é›†ä¸Šè¿›è¡Œæµ‹è¯•, ä¸éœ€è¦åå‘ä¼ æ’­ä¸å‚æ•°æ›´æ–°çš„æ“ä½œ.</p>
<p>è¯„ä¼°å‡½æ•°çš„å…³é”®æ˜¯ <code>torch.no_grad</code> æ“ä½œ, åœ¨æ­¤ä¸Šä¸‹æ–‡å†…å¯¹ <code>model</code> çš„æ“ä½œä¸ä¼šè®¡ç®—ä»»ä½•æ¢¯åº¦å€¼, åªä¼šè¿›è¡Œå•çº¯çš„å‰å‘æ±‚å€¼è®¡ç®—æ“ä½œ.</p>
<h3 id="å®šä¹‰è®­ç»ƒè¶…å‚æ•°"><a href="#å®šä¹‰è®­ç»ƒè¶…å‚æ•°" class="headerlink" title="å®šä¹‰è®­ç»ƒè¶…å‚æ•°"></a>å®šä¹‰è®­ç»ƒè¶…å‚æ•°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">seed = <span class="number">1</span></span><br><span class="line">learning_rate = <span class="number">1e-3</span></span><br><span class="line">batch_size = <span class="number">500</span></span><br><span class="line">epochs = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">torch.manual_seed(seed)</span><br><span class="line">torch.cuda.manual_seed(seed)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†å­¦ä¹ ç‡å’Œè®­ç»ƒè½®æ•°, ç”±äºåªæ˜¯ç¤ºä¾‹å› æ­¤è½®æ•°åªæœ‰ 5 æ¥å±•ç¤ºæ•ˆæœ.</p>
<p>å°†éšæœºæ•°ç§å­åˆ—å…¥äº†è¶…å‚æ•°å¹¶ä¸”å›ºå®šäº† <code>torch</code> éšæœºæ•°æ¨¡å—çš„ç§å­, ç›®çš„æ˜¯ä¸ºäº†ç¨³å®šå¤ç°ç»“æœ.</p>
<h3 id="åŠ è½½æ•°æ®é›†"><a href="#åŠ è½½æ•°æ®é›†" class="headerlink" title="åŠ è½½æ•°æ®é›†"></a>åŠ è½½æ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train_dataset = MyDataset(<span class="string">&quot;./digit_data/train/&quot;</span>)</span><br><span class="line">test_dataset = MyDataset(<span class="string">&quot;./digit_data/test/&quot;</span>)</span><br><span class="line">train_dataloader = DataLoader(train_dataset, shuffle=<span class="literal">True</span>, batch_size=batch_size)</span><br><span class="line">test_dataloader = DataLoader(test_dataset, shuffle=<span class="literal">True</span>, batch_size=batch_size)</span><br></pre></td></tr></table></figure>

<p>å¯¼å…¥äº†è‡ªå·±çš„æ‰‹å†™æ•°å­—æ•°æ®é›†å¹¶ä½¿ç”¨ <code>DataLoader</code> æ¥è¿›è¡ŒåŠ è½½, å¯ä»¥è®¾ç½®æ˜¯å¦æ‰“ä¹±ä¸æ‰¹æ¬¡å¤§å°ç­‰åŠ è½½å‚æ•°.</p>
<h3 id="å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡"><a href="#å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡" class="headerlink" title="å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡"></a>å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model = MyNetwork().to(DEVICE)</span><br><span class="line">loss_fn = nn.CrossEntropyLoss().to(DEVICE)</span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=learning_rate)</span><br></pre></td></tr></table></figure>

<p>æ¨¡å‹ä½¿ç”¨äº†é»˜è®¤å‚æ•°, æ•°æ®é›†å›¾ç‰‡å¤§å°ä¸º <code>28*28</code>, ä¸”åŠ ä¸Šäº† <code>to(DEVICE)</code>. åœ¨å‰é¢æ„å»ºæ•°æ®é›†éƒ¨åˆ†ä¹Ÿä½¿ç”¨äº† <code>to(DEVICE)</code> æ“ä½œ, å…¶ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ‰€æœ‰è¦å‚ä¸è®¡ç®—çš„ <code>Tensor</code> éƒ½åœ¨åŒä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ä¸Šè¿›è¡Œè®¡ç®—.</p>
<p>ç„¶åæ˜¯å®ä¾‹åŒ–æŸå¤±å‡½æ•°ä¸ä¼˜åŒ–å™¨. åœ¨ä¼˜åŒ–å™¨çš„å‚æ•°ä¸­éœ€è¦å¡«å…¥ <code>model</code> æ‰€æœ‰éœ€è¦æ›´æ–°çš„ç½‘ç»œå‚æ•°, å¹¶å¡«å…¥å­¦ä¹ ç‡.</p>
<p>ä¼˜åŒ–å™¨é€‰æ‹©äº† <code>Adam</code>, ä¸€ä¸ªå‡ ä¹ä¸‡ç”¨çš„ä¼˜åŒ–å™¨.</p>
<h3 id="è®­ç»ƒæ¨¡å‹"><a href="#è®­ç»ƒæ¨¡å‹" class="headerlink" title="è®­ç»ƒæ¨¡å‹"></a>è®­ç»ƒæ¨¡å‹</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;===============================&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(epochs):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Epoch <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-------------------------------&quot;</span>)</span><br><span class="line">    *train_metrics, _ = train(model, train_dataloader, loss_fn, optimizer)</span><br><span class="line">    *evaluate_metrics, _ = evaluate(model, test_dataloader, loss_fn)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Train Loss: &#123;:.4f&#125; Acc: &#123;:.4f&#125; F1: &#123;:.4f&#125;(&#123;:.4f&#125;/&#123;:.4f&#125;)&quot;</span>.<span class="built_in">format</span>(*train_metrics))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Eval  Loss: &#123;:.4f&#125; Acc: &#123;:.4f&#125; F1: &#123;:.4f&#125;(&#123;:.4f&#125;/&#123;:.4f&#125;)&quot;</span>.<span class="built_in">format</span>(*evaluate_metrics))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;===============================&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å¦‚ä¸‹è®­ç»ƒè¿‡ç¨‹è¾“å‡º.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">===============================</span><br><span class="line">Epoch 1</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 11.0961 Acc: 0.4295 F1: 0.4297(0.4272/0.4281)</span><br><span class="line">Eval  Loss: 0.7999 Acc: 0.8052 F1: 0.8232(0.8059/0.8014)</span><br><span class="line">===============================</span><br><span class="line">Epoch 2</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.8910 Acc: 0.8009 F1: 0.8002(0.8000/0.7999)</span><br><span class="line">Eval  Loss: 0.3495 Acc: 0.9106 F1: 0.9111(0.9103/0.9103)</span><br><span class="line">===============================</span><br><span class="line">Epoch 3</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.4862 Acc: 0.8683 F1: 0.8675(0.8675/0.8674)</span><br><span class="line">Eval  Loss: 0.2554 Acc: 0.9324 F1: 0.9324(0.9322/0.9320)</span><br><span class="line">===============================</span><br><span class="line">Epoch 4</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.3536 Acc: 0.9016 F1: 0.9013(0.9008/0.9010)</span><br><span class="line">Eval  Loss: 0.2114 Acc: 0.9396 F1: 0.9393(0.9397/0.9393)</span><br><span class="line">===============================</span><br><span class="line">Epoch 5</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.2802 Acc: 0.9173 F1: 0.9170(0.9170/0.9169)</span><br><span class="line">Eval  Loss: 0.1861 Acc: 0.9470 F1: 0.9474(0.9471/0.9469)</span><br><span class="line">===============================</span><br></pre></td></tr></table></figure>

<p>è®­ç»ƒæ—¶æ¯è®­ç»ƒä¸€è½®åŒæ—¶ä¹Ÿåœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°ä¸€æ¬¡, å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæŸå¤±å€¼éƒ½æ˜¯æˆåŠŸä¸‹é™, ä¸”æ­£ç¡®ç‡é€æ­¥ä¸Šå‡. æœ‰æ—¶é—´çš„è¯å¯ä»¥å¤šè®­ç»ƒå‡ è½®, çœ‹çœ‹æŸå¤±å€¼çš„å˜åŒ–æƒ…å†µ.</p>
<h3 id="è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ"><a href="#è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ" class="headerlink" title="è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ"></a>è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">*_, report = evaluate(model, test_dataloader, loss_fn)</span><br><span class="line"><span class="built_in">print</span>(report)</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0     0.9344    0.9913    0.9620       460</span><br><span class="line">           1     0.9653    0.9737    0.9695       571</span><br><span class="line">           2     0.9176    0.9660    0.9412       530</span><br><span class="line">           3     0.9346    0.9720    0.9529       500</span><br><span class="line">           4     0.9459    0.9440    0.9449       500</span><br><span class="line">           5     0.9566    0.9671    0.9618       456</span><br><span class="line">           6     0.9644    0.9372    0.9506       462</span><br><span class="line">           7     0.9467    0.9023    0.9240       512</span><br><span class="line">           8     0.9585    0.8978    0.9271       489</span><br><span class="line">           9     0.9503    0.9192    0.9345       520</span><br><span class="line"></span><br><span class="line">    accuracy                         0.9470      5000</span><br><span class="line">   macro avg     0.9474    0.9471    0.9469      5000</span><br><span class="line">weighted avg     0.9474    0.9470    0.9468      5000</span><br></pre></td></tr></table></figure>

<p>å…¶å®å°±æ˜¯å†æ¬¡è°ƒç”¨äº†ä¸€ä¸‹ <code>evaluate</code> å‡½æ•°, ä½†æ˜¯è¾“å‡ºäº† report ç»“æœ.</p>
<p>å¯ä»¥çœ‹åˆ°æ­£ç¡®ç‡å°šå¯, è¾¾åˆ°äº† 0.94 å¤š, å¤šè®­ç»ƒå‡ è½®è¯´ä¸å®šä¼šæ›´é«˜. è´´ä¸€ä¸‹è®­ç»ƒäº† 22 è½®çš„ç»“æœ.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0     0.9620    0.9913    0.9764       460</span><br><span class="line">           1     0.9758    0.9895    0.9826       571</span><br><span class="line">           2     0.9701    0.9792    0.9746       530</span><br><span class="line">           3     0.9839    0.9760    0.9799       500</span><br><span class="line">           4     0.9739    0.9720    0.9730       500</span><br><span class="line">           5     0.9759    0.9759    0.9759       456</span><br><span class="line">           6     0.9868    0.9697    0.9782       462</span><br><span class="line">           7     0.9631    0.9688    0.9659       512</span><br><span class="line">           8     0.9710    0.9571    0.9640       489</span><br><span class="line">           9     0.9706    0.9519    0.9612       520</span><br><span class="line"></span><br><span class="line">    accuracy                         0.9732      5000</span><br><span class="line">   macro avg     0.9733    0.9731    0.9732      5000</span><br><span class="line">weighted avg     0.9733    0.9732    0.9732      5000</span><br></pre></td></tr></table></figure>

<p><del>æé«˜äº†è¶³è¶³ <strong>3 ä¸ªç™¾åˆ†ç‚¹</strong>! è¶³ä»¥è®©æˆ‘ä»¬å‘ä¸€ç¯‡ CVPR äº†!</del> çœ‹å¾—å‡ºæ²¡æœ‰å¤ªæ˜æ˜¾çš„æå‡, ä¸€æ˜¯æ•°æ®é›†è¾ƒå°, äºŒæ˜¯ç½‘ç»œç»“æ„æ¯”è¾ƒç®€å•, ä¸è¿‡ä¹Ÿè¶³ä»¥è§åˆ°ç¥ç»ç½‘ç»œçš„å¼ºå¤§äº†.</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸‡å˜ä¸ç¦»å…¶å®—, è™½ç„¶æœ¬ç¯‡æ˜¯ä¸€ä¸ªåªæ˜¯ä¸€ä¸ªéå¸¸ç²¾ç®€çš„æ‰‹å†™æ•°å­—åˆ†ç±», ä½†æ˜¯éº»é›€è™½å°äº”è„ä¿±å…¨, å†å¤§å‹å†å¤æ‚çš„ç½‘ç»œç»“æ„, å®ƒçš„åŸºæœ¬æµç¨‹éƒ½ç¦»ä¸å¼€é‚£å‡ ä¸ªæ­¥éª¤, å”¯ä¸€æ²¡æåˆ°äº†å¯èƒ½å°±æ˜¯é¢å¯¹é•¿æ—¶é—´è®­ç»ƒæƒ…å†µä¸‹, æ€ä¹ˆ &quot;æ–­ç‚¹ç»­è®­&quot; è®°å½•å­˜æ¡£ç‚¹, è¿™ä¸ªé è‡ªå·±æ‘¸ç´¢äº†. <del>éƒ½æ˜¯ç½‘å®‰çš„äº†, è‡ªå­¦ä»€ä¹ˆçš„æ—©å°±ä¼šäº†å§.</del></p>
<p>å®é™…ä¸­, å¾ˆå°‘çœŸçš„è‡ªå·±æ‰‹æ“ç½‘ç»œäº†, å°±ç®—æ˜¯å­¦ä¹ è®ºæ–‡é‡Œçš„æ¨¡å‹, ä¹Ÿéƒ½æ˜¯å°½å¯èƒ½çš„ç›´æ¥æ‹‰å¼€æºä»£ç ä¸‹æ¥è·‘. é‚£ä¹ˆå­¦ä¹ æœ¬ç¯‡çš„ä¸»è¦ç›®çš„æ˜¯çŸ¥é“ä½¿ç”¨ <code>pytorch</code> çš„æœ€åŸºæœ¬çš„å‡ ä¸ªæ­¥éª¤, åœ¨çœ‹å¼€æºä»£ç æ—¶, èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°å„ä¸ªéƒ¨ä»¶éƒ½åœ¨å“ª, ç†è§£ä½œè€…çš„é¡¹ç›®ç»„ç»‡æ–¹å¼, å¹¶ä¸”å¿…è¦æ—¶å¯ä»¥å¯¹æºä»£ç åšå‡ºä¸€å®šçš„è°ƒæ•´.</p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p><code>pytorch</code> çš„å®˜æ–¹ç½‘ç«™: <span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy8=">https://pytorch.org/<i class="fa fa-external-link-alt"></i></span>.</p>
<p>è¿™ä¸ªå®˜æ–¹ç½‘ç«™æŒºå¥½çš„, ä¸ä»…æ–‡æ¡£è¯¦ç»†, åŒæ—¶ä¹Ÿæä¾›äº†å¾ˆå¤šç¤ºä¾‹æ•™å­¦, å¾ˆé€‚åˆå…¥é—¨æˆ–è€…è¯¦ç»†äº†è§£å„ç§æ¥å£.</p>
<p>å¦é™„ä¸Šé¡¹ç›®ä¸­ä½¿ç”¨çš„æ•°æ®é›†ä¸‹è½½åœ°å€, <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pVFBrSzA5cGZuaGE=">ç‚¹å‡»ä¸‹è½½<i class="fa fa-external-link-alt"></i></span>.</p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>å¿…å¤‡æŠ€èƒ½</category>
      </categories>
      <tags>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>pytorch</tag>
        <tag>æ‰‹å†™æ•°å­—åˆ†ç±»</tag>
      </tags>
  </entry>
  <entry>
    <title>Git ä¸ Github å…¥é—¨</title>
    <url>//posts/2022/08/15/wast-gitandgithub/</url>
    <content><![CDATA[<p><code>git</code> ä½ å¯èƒ½ç”¨ä¸åˆ°ä½†æ˜¯ <code>github</code> è‚¯å®šç”¨å¾—åˆ°, å› ä¸ºé¢å¯¹ä¸€å¤§å †ä»£ç ä»»åŠ¡, è°éƒ½æƒ³å»<del>æŠ„</del>å€Ÿé‰´ä¸€ä¸‹ä»–äººä¼˜ç§€çš„ä»£ç .</p>
<p>å› æ­¤æœ¬ç¯‡å°†å‘èŒæ–°ä»¬ä»‹ç»ä¸€ä¸‹ç‰ˆæœ¬ç®¡ç†å·¥å…· <code>git</code> ä¸å…¨ä¸–ç•Œæœ€å¤§çš„ä»£ç æ‰˜ç®¡å¹³å° <code>github</code> çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•.</p>
<span id="more"></span>

<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p>å…ˆè¯´ <code>github</code>, ç®€å•ç²—æš´çš„ç†è§£å°±æ˜¯, <code>github</code> æ˜¯ä¸€ä¸ªä¸“å±äºä»£ç çš„äº‘ç›˜, å…¨ä¸–ç•Œçš„äººéƒ½å¯ä»¥åœ¨ä¸Šé¢å­˜å‚¨è‡ªå·±çš„ä»£ç , å¹¶ä¸”å¯ä»¥è®©å¤§å®¶éƒ½æ¥æŸ¥çœ‹è‡ªå·±çš„ä»£ç .</p>
<p>å¹³å¸¸å¦‚æœé‡åˆ°ä¸€äº›ä¸ä¼šçš„ä»£ç é—®é¢˜, å¤šåŠç”¨æœç´¢å¼•æ“æœå‡ºæ¥çš„éƒ½æ˜¯ CSDN å’Œåšå®¢å›­æˆ–è€…çŸ¥ä¹çš„å†…å®¹, å¶å°”å¯ä»¥è§åˆ°ä¸€äº›ä¸ªäººåšå®¢<del>æ¯”å¦‚æˆ‘è¿™ä¸ª</del>. ä¸ªäººåšå®¢å¯èƒ½è´¨é‡ç¨å¥½, æ¯•ç«Ÿæ˜¯è‡ªå·±ç»è¥çš„, å¤§æ¦‚ç‡ä¼šè®¤çœŸå†™ç‚¹ä¸œè¥¿æ”¾ä¸Šå», ä½†æ˜¯å‰ä¸‰è€…å°±ä¸ä¸€å®šäº†, å¯èƒ½åŒæ ·çš„å†…å®¹éƒ½è¢«å¤åˆ¶çš„æœ‰åŒ…æµ†äº†. å› æ­¤æˆ‘ä»¬å¦‚æœæƒ³è¦è¿›ä¸€æ­¥æå‡è‡ªå·±çš„ Coding æ°´å¹³, å°±éœ€è¦çœ‹æ›´é«˜è´¨é‡çš„å†…å®¹, æ‰€ä»¥æˆ‘ä»¬æŠŠç›®å…‰æŠ•å‘äº† <code>github</code>.</p>
<p><code>github</code> çš„æœ€å¤§å®—æ—¨å°±æ˜¯å¼€æº, ä»»ä½•äººéƒ½å¯ä»¥å‘å¸ƒè‡ªå·±çš„ä»£ç å¹¶ä¸”è®©ä»–äººä¸€èµ·ååŒåˆä½œ. å¾—ç›Šäºæ­¤, <code>github</code> ä¸Šé¢æœ‰å¾ˆå¤šç»å…¸çš„å¤§å‹å¼€æºé¡¹ç›®å¯ä¾›å­¦ä¹ , å¹¶ä¸”å°é¡¹ç›®çš„å®Œæ•´åº¦å’Œè´¨é‡ä¹Ÿæ¯”ä¸€ä¼—åšå®¢é«˜å‡ºä¸å°‘, æ˜¯æˆ‘ä»¬<del>æŠ„</del>å€Ÿé‰´ä»£ç çš„å¥½å»å¤„.</p>
<p><code>github</code> çš„å®˜ç½‘åœ°å€æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tLw==">https://github.com/<i class="fa fa-external-link-alt"></i></span>, ç”±äºä¸å¯æŠ—åŠ›, è®¿é—®ä¸å¤ªç¨³å®š, ä½†æ˜¯å¯ä»¥é€šè¿‡ç§‘å­¦ä¸Šç½‘è§£å†³, å¯ä»¥å‚è€ƒæˆ‘å‰ä¸€ç¯‡æ–‡ç« <a href="/posts/2022/08/15/wast-gitandgithub/">è§£å†³å­¦ä¹ é“è·¯ä¸Šçš„ &quot;æœ€å 1 KB&quot;</a>å¿«é€Ÿå…¥é—¨ä¸€ä¸‹. è¿›å»ä¹‹åå°±å¯ä»¥åƒæ™®é€šçš„æœç´¢å¼•æ“é‚£æ ·ä½¿ç”¨, ä½†æ˜¯æ˜¯æœç´¢ <code>github</code> çš„æ‰€æœ‰é¡¹ç›®ä»“åº“ (å¤šç”¨è‹±è¯­æœ, ç»“æœä¼šæ›´ç†æƒ³).</p>
<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p><code>git</code> å’Œ <code>github</code> é•¿å¾—å¾ˆåƒä½†æ˜¯å®Œå…¨æ˜¯ä¸¤å›äº‹, åè€…æ˜¯ä¸€ä¸ªå­˜æ”¾ä»£ç çš„åœ°æ–¹, ä½†æ˜¯å‰è€…æ˜¯ä¸€ä¸ªä»£ç ç‰ˆæœ¬ç®¡ç†å·¥å…·.</p>
<p>ç½—é©¬ä¸æ˜¯ä¸€å¤©å»ºæˆçš„, ä»£ç ä¹Ÿä¸æ˜¯ä¸€å¤©è‚å®Œçš„, å‰ä¸€å¤©å†™å®Œçš„ä»£ç , åä¸€å¤©å°±ä¼šå‡ºç° bug, å› æ­¤å¯¹ä¸€ä»½ä»£ç ä¸é—´æ–­çš„è¿›è¡Œä¿®ä¿®è¡¥è¡¥æ˜¯å¸¸äº‹. å¦‚æœæ˜¯æ¯•ä¸šè®ºæ–‡, å€’è¿˜æ˜¯å¯ä»¥ç»™æ–‡ä»¶åè‡ªå·±åŠ ä¸Šä¸€ä¸ªç‰ˆæœ¬å·, æ¯”å¦‚ &quot;æœ€ç»ˆç‰ˆ&quot;, &quot;æœ€ç»ˆç‰ˆ v2&quot;...... ä½†æ˜¯å¯¹äºä»£ç æ–‡ä»¶, è¿™å°±ä¸å¤ªé€‚ç”¨äº†.</p>
<p>ä¸€æ˜¯ä»£ç æ–‡ä»¶å°†æ¥ä¼šä¿®æ”¹çš„æ¬¡æ•°å¯èƒ½å¤ªå¤š, ä¸€ä»½æ–‡ä»¶åŠ¨è¾„åå‡ äºŒåæ¬¡, å–è¿™ä¹ˆå¤šç‰ˆæœ¬å·ä¸å¤ªç°å®, äºŒæ˜¯æ— æ³•å¾ˆå¥½çš„å¯¹æ¯”æ¯ä¸€ä¸ªç‰ˆæœ¬æ¯æ¬¡çš„ä¿®æ”¹å˜åŠ¨, æ— æ³•è®©äººä¸€ç›®äº†ç„¶æ¯æ¬¡ä¿®æ”¹éƒ½æ”¹äº†å•¥.</p>
<p>å› æ­¤ <code>git</code> çš„å‡ºç°å¾ˆå¥½è§£å†³äº†ä¸Šè¿°é—®é¢˜, ä¸‹é¢ç®€è¦ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„ <code>git</code> å‘½ä»¤å’ŒåŸºæœ¬æ¦‚å¿µ.</p>
<h3 id="å®‰è£…-Git"><a href="#å®‰è£…-Git" class="headerlink" title="å®‰è£… Git"></a>å®‰è£… Git</h3><p>é¦–å…ˆå½“ç„¶æ˜¯å®‰è£… <code>git</code>, å®˜ç½‘åœ°å€ <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS8=">https://git-scm.com/<i class="fa fa-external-link-alt"></i></span>, ç‚¹è¿›å»ç›´æ¥ &quot;Downloads&quot; æœ€æ–°ç‰ˆæœ¬è¿›è¡Œå®‰è£…, å®‰è£…æ—¶æœ‰ä¸€äº›é€‰é¡¹å€¼å¾—æ³¨æ„ä¸€ä¸‹.</p>
<p><img data-src="/static/image/wast-gitandgithub/vaPitJ.png" alt="vaPitJ.png">]</p>
<p>è¿™ä¸¤ä¸ªå¯ä»¥å‹¾ä¸Š, è¿™æ ·å­å³é”®èœå•é‡Œä¼šåŠ å…¥è¿™ä¸¤ä¸ªå¿«æ·é¡¹, æ–¹ä¾¿æˆ‘ä»¬éšå¤„å¿«é€Ÿæ‰“å¼€ <code>git</code> ç»ˆç«¯.</p>
<p><img data-src="/static/image/wast-gitandgithub/vaPtnf.png" alt="vaPtnf.png"></p>
<p>ç„¶åæ˜¯è¿™ä¸ª, ä½¿ç”¨ <code>VS Code</code> ä½œä¸º <code>git</code> çš„é»˜è®¤æ–‡æœ¬ç¼–è¾‘å™¨. è¦æ±‚æˆ‘ä»¬å®‰è£…äº† <code>VS Code</code>, ç„¶åå‹¾é€‰è¿™ä¸ªé€‰é¡¹. è¿™ä¸ªæ„æ€æ˜¯ä¸€æ—¦ <code>git</code> å‡ºç°éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ•²ä¸€ç‚¹æ–‡æœ¬å†…å®¹çš„æ—¶å€™, ä¼šå¼¹å‡ºæ¥ <code>VS Code</code> ç•Œé¢ä½œä¸ºè¾“å…¥ç•Œé¢. å¼ºçƒˆå»ºè®®æ¢æ‰, ä¸€æ˜¯å¥½çœ‹äºŒæ˜¯çœäº‹<del>ççˆ±ç”Ÿå‘½, è¿œç¦» Vim</del>.</p>
<p><img data-src="/static/image/wast-gitandgithub/vaPTjx.png" alt="vaPTjx.png"></p>
<p>ç„¶åæ˜¯è¿™ä¸ª, ä¹Ÿæ˜¯å»ºè®®é€‰ä¸‹é¢çš„, æ›¾ç» <code>git</code> çš„ä¸»åˆ†æ”¯é»˜è®¤å« <code>master</code>, ä½†æ˜¯ç°åœ¨å¤§éƒ¨åˆ†æ–°é¡¹ç›®éƒ½å« <code>main</code> äº†. ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜, ä½†æ˜¯å»ºè®®æŒ‰æ–°çš„çº¦å®šæ¥<del>ç´§éšæ—¶ä»£æ½®æµ</del>.</p>
<p>åé¢çš„é€‰é¡¹å°±å¯ä»¥ä¸ç”¨å¤ªåœ¨æ„äº†, ç›´æ¥ä¸€è·¯ Next å°±è¡Œäº†, åæ­£ä¹‹åéƒ½è¿˜å¯ä»¥è‡ªå·±æ‰‹åŠ¨è°ƒæ•´è®¾ç½®é¡¹.</p>
<h3 id="ä½¿ç”¨-Git"><a href="#ä½¿ç”¨-Git" class="headerlink" title="ä½¿ç”¨ Git"></a>ä½¿ç”¨ Git</h3><p>è¿™é‡Œåªä»‹ç»å¾…ä¼šè¦ç”¨åˆ°çš„å‘½ä»¤å’Œä¸€äº›åŸºæœ¬æ¦‚å¿µ, æ¯•ç«Ÿæ˜¯å…¥é—¨<del>ä¸»è¦æ˜¯å¤ªæ‡’ä¸æƒ³å†™</del>, å…·ä½“çš„ç»†èŠ‚å¯ä»¥è‡ªå·±çœ‹å®˜æ–¹æ–‡æ¡£æˆ–è€…ä½¿ç”¨æœç´¢å¼•æ“å­¦ä¹ .</p>
<p><code>git init</code>: åˆå§‹åŒ–ä¸€ä¸ªæœ¬åœ°ä»“åº“.</p>
<p>æƒ³è¦ä½¿ç”¨ <code>git</code> æ¥ç®¡ç†ä¸€ä¸ªé¡¹ç›®, é¦–å…ˆéœ€è¦ä½¿ç”¨è¯¥å‘½ä»¤è®© <code>git</code> å°†ä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹æ ‡è®°ä¸ºéœ€è¦è¢« <code>git</code> è¿›è¡Œç®¡ç†çš„ä»“åº“. è¿è¡Œå®Œæˆå, é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹å°±ä¼šå¤šå‡ºæ¥ä¸€ä¸ª <code>.git</code> æ–‡ä»¶å¤¹, ä»£è¡¨è¿™ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹å·²ç»æ˜¯ä¸€ä¸ªåˆæ³•çš„ <code>git</code> ä»“åº“äº†.</p>
<p><code>git add &lt;æ–‡ä»¶&gt;</code>: ä¸´æ—¶å‚¨å­˜æ–‡ä»¶å˜åŠ¨.</p>
<p>å½“æˆ‘ä»¬çš„ä»£ç æ–‡ä»¶å‘ç”Ÿæ”¹åŠ¨æ—¶, ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œä¸´æ—¶å­˜å‚¨, æ‰€è°“ &quot;ä¸´æ—¶&quot;, æ˜¯æŒ‡æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œæˆä¸€æ¬¡å®Œæ•´çš„ä¿®æ”¹, ä½†æ˜¯éœ€è¦ä¸´æ—¶ä¿å­˜ä¸€ä¸‹å·²ç»åšè¿‡çš„ä¿®æ”¹æ­¥éª¤, è®©æˆ‘ä»¬åœ¨è¿›ä¸€æ­¥ä¿®æ”¹æ—¶å¥½è¿›è¡Œå¯¹æ¯”.</p>
<p><code>git commit -m &lt;ä¿¡æ¯&gt;</code>: æäº¤ä¸€æ¬¡æ”¹åŠ¨.</p>
<p>å½“æˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€æ¬¡ä¿®æ”¹, ä½¿ç”¨äº† <code>add</code> è¿›è¡Œäº†å­˜å‚¨, å¹¶ä¸”æƒ³è¦æŠŠè¿™æ¬¡ä¿®æ”¹ç¡®å®šä¸‹æ¥, å½¢æˆä¸€æ¬¡è®°å½•æ—¶, éœ€è¦ä½¿ç”¨è¯¥å‘½ä»¤. å…¶ä¸­ &quot;ä¿¡æ¯&quot; éƒ¨åˆ†æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„å†…å®¹, æ˜¯å¯¹è¿™ä¸€æ¬¡æäº¤çš„ä¸€ä¸ªç®€è¦è¯´æ˜, æ—¥åæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ ¹æ®å½“æ—¶æäº¤æ—¶å¡«çš„ä¿¡æ¯æ¥ç¡®å®šæäº¤çš„å†…å®¹, ä¹Ÿå¯ä»¥ä»å¤§é‡æäº¤ä¸­å¿«é€Ÿæ£€ç´¢ä¸æŸäº›ç‰¹å®šç›®çš„ç›¸å…³çš„æäº¤.</p>
<p><code>git log --graph --oneline --all</code>: ä½¿ç”¨å›¾å½¢åŒ–æ–¹å¼æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯çš„æäº¤è®°å½•.</p>
<p>ä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æäº¤è®°å½•ä»¥åŠå„æäº¤è®°å½•çš„å“ˆå¸Œå€¼, æœ‰åŠ©äºæˆ‘ä»¬è¿…é€Ÿäº†è§£æ•´ä¸ªä»“åº“çš„æäº¤å†å²è®°å½•.</p>
<p><code>git show &lt;æäº¤ id&gt;</code>: æŸ¥çœ‹æŸä¸€æ¬¡æäº¤çš„å…·ä½“å†…å®¹.</p>
<p>&quot;æäº¤ id&quot; å°±æ˜¯ä½¿ç”¨ <code>git log</code> æŸ¥åˆ°çš„æäº¤è®°å½•å“ˆå¸Œå€¼, æ˜¾ç¤ºä¹‹åä¼šå¾—åˆ°æ–‡ä»¶å˜åŠ¨è®°å½•ä»¥åŠå„æ–‡ä»¶å…·ä½“çš„ä¿®æ”¹æƒ…å†µ.</p>
<h3 id="ç®€å•çš„å®è·µä¸€ä¸‹"><a href="#ç®€å•çš„å®è·µä¸€ä¸‹" class="headerlink" title="ç®€å•çš„å®è·µä¸€ä¸‹"></a>ç®€å•çš„å®è·µä¸€ä¸‹</h3><p>ä»¥æˆ‘ä»¬ä¹‹å‰æ›¾ç»åˆ›å»ºè¿‡çš„ä¸€ä¸ª <code>example</code> é¡¹ç›®ä¸¾ä¾‹, æ¥ä½¿ç”¨ <code>git</code> å¯¹å…¶è¿›è¡Œæœ¬åœ°ç‰ˆæœ¬ç®¡ç†, é¡¹ç›®æ–‡ä»¶ç»“æ„å¦‚ä¸‹æ‰€ç¤º.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">example/</span><br><span class="line">    env/</span><br><span class="line">    main.py</span><br></pre></td></tr></table></figure>

<p>æ€»å…±ä¸¤éƒ¨åˆ†, ä¸€ä¸ªæ˜¯ <code>env</code> æ–‡ä»¶å¤¹, <code>python</code> çš„è™šæ‹Ÿç¯å¢ƒ, å¦ä¸€ä¸ªæ˜¯æˆ‘ä»¬çš„æºæ–‡ä»¶ <code>main.py</code>, æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åªæäº¤ <code>main.py</code>, è€Œå¿½ç•¥è™šæ‹Ÿç¯å¢ƒ <code>env</code>, å› ä¸ºç¯å¢ƒä¸¥æ ¼æ¥è¯´å¹¶ä¸éœ€è¦è®°å½•åˆ°æ•´ä¸ªé¡¹ç›®é‡Œ, æ¯æ¬¡ä½¿ç”¨æ—¶å¯ä»¥é‡æ–°ç”Ÿæˆ. å®Œæ•´çš„å‘½ä»¤æ‰§è¡Œè®°å½•å¦‚å›¾æ‰€ç¤º.</p>
<p><img data-src="/static/image/wast-gitandgithub/vaVnBt.png" alt="vaVnBt.png"></p>
<p>é¦–å…ˆè¿›å…¥ <code>example</code> æ–‡ä»¶å¤¹, ç„¶åä½¿ç”¨ <code>ls</code> å‘½ä»¤æŸ¥çœ‹äº†ä¸€ä¸‹æ–‡ä»¶å¤¹å†…çš„å†…å®¹. ä¹‹åä¾¿æ˜¯ <code>init -&gt; add -&gt; commit</code> çš„ä¸€è¿ä¸²æ“ä½œ.</p>
<p>éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯, ç¬¬ä¸€æ¬¡ä½¿ç”¨ <code>commit</code> æ—¶, ä¼šç»™äºˆæˆ‘ä»¬å›¾ä¸Šçš„æç¤ºä¿¡æ¯, æ„æ€æ˜¯æäº¤æ—¶éœ€è¦æŒ‡å®šä½œè€…ä¿¡æ¯. ä¹Ÿå°±æ˜¯å¯¹äºæ¯æ¬¡æäº¤, <code>git</code> å¿…é¡»è®°å½•æ˜¯ &quot;è°&quot; æäº¤äº†è¿™æ¬¡ä¿®æ”¹, å¹¶ä¸”æ˜¯é€šè¿‡ &quot;é‚®ç®±&quot; å’Œ &quot;ç”¨æˆ·å&quot; ä¸¤ä¸ªä¿¡æ¯æ¥ç¡®å®šèº«ä»½çš„. è¿™é‡Œæˆ‘ä»¬ç›´æ¥æŒ‰ç…§æç¤ºä¿¡æ¯é‡Œè¯´çš„, è®¾ç½®ä¸€ä¸‹è‡ªå·±çš„é‚®ç®±å’Œç”¨æˆ·å, ç„¶åé‡æ–°ä½¿ç”¨ <code>commit</code> å‘½ä»¤è¿›è¡Œæäº¤å³å¯.</p>
<p><img data-src="/static/image/wast-gitandgithub/vaVI8e.png" alt="vaVI8e.png"></p>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨ <code>log</code> å’Œ <code>show</code> ä¸¤ä¸ªå‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹åˆšåˆšçš„æäº¤è®°å½•, å…¶ä¸­ <code>+</code> è¡¨ç¤ºæ–‡ä»¶å†…æ–°å¢çš„è¡Œ, è€Œ <code>-</code> è¡¨ç¤ºåˆ å»çš„è¡Œ, ä¸€èˆ¬æ¥è¯´å¦‚æœæ˜¯å¯¹æŸä¸€è¡Œè¿›è¡Œäº†ä¿®æ”¹åˆ™ä¼šæ˜¯ <code>+</code> å’Œ <code>-</code> äº¤æ›¿å‡ºç°, è¿™é‡Œåªæœ‰ <code>+</code> æ˜¯å› ä¸ºæäº¤äº†ä¸€ä»½å…¨æ–°çš„æ–‡ä»¶.</p>
<h2 id="ä½¿ç”¨-Git-ç®¡ç†-Github-ä¸Šçš„é¡¹ç›®"><a href="#ä½¿ç”¨-Git-ç®¡ç†-Github-ä¸Šçš„é¡¹ç›®" class="headerlink" title="ä½¿ç”¨ Git ç®¡ç† Github ä¸Šçš„é¡¹ç›®"></a>ä½¿ç”¨ Git ç®¡ç† Github ä¸Šçš„é¡¹ç›®</h2><h3 id="Git-åˆ†æ”¯ç®€ä»‹"><a href="#Git-åˆ†æ”¯ç®€ä»‹" class="headerlink" title="Git åˆ†æ”¯ç®€ä»‹"></a>Git åˆ†æ”¯ç®€ä»‹</h3><p>å¦‚æœ <code>git</code> çš„åŠŸèƒ½ä»…é™äºæœ¬åœ°ç®¡ç†, é‚£ä¹Ÿå°±æ­¢æ­¥äºæ­¤äº†, å…¶æœ€å¼ºå¤§çš„åŠŸèƒ½è¿˜æ˜¯ä¸ <code>github</code> ç»“åˆ, ä»è€Œå®ç°æœ¬åœ°ä¸è¿œç¨‹åŒæ­¥çš„ç‰ˆæœ¬ç®¡ç†.</p>
<p>è¿™é‡Œéœ€è¦å…ˆä»‹ç»ä¸€ä¸‹ <code>git</code> è¿›è¡Œç‰ˆæœ¬ç®¡ç†çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µ &quot;åˆ†æ”¯&quot;.</p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ <code>git init</code> å‘½ä»¤åˆ›å»ºæœ¬åœ°ä»“åº“æ—¶, å…¶å®å°±æœ‰äº†ç¬¬ä¸€ä¸ªåˆ†æ”¯, ä¹Ÿæ˜¯æˆ‘ä»¬çš„ä¸»åˆ†æ”¯ <code>main</code>, åå­—å°±æ˜¯åœ¨å®‰è£… <code>git</code> æ—¶è®¾å®šçš„é»˜è®¤åç§°.</p>
<p>å½“æˆ‘ä»¬å¯¹ä»“åº“è¿›è¡Œæ“ä½œå¹¶æäº¤è®°å½•æ—¶, <code>git</code> éœ€è¦çŸ¥é“å½“å‰ä»“åº“æ­£å¤„äºå“ªä¸€ä¸ªåˆ†æ”¯ä¸Š, å¹¶æŠŠæäº¤è®°å½•åœ¨è¿™ä¸ªåˆ†æ”¯ä¸Š, å½¢æˆåˆ†æ”¯ä¸Šçš„ä¸€ä¸ªä¸ªèŠ‚ç‚¹. ä»è€Œå¾ˆå¤šæ¬¡æäº¤ä¹‹å, è¿™ä¸ªåˆ†æ”¯ä¼šé€æ¸å˜é•¿, å¹¶ä¸”ä¸Šé¢çš„èŠ‚ç‚¹æ•°å˜å¤š, æ¯ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯æ¯ä¸€æ¬¡æäº¤è®°å½•.</p>
<p>å½“ä½ æŸå¤©æƒ³è®©ä½ çš„ä»£ç å½¢æˆå¦å¤–ä¸€ä¸ªç‰ˆæœ¬æ—¶, ä½†æ˜¯å¹¶ä¸æƒ³å½±å“ä¸»åˆ†æ”¯ä¸Šçš„å†…å®¹æ—¶, å°±å¯ä»¥ä»ä¸»åˆ†æ”¯çš„æŸä¸ªèŠ‚ç‚¹å¼€å§‹, å»¶ä¼¸å‡ºå¦ä¸€æ¡æ–°åˆ†æ”¯, ä»è€Œè®©ä¸¤ä¸ªåˆ†æ”¯ä¸Šçš„å†…å®¹åŒæ—¶å­˜åœ¨ä¸”äº’ä¸å¹²æ‰°. å¯æƒ³è€ŒçŸ¥, å½“åˆ†æ”¯æ•°å¤šäº†ä¹‹å, åˆ†æ”¯å›¾å°†ä¼šæ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„.</p>
<p>æœ¬åœ°ä»“åº“æ˜¯å¦‚æ­¤, å¯¹äºè¿œç¨‹ä»“åº“æ¥è¯´ä¹Ÿæ˜¯ç±»ä¼¼çš„. å½“æˆ‘ä»¬éœ€è¦å°†æœ¬åœ°çš„ä»£ç ä»“åº“åŒæ­¥æ”¾åˆ° <code>Github</code> ä¸Šè¿›è¡Œç®¡ç†æ—¶, åˆ™éœ€è¦æ·»åŠ ä»“åº“å†…çš„ &quot;è¿œç¨‹åˆ†æ”¯&quot; ä¿¡æ¯.</p>
<p>è¿œç¨‹åˆ†æ”¯ä¸æœ¬åœ°çš„åˆ†æ”¯åƒå¹¶åˆ—çš„å…³ç³», å®ƒä»¬ä¹‹é—´å½¢æˆå…³è”å¹¶è¿›è¡Œè¿½è¸ª, ä»è€Œä½ å¯ä»¥æŒ‡å®šæœ¬åœ°çš„æŸä¸ªåˆ†æ”¯ä¸è¿œç¨‹çš„æŸä¸ªåˆ†æ”¯è¿›è¡Œå…³è”å¹¶åŒæ­¥. æœ€ç»ˆè¿œç¨‹ä»“åº“çš„è¿œç¨‹åˆ†æ”¯å°±åƒæ˜¯æœ¬åœ°ä»“åº“åˆ†æ”¯çš„ä¸€ä»½ &quot;å¤‡ä»½&quot;, æ— è®ºæ˜¯å“ªä¸€è¾¹æœ‰æ”¹åŠ¨, éƒ½å¯ä»¥é€šè¿‡ <code>git</code> æŒ‡ä»¤æ¥è¿›è¡Œäº’ç›¸åŒæ­¥.</p>
<p>è¿™é‡Œæ”¾ä¸Šä¸€ä¸ªç»å…¸çš„å›¾å½¢åŒ– <code>git</code> æ“ä½œå­¦ä¹ ç½‘ç«™ <span class="exturl" data-url="aHR0cHM6Ly9sZWFybmdpdGJyYW5jaGluZy5qcy5vcmcv">Leanr Git Branching<i class="fa fa-external-link-alt"></i></span>, æœ‰åŠ©äºå¿«é€Ÿç†è§£ <code>git</code> çš„åˆ†æ”¯æ¦‚å¿µ<del>å‡ ä¹æˆ‘æ‰€æœ‰è®¤è¯†çš„å­¦é•¿éƒ½æ¨èè¿‡</del>.</p>
<h3 id="åœ¨-Github-ä¸Šå‘å¸ƒç¬¬ä¸€ä¸ªé¡¹ç›®"><a href="#åœ¨-Github-ä¸Šå‘å¸ƒç¬¬ä¸€ä¸ªé¡¹ç›®" class="headerlink" title="åœ¨ Github ä¸Šå‘å¸ƒç¬¬ä¸€ä¸ªé¡¹ç›®"></a>åœ¨ Github ä¸Šå‘å¸ƒç¬¬ä¸€ä¸ªé¡¹ç›®</h3><p>é¦–å…ˆ, ä½ å¾—æ³¨å†Œä¸€ä¸ª <code>Github</code> è´¦å·, ç‚¹ <code>Sign up</code> ä¹‹åè‡ªå·±ç¢ç£¨å§.</p>
<p>æ³¨å†Œå¥½ä¹‹å, ä½ çš„ä¸ªäººç•Œé¢ç½‘å€åº”è¯¥å°±æ˜¯ <code>https://github.com/&lt;ç”¨æˆ·å&gt;/</code>, å¹¶ä¸”è¿›å»åç•Œé¢å¤§æ¦‚é•¿çš„åƒä¸‹é¢çš„æ ·å­.</p>
<p><img data-src="/static/image/wast-gitandgithub/vaLItP.png" alt="vaLItP.png"></p>
<p>ä½†æ˜¯åœ¨åˆ›å»ºä»“åº“å‘å¸ƒé¡¹ç›®ä¹‹å‰, è¿˜æœ‰ä¸€æ­¥é‡è¦çš„äº‹æƒ…, å¾€è‡ªå·±çš„ <code>Github</code> é‡Œæ·»åŠ  <code>ssh</code> è¿æ¥å…¬é’¥, å¯èƒ½ç°åœ¨ä½ è¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆä½†æ˜¯ç…§ç€æ•™ç¨‹åšå³å¯, æ—¢å¯ä»¥æé«˜å®‰å…¨æ€§ä¹Ÿå¯ä»¥é¿å…ä¸€äº›éº»çƒ¦. (å¦‚æœæœ‰å–œæ¬¢å°è¯•çš„åŒå­¦å¯ä»¥è¯•ä¸€ä¸‹èµ° <code>http</code> åè®®çš„æ–¹å¼, <code>Github</code> å·²ç»ä¸æ¨èå¹¶ä¸”ç”±äºä¸å¯æŠ—åŠ›ç½‘ç»œè´¨é‡ä¹Ÿå¾ˆå·®.)</p>
<p>è´´ä¸Šå®˜æ–¹çš„<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vY24vYXV0aGVudGljYXRpb24vY29ubmVjdGluZy10by1naXRodWItd2l0aC1zc2g=">æ•™ç¨‹<i class="fa fa-external-link-alt"></i></span>, åŒæ—¶ä¸‹é¢ä¹Ÿä¼šç®€è¦æè¿°ä¸€ä¸‹æ­¥éª¤.</p>
<div class="note info"><p>1.ç”Ÿæˆè‡ªå·±çš„ ssh å…¬é’¥<br>å¦‚æœæ›¾ç»å·²ç»ç”Ÿæˆè¿‡çš„åŒå­¦å¯ä»¥é…Œæƒ…è·³è¿‡è¿™ä¸€æ­¥.<br>æ‰“å¼€ <code>git bash</code> æˆ–è€… <code>cmd</code>, è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤.<br><code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;</code><br>å…¶ä¸­ <code>-C</code> åé¢è·Ÿçš„æ˜¯æ³¨é‡Šå†…å®¹, ä¸€èˆ¬å¡«ä¸€ä¸ªèƒ½å¤Ÿæ ‡è¯†èº«ä»½çš„é‚®ç®±åœ°å€. ä¹‹åä¸€è·¯å›è½¦å³å¯.<br>æˆåŠŸç”Ÿæˆä¹‹å, å¯ä»¥ä½¿ç”¨ <code>ls</code> å’Œ <code>cat</code> å‘½ä»¤æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶ä¸å…¬é’¥å†…å®¹.<br>æ‰€æœ‰æ“ä½œå’ŒæˆåŠŸç”Ÿæˆåçš„ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º.<br><img data-src="/static/image/wast-gitandgithub/vwila8.png" alt="vwila8.png"><br>2.å°†å…¬é’¥æ·»åŠ åˆ° Github<br>å›åˆ° <code>github</code> çš„ä¸ªäººä¸»é¡µé¢, è¿›å…¥ &quot;Settings&quot; ç•Œé¢, åœ¨å·¦ä¾§é€‰æ‹© &quot;SSH and GPG Keys&quot;, ç„¶åé€‰æ‹© <code>New SSH Key</code>, å¹¶å°†<strong>å…¬é’¥æ–‡ä»¶ <code>id_rsa.pub</code></strong> çš„å†…å®¹å¤åˆ¶è¿›å», æ³¨æ„æ˜¯<strong>å…¬é’¥æ–‡ä»¶ <code>id_rsa.pub</code></strong>.<br><img data-src="/static/image/wast-gitandgithub/vwi2s1.png" alt="vwi2s1.png"></p>
</div>

<p>ç»§ç»­å›åˆ°æˆ‘ä»¬çš„ <code>Github</code> ä¸ªäººä¸»é¡µé¢, ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„åŠ å·, é€‰æ‹© &quot;New repository&quot;, åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ä»“åº“.</p>
<p><img data-src="/static/image/wast-gitandgithub/v0E9gg.png" alt="v0E9gg.png"></p>
<p>å¦‚å›¾æ‰€ç¤ºå¡«å¥½å¿…è¦çš„ä¿¡æ¯, å…¶ä¸­é€‰é¡¹ public å³ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå…¬å¼€ä»“åº“, ä»»ä½•äººéƒ½å¯ä»¥åœ¨ <code>github</code> ä¸Šè®¿é—®å¹¶æŸ¥çœ‹é‡Œé¢çš„æ–‡ä»¶å†…å®¹.</p>
<p>åˆ›å»ºå®Œæˆå, ä¼šæ˜¾ç¤ºä¸‰ç§åç»­çš„æ“ä½œ, åœ¨è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç¬¬äºŒç§, &quot;å°†å·²æœ‰çš„ä»“åº“ä»å‘½ä»¤è¡Œæ¨é€&quot;.</p>
<p>è¿›å…¥ä½ çš„æœ¬åœ°ä»“åº“, æ‰“å¼€ <code>git bash</code> å¹¶ä¾æ¬¡æ‰§è¡Œä¸‹é¢ä¸‰æ¡å‘½ä»¤.</p>
<p><code>git remote add origin git@github.com:&lt;ç”¨æˆ·å&gt;/&lt;ä»“åº“å&gt;.git</code>: å°†è¿œç¨‹ä¸»æœºä¸ä»“åº“åœ°å€æ·»åŠ åˆ°æœ¬åœ°ä»“åº“é…ç½®ä¸­, ä¸»æœºå <code>origin</code>, åœ°å€ä¸º <code>ssh</code> åœ°å€ <code>git@github.com:&lt;ç”¨æˆ·å&gt;/&lt;ä»“åº“å&gt;.git</code></p>
<p><code>git branch -M main</code>: å¯é€‰æ­¥éª¤, å°†å½“å‰åˆ†æ”¯é‡å‘½åä¸º <code>main</code>, æ­¤å‰æˆ‘ä»¬çš„åˆ†æ”¯åå·²ç»æ˜¯ <code>main</code> äº†.</p>
<p><code>git push -u origin main</code>: å°†æœ¬åœ°åˆ†æ”¯ <code>main</code> æ¨é€åˆ°è¿œç¨‹ä¸»æœº <code>origin</code>, å¹¶ä¸”è¿œç¨‹åˆ†æ”¯åä¸æœ¬åœ°ç›¸åŒä¹Ÿä¸º <code>main</code>.</p>
<p>æ‰§è¡Œå®Œæˆåç¨ç­‰ä¸€ä¼šåˆ·æ–°ä¸€ä¸‹é¡µé¢, å°±å¯ä»¥çœ‹åˆ° <code>github</code> ä¸Šå·²ç»æœ‰æœ¬åœ°ä»“åº“çš„å†…å®¹äº†.</p>
<h3 id="åœ¨æœ¬åœ°ç®¡ç†è¿œç¨‹é¡¹ç›®"><a href="#åœ¨æœ¬åœ°ç®¡ç†è¿œç¨‹é¡¹ç›®" class="headerlink" title="åœ¨æœ¬åœ°ç®¡ç†è¿œç¨‹é¡¹ç›®"></a>åœ¨æœ¬åœ°ç®¡ç†è¿œç¨‹é¡¹ç›®</h3><p>è¿™éƒ¨åˆ†ä¸»è¦ä»‹ç»å¹³å¸¸æ•²ä»£ç æ—¶å¸¸ç”¨çš„å‘½ä»¤æµ.</p>
<p><code>git pull</code>: è¿›è¡Œå†™ä»£ç æ—¶çš„ç¬¬ä¸€æ­¥, ä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥å°†è¿œç¨‹ä»“åº“é‡Œçš„æœ€æ–°è®°å½•åŒæ­¥è‡³æœ¬åœ°.</p>
<p><code>git add &lt;æ–‡ä»¶&gt;</code>: å†™ä»£ç ä¸­é€”æˆ–è€…å†™å®Œä»£ç å, å°†ä¿®æ”¹åçš„æ–‡ä»¶è¿›è¡Œå‚¨å­˜.</p>
<p><code>git commit -m &lt;ä¿¡æ¯&gt;</code>: å°†æ‰€æœ‰é€šè¿‡ <code>add</code> å­˜å‚¨çš„å†…å®¹è¿›è¡Œæäº¤, äº§ç”Ÿä¸€æ¬¡è®°å½•.</p>
<p><code>git push</code>: å°†æœ¬åœ°æ‰€æœ‰çš„æäº¤è®°å½•åŒæ­¥æ¨é€åˆ°è¿œç¨‹ä»“åº“.</p>
<h2 id="åœ¨-VS-Code-ä¸­ä½¿ç”¨-Git"><a href="#åœ¨-VS-Code-ä¸­ä½¿ç”¨-Git" class="headerlink" title="åœ¨ VS Code ä¸­ä½¿ç”¨ Git"></a>åœ¨ VS Code ä¸­ä½¿ç”¨ Git</h2><p>å‰é¢èŠ±äº†å¾ˆé•¿çš„ç¯‡å¹…è®²è§£ <code>git</code> çš„å„ç§ä½¿ç”¨, å¹¶ä¸”æœ‰ç€éå¸¸å¤šçš„å‘½ä»¤, å¾ˆå®¹æ˜“è®©äººå¤´æ™•. ä½†æ˜¯å¥½åœ¨å¤§éƒ¨åˆ†å‘½ä»¤éƒ½æ˜¯é‡å¤ç›¸ä¼¼çš„, å› æ­¤, ä¸ºäº†çœäº‹, ç»å¤§å¤šæ•°å¼€å‘å·¥å…·éƒ½æ”¯æŒå›¾å½¢åŒ–çš„ <code>git</code> å‘½ä»¤æ“ä½œ, ä»è€Œé¿å…äº†å‘½ä»¤è¡Œçš„ç—›è‹¦. ä½†æ˜¯åœ¨ä½¿ç”¨æ—¶ä»ç„¶éœ€è¦çŸ¥é“æ¯ä¸€ä¸ªæŒ‰é”®é€‰é¡¹ä¸å‘½ä»¤çš„åŸºæœ¬å¯¹åº”å…³ç³», æ¸…æ¥šæ¯ä¸€æ­¥å…·ä½“åšäº†ä»€ä¹ˆ.</p>
<p><code>VS Code</code> æœ¬èº«è‡ªå¸¦å¯¹ <code>git</code> çš„æ”¯æŒ, ä¸”å·²ç»èƒ½å¤Ÿæ»¡è¶³åŸºæœ¬ä½¿ç”¨. æ‰“å¼€æˆ‘ä»¬çš„ <code>example</code> é¡¹ç›®, å·¦è¾¹åˆ‡æ¢åˆ° <code>æºä»£ç ç®¡ç†</code> çš„é¢æ¿.</p>
<p><img data-src="/static/image/wast-gitandgithub/v0naB4.png" alt="v0naB4.png"></p>
<p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ¬åœ°ä»“åº“çš„æ‰€æœ‰æ›´æ”¹, æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨åˆ‡æ¢ä¸€ä¸‹è§†å›¾æ¨¡å¼, ä»¥æ ‘å½¢å¼æŸ¥çœ‹, æ–¹ä¾¿ä¸èµ„æºç®¡ç†å™¨çš„è§†å›¾å¯¹åº”.</p>
<p>å¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸¤éƒ¨åˆ†å˜åŠ¨, ä¸”æ ‡è®°ä¸º <code>U</code>, æ„ä¸º &quot;æœªè·Ÿè¸ª&quot;, ä¹Ÿå°±æ˜¯å®ƒæ˜¯ä¸€ä»½æ–°æ–‡ä»¶, å¦‚æœæ˜¯æ›¾ç»æœ‰è¿‡è®°å½•åˆ™æ˜¯ <code>M</code>. ç‚¹å‡»å·¦ä¾§çš„æ–‡ä»¶å, è¿˜å¯ä»¥åœ¨å³æ–¹çš„çª—å£é‡Œé¢„è§ˆæ–‡ä»¶çš„æ¯ä¸€è¡Œæ›´æ”¹æƒ…å†µ.</p>
<p>æˆ‘ä»¬é€‰æ‹© <code>main.py</code> ä¸€è¡Œå³ä¾§çš„ <code>+</code> å·, &quot;æš‚å­˜æ›´æ”¹&quot;, å…¶è¡Œä¸ºç­‰ä»·äº <code>add</code> æ“ä½œ.</p>
<p><img data-src="/static/image/wast-gitandgithub/v0uFrF.png" alt="v0uFrF.png"></p>
<p>æ“ä½œä¹‹å <code>main.py</code> è¢«æ”¾å…¥ &quot;æš‚å­˜çš„æ›´æ”¹&quot; ä¸­, æ­¤æ—¶å¯ä»¥åœ¨ä¸Šæ–¹çš„è¾“å…¥æ¡†ä¸­é”®å…¥ä¿¡æ¯, ç„¶åç‚¹æäº¤, è¯¥æ­¥éª¤ç­‰ä»·äº <code>git commit</code> æ“ä½œ.</p>
<p>å¦‚æœæ²¡æœ‰æš‚å­˜çš„æ›´æ”¹, åˆ™æ‰€æœ‰çš„æ›´æ”¹éƒ½å°†ä¼šè¢«æäº¤. å¦‚æœæäº¤ä¿¡æ¯ä¸ºç©º, åˆ™ä¼šå¼¹å‡ºç•Œé¢è®©ä½ è¾“å…¥ä¿¡æ¯.</p>
<p><img data-src="/static/image/wast-gitandgithub/v0KiWt.png" alt="v0KiWt.png"></p>
<p>æäº¤å®Œæˆå, <code>VS Code</code> å·¦ä¸‹è§’å°†ä¼šå¦‚å›¾æ‰€ç¤º, æœ‰ä¸€ä¸ªåŒç®­å¤´åœ†åœˆä¸”æœ‰æ•°å­—æ ‡è®°, æ„ä¸ºæœ¬åœ°æ¯”è¿œç¨‹å¤šä¸€æ¬¡æäº¤è®°å½•, ç‚¹å‡»åœ†åœˆ, <code>VS Code</code> ä¼šå°†æœ¬åœ°ä»“åº“ä¸è¿œç¨‹ä»“åº“è¿›è¡Œè‡ªåŠ¨åŒæ­¥, å…¶æ“ä½œç­‰ä»·äºå…ˆè¿›è¡Œ <code>pull</code> å†è¿›è¡Œ <code>push</code>.</p>
<p>ä¸€èˆ¬æ¥è¯´, æ¨èä½¿ç”¨å‘½ä»¤è¡Œåˆ›å»ºä»“åº“ä»¥åŠå…³è”è¿œç¨‹ä»“åº“ç­‰åˆå§‹åŒ–æ“ä½œ, ä¹‹åå†ä½¿ç”¨å›¾å½¢åŒ–ç•Œé¢è¿›è¡Œæ¯å¤©çš„æäº¤å’ŒåŒæ­¥æ“ä½œ. æ­¤å¤–, å¦‚æœè§‰å¾— <code>VS Code</code> åŸç”Ÿæ”¯æŒä¸å¤Ÿ, è¿˜æœ‰ä¸°å¯Œçš„æ’ä»¶å¯ä»¥é€‰æ‹©, æ¯”å¦‚ <code>GitLens</code> è¯¸å¦‚æ­¤ç±».</p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å°½å¯èƒ½çš„æŠŠå¹³å¸¸é«˜é¢‘ä½¿ç”¨çš„å†…å®¹éƒ½å†™ä¸Šå»äº†, è™½ç„¶æ„Ÿè§‰å†™çš„å¾ˆé•¿ä½†æ˜¯ä»ç„¶å¾ˆéš¾æŠŠæ¯ä¸€ä»¶äº‹éƒ½å†™çš„å¾ˆæ¸…æ¥š, åªèƒ½æ˜¯æŠŠè¡¨é¢å†™ä¸€å†™, å†…éƒ¨çš„ç»†èŠ‚åŸç†ä¸æ˜¯è¿™ä¸ªå…¥é—¨ç¯‡èƒ½ä¸€æ¬¡æ€§æå®š, è¿˜å¾—é è‡ªå·±å¹³æ—¥å–„ç”¨æœç´¢å¼•æ“å’Œå®˜æ–¹æ–‡æ¡£.</p>
<p>è¿™é‡Œè´´ä¸€ä¸‹ <code>git</code> ä¸ <code>github</code> çš„æ–‡æ¡£åœ°å€, <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9kb2Nz">https://git-scm.com/docs<i class="fa fa-external-link-alt"></i></span>, <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vY24=">https://docs.github.com/cn<i class="fa fa-external-link-alt"></i></span>, ç†Ÿèƒ½ç”Ÿå·§~</p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>å¿…å¤‡æŠ€èƒ½</category>
      </categories>
      <tags>
        <tag>git</tag>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»å…¸é—®é¢˜ä¹‹æ–‡æœ¬åˆ†ç±»</title>
    <url>//posts/2022/08/17/wast-ml/</url>
    <content><![CDATA[<p>æˆä¸ºä¸€ä¸ªç†Ÿç»ƒçš„è°ƒåŒ…ä¾ æ˜¯é€Ÿé€šçš„å…³é”®è¦ç´ ä¹‹ä¸€, åœ¨æ— æ•°çš„è¯¾ç¨‹å¤§ä½œä¸šå’Œå°ä»»åŠ¡ä¸­, ä½¿ç”¨æœºå™¨å­¦ä¹ æ¥è§£å†³ä¸€äº›é—®é¢˜ç®—æ˜¯ç»å…¸ä¸­çš„ç»å…¸<del>å…¸ä¸­å…¸</del>, æ¯”å¦‚é€šè¿‡æ–‡æœ¬åˆ†ç±»æ¥å®ç°åƒåœ¾é‚®ä»¶è¿‡æ»¤. å› æ­¤æœ¬ç¯‡å°†åŸºäº <code>python</code> ä¸­æœ€å¸¸ç”¨çš„æœºå™¨å­¦ä¹ åº“ <code>scikit-learn</code>, ç”¨æœ´ç´ è´å¶æ–¯æ¨¡å‹æ¥å®Œæˆä¸€æ¬¡æ–‡æœ¬åˆ†ç±»ä»»åŠ¡.</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>éœ€è¦çš„ç¬¬ä¸‰æ–¹åº“.</p>
<p><code>jieba</code>: ä¸€ä¸ªä¸­æ–‡åˆ†è¯åº“, å¯ä»¥å°†ä¸€ä¸ªå¥å­åˆ†æˆä¸€ä¸ªä¸ªçš„å•è¯.</p>
<p><code>scikit-learn</code>: <code>python</code> ä¸­æœ€å¸¸ç”¨çš„æœºå™¨å­¦ä¹ åº“, å†…ç½®å¤šç§æ¨¡å‹ä¸ç®—æ³•, å¼€ç®±å³ç”¨.</p>
<h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">example/</span><br><span class="line">    data/</span><br><span class="line">        è´¢ç»/</span><br><span class="line">            1.txt</span><br><span class="line">            2.txt</span><br><span class="line">            ...</span><br><span class="line">            200.txt</span><br><span class="line">        æˆ¿äº§/</span><br><span class="line">            1.txt</span><br><span class="line">            ...</span><br><span class="line">            200.txt</span><br><span class="line">        XXX/</span><br><span class="line">            XXX.txt</span><br><span class="line">        ...</span><br><span class="line">    main.py</span><br><span class="line">    main.ipynb</span><br></pre></td></tr></table></figure>

<p><img data-src="/static/image/wast-ml/vBh4sA.png" alt="vBh4sA.png"></p>
<h2 id="å¿«é€Ÿä¸Šæ‰‹"><a href="#å¿«é€Ÿä¸Šæ‰‹" class="headerlink" title="å¿«é€Ÿä¸Šæ‰‹"></a>å¿«é€Ÿä¸Šæ‰‹</h2><h3 id="å¯¼å…¥æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„åº“"><a href="#å¯¼å…¥æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„åº“" class="headerlink" title="å¯¼å…¥æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„åº“"></a>å¯¼å…¥æ‰€æœ‰éœ€è¦ç”¨åˆ°çš„åº“</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_files</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> CountVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> MultinomialNB</span><br></pre></td></tr></table></figure>

<h3 id="è¯»å–æ•°æ®é›†"><a href="#è¯»å–æ•°æ®é›†" class="headerlink" title="è¯»å–æ•°æ®é›†"></a>è¯»å–æ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">raw_data = load_files(<span class="string">&quot;./data/&quot;</span>, encoding=<span class="string">&quot;utf8&quot;</span>, shuffle=<span class="literal">True</span>, decode_error=<span class="string">&quot;ignore&quot;</span>, random_state=<span class="number">1</span>)</span><br><span class="line">data_x = raw_data[<span class="string">&quot;data&quot;</span>]</span><br><span class="line">data_y = raw_data[<span class="string">&quot;target&quot;</span>]</span><br><span class="line">index2label = raw_data[<span class="string">&quot;target_names&quot;</span>]</span><br><span class="line">label2index = &#123;l: i <span class="keyword">for</span> i, l <span class="keyword">in</span> <span class="built_in">enumerate</span>(index2label)&#125;</span><br><span class="line"><span class="comment"># print(len(data_x), data_x[1])</span></span><br><span class="line"><span class="comment"># print(len(data_y), data_y[1])</span></span><br><span class="line"><span class="comment"># print(index2label)</span></span><br><span class="line"><span class="comment"># print(label2index)</span></span><br><span class="line"><span class="comment">## ========== Output ==========</span></span><br><span class="line"><span class="comment">## 1400 å¥¹ä»¬æ·±é™·ç¾å¦†åœˆåˆ†äº«å¥½è´§åœä¸ä¸‹æ¥...æ›´å¤šçš„æ˜¯æ—¶é—´ä¸å¿ƒæ€ã€‚</span></span><br><span class="line"><span class="comment">## 1400 3</span></span><br><span class="line"><span class="comment">## [&#x27;å®¶å±…&#x27;, &#x27;æˆ¿äº§&#x27;, &#x27;æ•™è‚²&#x27;, &#x27;æ—¶å°š&#x27;, &#x27;æ—¶æ”¿&#x27;, &#x27;ç§‘æŠ€&#x27;, &#x27;è´¢ç»&#x27;]</span></span><br><span class="line"><span class="comment">## &#123;&#x27;å®¶å±…&#x27;: 0, &#x27;æˆ¿äº§&#x27;: 1, &#x27;æ•™è‚²&#x27;: 2, &#x27;æ—¶å°š&#x27;: 3, &#x27;æ—¶æ”¿&#x27;: 4, &#x27;ç§‘æŠ€&#x27;: 5, &#x27;è´¢ç»&#x27;: 6&#125;</span></span><br><span class="line"><span class="comment">## ============================</span></span><br></pre></td></tr></table></figure>

<p>æ•°æ®çš„è¯»å–ç›´æ¥ä½¿ç”¨ç°æˆçš„åº“å‡½æ•° <code>load_files</code>, éœ€è¦æ»¡è¶³ä¸€å®šçš„ç›®å½•ç»“æ„æ‰èƒ½ç›´æ¥ä½¿ç”¨, å³æ•°æ®é›†æ–‡ä»¶å¤¹ä¸‹é¢æ˜¯ç±»åˆ«æ–‡ä»¶å¤¹, ç±»åˆ«æ–‡ä»¶å¤¹ä¸‹é¢æ˜¯æ¯ä¸€ä»½æ•°æ®æ–‡ä»¶.</p>
<p>è¯»å–ä¹‹åè¿”å›çš„å¯¹è±¡åŒ…å«æ‰€æœ‰çš„åŸå§‹æ•°æ®ä¸è‡ªåŠ¨ç”Ÿæˆçš„æ ‡ç­¾, ä» <code>index2label</code> å’Œ <code>label2index</code> å¯ä»¥çœ‹åˆ°æ•°å­—æ ‡ç­¾ä¸ç±»åˆ«æ–‡å­—çš„å¯¹åº”å…³ç³».</p>
<p>å¦‚æœæ˜¯å…¶ä»–å½¢å¼çš„æ•°æ®é›†, éœ€è¦è‡ªå·±å†™åŠ è½½å‡½æ•°. åŠ è½½åçš„è·å–çš„å†…å®¹ä¸ä¸Šé¢çš„åº”å½“ç±»ä¼¼, æœ‰æ•°å­—æ ‡ç­¾åŠå…¶ä¸æ–‡å­—ç±»åˆ«çš„å¯¹åº”å…³ç³», ä»¥åŠæ ·æœ¬ä¸æ ‡ç­¾ç›¸äº’å¯¹åº”çš„ä¸¤ä¸ªæœ‰åºåˆ—è¡¨.</p>
<h3 id="åˆ’åˆ†è®­ç»ƒé›†ä¸æµ‹è¯•é›†"><a href="#åˆ’åˆ†è®­ç»ƒé›†ä¸æµ‹è¯•é›†" class="headerlink" title="åˆ’åˆ†è®­ç»ƒé›†ä¸æµ‹è¯•é›†"></a>åˆ’åˆ†è®­ç»ƒé›†ä¸æµ‹è¯•é›†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train_x, test_x, train_y, test_y = train_test_split(</span><br><span class="line">    data_x, data_y, train_size=<span class="number">0.7</span>,</span><br><span class="line">    shuffle=<span class="literal">True</span>, stratify=data_y, random_state=<span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># print(f&quot;train_x: &#123;len(train_x)&#125;&quot;)</span></span><br><span class="line"><span class="comment"># print(f&quot;test_x: &#123;len(test_x)&#125;&quot;)</span></span><br><span class="line"><span class="comment">## ========== Output ==========</span></span><br><span class="line"><span class="comment">## train_x: 979</span></span><br><span class="line"><span class="comment">## test_x: 421</span></span><br><span class="line"><span class="comment">## ============================</span></span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è°ƒåŒ…æ¥åˆ’åˆ†æ•°æ®é›†, å¹¶ä¸”å¡«å…¥å‚æ•°, æŒ‰ 7:3 åˆ’åˆ†è®­ç»ƒé›†ä¸æµ‹è¯•é›†.</p>
<p>å…¶ä¸­ <code>stratify</code> å‚æ•°å«ä¹‰ä¸ºæŒ‰æ¯”ä¾‹åˆ’åˆ†, å³è®­ç»ƒé›†ä¸æµ‹è¯•é›†çš„å„ç±»åˆ«ä¹‹é—´çš„æ¯”ä¾‹ä¸æä¾›çš„ <code>data_y</code> æ¯”ä¾‹ä¸€è‡´, å³åˆ’åˆ†å‰çš„æ€»æ¯”ä¾‹.</p>
<h3 id="å¯¹æ•°æ®é›†è¿›è¡Œç‰¹å¾æå–"><a href="#å¯¹æ•°æ®é›†è¿›è¡Œç‰¹å¾æå–" class="headerlink" title="å¯¹æ•°æ®é›†è¿›è¡Œç‰¹å¾æå–"></a>å¯¹æ•°æ®é›†è¿›è¡Œç‰¹å¾æå–</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cv = CountVectorizer(tokenizer=jieba.lcut)</span><br><span class="line">train_x = cv.fit_transform(train_x)</span><br><span class="line">test_x = cv.transform(test_x)</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬æœ€ç»ˆæ˜¯ä½¿ç”¨æœ´ç´ è´å¶æ–¯æ¨¡å‹è¿›è¡Œæ–‡æœ¬åˆ†ç±», å› æ­¤éœ€è¦å¾—åˆ°ä¸€äº›ç¦»æ•£ç‰¹å¾.</p>
<p>è¿™éƒ¨åˆ†ä½¿ç”¨äº† <code>CountVectorizer</code> æ¥è¿›è¡Œç‰¹å¾æå–, å®ƒå¯ä»¥ä½¿ç”¨ <code>tokenizer</code> å¯¹æ•°æ®é›†è¿›è¡Œåˆ†è¯å¹¶ç»Ÿè®¡, åœ¨å†…éƒ¨æ„å»ºä¸€ä¸ªè¯å…¸, å°†æ¯ä¸ªå•è¯æ˜ å°„åˆ°ä¸€ä¸ªåºå·, è¿›è€ŒæŠŠæ¯ä¸ªæ ·æœ¬å˜æˆä¸€ä¸ªå‘é‡.</p>
<p><code>CountVectorizer.fit</code>: æ¥å—æ•°æ®é›†è¿›è¡Œæ‹Ÿåˆ, æ›´æ–°å†…éƒ¨çš„è¯å…¸.<br><code>CountVectorizer.transform</code>: æ¥å—æ•°æ®é›†, æŒ‰ç…§å†…éƒ¨çš„è¯å…¸å°†æ¯ä¸ªæ ·æœ¬è½¬æ¢æˆå‘é‡å½¢å¼.</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>fit_transform</code> æ¥å¤„ç†è®­ç»ƒé›†, è¿™æ˜¯ä¸¤æ­¥åˆå¹¶æ“ä½œ, æ„æ€æ˜¯ä½¿ç”¨è®­ç»ƒé›†æ¥æ„å»ºè¯å…¸å¹¶å°†è®­ç»ƒé›†å‘é‡åŒ–.</p>
<p>ä½†æ˜¯åªä½¿ç”¨ <code>transform</code> æ¥å¤„ç†æµ‹è¯•é›†, ä¹Ÿå°±æ˜¯ä½¿ç”¨è®­ç»ƒé›†ä¸Šçš„è¯å…¸æ¥å‘é‡åŒ–æµ‹è¯•é›†. è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£, å› ä¸ºå¯¹äºæ¨¡å‹æ¥è¯´, é€šè¿‡è®­ç»ƒé›†è®­ç»ƒ, ç†è®ºä¸Šæ¥è¯´æ˜¯ä¸çŸ¥é“æµ‹è¯•é›†çš„å†…å®¹çš„, å› æ­¤ä¸éœ€è¦è®©è¯å…¸æ›´æ–°æµ‹è¯•é›†çš„è¯æ±‡.</p>
<h3 id="æ„å»ºæ¨¡å‹å¹¶æ‹Ÿåˆ"><a href="#æ„å»ºæ¨¡å‹å¹¶æ‹Ÿåˆ" class="headerlink" title="æ„å»ºæ¨¡å‹å¹¶æ‹Ÿåˆ"></a>æ„å»ºæ¨¡å‹å¹¶æ‹Ÿåˆ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model = MultinomialNB()</span><br><span class="line">model.fit(train_x, train_y)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é€‰æ‹© <code>MultinomialNB</code> æ¨¡å‹, å› ä¸ºå®ƒæ˜¯ <code>sklearn</code> ä¸­é€‚åˆå¤„ç†ç¦»æ•£ç‰¹å¾çš„è´å¶æ–¯æ¨¡å‹, æœ‰å¾ˆå¤šå¯è°ƒèŠ‚çš„å‚æ•°, è¿™é‡Œä»ç®€, ç›´æ¥å…¨éƒ¨é»˜è®¤å‚æ•°.</p>
<p>æŠŠè®­ç»ƒé›†å–‚è¿›æ¨¡å‹çš„ <code>fit</code> å‡½æ•°, ç„¶åç­‰å¾…ä¸€ä¼šè®­ç»ƒè¿‡ç¨‹.</p>
<h3 id="åœ¨æµ‹è¯•é›†ä¸Šæµ‹è¯•å‡†ç¡®æ€§"><a href="#åœ¨æµ‹è¯•é›†ä¸Šæµ‹è¯•å‡†ç¡®æ€§" class="headerlink" title="åœ¨æµ‹è¯•é›†ä¸Šæµ‹è¯•å‡†ç¡®æ€§"></a>åœ¨æµ‹è¯•é›†ä¸Šæµ‹è¯•å‡†ç¡®æ€§</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pred_y = model.predict(test_x)</span><br><span class="line"><span class="built_in">print</span>(classification_report(test_y, pred_y, target_names=index2label))</span><br></pre></td></tr></table></figure>

<p>å°†æµ‹è¯•é›†çš„æ ·æœ¬å–‚è¿›è®­ç»ƒä¹‹åçš„æ¨¡å‹ <code>predict</code> å‡½æ•°ä¸­å¾—åˆ° <code>pred_y</code>. æˆ‘ä»¬ç›´æ¥è°ƒåŒ…æ¥è®¡ç®—å„é¡¹æŒ‡æ ‡ (å½“ç„¶åŒ…é‡Œè¿˜æœ‰å…¶ä»–åˆ†åˆ«è®¡ç®—å„é¡¹æŒ‡æ ‡çš„å‡½æ•°), å¾—åˆ°å¦‚ä¸‹è¾“å‡º.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">          å®¶å±…       0.88      0.97      0.92        60</span><br><span class="line">          æˆ¿äº§       1.00      0.80      0.89        60</span><br><span class="line">          æ•™è‚²       0.82      1.00      0.90        60</span><br><span class="line">          æ—¶å°š       1.00      0.98      0.99        60</span><br><span class="line">          æ—¶æ”¿       0.91      0.85      0.88        60</span><br><span class="line">          ç§‘æŠ€       1.00      0.97      0.98        61</span><br><span class="line">          è´¢ç»       0.98      0.98      0.98        60</span><br><span class="line"></span><br><span class="line">    accuracy                           0.94       421</span><br><span class="line">   macro avg       0.94      0.94      0.94       421</span><br><span class="line">weighted avg       0.94      0.94      0.94       421</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ•ˆæœä¸é”™, ç¨ä½ä¸€ç‚¹çš„æ˜¯ &quot;æˆ¿äº§&quot; ä¸ &quot;æ—¶æ”¿&quot;, å¬å›ç‡è¾ƒä½, çŒœæµ‹å¯èƒ½è¢«è¯¯åˆ†ç±»åˆ° &quot;å®¶å±…&quot; å’Œ &quot;æ•™è‚²&quot; é‡Œé¢å»äº†.</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å…¶å®åšä¸€ä¸ªè°ƒåŒ…ä¾ è¿˜æ˜¯æŒºç®€å•çš„, ä¸åˆ° 50 è¡Œä»£ç å°±å®ç°äº†ä¸€ä¸ªçœ‹èµ·æ¥ä¼¼ä¹æŒºéº»çƒ¦çš„äº‹, ä½†æ˜¯èƒ½å¤Ÿæ­£ç¡®è°ƒåŒ…çš„å‰ææ˜¯çŸ¥é“å„ä¸ªæ¨¡å‹çš„åŸºæœ¬åŸç†, èƒ½å¤Ÿæ„å»ºåˆé€‚çš„ç‰¹å¾å¹¶é€‰æ‹©åˆé€‚çš„æ¨¡å‹, åŒæ—¶ä¹Ÿéœ€è¦å¯¹å¸¸ç”¨çš„æœºå™¨å­¦ä¹ åº“çš„ api æœ‰ä¸€å®šäº†è§£å’Œä½¿ç”¨ç»éªŒ, ä¸ç„¶è¿è°ƒåŒ…ä¾ ä¹Ÿå½“ä¸äº† Xï¹X.</p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p><code>scikit-learn</code> å®˜æ–¹æ–‡æ¡£: <span class="exturl" data-url="aHR0cHM6Ly9zY2lraXQtbGVhcm4ub3JnL3N0YWJsZS9pbmRleC5odG1s">https://scikit-learn.org/stable/index.html<i class="fa fa-external-link-alt"></i></span> (å…¶å®è¿™æ–‡æ¡£å¾ˆå°‘çœ‹, ä¸å¦‚æœç´¢å¼•æ“ç°æœ).</p>
<p>å¦å¤–è´´ä¸€ä¸‹æ–‡ç« é‡Œé¢ç”¨çš„æ•°æ®é›†ç½‘ç›˜åœ°å€, <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pVHZLejA5cGNxOGI=">ç‚¹å‡»ä¸‹è½½<i class="fa fa-external-link-alt"></i></span>.</p>
<p>æ²¡å•¥å…¶ä»–ç›¸å…³èµ„æºäº†, è¯¾ä¸Šå¥½å¥½å­¦<del>è¯¾ä¸‹æ…¢æ…¢æœ</del>å°±å®Œäº‹äº†.</p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>å¿…å¤‡æŠ€èƒ½</category>
      </categories>
      <tags>
        <tag>æœºå™¨å­¦ä¹ </tag>
        <tag>scikit-learn</tag>
        <tag>æ–‡æœ¬åˆ†ç±»</tag>
      </tags>
  </entry>
  <entry>
    <title>å†é‡æ–‡æœ¬åˆ†ç±»</title>
    <url>//posts/2022/08/19/wast-nlp/</url>
    <content><![CDATA[<p>è¿™æ˜¯<a href="/categories/%E7%BD%91%E5%AE%89%E6%9C%AC%E7%A7%91%E9%80%9F%E9%80%9A/">ç½‘å®‰æœ¬ç§‘é€Ÿé€š</a>ç³»åˆ—çš„æœ€åä¸€ç¯‡äº†, ä¸»é¢˜è¿˜æ˜¯ <code>pytorch</code>, ä½†æ˜¯é—®é¢˜æ¢æˆäº† <code>NLP</code>, å¹¶ä¸”è¿˜æ˜¯ä»¥ç»å…¸çš„æ–‡æœ¬åˆ†ç±»ä½œä¸ºç¤ºä¾‹, æ•°æ®é›†ä½¿ç”¨ä¸å‰é¢<a href="/posts/2022/08/17/wast-ml/">ç»å…¸é—®é¢˜ä¹‹æ–‡æœ¬åˆ†ç±»</a>ç›¸åŒçš„ä¸€ä»½å°æ•°æ®é›†, æ–¹ä¾¿è¿›è¡Œæ¯”è¾ƒ.</p>
<p>é˜…è¯»æœ¬ç¯‡å‰éœ€è¦å…ˆçœ‹å‰ä¸¤ç¯‡, <a href="/posts/2022/08/17/wast-ml/">ç»å…¸é—®é¢˜ä¹‹æ–‡æœ¬åˆ†ç±»</a>ä¸<a href="/posts/2022/08/18/wast-dl/">åŸºäº PyTorch çš„æ‰‹å†™æ•°å­—åˆ†ç±»</a>. æœ¬ç¯‡çš„é¡¹ç›®ä»£ç å’Œæ•°æ®é›†æ˜¯ä»¥å‰ä¸¤ç¯‡ä½œä¸ºåŸºç¡€çš„, å¹¶ä¸”ä¹Ÿä¼šç²¾ç®€æ­£æ–‡å†…å®¹.</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„"><a href="#ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„" class="headerlink" title="ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„"></a>ç¯å¢ƒå‡†å¤‡ä¸é¡¹ç›®ç»“æ„</h2><p>ç¯å¢ƒä½¿ç”¨ <code>pytorch</code> ç¯å¢ƒ.</p>
<p>é¡¹ç›®ç»“æ„ä¸æ–‡æœ¬åˆ†ç±»é¡¹ç›®ç»“æ„ä¸€è‡´, å¹¶ä¸”ä½¿ç”¨ç›¸åŒçš„æ•°æ®é›†.</p>
<h2 id="å¿«é€Ÿä¸Šæ‰‹"><a href="#å¿«é€Ÿä¸Šæ‰‹" class="headerlink" title="å¿«é€Ÿä¸Šæ‰‹"></a>å¿«é€Ÿä¸Šæ‰‹</h2><h3 id="å¯¼å…¥åº“"><a href="#å¯¼å…¥åº“" class="headerlink" title="å¯¼å…¥åº“"></a>å¯¼å…¥åº“</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn.datasets <span class="keyword">import</span> load_files</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score, classification_report, f1_score, precision_score, recall_score</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn, optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, Dataset</span><br><span class="line"><span class="keyword">from</span> torch.nn.utils.rnn <span class="keyword">import</span> pad_sequence</span><br><span class="line"></span><br><span class="line">DEVICE = <span class="string">&quot;cuda&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span></span><br></pre></td></tr></table></figure>

<p>å‰ä¸¤ä¸ªé¡¹ç›®çš„ç»“åˆ, éƒ½æ˜¯äº›å¸¸è§„åº“.</p>
<h3 id="æ„å»ºæ•°æ®é›†"><a href="#æ„å»ºæ•°æ®é›†" class="headerlink" title="æ„å»ºæ•°æ®é›†"></a>æ„å»ºæ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Vocabulary</span>:</span><br><span class="line">    PAD = <span class="string">&quot;&lt;PAD&gt;&quot;</span></span><br><span class="line">    UNK = <span class="string">&quot;&lt;UNK&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.token2id = &#123;self.PAD: <span class="number">0</span>, self.UNK: <span class="number">1</span>&#125;</span><br><span class="line">        self.id2token = [self.PAD, self.UNK]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.token2id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_token</span>(<span class="params">self, token</span>):</span><br><span class="line">        <span class="keyword">if</span> token <span class="keyword">not</span> <span class="keyword">in</span> self.token2id:</span><br><span class="line">            self.token2id[token] = <span class="built_in">len</span>(self.token2id)</span><br><span class="line">            self.id2token.append(token)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self, text</span>):</span><br><span class="line">        <span class="keyword">return</span> [self.token2id.get(x, self.token2id[self.UNK]) <span class="keyword">for</span> x <span class="keyword">in</span> text]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">self, ids</span>):</span><br><span class="line">        <span class="keyword">return</span> [self.id2token[x] <span class="keyword">for</span> x <span class="keyword">in</span> ids]</span><br></pre></td></tr></table></figure>

<p>å…ˆå†™ä¸€ä¸ªè¯è¡¨ç±», è¿™ä¸ªè¯è¡¨å¯ä»¥æŒ‰éœ€æ±‚æ·»åŠ ç”Ÿè¯, å¹¶ä¸”å°†åˆ†è¯åçš„æ–‡æœ¬è¿›è¡Œè¯ä¸åºå·ä¹‹é—´çš„ç¼–è§£ç æ“ä½œ, æ ¸å¿ƒç›®çš„æ˜¯æä¾›æ–‡æœ¬å‘é‡åŒ–çš„èƒ½åŠ›.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_raw_data</span>(<span class="params">path</span>):</span><br><span class="line">    raw_data = load_files(path, encoding=<span class="string">&quot;utf8&quot;</span>, shuffle=<span class="literal">True</span>, decode_error=<span class="string">&quot;ignore&quot;</span>, random_state=<span class="number">1</span>)</span><br><span class="line">    data_x = raw_data[<span class="string">&quot;data&quot;</span>]</span><br><span class="line">    data_y = raw_data[<span class="string">&quot;target&quot;</span>]</span><br><span class="line">    index2label = raw_data[<span class="string">&quot;target_names&quot;</span>]</span><br><span class="line">    label2index = &#123;l: i <span class="keyword">for</span> i, l <span class="keyword">in</span> <span class="built_in">enumerate</span>(index2label)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (data_x, data_y), (index2label, label2index)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess</span>(<span class="params">data_x, data_y</span>):</span><br><span class="line">    data_x = [jieba.lcut(s) <span class="keyword">for</span> s <span class="keyword">in</span> data_x]</span><br><span class="line">    train_x, test_x, train_y, test_y = train_test_split(</span><br><span class="line">        data_x, data_y, train_size=<span class="number">0.7</span>,</span><br><span class="line">        shuffle=<span class="literal">True</span>, stratify=data_y, random_state=<span class="number">1</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    vocab = Vocabulary()</span><br><span class="line">    <span class="keyword">for</span> text <span class="keyword">in</span> train_x:</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> text:</span><br><span class="line">            vocab.add_token(word)</span><br><span class="line"></span><br><span class="line">    train_x = [vocab.encode(x) <span class="keyword">for</span> x <span class="keyword">in</span> train_x]</span><br><span class="line">    test_x = [vocab.encode(x) <span class="keyword">for</span> x <span class="keyword">in</span> test_x]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (train_x, test_x, train_y, test_y), vocab</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°è£…ä¸€ä¸‹ä¹‹å‰æ–‡æœ¬åˆ†ç±»é¡¹ç›®é‡Œçš„æ•°æ®é›†åŠ è½½æ“ä½œ, æ‰‹åŠ¨ä½¿ç”¨ <code>jieba.lcut</code> è¿›è¡Œåˆ†è¯å¹¶æ„å»ºè¯è¡¨, æœ€åè¿”å›åˆ’åˆ†å¥½çš„è®­ç»ƒé›†ä¸æµ‹è¯•é›†.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        self.inputs = x</span><br><span class="line">        self.targets = y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.inputs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">        input_ = torch.tensor(self.inputs[item]).long().to(DEVICE)</span><br><span class="line">        target = torch.tensor([self.targets[item]]).long().to(DEVICE)</span><br><span class="line">        <span class="keyword">return</span> (input_, target)</span><br></pre></td></tr></table></figure>

<p>è‡ªå®šä¹‰æ•°æ®é›†ç±», ä¸æ•°å­—åˆ†ç±»é¡¹ç›®é‡Œçš„å®šä¹‰æ–¹å¼ç±»ä¼¼, ä½†æ˜¯è¾“å…¥å‚æ•°æ¢æˆç›´æ¥è·å–å‰é¢é¢„å¤„ç†å¥½çš„æ•°æ®é›†.</p>
<h3 id="å®šä¹‰ç¥ç»ç½‘ç»œç»“æ„"><a href="#å®šä¹‰ç¥ç»ç½‘ç»œç»“æ„" class="headerlink" title="å®šä¹‰ç¥ç»ç½‘ç»œç»“æ„"></a>å®šä¹‰ç¥ç»ç½‘ç»œç»“æ„</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyNetwork</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, vocab_size, output_size=<span class="number">7</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        _embedding_size = <span class="number">128</span></span><br><span class="line">        _hidden_size = <span class="number">128</span></span><br><span class="line">        _filter_sizes = (<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">        self.embedding = nn.Embedding(vocab_size, _embedding_size)</span><br><span class="line">        self.dropout = nn.Dropout()</span><br><span class="line">        self.convs = nn.ModuleList([nn.Conv1d(_embedding_size, _hidden_size, k) <span class="keyword">for</span> k <span class="keyword">in</span> _filter_sizes])</span><br><span class="line">        self.fc = nn.Linear(_hidden_size * <span class="built_in">len</span>(_filter_sizes), output_size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_convpool</span>(<span class="params">self, x</span>):</span><br><span class="line">        outputs = []</span><br><span class="line">        <span class="keyword">for</span> conv <span class="keyword">in</span> self.convs:</span><br><span class="line">            output = torch.relu(conv(x))                                <span class="comment"># (128, L) -&gt; (128, L-k+1)</span></span><br><span class="line">            output = torch.max_pool1d(output, output.size(<span class="number">2</span>)).squeeze() <span class="comment"># (128, L-k+1) -&gt; (128,)</span></span><br><span class="line">            outputs.append(output)</span><br><span class="line">        <span class="keyword">return</span> torch.cat(outputs, -<span class="number">1</span>)                                   <span class="comment"># (128,) -&gt; (384,)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        outputs = self.embedding(inputs)                                <span class="comment"># (L,) -&gt; (L, 128)</span></span><br><span class="line">        outputs = self.dropout(outputs)                                 <span class="comment"># </span></span><br><span class="line">        outputs = outputs.transpose(<span class="number">1</span>, <span class="number">2</span>)                               <span class="comment"># (L, 128) -&gt; (128, L)</span></span><br><span class="line">        outputs = self._convpool(outputs)                               <span class="comment"># (128, L) -&gt; (384,)</span></span><br><span class="line">        outputs = self.fc(outputs)                                      <span class="comment"># (384,) -&gt; (7,)</span></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­ä½¿ç”¨ä¸æ•°å­—åˆ†ç±»ä¸­ç›¸åŒçš„å·ç§¯ç»“æ„, ä¹Ÿå°±æ˜¯ <code>TextCNN</code>, å·ç§¯æ ¸é€‰æ‹©ç»å…¸çš„ä¸‰ä¸ªå€¼. å„ä¸ªæ­¥éª¤çš„ç»´åº¦å˜åŒ–åœ¨æ³¨é‡Šé‡Œæœ‰æ ‡æ³¨.</p>
<h3 id="å®šä¹‰æŒ‡æ ‡è¯„ä»·å‡½æ•°"><a href="#å®šä¹‰æŒ‡æ ‡è¯„ä»·å‡½æ•°" class="headerlink" title="å®šä¹‰æŒ‡æ ‡è¯„ä»·å‡½æ•°"></a>å®šä¹‰æŒ‡æ ‡è¯„ä»·å‡½æ•°</h3><p>è§<a href="/posts/2022/08/18/wast-dl/#%E5%AE%9A%E4%B9%89%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87%E5%87%BD%E6%95%B0">å®šä¹‰è¯„ä»·æŒ‡æ ‡å‡½æ•°</a>.</p>
<h3 id="è®­ç»ƒä¸è¯„ä¼°å‡½æ•°"><a href="#è®­ç»ƒä¸è¯„ä¼°å‡½æ•°" class="headerlink" title="è®­ç»ƒä¸è¯„ä¼°å‡½æ•°"></a>è®­ç»ƒä¸è¯„ä¼°å‡½æ•°</h3><p>è§<a href="/posts/2022/08/18/wast-dl/#%E5%AE%9A%E4%B9%89%E8%AE%AD%E7%BB%83%E5%87%BD%E6%95%B0">å®šä¹‰è®­ç»ƒå‡½æ•°</a>ä¸<a href="/posts/2022/08/18/wast-dl/#%E5%AE%9A%E4%B9%89%E8%AF%84%E4%BC%B0%E5%87%BD%E6%95%B0">å®šä¹‰è¯„ä¼°å‡½æ•°</a></p>
<h3 id="æ ¡å¯¹å‡½æ•°-collate-fn"><a href="#æ ¡å¯¹å‡½æ•°-collate-fn" class="headerlink" title="æ ¡å¯¹å‡½æ•° (collate_fn)"></a>æ ¡å¯¹å‡½æ•° (collate_fn)</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">collate_fn</span>(<span class="params">data: <span class="built_in">list</span></span>):</span><br><span class="line">    inputs, targets = <span class="built_in">map</span>(<span class="built_in">list</span>, <span class="built_in">zip</span>(*data))</span><br><span class="line">    inputs = pad_sequence(inputs, batch_first=<span class="literal">True</span>)</span><br><span class="line">    targets = torch.stack(targets)</span><br><span class="line">    <span class="keyword">return</span> inputs, targets</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¸œè¥¿å¯èƒ½ç¬¬ä¸€æ¬¡è§, å¹¶ä¸”ç”¨äº†ä¸€äº›å¾ˆå¥‡æ€ªçš„æ“ä½œ, æ¯”å¦‚é‚£ä¸ª <code>map</code>, ä½†æ˜¯é¦–å…ˆè¦æ˜ç™½è¿™ä¸ªå‡½æ•°ç”¨äºå¹²ä»€ä¹ˆ.</p>
<p>å›å¿†æˆ‘ä»¬åœ¨æ•°å­—åˆ†ç±»é¡¹ç›®é‡Œä½¿ç”¨ <code>DataLoader</code> æ—¶, å®ƒå¯ä»¥ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ª loader æ¥è¿­ä»£æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>Dataset</code>. <code>Dataset</code> æ¯æ¬¡å–å‡ºæ¥çš„ä¸œè¥¿æ˜¯ä¸€ä¸ªäºŒå…ƒç»„, é‡Œé¢åŒ…å«æ ·æœ¬ä¸æ ‡ç­¾ä¸¤éƒ¨åˆ†, è€Œ <code>Dataloader</code> åˆèƒ½å¤ŸæŒ‰ <code>batch_size</code> çš„å¤§å°æ‰¹é‡è·å–è¿™äº›äºŒå…ƒç»„, å½¢æˆä¸€ä¸ª <code>list</code>. è¿™ä¸ªé•¿åº¦ä¸º <code>batch_size</code>, å†…å®¹ä¸ºäºŒå…ƒç»„çš„ <code>list</code> å°±æ˜¯ <code>collate_fn</code> çš„è¾“å…¥å‚æ•°.</p>
<p>å†çœ‹ <code>map</code> é‚£ä¸€è¡Œæ“ä½œ, æ¶‰åŠäº†å‡ ä¸ª <code>python</code> å‡½æ•°ç”¨æ³•, è¿™é‡Œç›´æ¥è¯´ç»“è®º, å®ƒå°† <code>data</code> é‡Œçš„æ ·æœ¬ä¸æ ‡ç­¾æ‹†åˆ†æˆäº†ä¸¤ä¸ªå•ç‹¬çš„ <code>list</code>.</p>
<p>ç„¶åå†è¯´ <code>pad_sequence</code> æ“ä½œ, å¯¹äºç¥ç»ç½‘ç»œæ¥è¯´, æ‰€æœ‰çš„è®¡ç®—è¿‡ç¨‹éƒ½æ˜¯çŸ©é˜µè®¡ç®—, ä½†æ˜¯å¯¹äºæ–‡æœ¬ä»»åŠ¡, æ¯ä¸ªæ ·æœ¬å¥å­é•¿åº¦å‡ ä¹éƒ½ä¸æ˜¯ç›¸åŒçš„, å› æ­¤éœ€è¦è¿›è¡Œå¯¹é½æ“ä½œ, å¯¹çŸ­å¥è¿›è¡Œå¡«å……. éœ€è¦æ³¨æ„çš„æ˜¯, é»˜è®¤å‚æ•°é‡Œçš„å¡«å……å€¼æ˜¯ <code>0</code>, è¿™ä¸æˆ‘ä»¬å‰é¢è¯è¡¨é‡Œçš„å®šä¹‰æ˜¯ä¸€è‡´çš„, å¦‚æœä¸ä¸€è‡´åˆ™éœ€è¦æ‰‹åŠ¨å¡«ä¸€ä¸‹.</p>
<p>æœ€åæ˜¯å‚æ•°çš„è¿”å›å€¼, ç›´æ¥å¯¹åº”äº†æˆ‘ä»¬ä» loader é‡Œè¿­ä»£æ•°æ®æ—¶è·å–çš„å˜é‡å½¢å¼, æ­¤å¤„å°±æ˜¯å’Œä¹‹å‰ä¸€æ ·, åˆ†åˆ«è¿”å›æ ·æœ¬åˆ—è¡¨ä¸æ ‡ç­¾åˆ—è¡¨.</p>
<h3 id="å®šä¹‰è®­ç»ƒè¶…å‚æ•°"><a href="#å®šä¹‰è®­ç»ƒè¶…å‚æ•°" class="headerlink" title="å®šä¹‰è®­ç»ƒè¶…å‚æ•°"></a>å®šä¹‰è®­ç»ƒè¶…å‚æ•°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">seed = <span class="number">1</span></span><br><span class="line">learning_rate = <span class="number">1e-3</span></span><br><span class="line">batch_size = <span class="number">16</span></span><br><span class="line">epochs = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">torch.manual_seed(seed)</span><br><span class="line">torch.cuda.manual_seed(seed)</span><br></pre></td></tr></table></figure>

<p>ä¸å‰é¢çš„é¡¹ç›®ç±»ä¼¼, ä½†æ˜¯ <code>batch_size</code> è®¾çš„ç¨å°ä¸€äº›, å› ä¸ºå¯¹äºæ–‡æœ¬å¤„ç†, æŒ‰æ‰¹æ¬¡è®­ç»ƒæ—¶, è¿›è¡Œäº†å¡«å……æ“ä½œ, è¶Šå¤§çš„ <code>batch_size</code> èƒ½å¤Ÿå¾—åˆ°è¶Šå¿«çš„è®­ç»ƒé€Ÿåº¦, ä½†æ˜¯åœ¨ä¸€ä¸ª <code>batch</code> å†…ä¼šå¼•å…¥æ›´å¤šä¸å¿…è¦çš„ <code>0</code> å¡«å……å€¼, å¯ä»¥é…Œæƒ…å°è¯•è°ƒæ•´.</p>
<h3 id="åŠ è½½æ•°æ®é›†"><a href="#åŠ è½½æ•°æ®é›†" class="headerlink" title="åŠ è½½æ•°æ®é›†"></a>åŠ è½½æ•°æ®é›†</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(data_x, data_y), (index2label, label2index) = load_raw_data(<span class="string">&quot;./data/&quot;</span>)</span><br><span class="line">(train_x, test_x, train_y, test_y), vocab = preprocess(data_x, data_y)</span><br><span class="line"></span><br><span class="line">train_dataset = MyDataset(train_x, train_y)</span><br><span class="line">test_dataset = MyDataset(test_x, test_y)</span><br><span class="line">train_dataloader = DataLoader(train_dataset, shuffle=<span class="literal">True</span>, batch_size=batch_size, collate_fn=collate_fn)</span><br><span class="line">test_dataloader = DataLoader(test_dataset, shuffle=<span class="literal">True</span>, batch_size=batch_size, collate_fn=collate_fn)</span><br></pre></td></tr></table></figure>

<p>æœ€å¤§çš„ä¸åŒå°±æ˜¯æ·»åŠ äº† <code>collate_fn</code> å‚æ•°, å…¶ä½™çš„éƒ½æ˜¯ä¹‹å‰æ¶‰åŠè¿‡çš„æ“ä½œ.</p>
<h3 id="å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡"><a href="#å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡" class="headerlink" title="å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡"></a>å®ä¾‹åŒ–æ¨¡å‹è®­ç»ƒéœ€è¦çš„å¯¹è±¡</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model = MyNetwork(<span class="built_in">len</span>(vocab)).to(DEVICE)</span><br><span class="line">loss_fn = nn.CrossEntropyLoss().to(DEVICE)</span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=learning_rate)</span><br></pre></td></tr></table></figure>

<p>ä¸ä¹‹å‰çš„å®šä¹‰ä¹Ÿæ˜¯å‡ ä¹ä¸€è‡´çš„, å”¯ä¸€çš„ä¸åŒå°±æ˜¯ <code>MyNetwork</code> å¤šäº†ä¸€ä¸ª <code>vocab_size</code> çš„å‚æ•°éœ€è¦ä¼ è¿›å», å…¶ä»–å‚æ•°éƒ½ç”¨çš„é»˜è®¤å€¼.</p>
<h3 id="è®­ç»ƒæ¨¡å‹"><a href="#è®­ç»ƒæ¨¡å‹" class="headerlink" title="è®­ç»ƒæ¨¡å‹"></a>è®­ç»ƒæ¨¡å‹</h3><p>ä»£ç è§<a href="/posts/2022/08/18/wast-dl/#%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B">è®­ç»ƒæ¨¡å‹</a>, è¿™é‡Œåªè´´ä¸€ä¸‹å 5 è½®çš„è®­ç»ƒç»“æœ.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">===============================</span><br><span class="line">Epoch 21</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.0071 Acc: 1.0000 F1: 1.0000(1.0000/1.0000)</span><br><span class="line">Eval  Loss: 0.1102 Acc: 0.9667 F1: 0.9669(0.9669/0.9667)</span><br><span class="line">===============================</span><br><span class="line">Epoch 22</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.0055 Acc: 1.0000 F1: 1.0000(1.0000/1.0000)</span><br><span class="line">Eval  Loss: 0.1099 Acc: 0.9644 F1: 0.9645(0.9645/0.9643)</span><br><span class="line">===============================</span><br><span class="line">Epoch 23</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.0056 Acc: 1.0000 F1: 1.0000(1.0000/1.0000)</span><br><span class="line">Eval  Loss: 0.1062 Acc: 0.9644 F1: 0.9645(0.9645/0.9643)</span><br><span class="line">===============================</span><br><span class="line">Epoch 24</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.0048 Acc: 1.0000 F1: 1.0000(1.0000/1.0000)</span><br><span class="line">Eval  Loss: 0.1019 Acc: 0.9667 F1: 0.9669(0.9669/0.9667)</span><br><span class="line">===============================</span><br><span class="line">Epoch 25</span><br><span class="line">-------------------------------</span><br><span class="line">Train Loss: 0.0042 Acc: 1.0000 F1: 1.0000(1.0000/1.0000)</span><br><span class="line">Eval  Loss: 0.1051 Acc: 0.9644 F1: 0.9645(0.9645/0.9643)</span><br><span class="line">===============================</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨è®­ç»ƒé›†ä¸Šå·²ç»å®Œå…¨æ‹Ÿåˆäº†, å¹¶ä¸”æµ‹è¯•é›†ä¸Š F1 å¾—åˆ†ä¹Ÿé«˜è¾¾ 0.9645.</p>
<h3 id="è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ"><a href="#è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ" class="headerlink" title="è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ"></a>è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ</h3><p>ä»£ç è§<a href="/posts/2022/08/18/wast-dl/#%E8%BE%93%E5%87%BA%E6%9C%80%E7%BB%88%E7%9A%84%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C">è¾“å‡ºæœ€ç»ˆçš„æµ‹è¯•ç»“æœ</a>, è¿™é‡Œåªè´´ä¸€ä¸‹è¾“å‡ºç»“æœ.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0     0.9524    1.0000    0.9756        60</span><br><span class="line">           1     0.9667    0.9667    0.9667        60</span><br><span class="line">           2     1.0000    1.0000    1.0000        60</span><br><span class="line">           3     0.9649    0.9167    0.9402        60</span><br><span class="line">           4     0.9833    0.9833    0.9833        60</span><br><span class="line">           5     0.9333    0.9180    0.9256        61</span><br><span class="line">           6     0.9508    0.9667    0.9587        60</span><br><span class="line"></span><br><span class="line">    accuracy                         0.9644       421</span><br><span class="line">   macro avg     0.9645    0.9645    0.9643       421</span><br><span class="line">weighted avg     0.9644    0.9644    0.9642       421</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å’Œä¹‹å‰ä½¿ç”¨æœ´ç´ è´å¶æ–¯çš„æ–‡æœ¬åˆ†ç±»åšä¸ªæ¯”è¾ƒ, å¯ä»¥çœ‹åˆ°è¿˜æ˜¯æœ‰æ˜æ˜¾æå‡çš„, <code>2</code> å·ç±»åˆ«ç”šè‡³å·²ç»å®Œå…¨æ­£ç¡®äº†. å½“ç„¶è¿™ä¸ªå¯¹æ¯”ä¸æ˜¯å¾ˆç§‘å­¦, æ¯•ç«Ÿè¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„æ•°æ®é›†, è€Œä¸”ä¸¤è€…éƒ½è¿˜æœ‰å¤§é‡çš„å¯è°ƒæ•´ç©ºé—´. æœ´ç´ è´å¶æ–¯é‡Œæœ‰å¾ˆå¤šè¶…å‚æ•°, è€Œä¸”æ ·æœ¬çš„ç‰¹å¾æå–ä¹Ÿæœ‰å¾…è¿›ä¸€æ­¥å‡çº§; <code>TextCNN</code> ç½‘ç»œé‡Œä¹Ÿæœ‰å¾ˆå¤šè¶…å‚æ•°å¯è°ƒ, æ¯”å¦‚è¯å‘é‡çš„é•¿åº¦ç­‰ç­‰.</p>
<p>ä¸è¿‡ç¥ç»ç½‘ç»œçš„å¼ºå¤„æ­£æ˜¯åœ¨äºèƒ½å¤Ÿè‡ªåŠ¨æå–æ·±å±‚æ¬¡ç‰¹å¾, é¿å…äº†äººå·¥æ„é€ ç‰¹å¾çš„éº»çƒ¦, ä¹Ÿå°±æ˜¯éå¸¸æ“…é•¿ &quot;æ‰¾è§„å¾‹&quot;, åªè¦æ•°æ®é›†å……è¶³, é€‰æ‹©åˆé€‚çš„ç½‘ç»œç»“æ„, ç„¶åç»è¿‡ä¸€ç•ªè¶…å‚æ•°è°ƒæ•´ä¹‹å, æ•ˆæœéƒ½ä¸ä¼šå¾ˆå·®. <del>å°±æ˜¯ç„å­¦ç‚¼ä¸¹.</del></p>
<h2 id="ç›¸å…³èµ„æº"><a href="#ç›¸å…³èµ„æº" class="headerlink" title="ç›¸å…³èµ„æº"></a>ç›¸å…³èµ„æº</h2><p>å„ä¸ªæ¨¡å—çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å»çœ‹ <code>pytorch</code> çš„<span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy8=">å®˜æ–¹ç½‘ç«™<i class="fa fa-external-link-alt"></i></span>, é¡¹ç›®ä¸­ä½¿ç”¨çš„æ•°æ®é›†åœ¨å‰é¢çš„æ–‡ç« é‡Œä¹Ÿæœ‰, è¿™é‡Œå†è´´ä¸€ä¸‹, <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pVHZLejA5cGNxOGI=">ç‚¹å‡»ä¸‹è½½<i class="fa fa-external-link-alt"></i></span>.</p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>å¿…å¤‡æŠ€èƒ½</category>
      </categories>
      <tags>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>pytorch</tag>
        <tag>nlp</tag>
        <tag>æ–‡æœ¬åˆ†ç±»</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰“é€ ä¸€ä¸ªèˆ’é€‚çš„ Python ç¼–ç¨‹ç¯å¢ƒ</title>
    <url>//posts/2022/08/13/wast-pythonandvsc/</url>
    <content><![CDATA[<p>ç½‘å®‰ä¸“ä¸šå‡ ä¹ 99% çš„ä½œä¸šéƒ½å¯ä»¥ç”¨ <code>python</code> æ¥è§£å†³, é™¤äº†å¤§ä¸€å¤§äºŒä¸€äº›ç‰¹åˆ«çš„ä¸“ä¸šè¯¾, éœ€è¦æŠ˜è…¾ä¸€ä¸‹ <code>c</code> è¯­è¨€, ä¹‹åå…¶ä½™çš„æ‰€æœ‰ç½‘å®‰ä¸“ä¸šå¿…ä¿®ä¸é€‰ä¿®çš„å¤§ä½œä¸š, éƒ½å¤šå¤šå°‘å°‘å’Œ &quot;å¤§æ•°æ®&quot;, &quot;äººå·¥æ™ºèƒ½&quot; æŒ‚é’©, é‡Œé¢æ¶‰åŠäº†å¾ˆå¤šæ•°æ®å¤„ç†ä¸åˆ†æ, è¿™ç±»ä»»åŠ¡ç”¨ <code>python</code> å†™å°†ä¼šéå¸¸æ–¹ä¾¿, å› ä¸ºå·²ç»æœ‰äº†è®¸å¤šçš„ç¬¬ä¸‰æ–¹åŒ…è®©æˆ‘ä»¬ç›´æ¥ä½¿ç”¨.</p>
<p>å› æ­¤æœ¬ç¯‡ä¸»è¦åŸºäºä¸ªäººç»éªŒä»‹ç»ä¸€ä¸‹æ¯”è¾ƒèˆ’é€‚çš„ <code>python</code> ç¼–ç¨‹ç¯å¢ƒè®¾ç½®, è®©å¤§å®¶èƒ½å¤ŸæŠŠç²¾åŠ›æ”¾åœ¨<del>æŠ„</del>å†™ä»£ç ä¸Š, è€Œä¸æ˜¯è¢«ç¯å¢ƒå¼„çš„å¤´ç–¼.</p>
<span id="more"></span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»æœ¬ç¯‡å¼€å§‹, åŸºæœ¬ä¸Šç®—æ˜¯å®Œå…¨çš„ä¸ªäººç»éªŒåˆ†äº«. ç”±äºæˆ‘è‡ªå·±æ˜¯ç½‘å®‰ä¸“ä¸šè€Œéä¿¡å®‰, å› æ­¤å¯èƒ½åˆ†äº«çš„å†…å®¹å¯¹ç½‘å®‰åŒå­¦é€‚ç”¨æ€§æ›´å¥½, ä¸è¿‡ä¿¡å®‰åŒå­¦å¯ä»¥é…Œæƒ…å‚è€ƒ. å¦‚æœè¿˜æ²¡åˆ†ä¸“ä¸š, ä¹Ÿå¯ä»¥å‚è€ƒä¸€ä¸‹å°†æ¥å¯èƒ½éœ€è¦ç‚¹ä¸€äº›å•¥æŠ€èƒ½æ¥é€Ÿé€šç½‘å®‰å„ä¸ªè¯¾ç¨‹ä½œä¸š.</p>
<p>å¦‚æœå¯¹ <code>VS Code</code> æ²¡æœ‰äº†è§£, å¯ä»¥çœ‹å‰ä¸€ç¯‡<a href="/posts/2022/08/11/wast-vscandvs/">ç»™æ–°ç”Ÿçš„ç¼–ç¨‹å·¥å…·æ¨èä¸åŸºæœ¬ä½¿ç”¨æ–¹æ³•</a>, è¿™é‡Œé¢è®²äº† <code>VS Code</code> çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•. è€Œæœ¬ç¯‡å°†ä¼šåŸºäº <code>VS Code</code>, æ‰“é€ ä¸€ä¸ªç›¸å¯¹èˆ’é€‚çš„ <code>python</code> ç¼–ç¨‹ç¯å¢ƒ.</p>
<h2 id="å®‰è£…-Python"><a href="#å®‰è£…-Python" class="headerlink" title="å®‰è£… Python"></a>å®‰è£… Python</h2><p>ç¬¬ä¸€æ­¥è‚¯å®šæ˜¯å®‰è£… <code>python</code>, å®˜ç½‘å°±æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly93d3cucHl0aG9uLm9yZy8=">https://www.python.org/<i class="fa fa-external-link-alt"></i></span>.</p>
<p>å¯ä»¥é€‰æ‹©ä¸‹æœ€æ–°ç‰ˆ, ä¸è¿‡ä¸æ˜¯é‚£ä¹ˆçš„æ¨è, è€Œæ˜¯é€‚å½“æ—§ä¸€ç‚¹, æ¯”å¦‚ç°åœ¨æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ <code>3.10.6</code>, é‚£ä¹ˆå¯ä»¥ä¸‹ <code>3.8.10</code> (<code>3.8.x</code> å‘å¸ƒçš„æœ€åä¸€ä¸ªæœ‰å®‰è£…åŒ…çš„ç‰ˆæœ¬). è¿™æ ·å­å…¼å®¹åº¦å¤§ä¸€ç‚¹. (æ›¾ç»é‡è§è¿‡è¦è£…çš„æŸä¸ªåŒ…è¿˜æ²¡å‘å¸ƒé€‚é…æ–°ç‰ˆæœ¬ <code>python</code> çš„ç‰ˆæœ¬, å®³å¾—æˆ‘åˆé‡è£…é™çº§äº† <code>python</code>).</p>
<p>è¿™é‡Œç›´æ¥æä¾› <a href="https://www.python.org/downloads/release/python-3810/"><code>Python 3.8.10</code></a> çš„å®˜æ–¹ä¸‹è½½é¡µé¢, ç‚¹è¿›å»ä¹‹åé€‰ &quot;Windows installer (64-bit)&quot; è¿™ä¸ªç‰ˆæœ¬å°±å¥½äº†.</p>
<p>ä¸‹è½½å¥½ä¹‹ååŒå‡»è¿›å…¥å®‰è£…ç•Œé¢. ä¸‹é¢ä¸¤é¡¹éƒ½å‹¾ä¸Š, å¹¶ä¸”é€‰æ‹© &quot;Customize installation&quot;.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vtamNQ.png" alt="vtamNQ.png"></p>
<p>è¿™ä¸€é¢ä¹Ÿæ˜¯ç›´æ¥å…¨å‹¾.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vtaN4J.png" alt="vtaN4J.png"></p>
<p>å†æ¬¡ Next ä¹‹å, è¿™ä¸ªç•Œé¢é‡Œ, å‹¾é€‰ &quot;Install for all users&quot;, å¹¶ä¸”å¯ä»¥åœ¨ä¸‹æ–¹è°ƒæ•´ <code>python</code> çš„å®‰è£…è·¯å¾„. æ¨èè£…åˆ° D ç›˜æˆ–è€…å…¶ä»–æ–¹ä¾¿æ‰¾åˆ°çš„åœ°æ–¹, æ¯”å¦‚ <code>D:\Program Files\Python38</code>.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vtd9VU.png" alt="vtd9VU.png"></p>
<p>é‡å¯ä¸€ä¸‹ç”µè„‘, å¿«æ·é”® <code>Win + R</code>, è¾“å…¥ <code>cmd</code> æ‰“å¼€å‘½ä»¤æç¤ºç¬¦, æ•²ä¸€ä¸‹ <code>python --version</code>, å¦‚ä¸‹å›¾æ‰€ç¤ºåˆ™å®‰è£…æˆåŠŸ.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vtdqeK.png" alt="vtdqeK.png"></p>
<h2 id="Python-è™šæ‹Ÿç¯å¢ƒ"><a href="#Python-è™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="Python è™šæ‹Ÿç¯å¢ƒ"></a>Python è™šæ‹Ÿç¯å¢ƒ</h2><h3 id="è™šæ‹Ÿç¯å¢ƒç®€ä»‹"><a href="#è™šæ‹Ÿç¯å¢ƒç®€ä»‹" class="headerlink" title="è™šæ‹Ÿç¯å¢ƒç®€ä»‹"></a>è™šæ‹Ÿç¯å¢ƒç®€ä»‹</h3><p>å…³äºè™šæ‹Ÿç¯å¢ƒçš„è¯¦ç»†ä»‹ç»å¾ˆå¤š, å¿…åº”ä¸€æœå°±æœ‰å¾ˆå¤š<span class="exturl" data-url="aHR0cHM6Ly9jbi5iaW5nLmNvbS9zZWFyY2g/cT1weXRob24lRTclOUElODQlRTglOTklOUElRTYlOEIlOUYlRTclOEUlQUYlRTUlQTIlODMlRTYlOTglQUYlRTQlQkIlODAlRTQlQjklODg=">ç»“æœ<i class="fa fa-external-link-alt"></i></span>, æœ‰æ—¶é—´å¯ä»¥æ…¢æ…¢ç†è§£.</p>
<p>å½“ä½ å†™ä»£ç æ—¶, ä¸å¯èƒ½å®Œå…¨éƒ½é è‡ªå·±ä»é›¶å¼€å§‹, è¿™æ ·å­å¾ˆä½æ•ˆ<del>å¹¶ä¸”å¾ˆè ¢</del>, æ‰€ä»¥å¯¹äº <code>python</code> è€Œè¨€, å†™ä»£ç ä¹‹å‰ç¡®å®šå¹¶å®‰è£…åˆé€‚çš„ç¬¬ä¸‰æ–¹åŒ…å°±æ˜¯åŸºæœ¬æ“ä½œ.</p>
<p>ç„¶è€Œ, ç¬¬ä¸‰æ–¹åŒ…åœ¨å‘å¸ƒçš„æ—¶å€™, å¯èƒ½ä¼šå­˜åœ¨è®¸å¤šä¸åŒçš„ç‰ˆæœ¬, ä¸åŒé¡¹ç›®ä¹‹é—´æ‰€éœ€è¦çš„åŒ…ç‰ˆæœ¬ä¹Ÿä¸å°½ç›¸åŒ, ä¼šé€ æˆå·¨å¤§çš„å…¼å®¹é—®é¢˜ (æ¯”å¦‚ä¸‡æ¶çš„ <code>tensorflow 1.x</code> å’Œ <code>tensorflow 2.x</code>). è¿™ç§æ—¶å€™å°±éœ€è¦ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ.</p>
<p>è™šæ‹Ÿç¯å¢ƒå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ &quot;<code>python</code> å’Œå¯¹åº”çš„åŒ…çš„å‰¯æœ¬&quot;, æœ€åŸºæœ¬çš„è¦ç´ æ˜¯ç¯å¢ƒå†…çš„ <code>python</code> ç‰ˆæœ¬å’ŒåŒ…çš„ç‰ˆæœ¬. æ¯ä¸€ä¸ªç¯å¢ƒä¹‹é—´çš„ <code>python</code> å’ŒåŒ…ç‰ˆæœ¬éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„. è¿™æ ·å­åœ¨è¿è¡Œé¡¹ç›®æ—¶, æˆ‘ä»¬å¯ä»¥é€‰æ‹©ç‰¹å®šçš„æŸä¸€ä¸ªç¯å¢ƒ, ä»è€Œä½¿ç”¨æŸä¸ªç‰¹å®šçš„ <code>python</code> ç‰ˆæœ¬ä¸åŒ…ç‰ˆæœ¬.</p>
<h3 id="è™šæ‹Ÿç¯å¢ƒç®¡ç†"><a href="#è™šæ‹Ÿç¯å¢ƒç®¡ç†" class="headerlink" title="è™šæ‹Ÿç¯å¢ƒç®¡ç†"></a>è™šæ‹Ÿç¯å¢ƒç®¡ç†</h3><p>ç½‘ä¸Šå¾ˆå¤šæ¨èä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5hY29uZGEuY29tLw==">Anaconda<i class="fa fa-external-link-alt"></i></span> æ¥è¿›è¡ŒåŒ…å’Œç¯å¢ƒçš„ç®¡ç†, æˆ‘è§‰å¾—å¯ä»¥ä½†æ²¡å¿…è¦, ä¸€æ˜¯è‡ƒè‚¿äºŒæ˜¯è®©æ–°æ‰‹æœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘. ä¸è¿‡ç­‰ç†Ÿç»ƒä¹‹åç”¨å€’æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©.</p>
<p>è¿™é‡Œåªä»‹ç»ä¸€ä¸‹ <code>python</code> è‡ªå¸¦çš„ <code>venv</code> æ¨¡å—ä½¿ç”¨ä»¥åŠç¬¬ä¸‰æ–¹åŒ… <code>virtualenvwrapper-win</code> çš„ä½¿ç”¨.</p>
<h4 id="åœ¨ç¯å¢ƒä¸­å®‰è£…ç¬¬ä¸‰æ–¹åŒ…"><a href="#åœ¨ç¯å¢ƒä¸­å®‰è£…ç¬¬ä¸‰æ–¹åŒ…" class="headerlink" title="åœ¨ç¯å¢ƒä¸­å®‰è£…ç¬¬ä¸‰æ–¹åŒ…"></a>åœ¨ç¯å¢ƒä¸­å®‰è£…ç¬¬ä¸‰æ–¹åŒ…</h4><p>ä¸€èˆ¬æ¥è¯´, å®‰è£…å®Œ <code>python</code> ä¹‹å, å°±ä¼šæœ‰ä¸€ä¸ª &quot;æœ¬åœ°ç¯å¢ƒ&quot;, è€Œå°†é™¤æœ¬åœ°ç¯å¢ƒä¹‹å¤–çš„å…¶ä»–ç¯å¢ƒé€šå¸¸ &quot;è™šæ‹Ÿç¯å¢ƒ&quot;.</p>
<p>åœ¨è¿è¡Œ <code>python</code> ç¨‹åºæ—¶, æ˜¯æŒ‰ç…§æ‰€æŒ‡å®šçš„ <code>python</code> è§£é‡Šå™¨æ¥å†³å®šä½¿ç”¨çš„ç¯å¢ƒçš„.</p>
<p>æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œé‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>python</code> æŒ‡ä»¤, å®é™…ä¸Šæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨å®‰è£…æ—¶å‹¾é€‰äº† &quot;Add Python 3.8 to PATH&quot;, åœ¨ç¯å¢ƒå˜é‡ <code>PATH</code> ä¸­æ·»åŠ äº†æœ¬åœ°ç¯å¢ƒä¸­ <code>python</code> è§£é‡Šå™¨çš„è·¯å¾„, æ‰€ä»¥åœ¨ä½¿ç”¨ <code>python</code> æŒ‡ä»¤æ—¶, å®é™…ä¸Šå°±æ˜¯ä½¿ç”¨äº†æœ¬åœ°ç¯å¢ƒ.</p>
<p>é€šå¸¸ä¸»è¦ä½¿ç”¨å†…ç½®çš„ <code>pip</code> æ¨¡å—è¿›è¡Œç¬¬ä¸‰æ–¹åŒ…çš„ç®¡ç†, å¹¶ä¸”æœ‰ä»¥ä¸‹å‡ ä¸ªå¸¸ç”¨å‘½ä»¤.</p>
<ul>
<li><p><code>&lt;è§£é‡Šå™¨&gt; -m pip list &lt;åŒ…å&gt;</code>: åˆ—å‡ºå½“å‰ç¯å¢ƒæ‰€æœ‰å®‰è£…çš„åŒ….</p>
</li>
<li><p><code>&lt;è§£é‡Šå™¨&gt; -m pip install &lt;åŒ…å&gt;</code>: å®‰è£…åŒ….</p>
</li>
<li><p><code>&lt;è§£é‡Šå™¨&gt; -m pip install &lt;åŒ…å&gt;</code>: å¸è½½åŒ….</p>
</li>
</ul>
<p><code>&lt;è§£é‡Šå™¨&gt;</code> å°±æ˜¯ä½ è¦è¿›è¡ŒåŒ…ç®¡ç†çš„ç¯å¢ƒçš„è§£é‡Šå™¨ <code>python.exe</code> è·¯å¾„, å¯¹äºæœ¬åœ°ç¯å¢ƒæ¥è¯´å°±æ˜¯ç›´æ¥ä½¿ç”¨çš„ <code>python</code> å‘½ä»¤.</p>
<p><code>-m pip</code> è¡¨ç¤ºè°ƒç”¨äº†æŒ‡å®šè§£é‡Šå™¨ä¸­çš„ <code>pip</code> æ¨¡å—è¿›è¡ŒåŒ…çš„ç®¡ç†.</p>
<p><code>&lt;åŒ…å&gt;</code> åˆ™æ˜¯ä½ éœ€è¦çš„åŒ…çš„ &quot;å®‰è£…åç§°&quot;, ä¸€èˆ¬æ¥è¯´å®ƒå’Œ <code>import</code> è¯­å¥çš„åå­—æ˜¯ä¸€è‡´çš„, ä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½ä¸ä¸€æ ·, æ¨èå»å®˜æ–¹çš„åŒ…å‘å¸ƒç½‘ç«™ <span class="exturl" data-url="aHR0cHM6Ly9weXBpLm9yZy8=">https://pypi.org/<i class="fa fa-external-link-alt"></i></span> ä¸Šè¿›è¡Œæœç´¢.</p>
<p>é™¤æ­¤ä¹‹å¤–, <code>pip</code> ä¹Ÿæ”¯æŒä½¿ç”¨ <code>whl</code> æ–‡ä»¶æˆ–è€…æºç å®‰è£…, å…·ä½“çš„å¯ä»¥è‡ªè¡Œè¿›ä¸€æ­¥å­¦ä¹ .</p>
<h4 id="åˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ"><a href="#åˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="åˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ"></a>åˆ›å»ºå¹¶ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ</h4><p>æœ€ç®€å•çš„åˆ›å»ºæ–¹æ³•æ˜¯ä½¿ç”¨è‡ªå¸¦çš„ <code>venv</code> æ¨¡å—, å‘½ä»¤å¦‚ä¸‹.</p>
<p><code>python -m venv &lt;è·¯å¾„&gt;</code></p>
<p>æ¯”å¦‚ä½¿ç”¨ <code>python -m venv env</code> åˆ™ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª <code>env</code> æ–‡ä»¶å¤¹, è¿™é‡Œé¢å°±åŒ…å«äº†åä¸º <code>env</code> çš„è™šæ‹Ÿç¯å¢ƒçš„è§£é‡Šå™¨ä»¥åŠç¬¬ä¸‰æ–¹åº“.</p>
<p>å¦å¤–æ¯”è¾ƒé‡è¦çš„æ–‡ä»¶æ˜¯ <code>activate</code> ä¸ <code>deactivate</code>, ç”¨äºæ¿€æ´»å’Œé€€å‡ºè™šæ‹Ÿç¯å¢ƒ.</p>
<p>å…·ä½“çš„ä½¿ç”¨åœ¨åé¢çš„éƒ¨åˆ†<a href="#%E5%9C%A8-VS-Code-%E4%B8%AD%E4%BD%BF%E7%94%A8-Python">åœ¨ VS Code ä¸­ä½¿ç”¨ Python</a> ä¸­å†è¿›è¡Œè¯´æ˜.</p>
<p>å¦ä¸€ç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ <code>virtualenvwrapper-win</code> æ¥è¾…åŠ©æˆ‘ä»¬ç®¡ç†è™šæ‹Ÿç¯å¢ƒ.</p>
<p>ä½¿ç”¨ <code>python -m pip install virtualenvwrapper-win</code> è¿›è¡Œå®‰è£…. å®‰è£…å®Œå, å³å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ä»¥ä¸‹å‡ ä¸ªå¸¸ç”¨å‘½ä»¤å¯¹æœºå™¨ä¸Šçš„è™šæ‹Ÿç¯å¢ƒè¿›è¡Œé›†ä¸­ç®¡ç†.</p>
<ul>
<li><code>mkvirtualenv &lt;è™šæ‹Ÿç¯å¢ƒåç§°&gt;</code>: åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ.</li>
<li><code>workon &lt;è™šæ‹Ÿç¯å¢ƒåç§°&gt;</code>: æ¿€æ´»å¯¹åº”çš„è™šæ‹Ÿç¯å¢ƒ.</li>
<li><code>rmvirtualenv &lt;è™šæ‹Ÿç¯å¢ƒåç§°&gt;</code>: åˆ é™¤è™šæ‹Ÿç¯å¢ƒ.</li>
</ul>
<p>å‰é¢çš„ <code>venv</code> æ¨¡å—å¸¸å¸¸ç”¨äºæŸä¸ªé¡¹ç›®å†…çš„ä¸´æ—¶ç¯å¢ƒ, è€Œ <code>virtualenvwrapper-win</code> è¿™ä¸ªç¬¬ä¸‰æ–¹å·¥å…·ä¸»è¦ç”¨äºä½ å¸Œæœ›è‡ªå·±çš„ç”µè„‘ä¸Šå¸¸é©»æŸäº›ä¸åŒç±»åˆ«çš„ç¯å¢ƒ, å¹¶å¯¹å®ƒä»¬æ–¹ä¾¿çš„è¿›è¡Œé›†ä¸­ç®¡ç†.</p>
<p>é»˜è®¤è¯¥æ¨¡å—åˆ›å»ºçš„ç¯å¢ƒéƒ½å°†ä½äº <code>%USERPROFILE%\envs</code> æ–‡ä»¶å¤¹ä¸‹,å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ <code>WORKON_HOME</code> æ¥è‡ªå®šä¹‰ä½ å¸Œæœ›çš„å­˜å‚¨ä½ç½®.</p>
<h3 id="å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åŒ…"><a href="#å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åŒ…" class="headerlink" title="å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åŒ…"></a>å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åŒ…</h3><p>å¯¹äºé€Ÿé€šç½‘å®‰, æœ‰ä¸€äº›å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹åº“æ€»ç»“, åœ¨è¿™é‡ŒæŠŠæˆ‘è‡ªå·±å¸¸ç”¨çš„åŒ…æƒ…å†µåˆ—ä¸¾ä¸€ä¸‹.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ç”¨äºæ ¼å¼åŒ–å’Œæ£€æµ‹ä»£ç è§„èŒƒçš„å·¥å…·</span><br><span class="line">autopep8</span><br><span class="line">pylint</span><br><span class="line"></span><br><span class="line"># ä¸çˆ¬è™«æœ‰å…³çš„åº“</span><br><span class="line">lxml</span><br><span class="line">beautifulsoup4</span><br><span class="line">requests</span><br><span class="line"></span><br><span class="line"># ä¸æ•°æ®å¤„ç†æœ‰å…³çš„åº“</span><br><span class="line">numpy</span><br><span class="line">pandas</span><br><span class="line">matplotlib</span><br><span class="line"></span><br><span class="line"># æœºå™¨å­¦ä¹ ä»¥åŠæ·±åº¦å­¦ä¹ ç›¸å…³çš„åº“</span><br><span class="line">opencv-python</span><br><span class="line">scikit-learn</span><br><span class="line"># torch</span><br><span class="line"># torchaudio</span><br><span class="line"># torchvision</span><br><span class="line"></span><br><span class="line"># åœ¨ VS Code å†…ä½¿ç”¨ jupyter notebook æœ‰å…³çš„åº“</span><br><span class="line">ipykernel</span><br><span class="line">jupyter</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>torch</code> çš„å®‰è£…éœ€è¦å‰å¾€å®˜ç½‘ <span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy8=">https://pytorch.org/<i class="fa fa-external-link-alt"></i></span> æŒ‰è¯´æ˜è¿›è¡Œå®‰è£….</p>
<h2 id="åœ¨-VS-Code-ä¸­ä½¿ç”¨-Python"><a href="#åœ¨-VS-Code-ä¸­ä½¿ç”¨-Python" class="headerlink" title="åœ¨ VS Code ä¸­ä½¿ç”¨ Python"></a>åœ¨ VS Code ä¸­ä½¿ç”¨ Python</h2><p>è¿™ä¸€èŠ‚å°†ä¼šå®è·µä¸€ä¸‹å‰é¢æ‰€æœ‰çš„å†…å®¹, åœ¨ <code>VS Code</code> ä¸­ä½¿ç”¨ <code>python</code> å®Œæˆä¸€æ¬¡å‘é‡ä¹˜æ³•è®¡ç®—.</p>
<p>æ‰“å¼€ä¹‹å‰æ›¾ç»åˆ›å»ºçš„ <code>example</code> æ–‡ä»¶å¤¹, å¹¶ä¸”æ–°å»ºä¸€ä¸ªç»ˆç«¯.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vNUegI.png" alt="vNUegI.png"></p>
<p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸ºè¿™ä¸ªé¡¹ç›®å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„è™šæ‹Ÿç¯å¢ƒ, å–åä¸º <code>env</code>.</p>
<p><code>python -m venv env</code></p>
<p><img data-src="/static/image/wast-pythonandvsc/vNami4.png" alt="vNami4.png"></p>
<p>å‘½ä»¤æ‰§è¡Œå®Œæˆå, å·¦è¾¹çš„èµ„æºç®¡ç†å™¨é¢æ¿ä¸Šå¤šå‡ºæ¥ä¸€ä¸ª <code>env</code> æ–‡ä»¶å¤¹, è¿™å°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºå¥½çš„è™šæ‹Ÿç¯å¢ƒ. æˆ‘ä»¬ä½¿ç”¨ <code>.\env\Scripts\activate</code> åœ¨ç»ˆç«¯ä¸­æ¿€æ´»è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒ, æ¿€æ´»å®Œæˆåå¯ä»¥çœ‹åˆ°ç»ˆç«¯çš„æç¤ºä¿¡æ¯å‰é¢å¤šäº†ä¸€ä¸ª <code>(env)</code> æ ‡è®°, è¡¨ç¤ºå½“å‰ç»ˆç«¯å¤„äº <code>env</code> çš„è™šæ‹Ÿç¯å¢ƒä¹‹ä¸‹.</p>
<p>å¦‚æœå‡ºç°ä¸èƒ½æ‰§è¡Œçš„æƒ…å†µ, å¯ä»¥å‚è€ƒ<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZGF4aW9uZzEzMTQvcC8xNjI2NTU0OS5odG1s">è¿™ç¯‡åšå®¢<i class="fa fa-external-link-alt"></i></span>è§£å†³æƒé™é—®é¢˜. æˆ–è€…åœ¨ <code>VS Code</code> çš„è®¾ç½®é‡ŒæŠŠé»˜è®¤çš„ç»ˆç«¯ç±»å‹è°ƒæˆ <code>cmd</code> è€Œä¸æ˜¯ <code>powershell</code>, æˆ‘æ¨èæ”¹æˆ <code>cmd</code> ä¸€åŠ³æ°¸é€¸. <del><code>powershell</code> å±äº‹å¤š</del>.</p>
<p>è§£å†³å®Œé—®é¢˜ä¹‹åå°±å¦‚ä¸‹å›¾æ‰€ç¤ºäº†.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vNdYn0.png" alt="vNdYn0.png"></p>
<p>æ­¤æ—¶åœ¨ç»ˆç«¯é‡Œç›´æ¥æ‰§è¡Œ <code>python</code> æœ‰å…³çš„å‘½ä»¤, éƒ½ä¼šæ˜ å°„åˆ°è™šæ‹Ÿç¯å¢ƒé‡Œçš„å‘½ä»¤.</p>
<p>ç„¶åæˆ‘ä»¬ç»§ç»­, ä½¿ç”¨ <code>pip</code> å‘è™šæ‹Ÿç¯å¢ƒé‡Œæ·»åŠ ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ <code>numpy</code>.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vNwSvn.png" alt="vNwSvn.png"></p>
<p>é¡ºåˆ©å®‰è£…å®Œæˆä¹‹å, å¯ä»¥çœ‹åˆ°å·¦è¾¹çš„ <code>env</code> æ–‡ä»¶å¤¹é‡Œ <code>site-packages</code> ä¸‹å¤šå‡ºæ¥ä¸€ä¸ª <code>numpy</code> çš„æ–‡ä»¶å¤¹, è¿™å°±æ˜¯æˆ‘ä»¬åˆšåˆšå®‰è£…å¥½çš„ç¬¬ä¸‰æ–¹åº“äº†. åŒæ—¶ç»ˆç«¯é‡Œç»™äº†æˆ‘ä»¬ä¸€ä¸ª <code>WARNING</code>, æç¤ºæˆ‘ä»¬å¯ä»¥å¯¹ <code>pip</code> æ¨¡å—è¿›è¡Œå‡çº§. è™½ç„¶å½±å“ä¸æ˜¯å¾ˆå¤§, ä¸è¿‡æ¨èå¤åˆ¶å®ƒæä¾›çš„æŒ‡ä»¤å‡ä¸€ä¸‹çº§, è¿™æ · <code>pip</code> åœ¨æŸ¥æ‰¾å’Œå®‰è£…åŒ…æ—¶èƒ½å¤Ÿä½¿ç”¨æœ€æ–°çš„åŠŸèƒ½, å‡å°å®‰è£…å¤±è´¥çš„é£é™©<del>ä¸»è¦æ˜¯æœ‰å½©è‰²è¿›åº¦æ¡</del>.</p>
<p>ç„¶åæ¸…ç©ºä¹‹å‰ <code>main.py</code> é‡Œé¢çš„ä»£ç , å¹¶ä¸”æ•²å…¥ä»¥ä¸‹æ–°çš„å†…å®¹.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vNDSvd.png" alt="vNDSvd.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    vector1 = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">    vector2 = np.array([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(np.dot(vector1, vector2))</span><br><span class="line">    <span class="built_in">print</span>(np.multiply(vector1, vector2))</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç° <code>import</code> è¯­å¥çš„ <code>numpy</code> æœ‰é»„è‰²æ³¢æµªçº¿, åŒæ—¶ä¸‹é¢çš„ &quot;é—®é¢˜&quot; é¢æ¿æœ‰å†™å‡ºæ¥åŸå› , æ„æ€æ˜¯æ²¡æœ‰ <code>numpy</code> è¿™ä¸ªåº“.</p>
<p>è¿™æ˜¯å› ä¸ºè™½ç„¶æˆ‘ä»¬åˆšåˆšåœ¨ç»ˆç«¯é‡Œæ˜¯å·²ç»æˆåŠŸæ¿€æ´»äº†è™šæ‹Ÿç¯å¢ƒ, ä½†æ˜¯å¯¹äº <code>VS Code</code> æ¥è¯´, å®ƒå¹¶ä¸å…³å¿ƒç»ˆç«¯é‡Œæ˜¯ä»€ä¹ˆæƒ…å†µ, è€Œæ˜¯å¯¹äºè¿™ä¸ªé¡¹ç›®æ¥è¯´, å®ƒéœ€è¦ä½¿ç”¨ä»€ä¹ˆç¯å¢ƒæ¥å¤„ç†é¡¹ç›®å†…å®¹, æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åœ¨ä¸‹æ–¹çš„çŠ¶æ€æ é‡Œåˆ‡æ¢ <code>VS Code</code> å¯¹äºå½“å‰é¡¹ç›®ä½¿ç”¨çš„ <code>python</code> ç¯å¢ƒ.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vN0OpQ.png" alt="vN0OpQ.png"></p>
<p>ç‚¹å‡»ä¸‹æ–¹çŠ¶æ€æ çš„ç¯å¢ƒé€‰æ‹©, å¹¶ä¸”åˆ‡æ¢åˆ°åˆšåˆšåˆ›å»ºçš„ <code>env</code> ç¯å¢ƒ, æ­¤æ—¶ä¸‹æ–¹çš„ç¯å¢ƒå·²ç»æ¢æˆäº† <code>&#39;env&#39;:venv</code>, å¹¶ä¸”åˆšåˆšçš„é»„è‰²æ³¢æµªçº¿ä¸é—®é¢˜ä¹Ÿæ¶ˆå¤±äº†.</p>
<p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€‰æ‹©åœ¨æ¿€æ´»äº†è™šæ‹Ÿç¯å¢ƒçš„ç»ˆç«¯é‡Œè¿è¡Œè¿™ä»½ä»£ç , æˆ–è€…ä½¿ç”¨å¿«æ·é”® <code>Ctrl + F5</code> è®© <code>VS Code</code> å¸®æˆ‘ä»¬è¿è¡Œ. è¿™é‡Œå±•ç¤ºä¸€ä¸‹åœ¨ç»ˆç«¯é‡Œç›´æ¥è¿è¡Œçš„ç»“æœ, å¯ä»¥çœ‹åˆ°æˆåŠŸè¾“å‡º, ä¸€ä¸ªæ˜¯å‘é‡å†…ç§¯ç»“æœ, ä¸€ä¸ªæ˜¯å‘é‡æŒ‰ä½ä¹˜æ³•ç»“æœ.</p>
<p><img data-src="/static/image/wast-pythonandvsc/vNDsPO.png" alt="vNDsPO.png"></p>
<h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>åˆ°è¿™é‡Œå°±ç»“æŸäº†, è¯´å®è¯åªè®²äº† <code>VS Code</code> ä¸­ä½¿ç”¨ <code>python</code> çš„æœ€åŸºæœ¬æŠ€å·§, è¿™äº›æ“ä½œä¹‹åå†™ä»£ç çš„æ—¶å€™å¤šæ“ä½œå‡ æ¬¡åº”è¯¥å°±çƒ‚ç†Ÿäºå¿ƒäº†.</p>
<p>ä½†æ˜¯å¯¹äºè¿›æ ¡æ²¡å¤šä¹…çš„èŒæ–°ä»¬æ¥è¯´, ä¼°è®¡çœ‹çš„è¿˜æ˜¯å¾ˆæ™•çš„, å› ä¸ºæœ‰å¾ˆå¤šæ–°åè¯, ç‰¹åˆ«æ˜¯ &quot;ç¯å¢ƒå˜é‡&quot; è¿™ç§, å¯èƒ½æ˜¯å®Œå…¨ç¬¬ä¸€æ¬¡å¬è¯´, è€Œä¸”ä¹Ÿå®¹æ˜“å‡ºé—®é¢˜. æ‰€ä»¥è¿˜æ˜¯å»ºè®®å¤šåŠ¨æ‰‹å°è¯•å°è¯•, å¹¶ä¸”å–„ç”¨æœç´¢å¼•æ“, å¤šç¿»å‡ ç¯‡åšå®¢, æ€»ä¼šèƒ½å¤Ÿæ‰¾åˆ°é€‚åˆä½ é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ.</p>
<p>å°±è¿™æ ·äº†, ä¸‹å›å•ç‹¬å†™å†™æ€ä¹ˆåˆç†çš„ç§‘å­¦ä¸Šç½‘, ä¸ºä½¿ç”¨ <code>Github</code> <del>æŠ„ä»£ç </del>æ‰“ä¸‹åšå®åŸºç¡€.</p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>æ–°æ‰‹å…¥é—¨</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>VS Code</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäº Requests çš„çˆ¬è™«å…¥é—¨</title>
    <url>//posts/2022/08/16/wast-spider/</url>
    <content><![CDATA[<p>æœ¬ç¯‡æ˜¯åŸºäº <code>python</code> è¯­è¨€åŠå…¶ç¬¬ä¸‰æ–¹åº“ <code>requests</code> çš„çˆ¬è™«å…¥é—¨, å®ç°ä¸€ä¸ªæœ€ç®€å•çš„çˆ¬è™«, ä»ç½‘é¡µä¸Šè‡ªåŠ¨åŒ–è·å–æˆ‘ä»¬èƒ½æƒ³è¦çš„ä¿¡æ¯.</p>
<span id="more"></span>

<p>æ•™ç¨‹è¦å¼€å§‹åŠ é€Ÿäº†! ä»æœ¬ç¯‡å¼€å§‹, é»˜è®¤ä½ å·²ç»æœ‰äº†ä¸€äº›ç¼–ç¨‹åŸºç¡€, å¹¶ä¸”å¯¹ <code>python</code> å·²ç»æœ‰è¿‡ä¸å°‘çš„ä½¿ç”¨ç»éªŒ, å°†ä»¥é€Ÿé€šä¸ºæ ¹æœ¬ç›®çš„, è¿›è¡Œç¤ºèŒƒæ€§æ“ä½œ, è€Œä¸ä¼šè¿‡æ·±çš„æ¶‰åŠä»£ç åŸç†. <del>åŠªåŠ›æˆä¸ºä¸€ä¸ªè°ƒåŒ…ä¾ å§!</del></p>
<h2 id="å·¥å…·ä¸ç¯å¢ƒå‡†å¤‡"><a href="#å·¥å…·ä¸ç¯å¢ƒå‡†å¤‡" class="headerlink" title="å·¥å…·ä¸ç¯å¢ƒå‡†å¤‡"></a>å·¥å…·ä¸ç¯å¢ƒå‡†å¤‡</h2><p>æµè§ˆå™¨: <code>Edge</code>, <code>Chrome</code>, <code>Firefox</code> å‡å¯, æ¨èä½¿ç”¨ <code>Firefox</code>, æŠ“åŒ…æ›´æ–¹ä¾¿.</p>
<p><code>python</code> çš„ç¬¬ä¸‰æ–¹åº“: <code>beautifulsoup4</code>, <code>lxml</code>, <code>requests</code>.</p>
<h2 id="çˆ¬è™«åŸºæœ¬åŸç†"><a href="#çˆ¬è™«åŸºæœ¬åŸç†" class="headerlink" title="çˆ¬è™«åŸºæœ¬åŸç†"></a>çˆ¬è™«åŸºæœ¬åŸç†</h2><p>çˆ¬è™«çš„æœ¬è´¨æ˜¯åœ¨æ¨¡ä»¿ç”¨æˆ·æ“ä½œæµè§ˆå™¨çš„è¿‡ç¨‹.</p>
<p>æˆ‘ä»¬å¹³å¸¸çœ‹åˆ°çš„ç½‘é¡µå†…å®¹, éƒ½æ˜¯é€šè¿‡æ“ä½œæµè§ˆå™¨, æµè§ˆå™¨å†å‘æœåŠ¡å™¨è¯·æ±‚å†…å®¹ä»è€Œå‘ˆç°ç»™ç”¨æˆ·, çœå»å¤æ‚çš„ç½‘ç»œé€šä¿¡è¿‡ç¨‹ä¹‹å, å¯ä»¥ç®€è¦æ¦‚æ‹¬æˆä¸‹é¢çš„æµç¨‹å›¾.</p>
<p><img data-src="/static/image/wast-spider/v0cQQx.png" alt="v0cQQx.png"></p>
<p>æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯ä½¿ç”¨ä»£ç æ¥å®Œæˆå…¶ä¸­çš„å‘å‡ºè¯·æ±‚å’Œæ¥æ”¶å“åº”çš„è¿‡ç¨‹.</p>
<h2 id="å¿«é€Ÿä¸Šæ‰‹"><a href="#å¿«é€Ÿä¸Šæ‰‹" class="headerlink" title="å¿«é€Ÿä¸Šæ‰‹"></a>å¿«é€Ÿä¸Šæ‰‹</h2><p>ä¸‹é¢ä»¥ç™¾åº¦çƒ­æœçš„æ¸¸æˆæ¦œä¸ºä¾‹, æ¢³ç†ä¸€ä¸‹æ¯ä¸€æ­¥, æœ€åå†™ä¸€ä¸ªçˆ¬è™«å‡ºæ¥.</p>
<h3 id="åˆ†æç½‘ç«™"><a href="#åˆ†æç½‘ç«™" class="headerlink" title="åˆ†æç½‘ç«™"></a>åˆ†æç½‘ç«™</h3><p>è¿™æ˜¯ç¬¬ä¸€æ­¥ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€æ­¥, é€šå¸¸ä½¿ç”¨æµè§ˆå™¨çš„å¼€å‘äººå‘˜å·¥å…·, å¯¹ä½ æƒ³è¦æŠ“å–çš„é¡µé¢è¿›è¡Œç½‘ç»œè¯·æ±‚åˆ†æ, è§‚å¯Ÿè¯·æ±‚æ˜¯å¦‚ä½•å‘èµ·, æƒ³è¦çš„å†…å®¹å“åº”è¿”å›åå‡ºç°åœ¨ä»€ä¹ˆåœ°æ–¹.</p>
<p>ç›®æ ‡ç½‘é¡µç½‘å€ä¸º <code>https://top.baidu.com/board?tab=game</code>, æµè§ˆå™¨æŸ¥çœ‹ä¸€ä¸‹é•¿è¿™æ ·.</p>
<p><img data-src="/static/image/wast-spider/v0hSFU.png" alt="v0hSFU.png"></p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è·å¾—æ•´ä¸ªæ¦œæŒ‰é¡ºåºæ‰€æœ‰æ¸¸æˆçš„<strong>åå­—</strong>, <strong>çƒ­æœæŒ‡æ•°</strong>, <strong>ç±»å‹</strong>ä»¥åŠ<strong>è¯¦æƒ…é¡µé“¾æ¥</strong>.</p>
<p>æ‰“å¼€æˆ‘ä»¬çš„ <code>Firefox</code> æµè§ˆå™¨ (å…¶ä»–æµè§ˆå™¨ä¹Ÿæ˜¯ç±»ä¼¼çš„), é¦–å…ˆå¿«æ·é”® <code>F12</code> æˆ–è€…æ›´å¤šå·¥å…·é‡Œæ‰“å¼€ &quot;å¼€å‘è€…å·¥å…·&quot;, å¹¶åˆ‡æ¢åˆ° &quot;ç½‘ç»œ&quot; é€‰é¡¹å¡.</p>
<p><img data-src="/static/image/wast-spider/v0hhc9.png" alt="v0hhc9.png"></p>
<p>æ­¤æ—¶æˆ‘ä»¬çš„é¡µé¢åœç•™åœ¨ç›®æ ‡é¡µé¢, å¹¶ä¸”æ²¡æœ‰ä»»ä½•çš„è®°å½•ä¿¡æ¯, å› æ­¤æˆ‘ä»¬é€‰æ‹© &quot;é‡æ–°è½½å…¥&quot; æˆ–è€…åˆ·æ–°ä¸€æ¬¡é¡µé¢, è®©æµè§ˆå™¨é‡æ–°å‘èµ·ä¸€æ¬¡è¯·æ±‚.</p>
<p><img data-src="/static/image/wast-spider/v04mBq.png" alt="v04mBq.png"></p>
<p>æŸ¥çœ‹ç½‘ç»œè¯·æ±‚çš„ç¬¬ä¸€é¡¹, ä¹Ÿå°±æ˜¯å‘ç›®æ ‡ç½‘å€å‘èµ·çš„è¯·æ±‚, å¹¶é€‰æ‹©å³ä¾§çš„å“åº”é€‰é¡¹å¡, å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¦çš„å†…å®¹å·²ç»é¢„è§ˆå‡ºæ¥äº†.</p>
<p>æ‰€ä»¥æˆ‘ä»¬ç¡®å®šçˆ¬å–å†…å®¹çš„æ–¹æ¡ˆ, å°±æ˜¯ç›´æ¥è¯·æ±‚ç›®æ ‡ç½‘å€, ç„¶åè·å¾—æ–‡æœ¬å†…å®¹å“åº”å³å¯.</p>
<h3 id="è¯·æ±‚ç½‘é¡µ"><a href="#è¯·æ±‚ç½‘é¡µ" class="headerlink" title="è¯·æ±‚ç½‘é¡µ"></a>è¯·æ±‚ç½‘é¡µ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">res = requests.get(<span class="string">&quot;https://top.baidu.com/board?tab=game&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res.status_code)</span><br><span class="line"></span><br><span class="line">Path(<span class="string">&quot;a.html&quot;</span>).write_text(res.text, encoding=<span class="string">&quot;utf8&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¦‚ä¸Šæ‰€ç¤º, æˆ‘ä»¬åœ¨è¿™é‡Œè§£é‡Šä¸€ä¸‹å…³é”®ä»£ç  <code>requests.get</code>.</p>
<p>åœ¨ä¹‹å‰çš„ç½‘ç»œè¯·æ±‚é¢æ¿ä¸­, é™¤äº†çœ‹åˆ°äº†å“åº”, æˆ‘ä»¬è¿˜èƒ½å¤Ÿçœ‹åˆ°å·¦ä¾§çš„ä¿¡æ¯æ é‡Œ, æœ‰ &quot;çŠ¶æ€&quot; ä¸ &quot;æ–¹æ³•&quot; ä¸¤ä¸ªå–å€¼, åˆ†åˆ«ä¸º <code>200</code> å’Œ <code>GET</code>.</p>
<p>æ–¹æ³•: å½“æµè§ˆå™¨å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚æ—¶, è¯·æ±‚æ˜¯æœ‰ä¸åŒç±»å‹çš„, å…¶åŸºæœ¬çš„åŒºåˆ†æ ‡å¿—å°±æ˜¯è¯¥è¯·æ±‚çš„æ–¹æ³• (Method), å¸¸è§çš„æœ‰ <code>GET</code> ä¸ <code>POST</code>, æ­¤å¤„åˆ™ä¸º <code>GET</code> è¯·æ±‚æ–¹æ³•.</p>
<p>çŠ¶æ€: å½“æœåŠ¡å™¨é€å›å“åº”æ—¶, é™¤äº†ç›¸åº”çš„å†…å®¹, è¿˜ä¼šæœ‰ä¸€ä¸ªåŸºæœ¬è¦ç´  &quot;å“åº”çŠ¶æ€ç &quot; (Status Code), ç”¨æ¥æ ‡è¯†æ­¤æ¬¡è¯·æ±‚æ“ä½œçš„ç»“æœ (è€Œéè¯·æ±‚éœ€è¦çš„å†…å®¹), å¯ä»¥é€šè¿‡çŠ¶æ€ç æ¥åˆ¤æ–­è¿”å›å†…å®¹çš„ç±»åˆ«. é€šå¸¸ä¸º <code>2XX</code>, <code>4XX</code> ç­‰ä¸‰ä½æ•°å­—, æ­¤å¤„çš„ <code>200</code> åˆ™æ˜¯è¡¨ç¤ºè¯·æ±‚æˆåŠŸ, å¹¶æ­£ç¡®çš„è¿”å›äº†å“åº”å†…å®¹.</p>
<p>æ‰€ä»¥ä»£ç é‡Œçš„ <code>requests.get</code> å°±æ˜¯å¯¹å‚æ•°é‡Œçš„ url ä½¿ç”¨ <code>GET</code> æ–¹æ³•å‘èµ·äº†è¯·æ±‚, å¹¶å°†å“åº”å­˜å‚¨åˆ°äº† <code>res</code> å˜é‡ä¸­, éšåå°†å“åº”çš„çŠ¶æ€ç æ‰“å°å‡ºæ¥.</p>
<p>å°†å“åº”çš„æ–‡æœ¬å†…å®¹ä¿å­˜è‡³æœ¬åœ°æ–‡ä»¶ <code>a.html</code> ä¸­, ç­‰å¾…åç»­è¿›ä¸€æ­¥åˆ†æ.</p>
<h3 id="åˆ†æç½‘é¡µç»“æ„ä¸å†…å®¹"><a href="#åˆ†æç½‘é¡µç»“æ„ä¸å†…å®¹" class="headerlink" title="åˆ†æç½‘é¡µç»“æ„ä¸å†…å®¹"></a>åˆ†æç½‘é¡µç»“æ„ä¸å†…å®¹</h3><p>ä¸ç½‘ç«™çš„äº¤äº’å°±åˆ°æ­¤æš‚å‘Šä¸€æ®µè½äº†, æ¥ä¸‹æ¥æ˜¯å¯¹ç½‘é¡µå†…å®¹çš„åˆ†æ, ä»ä¸­æå–å‡ºæˆ‘ä»¬æƒ³è¦çš„å†…å®¹.</p>
<p>åœ¨ <code>VS Code</code> ä¸­æ‰“å¼€åˆšåˆšä¿å­˜çš„ <code>a.html</code>, å¹¶ä¸”ä½¿ç”¨è‡ªå¸¦æ ¼å¼åŒ–ç¨‹åºæ•´ç†ä¸€ä¸‹, å†ä½¿ç”¨ <code>Ctrl + F</code> æœç´¢å†…å®¹ä¸­çš„å…³é”®è¯è¿›è¡Œå¿«é€Ÿå®šä½.</p>
<p><img data-src="/static/image/wast-spider/v0oHrd.png" alt="v0oHrd.png"></p>
<p>å®šä½å®Œæˆå, æˆ‘ä»¬åˆ†ææ•°æ®é™„è¿‘çš„ç»“æ„.</p>
<p><img data-src="/static/image/wast-spider/v0TFZn.png" alt="v0TFZn.png"></p>
<p>è´´ä¸€ä¸ªç¼©å°åçš„å›¾, ç”± <code>html</code> çš„æ ‘å½¢ç»“æ„å¯ä»¥çŸ¥é“, çº¢æ¡†é‡Œçš„æ¯ä¸€ä¸ª <code>&lt;div&gt;</code> å—å†…å°±æ˜¯æ¦œä¸Šæ’åçš„å…¶ä¸­ä¸€é¡¹æ¸¸æˆæ•°æ®, è€Œå®ƒä»¬çš„åµŒå¥—ç»“æ„ä¹Ÿå¾ˆå®¹æ˜“åˆ†æ, æ‰€æœ‰çº¢æ¡†æ‰€ç¤ºçš„æ•°æ®éƒ½ä½äº <code>&lt;main&gt;</code> çš„ç¬¬äºŒä¸ª <code>&lt;div&gt;</code> çš„ç¬¬ä¸€ä¸ª <code>&lt;div&gt;</code> çš„ç¬¬äºŒä¸ª <code>&lt;div&gt;</code> å†…, ä¸è¿‡è¿™ä¸ªåµŒå¥—æœ‰ç‚¹ç¨é•¿, æˆ‘ä»¬å°è¯•çœ‹çœ‹æœ€è¿‘çš„ä¸€ä¸ª <code>div</code> æ˜¯å¦æœ‰ç‹¬ç‰¹æ€§.</p>
<p>ä½¿ç”¨ <code>Ctrl + F</code> æœç´¢æœ€é‡Œå±‚çš„ <code>&lt;div&gt;</code> å—çš„å±æ€§ <code>style</code> çš„å†…å®¹ <code>margin-bottom:20px</code>, æƒŠå–œçš„å‘ç°åªæŸ¥æ‰¾åˆ°äº†ä¸€ä¸ª, æ‰€ä»¥æˆ‘ä»¬å¾…ä¼šå¯ä»¥ç›´æ¥å®šä½åˆ°è¿™ä¸€å±‚, ç„¶åä¾æ¬¡è·å–å®ƒä¸‹é¢çš„å­çº§ <code>&lt;div&gt;</code> å†…å®¹, ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦çš„æ•°æ®.</p>
<p>æˆ‘ä»¬ç»§ç»­åˆ†æçº¢æ¡†æ‰€ç¤ºçš„ <code>&lt;div&gt;</code> å—å†…å®¹, å®ƒçš„å†…å®¹ç”± 3 éƒ¨åˆ†ç»„æˆ, åˆ†åˆ«æ˜¯ <code>&lt;a&gt;</code>, <code>&lt;div&gt;</code> å’Œ <code>&lt;div&gt;</code>, è€Œæˆ‘ä»¬éœ€è¦çš„å†…å®¹å°±ä½äºåä¸¤ä¸ª <code>&lt;div&gt;</code> ä¸­.</p>
<p>æŒ‰åŒæ ·çš„æ–¹å¼å¯ä»¥ç»§ç»­åˆ†ææœ€ç»ˆçš„æ–‡æœ¬æ•°æ®ä½äºä½•å¤„, æ­¤å¤„ä¸å†èµ˜è¿°.</p>
<h3 id="ä»ç½‘é¡µå†…å®¹æå–æ•°æ®"><a href="#ä»ç½‘é¡µå†…å®¹æå–æ•°æ®" class="headerlink" title="ä»ç½‘é¡µå†…å®¹æå–æ•°æ®"></a>ä»ç½‘é¡µå†…å®¹æå–æ•°æ®</h3><p>é¢å¯¹è¿™ç§æœ‰è‰¯å¥½åµŒå¥—ç»“æ„å±‚æ¬¡çš„ç½‘é¡µ, æˆ‘ä»¬ä½¿ç”¨ <code>beautifulsoup4</code> å¯¹å…¶è¿›è¡Œå†…å®¹è§£æ, ä¸‹é¢ç›´æ¥è´´ä»£ç .</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(res.text, <span class="string">&quot;lxml&quot;</span>)</span><br><span class="line">items_div = soup.find(<span class="string">&quot;div&quot;</span>, &#123;<span class="string">&quot;style&quot;</span>: <span class="string">&quot;margin-bottom:20px&quot;</span>&#125;).find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">for</span> div <span class="keyword">in</span> items_div:</span><br><span class="line">    index = div.find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">0</span>].find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">1</span>].get_text(strip=<span class="literal">True</span>)</span><br><span class="line">    name = div.find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">1</span>].find(<span class="string">&quot;a&quot;</span>, recursive=<span class="literal">False</span>).find(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>).get_text(strip=<span class="literal">True</span>)</span><br><span class="line">    link = div.find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">1</span>].find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">1</span>].find(<span class="string">&quot;a&quot;</span>, recursive=<span class="literal">False</span>).attrs[<span class="string">&quot;href&quot;</span>]</span><br><span class="line">    type_ = div.find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">1</span>].find_all(<span class="string">&quot;div&quot;</span>, recursive=<span class="literal">False</span>)[<span class="number">0</span>].get_text(strip=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;name&#125;</span>\t<span class="subst">&#123;index&#125;</span>\t<span class="subst">&#123;type_&#125;</span>\t<span class="subst">&#123;link&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>ä»£ç ä¸­å˜é‡ <code>items_div</code> å…¶ä¸­ä¸€ä¸ª <code>div</code> çš„ <code>html</code> å†…å®¹ä¹Ÿé™„ä¸Š.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;category-wrap_iQLoo square_1ULM9&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;img-wrapper_29V76&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">href</span>=<span class="string">&quot;https://www.baidu.com/s?wd=%E5%8E%9F%E7%A5%9E+%E6%B8%B8%E6%88%8F<span class="symbol">&amp;amp;</span>sa=fyb_game_all<span class="symbol">&amp;amp;</span>rsv_dl=fyb_game_all&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;index_1Ew5p c-index-bg1&quot;</span>&gt;</span> 1 <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">            <span class="attr">src</span>=<span class="string">&quot;https://fyb-1.cdn.bcebos.com/fyb-1/20220811/4d0a80d59a3675130cf61eff31e3ae41?x-bce-process=image/resize,m_fill,w_214,h_214&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">alt</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;border_3WfEn&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;trend_2RttY&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;img-wrap_JPOmE trend-icon_1Z3Cd&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">                <span class="attr">src</span>=<span class="string">&quot;//fyb-pc-static.cdn.bcebos.com/static/asset/icon-same_886375f242bd1538af21a9721f16b170.png&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;hot-index_1Bl1a&quot;</span>&gt;</span> 228934 <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;text_1lUwZ&quot;</span>&gt;</span> çƒ­æœæŒ‡æ•° <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;line_3-bzA&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">src</span>=<span class="string">&quot;//fyb-pc-static.cdn.bcebos.com/static/asset/line-bg@2x_95cb5a089159c6d5a959a596d460d60a.png&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content_1YWBm&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.baidu.com/s?wd=%E5%8E%9F%E7%A5%9E+%E6%B8%B8%E6%88%8F<span class="symbol">&amp;amp;</span>sa=fyb_game_all<span class="symbol">&amp;amp;</span>rsv_dl=fyb_game_all&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">&quot;title_dIF3B &quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;c-single-text-ellipsis&quot;</span>&gt;</span> åŸç¥ <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--s-frag--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;intro_1l0wp&quot;</span>&gt;</span> ç±»å‹ï¼šå•æœºæ¸¸æˆ <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;c-single-text-ellipsis desc_3CTjT&quot;</span>&gt;</span></span><br><span class="line">            é™Œç”Ÿçš„å¤©ç©ºä¸‹ï¼Œå°‘å¹´å°‘å¥³ç«‹äºå°˜æ²™ã€‚ä½ ä»¬æ˜¯ä¸€å¯¹æ—…è¡Œä¸­çš„åŒå­ï¼Œä»ä¸–ç•Œä¹‹å¤–æ¼‚æµè€Œæ¥ã€‚ä½ çš„è¡€äº²è¢«é™Œç”Ÿçš„ç¥çµå¸¦èµ°ï¼Œè€Œä½ ä¹Ÿè¢«ç¥å°å°ï¼Œé™·å…¥æ²‰çœ ã€‚å†åº¦é†’æ¥ï¼Œå¤©åœ°é—´é£æ™¯å·²å˜â€¦â€¦ã€ŠåŸç¥ã€‹æ˜¯ç”±ç±³å“ˆæ¸¸è‡ªç ”çš„ä¸€æ¬¾å…¨æ–°å¼€æ”¾ä¸–ç•Œå†’é™©RPGã€‚ä½ å°†åœ¨æ¸¸æˆä¸­æ¢ç´¢ä¸€ä¸ªè¢«ç§°ä½œã€Œæç“¦ç‰¹ã€çš„å¹»æƒ³ä¸–ç•Œã€‚åœ¨è¿™å¹¿é˜”çš„ä¸–ç•Œä¸­ï¼Œä½ å¯ä»¥è¸éä¸ƒå›½ï¼Œé‚‚é€…æ€§æ ¼å„å¼‚ã€èƒ½åŠ›ç‹¬ç‰¹çš„åŒä¼´ï¼Œä¸ä»–ä»¬ä¸€åŒå¯¹æŠ—å¼ºæ•Œï¼Œè¸ä¸Šå¯»å›è¡€äº²ä¹‹è·¯ï¼›ä¹Ÿå¯ä»¥ä¸å¸¦ç›®çš„åœ°æ¼«æ¸¸ï¼Œæ²‰æµ¸åœ¨å……æ»¡ç”Ÿæœºçš„ä¸–ç•Œ</span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.baidu.com/s?wd=%E5%8E%9F%E7%A5%9E+%E6%B8%B8%E6%88%8F<span class="symbol">&amp;amp;</span>sa=fyb_game_all<span class="symbol">&amp;amp;</span>rsv_dl=fyb_game_all&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">class</span>=<span class="string">&quot;look-more_3oNWC&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span> æŸ¥çœ‹æ›´å¤š<span class="symbol">&amp;gt;</span> <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--/s-frag--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ç¨æ˜¾å†—é•¿, é¦–å…ˆæ˜¯è·å¾— <code>soup</code>, ä¹Ÿå°±æ˜¯è§£æå¥½çš„æ–‡æ¡£å†…å®¹, ç„¶åæ˜¯åå¤çš„è°ƒç”¨æ ¸å¿ƒå‡½æ•° <code>find</code> å’Œ <code>find_all</code>.</p>
<p><code>bs4</code> çš„ç†å¿µæ˜¯, æ•´ä¸ªæ–‡æ¡£ <code>soup</code> ä¼šè¢«è§†ä½œä¸€ä¸ªæ–‡æ¡£æ ‘, ä¸”å…¶ä¸­çš„å­èŠ‚ç‚¹ä¹Ÿæ˜¯ç›¸åŒçš„å°æ–‡æ¡£æ ‘, å½¢æˆä¸€ä¸ªé€’å½’ç»“æ„. è€Œä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°åˆ™å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æ ‘ä¸­è¿›è¡Œéå†ä¸æŸ¥æ‰¾.</p>
<p>ä¸¤ä¸ªå‡½æ•°å‚æ•°ç›¸åŒ, è¯¦æƒ…å¯ä»¥æŸ¥é˜…ä½¿ç”¨æ–‡æ¡£, å”¯ä¸€ä¸åŒçš„åœ°æ–¹æ˜¯ <code>find</code> åªè·å–æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è€Œ <code>find_all</code> åˆ™ä¼šè·å–æ‰€æœ‰èŠ‚ç‚¹è¿”å›ä¸€ä¸ªåˆ—è¡¨. æˆ‘ä»¬ç»™æ‰€æœ‰çš„è°ƒç”¨éƒ½åŠ ä¸Šäº† <code>recursive=False</code>, è¿™æ ·å¯ä»¥ç¡®ä¿è®©æˆ‘ä»¬ä¸€å±‚ä¸€å±‚ä¾æ¬¡å¾€ä¸‹è€Œä¸æ˜¯é€’å½’è·å–å†…éƒ¨æ‰€æœ‰èŠ‚ç‚¹, æ¯ä¸€å±‚èŠ‚ç‚¹çš„åºå·å’Œæ–‡æ¡£å†…éƒ¨çš„å®é™…æƒ…å†µç›¸å¯¹åº”, å¯ä»¥è‡ªè¡Œå¯¹æ¯”çœ‹çœ‹æ¯ä¸€è¡Œæ˜¯æ€ä¹ˆæ¥çš„.</p>
<p><code>get_text</code> ç”¨æ¥è·å–å½“å‰èŠ‚ç‚¹å†…éƒ¨æ‰€æœ‰çš„æ–‡æœ¬å†…å®¹, åŠ ä¸Šå‚æ•°åå¯ä»¥å»é™¤é¦–å°¾çš„ç©ºç™½.</p>
<h3 id="æ¥ä¸‹æ¥å¹²ä»€ä¹ˆ"><a href="#æ¥ä¸‹æ¥å¹²ä»€ä¹ˆ" class="headerlink" title="æ¥ä¸‹æ¥å¹²ä»€ä¹ˆ"></a>æ¥ä¸‹æ¥å¹²ä»€ä¹ˆ</h3><p>è·å¾—æ•°æ®ä¹‹å, æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¿å­˜åˆ°æ–‡ä»¶è¿›è¡Œå­˜å‚¨.</p>
<p>ä½†æ˜¯æˆ‘ä»¬è·å–çš„ä¸œè¥¿éå¸¸æœ‰é™, ä»…ä»…åªæ˜¯ä¸€ä¸ªæ’è¡Œæ¦œ, ä¸è¿‡åœ¨è¿™äº›æ•°æ®é‡Œ, æœ‰ä¸€é¡¹æ˜¯è¯¦æƒ…é“¾æ¥, åç»­å¯ä»¥è¿›ä¸€æ­¥å¯¹è¯¦æƒ…é“¾æ¥çš„é¡µé¢è¿›è¡Œåˆ†æ, ä»è€Œå®ç°å¯¹è¯¦æƒ…é¡µé¢å†…å®¹çš„æŠ“å–, è®©çˆ¬è™«çˆ¬çš„æ›´è¿œä¸€ç‚¹.</p>
<h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><p>è¿™æ¬¡æ–‡ç« å†…å®¹å¾ˆç®€çŸ­, ä»…ä»…æ˜¯å®è·µäº†ä¸€ä¸‹æœ€åŸºæœ¬è¿‡ç¨‹, å¹¶ä¸”éšç€ç½‘ç«™æ•°æ®æ›´æ–°, é¡µé¢ç»“æ„éšæ—¶ä¼šå‘ç”Ÿå˜åŒ–, å› æ­¤è¿˜éœ€å¤šå¤šç»ƒä¹ .</p>
<p>æœ‰å¾ˆå¤šä¸çˆ¬è™«ç›¸å…³çš„å†…å®¹, å¯ä»¥æœç´¢ç›¸å…³çš„å…³é”®è¯è¿›è¡Œè¿›ä¸€æ­¥å­¦ä¹ , ä¸€å¹¶è´´åœ¨ä¸‹é¢äº†.</p>
<p><code>http åè®®</code>: è¿›ä¸€æ­¥äº†è§£è¯·æ±‚ä¸­çš„æ–¹æ³•å’Œå“åº”ä¸­çš„çŠ¶æ€ç çš„å«ä¹‰, æŒæ¡æ›´å¤šæµè§ˆå™¨ä¸æœåŠ¡å™¨äº¤äº’çš„ç»†èŠ‚è¿‡ç¨‹.</p>
<p><code>html æ–‡æ¡£ç»“æ„</code>: äº†è§£ç½‘é¡µçš„æ ‘å½¢ç»“æ„, å­¦ä¹  <code>html</code> è¯­æ³•.</p>
<p><code>æ­£åˆ™è¡¨è¾¾å¼</code>: é™¤äº†ä½¿ç”¨ <code>beautifulsoup4</code> è¿™æ ·çš„å·¥å…·ç»“æ„åŒ–å¤„ç†ç½‘é¡µ, ä¹Ÿå¯ä»¥æŒ‰è§„åˆ™ç›´æ¥æœç´¢ä½ æƒ³è¦çš„æ‰€æœ‰ç»“æœ.</p>
<p>ä¸€äº›åº“çš„å®˜æ–¹æ–‡æ¡£åœ°å€.</p>
<p><code>requests</code>: <span class="exturl" data-url="aHR0cHM6Ly9yZXF1ZXN0cy5yZWFkdGhlZG9jcy5pby8=">https://requests.readthedocs.io/<i class="fa fa-external-link-alt"></i></span></p>
<p><code>beautifulsoup4</code>: <span class="exturl" data-url="aHR0cHM6Ly93d3cuY3J1bW15LmNvbS9zb2Z0d2FyZS9CZWF1dGlmdWxTb3VwL2JzNC9kb2Mv">https://www.crummy.com/software/BeautifulSoup/bs4/doc/<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>å¿…å¤‡æŠ€èƒ½</category>
      </categories>
      <tags>
        <tag>çˆ¬è™«</tag>
        <tag>requests</tag>
      </tags>
  </entry>
  <entry>
    <title>ç»™æ–°ç”Ÿçš„ç¼–ç¨‹å·¥å…·æ¨èä¸åŸºæœ¬ä½¿ç”¨æ–¹æ³•</title>
    <url>//posts/2022/08/11/wast-vscandvs/</url>
    <content><![CDATA[<p>æ­¤å¸–é¢å‘å¤§ä¸€æ–°ç”Ÿåˆšå…¥é—¨çš„ç¼–ç¨‹å°ç™½, ä½œä¸ºç¼–ç¨‹å·¥å…·çš„å¸¸è§„æ¨è, å¤§ä½¬è¯·ç›´æ¥æ— è§†orz.</p>
<p>ä¸»è¦è®²è§£ä¸€ä¸‹ <code>Visual Studio Code</code> å’Œ <code>Visual Studio</code> çš„åŸºæœ¬ä½¿ç”¨.</p>
<span id="more"></span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„ç½‘ç»œç©ºé—´å®‰å…¨ä¸“ä¸šæœ¬ç§‘ç”Ÿ, å¹³å¸¸è¯¾ç¨‹ä½œä¸šä¸­æœ€å¸¸ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€åº”è¯¥å°±æ˜¯ <code>c</code> å’Œ <code>python</code>. (ä¿¡æ¯å®‰å…¨ä¸“ä¸šä¹Ÿå¯ä»¥å‚è€ƒ)</p>
<p><code>c</code> åº”è¯¥ä¼šä¼´éšä½ å››å¹´çš„æœ¬ç§‘ç”Ÿæ¶¯, å¹¶ä¸”å°†ä¼šæ˜¯å¤§éƒ¨åˆ†äººæ¥è§¦çš„ç¬¬ä¸€é—¨è¯­è¨€, å¤§ä¸€ä¹Ÿä¼šæœ‰ä¸€é—¨è¯¾å« &quot;Cè¯­è¨€ç¨‹åºè®¾è®¡&quot;, è¿™ä¸ªè¯¾åŒ…æ‹¬ç†è®ºè¯¾ä¸å®éªŒè¯¾ä¸¤ä¸ªè¯¾å¤´, ç›¸ä¿¡å¤§å®¶è¿˜æ˜¯ä¼šå­¦æœ‰æ‰€è·çš„.</p>
<p>è€Œ <code>python</code>, å°±æˆ‘è¿™ä¸€å±Šæ¥çœ‹, å¹¶æ²¡æœ‰å¼€è®¾å’Œ <code>python</code> ç›¸å…³çš„è¯­è¨€è¯¾ç¨‹, ä½†æ˜¯, ä»é€Ÿé€šç½‘å®‰çš„è§’åº¦æ¥è¯´, <code>python</code> æ˜¯éå¸¸æ¨èå­¦ä¸€ä¸‹çš„, æ¯•ç«Ÿæœ‰å¾ˆå¤šç°æˆçš„åº“, ç½‘ä¸Šçš„ç›¸å…³èµ„æºä¹Ÿéå¸¸ä¸°å¯Œ, åŒæ—¶å¾ˆé€‚åˆåšå„ç§è¯¾ç¨‹å¤§ä½œä¸š. <del>äººç”Ÿè‹¦çŸ­, æˆ‘å­¦python</del>.</p>
<p>æ‰€ä»¥å°±æˆ‘å››å¹´çš„æœ¬ç§‘ä½¿ç”¨ç»éªŒæ¥è¯´, <code>Visual Studio Code</code> å’Œ <code>Visual Studio</code> ç”¨æ¥å†™ä¸Šè¿°ä¸¤ç§è¯­è¨€çš„ä½“éªŒè¿˜æ˜¯éå¸¸èˆ’é€‚çš„, æ‰€ä»¥åœ¨æ­¤è¿›è¡Œæ¨èå’Œè½¯ä»¶çš„ä½¿ç”¨æ–¹æ³•å…¥é—¨.</p>
<h2 id="Visual-Studio-Code"><a href="#Visual-Studio-Code" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h2><p>é¦–å…ˆæ˜¯ <code>VS Code</code>. ä»æœ¬è´¨ä¸Šæ¥è¯´, <code>VS Code</code> æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„æ–‡æœ¬ç¼–è¾‘å™¨, ä¸ç®¡ä½ æ˜¯å¦éœ€è¦å†™ä»£ç , æˆ‘éƒ½å»ºè®®ä½ åœ¨ç”µè„‘ä¸Šè£…ä¸€ä¸ª, å¯ä»¥æå¤§çš„æé«˜ä½ çš„æ–‡æœ¬å¤„ç†æ•ˆç‡. <del>ççˆ±ç”Ÿå‘½, è¿œç¦»è®°äº‹æœ¬</del>.</p>
<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å®˜ç½‘åœ°å€æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly9jb2RlLnZpc3VhbHN0dWRpby5jb20v">https://code.visualstudio.com/<i class="fa fa-external-link-alt"></i></span>. è¿›å»ä¹‹åçš„ç•Œé¢ç°åœ¨é•¿è¿™æ ·.</p>
<p><img data-src="/static/image/wast-vscandvs/vGcccj.jpg" alt="vGcccj.jpg"></p>
<p>å¯ä»¥ç›´æ¥ç‚¹ Download ä¸‹è½½ç„¶åå¿«é€Ÿå®‰è£…, ä¸è¿‡æˆ‘ä¸æ˜¯é‚£ä¹ˆçš„æ¨è, å› ä¸ºç›´æ¥ç‚¹ä¸‹è½½çš„æ˜¯ User ç‰ˆæœ¬, å¯èƒ½ä¼šæœ‰å¥‡æ€ªçš„æƒé™é—®é¢˜. æ¨èä¸‹èƒ½å¤Ÿè·å–ç³»ç»Ÿæƒé™çš„ç‰ˆæœ¬æ¯”è¾ƒå¥½, å¹¶ä¸”å¯ä»¥å®‰è£…åœ¨ç³»ç»Ÿç›®å½•.</p>
<p>æ‰€ä»¥æŒ‰ä¸‹å›¾ç›´æ¥ç‚¹åˆ°å…¶ä»–ç‰ˆæœ¬çš„é€‰æ‹©é¡µé¢, é€‰ 64 bit System ç‰ˆæœ¬ä¸‹è½½.</p>
<p><img data-src="/static/image/wast-vscandvs/vGgPvd.png" alt="vGgPvd.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vGgNPU.png" alt="vGgNPU.png"></p>
<p>ä¸‹è½½å®Œä¹‹åç‚¹å‡»å®‰è£…, æ¥ä¸‹æ¥æä¸€ä¸‹å‡ ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„å®‰è£…é€‰é¡¹, å¯ä»¥æå¤§çš„æé«˜ä½ çš„ä½¿ç”¨ä½“éªŒ.</p>
<p><img data-src="/static/image/wast-vscandvs/vGRJ9U.png" alt="vGRJ9U.png"></p>
<p>è¿™ä¸ªç•Œé¢ä¸Šçš„é€‰é¡¹å»ºè®®å…¨å‹¾ä¸Š, ç¬¬ 2 ä¸ªå’Œç¬¬ 3 ä¸ªé€‰é¡¹å¯ä»¥åœ¨ä½ çš„å³é”®èœå•é‡Œæ·»åŠ  &quot;é€šè¿‡ Code æ‰“å¼€&quot; çš„é€‰é¡¹, è¿™æ ·å­ä½ å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç›´æ¥ä½¿ç”¨å³é”®ç‚¹å‡»æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹æˆ–è€…æ–‡ä»¶å¤¹çš„ç©ºç™½å¤„, ç„¶åæŠŠä»–ä»¬åœ¨ <code>VS Code</code> ä¸­æ‰“å¼€è¿›è¡Œæ“ä½œ.</p>
<p>ç¬¬ 5 ä¸ªé€‰é¡¹å¹³å¸¸ä¸ä¼šæ€ä¹ˆç”¨åˆ°, ä½†æ˜¯ä¿æŒé»˜è®¤é€‰é¡¹å‹¾ä¸Šå°±å¯ä»¥äº†, å®ƒå¯ä»¥è®©ä½ åœ¨å‘½ä»¤è¡Œä¸­ç”¨ <code>Code</code> è¿›è¡Œæ“ä½œ</p>
<p>ä¸€è·¯ä¸‹ä¸€æ­¥, ç„¶åå°±å®‰è£…å®Œæˆ, ä¹‹åå¯ä»¥é€‰æ‹©é‡å¯ä¸€ä¸‹ç”µè„‘è®©ä¸€äº›é…ç½®ç«‹å³ç”Ÿæ•ˆ, ä¸è¿‡ä¸é‡å¯ä¹Ÿæ²¡å…³ç³», æ²¡å•¥å½±å“.</p>
<h3 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><p>é¦–å…ˆè¯´è¯´å¹³å¸¸å†™ä»£ç æ—¶å€™, ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯è‡³å°‘ä»¥ä¸€ä¸ªæ–‡ä»¶å¤¹ä½œä¸ºæœ€å°å•ä½æ¥æ“ä½œ (é™¤éçœŸçš„æ˜¯éå¸¸ä¸´æ—¶çš„ä¸€ä»½å°è„šæœ¬, å¦åˆ™éƒ½æ¨èå¼„ä¸ªæ–‡ä»¶å¤¹èˆ’æœ, é‡Œé¢ä¸ä»…æ”¾ä»£ç åŒæ—¶ä¹Ÿæ”¾ä»£ç è¦å¼•ç”¨å’Œç”Ÿæˆçš„å…¶ä»–æ–‡ä»¶).</p>
<p>è¿™ä¸ªæ–‡ä»¶å¤¹å°±æ˜¯ä½ çš„é¡¹ç›®æ–‡ä»¶å¤¹, ä¸€ä¸ª Project, ä¹‹åä¼šåœ¨è¿™ä¸ªåŸºç¡€ä¸Šå¼€å±•ä½ åç»­çš„ Coding å·¥ä½œ.</p>
<p>æ‰€ä»¥åŸºæœ¬ä¸Šä½ è¦å†™ç‚¹å•¥è¯¾ç¨‹å¤§ä½œä¸šä»£ç çš„æ—¶å€™, ç¬¬ä¸€æ­¥å°±æ˜¯æ‰¾ä¸ªåœ°æ–¹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹, ç„¶åç”¨ Code æ‰“å¼€. è¿™é‡Œç”¨ä¸€ä¸ªå« &quot;example&quot; çš„æ–‡ä»¶å¤¹ä½œä¸ºç¤ºä¾‹, è®²è§£ä¸€ä¸‹ <code>VS Code</code> çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•.</p>
<h4 id="æ’ä»¶å®‰è£…"><a href="#æ’ä»¶å®‰è£…" class="headerlink" title="æ’ä»¶å®‰è£…"></a>æ’ä»¶å®‰è£…</h4><p>ä¸ç®¡ä½ æ˜¯ç”¨é€šè¿‡å³é”®æ‰“å¼€çš„é¡¹ç›®æ–‡ä»¶å¤¹è¿˜æ˜¯ä» &quot;æ–‡ä»¶&quot; èœå•æ æ‰“å¼€çš„, ä¹‹åçš„ç•Œé¢éƒ½åº”è¯¥å’Œä¸‹é¢çš„å›¾é•¿å¾—å·®ä¸å¤š, ä¸€ç‰‡ç©ºç™½.</p>
<p><img data-src="/static/image/wast-vscandvs/vJ85wR.png" alt="vJ85wR.png"></p>
<p>ç„¶åæˆ‘ä»¬é€‰åˆ°å·¦è¾¹çš„é•¿å¾—åƒæ–¹å—çš„å›¾æ ‡, ä¹Ÿå°±æ˜¯æ‰©å±•, å¼€å§‹æŒ‰ç…§å·¥ä½œéœ€æ±‚è‡ªå®šä¹‰æˆ‘ä»¬çš„ <code>VS Code</code>.</p>
<p><img data-src="/static/image/wast-vscandvs/vJGk6g.png" alt="vJGk6g.png"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå·²ç»æœ‰ä¸€ä¸ªæ‰©å±•äº†, è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸‹è½½ <code>VS Code</code> å‡ ä¹å¿…è£…çš„ä¸€ä¸ªæ‰©å±•, ä¸­æ–‡æ±‰åŒ–æ‰©å±•, å¦‚æœæ²¡æœ‰é¢„è£…, åˆ™ç›´æ¥æœç´¢å¯¹åº”çš„æ‰©å±•åå­—è£…ä¸Šå°±å¯ä»¥äº†. <del>è‹±è¯­å¤§ä½¬è¯·æ— è§†ä¸­æ–‡æ‰©å±•</del>.</p>
<p>è£…å®Œä¼šæç¤ºé‡æ–°å¯åŠ¨ <code>VS Code</code> åŠ è½½, ä¹‹åçš„ç•Œé¢å°±ä¼šåƒæˆ‘å›¾é‡Œé‚£æ ·å…¨ä¸­æ–‡äº†.</p>
<p>ç„¶åæ˜¯ç¼–ç¨‹è¯­è¨€æ‰©å±•, è¿™ä¹Ÿæ˜¯æœ€åŸºæœ¬çš„ä¸œè¥¿, éœ€è¦ç”¨ <code>VS Code</code> å†™ä»€ä¹ˆè¯­è¨€çš„ä»£ç å°±è£…ä»€ä¹ˆè¯­è¨€çš„æ‰©å±•, ä¸€èˆ¬ç›´æ¥è£… Microsoft å®˜æ–¹çš„æˆ–è€… Star æœ€å¤šçš„å°±è¡Œ.</p>
<p>ç”±äº <code>VS Code</code> ä¹‹ååŸºæœ¬ä¸Šç”¨æ¥å†™ <code>python</code>, å› æ­¤è¿™é‡ŒæŠŠ <code>python</code> æ‰©å±•å…ˆè£…ä¸Š, æ—¥åæœ‰éœ€æ±‚å¯ä»¥è‡ªè¡Œä¸¾ä¸€åä¸‰.</p>
<p><img data-src="/static/image/wast-vscandvs/vJGj3T.png" alt="vJGj3T.png"></p>
<p>å®‰è£…å®Œæˆä¹‹åå¯èƒ½ä¼šå¼¹å‡ºæ¥ä¸€äº› Get Start é¡µé¢, ä¸ç”¨ç®¡, ä¸è¿‡æœ‰æ—¶é—´çš„è¯å¯ä»¥ç¨å¾®ç¿»ä¸€ç¿», ä¹Ÿæ˜¯ä¸€äº›æ–°æ‰‹æ•™ç¨‹.</p>
<h4 id="ç¬¬ä¸€ä»½ä»£ç "><a href="#ç¬¬ä¸€ä»½ä»£ç " class="headerlink" title="ç¬¬ä¸€ä»½ä»£ç "></a>ç¬¬ä¸€ä»½ä»£ç </h4><p><img data-src="/static/image/wast-vscandvs/vJJhI1.png" alt="vJJhI1.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sub</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a - b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mul</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a * b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">div</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a / b</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    num1 = add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    num2 = mul(num1, <span class="number">7</span>)</span><br><span class="line">    num3 = sub(num2, num1)</span><br><span class="line">    num4 = div(num3, num1)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Result: <span class="subst">&#123;num4&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ–°å»ºä¸€ä»½æ–‡ä»¶, ç„¶åéšä¾¿æ•²ä¸€ç‚¹ä¸œè¥¿ä¹‹å, å¾—åˆ°äº†ç°åœ¨çš„ <code>main.py</code> æ–‡ä»¶. ä¸‹é¢è¯´è¯´å¯¹è¿™ä»½æ–‡ä»¶æœ€ç®€å•çš„è¿è¡Œå’Œè°ƒè¯•.</p>
<h5 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h5><p>æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è¿è¡Œ, è¿™é‡Œåªè¯´ä¸¤ç§æœ€ç®€å•çš„, ä¸€æ˜¯é é¼ æ ‡æˆ–è€…å¿«æ·é”®, äºŒæ˜¯åœ¨å‘½ä»¤è¡Œé‡Œæ•²å‘½ä»¤.</p>
<p><img data-src="/static/image/wast-vscandvs/vJYkZj.png" alt="vJYkZj.png"></p>
<p>å›¾å†…å¯ä»¥çœ‹åˆ°èœå•æ æœ‰ä¸ªè¿è¡Œé€‰é¡¹, ç‚¹å¼€å°±æ˜¯ä¸¤ä¸ª, ä¸€ä¸ªå« &quot;å¯åŠ¨è°ƒè¯•&quot; (<code>F5</code>), å¦ä¸€ä¸ªæ˜¯ &quot;ä»¥éè°ƒè¯•æ¨¡å¼è¿è¡Œ&quot; (<code>Ctrl + F5</code>).</p>
<p>å‰è€…æ˜¯è°ƒè¯•, åè€…æ˜¯å•çº¯çš„è¿è¡Œ, å¯¹äºæˆ‘ä»¬æ¥è¯´, åªéœ€è¦ç‚¹å‡»åè€…, æˆ–è€…ç›´æ¥å¿«æ·é”® <code>Ctrl + F5</code>, å°±å¯ä»¥çœ‹åˆ°è¿è¡Œæ•ˆæœäº†.</p>
<p><img data-src="/static/image/wast-vscandvs/vJY3w9.png" alt="vJY3w9.png"></p>
<p>è‡ªåŠ¨å¼¹å‡ºäº†ä¸€ä¸ªç»ˆç«¯, å¹¶ä¸”æˆåŠŸçš„æ‰“å°å‡ºäº†æˆ‘ä»¬çš„ç»“æœ. åˆ°è¿™é‡Œç¬¬ä¸€ç§æ–¹æ³•å°±ç»“æŸäº†, æ›´å¤šç»†è‡´çš„åŠŸèƒ½æ—¥åå†æ…¢æ…¢æ¢ç´¢å§.</p>
<p>ç„¶åæ˜¯ç¬¬äºŒç§æ–¹å¼, è‡ªå·±åœ¨å‘½ä»¤è¡Œé‡Œæ•²å‘½ä»¤, é‚£ä¹ˆé¦–å…ˆéœ€è¦çŸ¥é“æ€ä¹ˆæŠŠç»ˆç«¯è°ƒç”¨å‡ºæ¥.</p>
<p><img data-src="/static/image/wast-vscandvs/vJYBeH.png" alt="vJYBeH.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vJYyFI.png" alt="vJYyFI.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vJY4mQ.png" alt="vJY4mQ.png"></p>
<p>å¦‚ä¸Šå›¾æ–°å»ºä¸€ä¸ªç»ˆç«¯, ç„¶åæ•²å…¥æŒ‡ä»¤ <code>python main.py</code>, åŒæ ·è¾“å‡ºäº†æˆ‘ä»¬çš„è¿è¡Œç»“æœ. å¯ä»¥çœ‹åˆ°, æ–°å»ºçš„ç»ˆç«¯ä¼šè‡ªåŠ¨æ‰“å¼€åˆ°æˆ‘ä»¬çš„é¡¹ç›®æ–‡ä»¶å¤¹ç›®å½•, æ‰€ä»¥å¯ä»¥ç›´æ¥è®¿é—®åˆ°é‡Œé¢çš„å†…å®¹, è€Œæˆ‘ä»¬çš„æ‰€æœ‰å‘½ä»¤, ä¹Ÿéƒ½æ˜¯åŸºäºé¡¹ç›®æ–‡ä»¶å¤¹ä½œä¸ºæ ¹ç›®å½•æ¥è¿è¡Œçš„. (è¿™ä¸€ç‚¹å¾ˆé‡è¦, å¦‚æœå‘½ä»¤è¡Œçš„å·¥ä½œç›®å½•å’Œé¡¹ç›®æ–‡ä»¶å¤¹ä¸ä¸€è‡´, å¯ä»¥è‡ªå·±æ‰‹åŠ¨ <code>cd</code> åˆ‡æ¢ä¸€ä¸‹, å¯ä»¥å…å»å†™ä»£ç æ—¶å¸¦æ¥çš„ä¸€äº›è·¯å¾„é—®é¢˜)</p>
<h5 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h5><p>è¿™é‡Œç®€å•çš„è°ƒè¯•ä¸€ä¸‹è¿™ä»½æ–‡ä»¶, æ‰“ä¸€ä¸‹æ–­ç‚¹, æŸ¥çœ‹ä¸€ä¸‹è¿è¡Œä¸­å˜é‡.</p>
<p>æ‰€è°“æ–­ç‚¹, å°±æ˜¯ä½ åœ¨è°ƒè¯•çš„æ—¶å€™éœ€è¦è®©ç¨‹åºåœåœ¨å“ªä¸ªç‚¹, ä»è€Œåœ¨æŸä¸ªç‚¹å¯ä»¥æŸ¥çœ‹ç¨‹åºçš„è¿è¡Œæƒ…å†µ, å¿«é€Ÿå®šä½é—®é¢˜æ¥æº.</p>
<p>æ‰“ä¸Šæ–­ç‚¹çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•, æ¯”å¦‚åœ¨ç¬¬ 15 è¡Œåœä¸‹, é‚£ä¹ˆåªéœ€è¦åœ¨è¡Œå·å·¦è¾¹ç‚¹ä¸€ä¸‹å°±å¯ä»¥äº†, è¿™æ ·å­å½“ç¨‹åºè¿è¡Œåˆ°ç¬¬ 15 è¡Œçš„æ—¶å€™, ä¼šåœä¸‹, ä¸”ç¬¬ 15 è¡Œ<strong>ä¸ä¼šæ‰§è¡Œ</strong>, æ˜¯å³å°†è¦æ‰§è¡Œçš„è¯­å¥.</p>
<p><img data-src="/static/image/wast-vscandvs/vJtKht.png" alt="vJtKht.png"></p>
<p>ç„¶å, ä»è¿è¡Œèœå•é‡Œé€‰æ‹© &quot;è¿›è¡Œè°ƒè¯•&quot; æˆ–è€…å¿«æ·é”® <code>F5</code>, ä¼šå¼¹å‡ºæç¤ºè®©ä½ é€‰æ‹©è¦ä½¿ç”¨çš„è°ƒè¯•é…ç½® (å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç»™è¿™ä¸ªé¡¹ç›®è®¾å®šè‡ªå·±çš„è°ƒè¯•é…ç½®, æ‰€ä»¥éœ€è¦é€‰æ‹©ä¸€ç§ç³»ç»Ÿæä¾›çš„é»˜è®¤è°ƒè¯•é…ç½®), è¿™é‡Œç›´æ¥é€‰ç¬¬ä¸€ä¸ªå°±è¡Œäº†.</p>
<p><img data-src="/static/image/wast-vscandvs/vJtyB4.png" alt="vJtyB4.png"></p>
<p>ä¸å‡ºæ„å¤–çš„è¯, ç¨‹åºä¼šç¨³ç¨³çš„åœåœ¨ç¬¬ 15 è¡Œ, å¹¶ä¸”å·¦è¾¹è·³è½¬åˆ°äº†è°ƒè¯•é¢æ¿, æ˜¾ç¤ºäº†å„ç§è°ƒè¯•ä¿¡æ¯.</p>
<p><img data-src="/static/image/wast-vscandvs/vJtouD.png" alt="vJtouD.png"></p>
<ul>
<li>å˜é‡: æ˜¾ç¤ºäº†å„ç§å±€éƒ¨æˆ–è€…å…¨å±€çš„å˜é‡å€¼.</li>
<li>ç›‘è§†: å¯ä»¥æ‰‹åŠ¨è¾“å…¥ä¸€äº›å˜é‡æˆ–è€…è¡¨è¾¾å¼æ¥è¿›è¡Œå•ç‹¬è§‚å¯Ÿ.</li>
<li>è°ƒç”¨å †æ ˆ: æ˜¾ç¤ºäº†å‡½æ•°ä¹‹é—´çš„åµŒå¥—è°ƒç”¨å…³ç³».</li>
<li>æ–­ç‚¹: æ˜¾ç¤ºå½“å‰æ‰€æœ‰çš„æ–­ç‚¹ä¿¡æ¯, æœ‰ä¸‰ç§å›ºæœ‰æ–­ç‚¹, å’Œç¨‹åºçš„æŠ¥é”™æœ‰å…³.</li>
</ul>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°, å·¦è¾¹å˜é‡é‡Œ, æ˜¾ç¤ºäº†ä¸€ä¸ªå±€éƒ¨å˜é‡ <code>num1</code> ç­‰äº 5, è¿™å’Œæˆ‘ä»¬çš„é¢„æœŸæ˜¯ä¸€è‡´çš„, å¹¶ä¸”ç¬¬ 15 è¡Œå°šæœªæ‰§è¡Œ, æ‰€ä»¥è¿˜æ²¡æœ‰ <code>num2</code> è¿™ä¸ªå˜é‡.</p>
<p>ç„¶åæ˜¯è°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥ä½¿ç”¨çš„åŸºæœ¬æ“ä½œ, å¯ä»¥çœ‹åˆ°ä¸Šæ–¹å¤šå‡ºæ¥ä¸€ä¸ªæ¡, æœ‰å„ç§è°ƒè¯•æŒ‰é’®.</p>
<div class="note info"><p>ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­, å¯èƒ½ä¼šé‡åˆ°å‡½æ•°è°ƒç”¨, å¦‚æœæˆ‘ä»¬éœ€è¦è¿›å…¥è¿™ä¸ªå‡½æ•°è¿›è¡Œè°ƒè¯•, æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„å†…éƒ¨æƒ…å†µ, åˆ™éœ€è¦ä½¿ç”¨ &quot;å•æ­¥è°ƒè¯•&quot;, å³ä¸€æ­¥ä¸€æ­¥æ‰§è¡Œ, è¿›å…¥å‡½æ•°å†…éƒ¨.</p>
<p>è€Œå½“ä½ åœ¨å½“å‰å‡½æ•°å†…éƒ¨æŸ¥çœ‹å®Œæƒ…å†µä¹‹å, å¯èƒ½å‡½æ•°è¿˜å‰©å¾ˆå¤šæ²¡æ‰§è¡Œå®Œ, è¿™ä¸ªä¹‹åéœ€è¦ä½¿ç”¨ &quot;å•æ­¥è·³å‡º&quot;, ç›´æ¥å¿«è¿›åˆ°æŠŠå½“å‰å‡½æ•°æ‰§è¡Œå®Œæˆ.</p>
<p>æœ‰çš„æ—¶å€™ä½ å®Œå…¨ä¸æƒ³è¿›å…¥æŸä¸ªå‡½æ•°, æƒ³ç›´æ¥æ‰§è¡Œä¸€æ•´è¡Œ, è¿™ç§æ—¶å€™å¯ä»¥ä½¿ç”¨ &quot;å•æ­¥è·³è¿‡&quot;.</p>
<p>æœ€å, å¦‚æœä½ è¿™ä¸€ç‰‡ä»£ç å·²ç»è°ƒè¯•å®Œæˆ, éœ€è¦ç›´æ¥å¿«è¿›åˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹, ä½¿ç”¨ &quot;ç»§ç»­&quot; åˆ™ä¼šå°†ç¨‹åºç»§ç»­æ‰§è¡Œ, ç›´åˆ°å†æ¬¡é‡è§æ–­ç‚¹åˆ™åœä¸‹, æˆ–è€…ç›´æ¥æ‰§è¡Œåˆ°ç¨‹åºç»“æŸ.</p>
</div>

<p>è¿™äº›è°ƒè¯•æŒ‰é’®é…åˆå·¦ä¾§é¢æ¿çš„è°ƒè¯•ä¿¡æ¯, å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“ç¨‹åºçš„æ‰§è¡Œæ­¥éª¤ä»¥åŠæ¯ä¸€æ­¥çš„å˜åŒ–æƒ…å†µ, æ˜¯è§£å†³ä»£ç  bug çš„åˆ©å™¨, é—²æš‡æ—¶é—´å¯ä»¥å¤šå°è¯•å‡ æ¬¡, ç†Ÿæ‚‰è°ƒè¯•è¿‡ç¨‹å’Œæ“ä½œ.</p>
<h2 id="Visual-Studio"><a href="#Visual-Studio" class="headerlink" title="Visual Studio"></a>Visual Studio</h2><p>ç¬¬äºŒä¸ªæ¨èçš„ç¼–ç¨‹å·¥å…·æ˜¯ <code>VS</code>, ç›¸æ¯”äº <code>VS Code</code>, <code>VS</code> æ›´åŠ è‡ƒè‚¿ä½†æ˜¯åŠŸèƒ½æ›´åŠ å¼ºå¤§, å¦‚æœç”¨ä¹ æƒ¯äº†, åœ¨ Windows å¹³å°ä¸Šå†™ <code>c</code> è¯­è¨€ä¹‹ç±»çš„è¯¾ç¨‹ä½œä¸š,  å°†ä¼šæ˜¯æ— æ¯”èˆ’é€‚.</p>
<h3 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p><code>VS</code> çš„å®‰è£…åˆ†æˆä¸¤æ­¥, é¦–å…ˆæ˜¯å®‰è£…å®ƒä¸“å±çš„ Installer, ç„¶åå†å†³å®šå®‰è£…å…·ä½“çš„ <code>VS</code> å†…å®¹.</p>
<p>å®˜æ–¹ç½‘ç«™æ˜¯ <span class="exturl" data-url="aHR0cHM6Ly92aXN1YWxzdHVkaW8ubWljcm9zb2Z0LmNvbS8=">https://visualstudio.microsoft.com/<i class="fa fa-external-link-alt"></i></span>, ç›®å‰æ˜¯ 2022 çš„æœ€æ–°ç‰ˆæœ¬, ä¸‹çš„æ—¶å€™é€‰æ‹© Community ç‰ˆæœ¬ä¸‹è½½, è¿™ä¸ªç‰ˆæœ¬æ˜¯<strong>é¢å‘ä¸ªäººå…è´¹ä½¿ç”¨</strong>çš„, åªéœ€è¦æ³¨å†Œå¾®è½¯çš„è´¦æˆ·å°±å¯ä»¥æˆæƒç»™ä¸ªäººäº†.</p>
<p><img data-src="/static/image/wast-vscandvs/vJ5QCq.png" alt="vJ5QCq.png"></p>
<p>è¿™ä¸ªä¸œè¥¿ä¸‹å®Œä¹‹åæ˜¯ VS çš„ Installer, ç›´æ¥æ— è„‘è£…å¥½ç„¶åè¿è¡Œ, ä¼šè¿›å…¥å¦‚ä¸‹çš„é€‰æ‹©ç•Œé¢. (æ‰¾ä¸åˆ°å°±å»å¼€å§‹èœå•é‡Œç¿», å®ƒæ˜¯ä¸ä¼šæœ‰æ¡Œé¢å¿«æ·æ–¹å¼çš„)</p>
<p><img data-src="/static/image/wast-vscandvs/vJI6S0.png" alt="vJI6S0.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vJIfw4.png" alt="vJIfw4.png"></p>
<p>é»˜è®¤ä¼šç›´æ¥è¿›åˆ°ç¬¬äºŒå¼ å›¾, å¦‚æœä¸æ˜¯çš„è¯æŒ‰ç¬¬ä¸€å¼ å›¾è‡ªå·±é€‰å®‰è£….</p>
<p>å¯¹äºæˆ‘ä»¬æ—¥å¸¸å†™å†™ä½œä¸šæ¥è¯´, æˆ‘ä»¬åªéœ€è¦èƒ½å¤Ÿå†™ <code>c</code> è¯­è¨€å°±å¤Ÿäº†, æ‰€ä»¥åªéœ€å‹¾é€‰ä¸‹é¢å…¶ä¸­çš„ä¸€ä¸ªå°±å®Œå…¨è¶³å¤Ÿä½¿ç”¨äº†, é‚£å°±æ˜¯ &quot;ä½¿ç”¨ C++ çš„æ¡Œé¢å¼€å‘&quot;. è™½ç„¶å†™çš„æ˜¯ <code>c++</code>, ä½†æ˜¯å…¶å®å†™ <code>c</code> ä¹Ÿæ˜¯ç”¨è¿™ä¸ªå†™çš„, åªè¦ä½ åˆ›å»ºæºæ–‡ä»¶çš„æ—¶å€™, åç¼€åè‡ªå·±æ”¹æˆ <code>.c</code> è€Œä¸æ˜¯ <code>.cpp</code>, è¿™æ ·å­ç¼–è¯‘çš„æ—¶å€™å°±ä¼šæ¢æˆ <code>c</code> çš„ç¼–è¯‘æ–¹å¼.</p>
<p><img data-src="/static/image/wast-vscandvs/vJIqOO.png" alt="vJIqOO.png"></p>
<p>è¿™ä¸€å¨å­ä¸œè¥¿è£…ä¸‹æ¥è¿˜æ˜¯è¦ä¸€ç‚¹ç©ºé—´å’Œæ—¶é—´çš„, æ¨èç”µè„‘æœ‰ç©ºé—²æ—¶é—´çš„æ—¶å€™æ…¢æ…¢æŒ‚æœºå®‰è£…, å®‰è£…å®Œä¹‹åé‡å¯ä¸€ä¸‹ç”µè„‘, è®©ä¸€äº›ç³»ç»Ÿé¡¹ç”Ÿæ•ˆ.</p>
<h3 id="åŸºæœ¬ä½¿ç”¨-1"><a href="#åŸºæœ¬ä½¿ç”¨-1" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><p>æ‰“å¼€è£…å¥½çš„ <code>VS</code>, æˆ‘ä»¬å¼€å§‹ç”¨ <code>c</code> å†™ä¸€ä¸ª Hello World ç¨‹åº<del>ç¨‹åºå‘˜ç»•ä¸è¿‡å»çš„æ–°æ‰‹ä»£ç </del>.</p>
<p>é¦–å…ˆä¼šè·³å‡ºæ¥è¿™ä¸ªç•Œé¢, æˆ‘ä»¬ç›´æ¥é€‰æ‹©åˆ›å»ºæ–°é¡¹ç›®.</p>
<p><img data-src="/static/image/wast-vscandvs/vJOeqP.png" alt="vJOeqP.png"></p>
<p>ç„¶åæ˜¯é€‰æ‹©é¡¹ç›®æ¨¡æ¿, æ¨¡æ¿ç±»å‹æœ‰å¾ˆå¤š, ä½†æ˜¯æˆ‘ä»¬é€‰æ‹©æœ€ç®€å•çš„ &quot;ç©ºé¡¹ç›®&quot;, è¿™æ ·å­å¯ä»¥åç»­è‡ªå·±æ‰‹åŠ¨åˆ›å»ºæ–‡ä»¶, äº†è§£ä¸€ä¸‹å…·ä½“çš„é¡¹ç›®ç»“æ„.</p>
<p>ç„¶åæ˜¯è®¾ç½®åç§°. è¿™é‡Œæœ‰ä¸¤ä¸ªå†…å®¹å¯ä»¥è‡ªå®šä¹‰, ä¸€ä¸ªæ˜¯é¡¹ç›®åç§°, ä¸€ä¸ªæ˜¯è§£å†³æ–¹æ¡ˆåç§°.</p>
<p>åœ¨ <code>VS</code> é‡Œé¢åˆ›å»ºé¡¹ç›®æ—¶, é¡¶å±‚ç»“æ„ä¸æ˜¯ &quot;é¡¹ç›®&quot; è€Œæ˜¯ &quot;è§£å†³æ–¹æ¡ˆ&quot;, è¿™æ˜¯ä¸ <code>VS Code</code> ä¸åŒçš„ä¸€ç‚¹. ä¸€ä¸ª &quot;è§£å†³æ–¹æ¡ˆ&quot; æ˜¯ä¸€ä¸ªæ›´å¤§çš„å®¹å™¨, é‡Œé¢å¯ä»¥åŒ…å«å¾ˆå¤šçš„ &quot;é¡¹ç›®&quot;, ç„¶åæ¯ä¸€ä¸ª &quot;é¡¹ç›®&quot; æ˜¯ä¸€ä¸ªä¸ªå•ç‹¬çš„å†…å®¹, ç”¨ä¸åŒçš„æ–‡ä»¶å¤¹åˆ†é—¨åˆ«ç±»çš„åŒºåˆ†å¼€æ¥.</p>
<p>è¿™æ ·å­çš„å¥½å¤„å°±æ˜¯, é€‚åº”æ€§èŒƒå›´æ›´å¹¿, èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„åšå¤šä¸ªé¡¹ç›®ä¹‹é—´çš„äº’ç›¸è°ƒç”¨, æ¯”å¦‚ä½ å¯ä»¥ä¸€ä¸ªé¡¹ç›®ç”¨æ¥å†™æµ‹è¯•, å¦ä¸€ä¸ªé¡¹ç›®æ˜¯ä½ å®é™…ä¸Šè¦å†™çš„ä»£ç åº“.</p>
<p>è¿™é‡Œæˆ‘ä»¬æŠŠ &quot;è§£å†³æ–¹æ¡ˆ&quot; çš„åç§°è®¾ä¸º &quot;example&quot;, æŠŠé¡¹ç›®åç§°è®¾ç½®ä¸º &quot;c_project&quot;. è¿™æ ·å­å®é™…çš„ç‰©ç†ç»“æ„å°±ä¼šæ˜¯ä¸€ä¸ª <code>example</code> çš„æ€»æ–‡ä»¶å¤¹ä¸‹é¢è¿˜æœ‰ä¸€ä¸ª <code>c_project</code> çš„é¡¹ç›®æ–‡ä»¶å¤¹.</p>
<p><img data-src="/static/image/wast-vscandvs/vJXf00.png" alt="vJXf00.png"></p>
<p>åˆ›å»ºå¥½ä¹‹åå¤§æ¦‚é•¿ä¸‹å›¾æ‰€ç¤º, è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä½ç½®å¯ä»¥è‡ªå·±è°ƒ, æˆ‘è°ƒå·¦è¾¹å»äº†, è§†å›¾èœå•é‡Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æ˜¾ç¤ºå‡ºæ¥.</p>
<p><img data-src="/static/image/wast-vscandvs/vJXztO.png" alt="vJXztO.png"></p>
<h4 id="è®¤è¯†è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨"><a href="#è®¤è¯†è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨" class="headerlink" title="è®¤è¯†è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨"></a>è®¤è¯†è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨</h4><p><code>VS</code> é‡Œé¢çš„è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨æ˜¯ä¸€ä¸ªé›†åˆäº†éå¸¸å¤šåŠŸèƒ½çš„ç®¡ç†å™¨, éœ€è¦ç†Ÿæ‚‰ä¸€ä¸‹å®ƒæä¾›ç»™æˆ‘ä»¬çš„åŸºæœ¬åŠŸèƒ½.</p>
<p>ç®¡ç†å™¨çš„é¡¶å±‚æ˜¯è§£å†³æ–¹æ¡ˆ, ä¹Ÿå°±æ˜¯åˆšåˆšæˆ‘ä»¬å‘½åçš„ <code>example</code> æ–‡ä»¶å¤¹, ç„¶ååˆ—å‡ºæ¥äº†é‡Œé¢åŒ…å«çš„æ‰€æœ‰é¡¹ç›®, ç›®å‰åªæœ‰ä¸€ä¸ªé¡¹ç›®, å°±æ˜¯ä¸€èµ·åˆ›å»ºçš„ <code>c_project</code>.</p>
<p>ç›®å‰çœ‹åˆ°çš„è¿™ä¸ªè§†å›¾æ˜¯ &quot;è§£å†³æ–¹æ¡ˆè§†å›¾&quot;, æ˜¯è§£å†³æ–¹æ¡ˆå†…çš„<strong>é€»è¾‘ç»“æ„</strong>è€Œä¸æ˜¯åœ¨ç£ç›˜ä¸Šçš„<strong>ç‰©ç†ç»“æ„</strong>.</p>
<p>é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆå°è¯•åˆ›å»ºä¸€ä»½ <code>main.c</code>, å¹¶å†™å‡ å¥ä»£ç .</p>
<p>å³é”® &quot;æºæ–‡ä»¶&quot;, é€‰æ‹© &quot;æ·»åŠ &quot;, ç„¶åé€‰æ‹© &quot;æ–°å»ºé¡¹&quot;, é€‰æ‹©æºæ–‡ä»¶, åŒæ—¶æŠŠæ–‡ä»¶åè®¾ä¸º <code>main.c</code>. ç„¶åé”®å…¥ç»å…¸çš„ Hello world ç¨‹åºä»£ç .</p>
<p><img data-src="/static/image/wast-vscandvs/vJjO2Q.png" alt="vJjO2Q.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vJviPU.png" alt="vJviPU.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vJvKIK.png" alt="vJvKIK.png"></p>
<p>å¯ä»¥çœ‹åˆ°å·¦ä¾§å·²ç»æˆåŠŸçš„åœ¨æºæ–‡ä»¶é¡¹ä¸‹é¢å¤šå‡ºæ¥äº†ä¸€ä»½ <code>main.c</code>. ä½†æ˜¯åˆšåˆšè¯´äº†ç›®å‰çš„ç•Œé¢æ˜¯è§£å†³æ–¹æ¡ˆçš„ &quot;é€»è¾‘ç»“æ„&quot;, æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ‡æ¢ä¸€ä¸‹è§†å›¾, çœ‹çœ‹åˆšåˆšåˆ›å»ºçš„æ–‡ä»¶ç©¶ç«Ÿåœ¨å“ª.</p>
<p><img data-src="/static/image/wast-vscandvs/vJv6Ln.png" alt="vJv6Ln.png"></p>
<p>ç®¡ç†å™¨çš„ä¸Šæ–¹æœ‰ä¸€ä¸ªåˆ‡æ¢è§†å›¾æŒ‰é’®, ç‚¹å‡»ä¹‹åå¯ä»¥é€‰æ‹©æ˜¯ &quot;è§£å†³æ–¹æ¡ˆ&quot; è¿˜æ˜¯ &quot;æ–‡ä»¶å¤¹è§†å›¾&quot;, æˆ‘ä»¬ç›´æ¥æ¢åˆ°æ–‡ä»¶å¤¹è§†å›¾.</p>
<p><img data-src="/static/image/wast-vscandvs/vJv4WF.png" alt="vJv4WF.png"></p>
<p>è¿™ä¸ªæ—¶å€™å°±éå¸¸æ¸…æ™°äº†, é¡¶å±‚æ–‡ä»¶å¤¹ <code>example</code>, æ¬¡çº§é¡¹ç›®æ–‡ä»¶å¤¹ <code>c_project</code>, ç„¶ååœ¨é¡¹ç›®æ–‡ä»¶å¤¹å†…æœ‰ä¸€ä»½ <code>main.c</code>.</p>
<p>åˆ‡å›è§£å†³æ–¹æ¡ˆè§†å›¾, ç°åœ¨å†çœ‹ &quot;æºæ–‡ä»¶&quot; è¿™ä¸€é¡¹, å®ƒå…¶å®åªæ˜¯äººä¸ºè®¾ç½®çš„ä¸€ä¸ªåˆ†ç±»ç»“æ„, åœ¨ <code>VS</code> é‡Œå« &quot;ç­›é€‰å™¨&quot;, å¯ä»¥åœ¨ä¸å½±å“ç‰©ç†ç»“æ„æ–‡ä»¶å®é™…è·¯å¾„çš„åŒæ—¶ç»™å¼€å‘äººå‘˜ä¸€ä¸ªåˆé€‚çš„æ–‡ä»¶åˆ†ç±»æ–¹æ³•, å¯ä»¥å³é”®æ–°å»ºé‡Œæ·»åŠ æ–°çš„è‡ªå®šä¹‰ç­›é€‰å™¨.</p>
<h4 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h4><p>æ—¢ç„¶æ˜¯å†™ <code>c</code> è¯­è¨€, è¿è¡Œå‰å¿…ä¸å¯å°‘çš„æ­¥éª¤å°±æ˜¯ç¼–è¯‘, é‚£ä¹ˆé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“, <code>VS</code> æ˜¯å¦‚ä½•çŸ¥é“å“ªäº›æ–‡ä»¶æ˜¯éœ€è¦è¢«çº³å…¥ç¼–è¯‘èŒƒå›´çš„.</p>
<p>ä¸€ä¸ªæœ€ç®€å•çš„è®¾ç½®æ–¹æ³•å°±æ˜¯å°†æ–‡ä»¶æˆ–è€…æ–‡ä»¶å¤¹è®¾ç½®æ˜¯å¦åŒ…å«åœ¨é¡¹ç›®ä¸­. è§£å†³æ–¹æ¡ˆè§†å›¾åªä¼šæ˜¾ç¤ºåœ¨é¡¹ç›®ä¸­çš„å†…å®¹. å³ä½¿æ–‡ä»¶å®é™…ä¸Šåœ¨é¡¹ç›®æ–‡ä»¶å¤¹å†…, å¦‚æœä¸åœ¨é¡¹ç›®ä¸­, é‚£å®ƒä¹Ÿä¸ä¼šçº³å…¥ <code>VS</code> é¡¹ç›®çš„å„ç§åˆ¤æ–­é€»è¾‘ä¸­, æ¯”å¦‚ä¸ä¼šå‚ä¸ç¼–è¯‘.</p>
<p><img data-src="/static/image/wast-vscandvs/vJxqXj.png" alt="vJxqXj.png"></p>
<p>è¿™ç§æ–¹å¼å¯ä»¥å¾ˆè½»æ¾çš„æŠŠæ–‡ä»¶æ’é™¤é¡¹ç›®. é‚£ä¹ˆå¯¹äºæ·»åŠ åˆ°é¡¹ç›®é‡Œ, æ¯”å¦‚éœ€è¦æ·»åŠ ç°æœ‰çš„æ–‡ä»¶ä¸æºä»£ç , æˆ‘ä»¬éœ€è¦é¦–å…ˆæŠŠå¯¹åº”çš„æ–‡ä»¶åœ¨ç‰©ç†ä¸Šç§»åˆ°æˆ‘ä»¬çš„é¡¹ç›®æ–‡ä»¶å¤¹å†…åˆé€‚çš„åœ°æ–¹, ç„¶åä½¿ç”¨ç®¡ç†å™¨åˆ‡æ¢åˆ° &quot;æ‰€æœ‰æ–‡ä»¶&quot; è§†å›¾.</p>
<p><img data-src="/static/image/wast-vscandvs/vJzQjH.png" alt="vJzQjH.png"></p>
<p>å¦‚æœåˆšåˆšæŠŠ <code>main.c</code> æ’é™¤äº†, é‚£ä¹ˆå°±ä¼šåƒå›¾ä¸Šé‚£æ ·æœ‰ä¸ªçº¢è‰²ç¬¦å·, è¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶æ²¡æœ‰çº³å…¥é¡¹ç›®é€»è¾‘è€ƒè™‘èŒƒå›´. æˆ‘ä»¬å¯ä»¥ç”¨å³é”®æŠŠå®ƒé‡æ–°åŒ…å«åˆ°é¡¹ç›®å†…, è¿™æ ·å­çº¢è‰²ç¬¦å·å°±æ¶ˆå¤±äº†, è§£å†³æ–¹æ¡ˆè§†å›¾é‡Œä¹Ÿèƒ½é‡æ–°çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶äº†.</p>
<p>å½“ç¡®å®šäº†é‚£äº›æ–‡ä»¶è¢«åŒ…å«åˆ°é¡¹ç›®ä¸­å, å°±å¯ä»¥å¼€å§‹ç¼–è¯‘äº†.</p>
<p>æœ‰ä¸¤ç§æ–¹å¼ä¼šè¿›è¡Œç¼–è¯‘, ä¸€ç§æ˜¯ç›´æ¥è¿è¡Œæˆ–è€…è°ƒè¯•ç¨‹åº, å¦‚æœé¡¹ç›®æ²¡æœ‰è¢«ç¼–è¯‘, åˆ™ä¼šå…ˆè¿›è¡Œç¼–è¯‘, å†è¿è¡Œç¨‹åº. å¦ä¸€ç§å°±æ˜¯åªç¼–è¯‘ä¸è¿è¡Œ, åˆ†æ­¥éª¤è¿›è¡Œ.</p>
<p>æˆ‘è¿™é‡Œè¿˜æ˜¯æ¨èåˆ†æ­¥éª¤è¿›è¡Œ, å…ˆç¼–è¯‘çœ‹çœ‹æ˜¯å¦å­˜åœ¨ä»€ä¹ˆè­¦å‘Šæˆ–è€…é”™è¯¯, å†è¿›è¡Œè¿è¡Œæˆ–è€…è°ƒè¯•.</p>
<p>ç¼–è¯‘çš„æ—¶å€™æœ‰ä¸€äº›åŸºæœ¬é€‰é¡¹å¯ä»¥è°ƒæ•´.</p>
<p><img data-src="/static/image/wast-vscandvs/vtQxRU.png" alt="vtQxRU.png"></p>
<p><code>x86</code> å’Œ <code>x64</code> å¥½ç†è§£, æŒ‡çš„æ˜¯ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ 32 ä½ç¨‹åºè¿˜æ˜¯ 64 ä½ç¨‹åº, ä¸€èˆ¬æ¥è¯´è°ƒæˆ <code>x64</code> ä¼šè®©ç¨‹åºèƒ½æ›´å……åˆ†åˆ©ç”¨ç°åœ¨çš„ 64 ä½å¤„ç†å™¨æ€§èƒ½.</p>
<p>è€Œ <code>Release</code> ä¸ <code>Debug</code>, ç¿»è¯‘ä¸€èˆ¬å« &quot;å‘å¸ƒ&quot; ä¸ &quot;è°ƒè¯•&quot;. è°ƒè¯•ç‰ˆæœ¬æ˜¯é€‚åˆäºè°ƒè¯•ä»£ç çš„ç‰ˆæœ¬, <code>VS</code> åœ¨ç¼–è¯‘æ—¶ä¼šåŠ å…¥å¾ˆå¤šè°ƒè¯•ä¿¡æ¯è¿›å…¥æœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶, èƒ½å¤Ÿåœ¨è°ƒè¯•æ—¶å……åˆ†çš„è·å¾—ç¨‹åºè¿è¡Œçš„æ¯ä¸€æ­¥ä¿¡æ¯. è€Œ &quot;å‘å¸ƒ&quot; åˆ™æ˜¯é€‚åˆæœ€ç»ˆè¿è¡Œçš„ä¼˜åŒ–ç‰ˆæœ¬, <code>VS</code> ä¼šåœ¨ç¼–è¯‘æ—¶å°½å¯èƒ½çš„å‡å°‘ä»£ç å†—ä½™, å¯¹ä»£ç ç»“æ„è¿›è¡Œä¼˜åŒ–, æé«˜æœ€ç»ˆç¨‹åºçš„è¿è¡Œæ•ˆç‡.</p>
<p>æ‰€ä»¥å†™ä»£ç çš„æ—¶å€™ç”¨ <code>Debug</code> ç‰ˆæœ¬, è€Œäº¤ç¨‹åºçš„æ—¶å€™ç”¨ <code>Release</code> ç‰ˆæœ¬. (è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„è¿è¡Œæ•ˆç‡å·®å¼‚éå¸¸å¤§, å¦‚æœä½ è§‰å¾—ä»£ç å¤ªæ…¢, ä¸å¦¨è¯•ä¸€ä¸‹ <code>Release</code> æ¥å°è¯•æé«˜æ•ˆç‡. <del>è¯´ä¸å®šæœ‰å¥‡æ•ˆ</del>)</p>
<p>ç„¶åè¿›å…¥ç¼–è¯‘çš„æ­£é¢˜. é€‰æ‹©èœå•æ é‡Œçš„ &quot;ç”Ÿæˆ&quot;, åœ¨è¿™é‡Œå¯ä»¥å¯¹è§£å†³æ–¹æ¡ˆå’Œæ¯ä¸ªé¡¹ç›®è¿›è¡Œç”Ÿæˆæ“ä½œ. æ­¤å¤„ &quot;ç”Ÿæˆ&quot; ä¸ä¸€å®šæŒ‡ç¼–è¯‘, è€Œæ˜¯å»ç”Ÿæˆæ¯ä¸ªé¡¹ç›®çš„ç›®æ ‡æ–‡ä»¶, å¯¹äº <code>c</code> è¯­è¨€æ¥è¯´å°±æ˜¯ç¼–è¯‘é“¾æ¥æ“ä½œ. </p>
<p>é€‰æ‹©ç”Ÿæˆæ•´ä¸ªè§£å†³æ–¹æ¡ˆ, åˆ™ <code>VS</code> ä¼šæŒ‰ç…§é¡¹ç›®é—´çš„ä¾èµ–å…³ç³»ä¾æ¬¡ç”Ÿæˆæ–¹æ¡ˆå†…æ‰€æœ‰çš„é¡¹ç›®. é€‰æ‹©ç”ŸæˆæŸä¸€ä¸ªé¡¹ç›®, é‚£å°±æ˜¯ç”Ÿæˆå•ç‹¬çš„ä¸€ä¸ªé¡¹ç›®. æ¯æ¬¡å¯ä»¥é€‰æ‹© &quot;é‡æ–°ç”Ÿæˆ&quot; æˆ–è€… &quot;ç”Ÿæˆ&quot;, å‰è€…ä¼šå…ˆè¿›è¡Œä¸€æ­¥ &quot;æ¸…ç†&quot; æ“ä½œ, æŠŠä¸Šä¸€æ¬¡ç”Ÿæˆæ—¶äº§ç”Ÿçš„æ‰€æœ‰æ–‡ä»¶å…ˆæ¸…é™¤å†è¿›è¡Œç”Ÿæˆ.</p>
<p>ä¸€èˆ¬æ¥è¯´, ç›´æ¥ä½¿ç”¨å¿«æ·é”® <code>Ctrl + B</code> å³å¯, ä¼šç”Ÿæˆå½“å‰æ­£åœ¨æ“ä½œçš„é¡¹ç›®.</p>
<p><img data-src="/static/image/wast-vscandvs/vtlezD.png" alt="vtlezD.png"></p>
<p><img data-src="/static/image/wast-vscandvs/vtlnQe.png" alt="vtlnQe.png"></p>
<p>è¿è¡Œä¸€ä¸‹ç”Ÿæˆ, å¯ä»¥çœ‹åˆ°ä¸‹æ–¹çš„è¾“å‡ºé‡Œæ˜¾ç¤ºç”ŸæˆæˆåŠŸ, å¹¶ä¸”ä¹Ÿè¾“å‡ºäº†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„.</p>
<h4 id="è¿è¡Œä¸è°ƒè¯•"><a href="#è¿è¡Œä¸è°ƒè¯•" class="headerlink" title="è¿è¡Œä¸è°ƒè¯•"></a>è¿è¡Œä¸è°ƒè¯•</h4><p>è¿™é‡Œå°±ç®€å•è¯´è¯´, ä¸èµ˜è¿°äº†, å› ä¸ºåŒä¸ºå¾®è½¯å®¶çš„äº§å“, åŸºæœ¬æ¦‚å¿µå’Œå¿«æ·é”®éƒ½æ˜¯ä¸€æ ·çš„, å…·ä½“çš„æ“ä½œå’Œå‰é¢ <code>VS Code</code> ä¸­è¯´çš„å¤§åŒå°å¼‚, å‡ ä¹æ˜¯ä¸€è‡´çš„. è¿™é‡Œå°±æ”¾ä¸€ä¸‹æˆåŠŸè¿è¡Œæˆªå›¾äº†.</p>
<p>æŒ‰ä¸‹å¿«æ·é”® <code>Ctrl + F5</code>, <code>VS</code> å°±ä¼šè‡ªåŠ¨å¼¹å‡ºæ¥ä¸€ä¸ªè¿è¡Œé»‘æ¡†äº†, &quot;Hello world!&quot;</p>
<p><img data-src="/static/image/wast-vscandvs/vtlJW8.png" alt="vtlJW8.png"></p>
<h2 id="åè¯"><a href="#åè¯" class="headerlink" title="åè¯"></a>åè¯</h2><p>è¿™ä¸€ç¯‡å°±æ‰“ç®—å†™è¿™ä¹ˆå¤šäº†, ç¬¬ä¸€æ¬¡å†™è¿™ç§æ–°æ‰‹æ•™ç¨‹é¢, å°½å¯èƒ½çš„æŒ‰ç…§ä¸€ä¸ªæ²¡æœ‰æ¥è§¦è¿‡ç¼–ç¨‹ä½†æ˜¯æ¥åˆ°äº†ç½‘å®‰å­¦é™¢çš„å¤§ä¸€æ–°ç”Ÿè§†è§’æ¥å†™, å¸Œæœ›èƒ½å¤Ÿæœ‰æ‰€å¸®åŠ©, å¿«é€Ÿå…¥é—¨å§. <del>ä¸Šå•Š, å·æ­»ä»–ä»¬!</del></p>
]]></content>
      <categories>
        <category>ç½‘å®‰æœ¬ç§‘é€Ÿé€š</category>
        <category>æ–°æ‰‹å…¥é—¨</category>
      </categories>
      <tags>
        <tag>VS Code</tag>
        <tag>Visual Studio Code</tag>
        <tag>Visual Studio</tag>
        <tag>VS</tag>
      </tags>
  </entry>
  <entry>
    <title>IDM ç ´è§£ç‰ˆ</title>
    <url>//posts/2023/05/17/idm-cracked/</url>
    <content><![CDATA[<p>IDM ç ´è§£ç‰ˆ, ä¸‹è½½åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pZkNUaDB3Zjdxa2I=">IDM-v6.41.11-Repack.zip<i class="fa fa-external-link-alt"></i></span>.</p>
<p>æ ¡éªŒç :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MD5: EC358D55F0B1657A3095568747CC5B27</span><br><span class="line">SHA1: 8F544AA6CA37BA181A6D942441CC65C0B448FE42</span><br><span class="line">SHA2-256: 8A6DE19A91AE4644762D89C507946AB8E7D096B39D14A32B42C2FAACF9C442DD</span><br><span class="line">SHA3-256: 0679F2F0EB14C58149380429E1229AED27012A5ABC46347AE4742E3975C59079</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>èµ„æºåˆ†äº«</category>
      </categories>
      <tags>
        <tag>ä¸‹è½½å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Typora ç ´è§£ç‰ˆ</title>
    <url>//posts/2023/07/03/typora-cracked/</url>
    <content><![CDATA[<p>Typora v1.3.8 ç ´è§£ç‰ˆ, ä¸‹è½½åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pWmFuNTBuNGF3cGE=">typora-setup-x64.zip<i class="fa fa-external-link-alt"></i></span>.</p>
<p>å®‰è£…åŒ…å®‰è£…ä¹‹å, å°†å‹ç¼©åŒ…é‡Œçš„ <code>winmm.dll</code> æ–‡ä»¶æ”¾åˆ°ç¨‹åºå®‰è£…ç›®å½•ä¸‹. å¯èƒ½ä¼šæŠ¥æ¯’, éœ€è¦æ‰‹åŠ¨æ·»åŠ ä¿¡ä»».</p>
<p>æ ¡éªŒç :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MD5: 8AA8CCF545DA329B44E56700C9D2F468</span><br><span class="line">SHA1: A10C3549E148C7C8124AF9A46D4D3882AC86214B</span><br><span class="line">SHA2-256: B997A59F563AD71282CFA99E3B1AD0900E7DE870D27576C5A53D1EC98567900E</span><br><span class="line">SHA3-256: 590592CE225A2D5261B4D2EC892E869E61301ABDCC49D6D78A3AA268A38E1C4D</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>èµ„æºåˆ†äº«</category>
      </categories>
      <tags>
        <tag>ä¸‹è½½å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows 10 æ¿€æ´»å·¥å…·</title>
    <url>//posts/2023/02/27/win10activation/</url>
    <content><![CDATA[<p>Windows 10 æ¿€æ´»å·¥å…·å­˜æ¡£, ä¸‹è½½åœ°å€: <span class="exturl" data-url="aHR0cHM6Ly93dy1ybS5sYW56b3V0LmNvbS9pZFJabjBvbTJqdWQ=">W10_Digital_Activation_Program_v1.4.6_Chs.zip<i class="fa fa-external-link-alt"></i></span>.</p>
<p>æ ¡éªŒç :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MD5: A7A44635E59CC9C403EBA7873D1B6D0E</span><br><span class="line">SHA1: 13275066B9D3FBFF8F99AA7CDF89D5AC2E94F571</span><br><span class="line">SHA2-256: E44F2F49A0805F3B0B7CB4720B48CFCAEDB3755189ED12CC49F406B425A40296</span><br><span class="line">SHA3-256: 078D7D813914831F4D19757FE98E89F49177C8EC9DEBA4A7FDEEE1083233D890</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>èµ„æºåˆ†äº«</category>
      </categories>
      <tags>
        <tag>æ¿€æ´»å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title>æ‰©æ•£æ¨¡å‹é˜…è¯»ç¬”è®°</title>
    <url>//posts/2022/10/29/diffusion-model/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹çŸ¥ä¹çš„ä¸€ç¯‡æ–‡ç« <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NDgxMTI3MTE=">æ‰©æ•£æ¨¡å‹ Diffusion Models - åŸç†ç¯‡<i class="fa fa-external-link-alt"></i></span>çš„æ‘˜è¦æ€§æ€»ç»“.</p>
<span id="more"></span>

<h2 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h2><p><img data-src="/static/image/diffusion-model/x5xJiR.jpg" alt="x5xJiR.jpg"></p>
<p>å‰å‘è¿‡ç¨‹ä¸ºä¸€å¼ å›¾ç‰‡ $x_0$ åœ¨ç»è¿‡ $T$ è½®é«˜æ–¯å™ªå£°å åŠ åä¼šå˜æˆä¸€å¼ è¿‘ä¼¼çº¯é«˜æ–¯å™ªå£°å›¾ $x_T$, è€Œç½‘ç»œåˆ™æ˜¯å­¦ä¹ åå‘è¿‡ç¨‹ä¸­çš„å‚æ•°, èƒ½å¤Ÿé€šè¿‡ $x_T$ ä¸€æ­¥æ­¥è¿˜åŸå‡º $x_0$.</p>
<h2 id="å‰å‘æ‰©æ•£"><a href="#å‰å‘æ‰©æ•£" class="headerlink" title="å‰å‘æ‰©æ•£"></a>å‰å‘æ‰©æ•£</h2><p>è®¾å…±è¿›è¡Œ $T$ è½®æ‰©æ•£, æœ‰ $\beta_1 &lt; \beta_2 &lt; \dots &lt; \beta_T (0 &lt; \beta_i &lt; 1)$ çš„æ–¹å·®å‚æ•°.</p>
<p>è®¾ $q(x_t|x_{t-1})$ æœä»é«˜æ–¯åˆ†å¸ƒ, ä¸”:</p>
<p>$$<br>x_t(z;x_{t-1},t)=\sqrt{1-\beta_t}x_{t-1}+\sqrt{\beta_t}z \sim N(\sqrt{1-\beta_t}x_{t-1}, \beta_t)<br>$$</p>
<p>è®¾ $\alpha_t=1-\beta_t,\bar{\alpha}_t=\prod_{i=1}^t\alpha_t$, åˆ™æœ‰:</p>
<p>$$<br>x_t(\epsilon_t;x_0,t)=\sqrt{\bar{\alpha}_t}x_0+\sqrt{1-\bar{\alpha}_t}\epsilon_t \sim N(\sqrt{\bar{\alpha}_t}x_0, 1-\bar{\alpha}_t)<br>$$</p>
<p>åˆ™ç»™å®š $x_0,t$, ä»¥åŠé«˜æ–¯éšæœºé‡ $\epsilon_t$, å¯ä»¥ç›´æ¥å¾—åˆ°å¯¹åº”çš„ $x_t$.</p>
<h2 id="é€†å‘æ‰©æ•£"><a href="#é€†å‘æ‰©æ•£" class="headerlink" title="é€†å‘æ‰©æ•£"></a>é€†å‘æ‰©æ•£</h2><p>å‡è®¾ $p(x_{t-1}|x_t;\theta)$ ä¹Ÿæœä»é«˜æ–¯åˆ†å¸ƒ, åˆ™æœ‰:</p>
<p>$$<br>x_{t-1}(z;x_t,t) = \mu_t(x_t, t;\theta)+\sigma_t(x_t, t;\theta)z \sim N(\mu_t(x_t, t;\theta), \sigma^2_t(x_t, t;\theta))<br>$$</p>
<p>$p(x_{t-1}|x_t;\theta)$ æ— æ³•ç”¨å…¬å¼è¡¨ç¤º, ä½†æ˜¯ $q(x_{t-1}|x_t,x_0)$ å¯ä»¥, æœ‰:</p>
<p>$$<br>\mu_t = \frac{1}{\sqrt{\alpha_t}}(x_t-\frac{\beta_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_t)<br>$$</p>
<p>$$<br>\sigma_t = \sqrt{\frac{1-\bar{\alpha}_{t-1}}{1-\bar{\alpha}_t}\beta_t}<br>$$</p>
<p>$$<br>x_{t-1}(z;x_t,\epsilon_t,t) = \mu_t+\sigma_tz \sim N(\frac{1}{\sqrt{\alpha_t}}(x_t-\frac{\beta_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_t), \frac{1-\bar{\alpha}_{t-1}}{1-\bar{\alpha}_t}\beta_t)<br>$$</p>
<p>(è¯¥å…¬å¼ä¸å« $x_0$, ä½†æ˜¯éœ€è¦æœ‰ $x_0$ çš„å‰æä¸‹å¾—åˆ°, ç”±å‰å‘çš„å…¬å¼æ›¿æ¢æ‰äº†, $\epsilon_t$ ä¸å‰å‘ä¸­çš„ $\epsilon_t$ æ˜¯åŒä¸€ä¸ªå€¼)</p>
<p>å…¶ä¸­, $\sigma_t$ å¯è¿‘ä¼¼è®¤ä¸ºç­‰äº $\sqrt{\beta_t}$.</p>
<h2 id="æŸå¤±è®¡ç®—"><a href="#æŸå¤±è®¡ç®—" class="headerlink" title="æŸå¤±è®¡ç®—"></a>æŸå¤±è®¡ç®—</h2><p>ç›®æ ‡æ˜¯èƒ½å¤Ÿè®© $q$ å’Œ $p$ å°½å¯èƒ½çš„æ¥è¿‘, ç”¨ $q$ å»è¿‘ä¼¼ $p$.</p>
<p>æŸå¤±éœ€è¦ç®— $q(x_{t-1}|x_t,x_0)$ å’Œ $p(x_{t-1}|x_t;\theta)$ ä¹‹é—´çš„ KL æ•£åº¦(åˆ†å¸ƒç›¸ä¼¼ç¨‹åº¦), ä¸€é€šè®¡ç®—ä¹‹åå¾—åˆ°:</p>
<p>$$<br>Loss = E((\mu_t(x_t, \epsilon_t, t)-\mu_t(x_t,t;\theta))^2)<br>$$</p>
<p>ä¼˜åŒ–å:</p>
<p>$$<br>Loss = E((\epsilon_t-\epsilon_t(x_t,t;\theta))^2)<br>$$</p>
<p>å¯ä»¥çœ‹å‡ºæ¥å®é™…æ¨ç†ä¸­, åªæœ‰å‡å€¼ä¸­çš„ $\epsilon_t$ æ˜¯æœªçŸ¥çš„, å› æ­¤éœ€è¦ä¸€ä¸ªç½‘ç»œå»çŒœæµ‹ $\epsilon_t$, ä½¿å¾— $q(x_{t-1}|x_t,x_0)$ å¯ä»¥è¿‘ä¼¼æ›¿ä»£ $p(x_{t-1}|x_t;\theta)$, æ¥è¿˜åŸ $t-1$ æ­¥çš„æ•°æ®.</p>
<p>ä¼˜åŒ–åæ˜¯å»æ‹ŸåˆåŠ å…¥çš„å™ªå£°æ•°æ®, ä¹Ÿå°±æ˜¯ä¸€ä¸ªç½‘ç»œè¾“å…¥äº† $t$ æ—¶åˆ»çš„åŠ å™ªå›¾, èƒ½ä¼°è®¡å‡ºæ·»åŠ çš„å™ªå£°å˜é‡ $\epsilon_t=\epsilon_t(x_t,t;\theta)$, è¿›è€Œä½¿ç”¨ $q(x_{t-1}|x_t,x_0)$ å¾—åˆ° $x_{t-1}$.</p>
<h2 id="ä¸€äº›ç¼–ç¨‹æ—¶çš„æ­¥éª¤"><a href="#ä¸€äº›ç¼–ç¨‹æ—¶çš„æ­¥éª¤" class="headerlink" title="ä¸€äº›ç¼–ç¨‹æ—¶çš„æ­¥éª¤"></a>ä¸€äº›ç¼–ç¨‹æ—¶çš„æ­¥éª¤</h2><h3 id="åŸºæœ¬å‚æ•°"><a href="#åŸºæœ¬å‚æ•°" class="headerlink" title="åŸºæœ¬å‚æ•°"></a>åŸºæœ¬å‚æ•°</h3><ul>
<li><p>$T$</p>
<p>æ‰©æ•£æ­¥æ•°, è‡³å°‘ $100$ ä»¥ä¸Š.</p>
</li>
<li><p>$\beta_1 &lt; \beta_2 &lt; \dots &lt; \beta_T (0 &lt; \beta_i &lt; 1)$</p>
<p>æ¯ä¸€è½®æ‰©æ•£çš„æ–¹å·®, åœ¨æ»¡è¶³å¤§å°å…³ç³»çš„æƒ…å†µä¸‹, å°½å¯èƒ½çš„å°, é€šå¸¸åœ¨ $10^{-3}$ çš„æ•°é‡çº§å·¦å³. (åº”è¯¥æ­¥éª¤è¶Šå¤š, æ–¹å·®è¶Šç²¾ç»†?)</p>
</li>
</ul>
<h3 id="é¢„è®¡ç®—çš„å€¼"><a href="#é¢„è®¡ç®—çš„å€¼" class="headerlink" title="é¢„è®¡ç®—çš„å€¼"></a>é¢„è®¡ç®—çš„å€¼</h3><ul>
<li>$\alpha_t=1-\beta_t$</li>
<li>$\bar{\alpha}_t=\prod_{i=1}^t\alpha_t$</li>
</ul>
<h3 id="è®¾è®¡ä¸€ä¸ªç¥ç»ç½‘ç»œ"><a href="#è®¾è®¡ä¸€ä¸ªç¥ç»ç½‘ç»œ" class="headerlink" title="è®¾è®¡ä¸€ä¸ªç¥ç»ç½‘ç»œ"></a>è®¾è®¡ä¸€ä¸ªç¥ç»ç½‘ç»œ</h3><p>è¾“å…¥:</p>
<ul>
<li>$x_t$: è®­ç»ƒé›†æ ·æœ¬ç»è¿‡ $t$ è½®æ­£å‘æ‰©æ•£åçš„ç»“æœ.</li>
<li>$t$: æ‰©æ•£æ­¥æ•°</li>
</ul>
<p>è¾“å‡º:</p>
<ul>
<li>$\epsilon_t(\theta)$: å™ªå£°ä¼°è®¡å€¼</li>
</ul>
<h3 id="æŸå¤±è®¡ç®—æ–¹æ³•"><a href="#æŸå¤±è®¡ç®—æ–¹æ³•" class="headerlink" title="æŸå¤±è®¡ç®—æ–¹æ³•"></a>æŸå¤±è®¡ç®—æ–¹æ³•</h3><p>äº§ç”Ÿä¸€ä¸ªéšæœºå™ªå£° $\epsilon_t$, é€šè¿‡ç½‘ç»œå¾—åˆ°ä¼°è®¡å€¼ $\epsilon_t(\theta)$, è®¡ç®—ä¸¤è€…ä¹‹é—´çš„å‡æ–¹å·® (MSEæŸå¤±).</p>
<h3 id="è®­ç»ƒæ­¥éª¤"><a href="#è®­ç»ƒæ­¥éª¤" class="headerlink" title="è®­ç»ƒæ­¥éª¤"></a>è®­ç»ƒæ­¥éª¤</h3><p>ç»™å®šè®­ç»ƒé›† $X$, å»æ‹Ÿåˆæ¯ä¸ªæ ·æœ¬ $x$ åœ¨æ¯ä¸ªæ­¥éª¤ $t$ æ—¶åˆ»çš„å™ªå£°ä¼°è®¡.</p>
<h3 id="æ¨ç†æ­¥éª¤"><a href="#æ¨ç†æ­¥éª¤" class="headerlink" title="æ¨ç†æ­¥éª¤"></a>æ¨ç†æ­¥éª¤</h3><p>ç»™å®šä¸€ä¸ªçœŸå®æ ·æœ¬ $x_t$, æŒ‡å®šå…¶ $t$ å€¼, æ ¹æ®ç½‘ç»œå¾—åˆ°å™ªå£°ä¼°è®¡ $\epsilon_t(\theta)$, è®¡ç®—å‡º $\mu_t$ å’Œ $\sigma_t$, é‡‡æ ·ä¸€ä¸ªéšæœºæ ‡å‡†é«˜æ–¯å™ªå£° $z$, è®¡ç®— $x_{t-1} = \mu_t+\sigma_tz$</p>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>å›¾åƒç”Ÿæˆ</tag>
        <tag>æ‰©æ•£æ¨¡å‹</tag>
        <tag>Diffusion Model</tag>
      </tags>
  </entry>
  <entry>
    <title>MultiheadAttention ä½¿ç”¨æ–¹æ³•</title>
    <url>//posts/2024/01/22/multiheadattention/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹ PyTorch ä¸­å¤šå¤´æ³¨æ„åŠ› <span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy9kb2NzL3N0YWJsZS9nZW5lcmF0ZWQvdG9yY2gubm4uTXVsdGloZWFkQXR0ZW50aW9uLmh0bWw=">MultiheadAttention<i class="fa fa-external-link-alt"></i></span> çš„ä½¿ç”¨æ–¹æ³•, ä¸»è¦æ˜¯å¯¹ç»´åº¦å˜æ¢çš„è¿‡ç¨‹æ¢³ç†.</p>
<span id="more"></span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ PyTorch çš„æ–‡æ¡£ä¸­, å¯¹äº <span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy9kb2NzL3N0YWJsZS9nZW5lcmF0ZWQvdG9yY2gubm4uTXVsdGloZWFkQXR0ZW50aW9uLmh0bWw=">MultiheadAttention<i class="fa fa-external-link-alt"></i></span> ç±»æœ‰ç€è¿™ä¹ˆå‡ ä¸ªä¸ç»´åº¦æœ‰å…³çš„æ„é€ å‚æ•°, å½±å“ <code>forward</code> ä¼ å…¥çš„ <code>query</code>, <code>key</code>, <code>value</code> çš„å½¢çŠ¶:</p>
<blockquote>
<ul>
<li><code>embed_dim</code> â€“ Total dimension of the model.</li>
<li><code>num_heads</code> â€“ Number of parallel attention heads. Note that <code>embed_dim</code> will be split across <code>num_heads</code> (i.e. each head will have dimension <code>embed_dim // num_heads</code>).</li>
<li><code>kdim</code> â€“ Total number of features for keys. Default: <code>None</code> (uses <code>kdim</code>=<code>embed_dim</code>).</li>
<li><code>vdim</code> â€“ Total number of features for values. Default: <code>None</code> (uses <code>vdim</code>=<code>embed_dim</code>).</li>
</ul>
</blockquote>
<p>åœ¨ä½¿ç”¨è‡ªæ³¨æ„åŠ›çš„æ—¶å€™, å‰å‘ä¼ æ’­åªéœ€è¦å¡«å…¥ç›¸åŒçš„å‚æ•°ä½œä¸º <code>query</code>, <code>key</code>, <code>value</code>, ä¸ç”¨è€ƒè™‘å¤ªå¤š, ä½†æ˜¯éœ€è¦ä½¿ç”¨å¡«å…¥å…·æœ‰ä¸åŒç»´åº¦çš„ <code>query</code>, <code>key</code>, <code>value</code> æ—¶, åˆ™ä¼šä»¤ä¸€äº›ä¸ç†Ÿæ‚‰çš„æ–°æ‰‹æ™•å¤´è½¬å‘.</p>
<h2 id="æ³¨æ„åŠ›æœºåˆ¶"><a href="#æ³¨æ„åŠ›æœºåˆ¶" class="headerlink" title="æ³¨æ„åŠ›æœºåˆ¶"></a>æ³¨æ„åŠ›æœºåˆ¶</h2><div class="note info"><p>ä»¥ä¸‹è¾“å…¥å¹¶ä¸æ˜¯ <code>MultiheadAttention</code> çš„è¾“å…¥, åªæ˜¯æ³¨æ„åŠ›éƒ¨åˆ†çš„è¾“å…¥.</p>
</div>

<p>è®¾æœ‰ä¸‰ä¸ªç‹¬ç«‹çš„å¼ é‡ $Q_{B \times L \times d_k}$, $K_{B \times S \times d_k}$, $V_{B \times S \times d_v}$ ä¸ºæ³¨æ„åŠ›çš„è¾“å…¥, å…¶ä¸­ $B$ æŒ‡æ‰¹å¤§å°, $L$ æŒ‡ $Q$ çš„åºåˆ—é•¿, $S$ æŒ‡ $K$ å’Œ $V$ çš„åºåˆ—é•¿, é‚£ä¹ˆå¯ä»¥çŸ¥é“è¾“å…¥:</p>
<ul>
<li>$Q$, $K$ çš„æ¯ä¸ªå…ƒç´ é•¿åº¦ (ç‰¹å¾æ•°) ç›¸åŒ, è€Œ $V$ å¯ä»¥å…·æœ‰ç‹¬ç«‹çš„å…ƒç´ é•¿åº¦.</li>
<li>$Q$ çš„åºåˆ—é•¿åº¦æ˜¯ç‹¬ç«‹çš„, è€Œ $K$ å’Œ $V$ çš„åºåˆ—é•¿åº¦å¿…é¡»ç›¸ç­‰, å› ä¸ºå®ƒä»¬çš„å…ƒç´ æˆå¯¹å‡ºç°.</li>
</ul>
<p>ä¸‹ä¸€æ­¥åˆ™æ˜¯è®¡ç®—æ³¨æ„åŠ›, ä¹Ÿå°±æ˜¯ç»å…¸å…¬å¼:</p>
<p>$$<br>Attention(Q, K, V) = softmax(\frac{QK^\top}{\sqrt{d_k}})V<br>$$</p>
<p>ä¸­é—´çš„ $QK^\top$ å°†ä¼šå¾—åˆ°ä¸€ä¸ª $B \times L \times S$ çš„å¼ é‡, ä¹Ÿå°±æ˜¯ä¸ºæ¯ä¸ªæ ·æœ¬ç”Ÿæˆäº†ä¸€ä¸ª $L \times S$ çš„çŸ©é˜µ, è€Œè¿™ä¸ªçŸ©é˜µä¸­é—´çš„æ¯ä¸ªå…ƒç´ å°±æ˜¯ $Q$ å’Œ $K$ ä¸­æ¯ä¸ªå…ƒç´ çš„å†…ç§¯.</p>
<p><img data-src="/static/image/multiheadattention/attention.jpg" alt="attention"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºæ˜¯ä¸€ä¸ªæ ·æœ¬çš„è®¡ç®—è¿‡ç¨‹, åœ¨è·å–å†…ç§¯ç»“æœä¹‹å, å¯¹æ¯ä¸€è¡Œè¿›è¡Œ softmax æ“ä½œ, ç›®çš„æ˜¯å¾—åˆ° $K$ ä¸­æ¯ä¸ªå…ƒç´ å¯¹äº $Q$ çš„æ¯ä¸ªå…ƒç´ çš„æƒé‡, ç„¶åå°†ä¸ $K$ åŒ¹é…çš„ $V$ ä¸­çš„å€¼è¿›è¡ŒåŠ æƒå¹³å‡.</p>
<p>å¯¹ $Q$ ä¸­çš„æ¯ä¸ªå…ƒç´ æ¥è¯´, ç›¸å½“äºæ˜¯ä»ä¸€ä¸ª KV è¡¨ä¸­é€šè¿‡å¯¹å…³é”®å­— (<strong>Key</strong>) çš„æŸ¥è¯¢ (<strong>Query</strong>), æ¥è·å¾—äº†å¯¹åº”æ¯ä¸€ä¸ªå€¼ (<strong>Value</strong>) çš„æƒé‡, æœ€åå¯¹æ•´ä¸ªè¡¨è¿›è¡ŒåŠ æƒå¹³å‡, å¾—åˆ°äº†æŸ¥è¯¢ç»“æœ.</p>
<h2 id="å¤šå¤´æ³¨æ„åŠ›"><a href="#å¤šå¤´æ³¨æ„åŠ›" class="headerlink" title="å¤šå¤´æ³¨æ„åŠ›"></a>å¤šå¤´æ³¨æ„åŠ›</h2><p>ä¸Šä¸€èŠ‚ä¸­æˆ‘ä»¬å›é¡¾äº†æ³¨æ„åŠ›éƒ¨åˆ†çš„å†…å®¹, è€Œåœ¨å®Œæ•´çš„æ³¨æ„åŠ›æ¨¡å‹é‡Œ, è¿˜æœ‰å¤šå¤´å¤„ç†.</p>
<p>ç°åœ¨, è®¾æˆ‘ä»¬çš„åŸå§‹è¾“å…¥ <code>query</code>, <code>key</code>, <code>value</code> å½¢çŠ¶åˆ†åˆ«ä¸º $(B, L, E_q)$, $(B, S, E_k)$, $(B, S, E_v)$, ç„¶åè¿˜æœ‰ä¸€ä¸ª $d_{model}$, æ¨¡å‹ä½¿ç”¨çš„éšè—å±‚å¤§å°, ä»¥åŠ $h$, æ¨¡å‹ä½¿ç”¨çš„æ³¨æ„åŠ›å¤´æ•°.</p>
<p>æ­¤æ—¶, æˆ‘ä»¬å°†ä¼šæœ‰ $h$ ä¸ªçº¿æ€§æŠ•å½±çŸ©é˜µ, è®°ä¸º $W^Q_i, W^K_i, W^V_i, i = 0, \ldots, h - 1$, å®ƒä»¬çš„å½¢çŠ¶åˆ†åˆ«ä¸º $(E_q, d_k)$, $(E_k, d_k)$, $(E_v, d_v)$.</p>
<p>æ¯ä¸€ç»„ $W^*_i$ éƒ½å½¢æˆä¸€ç»„æ³¨æ„åŠ›å¤´, å¯¹è¾“å…¥çš„ <code>query</code>, <code>key</code>, <code>value</code> æŠ•å½±å‡ºä¸€ç»„ $Q_i, K_i, V_i$, å¹¶è®¡ç®—å‡ºä¸åŒæ–¹é¢çš„ $Attention(Q_i, K_i, V_i)$ æ³¨æ„åŠ›ç»“æœ.</p>
<p>æœ€åå°† $h$ ä¸ªé•¿åº¦ä¸º $d_v$ çš„æ³¨æ„åŠ›ç»“æœæ‹¼æ¥èµ·æ¥, å°†æ‹¼æ¥åçš„ç»“æœä¸ä¸€ä¸ª $W^O_{hd_v \times d_{model}}$ è¿›è¡Œè¿ç®—, å¾—åˆ°æœ€åçš„å¤šå¤´æ³¨æ„åŠ›è¾“å‡º, å½¢çŠ¶ä¸º $(B, L, d_{model})$.</p>
<h2 id="PyTorch-ä¸­çš„å‚æ•°è®¾ç½®"><a href="#PyTorch-ä¸­çš„å‚æ•°è®¾ç½®" class="headerlink" title="PyTorch ä¸­çš„å‚æ•°è®¾ç½®"></a>PyTorch ä¸­çš„å‚æ•°è®¾ç½®</h2><p>åœ¨ PyTorch çš„å®ç°ä¸­:</p>
<ul>
<li>å‚æ•° <code>embed_size</code> å¯¹åº” $E_q$.</li>
<li>å‚æ•° <code>k_dim</code> å¯¹åº” $E_k$.</li>
<li>å‚æ•° <code>v_dim</code> å¯¹åº” $E_v$.</li>
<li>å‚æ•° <code>num_heads</code> å¯¹åº” $h$.</li>
<li>$d_{model} = E_q$, ä¹Ÿå°±æ˜¯é™åˆ¶äº†è¾“å…¥ <code>query</code> çš„ç»´åº¦å’Œæ¨¡å‹çš„è¾“å‡ºç»´åº¦ç›¸åŒ.</li>
<li>$d_k = d_{model} / h$, è¦æ±‚ <code>embed_size</code> èƒ½å¤Ÿæ•´é™¤ <code>num_heads</code>.</li>
<li>$d_v = d_k$, å³è¾“å…¥æ³¨æ„åŠ›çš„ $V_i$ ä¸ $Q_i, K_i$ ç‰¹å¾æ•°ç›¸åŒ, è¾“å‡ºçš„æ³¨æ„åŠ›ç»“æœç‰¹å¾æ•°ä¸è¾“å…¥ç›¸åŒ.</li>
<li>$hd_v = d_{model}$. å½“ $h = 1$ æ—¶, æœ‰ $d_v = d_k = d_{model} = E_q$.</li>
</ul>
<p>å¯ä»¥çœ‹å‡º PyTorch å†…éƒ¨å®ç°éšå«äº†å¾ˆå¤šå¤„çš„ç»´åº¦ç›¸ç­‰, å¹¶ä¸æ”¯æŒæ‰€æœ‰çš„ç»†èŠ‚è°ƒæ•´, ä½†æ˜¯å®ŒæˆåŸå§‹è®ºæ–‡ä¸­çš„è¦æ±‚è¿˜æ˜¯ç»°ç»°æœ‰ä½™.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2kub3JnLzEwLjQ4NTUwL2FyWGl2LjE3MDYuMDM3NjI=">Attention is All you Need<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9qYWxhbW1hci5naXRodWIuaW8vaWxsdXN0cmF0ZWQtdHJhbnNmb3JtZXIv">The Illustrated Transformer<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9weXRvcmNoLm9yZy9kb2NzL3N0YWJsZS9nZW5lcmF0ZWQvdG9yY2gubm4uTXVsdGloZWFkQXR0ZW50aW9uLmh0bWw=">torch.nn.MultiheadAttention<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>PyTorch</tag>
        <tag>MultiheadAttention</tag>
        <tag>NLP</tag>
      </tags>
  </entry>
  <entry>
    <title>Simpleperf ä¸‰éƒ¨æ›² (ä¸€)</title>
    <url>//posts/2024/07/07/simpleperf1/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹æ€§èƒ½åˆ†æå·¥å…· <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvUkVBRE1FLm1k">Simpleperf<i class="fa fa-external-link-alt"></i></span> ä½¿ç”¨æ–‡æ¡£æ€»ç»“, ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯æ–‡æ¡£ç¿»è¯‘.</p>
<span id="more"></span>

<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>ç›¸æ¯”ä¸ç›´æ¥ä½¿ç”¨ Simpleperf, Android Studio æä¾›äº†ä¸€ä¸ªåŸºäº simpleperf çš„å›¾å½¢åŒ–å‰ç«¯, <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vc3R1ZGlvL3Byb2ZpbGUvY3B1LXByb2ZpbGVy">Inspect CPU activity with CPU Profiler<i class="fa fa-external-link-alt"></i></span> æ–‡æ¡£ä¸­ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ CPU Profiler æ¥åˆ†æå®‰å“ä¸Šçš„åº”ç”¨æ€§èƒ½.</p>
<p>Simpleperf æ˜¯ Android çš„æœ¬åœ° CPU åˆ†æå·¥å…·. å®ƒå¯ä»¥ç”¨æ¥åˆ†æ Android åº”ç”¨ç¨‹åºå’Œè¿è¡Œåœ¨ Android ä¸Šçš„æœ¬åœ°è¿›ç¨‹. å®ƒå¯ä»¥åˆ†æ Android ä¸Šçš„ Java å’Œ c++ ä»£ç . Simpleperf å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥åœ¨ Android &gt;= L ä¸Šè¿è¡Œ, Python è„šæœ¬å¯ä»¥åœ¨ Android &gt;= N ä¸Šä½¿ç”¨.</p>
<p>Simpleperf åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†: simpleperf å¯æ‰§è¡Œæ–‡ä»¶å’Œ Python è„šæœ¬.</p>
<p>simpleperf å¯æ‰§è¡Œæ–‡ä»¶ç±»ä¼¼äº linux-tools-perf, ä½†åœ¨ Android æ€§èƒ½åˆ†æç¯å¢ƒä¸­å…·æœ‰ä¸€äº›ç‰¹å®šåŠŸèƒ½:</p>
<ul>
<li>åœ¨æ€§èƒ½åˆ†ææ•°æ®ä¸­æ”¶é›†æ›´å¤šä¿¡æ¯. ç”±äºå¸¸è§çš„å·¥ä½œæµç¨‹æ˜¯&quot;åœ¨è®¾å¤‡ä¸Šè®°å½•, å¹¶åœ¨ä¸»æœºä¸ŠæŠ¥å‘Š&quot;, simpleperf ä¸ä»…åœ¨æ€§èƒ½åˆ†ææ•°æ®ä¸­æ”¶é›†æ ·æœ¬, è¿˜æ”¶é›†æ‰€éœ€çš„ç¬¦å·, è®¾å¤‡ä¿¡æ¯å’Œè®°å½•æ—¶é—´.</li>
<li>æä¾›æ–°çš„è®°å½•åŠŸèƒ½.<ul>
<li>åœ¨è®°å½•åŸºäº dwarf çš„è°ƒç”¨å›¾æ—¶, simpleperf åœ¨å°†æ ·æœ¬å†™å…¥æ–‡ä»¶ä¹‹å‰å±•å¼€å †æ ˆ. è¿™æ˜¯ä¸ºäº†èŠ‚çœè®¾å¤‡ä¸Šçš„å­˜å‚¨ç©ºé—´.</li>
<li>æ”¯æŒä½¿ç”¨ <code>--trace-offcpu</code> é€‰é¡¹è·Ÿè¸ª CPU æ—¶é—´å’Œé CPU æ—¶é—´.</li>
<li>æ”¯æŒåœ¨ Android P åŠä»¥ä¸Šç‰ˆæœ¬ä¸Šè®°å½• JIT ç¼–è¯‘å’Œè§£é‡Šçš„ Java ä»£ç çš„è°ƒç”¨å›¾.</li>
</ul>
</li>
<li>ä¸ Android å¹³å°ç´§å¯†ç›¸å…³.<ul>
<li>äº†è§£ Android ç¯å¢ƒ, ä¾‹å¦‚ä½¿ç”¨ç³»ç»Ÿå±æ€§å¯ç”¨æ€§èƒ½åˆ†æ, ä½¿ç”¨ <code>run-as</code> åœ¨åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œæ€§èƒ½åˆ†æ.</li>
<li>æ”¯æŒä» <code>.gnu_debugdata</code> éƒ¨åˆ†è¯»å–ç¬¦å·å’Œè°ƒè¯•ä¿¡æ¯, å› ä¸ºç³»ç»Ÿåº“ä» Android O å¼€å§‹ä½¿ç”¨ <code>.gnu_debugdata</code> éƒ¨åˆ†æ„å»º.</li>
<li>æ”¯æŒåˆ†æåµŒå…¥åœ¨ apk æ–‡ä»¶ä¸­çš„å…±äº«åº“.</li>
<li>ä½¿ç”¨æ ‡å‡†çš„ Android å †æ ˆå±•å¼€å™¨, å› æ­¤å…¶ç»“æœä¸æ‰€æœ‰å…¶ä»– Android å·¥å…·ä¸€è‡´.</li>
</ul>
</li>
<li>æ„å»ºç”¨äºä¸åŒç”¨é€”çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“.<ul>
<li>åœ¨è®¾å¤‡ä¸Šæ„å»ºé™æ€å¯æ‰§è¡Œæ–‡ä»¶. ç”±äºé™æ€å¯æ‰§è¡Œæ–‡ä»¶ä¸ä¾èµ–äºä»»ä½•åº“, simpleperf å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥æ¨é€åˆ°ä»»ä½• Android è®¾å¤‡ä¸Šå¹¶ç”¨äºè®°å½•æ€§èƒ½åˆ†ææ•°æ®.</li>
<li>åœ¨ä¸åŒçš„ä¸»æœºä¸Šæ„å»ºå¯æ‰§è¡Œæ–‡ä»¶: Linux, Mac å’Œ Windows. è¿™äº›å¯æ‰§è¡Œæ–‡ä»¶å¯ç”¨äºåœ¨ä¸»æœºä¸ŠæŠ¥å‘Š.</li>
<li>åœ¨ä¸åŒçš„ä¸»æœºä¸Šæ„å»ºæŠ¥å‘Šå…±äº«åº“. æŠ¥å‘Šåº“ç”±ä¸åŒçš„ Python è„šæœ¬ä½¿ç”¨æ¥è§£ææ€§èƒ½åˆ†ææ•°æ®.</li>
</ul>
</li>
</ul>
<p>æœ‰å…³ simpleperf å¯æ‰§è¡Œæ–‡ä»¶çš„è¯¦ç»†æ–‡æ¡£è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvUkVBRE1FLm1kI2V4ZWN1dGFibGUtY29tbWFuZHMtcmVmZXJlbmNl">executable-commands-reference<i class="fa fa-external-link-alt"></i></span>.</p>
<p>Python è„šæœ¬æ ¹æ®å…¶åŠŸèƒ½åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†:</p>
<ul>
<li>ç”¨äºè®°å½•çš„è„šæœ¬, å¦‚ <code>app_profiler.py</code>, <code>run_simpleperf_without_usb_connection.py</code>.</li>
<li>ç”¨äºæŠ¥å‘Šçš„è„šæœ¬, å¦‚ <code>report.py</code>, <code>report_html.py</code>, <code>inferno</code>.</li>
<li>ç”¨äºè§£ææ€§èƒ½åˆ†ææ•°æ®çš„è„šæœ¬, å¦‚ <code>simpleperf_report_lib.py</code>.</li>
</ul>
<p>è¿™äº› Python è„šæœ¬åœ¨ Python &gt;= 3.9 ç‰ˆæœ¬ä¸Šè¿›è¡Œäº†æµ‹è¯•. æ—§ç‰ˆæœ¬å¯èƒ½ä¸å—æ”¯æŒ. æœ‰å…³ Python è„šæœ¬çš„è¯¦ç»†æ–‡æ¡£è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvUkVBRE1FLm1kI3NjcmlwdHMtcmVmZXJlbmNl">scripts-reference<i class="fa fa-external-link-alt"></i></span>.</p>
<h3 id="simpleperf-ä¸­çš„å·¥å…·"><a href="#simpleperf-ä¸­çš„å·¥å…·" class="headerlink" title="simpleperf ä¸­çš„å·¥å…·"></a>simpleperf ä¸­çš„å·¥å…·</h3><p>simpleperf å¯æ‰§è¡Œæ–‡ä»¶å’Œ Python è„šæœ¬ä½äº NDK å‘å¸ƒç‰ˆçš„ simpleperf/ ç›®å½•ä¸­, ä»¥åŠ AOSP çš„ system/extras/simpleperf/scripts/ ç›®å½•ä¸­. å®ƒä»¬çš„åŠŸèƒ½å¦‚ä¸‹æ‰€åˆ—.</p>
<ul>
<li><p><code>bin/</code>: åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“.</p>
<ul>
<li><code>bin/android/$&#123;arch&#125;/simpleperf</code>: ç”¨äºè®¾å¤‡ä¸Šçš„é™æ€ simpleperf å¯æ‰§è¡Œæ–‡ä»¶.</li>
<li><code>bin/$&#123;host&#125;/$&#123;arch&#125;/simpleperf</code>: ç”¨äºä¸»æœºä¸Šçš„ simpleperf å¯æ‰§è¡Œæ–‡ä»¶, ä»…æ”¯æŒæŠ¥å‘ŠåŠŸèƒ½.</li>
<li><code>bin/$&#123;host&#125;/$&#123;arch&#125;/libsimpleperf_report.$&#123;so/dylib/dll&#125;</code>: ç”¨äºä¸»æœºä¸Šçš„æŠ¥å‘Šå…±äº«åº“.</li>
</ul>
</li>
<li><p><code>*.py</code>, <code>inferno</code>, <code>purgatorio</code>: ç”¨äºè®°å½•å’ŒæŠ¥å‘Šçš„ Python è„šæœ¬. è¯¦ç»†ä¿¡æ¯è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2Mvc2NyaXB0c19yZWZlcmVuY2UubWQ=">scripts_reference.md<i class="fa fa-external-link-alt"></i></span>.</p>
</li>
</ul>
<h3 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h3><h4 id="åœ¨ä¸åŒ-Android-ç‰ˆæœ¬ä¸Šçš„æ”¯æŒ"><a href="#åœ¨ä¸åŒ-Android-ç‰ˆæœ¬ä¸Šçš„æ”¯æŒ" class="headerlink" title="åœ¨ä¸åŒ Android ç‰ˆæœ¬ä¸Šçš„æ”¯æŒ"></a>åœ¨ä¸åŒ Android ç‰ˆæœ¬ä¸Šçš„æ”¯æŒ</h4><p>åœ¨ Android &lt; N ä¸Š, å†…æ ¸å¯èƒ½è¿‡æ—§ (&lt; 3.18), ä¸æ”¯æŒè®°å½•åŸºäº DWARF çš„è°ƒç”¨å›¾ç­‰åŠŸèƒ½. åœ¨ Android M - O ä¸Š, æˆ‘ä»¬åªèƒ½åˆ†æ C++ ä»£ç å’Œå®Œå…¨ç¼–è¯‘çš„ Java ä»£ç . åœ¨ Android &gt;= P ä¸Š, ART è§£é‡Šå™¨æ”¯æŒåŸºäº DWARF çš„å±•å¼€, å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ†æ Java ä»£ç . åœ¨ Android &gt;= Q ä¸Š, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¾å¤‡ä¸Šçš„ simpleperf æ¥åˆ†æå·²å‘å¸ƒçš„ Android åº”ç”¨, åªéœ€åœ¨ AndroidManifest.xml ä¸­æ·»åŠ  <code>&lt;profileable android:shell=&quot;true&quot; /&gt;</code>.</p>
<h4 id="æ¯”è¾ƒåŸºäº-DWARF-å’ŒåŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾"><a href="#æ¯”è¾ƒåŸºäº-DWARF-å’ŒåŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾" class="headerlink" title="æ¯”è¾ƒåŸºäº DWARF å’ŒåŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾"></a>æ¯”è¾ƒåŸºäº DWARF å’ŒåŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾</h4><p>Simpleperf æ”¯æŒä¸¤ç§æ–¹å¼è®°å½•è°ƒç”¨æ ˆ. ä¸€ä¸ªæ˜¯åŸºäº DWARF çš„è°ƒç”¨å›¾, å¦ä¸€ä¸ªæ˜¯åŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾. ä»¥ä¸‹æ˜¯å®ƒä»¬çš„æ¯”è¾ƒ:</p>
<p>è®°å½•åŸºäº DWARF çš„è°ƒç”¨å›¾:</p>
<ul>
<li>éœ€è¦äºŒè¿›åˆ¶æ–‡ä»¶ä¸­è°ƒè¯•ä¿¡æ¯çš„æ”¯æŒ.</li>
<li>åœ¨ ARM å’Œ ARM64 ä¸Šè¡¨ç°è‰¯å¥½, å¯¹ Java ä»£ç å’Œ C++ ä»£ç éƒ½é€‚ç”¨.</li>
<li>æ¯ä¸ªæ ·æœ¬åªèƒ½å±•å¼€ 64K çš„å †æ ˆ. å› æ­¤ä¸æ€»æ˜¯å¯èƒ½å±•å¼€åˆ°æœ€åº•éƒ¨. ç„¶è€Œ, è¿™åœ¨ simpleperf ä¸­å¾—åˆ°äº†ç¼“è§£, å¦‚ä¸‹ä¸€èŠ‚æ‰€è¿°.</li>
<li>æ¯”åŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾å ç”¨æ›´å¤šçš„ CPU æ—¶é—´. å› æ­¤å®ƒçš„å¼€é”€æ›´å¤§, æ— æ³•ä»¥å¾ˆé«˜çš„é¢‘ç‡é‡‡æ · (é€šå¸¸ &lt;= 4000 Hz).</li>
</ul>
<p>è®°å½•åŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾:</p>
<ul>
<li>éœ€è¦å †æ ˆå¸§å¯„å­˜å™¨çš„æ”¯æŒ.</li>
<li>åœ¨ ARM ä¸Šè¡¨ç°ä¸ä½³. å› ä¸º ARM ç¼ºå°‘å¯„å­˜å™¨, ä¸” ARM å’Œ THUMB ä»£ç æœ‰ä¸åŒçš„å †æ ˆå¸§å¯„å­˜å™¨. å› æ­¤å†…æ ¸æ— æ³•å±•å¼€åŒæ—¶åŒ…å« ARM å’Œ THUMB ä»£ç çš„ç”¨æˆ·å †æ ˆ.</li>
<li>åœ¨ Java ä»£ç ä¸Šä¹Ÿè¡¨ç°ä¸ä½³. å› ä¸º ART ç¼–è¯‘å™¨ä¸ä¿ç•™å †æ ˆå¸§å¯„å­˜å™¨, å¹¶ä¸”å®ƒæ— æ³•è·å–è§£é‡Šçš„ Java ä»£ç çš„å¸§.</li>
<li>åœ¨åˆ†æ ARM64 ä¸Šçš„æœ¬æœºç¨‹åºæ—¶è¡¨ç°è‰¯å¥½. ä¸€ä¸ªä¾‹å­æ˜¯åˆ†æ surfacelinger. å½“å®ƒè¡¨ç°è‰¯å¥½æ—¶, é€šå¸¸ä¼šæ˜¾ç¤ºå®Œæ•´çš„ç«ç„°å›¾.</li>
<li>æ¯”åŸºäº DWARF çš„è°ƒç”¨å›¾å ç”¨æ›´å°‘çš„ CPU æ—¶é—´. å› æ­¤é‡‡æ ·é¢‘ç‡å¯ä»¥è¾¾åˆ° 10000 Hz æˆ–æ›´é«˜.</li>
</ul>
<p>æ‰€ä»¥, å¦‚æœéœ€è¦åœ¨ ARM ä¸Šåˆ†æä»£ç æˆ–åˆ†æ Java ä»£ç , åŸºäº DWARF çš„è°ƒç”¨å›¾æ›´å¥½. å¦‚æœéœ€è¦åœ¨ ARM64 ä¸Šåˆ†æ C++ ä»£ç , åŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾å¯èƒ½æ›´å¥½. æ€»ä¹‹, å¯ä»¥å…ˆå°è¯•åŸºäº DWARF çš„è°ƒç”¨å›¾, è¿™æ˜¯ä½¿ç”¨ <code>-g</code> æ—¶çš„é»˜è®¤é€‰é¡¹. å› ä¸ºå®ƒæ€»èƒ½äº§ç”Ÿåˆç†çš„ç»“æœ. å¦‚æœæ•ˆæœä¸å¤Ÿå¥½, å†å°è¯•åŸºäºå †æ ˆå¸§çš„è°ƒç”¨å›¾.</p>
<h4 id="ä¿®å¤åŸºäº-DWARF-çš„ç ´æŸè°ƒç”¨å›¾"><a href="#ä¿®å¤åŸºäº-DWARF-çš„ç ´æŸè°ƒç”¨å›¾" class="headerlink" title="ä¿®å¤åŸºäº DWARF çš„ç ´æŸè°ƒç”¨å›¾"></a>ä¿®å¤åŸºäº DWARF çš„ç ´æŸè°ƒç”¨å›¾</h4><p>åŸºäº DWARF çš„è°ƒç”¨å›¾æ˜¯é€šè¿‡å±•å¼€çº¿ç¨‹å †æ ˆç”Ÿæˆçš„. å½“è®°å½•ä¸€ä¸ªæ ·æœ¬æ—¶, å†…æ ¸ä¼šè½¬å‚¨æœ€å¤š 64KB çš„å †æ ˆæ•°æ®. é€šè¿‡åŸºäº DWARF ä¿¡æ¯å±•å¼€å †æ ˆ, æˆ‘ä»¬å¯ä»¥å¾—åˆ°è°ƒç”¨æ ˆ.</p>
<p>é€ æˆè°ƒç”¨æ ˆç ´æŸçš„ä¸¤ä¸ªåŸå› :</p>
<ul>
<li>å†…æ ¸æ¯ä¸ªæ ·æœ¬åªèƒ½è½¬å‚¨æœ€å¤š 64KB çš„å †æ ˆæ•°æ®, ä½†çº¿ç¨‹å¯èƒ½æœ‰æ›´å¤§çš„å †æ ˆ. åœ¨è¿™ç§æƒ…å†µä¸‹, æˆ‘ä»¬æ— æ³•å±•å¼€åˆ°çº¿ç¨‹çš„èµ·å§‹ç‚¹.</li>
<li>æˆ‘ä»¬éœ€è¦åŒ…å« DWARF è°ƒç”¨å¸§ä¿¡æ¯çš„äºŒè¿›åˆ¶æ–‡ä»¶æ¥å±•å¼€å †æ ˆå¸§. äºŒè¿›åˆ¶æ–‡ä»¶åº”å…·æœ‰ä»¥ä¸‹éƒ¨åˆ†ä¹‹ä¸€: <code>.eh_frame</code>, <code>.debug_frame</code>, <code>.ARM.exidx</code> æˆ– <code>.gnu_debugdata</code>.</li>
</ul>
<p>ä¸ºç¼“è§£è¿™äº›é—®é¢˜:</p>
<p>å…³äºç¼ºå°‘å †æ ˆæ•°æ®çš„é—®é¢˜:</p>
<p>ä¸ºç¼“è§£è¿™ä¸ªé—®é¢˜, simpleperf åœ¨è®°å½•åä¼šè¿æ¥è°ƒç”¨é“¾ (è°ƒç”¨æ ˆ). å¦‚æœä¸€ä¸ªçº¿ç¨‹çš„ä¸¤ä¸ªè°ƒç”¨é“¾æœ‰åŒ…å«ç›¸åŒ ip å’Œ sp åœ°å€çš„æ¡ç›®, é‚£ä¹ˆ simpleperf å°è¯•è¿æ¥å®ƒä»¬ä»¥å»¶é•¿è°ƒç”¨é“¾. å› æ­¤, é€šè¿‡æ›´é•¿æ—¶é—´çš„è®°å½•å’Œæ›´å¤šæ ·æœ¬çš„è¿æ¥, æˆ‘ä»¬å¯ä»¥è·å¾—æ›´å®Œæ•´çš„è°ƒç”¨é“¾. è™½ç„¶è¿™ä¸èƒ½ä¿è¯è·å¾—å®Œæ•´çš„è°ƒç”¨å›¾, ä½†é€šå¸¸æ•ˆæœå¾ˆå¥½.</p>
<p>simpleperf åœ¨å±•å¼€æ ·æœ¬å‰å°†å…¶å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­. å¦‚æœç¼“å†²åŒºç©ºé—²ç©ºé—´ä¸è¶³, simpleperf å¯èƒ½ä¼šå†³å®šå°†æ ·æœ¬çš„å †æ ˆæ•°æ®æˆªæ–­ä¸º 1K. å¸Œæœ›é€šè¿‡è°ƒç”¨é“¾è¿æ¥å¯ä»¥æ¢å¤è¿™äº›æ•°æ®. ä½†å¦‚æœå¤§é‡æ ·æœ¬è¢«æˆªæ–­, è®¸å¤šè°ƒç”¨é“¾å¯èƒ½ä¼šç ´æŸ. æˆ‘ä»¬å¯ä»¥é€šè¿‡è®°å½•å‘½ä»¤çš„è¾“å‡ºåˆ¤æ–­æ ·æœ¬æ˜¯å¦è¢«æˆªæ–­, ä¾‹å¦‚:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ simpleperf record ...</span><br><span class="line">simpleperf I cmd_record.cpp:809] Samples recorded: 105584 (<span class="built_in">cut</span> 86291). Samples lost: 6501.</span><br><span class="line"></span><br><span class="line">$ simpleperf record ...</span><br><span class="line">simpleperf I cmd_record.cpp:894] Samples recorded: 7,365 (1,857 with truncated stacks).</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é¿å…æˆªæ–­æ ·æœ¬. ä¸€ç§æ˜¯å¢åŠ ç¼“å†²åŒºå¤§å°, ä¾‹å¦‚ <code>--user-buffer-size 1G</code>. ä½† <code>--user-buffer-size</code> ä»…åœ¨æœ€æ–°çš„ simpleperf ä¸­å¯ç”¨. å¦‚æœè¯¥é€‰é¡¹ä¸å¯ç”¨, å¯ä»¥ä½¿ç”¨ <code>--no-cut-samples</code> ç¦æ­¢æˆªæ–­æ ·æœ¬.</p>
<p>å…³äºç¼ºå°‘ DWARF è°ƒç”¨å¸§ä¿¡æ¯çš„é—®é¢˜:</p>
<p>å¤§å¤šæ•° C++ ä»£ç ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«è°ƒç”¨å¸§ä¿¡æ¯, ä½äº <code>.eh_frame</code> æˆ– <code>.ARM.exidx</code> éƒ¨åˆ†. è¿™äº›éƒ¨åˆ†ä¸ä¼šè¢«å‰¥ç¦», é€šå¸¸è¶³ä»¥è¿›è¡Œå †æ ˆå±•å¼€.</p>
<p>å¯¹äº C ä»£ç å’Œä¸€å°éƒ¨åˆ†ç¼–è¯‘å™¨ç¡®å®šä¸ä¼šç”Ÿæˆå¼‚å¸¸çš„ C++ ä»£ç , è°ƒç”¨å¸§ä¿¡æ¯ç”Ÿæˆåœ¨ <code>.debug_frame</code> éƒ¨åˆ†. é€šå¸¸ <code>.debug_frame</code> éƒ¨åˆ†ä¼šä¸å…¶ä»–è°ƒè¯•éƒ¨åˆ†ä¸€èµ·è¢«å‰¥ç¦» (strip). è§£å†³æ–¹æ³•ä¹‹ä¸€æ˜¯åœ¨è®¾å¤‡ä¸Šä¸‹è½½æœªå‰¥ç¦»çš„äºŒè¿›åˆ¶æ–‡ä»¶, å¦‚<span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvUkVBRE1FLm1kI2ZpeC1icm9rZW4tY2FsbGNoYWluLXN0b3BwZWQtYXQtYy1mdW5jdGlvbnM=">è¿™é‡Œ<i class="fa fa-external-link-alt"></i></span>æ‰€è¿°.</p>
<p>ç¼–è¯‘å™¨ä¸ä¼šä¸ºå‡½æ•°çš„åºè¨€å’Œå°¾å£°ç”Ÿæˆå±•å¼€æŒ‡ä»¤, å› ä¸ºå®ƒä»¬æ“ä½œå †æ ˆå¸§ä¸”ä¸ä¼šç”Ÿæˆå¼‚å¸¸. ä½†åˆ†æå¯èƒ½ä¼šé‡åˆ°è¿™äº›æŒ‡ä»¤, å¹¶ä¸”æ— æ³•å±•å¼€å®ƒä»¬. è¿™é€šå¸¸åœ¨å¸§å›¾ä¸­ä¸é‡è¦, ä½†åœ¨åŸºäºæ—¶é—´çš„å †æ ˆå›¾è¡¨ (å¦‚ Android Studio å’Œ Firefox åˆ†æå™¨ä¸­) ä¸­, å¶å°”ä¼šå¯¼è‡´å †æ ˆé—´éš™. æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>--remove-gaps</code> ç§»é™¤å †æ ˆé—´éš™, é»˜è®¤æƒ…å†µä¸‹å·²å¯ç”¨æ­¤é€‰é¡¹.</p>
<h4 id="ä¿®å¤åœ¨-C-å‡½æ•°ä¸­åœæ­¢çš„ç ´æŸè°ƒç”¨é“¾"><a href="#ä¿®å¤åœ¨-C-å‡½æ•°ä¸­åœæ­¢çš„ç ´æŸè°ƒç”¨é“¾" class="headerlink" title="ä¿®å¤åœ¨ C å‡½æ•°ä¸­åœæ­¢çš„ç ´æŸè°ƒç”¨é“¾"></a>ä¿®å¤åœ¨ C å‡½æ•°ä¸­åœæ­¢çš„ç ´æŸè°ƒç”¨é“¾</h4><p>ä½¿ç”¨åŸºäº DWARF çš„è°ƒç”¨å›¾æ—¶, simpleperf åœ¨è®°å½•æœŸé—´ç”Ÿæˆè°ƒç”¨é“¾ä»¥èŠ‚çœç©ºé—´. å±•å¼€ C å‡½æ•°æ‰€éœ€çš„è°ƒè¯•ä¿¡æ¯åœ¨ <code>.debug_frame</code> éƒ¨åˆ†, é€šå¸¸åœ¨ apk ä¸­çš„æœ¬æœºåº“ä¸­è¢«å‰¥ç¦». ä¸ºè§£å†³æ­¤é—®é¢˜, æˆ‘ä»¬å¯ä»¥åœ¨è®¾å¤‡ä¸Šä¸‹è½½æœªå‰¥ç¦»çš„æœ¬æœºåº“, å¹¶åœ¨è®°å½•æ—¶è¦æ±‚ simpleperf ä½¿ç”¨å®ƒä»¬.</p>
<p>ç›´æ¥ä½¿ç”¨ simpleperf:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨è®¾å¤‡ä¸Šåˆ›å»º native_libs ç›®å½•, å¹¶æ¨é€æœªå‰¥ç¦»çš„åº“åˆ°å…¶ä¸­ (ä¸æ”¯æŒåµŒå¥—ç›®å½•). </span></span><br><span class="line">$ adb shell <span class="built_in">mkdir</span> /data/local/tmp/native_libs</span><br><span class="line">$ adb push &lt;unstripped_dir&gt;/*.so /data/local/tmp/native_libs</span><br><span class="line"><span class="comment"># ä½¿ç”¨ --symfs é€‰é¡¹è¿è¡Œ simpleperf record. </span></span><br><span class="line">$ adb shell simpleperf record xxx --symfs /data/local/tmp/native_libs</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>app_profiler.py</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./app_profiler.py -lib &lt;unstripped_dir&gt;</span><br></pre></td></tr></table></figure>

<h4 id="å¦‚ä½•è§£å†³æŠ¥å‘Šä¸­ç¼ºå°‘ç¬¦å·çš„é—®é¢˜"><a href="#å¦‚ä½•è§£å†³æŠ¥å‘Šä¸­ç¼ºå°‘ç¬¦å·çš„é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³æŠ¥å‘Šä¸­ç¼ºå°‘ç¬¦å·çš„é—®é¢˜"></a>å¦‚ä½•è§£å†³æŠ¥å‘Šä¸­ç¼ºå°‘ç¬¦å·çš„é—®é¢˜</h4><p><code>simpleperf record</code> å‘½ä»¤åœ¨è®¾å¤‡ä¸Šçš„ <code>perf.data</code> ä¸­æ”¶é›†ç¬¦å·. ä½†å¦‚æœä½ åœ¨è®¾å¤‡ä¸Šä½¿ç”¨çš„æœ¬æœºåº“è¢«å‰¥ç¦», è¿™ä¼šå¯¼è‡´æŠ¥å‘Šä¸­æœ‰å¾ˆå¤šæœªçŸ¥ç¬¦å·. è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ä¸»æœºä¸Šæ„å»º <code>binary_cache</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ”¶é›† perf.data ä¸­éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ° binary_cache/ ä¸­. </span></span><br><span class="line">$ ./binary_cache_builder.py -lib NATIVE_LIB_DIR,...</span><br></pre></td></tr></table></figure>

<p>ä¼ é€’ç»™ <code>-lib</code> é€‰é¡¹çš„ NATIVE_LIB_DIR æ˜¯åŒ…å«ä¸»æœºä¸Šæœªå‰¥ç¦»æœ¬æœºåº“çš„ç›®å½•. è¿è¡Œå, åŒ…å«ç¬¦å·è¡¨çš„æœ¬æœºåº“å°†æ”¶é›†åˆ° binary_cache/ ä¸­ä¾›æŠ¥å‘Šä½¿ç”¨.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./report.py --symfs binary_cache</span><br><span class="line"></span><br><span class="line"><span class="comment"># report_html.py ä¼šè‡ªåŠ¨æœç´¢ binary_cache/, å› æ­¤ä¸éœ€è¦ä¼ é€’ä»»ä½•å‚æ•°. </span></span><br><span class="line">$ ./report_html.py</span><br></pre></td></tr></table></figure>

<h4 id="æ˜¾ç¤ºæ³¨é‡Šçš„æºä»£ç å’Œåæ±‡ç¼–"><a href="#æ˜¾ç¤ºæ³¨é‡Šçš„æºä»£ç å’Œåæ±‡ç¼–" class="headerlink" title="æ˜¾ç¤ºæ³¨é‡Šçš„æºä»£ç å’Œåæ±‡ç¼–"></a>æ˜¾ç¤ºæ³¨é‡Šçš„æºä»£ç å’Œåæ±‡ç¼–</h4><p>è¦åœ¨æºä»£ç å’ŒæŒ‡ä»¤çº§åˆ«æ˜¾ç¤ºçƒ­ç‚¹ä½ç½®, æˆ‘ä»¬éœ€è¦æ˜¾ç¤ºå¸¦æœ‰äº‹ä»¶è®¡æ•°æ³¨é‡Šçš„æºä»£ç å’Œåæ±‡ç¼–. simpleperf æ”¯æŒæ˜¾ç¤º C++ ä»£ç å’Œå®Œå…¨ç¼–è¯‘çš„ Java ä»£ç çš„æ³¨é‡Šæºä»£ç å’Œåæ±‡ç¼–. simpleperf æ”¯æŒä¸¤ç§æ–¹æ³•æ¥å®ç°è¿™ä¸€ç‚¹:</p>
<p>é€šè¿‡ <code>report_html.py</code>:</p>
<ul>
<li>ç”Ÿæˆ perf.data å¹¶å°†å…¶æ‹‰åˆ°ä¸»æœºä¸Š.</li>
<li>ç”ŸæˆåŒ…å«è°ƒè¯•ä¿¡æ¯çš„ elf æ–‡ä»¶çš„ binary_cache. ä½¿ç”¨ <code>-lib</code> é€‰é¡¹æ·»åŠ å¸¦æœ‰è°ƒè¯•ä¿¡æ¯çš„åº“. é€šè¿‡ <code>binary_cache_builder.py -i perf.data -lib &lt;dir_of_lib_with_debug_info&gt;</code> å®ç°.</li>
<li>ä½¿ç”¨ <code>report_html.py</code> ç”Ÿæˆå¸¦æœ‰æ³¨é‡Šæºä»£ç å’Œåæ±‡ç¼–çš„ <code>report.html</code>, å¦‚<span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2Mvc2NyaXB0c19yZWZlcmVuY2UubWQjcmVwb3J0X2h0bWxfcHk=">æ­¤å¤„<i class="fa fa-external-link-alt"></i></span>æ‰€è¿°.</li>
</ul>
<p>é€šè¿‡ <code>pprof</code>:</p>
<ul>
<li>å¦‚ä¸Šæ‰€è¿°ç”Ÿæˆ <code>perf.data</code> å’Œ <code>binary_cache</code>.</li>
<li>ä½¿ç”¨ <code>pprof_proto_generator.py</code> ç”Ÿæˆ pprof åŸå‹æ–‡ä»¶.</li>
<li>ä½¿ç”¨ pprof æŠ¥å‘Šå¸¦æœ‰æ³¨é‡Šæºä»£ç çš„å‡½æ•°, å¦‚<span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2Mvc2NyaXB0c19yZWZlcmVuY2UubWQjcHByb2ZfcHJvdG9fZ2VuZXJhdG9yX3B5">æ­¤å¤„<i class="fa fa-external-link-alt"></i></span>æ‰€è¿°.</li>
</ul>
<h4 id="å‡å°‘ä¸¢å¤±çš„æ ·æœ¬å’Œå †æ ˆè¢«æˆªæ–­çš„æ ·æœ¬"><a href="#å‡å°‘ä¸¢å¤±çš„æ ·æœ¬å’Œå †æ ˆè¢«æˆªæ–­çš„æ ·æœ¬" class="headerlink" title="å‡å°‘ä¸¢å¤±çš„æ ·æœ¬å’Œå †æ ˆè¢«æˆªæ–­çš„æ ·æœ¬"></a>å‡å°‘ä¸¢å¤±çš„æ ·æœ¬å’Œå †æ ˆè¢«æˆªæ–­çš„æ ·æœ¬</h4><p>ä½¿ç”¨ simpleperf è®°å½•æ—¶, æˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°ä¸¢å¤±çš„æ ·æœ¬æˆ–å †æ ˆæ•°æ®è¢«æˆªæ–­çš„æ ·æœ¬. åœ¨å°†æ ·æœ¬ä¿å­˜åˆ°æ–‡ä»¶ä¹‹å‰, simpleperf ä½¿ç”¨ä¸¤ä¸ªç¼“å†²åŒºåœ¨å†…å­˜ä¸­ç¼“å­˜æ ·æœ¬. ä¸€ä¸ªæ˜¯å†…æ ¸ç¼“å†²åŒº, å¦ä¸€ä¸ªæ˜¯ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº. å†…æ ¸å°†æ ·æœ¬æ”¾å…¥å†…æ ¸ç¼“å†²åŒº. simpleperf åœ¨å¤„ç†æ ·æœ¬ä¹‹å‰å°†æ ·æœ¬ä»å†…æ ¸ç¼“å†²åŒºç§»åŠ¨åˆ°ç”¨æˆ·ç©ºé—´ç¼“å†²åŒº. å¦‚æœç¼“å†²åŒºæº¢å‡º, æˆ‘ä»¬ä¼šä¸¢å¤±æ ·æœ¬æˆ–å¾—åˆ°å †æ ˆæ•°æ®è¢«æˆªæ–­çš„æ ·æœ¬. ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ simpleperf record -a --duration 1 -g --user-buffer-size 100k</span><br><span class="line">simpleperf I cmd_record.cpp:799] Recorded <span class="keyword">for</span> 1.00814 seconds. Start post processing.</span><br><span class="line">simpleperf I cmd_record.cpp:894] Samples recorded: 79 (16 with truncated stacks).</span><br><span class="line">                                 Samples lost: 2,129 (kernelspace: 18, userspace: 2,111).</span><br><span class="line">simpleperf W cmd_record.cpp:911] Lost 18.5567% of samples <span class="keyword">in</span> kernel space, consider increasing</span><br><span class="line">                                 kernel buffer size(-m), or decreasing sample frequency(-f), or</span><br><span class="line">                                 increasing sample period(-c).</span><br><span class="line">simpleperf W cmd_record.cpp:928] Lost/Truncated 97.1233% of samples <span class="keyword">in</span> user space, consider</span><br><span class="line">                                 increasing userspace buffer size(--user-buffer-size), or</span><br><span class="line">                                 decreasing sample frequency(-f), or increasing sample period(-c).</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­, æˆ‘ä»¬å¾—åˆ°äº† 79 ä¸ªæ ·æœ¬, å…¶ä¸­ 16 ä¸ªæ ·æœ¬çš„å †æ ˆæ•°æ®è¢«æˆªæ–­. æˆ‘ä»¬åœ¨å†…æ ¸ç¼“å†²åŒºä¸­ä¸¢å¤±äº† 18 ä¸ªæ ·æœ¬, åœ¨ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºä¸­ä¸¢å¤±äº† 2111 ä¸ªæ ·æœ¬.</p>
<p>è¦å‡å°‘å†…æ ¸ç¼“å†²åŒºä¸­ä¸¢å¤±çš„æ ·æœ¬, æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-m</code> å¢åŠ å†…æ ¸ç¼“å†²åŒºå¤§å°. è¦å‡å°‘ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºä¸­ä¸¢å¤±çš„æ ·æœ¬æˆ–å‡å°‘å †æ ˆæ•°æ®è¢«æˆªæ–­çš„æ ·æœ¬, æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>--user-buffer-size</code> å¢åŠ ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºå¤§å°.</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥å‡å°‘åœ¨å›ºå®šæ—¶é—´æ®µå†…ç”Ÿæˆçš„æ ·æœ¬æ•°é‡, ä¾‹å¦‚ä½¿ç”¨ <code>-f</code> å‡å°‘é‡‡æ ·é¢‘ç‡, å‡å°‘ç›‘æ§çš„çº¿ç¨‹æ•°é‡, ä¸åŒæ—¶ç›‘æ§å¤šä¸ª perf äº‹ä»¶.</p>
<h2 id="Android-åº”ç”¨ç¨‹åºåˆ†æ"><a href="#Android-åº”ç”¨ç¨‹åºåˆ†æ" class="headerlink" title="Android åº”ç”¨ç¨‹åºåˆ†æ"></a>Android åº”ç”¨ç¨‹åºåˆ†æ</h2><p>åŸæ–‡è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvYW5kcm9pZF9hcHBsaWNhdGlvbl9wcm9maWxpbmcubWQ=">Android application profiling<i class="fa fa-external-link-alt"></i></span>.</p>
<p>åˆ†æå®‰å“åº”ç”¨ç¨‹åºæ¶‰åŠä¸‰ä¸ªæ­¥éª¤:</p>
<ol>
<li>å‡†å¤‡å®‰å“åº”ç”¨ç¨‹åº.</li>
<li>è®°å½•æ€§èƒ½åˆ†ææ•°æ®.</li>
<li>æŠ¥å‘Šæ€§èƒ½åˆ†ææ•°æ®.</li>
</ol>
<h3 id="å‡†å¤‡å®‰å“åº”ç”¨"><a href="#å‡†å¤‡å®‰å“åº”ç”¨" class="headerlink" title="å‡†å¤‡å®‰å“åº”ç”¨"></a>å‡†å¤‡å®‰å“åº”ç”¨</h3><p>æ ¹æ®åˆ†ææƒ…å†µ, æˆ‘ä»¬å¯èƒ½éœ€è¦å®šåˆ¶æ„å»ºè„šæœ¬, ä»¥ä¸“é—¨ç”Ÿæˆç”¨äºåˆ†æçš„ apk æ–‡ä»¶. ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®.</p>
<hr>
<p>å¦‚æœä½ æƒ³åˆ†æåº”ç”¨ç¨‹åºçš„è°ƒè¯•ç‰ˆæœ¬:</p>
<p>å¯¹äºè°ƒè¯•ç‰ˆæœ¬ç±»å‹, Android Studio åœ¨ <code>AndroidManifest.xml</code> ä¸­è®¾ç½® <code>android:debuggable=&quot;true&quot;</code>, å¯ç”¨ JNI æ£€æŸ¥, å¹¶ä¸”å¯èƒ½ä¸ä¼šä¼˜åŒ– C/C++ ä»£ç . æ— éœ€ä»»ä½•æ›´æ”¹, simpleperf å°±å¯ä»¥åˆ†æå®ƒ.</p>
<hr>
<p>å¦‚æœä½ æƒ³åˆ†æåº”ç”¨ç¨‹åºçš„å‘å¸ƒç‰ˆæœ¬:</p>
<p>å¯¹äºå‘å¸ƒç‰ˆæœ¬ç±»å‹, Android Studio åœ¨ <code>AndroidManifest.xml</code> ä¸­è®¾ç½® <code>android:debuggable=&quot;false&quot;</code>, ç¦ç”¨ JNI æ£€æŸ¥å¹¶ä¼˜åŒ– C/C++ ä»£ç . ç„¶è€Œ, ç”±äºå®‰å…¨é™åˆ¶, åªæœ‰è®¾ç½®äº† <code>android:debuggable</code> ä¸º <code>true</code> çš„åº”ç”¨ç¨‹åºæ‰èƒ½è¢«åˆ†æ. å› æ­¤, simpleperf åªèƒ½åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹åˆ†æå‘å¸ƒç‰ˆæœ¬:</p>
<ol>
<li><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å·² root çš„è®¾å¤‡, å¯ä»¥åˆ†æä»»ä½•åº”ç”¨ç¨‹åº.</p>
</li>
<li><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Android &gt;= Q, å¯ä»¥åœ¨ <code>AndroidManifest.xml</code> ä¸­æ·»åŠ  profileableFromShell æ ‡å¿—, è¿™ä½¿å¾—é¢„è£…çš„åˆ†æå·¥å…·å¯ä»¥åˆ†æå‘å¸ƒçš„åº”ç”¨ç¨‹åº. åœ¨è¿™ç§æƒ…å†µä¸‹, é€šè¿‡ adb ä¸‹è½½çš„ simpleperf å°†è°ƒç”¨ç³»ç»Ÿé•œåƒä¸­é¢„è£…çš„ simpleperf æ¥åˆ†æåº”ç”¨ç¨‹åº.</p>
 <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profileable</span> <span class="attr">android:shell</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Android &gt;= O, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>wrap.sh</code> æ¥åˆ†æå‘å¸ƒç‰ˆæœ¬:</p>
<ol>
<li><p>ç¬¬ä¸€æ­¥: åœ¨ <code>AndroidManifest.xml</code> ä¸­æ·»åŠ  <code>android:debuggable=&quot;true&quot;</code> ä»¥å¯ç”¨åˆ†æ.</p>
 <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:debuggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">...</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>ç¬¬äºŒæ­¥: åœ¨ <code>lib/arch</code> ç›®å½•ä¸­æ·»åŠ  <code>wrap.sh</code>. <code>wrap.sh</code> åœ¨ä¸ä¼ é€’ä»»ä½•è°ƒè¯•æ ‡å¿—ç»™ ART çš„æƒ…å†µä¸‹è¿è¡Œåº”ç”¨ç¨‹åº, å› æ­¤åº”ç”¨ç¨‹åºä½œä¸ºå‘å¸ƒåº”ç”¨ç¨‹åºè¿è¡Œ. å¯ä»¥é€šè¿‡åœ¨ <code>app/build.gradle</code> ä¸­æ·»åŠ ä»¥ä¸‹è„šæœ¬æ¥å®ç° <code>wrap.sh</code>.</p>
 <figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            sourceSets &#123;</span><br><span class="line">                release &#123;</span><br><span class="line">                    resources &#123;</span><br><span class="line">                        srcDir &#123;</span><br><span class="line">                            <span class="string">&quot;wrap_sh_lib_dir&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task createWrapShLibDir &#123;</span><br><span class="line">    <span class="keyword">for</span> (String <span class="attr">abi :</span> [<span class="string">&quot;armeabi-v7a&quot;</span>, <span class="string">&quot;arm64-v8a&quot;</span>, <span class="string">&quot;x86&quot;</span>, <span class="string">&quot;x86_64&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">def</span> dir = <span class="keyword">new</span> File(<span class="string">&quot;app/wrap_sh_lib_dir/lib/&quot;</span> + abi)</span><br><span class="line">        dir.mkdirs()</span><br><span class="line">        <span class="keyword">def</span> wrapFile = <span class="keyword">new</span> File(dir, <span class="string">&quot;wrap.sh&quot;</span>)</span><br><span class="line">        wrapFile.withWriter &#123; writer -&gt;</span><br><span class="line">            writer.write(<span class="string">&#x27;#!/system/bin/sh\n$@\n&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<hr>
<p>å¦‚æœä½ æƒ³åˆ†æ C/C++ ä»£ç :</p>
<p>Android Studio ä¼šåœ¨ apk ä¸­å‰¥ç¦»æœ¬æœºåº“çš„ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯. å› æ­¤, åˆ†æç»“æœå¯èƒ½åŒ…å«æœªçŸ¥ç¬¦å·æˆ–æŸåçš„è°ƒç”¨å›¾. ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-lib</code> é€‰é¡¹å°†åŒ…å«æœªå‰¥ç¦»æœ¬æœºåº“çš„ç›®å½•ä¼ é€’ç»™ <code>app_profiler.py</code>. é€šå¸¸, è¿™ä¸ªç›®å½•å¯ä»¥æ˜¯ä½ çš„ Android Studio é¡¹ç›®çš„è·¯å¾„.</p>
<hr>
<p>å¦‚æœä½ æƒ³åˆ†æ Java ä»£ç :</p>
<ul>
<li>åœ¨ Android &gt;= P ä¸Š, simpleperf æ”¯æŒåˆ†æ Java ä»£ç , æ— è®ºæ˜¯é€šè¿‡è§£é‡Šå™¨æ‰§è¡Œ, è¿˜æ˜¯é€šè¿‡ JIT ç¼–è¯‘, æˆ–è€…ç¼–è¯‘æˆæœ¬æœºæŒ‡ä»¤. å› æ­¤, ä½ ä¸éœ€è¦åšä»»ä½•äº‹æƒ….</li>
<li>åœ¨ Android O ä¸Š, simpleperf æ”¯æŒåˆ†æç¼–è¯‘æˆæœ¬æœºæŒ‡ä»¤çš„ Java ä»£ç , å¹¶ä¸”è¿˜éœ€è¦ wrap.sh æ¥ä½¿ç”¨ç¼–è¯‘åçš„ Java ä»£ç . è¦ç¼–è¯‘ Java ä»£ç , æˆ‘ä»¬å¯ä»¥ä¼ é€’ --compile_java_code é€‰é¡¹ç»™ app_profiler.py.</li>
<li>åœ¨ Android N ä¸Š, simpleperf æ”¯æŒåˆ†æç¼–è¯‘æˆæœ¬æœºæŒ‡ä»¤çš„ Java ä»£ç . è¦ç¼–è¯‘ Java ä»£ç , æˆ‘ä»¬å¯ä»¥ä¼ é€’ --compile_java_code é€‰é¡¹ç»™ app_profiler.py.</li>
<li>åœ¨ Android &lt;= M ä¸Š, simpleperf ä¸æ”¯æŒåˆ†æ Java ä»£ç .</li>
</ul>
<p>ä»¥ä¸‹æ˜¯ä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kZW1vL1NpbXBsZXBlcmZFeGFtcGxlQ3Bw">SimpleperfExampleCpp<i class="fa fa-external-link-alt"></i></span> åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹. å®ƒæ„å»ºäº†ä¸€ä¸ªç”¨äºåˆ†æçš„ app-debug.apk.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://android.googlesource.com/platform/system/extras</span><br><span class="line">$ <span class="built_in">cd</span> extras/simpleperf/demo</span><br><span class="line"><span class="comment"># ç”¨ Android Studio æ‰“å¼€ SimpleperfExampleCpp é¡¹ç›®, å¹¶æˆåŠŸæ„å»ºæ­¤é¡¹ç›®, å¦åˆ™ä¸‹é¢çš„ `./gradlew` å‘½ä»¤å°†å¤±è´¥. </span></span><br><span class="line">$ <span class="built_in">cd</span> SimpleperfExampleCpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ Windows ä¸Š, ä½¿ç”¨ &quot;gradlew&quot; è€Œä¸æ˜¯ &quot;./gradlew&quot;. </span></span><br><span class="line">$ ./gradlew clean assemble</span><br><span class="line">$ adb install -r app/build/outputs/apk/debug/app-debug.apk</span><br></pre></td></tr></table></figure>

<h3 id="è®°å½•å’ŒæŠ¥å‘Šåˆ†ææ•°æ®"><a href="#è®°å½•å’ŒæŠ¥å‘Šåˆ†ææ•°æ®" class="headerlink" title="è®°å½•å’ŒæŠ¥å‘Šåˆ†ææ•°æ®"></a>è®°å½•å’ŒæŠ¥å‘Šåˆ†ææ•°æ®</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>app_profiler.py</code> æ¥åˆ†æå®‰å“åº”ç”¨ç¨‹åº.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢åˆ° simpleperf è„šæœ¬çš„ç›®å½•. è®°å½• perf.data. </span></span><br><span class="line"><span class="comment"># -p é€‰é¡¹é€šè¿‡åŒ…åé€‰æ‹©è¢«åˆ†æçš„åº”ç”¨ç¨‹åº. </span></span><br><span class="line"><span class="comment"># --compile_java_code é€‰é¡¹å°† Java ä»£ç ç¼–è¯‘æˆæœ¬æœºæŒ‡ä»¤, Android &gt;= P ä¸Šä¸éœ€è¦è¿™ä¸ªé€‰é¡¹. </span></span><br><span class="line"><span class="comment"># -a é€‰é¡¹é€‰æ‹©è¦åˆ†æçš„ Activity. </span></span><br><span class="line"><span class="comment"># -lib é€‰é¡¹æŒ‡å®šæŸ¥æ‰¾è°ƒè¯•æœ¬æœºåº“çš„ç›®å½•. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp -a .MixActivity -lib path_of_SimpleperfExampleCpp</span><br></pre></td></tr></table></figure>

<p>è¿™å°†åœ¨å½“å‰ç›®å½•ä¸­æ”¶é›† <code>perf.data</code> ä½œä¸ºæ€§èƒ½åˆ†ææ•°æ®, å¹¶åœ¨ <code>binary_cache/</code> ä¸­å­˜å‚¨ç›¸å…³çš„æœ¬æœºäºŒè¿›åˆ¶æ–‡ä»¶.</p>
<p>é€šå¸¸æˆ‘ä»¬åœ¨åˆ†ææ—¶éœ€è¦ä½¿ç”¨åº”ç”¨ç¨‹åº, å¦åˆ™å¯èƒ½ä¸ä¼šè®°å½•ä»»ä½•æ ·æœ¬. ä½†åœ¨è¿™ç§æƒ…å†µä¸‹, MixActivity å¯åŠ¨äº†ä¸€ä¸ªå¿™çº¿ç¨‹, å› æ­¤æˆ‘ä»¬åœ¨åˆ†ææ—¶ä¸éœ€è¦ä½¿ç”¨åº”ç”¨ç¨‹åº.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ stdio ç•Œé¢ä¸­æŠ¥å‘Š perf.data. </span></span><br><span class="line">$ ./report.py</span><br><span class="line">Cmdline: /data/data/simpleperf.example.cpp/simpleperf record ...</span><br><span class="line">Arch: arm64</span><br><span class="line">Event: task-clock:u (<span class="built_in">type</span> 1, config 1)</span><br><span class="line">Samples: 10023</span><br><span class="line">Event count: 10023000000</span><br><span class="line"></span><br><span class="line">Overhead  Command     Pid   Tid   Shared Object              Symbol</span><br><span class="line">27.04%    BusyThread  5703  5729  /system/lib64/libart.so    art::JniMethodStart(art::Thread*)</span><br><span class="line">25.87%    BusyThread  5703  5729  /system/lib64/libc.so      long StrToI&lt;long, ...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>report.py</code> åœ¨ stdio ç•Œé¢ä¸­æŠ¥å‘Šæ€§èƒ½åˆ†ææ•°æ®. å¦‚æœæŠ¥å‘Šä¸­æœ‰è®¸å¤šæœªçŸ¥ç¬¦å·, è¯·æ£€æŸ¥æ­¤å¤„.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ html ç•Œé¢ä¸­æŠ¥å‘Š perf.data. </span></span><br><span class="line">$ ./report_html.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æºä»£ç å’Œåæ±‡ç¼–. å¦‚æœ source_dirs è·¯å¾„ä¸æ­£ç¡®, è¯·è¿›è¡Œæ›´æ”¹. </span></span><br><span class="line">$ ./report_html.py --add_source_code --source_dirs path_of_SimpleperfExampleCpp --add_disassembly</span><br></pre></td></tr></table></figure>

<p><code>report_html.py</code> ä¼šåœ¨ <code>report.html</code> ä¸­ç”ŸæˆæŠ¥å‘Š, å¹¶å¼¹å‡ºæµè§ˆå™¨æ ‡ç­¾é¡µæ˜¾ç¤ºå®ƒ.</p>
<h3 id="è®°å½•å’ŒæŠ¥å‘Šè°ƒç”¨å›¾"><a href="#è®°å½•å’ŒæŠ¥å‘Šè°ƒç”¨å›¾" class="headerlink" title="è®°å½•å’ŒæŠ¥å‘Šè°ƒç”¨å›¾"></a>è®°å½•å’ŒæŠ¥å‘Šè°ƒç”¨å›¾</h3><p>æˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ­¥éª¤è®°å½•å’ŒæŠ¥å‘Šè°ƒç”¨å›¾.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®°å½•åŸºäº DWARF çš„è°ƒç”¨å›¾: åœ¨ -r é€‰é¡¹ä¸­æ·»åŠ  &quot;-g&quot;. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp -r <span class="string">&quot;-e task-clock:u -f 1000 --duration 10 -g&quot;</span> -lib path_of_SimpleperfExampleCpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•åŸºäºæ ˆå¸§çš„è°ƒç”¨å›¾: åœ¨ -r é€‰é¡¹ä¸­æ·»åŠ  &quot;--call-graph fp&quot;. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp -r <span class="string">&quot;-e task-clock:u -f 1000 --duration 10 --call-graph fp&quot;</span> \</span><br><span class="line">        -lib path_of_SimpleperfExampleCpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ stdio ç•Œé¢ä¸­æŠ¥å‘Šè°ƒç”¨å›¾. </span></span><br><span class="line">$ ./report.py -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ Python Tk ç•Œé¢ä¸­æŠ¥å‘Šè°ƒç”¨å›¾. </span></span><br><span class="line">$ ./report.py -g --gui</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ html ç•Œé¢ä¸­æŠ¥å‘Šè°ƒç”¨å›¾. </span></span><br><span class="line">$ ./report_html.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ flamegraphs ä¸­æŠ¥å‘Šè°ƒç”¨å›¾. </span></span><br><span class="line"><span class="comment"># åœ¨ Windows ä¸Š, ä½¿ç”¨ inferno.bat è€Œä¸æ˜¯ ./inferno.sh. </span></span><br><span class="line">$ ./inferno.sh -sc</span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡ç½‘é¡µæ¥å£è¿›è¡ŒæŠ¥å‘Š"><a href="#é€šè¿‡ç½‘é¡µæ¥å£è¿›è¡ŒæŠ¥å‘Š" class="headerlink" title="é€šè¿‡ç½‘é¡µæ¥å£è¿›è¡ŒæŠ¥å‘Š"></a>é€šè¿‡ç½‘é¡µæ¥å£è¿›è¡ŒæŠ¥å‘Š</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ report_html.py åœ¨ç½‘é¡µæµè§ˆå™¨ä¸­æ˜¾ç¤ºæ€§èƒ½åˆ†æç»“æœ. report_html.py é›†æˆäº†å›¾è¡¨ç»Ÿè®¡, æ ·æœ¬è¡¨, ç«ç„°å›¾, æºä»£ç æ³¨é‡Šå’Œåæ±‡ç¼–æ³¨é‡Š. å®ƒæ˜¯æ˜¾ç¤ºæŠ¥å‘Šçš„æ¨èæ–¹å¼.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./report_html.py</span><br></pre></td></tr></table></figure>

<h3 id="å±•ç¤ºç«ç„°å›¾"><a href="#å±•ç¤ºç«ç„°å›¾" class="headerlink" title="å±•ç¤ºç«ç„°å›¾"></a>å±•ç¤ºç«ç„°å›¾</h3><p>è¦æ˜¾ç¤ºç«ç„°å›¾, æˆ‘ä»¬éœ€è¦å…ˆè®°å½•è°ƒç”¨å›¾. ç«ç„°å›¾å¯ä»¥åœ¨ report_html.py çš„ &quot;Flamegraph&quot; æ ‡ç­¾ä¸­æ˜¾ç¤º. æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ inferno ç›´æ¥æ˜¾ç¤ºç«ç„°å›¾.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ Windows ä¸Š, ä½¿ç”¨ inferno.bat è€Œä¸æ˜¯ ./inferno.sh. </span></span><br><span class="line">$ ./inferno.sh -sc</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyZW5kYW5ncmVnZy9GbGFtZUdyYXBo">FlameGraph<i class="fa fa-external-link-alt"></i></span> æ¥ç”Ÿæˆç«ç„°å›¾. è¯·ç¡®ä¿å·²å®‰è£… Perl.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">./report_sample.py --symfs binary_cache &gt; out.perf</span><br><span class="line">FlameGraph/stackcollapse-perf.pl out.perf &gt; out.folded</span><br><span class="line">FlameGraph/flamegraph.pl out.folded &gt; a.svg</span><br></pre></td></tr></table></figure>

<h3 id="åœ¨-Android-Studio-ä¸­è¿›è¡ŒæŠ¥å‘Š"><a href="#åœ¨-Android-Studio-ä¸­è¿›è¡ŒæŠ¥å‘Š" class="headerlink" title="åœ¨ Android Studio ä¸­è¿›è¡ŒæŠ¥å‘Š"></a>åœ¨ Android Studio ä¸­è¿›è¡ŒæŠ¥å‘Š</h3><p>simpleperf çš„ <code>report-sample</code> å‘½ä»¤å¯ä»¥å°† <code>perf.data</code> è½¬æ¢ä¸º Android Studio CPU åˆ†æå™¨æ¥å—çš„ protobuf æ ¼å¼. è½¬æ¢å¯ä»¥åœ¨è®¾å¤‡ä¸Šæˆ–ä¸»æœºä¸Šå®Œæˆ. å¦‚æœåœ¨ä¸»æœºä¸Šæœ‰æ›´å¤šç¬¦å·ä¿¡æ¯, å»ºè®®ä½¿ç”¨ <code>--symdir</code> é€‰é¡¹åœ¨ä¸»æœºä¸Šè¿›è¡Œè½¬æ¢.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ simpleperf report-sample --protobuf --show-callchain -i perf.data -o perf.trace</span><br><span class="line"><span class="comment"># ç„¶ååœ¨ Android Studio ä¸­æ‰“å¼€ perf.trace è¿›è¡ŒæŸ¥çœ‹. </span></span><br></pre></td></tr></table></figure>

<h3 id="å»æ··æ·†-Java-ç¬¦å·"><a href="#å»æ··æ·†-Java-ç¬¦å·" class="headerlink" title="å»æ··æ·† Java ç¬¦å·"></a>å»æ··æ·† Java ç¬¦å·</h3><p>Java ç¬¦å·å¯èƒ½ä¼šè¢« ProGuard æ··æ·†. è¦åœ¨æŠ¥å‘Šä¸­æ¢å¤åŸå§‹ç¬¦å·, å¯ä»¥é€šè¿‡ <code>--proguard-mapping-file</code> å°† ProGuard æ˜ å°„æ–‡ä»¶ä¼ é€’ç»™ report è„šæœ¬æˆ– <code>report-sample</code> å‘½ä»¤.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./report_html.py --proguard-mapping-file proguard_mapping_file.txt</span><br></pre></td></tr></table></figure>

<h3 id="è®°å½•-CPU-æ—¶é—´å’Œé-CPU-æ—¶é—´"><a href="#è®°å½•-CPU-æ—¶é—´å’Œé-CPU-æ—¶é—´" class="headerlink" title="è®°å½• CPU æ—¶é—´å’Œé CPU æ—¶é—´"></a>è®°å½• CPU æ—¶é—´å’Œé CPU æ—¶é—´</h3><p>æˆ‘ä»¬å¯ä»¥è®°å½• CPU æ—¶é—´å’Œé CPU æ—¶é—´.</p>
<p>é¦–å…ˆæ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒ <code>trace-offcpu</code> åŠŸèƒ½.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./run_simpleperf_on_device.py list --show-features</span><br><span class="line">dwarf-based-call-graph</span><br><span class="line">trace-offcpu</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ”¯æŒ trace-offcpu åŠŸèƒ½, å®ƒä¼šæ˜¾ç¤ºåœ¨åŠŸèƒ½åˆ—è¡¨ä¸­. ç„¶åæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨å®ƒ.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./app_profiler.py -p simpleperf.example.cpp -a .SleepActivity -r <span class="string">&quot;-g -e task-clock:u -f 1000 --duration 10 --trace-offcpu&quot;</span> -lib path_of_SimpleperfExampleCpp</span><br><span class="line">./report_html.py --add_disassembly --add_source_code --source_dirs path_of_SimpleperfExampleCpp</span><br></pre></td></tr></table></figure>

<h3 id="ä»å¯åŠ¨å¼€å§‹åˆ†æ"><a href="#ä»å¯åŠ¨å¼€å§‹åˆ†æ" class="headerlink" title="ä»å¯åŠ¨å¼€å§‹åˆ†æ"></a>ä»å¯åŠ¨å¼€å§‹åˆ†æ</h3><p>æˆ‘ä»¬å¯ä»¥ä»åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œåˆ†æ.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¼€å§‹ simpleperf å½•åˆ¶, ç„¶åå¯åŠ¨è¦åˆ†æçš„ Activity. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp -a .MainActivity</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è®¾å¤‡ä¸Šæ‰‹åŠ¨å¯åŠ¨ Activity.</p>
<ol>
<li><p>ç¡®ä¿åº”ç”¨ç¨‹åºæ²¡æœ‰è¿è¡Œæˆ–ä¸æ˜¯æœ€è¿‘çš„åº”ç”¨ç¨‹åºä¹‹ä¸€.</p>
</li>
<li><p>å¼€å§‹ simpleperf å½•åˆ¶.</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./app_profiler.py -p simpleperf.example.cpp</span><br></pre></td></tr></table></figure></li>
<li><p>åœ¨è®¾å¤‡ä¸Šæ‰‹åŠ¨å¯åŠ¨åº”ç”¨ç¨‹åº.</p>
</li>
</ol>
<h3 id="åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­æ§åˆ¶è®°å½•"><a href="#åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­æ§åˆ¶è®°å½•" class="headerlink" title="åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­æ§åˆ¶è®°å½•"></a>åœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­æ§åˆ¶è®°å½•</h3><p>Simpleperf æ”¯æŒä»åº”ç”¨ç¨‹åºä»£ç ä¸­æ§åˆ¶è®°å½•. ä»¥ä¸‹æ˜¯å·¥ä½œæµç¨‹:</p>
<ol>
<li>è¿è¡Œ <code>api_profiler.py prepare -p &lt;package_name&gt;</code> ä»¥å…è®¸åº”ç”¨ç¨‹åºä½¿ç”¨ simpleperf è®°å½•è‡ªèº«. é»˜è®¤æƒ…å†µä¸‹, æƒé™åœ¨è®¾å¤‡é‡å¯åä¼šè¢«é‡ç½®. å› æ­¤, æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è®¾å¤‡é‡å¯åè¿è¡Œè¯¥è„šæœ¬. ä½†æ˜¯åœ¨ Android &gt;= 13 ä¸Š, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--days</code> é€‰é¡¹è®¾ç½®æƒé™æŒç»­çš„å¤©æ•°.</li>
<li>åœ¨åº”ç”¨ç¨‹åºä¸­é“¾æ¥ simpleperf app_api ä»£ç . åº”ç”¨ç¨‹åºéœ€è¦è®¾ç½®ä¸º debuggable æˆ– profileableFromShell, å¦‚ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvYW5kcm9pZF9hcHBsaWNhdGlvbl9wcm9maWxpbmcubWQjcHJlcGFyZS1hbi1hbmRyb2lkLWFwcGxpY2F0aW9u">Prepare an Android application<i class="fa fa-external-link-alt"></i></span> æ‰€è¿°. ç„¶å, åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ API æ¥å¼€å§‹/æš‚åœ/æ¢å¤/åœæ­¢è®°å½•. ä¸ºäº†å¼€å§‹è®°å½•, app_api ä¼š fork ä¸€ä¸ªè¿è¡Œ simpleperf çš„å­è¿›ç¨‹, å¹¶ä½¿ç”¨ç®¡é“æ–‡ä»¶å‘å­è¿›ç¨‹å‘é€å‘½ä»¤. è®°å½•å®Œæˆå, ä¼šç”Ÿæˆä¸€ä¸ªåˆ†ææ•°æ®æ–‡ä»¶.</li>
<li>è¿è¡Œ <code>api_profiler.py collect -p &lt;package_name&gt;</code> å°†åˆ†ææ•°æ®æ–‡ä»¶æ”¶é›†åˆ°ä¸»æœº.</li>
</ol>
<p>ç¤ºä¾‹å¯ä»¥åœ¨ demo ä¸­çš„ CppApi å’Œ JavaApi æ‰¾åˆ°.</p>
<h3 id="æ‰‹åŠ¨è§£ææ€§èƒ½åˆ†ææ•°æ®"><a href="#æ‰‹åŠ¨è§£ææ€§èƒ½åˆ†ææ•°æ®" class="headerlink" title="æ‰‹åŠ¨è§£ææ€§èƒ½åˆ†ææ•°æ®"></a>æ‰‹åŠ¨è§£ææ€§èƒ½åˆ†ææ•°æ®</h3><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç¼–å†™ Python è„šæœ¬æ¥æ‰‹åŠ¨è§£æåˆ†ææ•°æ®, é€šè¿‡ä½¿ç”¨ <a href="https://android.googlesource.com/platform/system/extras/+/main/simpleperf/doc/scripts_reference.md#simpleperf_report_libpy"><code>simpleperf_report_lib.py</code></a> åº“. ç¤ºä¾‹åŒ…æ‹¬ <code>report_sample.py</code> å’Œ<code>report_html.py</code>.</p>
<h2 id="æŸ¥çœ‹åˆ†æç»“æœ"><a href="#æŸ¥çœ‹åˆ†æç»“æœ" class="headerlink" title="æŸ¥çœ‹åˆ†æç»“æœ"></a>æŸ¥çœ‹åˆ†æç»“æœ</h2><p>ä½¿ç”¨ <code>simpleperf record</code> æˆ– <code>app_profiler.py</code> å, æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªåˆ†ææ•°æ®æ–‡ä»¶. è¯¥æ–‡ä»¶åŒ…å«ä¸€ä¸ªæ ·æœ¬åˆ—è¡¨. æ¯ä¸ªæ ·æœ¬éƒ½æœ‰æ—¶é—´æˆ³ã€çº¿ç¨‹ IDã€è°ƒç”¨æ ˆã€åœ¨æ­¤æ ·æœ¬ä¸­ä½¿ç”¨çš„äº‹ä»¶ï¼ˆå¦‚ cpu-cycles æˆ– cpu-clockï¼‰ç­‰. æˆ‘ä»¬æœ‰å¤šç§æŸ¥çœ‹åˆ†æç»“æœçš„é€‰æ‹©. æˆ‘ä»¬å¯ä»¥æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºæ ·æœ¬, æˆ–è€…æ˜¾ç¤ºèšåˆçš„ç«ç„°å›¾. æˆ‘ä»¬å¯ä»¥ä»¥æ–‡æœ¬æ ¼å¼æ˜¾ç¤ºæŠ¥å‘Š, æˆ–è€…åœ¨ä¸€äº›äº¤äº’å¼ UI ä¸­æ˜¾ç¤ºæŠ¥å‘Š.</p>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›æ¨èçš„æŸ¥çœ‹åˆ†æç»“æœçš„ UI. Google å¼€å‘è€…å¯ä»¥åœ¨ go/gmm-profiling ä¸­æ‰¾åˆ°æ›´å¤šç¤ºä¾‹.</p>
<ul>
<li>Continuous PProf UI (great flamegraph UI, but only available internally)</li>
<li>Firefox Profiler (great chronological UI)</li>
<li>FlameScope (great jank-finding UI)</li>
<li>Differential FlameGraph</li>
<li>Android Studio Profiler</li>
<li>Simpleperf HTML Report</li>
<li>PProf Interactive Command Line</li>
<li>Simpleperf Report Command Line</li>
<li>Custom Report Interface</li>
</ul>
<h3 id="Android-Studio-Profiler"><a href="#Android-Studio-Profiler" class="headerlink" title="Android Studio Profiler"></a>Android Studio Profiler</h3><p>Android Studio Profiler æ”¯æŒè®°å½•å’ŒæŠ¥å‘Šåº”ç”¨è¿›ç¨‹çš„åˆ†ææ•°æ®. å®ƒæ”¯æŒå‡ ç§è®°å½•æ–¹æ³•, åŒ…æ‹¬ä½¿ç”¨ simpleperf ä½œä¸ºåç«¯çš„æ–¹æ³•. æ‚¨å¯ä»¥ä½¿ç”¨ Android Studio Profiler è¿›è¡Œè®°å½•å’ŒæŠ¥å‘Š.</p>
<p>åœ¨ Android Studio ä¸­: Open View -&gt; Tool Windows -&gt; Profiler -&gt; Click + -&gt; Your Device -&gt; Profileable Processes -&gt; Your App</p>
<p>ç‚¹å‡» &quot;CPU&quot; å›¾è¡¨</p>
<p>é€‰æ‹© Callstack Sample Recording. å³ä½¿æ‚¨ä½¿ç”¨ Java, è¿™ä¹Ÿèƒ½æä¾›æ›´å¥½çš„å¯è§‚å¯Ÿæ€§, åŒ…æ‹¬ ARTã€malloc å’Œå†…æ ¸.</p>
<p>ç‚¹å‡» Record, åœ¨è®¾å¤‡ä¸Šè¿è¡Œæ‚¨çš„æµ‹è¯•, å®Œæˆåç‚¹å‡» Stop.</p>
<p>ç‚¹å‡»ä¸€ä¸ªçº¿ç¨‹è½¨è¿¹, å¹¶é€‰æ‹© &quot;Flame Chart&quot; ä»¥åœ¨å·¦ä¾§æŸ¥çœ‹æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„å›¾è¡¨, åœ¨å³ä¾§æŸ¥çœ‹èšåˆçš„ç«ç„°å›¾:</p>
<p>å¦‚æœæ‚¨å¸Œæœ›åœ¨è®°å½•é€‰é¡¹ä¸Šæœ‰æ›´å¤šçµæ´»æ€§, æˆ–å¸Œæœ›æ·»åŠ  proguard æ˜ å°„æ–‡ä»¶, å¯ä»¥ä½¿ç”¨ simpleperf è¿›è¡Œè®°å½•, å¹¶ä½¿ç”¨ Android Studio Profiler è¿›è¡ŒæŠ¥å‘Š.</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>simpleperf report-sample</code> å°† <code>perf.data</code> è½¬æ¢ä¸º Android Studio Profiler çš„è·Ÿè¸ªæ–‡ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°† perf.data è½¬æ¢ä¸º Android Studio Profiler çš„ perf.trace æ–‡ä»¶. </span></span><br><span class="line"><span class="comment"># å¦‚æœåœ¨ Mac/Windows ä¸Š, ä½¿ç”¨ç›¸åº”å¹³å°çš„ simpleperf ä¸»æœºå¯æ‰§è¡Œæ–‡ä»¶. </span></span><br><span class="line">bin/linux/x86_64/simpleperf report-sample --show-callchain --protobuf -i perf.data -o perf.trace</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ proguard æ˜ å°„æ–‡ä»¶å°† perf.data è½¬æ¢ä¸º perf.trace. </span></span><br><span class="line">bin/linux/x86_64/simpleperf report-sample --show-callchain --protobuf -i perf.data -o perf.trace \</span><br><span class="line">    --proguard-mapping-file proguard.map</span><br></pre></td></tr></table></figure>

<p>åœ¨ Android Studio ä¸­: æ‰“å¼€ File -&gt; Open -&gt; é€‰æ‹© perf.trace</p>
<hr>
<p>åœ¨åŸæ–‡ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2Mvdmlld190aGVfcHJvZmlsZS5tZA==">View the profile<i class="fa fa-external-link-alt"></i></span> æŸ¥çœ‹æ›´å¤š UI çš„ä»‹ç»å’Œç”¨æ³•.</p>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>Simpleperf</tag>
        <tag>Android</tag>
        <tag>å®‰å“æ€§èƒ½åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Simpleperf ä¸‰éƒ¨æ›² (äºŒ)</title>
    <url>//posts/2024/07/07/simpleperf2/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹æ€§èƒ½åˆ†æå·¥å…· <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvUkVBRE1FLm1k">Simpleperf<i class="fa fa-external-link-alt"></i></span> ä½¿ç”¨æ–‡æ¡£æ€»ç»“, ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯æ–‡æ¡£ç¿»è¯‘.</p>
<p>æœ¬ç¯‡åŸæ–‡è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvZXhlY3V0YWJsZV9jb21tYW5kc19yZWZlcmVuY2UubWQ=">Executable commands reference<i class="fa fa-external-link-alt"></i></span>.</p>
<span id="more"></span>

<h2 id="Simpleperf-æ˜¯å¦‚ä½•å·¥ä½œçš„"><a href="#Simpleperf-æ˜¯å¦‚ä½•å·¥ä½œçš„" class="headerlink" title="Simpleperf æ˜¯å¦‚ä½•å·¥ä½œçš„"></a>Simpleperf æ˜¯å¦‚ä½•å·¥ä½œçš„</h2><p>ç°ä»£ CPU æœ‰ä¸€ä¸ªåä¸ºæ€§èƒ½ç›‘æ§å•å…ƒ (PMU) çš„ç¡¬ä»¶ç»„ä»¶. PMUæœ‰å‡ ä¸ªç¡¬ä»¶è®¡æ•°å™¨, ç”¨äºè®¡æ•°è¯¸å¦‚å‘ç”Ÿäº†å¤šå°‘CPUå‘¨æœŸ, æ‰§è¡Œäº†å¤šå°‘æŒ‡ä»¤æˆ–å‘ç”Ÿäº†å¤šå°‘ç¼“å­˜æœªå‘½ä¸­ç­‰äº‹ä»¶.</p>
<p>Linux å†…æ ¸å°†è¿™äº›ç¡¬ä»¶è®¡æ•°å™¨å°è£…æˆç¡¬ä»¶æ€§èƒ½äº‹ä»¶. æ­¤å¤–, Linux å†…æ ¸è¿˜æä¾›ä¸ç¡¬ä»¶æ— å…³çš„è½¯ä»¶äº‹ä»¶å’Œè·Ÿè¸ªç‚¹äº‹ä»¶. Linux å†…æ ¸é€šè¿‡ <code>perf_event_open</code> ç³»ç»Ÿè°ƒç”¨å°†æ‰€æœ‰äº‹ä»¶æš´éœ²ç»™ç”¨æˆ·ç©ºé—´, è¿™ä¸ªè°ƒç”¨è¢« simpleperf ä½¿ç”¨.</p>
<p>Simpleperf æœ‰ä¸‰ä¸ªä¸»è¦å‘½ä»¤: <code>stat</code>, <code>record</code> å’Œ <code>report</code>.</p>
<p><code>stat</code> å‘½ä»¤æ€»ç»“åœ¨ä¸€æ®µæ—¶é—´å†…è¢«åˆ†æçš„è¿›ç¨‹ä¸­å‘ç”Ÿçš„äº‹ä»¶æ•°é‡. å…¶å·¥ä½œåŸç†å¦‚ä¸‹:</p>
<ul>
<li>æ ¹æ®ç”¨æˆ·é€‰é¡¹, simpleperf é€šè¿‡å¯¹å†…æ ¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ¥å¯ç”¨åˆ†æ.</li>
<li>åœ¨åˆ†æçš„è¿›ç¨‹è¿è¡Œæ—¶, å†…æ ¸å¯ç”¨è®¡æ•°å™¨.</li>
<li>åˆ†æç»“æŸå, simpleperf ä»å†…æ ¸è¯»å–è®¡æ•°å™¨, å¹¶æŠ¥å‘Šè®¡æ•°å™¨æ‘˜è¦.</li>
</ul>
<p><code>record</code> å‘½ä»¤åœ¨ä¸€æ®µæ—¶é—´å†…è®°å½•è¢«åˆ†æè¿›ç¨‹çš„æ ·æœ¬. å…¶å·¥ä½œåŸç†å¦‚ä¸‹:</p>
<ul>
<li>æ ¹æ®ç”¨æˆ·é€‰é¡¹, simpleperf é€šè¿‡å¯¹å†…æ ¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ¥å¯ç”¨åˆ†æ.</li>
<li>Simpleperf åœ¨ simpleperf å’Œå†…æ ¸ä¹‹é—´åˆ›å»ºæ˜ å°„ç¼“å†²åŒº.</li>
<li>åœ¨åˆ†æçš„è¿›ç¨‹è¿è¡Œæ—¶, å†…æ ¸å¯ç”¨è®¡æ•°å™¨.</li>
<li>æ¯å½“å‘ç”Ÿä¸€å®šæ•°é‡çš„äº‹ä»¶æ—¶, å†…æ ¸å°†æ ·æœ¬è½¬å‚¨åˆ°æ˜ å°„ç¼“å†²åŒº.</li>
<li>Simpleperf ä»æ˜ å°„ç¼“å†²åŒºè¯»å–æ ·æœ¬, å¹¶å°†åˆ†ææ•°æ®å­˜å‚¨åœ¨åä¸º<code>perf.data</code>çš„æ–‡ä»¶ä¸­.</li>
</ul>
<p><code>report</code> å‘½ä»¤è¯»å– <code>perf.data</code> æ–‡ä»¶å’Œä»»ä½•è¢«åˆ†æè¿›ç¨‹ä½¿ç”¨çš„å…±äº«åº“, å¹¶è¾“å‡ºæ˜¾ç¤ºæ—¶é—´èŠ±è´¹åœ¨å“ªäº›åœ°æ–¹çš„æŠ¥å‘Š.</p>
<p>Simpleperf æ”¯æŒä»¥ä¸‹å‡ ä¸ªå‘½ä»¤:</p>
<ul>
<li><code>debug-unwind</code> å‘½ä»¤: è°ƒè¯•/æµ‹è¯•åŸºäº DWARF çš„ç¦»çº¿å±•å¼€, ç”¨äºè°ƒè¯• simpleperf.</li>
<li><code>dump</code> å‘½ä»¤: è½¬å‚¨ <code>perf.data</code> ä¸­çš„å†…å®¹, ç”¨äºè°ƒè¯• simpleperf.</li>
<li><code>help</code> å‘½ä»¤: æ‰“å°å…¶ä»–å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯.</li>
<li><code>kmem</code> å‘½ä»¤: æ”¶é›†å†…æ ¸å†…å­˜åˆ†é…ä¿¡æ¯ (å°†è¢«Pythonè„šæœ¬æ›¿ä»£) .</li>
<li><code>list</code> å‘½ä»¤: åˆ—å‡º Android è®¾å¤‡ä¸Šæ”¯æŒçš„æ‰€æœ‰äº‹ä»¶ç±»å‹.</li>
<li><code>record</code> å‘½ä»¤: åˆ†æè¿›ç¨‹å¹¶å°†åˆ†ææ•°æ®å­˜å‚¨åœ¨ <code>perf.data</code> ä¸­.</li>
<li><code>report</code> å‘½ä»¤: æŠ¥å‘Š <code>perf.data</code> ä¸­çš„åˆ†ææ•°æ®.</li>
<li><code>report-sample</code> å‘½ä»¤: æŠ¥å‘Š <code>perf.data</code> ä¸­çš„æ¯ä¸ªæ ·æœ¬, ç”¨äºæ”¯æŒ simpleperf åœ¨ Android Studio ä¸­çš„é›†æˆ.</li>
<li><code>stat</code> å‘½ä»¤: åˆ†æè¿›ç¨‹å¹¶æ‰“å°è®¡æ•°å™¨æ‘˜è¦.</li>
</ul>
<p>æ¯ä¸ªå‘½ä»¤æ”¯æŒä¸åŒçš„é€‰é¡¹, å¯ä»¥é€šè¿‡å¸®åŠ©ä¿¡æ¯æŸ¥çœ‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰å‘½ä»¤. </span></span><br><span class="line">$ simpleperf --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å° record å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯. </span></span><br><span class="line">$ simpleperf record --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹æè¿°äº†æœ€å¸¸ç”¨çš„å‘½ä»¤, åˆ†åˆ«æ˜¯ list, stat, record å’Œ report.</p>
<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>è¿™ä¸ªå‘½ä»¤åˆ—å‡ºäº†è®¾å¤‡ä¸Šæ‰€æœ‰å¯ç”¨çš„äº‹ä»¶åˆ—è¡¨. ä¸åŒçš„è®¾å¤‡å¯èƒ½æ”¯æŒä¸åŒçš„äº‹ä»¶, å› ä¸ºå®ƒä»¬å…·æœ‰ä¸åŒçš„ç¡¬ä»¶å’Œå†…æ ¸.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ simpleperf list</span><br><span class="line">List of hw-cache events:</span><br><span class="line">  branch-loads</span><br><span class="line">  ...</span><br><span class="line">List of hardware events:</span><br><span class="line">  cpu-cycles</span><br><span class="line">  instructions</span><br><span class="line">  ...</span><br><span class="line">List of software events:</span><br><span class="line">  cpu-clock</span><br><span class="line">  task-clock</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>åœ¨ ARM/ARM64 æ¶æ„ä¸Š, <code>list</code> å‘½ä»¤è¿˜æ˜¾ç¤ºäº†ä¸€ç»„åŸå§‹äº‹ä»¶åˆ—è¡¨, è¿™äº›äº‹ä»¶æ˜¯è®¾å¤‡ä¸Š ARM æ€§èƒ½ç›‘è§†å™¨å•å…ƒ (PMU) æ”¯æŒçš„äº‹ä»¶. å†…æ ¸å·²ç»å°†å…¶ä¸­çš„ä¸€éƒ¨åˆ†åŒ…è£…æˆäº†ç¡¬ä»¶äº‹ä»¶å’Œç¡¬ä»¶ç¼“å­˜äº‹ä»¶. ä¾‹å¦‚, <code>raw-cpu-cycles</code> è¢«åŒ…è£…æˆäº† <code>cpu-cycles</code>, <code>raw-instruction-retired</code> è¢«åŒ…è£…æˆäº†<code>instructions</code>. åŸå§‹äº‹ä»¶çš„æä¾›æ˜¯ä¸ºäº†åœ¨æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨è®¾å¤‡ä¸Šæ”¯æŒçš„æŸäº›äº‹ä»¶æ—¶, ä½†ä¸å¹¸çš„æ˜¯å†…æ ¸æ²¡æœ‰å°†å…¶åŒ…è£…æˆç¡¬ä»¶äº‹ä»¶æ—¶ä½¿ç”¨.</p>
<h2 id="stat"><a href="#stat" class="headerlink" title="stat"></a>stat</h2><p>stat å‘½ä»¤ç”¨äºè·å–è¢«åˆ†æè¿›ç¨‹çš„äº‹ä»¶è®¡æ•°å™¨å€¼. é€šè¿‡ä¼ é€’é€‰é¡¹, æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªäº›äº‹ä»¶, ç›‘æ§å“ªäº›è¿›ç¨‹/çº¿ç¨‹, ç›‘æ§å¤šé•¿æ—¶é—´ä»¥åŠæ‰“å°é—´éš”.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Stat using default events (cpu-cycles,instructions,...), and monitor process 7394 for 10 seconds.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p 7394 --duration 10</span><br><span class="line">Performance counter statistics:</span><br><span class="line"></span><br><span class="line"><span class="comment">#         count  event_name                # count / runtime</span></span><br><span class="line">     16,513,564  cpu-cycles                <span class="comment"># 1.612904 GHz</span></span><br><span class="line">      4,564,133  stalled-cycles-frontend   <span class="comment"># 341.490 M/sec</span></span><br><span class="line">      6,520,383  stalled-cycles-backend    <span class="comment"># 591.666 M/sec</span></span><br><span class="line">      4,900,403  instructions              <span class="comment"># 612.859 M/sec</span></span><br><span class="line">         47,821  branch-misses             <span class="comment"># 6.085 M/sec</span></span><br><span class="line">  25.274251(ms)  task-clock                <span class="comment"># 0.002520 cpus used</span></span><br><span class="line">              4  context-switches          <span class="comment"># 158.264 /sec</span></span><br><span class="line">            466  page-faults               <span class="comment"># 18.438 K/sec</span></span><br><span class="line"></span><br><span class="line">Total <span class="built_in">test</span> time: 10.027923 seconds.</span><br></pre></td></tr></table></figure>

<h3 id="é€‰æ‹©è¦ç»Ÿè®¡çš„äº‹ä»¶"><a href="#é€‰æ‹©è¦ç»Ÿè®¡çš„äº‹ä»¶" class="headerlink" title="é€‰æ‹©è¦ç»Ÿè®¡çš„äº‹ä»¶"></a>é€‰æ‹©è¦ç»Ÿè®¡çš„äº‹ä»¶</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-e</code> é€‰é¡¹é€‰æ‹©è¦ä½¿ç”¨çš„äº‹ä»¶ (event).</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Stat event cpu-cycles.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -e cpu-cycles -p 11904 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stat event cache-references and cache-misses.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -e cache-references,cache-misses -p 11904 --duration 10</span><br></pre></td></tr></table></figure>

<p>å½“è¿è¡Œ stat å‘½ä»¤æ—¶, å¦‚æœç¡¬ä»¶äº‹ä»¶çš„æ•°é‡å¤§äº PMU å¯ç”¨çš„ç¡¬ä»¶è®¡æ•°å™¨æ•°é‡, å†…æ ¸ä¼šåœ¨äº‹ä»¶ä¹‹é—´å…±äº«ç¡¬ä»¶è®¡æ•°å™¨, å› æ­¤æ¯ä¸ªäº‹ä»¶ä»…åœ¨æ€»æ—¶é—´çš„ä¸€éƒ¨åˆ†è¢«ç›‘æ§. ç»“æœ, æ˜¾ç¤ºçš„äº‹ä»¶æ•°é‡å°äºå®é™…å‘ç”Ÿçš„äº‹ä»¶æ•°é‡. ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Stat using event cache-references, cache-references:u,....</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p 7394 -e cache-references,cache-references:u,cache-references:k \</span><br><span class="line">      -e cache-misses,cache-misses:u,cache-misses:k,instructions --duration 1</span><br><span class="line">Performance counter statistics:</span><br><span class="line"></span><br><span class="line"><span class="comment">#   count  event_name           # count / runtime</span></span><br><span class="line">  490,713  cache-references     <span class="comment"># 151.682 M/sec</span></span><br><span class="line">  899,652  cache-references:u   <span class="comment"># 130.152 M/sec</span></span><br><span class="line">  855,218  cache-references:k   <span class="comment"># 111.356 M/sec</span></span><br><span class="line">   61,602  cache-misses         <span class="comment"># 7.710 M/sec</span></span><br><span class="line">   33,282  cache-misses:u       <span class="comment"># 5.050 M/sec</span></span><br><span class="line">   11,662  cache-misses:k       <span class="comment"># 4.478 M/sec</span></span><br><span class="line">        0  instructions         <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">Total <span class="built_in">test</span> time: 1.000867 seconds.</span><br><span class="line">simpleperf W cmd_stat.cpp:946] It seems the number of hardware events are more than the number of</span><br><span class="line">available CPU PMU hardware counters. That will trigger hardware counter</span><br><span class="line">multiplexing. As a result, events are not counted all the time processes</span><br><span class="line">running, and event counts are smaller than what really happens.</span><br><span class="line">Use --print-hw-counter to show available hardware counters.</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­, æˆ‘ä»¬ç›‘æ§äº† 7 ä¸ªäº‹ä»¶. æ¯ä¸ªäº‹ä»¶ä»…åœ¨æ€»æ—¶é—´çš„ä¸€éƒ¨åˆ†è¢«ç›‘æ§. å› ä¸º <code>cache-references</code> çš„æ•°é‡å°äº <code>cache-references:u</code> (ä»…åœ¨ç”¨æˆ·ç©ºé—´çš„ <code>cache-references</code>) å’Œ <code>cache-references:k</code> (ä»…åœ¨å†…æ ¸ä¸­çš„ <code>cache-references</code>) . æŒ‡ä»¤æ•°ä¸ºé›¶. åœ¨æ‰“å°ç»“æœå, simpleperf ä¼šæ£€æŸ¥ CPU æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç¡¬ä»¶è®¡æ•°å™¨æ¥åŒæ—¶è®¡æ•°ç¡¬ä»¶äº‹ä»¶. å¦‚æœæ²¡æœ‰, å®ƒä¼šæ‰“å°ä¸€ä¸ªè­¦å‘Š.</p>
<p>ä¸ºäº†é¿å…ç¡¬ä»¶è®¡æ•°å™¨å¤ç”¨, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>simpleperf stat --print-hw-counter</code> æ¥æ˜¾ç¤ºæ¯ä¸ª CPU ä¸Šçš„å¯ç”¨è®¡æ•°å™¨. ç„¶åä¸è¦ç›‘æ§æ¯”å¯ç”¨è®¡æ•°å™¨æ›´å¤šçš„ç¡¬ä»¶äº‹ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ simpleperf <span class="built_in">stat</span> --print-hw-counter</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 0.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 1.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 2.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 3.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 4.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 5.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 6.</span><br><span class="line">There are 2 CPU PMU hardware counters available on cpu 7.</span><br></pre></td></tr></table></figure>

<p>å½“å‘ç”Ÿè®¡æ•°å™¨å¤ç”¨æ—¶, æ— æ³•ä¿è¯å“ªäº›äº‹ä»¶åœ¨ä½•æ—¶è¢«ç›‘æ§. å¦‚æœæˆ‘ä»¬å¸Œæœ›ç¡®ä¿æŸäº›äº‹ä»¶å§‹ç»ˆåŒæ—¶è¢«ç›‘æ§, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--group</code> é€‰é¡¹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Stat using event cache-references, cache-references:u,....</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p 7964 --group cache-references,cache-misses \</span><br><span class="line">      --group cache-references:u,cache-misses:u --group cache-references:k,cache-misses:k \</span><br><span class="line">      --duration 1</span><br><span class="line">Performance counter statistics:</span><br><span class="line"></span><br><span class="line"><span class="comment">#     count  event_name           # count / runtime</span></span><br><span class="line">  2,088,463  cache-references     <span class="comment"># 181.360 M/sec</span></span><br><span class="line">     47,871  cache-misses         <span class="comment"># 2.292164% miss rate</span></span><br><span class="line">  1,277,600  cache-references:u   <span class="comment"># 136.419 M/sec</span></span><br><span class="line">     25,977  cache-misses:u       <span class="comment"># 2.033265% miss rate</span></span><br><span class="line">    326,305  cache-references:k   <span class="comment"># 74.724 M/sec</span></span><br><span class="line">     13,596  cache-misses:k       <span class="comment"># 4.166654% miss rate</span></span><br><span class="line"></span><br><span class="line">Total <span class="built_in">test</span> time: 1.029729 seconds.</span><br><span class="line">simpleperf W cmd_stat.cpp:946] It seems the number of hardware events are more than the number of</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="é€‰æ‹©è¦ç»Ÿè®¡çš„ç›®æ ‡"><a href="#é€‰æ‹©è¦ç»Ÿè®¡çš„ç›®æ ‡" class="headerlink" title="é€‰æ‹©è¦ç»Ÿè®¡çš„ç›®æ ‡"></a>é€‰æ‹©è¦ç»Ÿè®¡çš„ç›®æ ‡</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-p</code> æˆ–<code>-t</code> é€‰é¡¹é€‰æ‹©è¦ç›‘æ§çš„è¿›ç¨‹æˆ–çº¿ç¨‹. ç›‘æ§ä¸€ä¸ªè¿›ç¨‹ç›¸å½“äºç›‘æ§è¯¥è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹. Simpleperf è¿˜å¯ä»¥æ´¾ç”Ÿä¸€ä¸ªå­è¿›ç¨‹æ¥è¿è¡Œæ–°å‘½ä»¤, ç„¶åç›‘æ§è¯¥å­è¿›ç¨‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç»Ÿè®¡è¿›ç¨‹ 11904 å’Œ 11905.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p 11904,11905 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡åå­—é‡ŒåŒ…å« &quot;chrome&quot; çš„è¿›ç¨‹.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p chrome --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­£åˆ™è¡¨è¾¾å¼ç»Ÿè®¡è¿›ç¨‹å.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p <span class="string">&quot;chrome:(privileged|sandboxed)&quot;</span> --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡çº¿ç¨‹ 11904 å’Œ 11905.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -t 11904,11905 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯å­è¿›ç¨‹ ls å¹¶è¿›è¡Œç»Ÿè®¡.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿè®¡å®‰å“åº”ç”¨, åœ¨é root è®¾å¤‡ä¸Š, åªèƒ½ç»Ÿè®¡ debuggable</span></span><br><span class="line"><span class="comment"># æˆ–è€… profileable from shell çš„åº”ç”¨.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> --app simpleperf.example.cpp --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»…ç»Ÿè®¡åº”ç”¨çš„æŸä¸ªçº¿ç¨‹.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> --app simpleperf.example.cpp -t 11904 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ -a è¿›è¡Œç³»ç»ŸèŒƒå›´çš„ç»Ÿè®¡.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -a --duration 10</span><br></pre></td></tr></table></figure>

<h3 id="å†³å®šç»Ÿè®¡çš„æ—¶é•¿"><a href="#å†³å®šç»Ÿè®¡çš„æ—¶é•¿" class="headerlink" title="å†³å®šç»Ÿè®¡çš„æ—¶é•¿"></a>å†³å®šç»Ÿè®¡çš„æ—¶é•¿</h3><p>åœ¨ç›‘æ§ç°æœ‰çº¿ç¨‹æ—¶, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--duration</code> é€‰é¡¹æ¥å†³å®šç›‘æ§çš„æ—¶é•¿. åœ¨ç›‘æ§è¿è¡Œæ–°å‘½ä»¤çš„å­è¿›ç¨‹æ—¶, simpleperf ä¼šä¸€ç›´ç›‘æ§ç›´åˆ°å­è¿›ç¨‹ç»“æŸ. åœ¨è¿™ç§æƒ…å†µä¸‹, æˆ‘ä»¬å¯ä»¥éšæ—¶ä½¿ç”¨ Ctrl-C æ¥åœæ­¢ç›‘æ§.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Stat process 11904 for 10 seconds.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p 11904 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stat until the child process running `ls` finishes.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Stop monitoring using Ctrl-C.</span></span><br><span class="line">$ simpleperf <span class="built_in">stat</span> -p 11904 --duration 10</span><br><span class="line">^C</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ‚¨å¸Œæœ›ç¼–å†™è„šæœ¬æ¥æ§åˆ¶ç›‘æ§æ—¶é•¿, å¯ä»¥å‘ simpleperf å‘é€ <code>SIGINT</code>, <code>SIGTERM</code> æˆ– <code>SIGHUP</code> ä¿¡å·æ¥åœæ­¢ç›‘æ§.</p>
<hr>
<p>æ›´å¤šå†…å®¹è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvZXhlY3V0YWJsZV9jb21tYW5kc19yZWZlcmVuY2UubWQjdGhlLXN0YXQtY29tbWFuZA==">The stat command<i class="fa fa-external-link-alt"></i></span>.</p>
<h2 id="record"><a href="#record" class="headerlink" title="record"></a>record</h2><p>record å‘½ä»¤ç”¨äºè½¬å‚¨è¢«åˆ†æè¿›ç¨‹çš„æ ·æœ¬. æ¯ä¸ªæ ·æœ¬å¯ä»¥åŒ…å«ç”Ÿæˆæ ·æœ¬çš„æ—¶é—´, è‡ªä¸Šæ¬¡æ ·æœ¬ä»¥æ¥çš„äº‹ä»¶æ•°é‡, çº¿ç¨‹çš„ç¨‹åºè®¡æ•°å™¨, çº¿ç¨‹çš„è°ƒç”¨é“¾ç­‰ä¿¡æ¯.</p>
<p>é€šè¿‡ä¼ é€’é€‰é¡¹, æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨å“ªäº›äº‹ä»¶, ç›‘æ§å“ªäº›è¿›ç¨‹/çº¿ç¨‹, è½¬å‚¨æ ·æœ¬çš„é¢‘ç‡, ç›‘æ§å¤šé•¿æ—¶é—´, ä»¥åŠå­˜å‚¨æ ·æœ¬çš„ä½ç½®.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Record on process 7394 for 10 seconds, using default event (cpu-cycles), </span></span><br><span class="line"><span class="comment"># using default sample frequency (4000 samples per second),</span></span><br><span class="line"><span class="comment"># writing records to perf.data.</span></span><br><span class="line">$ simpleperf record -p 7394 --duration 10</span><br><span class="line">simpleperf I cmd_record.cpp:316] Samples recorded: 21430. Samples lost: 0.</span><br></pre></td></tr></table></figure>

<h3 id="é€‰æ‹©è¦è®°å½•çš„äº‹ä»¶"><a href="#é€‰æ‹©è¦è®°å½•çš„äº‹ä»¶" class="headerlink" title="é€‰æ‹©è¦è®°å½•çš„äº‹ä»¶"></a>é€‰æ‹©è¦è®°å½•çš„äº‹ä»¶</h3><p>é»˜è®¤æƒ…å†µä¸‹, ä½¿ç”¨ <code>cpu-cycles</code> äº‹ä»¶æ¥è¯„ä¼°æ¶ˆè€—çš„ CPU å‘¨æœŸ. ä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>-e</code> é€‰é¡¹ä½¿ç”¨å…¶ä»–äº‹ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Record using event instructions.</span></span><br><span class="line">$ simpleperf record -e instructions -p 11904 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record using task-clock, which shows the passed CPU time in nanoseconds.</span></span><br><span class="line">$ simpleperf record -e task-clock -p 11904 --duration 10</span><br></pre></td></tr></table></figure>

<h3 id="é€‰æ‹©è¦è®°å½•çš„ç›®æ ‡"><a href="#é€‰æ‹©è¦è®°å½•çš„ç›®æ ‡" class="headerlink" title="é€‰æ‹©è¦è®°å½•çš„ç›®æ ‡"></a>é€‰æ‹©è¦è®°å½•çš„ç›®æ ‡</h3><p><code>record</code> å‘½ä»¤ä¸­é€‰æ‹©ç›®æ ‡çš„æ–¹å¼ç±»ä¼¼äº <code>stat</code> å‘½ä»¤.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Record process 11904 and 11905.</span></span><br><span class="line">$ simpleperf record -p 11904,11905 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record processes with name containing &quot;chrome&quot;.</span></span><br><span class="line">$ simpleperf record -p chrome --duration 10</span><br><span class="line"><span class="comment"># Record processes with name containing part matching regex &quot;chrome:(privileged|sandboxed)&quot;.</span></span><br><span class="line">$ simpleperf record -p <span class="string">&quot;chrome:(privileged|sandboxed)&quot;</span> --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record thread 11904 and 11905.</span></span><br><span class="line">$ simpleperf record -t 11904,11905 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record a child process running `ls`.</span></span><br><span class="line">$ simpleperf record <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Record the process of an Android application. On non-root devices, this only works for debuggable</span></span><br><span class="line"><span class="comment"># or profileable from shell apps.</span></span><br><span class="line">$ simpleperf record --app simpleperf.example.cpp --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record only selected thread 11904 in an app.</span></span><br><span class="line">$ simpleperf record --app simpleperf.example.cpp -t 11904 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record system wide.</span></span><br><span class="line">$ simpleperf record -a --duration 10</span><br></pre></td></tr></table></figure>

<h3 id="è®¾ç½®è®°å½•é¢‘ç‡"><a href="#è®¾ç½®è®°å½•é¢‘ç‡" class="headerlink" title="è®¾ç½®è®°å½•é¢‘ç‡"></a>è®¾ç½®è®°å½•é¢‘ç‡</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>-f</code> æˆ– <code>-c</code> é€‰é¡¹è®¾ç½®è½¬å‚¨è®°å½•çš„é¢‘ç‡. ä¾‹å¦‚, <code>-f 4000</code> è¡¨ç¤ºåœ¨ç›‘æ§çš„çº¿ç¨‹è¿è¡Œæ—¶, æ¯ç§’é’Ÿå¤§çº¦è½¬å‚¨ 4000 æ¡è®°å½•. å¦‚æœä¸€ä¸ªç›‘æ§çš„çº¿ç¨‹åœ¨ä¸€ç§’é’Ÿå†…è¿è¡Œäº† 0.2 ç§’ (åœ¨å…¶ä»–æ—¶é—´å®ƒå¯èƒ½è¢«æŠ¢å æˆ–é˜»å¡) , simpleperf æ¯ç§’é’Ÿå¤§çº¦è½¬å‚¨ 4000 * 0.2 / 1.0 = 800 æ¡è®°å½•. å¦ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨ <code>-c</code>. ä¾‹å¦‚, <code>-c 10000</code> è¡¨ç¤ºæ¯å½“å‘ç”Ÿ 10000 ä¸ªäº‹ä»¶æ—¶è½¬å‚¨ä¸€æ¡è®°å½•.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨é‡‡æ ·é¢‘ç‡ 1000 è¿›è¡Œè®°å½•: æ¯ç§’è¿è¡Œé‡‡æ · 1000 æ¬¡. </span></span><br><span class="line">$ simpleperf record -f 1000 -p 11904,11905 --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨é‡‡æ ·å‘¨æœŸ 100000 è¿›è¡Œè®°å½•: æ¯ 100000 ä¸ªäº‹ä»¶é‡‡æ ·ä¸€æ¬¡. </span></span><br><span class="line">$ simpleperf record -c 100000 -t 11904,11905 --duration 10</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†é¿å…ç”Ÿæˆæ ·æœ¬èŠ±è´¹è¿‡å¤šæ—¶é—´, kernel &gt;= 3.10 è®¾ç½®äº†ç”¨äºç”Ÿæˆæ ·æœ¬çš„æœ€å¤§ CPU æ—¶é—´ç™¾åˆ†æ¯” (é»˜è®¤æ˜¯ 25%) , å¹¶åœ¨è¾¾åˆ°è¯¥é™åˆ¶æ—¶é™ä½å…è®¸çš„æœ€å¤§é‡‡æ ·é¢‘ç‡. simpleperf ä½¿ç”¨ <code>--cpu-percent</code> é€‰é¡¹æ¥è°ƒæ•´å®ƒ, ä½†è¿™éœ€è¦ root æƒé™æˆ–è¿è¡Œ Android &gt;= Q.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨é‡‡æ ·é¢‘ç‡ 10000 è¿›è¡Œè®°å½•, å…è®¸çš„æœ€å¤§ CPU ä½¿ç”¨ç‡ä¸º 50%. </span></span><br><span class="line">$ simpleperf record -f 1000 -p 11904,11905 --duration 10 --cpu-percent 50</span><br></pre></td></tr></table></figure>

<h3 id="å†³å®šè®°å½•çš„æ—¶é•¿"><a href="#å†³å®šè®°å½•çš„æ—¶é•¿" class="headerlink" title="å†³å®šè®°å½•çš„æ—¶é•¿"></a>å†³å®šè®°å½•çš„æ—¶é•¿</h3><p>ä¸ <code>stat</code> ç±»ä¼¼, ä¹Ÿå¯ä»¥é€šè¿‡ <code>--duration</code> æ¥æ§åˆ¶è®°å½•æ—¶é•¿.</p>
<h3 id="è®¾ç½®å­˜å‚¨åˆ†ææ•°æ®çš„è·¯å¾„"><a href="#è®¾ç½®å­˜å‚¨åˆ†ææ•°æ®çš„è·¯å¾„" class="headerlink" title="è®¾ç½®å­˜å‚¨åˆ†ææ•°æ®çš„è·¯å¾„"></a>è®¾ç½®å­˜å‚¨åˆ†ææ•°æ®çš„è·¯å¾„</h3><p>é»˜è®¤æƒ…å†µä¸‹, simpleperf å°†åˆ†ææ•°æ®å­˜å‚¨åœ¨å½“å‰ç›®å½•çš„ <code>perf.data</code> æ–‡ä»¶ä¸­. ä½†å¯ä»¥ä½¿ç”¨ <code>-o</code> é€‰é¡¹æ›´æ”¹å­˜å‚¨è·¯å¾„.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Write records to data/perf2.data.</span></span><br><span class="line">$ simpleperf record -p 11904 -o data/perf2.data --duration 10</span><br></pre></td></tr></table></figure>

<h3 id="è®°å½•è°ƒç”¨å›¾"><a href="#è®°å½•è°ƒç”¨å›¾" class="headerlink" title="è®°å½•è°ƒç”¨å›¾"></a>è®°å½•è°ƒç”¨å›¾</h3><p>è°ƒç”¨å›¾æ˜¯æ˜¾ç¤ºå‡½æ•°è°ƒç”¨å…³ç³»çš„æ ‘ç»“æ„. ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">    FunctionOne();</span><br><span class="line">    FunctionTwo();</span><br><span class="line">&#125;</span><br><span class="line">FunctionOne() &#123;</span><br><span class="line">    FunctionTwo();</span><br><span class="line">    FunctionThree();</span><br><span class="line">&#125;</span><br><span class="line">a call graph:</span><br><span class="line">    main-&gt; FunctionOne</span><br><span class="line">       |    |</span><br><span class="line">       |    |-&gt; FunctionTwo</span><br><span class="line">       |    |-&gt; FunctionThree</span><br><span class="line">       |</span><br><span class="line">       |-&gt; FunctionTwo</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨å›¾æ˜¾ç¤ºäº†ä¸€ä¸ªå‡½æ•°å¦‚ä½•è°ƒç”¨å…¶ä»–å‡½æ•°, åå‘è°ƒç”¨å›¾åˆ™æ˜¾ç¤ºä¸€ä¸ªå‡½æ•°å¦‚ä½•è¢«å…¶ä»–å‡½æ•°è°ƒç”¨. è¦æ˜¾ç¤ºè°ƒç”¨å›¾, æˆ‘ä»¬é¦–å…ˆéœ€è¦è®°å½•å®ƒ, ç„¶åå†æŠ¥å‘Šå®ƒ.</p>
<p>æœ‰ä¸¤ç§è®°å½•è°ƒç”¨å›¾çš„æ–¹æ³•, ä¸€ç§æ˜¯è®°å½•åŸºäº dwarf çš„è°ƒç”¨å›¾, å¦ä¸€ç§æ˜¯è®°å½•åŸºäºæ ˆå¸§çš„è°ƒç”¨å›¾. è®°å½•åŸºäº dwarf çš„è°ƒç”¨å›¾éœ€è¦æœ¬åœ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„è°ƒè¯•ä¿¡æ¯æ”¯æŒ. è€Œè®°å½•åŸºäºæ ˆå¸§çš„è°ƒç”¨å›¾åˆ™éœ€è¦æ ˆå¸§å¯„å­˜å™¨çš„æ”¯æŒ.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®°å½•åŸºäº dwarf çš„è°ƒç”¨å›¾</span></span><br><span class="line">$ simpleperf record -p 11904 -g --duration 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•åŸºäºæ ˆå¸§çš„è°ƒç”¨å›¾</span></span><br><span class="line">$ simpleperf record -p 11904 --call-graph fp --duration 10</span><br></pre></td></tr></table></figure>

<h3 id="è®°å½•-CPU-æ—¶é—´å’Œé-CPU-æ—¶é—´"><a href="#è®°å½•-CPU-æ—¶é—´å’Œé-CPU-æ—¶é—´" class="headerlink" title="è®°å½• CPU æ—¶é—´å’Œé CPU æ—¶é—´"></a>è®°å½• CPU æ—¶é—´å’Œé CPU æ—¶é—´</h3><p>Simpleperf æ˜¯ä¸€ä¸ª CPU åˆ†æå™¨, å®ƒåªåœ¨çº¿ç¨‹è¿è¡Œåœ¨ CPU ä¸Šæ—¶ç”Ÿæˆæ ·æœ¬. ä½†æœ‰æ—¶æˆ‘ä»¬æƒ³çŸ¥é“çº¿ç¨‹åœ¨ CPU å¤–çš„æ—¶é—´æ˜¯å¦‚ä½•èŠ±è´¹çš„ (ä¾‹å¦‚, è¢«å…¶ä»–çº¿ç¨‹æŠ¢å , åœ¨ IO ä¸­é˜»å¡æˆ–ç­‰å¾…æŸäº›äº‹ä»¶) . ä¸ºæ”¯æŒè¿™ä¸€ç‚¹, simpleperf åœ¨ <code>record</code> å‘½ä»¤ä¸­æ·»åŠ äº† <code>--trace-offcpu</code> é€‰é¡¹. å½“ä½¿ç”¨ <code>--trace-offcpu</code> æ—¶, simpleperf ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:</p>
<ol>
<li>ä»…å…è®¸ <code>cpu-clock``/task-clock</code> äº‹ä»¶ä¸ <code>--trace-offcpu</code> ä¸€èµ·ä½¿ç”¨, è¿™ä½¿å¾— simpleperf ä¸º <code>cpu-clock</code> äº‹ä»¶ç”Ÿæˆ on-cpu æ ·æœ¬.</li>
<li>Simpleperf è¿˜ç›‘æ§ <code>sched:sched_switch</code> äº‹ä»¶, æ¯æ¬¡ç›‘æ§çš„çº¿ç¨‹ä» CPU ä¸Šè°ƒåº¦æ—¶ä¼šç”Ÿæˆä¸€ä¸ª sched_switch æ ·æœ¬.</li>
<li>Simpleperf è¿˜è®°å½•ä¸Šä¸‹æ–‡åˆ‡æ¢è®°å½•, å› æ­¤å®ƒçŸ¥é“çº¿ç¨‹ä½•æ—¶è¢«è°ƒåº¦å› CPU.</li>
</ol>
<p>simpleperf ä¸ºçº¿ç¨‹æ”¶é›†çš„æ ·æœ¬å’Œä¸Šä¸‹æ–‡åˆ‡æ¢è®°å½•å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img data-src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABSgAAAHmCAMAAABH4pBtAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABvFBMVEX////u7u63t7eLiYhXVFMzMzO3trVXTUCLcU+3kF3lsGqIiopUVlf29vZpZ2RGQDvDmWH/w3S1trZGUFRfd4V1ma6Mvtp6eHZpWUP2vHFkZ2g+QUV6o7qZ0vLDw8Put253eHlOXWSUy+lGQ0GQxOLl5eVAQkNCQ0VGQDpCPzhDQUB6ZEhkVkE7QEM7QEGIbk5WaXVLWWFFQDhAOzdddYJgU0CamJd6d3P7wHJGQDiXz++BrcVtjqHbqWjPoWSaelNXSz6HtdBFT1Sohldmg5OIuNJ1YUZUSz5UZnFDTlP7+/t6eXhycXCjo6NZWVlwcXHb29tPT09OTk7Nzc1QUFCoqKampqY8QUXT09PFxcWnqKg2NjaYmJiDg4NAQECoqKhWVlbW1tZfX1+VlZXPz8+Hh4dhYWF0dHRxcXFbW1tubm53d3dXV1eLi4tGRkZ6enppaWmampqoqKeLiYdXUEh6bVy3n3+LiolGQj+ah27bvZT72Kf/26mamZnlxZpGRULDqoZpaGdGQj7uzZ9XVlTPtI16eXf206NGQT6ok3eLemRpX1JGQ0LPz85paGaamZixsbHDw8JgV027o4EizP2+AAAAAWJLR0QAiAUdSAAAAAlwSFlzAAAYmwAAGJsBSXWDlAAAAAd0SU1FB+ULGAAgOjuok+AAACpFSURBVHja7Z2LfxtXdphNxscrKpZjZkXJSmQqls3utq5a903JlmRZbtLSTcptnU0TJ6t2ozzarr1ZeWYiYKARLAgePBS72/7DvfcOniRGBEGCc8/F9/1+pkEMBjjn8Oibe+eFV14BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAmM3a+m+8KlApr/7G+lrVfQAA5bwmPzi3cR4qZePcD+S1wR9kbf03X69a3FXw+m+ysQBfufDGb725CR7w5m+9ccH+RX5bfnhx69IKsnXxh/Lbg7Zc1VnO5MyCGvjE5beuVG0IKLjy1mWz4fqd37369spy9Xd/x20sVnaWMzGzoAY+sS3XqvYDDLkm26/83jvXq7ZVlVx/5/dWfZZTzCyoQdVqnObdjaprAmM23t2W96p2VbW8ZzYWKz7LcTMLalC1GqfYkZX+c/jGFflHW1Wbqmq2frTysxwzs6AGZoPpEds/rrogMMk/lpWeeFuuyz9Z+VnOxrvM9DberVqOk6y/X3U9YJJ/eqNqT1XPP2OWc0WowRXZqdqOiNJb/vkHVWuqev7Fv6z6r1A9/4oabP7Yp7k3ovQLRPn22/+antz8N9Rg8/1/W7UdEaW3IEpE6fqAGmxu/Luq7YgovQVRIkrXB9QAUUI5iBJRuj6gBogSykGUiNL1ATVAlFAOokSUrg+oAaKEchAlonR9QA0QJZSDKBGl6wNqgCihHESJKF0fUANECeUgSkTp+oAaIEooB1EiStcH1ABRQjmIElG6PqAGiBLKQZSI0vUBNUCUUA6iRJSuD6gBooRyECWidH1ADRAllIMoEaXrA2qAKKEcRIkoXR9QA0QJ5SBKROn6gBogSigHUSJK1wfUAFFCOYgSUbo+oAaIEspBlIjS9QE1QJRQDqJElK4PqAGihHIQJaJ0fUANECWUgygRpesDaoAooRxEiShdH1ADRAnlIEpE6fqAGiBKKAdRIkrXB9QAUUI5iBJRuj6gBogSykGUiNL1ATVAlFAOokSUrg+oAaKEchAlonR9QA0QJZSDKBGl6wNqgCihHESJKF0fUANECeUgSkTp+oAaIEooB1EiStcH1ABRQjmIElG6PqAGiBLKQZSI0vUBNUCUUA6iRJSuD6gBooRyECWidH1ADRAllIMoEaXrA2qAKKEcRIkoXR9QA0S5KLvnz5/fLV167fy10avOnx+ucW24cPeod/cDRIkoXR9QA0S5GNfeEstb12Yt3D130yy7ec7o8Lx7mdzcuGIfbxTL35fzVcc/H2ckykuXLl0vHt36cOuDt69f/ejDyYXFslvmVZfeK567Pnz9pUuI8iz6gBogyoW4beR37s458/P24YW7RqJ3b2+8JW/tGjl+vGH4WD5GlLO5ddFtSm7cs7/cE/ng7YtyYyjK99zCTy5aJxabnE+u3nr77S3ZKpaLBCJKv+cniBJRLsTux3LfDBE3r9yXj3c3r5hOvfLmldHSt4qF9v9Gju8PnruNKGdx/YZx44efmp8fmd8+EjNEvPHJcOF7N+TGp/c++kQ+taL8YGtr66MbcjE8UV57v5ifzGwLD+YniBJRLsSbcnPwSOTNzQ15c8OOMAdPmW4uNvG7d3ZHotxw0kSUh/hAPrDT6Fsfirx369I7cunf35N3BjNrI9EPb9mFN+SqEaWTo3l8KzRRnnfzk7v+zk8QJaJcrGgjK54z7WoseffK7Y9lMKZ8c7Rwc3MkyrtGqIjyMO8ZPxaP3pFPB7NrQ+HBq/LO4FX33h6K0kzMPwxNlIP5ye59ublrptRXNq9s+DU/QZSIciHelzuDR3dM627YDfzmfaNCx93hA0vR2rsbN41GEeVh7slwnn1VPrDjSzfHHjz1qZuODxiK8hNj1rBEeWc4Bdm8WWxOTbfI8FO9mJ8gSkS5EAdFed89GjTuudHCzdFeJbl5m4M5s9iyux8d1630pkX5znC0ORbl9U/lRmj7KMfzk7ty13bM3fNmfjI4VOPF/ARRIsqFuG8auuCukeSGa9lR425Mt7bbq3R71z0eLPgYUY5FORw0zhDlJ9OiHBz2vhSaKM+NpiC3jQjPu/3fG17NTxAlolysaKODOTfdwZwpUd4WGSx888poDGDZHSy4NnqB7yxflB+Opt4fHp56fzD0YSFKe9R769Ktt8eivBWIKIdTkEKUd90jn+YniBJRLsTuzUGXnre73w+I0gwYi0f35a0pUZrRwe3i+Y+rTmBOli9KM04cnDt+0U7Cp0W5NTyYc+vqrdE+ymKtdwZyfScAUY6nIPfd1Nu/+QmiRJQLVk1My145b/53Z/OQKO/YM92u3Tlnz7GcEuVtu/vpzvsyOZvymjM5PehTO0a0pwJdOihKMxu/NHjRR1OiNJPy64VcLwYgyjujGYbdxJ73cH6CKBHlgrx5czQHOiTKzds3R9c3Toly8/7HbsH9qqOflzMQpRlS3vj0+nsf3nBHdaZFaYaU8snV965+YJ+ZEuWWWem9q5/I5E5MtaIczU+u2fnJeQ/nJ4gSUS6KGU7e3SguHju/Yec+VzbGM6Dd8xv377iz365s3Jla7dr9jYlreHznLC5hvPTJxKmTB0T59tVi2cVbB0R53V7KI+NLHVWLspiCuPnJxuYhUfowP6lUlO+/P/WjKhAllHImN8W4dWnro617xZ7KD40Mr29N6O/6va1P7xVz863pG2Dc+2jLXbYTgCiHUxA3Pznv4fykUlG6XQvjH1WBKKEUbrN2RjfFsFOQ4hjNYGbi1/ykUlFubEz9qCwMRAllIEpus+b6gBogSigHUSJK1wfUAFFCOYgSUbo+oAaIEspBlIjS9QE1QJRQDqJElK4PqAGihHIQJaJ0fUANECWUgygRpesDaoAooRxEiShdH1ADRAnlIEpE6fqAGiBKKAdRIkrXB9QAUUI5iBJRuj6gBogSykGUiNL1ATVAlFAOokSUrg+oAaKEchAlonR9QA0QJZSDKBGl6wNqgCihHESJKF0fUANECeUgSkTp+oAaIEooB1EiStcH1ABRQjmIElG6PqAGiBLKQZSI0vUBNUCUUA6iRJSuD6gBooRyECWidH1ADRAllIMoEaXrA2qAKKEcRIkoXR9QA0QJ5SBKROn6gBogSigHUSJK1wfUAFFCOYgSUbo+oAaIEspBlIjS9QE1QJRQDqJElK4PqAGihHIQJaJ0fUANECWUgygRpesDaoAooRxEiShdH1ADRAnlIEpE6fqAGiBKKAdRIkrXB9QAUUI5iBJRuj6gBogSykGUiNL1ATVAlFAOokSUrg+oAaKEchAlonR9QA0QJZSDKBGl6wNqgCihHESJKF0fUANECeUgSkTp+oAaIEooB1EiStcH1ABRQjmIElG6PqAGiBLKQZSI0vUBNUCUUA6iRJSuD6gBooRyfh9RIspNRGnxS5RvVV0OmOQPEOXb/wFJIMpNz0S5I1WXAyaRd6rWVPX8RySx+fvUYPPu5artOMGe3K66HjDmtkjVmqoeYZaz+QfUYPOt9artOMlnP9ituiAwZPcH/0nuVe2pqrknzHI2qYGpwU7Vcpxk7937VRcEhtx/9w//6Ie3qjZVtdz64X9mlmNmFtRA9qqW4xT7co4xpRfsnpP9n/yXH31Utaqq5aMf/eEfrfosZ/cHn638TM/UoGo1HmDn1R9vnF/xv0r17J7f+PGrO2si/1UurvCY8tZFs7H4fNVnOfff3Vv5mZ6pQdVmPMjeH78qUDmv/vHeKz8V+enO63+ydWklXXnr0tafvG43Fv9tpWc5dmax6jO9ogb+sbczwZ/+6U4Q6MrDbT8/F/n8lb0/e71qaVfF639mNxZfbK/uLKeYWdheoAa+8+d/XnUEq5rHmpXF2ivFhuunVau7uo3FX6zyLMfOLBzUwHN+9rOqI1jVPB58IfLFg8Ev/32/6nAqwW4s3B9u7+TiLed/eDvbmDLEUmvgLxos6Tp1reoYVjSPn9ut6c+H4f9l1eFUgt1YLP8MOn2zDfANe0Ch6hhWM48LxbzjwiB8dQPiU8FtLB6c/H1ezs9+UnWeoJ2fiATRRfry2LaDKfliexj+ftUBVUCxsfj5kj9lf7g5AliQ0QEF5SjM4+cytoQNX9mA+FQoNhbL1thfimxXnSno5sGZTH3I4zAXhsf8rCV+KuoGxKdCsbH44uFyP+Vn9sg6wAn43Dbq51VHsYp5bA9FaQc7P9E3ID4NhhuLv1rqpzy0H1F1qqCataJR1f8TVZjHXw9F+dfD8Fdv7j3cWCz3QNZf2Y/YrzpX0MzUAQXF6MtjNPO2c293kswKzr1HG4tlbuH2VnQrBKfI5AEFzejLY/9v/nbA3+wXOw50DYhPg/HGYpk3bX34hbLWAO+YOqCgGLV5FLvOBjsOvlB1MOoUGG8sljne+wudrQEeMXVAQTFq8yhEWcy8V3XUs+TjLION6LKPrEPITB5Q0IzaPApJfK51QHyKNVgag1M1l3xkHUJm6oCCYvTm4SSxNgxe08GoU67B8vj5mRxZh5CZOqCgGL15OEmMdhys5tx7uaIcb0QV3PIQfCaUc3E15uFifmAV/z//l/nxv6uOp7IaLI3xVsirr0MFfWgUTCh5jGNe3QHPcv9uD/72LI6swwqgUTCh5IEoz+bvprE3wDNCaSKNeSBKRAlKCKWJNOaBKBElKCGUJtKYB6JElKCEUJpIYx6IElGCEkJpIo15IEpECUoIpYk05oEoESUoIZQm0pgHokSUoIRQmkhjHogSUYISQmkijXkgSkQJSgiliTTmgSgRJSghlCbSmAeiRJSghFCaSGMeiBJRghJCaSKNeSBKRAlKCKWJNOaBKBElKCGUJtKYB6JElKCEUJpIYx6IElGCEkJpIo15IEpECUoIpYk05oEoESUoIZQm0pgHokSUoIRQmkhjHogSUYISQmkijXkgSkQJSgiliTTmgSgRJSghlCbSmAeiRJSghFCaSGMeiBJRghJCaSKNeSBKRAlKCKWJNOaBKBElKCGUJtKYB6JElKCEUJpIYx6IElGCEkJpIo15IEpECUoIpYk05oEoESUoIZQm0pgHokSUoIRQmkhjHogSUYISQmkijXkgSkQJSgiliTTmgSgRJSghlCbSmAeiRJSghFCaSGMeiBJRghJCaSKNeSBKRAlKCKWJNOaBKBElKCGUJtKYB6JElKCEUJpIYx6IElGCEkJpIo15IEpECUoIpYk05oEoESUoIZQm0pgHokSUoIRQmkhjHogSUYISQmkijXmMY/7FetWxVF8D3Z8BgRNKE2nMYxzzl19WHUv1NdD9GRA4oTSRxjzGMa//oupYqq+B7s+AwAmliTTmMY55R/aqDqbyGuj+DAicUJpIYx7jmPfkYdXBVF4D3Z8BgRNKE2nMYyLmB1+t6JASUYIKQmkijXlMxLz3ixU9nIMoQQWhNJHGPCZj3pH9qsOpvAaaPwMCJ5Qm0pjHVMwPvtquOp7Ka6D4MyBwQmkijXlMx7wuv7xQdURV10DvZ0DghNJEGvM4EPPa3331YH/VXIkoQQWhNJHGPA7FvP53Il99uX5iHq5VndriNVD6GRA4oTSRxjxmxbyz/atfnhij21/uV53d4jXQ+BkQOKE0kcY8lhfz2sMv5VcqzsxElKCCUJpIYx5LjXn/q19ouHcbogQVhNJEGvNYbsx7X2q4yyWiBBWE0kQa81h2zF/+wv/ZN6IEFYTSRBrzWHbMe1/9quoUK6/BWX0GBE4oTaQxj6XHvO//dZGIElQQShNpzGP5MX/5y6pzrL4GOnsDPCOUJtKYx/JjfvhV1TlWXwOdvQGeEUoTacxj+TGvie/X6CBKUEEoTaQxjzOI2fs7pyNKUEEoTaQxjzOI+ZcPqk6y+hqo7A3wjFCaSGMeZxDzA9+P5iBKUEEoTaQxjzOIeR1R6uwN8IxQmkhjHogSUYISQmkijXkgSkQJSgiliTTmgSgRJSghlCbSmAeiRJSghFCaSGMeiBJRghJCaSKNeSBKRAlKCKWJNOaBKBElKCGUJtKYB6JElKCEUJpIYx6IElGCEkJpIo15IEpECUoIpYk05oEoESUoIZQm0pgHokSUcObsbD+6fHzk+Ks82l7q16BqzMPbmAMT5UJ1XqDMy+5xqIgL21+LRHFyJsSRyNfbF8hDQcwBidLrOoMGdv5eHtfqaePMSOu1x/L3p77N1ZiH5zEHI0rP6wz+s3NZ4vrZNdCQeiyXT7WNNObhfcyBiNL7OoPv7D2RODv7FrJksTzZW+U8FMQchCgV1Bk8Z/9pVMGWdkg9erq/unloiDkEUWqoM/jNa1I7w902h0lr8tqq5qEi5gBEqaLO4DN7X0uzyhayNOXrE09NNOahJGb1olRSZ/CYvW+etaruoUaj9eybE3aRxjy0xKxdlFrqDP7iRw+dvIs05qEmZuWiVFNn8BdPesh10arloSZm5aJUU2fwliePPekh00WPn6xWHnpi1i1KPXUGX9mWCk+ZOEhdtlcpD0UxqxalojqDp6xJUnXnTJLI2urkoSlmzaLUVGfwk73ncdV9M038fLFrWxTmoSpmxaJUVWfwk0fPKj0H9zDps0erkoeqmBWLUlWdwUvWpF111xykvcjERGMeumLWK0pddQYv+dazSYkl/nY18tAVs15R6qoz+MhD8easiTEtebgKeSiLWa0oldUZfORyreqOmUXt8irkoSxmtaJUVmfwkB2p6OZ8LyeTY97jVGMe88fcTo6/ZEySHP3MPDFrFaXG3gDP8HHvjeW4e3A05jF/zLEcf8kYMa9Js4PPHD9mraLU2BvgFxf83Njaze2xvoxJYx7HiPlkoswye3evyWdeLsqymJWKUmNvgGc8iqruljKiY51npjGPY8RsdZgPzwRMR0cm8vlEaakdEmVefmZhScxKRamxN8Aznnt1YdckyfPQ8yiNuRVLJ3Zf7NLqiMSp02HS6bibc2c1Eenal7UjqeXTohyuKdYNXemZnz3JjRbNOmImoHXzfr3UijJNpNNNjxezUlFq7A3wix3Jq26WMvLj7OrWmEd5zJF0s6QTpY22UWJfOi0jyihuxtaPbekkxpBdO0bsNM1/MmvNWIwDzZrmqU5kx49JJEnbrtztSJSbZ6Jas196u++SmHWKUmNvgGc86lfdK+X0jzEv0ZhHacy52CX1pGW8lzfSvrFibG/pkNpxYs+eEphGkqZiZVif2ts4WrMpdfPy2Lw2M2vb17iRp3TSRm79KPZKlZbEx4tZpyg19gZ4xhvdqlulnO4bYedRHnMsPbcbMpX+6Bn7RGRkJ/3MEEuWOc3l04dlhmu2jB7bkhklJkaZQ1GOzShulFV+SGd2zDpFqbE3wC+8PR5oOcYxQY15vCTmLBLp1OxosDd4ptgTaX5mMiAbLJyW3XDNRtRv1DqNqOfWHIqyPbrVWLFWuShnx6xSlBp7Azxjf85DptUg+yHn8dKYs27fzLPHI8AJUboRZZblxYjykOyKNRs1SY0ljSutToeirMvwCpWjRDk7ZpWi1Ngb4BkPPD0TtyB+EHIeR8Sc9qXdiOzRmDxpj0U5MdV28/LssOzcmm1pm3m3+c/ujBzto+zYz2wl9aNFOTNmlaLU2BvgGZcr3X0TH9HC3bmvhdWYR3nMdTdD7popY9cel67JhCgbkV3Y7sSp+a3dSHtTshuvmUokLaPVjt0ZWYgys0eC2vZHdrQoZ8asUpQaewM8o9q79MkRk6L2Ud9nrzqPl8Tcl343tjPrViRRZGfSY1HWze99d9C6KdLvdCKZuebg3KDIDTvF7Z+MYnsaZT+yi48U5cyYVYpSY2+AX+xVu5/7qCbKZM675WvM42Uxp0ks/cSd/dfu95vmQdcNTIqf9V5Uc//481qnl3Xj2Wu2YzuSSmJ7qqQb1vTcz3bUa6fDgc5LhjszY9YoSo29AZ6xU37Us/jGulZWXCg8uSRzl4e0zL+5vPh9/NP9U82Gl3vk9bp7aF6bt+1JK616Y2rVQRPV62U3C5z3dFyNeex4fYxhdswaRamxN8AzSg4Ips1IJErchcR5zzwcf8+nme5J1LJnLrdikVp+aBLX7JhXdOrukILBnsEiHXvRXS9NzKqm1yTOJlbNE/NZUpt9Ld28hwQ15uH3wdjZMWsUpcbeAM9Yn33NQk2itvlD12wTRUlWG51U0uiaJaYD7MEAqdX7M/Z2dTr1vN7p5I1Eui3zCts10mm2I4ni4p3slcr10Y6ymvSzeiyzd7j318PNY/3UrhcZnVopp/mNrDNjVihKjb0BnrE+ex9V0RH9jm0iu4vLHRYYtIjtpLhdXALX6MvBJmpJlNrZTNpIknRw4p7Yb55PiqMK0eBX9052pci+vnjfw8TzilJhHuvl+wePSZqNOMWLmuNQRKmwN8AzZjdRVlw4Zy8qLq6cM73i/jHm+cQlcHaBXXxgaxuLO/hgyLOsWSs2qq6duqOuy93r7J0ZTNP17Dv3Z3+nyclE6XcepyfK5RC2KP3uDfCMsiZy18YlZks7feVcko2mD0XTDK8jnmiiVs+8sF+3p/rZXT2jiUvmpoXxaPPcLU7ma46uyDtJE2nMA1EugWOI0ufeAM+YfdHCYJs6dZ5znhiy/MBNFWaeupy2e9Kx97ap2W2sWaFzsInSxmhD3Za4mDTO3NMdz3lvFY15+H3ByOyYNYpSY2+AZ5SMavrF/hvTIePznAvcJXVZXB/shLELXIuMb/bVKlZoZm5HjpuWxAebKGuMdv1k7g6zjZJ9ayfcR+l1Howol8D8+yi97g3wjJIm6kotT5PpC0JGS9I0dtvYftZIOn3bJ82GPReieEHbHT2MJc9F2mnSkeEme7KJ+pl598F8JZIkzXvSP1ETacxj6aI86lTnIwhclF73BnhGSROZP2qnY7vkUBPZJVL8/RPzEnvyWSbmxc3+8CU9s7hTnHVhXtqsibQONlE/kWJV20Sm/8wbdVonaiKNeSDKJTC/KL3uDfCM0n+sebfm/qzFl0ZPfnV0Xuu2in+FeXEdXSNPaun4JWm9G3fdybvtXjez+31ytyxPssE7mR4crFp8ubT5rPZypt5e54Eol8D8ovS6N8Azthf+eroT/CuU+Q0RbYebx2Ixm3+LxTGBtJ64f5bm36V5aP8V1pt2QdJupM1snFreTNrpIp80K2aNotTYG+AZi19vfJImmn/Vk1/r7W8eC8Wc2Lme+/oce2KKO0k6ltierJLbn2174rQ9ZyXOivjciSzSby3wUeFf6+1vb4BnrC38/XRn0kS5rIWbx0IxdzqpvcDY3qgysTvT2u7s58xaMknbxc3Mo3ZaswcOiovnao20O/pCiWMwM2aNotTYG+AbC9+CKlv83lXzr5rNfz9KhXksEHPujgik9gI6e9Mad9Z0PHHxXGd48dzwuruOO9IayfEn31k496NU2BvgGc+b8/5Bq6A599fDa8xjkZhr0qkVuxxbSdLtF2fwOWXay0niiYvnsuLiub49iTpawBUzY1YpSo29AZ7xde3kf+rlUfs65DwWiTm1N+zqJPZkP4nj/sxTne3rBtfdJS+9eO74MasUpcbeAM9YX/iQ4FkQzX3mhMY8Fow5N/bLU3dEpz1TlMWIslVcE7LwOUgzY1YpSo29AZ6xs8DeqzMjnf+AoMY8Fog5d9Pumr1zQ+Qe9GeIcmIfZasYXy5w97XZMasUpcbeAN+o9puXXs5xvndJYx7HjzmzZ/rkfTeirLVqYi8POSTKqJ33hhfPxfZ+DJEc/x7Bs2NWKUqVvQGe4fMOnOPsvtGYxwIxFzsdu24fpUjb/JodHlFGE19C0HXfWnD8IdXsmHWKUmNvgGdsP666Vcp5fIxrFjTmsUjMeXEVjr3ipp7aW82m9ruxzAP7ZGtwmnlz8ruw2s1FTjefHbNOUWrsDfCMC9V+mefLyORC2HksJeYTXuH98ph1ilJjb4BvfOvtvKT2beh5LCPm0xFlScw6RamyN8AzHvp6TDCVh6HnsYyYT0WUZTErFaXG3gDP2Hvq6YULzad7oeehLmalolRXZ/CQJ56ejxs9CT8PbTErFaW6OoOHXPDzNLP2cXdza8xDW8xaRamtzuAjfm5uj7+x1ZiHspi1ilJbncFHLoiHe3Cax9/YasxDWcxqRamszuAlrz327qBg+vi11chDV8xqRamszuAle8+9O8+s9nyBw4Ea89AVs15R6qoz+Mm+u+OMR9Rlf1XyUBWzXlHqqjN4ypNni36vyFLIny24l1tjHppiVixKVXUGT9l7vuwvmT4W8aKTEo15aIpZsyg11Rl8Ze2FR7twai8W/mI6jXkoilmzKDXVGbzlobuhoRckJ7kAVmMeemJWLUpFdQZ/eejLxQvtk/WQxjzUxKxblHrqDB7zD+4bTyunK/+wenloiVm5KNXUGXzmoXiwD6d28m2txjyUxKxdlFrqDF7z8EW/4jMo8v6LU+ghjXnoiFm9KJXUGfxm7btnlZ6VW3/23akcC9SYh4qY9YtSR53Bc/YeSVzZBjeP5dEpnVumMQ8NMQcgShV1Bu/Z+c591WkFLVST707xu+A15uF/zCGIUkOdQQEPn0vcPuNbraTtWJ6f8p4bjXn4HnMYovS/zqCCna9Fekl2RhvdPEt6Il8vYUurMQ+/Yw5FlL7XGZSw9/D7N8TQj5dM337KG98/XNJ+G415+BxzOKL0u86giZ2dnfWlYz6EPNTEHJIofa4zACgmOFECAJw2iBIA4AgQJQDAESBKAIAjQJQAAEeAKAEAjgBRAgAcAaIEADgCRAkAcASIEgDgCBAlAMARIEoAgCNAlAAAR4AoAQCOAFECABwBogQAOAJECQBwBIgSAOAIECUAwBEgSgCAI0CUABAsO9un832C/0devnz7FL9ucKGY5firnGbMAKCUtUdviDxb9pdXFzwTeePR2mrGDABa2Vt/LlE3SxtnRJp1I3m+vrdqMQOAWvaevHiW5GclnCF58uzFk4W1ozFmANDL9tOofWbjsknSdvR0e3ViBgC1XPhGkkqU47STyDcXViNmANDL/tN+qyrlWFr9p/urEDMA6OWR1CobmhWkNXkUfswAoJcn0q5WOZa2PAk9ZgDQixfOOaZ1NMYMAHp5IlnVvinI5reOxpgBQC+/9mNsZmnLr8ONGQD0su+Pc6x19kONGQD0cuFprWrTTFJ7Ose5iRpjBgDFfNuv+BybadL+t2HGDAB6WZdKz9k+TEvWQ4wZAPSy9yKp2jIHSV7shRczACjm+8irSawljb4PL2YA0MuO1Kt2zGHqshNazACgmM/iqg0zi/iz0GIGAL2s+XJ5yzSZrIUVMwAo5nsvB2dmePZ9WDEDgF72fLq+ZZK27IUUMwAoZvtx1XYp4/F2SDEDgGKed6uWSxnd5yHFDAB6WfPtApcxrbJDIxpjBgDFrEdVu6WcaD2cmAFAMd95O4s189jvwokZAPSy5+MVLkPqs48ha4wZABSzL1Wb5WXMvhmuxpgBQDHr/arF8jL666HEDACKuTzPXcLzpH3kMyPSzEyM82yhSwzbST71e+3yCWLOjnzmVMjmihkAFPN0nktcMomNZ1oHn5lJXcyinshCd4uMD1zC3X56gphNBK384DOnTzJXzACgmLluLpFmRpK9STWWizKRZtqIosUGbwdFmckJYjaSjJKpNzsTUc6OGQD0siNz3/42mhZl14zXppa3hq4zg88ZGp0htwNnjeeHRZnOusHj/DGnckiU05858WmzTmE/OubWYVGm3JQSIDB2Dh5AbkcSxXFatyJs9N29JyQy48dMxE2nu8X/jHTynkTNkR2afel084Z72f8dvLZhLZJERiR5t2Nm5NZveV8ksrZp1TrSb6dWjuYz3QfHrYOibMwW5YGYk46JuWc+y0Vrr9ppSc9E6ILJGmlNpFN3MWex9EenFuUmtMjuYEykbhZEwwm9+bVvYzaLpW9DTXvFGxRrmAGz/Sj7Evt2WTJPzACgmIMHkHPpNOtd6aXSt79IzQ0ejSjzxEglaxg5du1OyEz6nW43Gl1KaATSjo2jrEqS/1eTeHDgJJFOJ85bIl2z2LxlqyM187q6NWrcjOxTsXmJtZwkNekclM6sQ8gHY64b4bZ7krSKaMXYuyltq3IbR572JTaq7JpFUZQYY49SNdIzsdggo05ivJ0ORWliy41xe+ZdO2nDvoHb6WrWiNujNeK8buqTdOaKGQAUs35gjtx2I8lmYvSVml/6UTHeslNp+18mPfOjIy3jo9z6qDlcLXY/m8XUe7w30Bil4bzVKObVNfvI+MuOI91TqfkvcqZ1A8GD0onXj445cZ+WJI1OZEe8fRNiT3Ibg4ujaf3ZNnrLpNOwHz4YUnbt8+Zn3do8nVhgRJla/RaLm8X7N83KNVecromxeEnP5pDOFTMAKOagdNKONN2R4qbRRq3TNjqMpTESZXNowMyOBceHdApX5VajB0XZLRRp6Jpn+8PxnDONlbBZ2HS/F88uIEo7iHQx10y0/bhrdNjpN0airA3fM3PqG6UQOzHana2JjXu8oPi1awalWdY0j3vDNyh2DNTN6xL3Vn03oI4RJUDgHJROo9kxM9IkNYO7pBH1cjNmMqoYibI3lk53UpQDWVjbHRRl5p4vSBoyvJ1F8cDuCnXrDg7/zCWdQzGbibXb3dmWdipJXVotN9EeiDIeTqmLqLKxKHMn9/5A89lYlIkb4hbEjWgo92Jy3jJPFS8p5N5FlACB8+DQ4em0XevY8VIU52aoF9Uy83Mkyu5weurm4GNRDp4vF2XmyBujPYQdOw12M30nx7QQZ3RIOo/mi7nXMR+ZSrcuWSrNpj3QMhRlb7gj9YAoi+fH2jsgyr4bUWZZyzwanI1ZPMhGaxQG7c0TMwAo5sGs0yFbHWOEmjSNSWpRInljYh+lFUQ9yQtFjkRZd8+3rO1mibIzOuhTc65JErsX0Qk2GbykXzL1nkuULgLz2f1+17xNv9frNBoT+yitxNtJfkCUxY7Tepko49G3TTRdUM0kTdw72dl48ZJCkXPJHQAUc3Aa23VKizqpMYgd9LUligZCdGO+TpQ10k4nPSDKhj3lJ3WHR2aJsia1tJFF/ZZ5v5qdItfsWNI+5Q6MFC9J7BssMvXud4xz84477mRP9uzao+gDUcZuVp+bH9HBEWXLPW99OFOUxod5oxWbfN0L7cjz4BrNIhmm3gCBc1A6eUd63b7VQCp2dp3b82oK4dSkb497SNwZKmhClOZ5M/uN8tmizPvSid25Rmksnb49Yp5H7kF3+JK6Wbtz+PSg+Q7mdHq1yA4AW+70zbrYxy6GvsRtuwsztk8dEKWJ1D4fN2aLcrC47870tNFn7kFvYg2bQyQRogQInEMHRlpGkz17TnWjG9u5Zy+2p+3ERmh5bH+mSVSrD54Z/CwMm/RrThjd2D4/nLa242LS3ap1indtZL2o657Lau7c7eFLzBv36sOXH0uUjXqt36m5T4zt+mlsBn5FDFlsf+a1ThFzuzEZm3k+6uYugqkF7cGDvNuJk3T4wtbhNexZ8nGzHSNKgLDx+45l851w7huccA4QGIcuB/SMuS5h9AwuYQQIjGPcFKMKTnhTDH9iBgDNzHXLsso4wW3WPIsZABQz101wK+MEN+71LGYAUMxcX6tQGSf4KgjPYgYAxfh9CJkvFwMAD9D41a8aYwYAxexJ/eRuWBZ12QslZgDQzHfdk8thWXS/CydmAFDMenRyOSyLaD2cmAFAMWvSOrkdlkNL1sKJGQA089zbeWz3eUgxA4Bith9XLZcyHm+HFDMAKGZPPL3QpV1+/FhjzACgme/jkwtiGcTfhxUzAChmzc+bTGQvOyyiMWYA0MxnXg7P4s9CixkAFLPj45Uu9Zff1lFjzACgme8j726Fm0bfhxczAChm70Vyck2cLsmLvfBiBgDNrPt2qUtLjrwSUGPMAKCZb/teTWTT/rdhxgwAirnw1Ku7hteeXggzZgDQzL5P17q057v5rcaYAUAzv/bHOm35dbgxA4BmnvhysUsmT0KOGQA088SP8Vn7OM7RGDMAaMYL6xzTORpjBgDNPJJaxWfcpDV5FH7MAKCZ/af9Ss/ibvWf7q9CzACgmQvfSFLZAC1N5JsFzkXUGDMAqGb7adSuRDtpO3q64PcoaIwZADSz9+TFsyQ/a+XkybMXTxa+p4TGmAFANXvrzyXqZmc2RkuzbiTP10+kHI0xA4Bu1h69IfIsjuNuslS65iOeibzx6BS+QkFjzACgnJ3t9fVHl5fMo/X17VO8LbjGmAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgufx//g740/mh828AAAAldEVYdGRhdGU6Y3JlYXRlADIwMjEtMTEtMjRUMDA6MzI6NTgrMDA6MDBPJJNTAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIxLTExLTI0VDAwOjMyOjU4KzAwOjAwPnkr7wAAAABJRU5ErkJggg==" alt="simpleperf_trace_offcpu_sample_mode"></p>
<p>è¿™é‡Œæœ‰ä¸¤ç§ç±»å‹çš„æ ·æœ¬:</p>
<ol>
<li>ä¸º cpu-clock äº‹ä»¶ç”Ÿæˆçš„ on-cpu æ ·æœ¬. æ¯ä¸ªæ ·æœ¬ä¸­çš„å‘¨æœŸå€¼è¡¨ç¤ºåœ¨ CPU ä¸ŠèŠ±è´¹äº†å¤šå°‘çº³ç§’ (é’ˆå¯¹è¯¥æ ·æœ¬çš„è°ƒç”¨é“¾) .</li>
<li>ä¸º sched:sched_switch äº‹ä»¶ç”Ÿæˆçš„ off-cpu (sched_switch) æ ·æœ¬. å‘¨æœŸå€¼ç”± simpleperf è®¡ç®—ä¸ºä¸‹ä¸€ä¸ª switch on è®°å½•çš„æ—¶é—´æˆ³å‡å»å½“å‰æ ·æœ¬çš„æ—¶é—´æˆ³. å› æ­¤, æ¯ä¸ªæ ·æœ¬ä¸­çš„å‘¨æœŸå€¼è¡¨ç¤ºåœ¨ CPU å¤–èŠ±è´¹äº†å¤šå°‘çº³ç§’ (é’ˆå¯¹è¯¥æ ·æœ¬çš„è°ƒç”¨é“¾) .</li>
</ol>
<p>æ³¨æ„: å®é™…ä¸Š, switch on è®°å½•å’Œæ ·æœ¬å¯èƒ½ä¼šä¸¢å¤±. ä¸ºäº†å‡è½»ç²¾åº¦æŸå¤±, æˆ‘ä»¬è®¡ç®—ä¸€ä¸ª off-cpu æ ·æœ¬çš„å‘¨æœŸä¸ºä¸‹ä¸€ä¸ª switch on è®°å½•æˆ–æ ·æœ¬çš„æ—¶é—´æˆ³å‡å»å½“å‰æ ·æœ¬çš„æ—¶é—´æˆ³.</p>
<p>é€šè¿‡ Python è„šæœ¬æŠ¥å‘Šæ—¶, <code>simpleperf_report_lib.py</code> æä¾› <code>SetTraceOffCpuMode()</code> æ–¹æ³•æ¥æ§åˆ¶å¦‚ä½•æŠ¥å‘Šæ ·æœ¬:</p>
<ol>
<li>on-cpu æ¨¡å¼: ä»…æŠ¥å‘Š on-cpu æ ·æœ¬.</li>
<li>off-cpu æ¨¡å¼: ä»…æŠ¥å‘Š off-cpu æ ·æœ¬.</li>
<li>on-off-cpu æ¨¡å¼: æŠ¥å‘Š on-cpu å’Œ off-cpu æ ·æœ¬, å¯ä»¥æŒ‰äº‹ä»¶åç§°åˆ†å¼€.</li>
<li>mixed-on-off-cpu æ¨¡å¼: åœ¨ç›¸åŒäº‹ä»¶åç§°ä¸‹æŠ¥å‘Š on-cpu å’Œ off-cpu æ ·æœ¬.</li>
</ol>
<p>å¦‚æœæœªè®¾ç½®, å°†ä½¿ç”¨ mixed-on-off-cpu æ¨¡å¼è¿›è¡ŒæŠ¥å‘Š.</p>
<p>ä½¿ç”¨ <code>report_html.py</code>, <code>inferno</code> å’Œ <code>report_sample.py</code> æ—¶, å¯ä»¥é€šè¿‡ <code>--trace-offcpu</code> é€‰é¡¹è®¾ç½®æŠ¥å‘Šæ¨¡å¼.</p>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›è®°å½•å’ŒæŠ¥å‘Š trace offcpu é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Check if --trace-offcpu is supported by the kernel (should be available on kernel &gt;= 4.2).</span></span><br><span class="line">$ simpleperf list --show-features</span><br><span class="line">trace-offcpu</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record with --trace-offcpu.</span></span><br><span class="line">$ simpleperf record -g -p 11904 --duration 10 --trace-offcpu -e cpu-clock</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record system wide with --trace-offcpu.</span></span><br><span class="line">$ simpleperf record -a -g --duration 3 --trace-offcpu -e cpu-clock</span><br><span class="line"></span><br><span class="line"><span class="comment"># Record with --trace-offcpu using app_profiler.py.</span></span><br><span class="line">$ ./app_profiler.py -p com.google.samples.apps.sunflower \</span><br><span class="line">    -r <span class="string">&quot;-g -e cpu-clock:u --duration 10 --trace-offcpu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Report on-cpu samples.</span></span><br><span class="line">$ ./report_html.py --trace-offcpu on-cpu</span><br><span class="line"><span class="comment"># Report off-cpu samples.</span></span><br><span class="line">$ ./report_html.py --trace-offcpu off-cpu</span><br><span class="line"><span class="comment"># Report on-cpu and off-cpu samples under different event names.</span></span><br><span class="line">$ ./report_html.py --trace-offcpu on-off-cpu</span><br><span class="line"><span class="comment"># Report on-cpu and off-cpu samples under the same event name.</span></span><br><span class="line">$ ./report_html.py --trace-offcpu mixed-on-off-cpu</span><br></pre></td></tr></table></figure>

<h2 id="report"><a href="#report" class="headerlink" title="report"></a>report</h2><p>report å‘½ä»¤ç”¨äºæŠ¥å‘Šç”± record å‘½ä»¤ç”Ÿæˆçš„åˆ†ææ•°æ®. æŠ¥å‘ŠåŒ…å«ä¸€ä¸ªæ ·æœ¬æ¡ç›®è¡¨, æ¯ä¸ªæ ·æœ¬æ¡ç›®æ˜¯æŠ¥å‘Šä¸­çš„ä¸€è¡Œ. report å‘½ä»¤å°†å±äºåŒä¸€è¿›ç¨‹, çº¿ç¨‹, åº“, å‡½æ•°çš„æ ·æœ¬åˆ†ç»„åˆ°åŒä¸€ä¸ªæ ·æœ¬æ¡ç›®ä¸­. ç„¶åæ ¹æ®æ ·æœ¬æ¡ç›®çš„äº‹ä»¶è®¡æ•°å¯¹æ ·æœ¬æ¡ç›®è¿›è¡Œæ’åº.</p>
<p>é€šè¿‡ä¼ é€’é€‰é¡¹, æˆ‘ä»¬å¯ä»¥å†³å®šå¦‚ä½•è¿‡æ»¤æ‰ä¸æ„Ÿå…´è¶£çš„æ ·æœ¬, å¦‚ä½•å°†æ ·æœ¬åˆ†ç»„åˆ°æ ·æœ¬æ¡ç›®ä¸­, ä»¥åŠåœ¨å“ªé‡ŒæŸ¥æ‰¾åˆ†ææ•°æ®å’ŒäºŒè¿›åˆ¶æ–‡ä»¶.</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹. è®°å½•è¢«åˆ†ç»„ä¸º 4 ä¸ªæ ·æœ¬æ¡ç›®, æ¯ä¸ªæ¡ç›®æ˜¯ä¸€è¡Œ. æœ‰å‡ åˆ—, æ¯åˆ—æ˜¾ç¤ºå±äºæ ·æœ¬æ¡ç›®çš„ä¸€éƒ¨åˆ†ä¿¡æ¯. ç¬¬ä¸€åˆ—æ˜¯ Overhead, æ˜¾ç¤ºå½“å‰æ ·æœ¬æ¡ç›®ä¸­äº‹ä»¶å æ€»äº‹ä»¶çš„ç™¾åˆ†æ¯”. ç”±äº perf äº‹ä»¶æ˜¯ cpu-cycles, overhead æ˜¯æ¯ä¸ªå‡½æ•°ä½¿ç”¨çš„ CPU å‘¨æœŸçš„ç™¾åˆ†æ¯”.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Reports perf.data, using only records sampled in libsudo-game-jni.so, grouping records using</span></span><br><span class="line"><span class="comment"># thread name(comm), process id(pid), thread id(tid), function name(symbol), and showing sample</span></span><br><span class="line"><span class="comment"># count for each row.</span></span><br><span class="line">$ simpleperf report --dsos /data/app/com.example.sudogame-2/lib/arm64/libsudo-game-jni.so \</span><br><span class="line">      --<span class="built_in">sort</span> <span class="built_in">comm</span>,pid,tid,symbol -n</span><br><span class="line">Cmdline: /data/data/com.example.sudogame/simpleperf record -p 7394 --duration 10</span><br><span class="line">Arch: arm64</span><br><span class="line">Event: cpu-cycles (<span class="built_in">type</span> 0, config 0)</span><br><span class="line">Samples: 28235</span><br><span class="line">Event count: 546356211</span><br><span class="line"></span><br><span class="line">Overhead  Sample  Command    Pid   Tid   Symbol</span><br><span class="line">59.25%    16680   sudogame  7394  7394  checkValid(Board const&amp;, int, int)</span><br><span class="line">20.42%    5620    sudogame  7394  7394  canFindSolution_r(Board&amp;, int, int)</span><br><span class="line">13.82%    4088    sudogame  7394  7394  randomBlock_r(Board&amp;, int, int, int, int, int)</span><br><span class="line">6.24%     1756    sudogame  7394  7394  @plt</span><br></pre></td></tr></table></figure>

<h3 id="è®¾ç½®è¯»å–åˆ†ææ•°æ®çš„è·¯å¾„"><a href="#è®¾ç½®è¯»å–åˆ†ææ•°æ®çš„è·¯å¾„" class="headerlink" title="è®¾ç½®è¯»å–åˆ†ææ•°æ®çš„è·¯å¾„"></a>è®¾ç½®è¯»å–åˆ†ææ•°æ®çš„è·¯å¾„</h3><p>é»˜è®¤æƒ…å†µä¸‹, report å‘½ä»¤ä»å½“å‰ç›®å½•çš„ perf.data æ–‡ä»¶ä¸­è¯»å–åˆ†ææ•°æ®. ä½†å¯ä»¥ä½¿ç”¨ <code>-i</code> é€‰é¡¹æ›´æ”¹è¯»å–è·¯å¾„.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">simpleperf report -i data/perf2.data</span><br></pre></td></tr></table></figure>

<h3 id="è®¾ç½®æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„"><a href="#è®¾ç½®æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„" class="headerlink" title="è®¾ç½®æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„"></a>è®¾ç½®æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„</h3><p>ä¸ºäº†æŠ¥å‘Šå‡½æ•°ç¬¦å·, simpleperf éœ€è¦è¯»å–è¢«ç›‘æ§è¿›ç¨‹ä½¿ç”¨çš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ä»¥è·å–ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯. é»˜è®¤æƒ…å†µä¸‹, è·¯å¾„æ˜¯è®°å½•æ—¶è¢«ç›‘æ§è¿›ç¨‹ä½¿ç”¨çš„å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶. ç„¶è€Œ, è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åœ¨æŠ¥å‘Šæ—¶å¯èƒ½ä¸å­˜åœ¨æˆ–ä¸åŒ…å«ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯. å› æ­¤, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>--symfs</code> é€‰é¡¹é‡å®šå‘è·¯å¾„.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># In this case, when simpleperf wants to read executable binary /A/b, it reads file in /A/b.</span></span><br><span class="line">$ simpleperf report</span><br><span class="line"></span><br><span class="line"><span class="comment"># In this case, when simpleperf wants to read executable binary /A/b, it prefers file in</span></span><br><span class="line"><span class="comment"># /debug_dir/A/b to file in /A/b.</span></span><br><span class="line">$ simpleperf report --symfs /debug_dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read symbols for system libraries built locally. Note that this is not needed since Android O,</span></span><br><span class="line"><span class="comment"># which ships symbols for system libraries on device.</span></span><br><span class="line">$ simpleperf report --symfs <span class="variable">$ANDROID_PRODUCT_OUT</span>/symbols</span><br></pre></td></tr></table></figure>

<h3 id="æŠ¥å‘Šè°ƒç”¨å›¾"><a href="#æŠ¥å‘Šè°ƒç”¨å›¾" class="headerlink" title="æŠ¥å‘Šè°ƒç”¨å›¾"></a>æŠ¥å‘Šè°ƒç”¨å›¾</h3><p>è¦æŠ¥å‘Šè°ƒç”¨å›¾, è¯·ç¡®ä¿åˆ†ææ•°æ®æ˜¯å¸¦æœ‰è°ƒç”¨å›¾è®°å½•çš„, å¦‚ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvZXhlY3V0YWJsZV9jb21tYW5kc19yZWZlcmVuY2UubWQjcmVjb3JkLWNhbGwtZ3JhcGhz">Record call graphs<i class="fa fa-external-link-alt"></i></span> æ‰€ç¤º.</p>
<hr>
<p>æ›´å¤šè¯¦ç»†å†…å®¹è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvZXhlY3V0YWJsZV9jb21tYW5kc19yZWZlcmVuY2UubWQjdGhlLXJlY29yZC1jb21tYW5k">The record command<i class="fa fa-external-link-alt"></i></span>.</p>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>Simpleperf</tag>
        <tag>Android</tag>
        <tag>å®‰å“æ€§èƒ½åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Simpleperf ä¸‰éƒ¨æ›² (ä¸‰)</title>
    <url>//posts/2024/07/07/simpleperf3/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹æ€§èƒ½åˆ†æå·¥å…· <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2MvUkVBRE1FLm1k">Simpleperf<i class="fa fa-external-link-alt"></i></span> ä½¿ç”¨æ–‡æ¡£æ€»ç»“, ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯æ–‡æ¡£ç¿»è¯‘.</p>
<p>æœ¬ç¯‡åŸæ–‡è§ <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL21haW4vc2ltcGxlcGVyZi9kb2Mvc2NyaXB0c19yZWZlcmVuY2UubWQ=">Scripts reference<i class="fa fa-external-link-alt"></i></span>.</p>
<span id="more"></span>

<h2 id="è®°å½•åˆ†ææ•°æ®"><a href="#è®°å½•åˆ†ææ•°æ®" class="headerlink" title="è®°å½•åˆ†ææ•°æ®"></a>è®°å½•åˆ†ææ•°æ®</h2><h3 id="app-profiler-py"><a href="#app-profiler-py" class="headerlink" title="app_profiler.py"></a>app_profiler.py</h3><p><code>app_profiler.py</code> ç”¨äºè®°å½• Android åº”ç”¨ç¨‹åºå’Œæœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶çš„åˆ†ææ•°æ®.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®°å½•ä¸€ä¸ª Android åº”ç”¨ç¨‹åº. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•åŒ…å«ç¼–è¯‘æˆæœ¬åœ°æŒ‡ä»¤çš„ Java ä»£ç çš„ Android åº”ç”¨ç¨‹åº. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp --compile_java_code</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•ä¸€ä¸ª Android åº”ç”¨ç¨‹åºçš„ Activity å¯åŠ¨. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp -a .SleepActivity</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•ä¸€ä¸ªæœ¬åœ°è¿›ç¨‹. </span></span><br><span class="line">$ ./app_profiler.py -np surfaceflinger</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ® pid è®°å½•ä¸€ä¸ªæœ¬åœ°è¿›ç¨‹. </span></span><br><span class="line">$ ./app_profiler.py --pid 11324</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•ä¸€ä¸ªå‘½ä»¤. </span></span><br><span class="line">$ ./app_profiler.py -cmd \</span><br><span class="line">    <span class="string">&quot;dex2oat --dex-file=/data/local/tmp/app-debug.apk --oat-file=/data/local/tmp/a.oat&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•ä¸€ä¸ª Android åº”ç”¨ç¨‹åº, å¹¶ä½¿ç”¨ -r å‘ record å‘½ä»¤å‘é€è‡ªå®šä¹‰é€‰é¡¹. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp \</span><br><span class="line">    -r <span class="string">&quot;-e cpu-clock -g --duration 30&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½• CPU æ—¶é—´å’Œé CPU æ—¶é—´. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp \</span><br><span class="line">    -r <span class="string">&quot;-e task-clock -g -f 1000 --duration 10 --trace-offcpu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åˆ†ææ•°æ®ä¿å­˜åˆ°è‡ªå®šä¹‰æ–‡ä»¶ (å¦‚ perf_custom.data) è€Œä¸æ˜¯ perf.data. </span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp -o perf_custom.data</span><br></pre></td></tr></table></figure>

<h3 id="ä»åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œåˆ†æ"><a href="#ä»åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œåˆ†æ" class="headerlink" title="ä»åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œåˆ†æ"></a>ä»åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿›è¡Œåˆ†æ</h3><p>æœ‰æ—¶æˆ‘ä»¬æƒ³åˆ†æåº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´. ä¸ºæ”¯æŒè¿™ä¸€ç‚¹, æˆ‘ä»¬åœ¨ record å‘½ä»¤ä¸­æ·»åŠ äº† --app é€‰é¡¹. --app é€‰é¡¹è®¾ç½®è¦åˆ†æçš„ Android åº”ç”¨ç¨‹åºçš„åŒ…å. å¦‚æœåº”ç”¨ç¨‹åºå°šæœªè¿è¡Œ, record å‘½ä»¤å°†ä»¥ 1 æ¯«ç§’çš„é—´éš”è½®è¯¢åº”ç”¨ç¨‹åºè¿›ç¨‹. å› æ­¤, è¦ä»åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶å¼€å§‹åˆ†æ, æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨ --app å¯åŠ¨ record å‘½ä»¤, ç„¶åå†å¯åŠ¨åº”ç”¨ç¨‹åº. ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./run_simpleperf_on_device.py record --app simpleperf.example.cpp \</span><br><span class="line">    -g --duration 1 -o /data/local/tmp/perf.data</span><br><span class="line"><span class="comment"># Start the app manually or using the `am` command.</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨, app_profiler.py æ”¯æŒä½¿ç”¨ <code>-a</code> é€‰é¡¹åœ¨è®°å½•å¼€å§‹åå¯åŠ¨ä¸€ä¸ª Activity.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./app_profiler.py -p simpleperf.example.cpp -a .MainActivity</span><br></pre></td></tr></table></figure>

<h3 id="binary-cache-builder-py"><a href="#binary-cache-builder-py" class="headerlink" title="binary_cache_builder.py"></a>binary_cache_builder.py</h3><p><code>binary_cache</code> ç›®å½•æ˜¯ä¸€ä¸ªä¿å­˜åˆ†ææ•°æ®æ–‡ä»¶æ‰€éœ€äºŒè¿›åˆ¶æ–‡ä»¶çš„ç›®å½•. è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åº”ä¸ºæœªå‰¥ç¦»ç‰ˆæœ¬, åŒ…å«è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·è¡¨. report è„šæœ¬ä½¿ç”¨ <code>binary_cache</code> ç›®å½•è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·, <code>report_html.py</code> ä¹Ÿä½¿ç”¨è¯¥ç›®å½•ç”Ÿæˆå¸¦æ³¨é‡Šçš„æºä»£ç å’Œåæ±‡ç¼–ä»£ç .</p>
<p>é»˜è®¤æƒ…å†µä¸‹, <code>app_profiler.py</code> åœ¨è®°å½•åæ„å»º <code>binary_cache</code> ç›®å½•. ä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>binary_cache_builder.py</code> ä¸ºç°æœ‰çš„åˆ†ææ•°æ®æ–‡ä»¶æ„å»º <code>binary_cache</code>. è¿™åœ¨æ‚¨ç›´æ¥ä½¿ç”¨ <code>simpleperf record</code> è¿›è¡Œç³»ç»ŸèŒƒå›´çš„åˆ†ææˆ–åœ¨æœªè¿æ¥ USB çº¿ç¼†çš„æƒ…å†µä¸‹è®°å½•æ•°æ®æ—¶éå¸¸æœ‰ç”¨.</p>
<p><code>binary_cache_builder.py</code> å¯ä»¥ä» Android è®¾å¤‡ä¸­æ‹‰å–äºŒè¿›åˆ¶æ–‡ä»¶, æˆ–åœ¨ä¸»æœºä¸Šçš„ç›®å½•ä¸­æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ (é€šè¿‡ -lib é€‰é¡¹) .</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Generate binary_cache for perf.data, by pulling binaries from the device.</span></span><br><span class="line">$ ./binary_cache_builder.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate binary_cache, by pulling binaries from the device and finding binaries in</span></span><br><span class="line"><span class="comment"># SimpleperfExampleCpp.</span></span><br><span class="line">$ ./binary_cache_builder.py -lib path_of_SimpleperfExampleCpp</span><br></pre></td></tr></table></figure>

<h3 id="run-simpleperf-on-device-py"><a href="#run-simpleperf-on-device-py" class="headerlink" title="run_simpleperf_on_device.py"></a>run_simpleperf_on_device.py</h3><p>è¿™ä¸ªè„šæœ¬å°† simpleperf å¯æ‰§è¡Œæ–‡ä»¶æ¨é€åˆ°è®¾å¤‡ä¸Š, å¹¶åœ¨è®¾å¤‡ä¸Šè¿è¡Œ simpleperf å‘½ä»¤. å®ƒæ¯”æ‰‹åŠ¨è¿è¡Œ adb å‘½ä»¤æ›´æ–¹ä¾¿.</p>
<h2 id="æŸ¥çœ‹åˆ†ææ•°æ®"><a href="#æŸ¥çœ‹åˆ†ææ•°æ®" class="headerlink" title="æŸ¥çœ‹åˆ†ææ•°æ®"></a>æŸ¥çœ‹åˆ†ææ•°æ®</h2><p>æœ¬èŠ‚ä¸­çš„è„šæœ¬ç”¨äºæŸ¥çœ‹åˆ†æç»“æœæˆ–å°†åˆ†ææ•°æ®è½¬æ¢ä¸ºå¤–éƒ¨ UI ä½¿ç”¨çš„æ ¼å¼. æœ‰å…³æ¨èçš„ UI, è¯·å‚è§ view_the_profile.md.</p>
<h3 id="report-py"><a href="#report-py" class="headerlink" title="report.py"></a>report.py</h3><p><code>report.py</code> æ˜¯ä¸»æœºä¸Š report å‘½ä»¤çš„åŒ…è£…å™¨. å®ƒæ¥å— report å‘½ä»¤çš„æ‰€æœ‰é€‰é¡¹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŠ¥å‘Šè°ƒç”¨å›¾</span></span><br><span class="line">$ ./report.py -g</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ç”± Python Tk å®ç°çš„ GUI çª—å£ä¸­æŠ¥å‘Šè°ƒç”¨å›¾</span></span><br><span class="line">$ ./report.py -g --gui</span><br></pre></td></tr></table></figure>

<h3 id="report-html-py"><a href="#report-html-py" class="headerlink" title="report_html.py"></a>report_html.py</h3><p><code>report_html.py</code> æ ¹æ®åˆ†ææ•°æ®ç”Ÿæˆ <code>report.html</code>. ç„¶å <code>report.html</code> å¯ä»¥åœ¨ä¸ä¾èµ–å…¶ä»–æ–‡ä»¶çš„æƒ…å†µä¸‹æ˜¾ç¤ºåˆ†æç»“æœ. å› æ­¤, å®ƒå¯ä»¥åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­æ˜¾ç¤ºæˆ–ä¼ è¾“åˆ°å…¶ä»–æœºå™¨ä¸Š. æ ¹æ®ä½¿ç”¨çš„å‘½ä»¤è¡Œé€‰é¡¹, <code>report.html</code> çš„å†…å®¹å¯ä»¥åŒ…æ‹¬: å›¾è¡¨ç»Ÿè®¡, æ ·æœ¬è¡¨, ç«ç„°å›¾, æ¯ä¸ªå‡½æ•°çš„æ³¨é‡Šæºä»£ç , æ¯ä¸ªå‡½æ•°çš„æ³¨é‡Šåæ±‡ç¼–.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸºäº perf.data ç”Ÿæˆå›¾è¡¨ç»Ÿè®¡, æ ·æœ¬è¡¨å’Œç«ç„°å›¾. </span></span><br><span class="line">$ ./report_html.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æºä»£ç . </span></span><br><span class="line">$ ./report_html.py --add_source_code --source_dirs path_of_SimpleperfExampleCpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ åæ±‡ç¼–. </span></span><br><span class="line">$ ./report_html.py --add_disassembly</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ åæ±‡ç¼–å¯èƒ½ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´. å› æ­¤, æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä»…ä¸ºé€‰å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ åæ±‡ç¼–. </span></span><br><span class="line">$ ./report_html.py --add_disassembly --binary_filter libgame.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºå±äºåŒ…åä¸º com.example.myapp çš„åº”ç”¨ç¨‹åºçš„äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ åæ±‡ç¼–å’Œæºä»£ç . </span></span><br><span class="line">$ ./report_html.py --add_source_code --add_disassembly --binary_filter com.example.myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># report_html.py æ¥å—å¤šä¸ªè®°å½•æ•°æ®æ–‡ä»¶. </span></span><br><span class="line">$ ./report_html.py -i perf1.data perf2.data</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯ä¸º SimpleperfExampleCpp ç”Ÿæˆ html åˆ†æç»“æœçš„ç¤ºä¾‹.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./app_profiler.py -p simpleperf.example.cpp</span><br><span class="line">./report_html.py --add_source_code --source_dirs path_of_SimpleperfExampleCpp --add_disassembly</span><br></pre></td></tr></table></figure>

<p>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç”Ÿæˆçš„ report.html å, æœ‰å‡ ä¸ªæ ‡ç­¾é¡µ:</p>
<p>ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µæ˜¯ &quot;Chart Statistics&quot;. æ‚¨å¯ä»¥ç‚¹å‡»é¥¼å›¾ä»¥æ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹, çº¿ç¨‹, åº“å’Œå‡½æ•°æ‰€æ¶ˆè€—çš„æ—¶é—´.</p>
<p>ç¬¬äºŒä¸ªæ ‡ç­¾é¡µæ˜¯ &quot;Sample Table&quot;. å®ƒæ˜¾ç¤ºæ¯ä¸ªå‡½æ•°æ‰€èŠ±è´¹çš„æ—¶é—´. é€šè¿‡ç‚¹å‡»è¡¨æ ¼ä¸­çš„ä¸€è¡Œ, æˆ‘ä»¬å¯ä»¥è·³è½¬åˆ°ä¸€ä¸ªåä¸º&quot;Function&quot;çš„æ–°æ ‡ç­¾é¡µ.</p>
<p>ç¬¬ä¸‰ä¸ªæ ‡ç­¾é¡µæ˜¯ &quot;Flamegraph&quot;. å®ƒæ˜¾ç¤ºäº†ç”± inferno ç”Ÿæˆçš„å›¾è¡¨.</p>
<p>ç¬¬å››ä¸ªæ ‡ç­¾é¡µæ˜¯ &quot;Function&quot;. åªæœ‰å½“ç”¨æˆ·ç‚¹å‡» &quot;Sample Table&quot; æ ‡ç­¾é¡µä¸­çš„ä¸€è¡Œæ—¶æ‰ä¼šå‡ºç°. å®ƒæ˜¾ç¤ºä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯, åŒ…æ‹¬:</p>
<ul>
<li>æ˜¾ç¤ºè¯¥å‡½æ•°è°ƒç”¨çš„å‡½æ•°çš„ç«ç„°å›¾.</li>
<li>æ˜¾ç¤ºè°ƒç”¨è¯¥å‡½æ•°çš„å‡½æ•°çš„ç«ç„°å›¾.</li>
<li>è¯¥å‡½æ•°çš„æ³¨é‡Šæºä»£ç . åªæœ‰åœ¨è¯¥å‡½æ•°æœ‰æºä»£ç æ–‡ä»¶æ—¶æ‰ä¼šå‡ºç°.</li>
<li>è¯¥å‡½æ•°çš„æ³¨é‡Šåæ±‡ç¼–. åªæœ‰åœ¨åŒ…å«è¯¥å‡½æ•°çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨æ—¶æ‰ä¼šå‡ºç°.</li>
</ul>
<h3 id="inferno"><a href="#inferno" class="headerlink" title="inferno"></a>inferno</h3><p>inferno æ˜¯ä¸€ä¸ªç”¨äºåœ¨ HTML æ–‡ä»¶ä¸­ç”Ÿæˆç«ç„°å›¾çš„å·¥å…·.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸºäº perf.data ç”Ÿæˆç«ç„°å›¾. </span></span><br><span class="line"><span class="comment"># åœ¨ Windows ä¸Š, ä½¿ç”¨ inferno.bat ä»£æ›¿ ./inferno.sh. </span></span><br><span class="line">$ ./inferno.sh -sc --record_file perf.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•ä¸€ä¸ªæœ¬åœ°ç¨‹åºå¹¶ç”Ÿæˆç«ç„°å›¾. </span></span><br><span class="line">$ ./inferno.sh -np surfaceflinger</span><br></pre></td></tr></table></figure>

<h3 id="purgatorio"><a href="#purgatorio" class="headerlink" title="purgatorio"></a>purgatorio</h3><p>purgatorio æ˜¯ä¸€ä¸ªå¯è§†åŒ–å·¥å…·, ç”¨äºæŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºæ ·æœ¬.</p>
<h3 id="pprof-proto-generator-py"><a href="#pprof-proto-generator-py" class="headerlink" title="pprof_proto_generator.py"></a>pprof_proto_generator.py</h3><p>å®ƒå°†åˆ†ææ•°æ®æ–‡ä»¶è½¬æ¢ä¸º pprof.proto æ ¼å¼, è¯¥æ ¼å¼ç”± pprof ä½¿ç”¨.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†å½“å‰ç›®å½•ä¸­çš„ perf.data è½¬æ¢ä¸º pprof.proto æ ¼å¼. </span></span><br><span class="line">$ ./pprof_proto_generator.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ PDF æ ¼å¼æ˜¾ç¤ºæŠ¥å‘Š. </span></span><br><span class="line">$ pprof -pdf pprof.profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ HTML æ ¼å¼æ˜¾ç¤ºæŠ¥å‘Š. è¦æ˜¾ç¤ºåæ±‡ç¼–, æ·»åŠ  --tools é€‰é¡¹, å¦‚: </span></span><br><span class="line"><span class="comment"># --tools=objdump:&lt;ndk_path&gt;/toolchains/llvm/prebuilt/linux-x86_64/aarch64-linux-android/bin</span></span><br><span class="line"><span class="comment"># è¦æ˜¾ç¤ºæ³¨é‡Šæºä»£ç æˆ–åæ±‡ç¼–, åœ¨è§†å›¾èœå•ä¸­é€‰æ‹© `top`, ç‚¹å‡»ä¸€ä¸ªå‡½æ•°å¹¶é€‰æ‹© `source` æˆ– `disassemble`. </span></span><br><span class="line">$ pprof -http=:8080 pprof.profile</span><br></pre></td></tr></table></figure>

<h3 id="gecko-profile-generator-py"><a href="#gecko-profile-generator-py" class="headerlink" title="gecko_profile_generator.py"></a>gecko_profile_generator.py</h3><p>å°† perf.data è½¬æ¢ä¸º Gecko Profile æ ¼å¼, è¯¥æ ¼å¼å¯è¢« <span class="exturl" data-url="aHR0cHM6Ly9wcm9maWxlci5maXJlZm94LmNvbS8=">https://profiler.firefox.com/<i class="fa fa-external-link-alt"></i></span> è¯»å–.</p>
<p>Firefox Profiler æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„é€šç”¨åˆ†æå™¨ UI, å¯ä»¥åœ¨ä»»ä½•æµè§ˆå™¨ (ä¸ä»…ä»…æ˜¯ Firefox) æœ¬åœ°è¿è¡Œ, å…·æœ‰:</p>
<ul>
<li>æ¯çº¿ç¨‹è½¨è¿¹</li>
<li>ç«ç„°å›¾</li>
<li>æœç´¢, èšç„¦äºç‰¹å®šçš„å †æ ˆ</li>
<li>æ—¶é—´åºåˆ—è§†å›¾, ä»¥æ—¶é—´æˆ³é¡ºåºæŸ¥çœ‹æ ·æœ¬</li>
<li>æŒ‰çº¿ç¨‹å’ŒæŒç»­æ—¶é—´è¿‡æ»¤</li>
</ul>
<p>ä½¿ç”¨æ–¹æ³•:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®°å½•åº”ç”¨ç¨‹åºçš„åˆ†ææ•°æ®</span></span><br><span class="line">$ ./app_profiler.py -p simpleperf.example.cpp</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æ¢å¹¶å‹ç¼©. </span></span><br><span class="line">$ ./gecko_profile_generator.py -i perf.data | gzip &gt; gecko-profile.json.gz</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ <span class="exturl" data-url="aHR0cHM6Ly9wcm9maWxlci5maXJlZm94LmNvbS8=">https://profiler.firefox.com/<i class="fa fa-external-link-alt"></i></span> ä¸­æ‰“å¼€ gecko-profile.json.gz.</p>
<h3 id="report-sample-py"><a href="#report-sample-py" class="headerlink" title="report_sample.py"></a>report_sample.py</h3><p>report_sample.py å°†åˆ†ææ•°æ®æ–‡ä»¶è½¬æ¢ä¸º linux-perf-tool è¾“å‡ºçš„ perf è„šæœ¬æ–‡æœ¬æ ¼å¼.</p>
<p>è¿™ç§æ ¼å¼å¯ä»¥å¯¼å…¥åˆ°:</p>
<ul>
<li>FlameGraph</li>
<li>Flamescope</li>
<li>Firefox Profiler, ä½†æ›´æ¨èä½¿ç”¨ gecko_profile_generator.py.</li>
<li>Speedscope</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†åˆ†ææ•°æ®è®°å½•åˆ° perf.data</span></span><br><span class="line">$ ./app_profiler.py &lt;args&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å½“å‰ç›®å½•ä¸­çš„ perf.data è½¬æ¢ä¸º FlameGraph ä½¿ç”¨çš„æ ¼å¼. </span></span><br><span class="line">$ ./report_sample.py --symfs binary_cache &gt;out.perf</span><br><span class="line"></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">$ FlameGraph/stackcollapse-perf.pl out.perf &gt;out.folded</span><br><span class="line">$ FlameGraph/flamegraph.pl out.folded &gt;a.svg</span><br></pre></td></tr></table></figure>

<h3 id="stackcollapse-py"><a href="#stackcollapse-py" class="headerlink" title="stackcollapse.py"></a>stackcollapse.py</h3><p>stackcollapse.py å°†åˆ†ææ•°æ®æ–‡ä»¶ (perf.data) è½¬æ¢ä¸º Brendan Gregg çš„  &quot;æŠ˜å å †æ ˆ&quot;  æ ¼å¼.</p>
<p>æŠ˜å å †æ ˆæ˜¯ä»¥åˆ†å·åˆ†éš”çš„å †æ ˆå¸§ (ä»æ ¹åˆ°å¶) , åè·Ÿåœ¨è¯¥å †æ ˆä¸­é‡‡æ ·çš„äº‹ä»¶è®¡æ•°çš„è¡Œ, ä¾‹å¦‚:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BusyThread;__start_thread;__pthread_start(void*);java.lang.Thread.run 17889729</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰ç›¸ä¼¼çš„å †æ ˆéƒ½è¢«èšåˆ, æ ·æœ¬æ—¶é—´æˆ³ä¸è¢«ä½¿ç”¨.</p>
<p>æŠ˜å å †æ ˆæ ¼å¼å¯è¢«ä»¥ä¸‹å·¥å…·è¯»å–:</p>
<ul>
<li>The FlameGraph toolkit</li>
<li>Inferno (FlameGraph çš„ Rust ç§»æ¤ç‰ˆ)</li>
<li>Speedscope</li>
</ul>
<p>ç¤ºä¾‹:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†åˆ†ææ•°æ®è®°å½•åˆ° perf.data</span></span><br><span class="line">$ ./app_profiler.py &lt;args&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¬æ¢ä¸ºæŠ˜å å †æ ˆæ ¼å¼</span></span><br><span class="line">$ ./stackcollapse.py --kernel --jit | gzip &gt; profile.folded.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ FlameGraph å¯è§†åŒ– Java å †æ ˆå’Œçº³ç§’æ—¶é—´</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/brendangregg/FlameGraph.git</span><br><span class="line">$ gunzip -c profile.folded.gz \</span><br><span class="line">    | FlameGraph/flamegraph.pl --color=java --countname=ns \</span><br><span class="line">    &gt; profile.svg</span><br></pre></td></tr></table></figure>

<h2 id="ä¸€äº›å·¥å…·åº“"><a href="#ä¸€äº›å·¥å…·åº“" class="headerlink" title="ä¸€äº›å·¥å…·åº“"></a>ä¸€äº›å·¥å…·åº“</h2><h3 id="simpleperf-report-lib-py"><a href="#simpleperf-report-lib-py" class="headerlink" title="simpleperf_report_lib.py"></a>simpleperf_report_lib.py</h3><p>simpleperf_report_lib.py æ˜¯ä¸€ä¸ªç”¨äºè§£æç”± record å‘½ä»¤ç”Ÿæˆçš„åˆ†ææ•°æ®æ–‡ä»¶çš„ Python åº“. å†…éƒ¨å®ƒä½¿ç”¨ libsimpleperf_report.so æ¥å®Œæˆå·¥ä½œ. é€šå¸¸, å¯¹äºæ¯ä¸ªåˆ†ææ•°æ®æ–‡ä»¶, æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª ReportLib å®ä¾‹, ä¼ é€’æ–‡ä»¶è·¯å¾„ (é€šè¿‡ SetRecordFile) . ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ GetNextSample() è¯»å–æ‰€æœ‰æ ·æœ¬. å¯¹äºæ¯ä¸ªæ ·æœ¬, æˆ‘ä»¬å¯ä»¥è¯»å–å…¶äº‹ä»¶ä¿¡æ¯ (é€šè¿‡ GetEventOfCurrentSample) , ç¬¦å·ä¿¡æ¯ (é€šè¿‡ GetSymbolOfCurrentSample) å’Œè°ƒç”¨é“¾ä¿¡æ¯ (é€šè¿‡ GetCallChainOfCurrentSample) . æˆ‘ä»¬è¿˜å¯ä»¥è·å–ä¸€äº›å…¨å±€ä¿¡æ¯, å¦‚è®°å½•é€‰é¡¹ (é€šè¿‡ GetRecordCmd) , è®¾å¤‡æ¶æ„ (é€šè¿‡ GetArch) å’Œå…ƒä¿¡æ¯å­—ç¬¦ä¸² (é€šè¿‡ MetaInfo) .</p>
<p>ä½¿ç”¨ simpleperf_report_lib.py çš„ç¤ºä¾‹å¯ä»¥åœ¨ report_sample.py, report_html.py, pprof_proto_generator.py å’Œ inferno/inferno.py ä¸­æ‰¾åˆ°.</p>
<h3 id="ipc-py"><a href="#ipc-py" class="headerlink" title="ipc.py"></a>ipc.py</h3><p>ipc.py æ•è·ç³»ç»Ÿåœ¨æŒ‡å®šæŒç»­æ—¶é—´å†…çš„æ¯å‘¨æœŸæŒ‡ä»¤æ•° (IPC) .</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./ipc.py</span><br><span class="line">./ipc.py 2 20          <span class="comment"># è®¾ç½®é—´éš”ä¸º2ç§’, æ€»æŒç»­æ—¶é—´ä¸º20ç§’</span></span><br><span class="line">./ipc.py -p 284 -C 4   <span class="comment"># ä»…åœ¨æ ¸4ä¸Šåˆ†æPID 284</span></span><br><span class="line">./ipc.py -c <span class="string">&#x27;sleep 5&#x27;</span>  <span class="comment"># ä»…åˆ†æè¿è¡Œçš„å‘½ä»¤</span></span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">K_CYCLES   K_INSTR      IPC</span><br><span class="line">36840      14138       0.38</span><br><span class="line">70701      27743       0.39</span><br><span class="line">104562     41350       0.40</span><br><span class="line">138264     54916       0.40</span><br></pre></td></tr></table></figure>

<h3 id="sample-filter-py"><a href="#sample-filter-py" class="headerlink" title="sample_filter.py"></a>sample_filter.py</h3><p>sample_filter.py æ ¹æ® <span class="exturl" data-url="aHR0cHM6Ly9hbmRyb2lkLmdvb2dsZXNvdXJjZS5jb20vcGxhdGZvcm0vc3lzdGVtL2V4dHJhcy8rL3JlZnMvaGVhZHMvbWFpbi9zaW1wbGVwZXJmL2RvYy9zYW1wbGVfZmlsdGVyLm1k">sample_filter.md<i class="fa fa-external-link-alt"></i></span> ä¸­çš„æ–‡æ¡£ç”Ÿæˆæ ·æœ¬è¿‡æ»¤å™¨æ–‡ä»¶. è¿è¡ŒæŠ¥å‘Šè„šæœ¬æ—¶, å¯ä»¥é€šè¿‡ <code>--filter-file</code> é€‰é¡¹ä¼ é€’è¿‡æ»¤å™¨æ–‡ä»¶.</p>
<p>ä¾‹å¦‚, å®ƒå¯ä»¥ç”¨äºå°†ä¸€ä¸ªå¤§å‹è®°å½•æ–‡ä»¶æ‹†åˆ†ä¸ºå¤šä¸ªæŠ¥å‘Šæ–‡ä»¶.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sample_filter.py -i perf.data --split-time-range 2 -o sample_filter</span><br><span class="line">$ gecko_profile_generator.py -i perf.data --filter-file sample_filter_part1 \</span><br><span class="line">    | gzip &gt;profile-part1.json.gz</span><br><span class="line">$ gecko_profile_generator.py -i perf.data --filter-file sample_filter_part2 \</span><br><span class="line">    | gzip &gt;profile-part2.json.gz</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>Simpleperf</tag>
        <tag>Android</tag>
        <tag>å®‰å“æ€§èƒ½åˆ†æ</tag>
      </tags>
  </entry>
  <entry>
    <title>SM9 æ–‡æ¡£é˜…è¯»ç¬”è®°</title>
    <url>//posts/2023/12/15/sm9/</url>
    <content><![CDATA[<p>æœ¬æ–‡è®°å½•è‡ªå·±åœ¨å­¦ä¹ å®ç° SM9 ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸ªäººç†è§£. ç”±äºå®ç°ä¹‹å‰æ²¡æœ‰ç³»ç»Ÿå­¦ä¹ è¿‡ SM9 æ¶‰åŠçš„ç›¸å…³æ•°å­¦çŸ¥è¯†, å› æ­¤è¸©äº†è®¸å¤šå‘, ç‰¹æ­¤è®°å½•.</p>
<p>ä¸»è¦æ˜¯ä¸€äº›å…³é”®æ€§æ•°å­¦æ¦‚å¿µçš„ç†è§£, ä»¥åŠä¸€äº›ç®€å•çš„ä¼˜åŒ–æŠ€å·§.</p>
<span id="more"></span>

<h2 id="æ‰©åŸŸè¿ç®—"><a href="#æ‰©åŸŸè¿ç®—" class="headerlink" title="æ‰©åŸŸè¿ç®—"></a>æ‰©åŸŸè¿ç®—</h2><p>åœ¨ SM9 ä¸­, æŒ‰å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ‰©åŸŸè¿ç®—:</p>
<p>$F_{q^{12}}$ çš„ $1\text{-}2\text{-}4\text{-}12$ å¡”å¼æ‰©å¼ :</p>
<p>$$<br>\begin{align*}<br>  &amp; F_{q^{2}}[u] = F_{q}[u]/(u^2 - \alpha), &amp;&amp; \alpha = -2 \\<br>  &amp; F_{q^{4}}[v] = F_{q^{2}}[v]/(v^2 - \xi), &amp;&amp; \xi = u \\<br>  &amp; F_{q^{12}}[w] = F_{q^{4}}[w]/(w^3 - v), &amp;&amp; v^2 = \xi<br>\end{align*}<br>$$</p>
<p>å…¶ä¸­, ç¬¬ä¸€æ¬¡çš„ 2 æ¬¡æ‰©å¼ çº¦åŒ–å¤šé¡¹å¼ä¸º: $x^2 - \alpha, \alpha=-2$;</p>
<p>ç¬¬äºŒæ¬¡è¿›è¡Œ 2 æ¬¡æ‰©å¼ çš„çº¦åŒ–å¤šé¡¹å¼ä¸º: $x^2 - u, u^2 = \alpha, u = \sqrt{-2}$;</p>
<p>ç¬¬ä¸‰æ¬¡è¿›è¡Œ 3 æ¬¡æ‰©å¼ çš„çº¦åŒ–å¤šé¡¹å¼ä¸º: $x^3-v, v^2=u, v = \sqrt{\sqrt{-2}}$.</p>
<p>$u$ å±äº $F_{q^{2}}$, è¡¨ç¤ºä¸º $(1, 0)$.</p>
<p>$v$ å±äº $F_{q^{4}}$, è¡¨ç¤ºä¸º $(0, 1, 0, 0)$, ä¹Ÿå¯ä»¥ç”¨ $F_{q^{2}}$ å…ƒç´ è¡¨ç¤ºä¸º $((0, 1), (0, 0))$.</p>
<p>æ‰©åŸŸè¿™ä¸ªæ¦‚å¿µå¯ä»¥ç±»æ¯”ä¸­å­¦å­¦è¿‡çš„ &quot;å¤æ•°&quot;, $ai + b$, å°†å®æ•°åŸŸæ‰©å±•åˆ°äº†å¤æ•°åŸŸ, è¿™é‡Œé¢çš„ $i$ æ˜¯ $\sqrt{-1}$.</p>
<p>æ‰©å±•åçš„åŸŸå…ƒç´ å¯ä»¥ç”¨æ‰©å±•å‰çš„åŸŸå…ƒç´ æ¥è¿›è¡Œè¡¨ç¤º, è¿™é‡Œé¢ $a$ å’Œ $b$ éƒ½æ˜¯å®æ•°åŸŸ, è€Œ $ai + b$ åˆ™æ˜¯å¤æ•°åŸŸ.</p>
<p>å› æ­¤ SM9 ä¸­å°† $F_{q}$ çš„å…ƒç´ æœ€é«˜æ‰©å±•åˆ°äº† $F_{q^{12}}$ ä¸Š, ä¹Ÿå°±æ˜¯ä»åŸæœ¬çš„ 1 é¡¹å˜æˆäº† 12 é¡¹. å¹¶ä¸”éœ€è¦æ³¨æ„æ‰©åŸŸå…ƒç´ çš„ä¹¦å†™æ–¹å¼.</p>
<p>ä¾‹å¦‚ $F_{q^{4}}$ ä¸Šæˆ‘ä»¬éœ€è¦æŒ‰ $F_{q^{2 \times 2}}$ æ¥ç†è§£, ä¹Ÿå°±æ˜¯åœ¨ $F_{q^{2}}$ ä¸Šè¿›è¡Œäº† 1 æ¬¡ 2 æ¬¡æ‰©å¼ , è¿™æ ·æ‰©åŸŸåçš„å…ƒç´ ç”¨ $F_{q^{2}}$ ä¸Šçš„å…ƒç´ è¡¨ç¤º, <strong>è€Œä¸æ˜¯</strong>ç®€å•çš„ç”¨ $F_{q}$ è¿›è¡Œè¡¨ç¤º, ä¸¤è€…ä¹‹é—´éœ€è¦è¿›è¡Œè½¬æ¢.</p>
<p>å…·ä½“æ¥è¯´å¯ä»¥æ ¹æ®æ‰©åŸŸå…ƒç´  $u$, $v$ å’Œ $w$ æ¥è¿›è¡Œè½¬æ¢è®¡ç®—, åœ¨ SM9 ä¸­æ‰©åŸŸå…ƒç´ ä½¿ç”¨å¤šé¡¹å¼è¿›è¡Œè¡¨ç¤º, ä¸‰è€…ä¹‹é—´å­˜åœ¨å¦‚ä¸‹å…³ç³».</p>
<p>$$<br>\begin{align*}<br>  \alpha = u^2 = (v^2)^2 = ((w^3)^2)^2<br>\end{align*}<br>$$</p>
<p>å› æ­¤æœ‰:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  w &amp;= \alpha^\frac{1}{12} \\<br>  v &amp;= \alpha^\frac{1}{6} = w^2 \\<br>  u &amp;= \alpha^\frac{1}{2} = w^6<br>\end{align*}<br>\right.<br>$$</p>
<p>æ‰€ä»¥å¡”å¼æ‰©å¼ ä¸‹ä¸€ä¸ª $F_{q^{12}}$ ä¸Šçš„åŸŸå…ƒç´  $X_{F_{q^{12}}}$ å¯ä»¥è¢«è¡¨ç¤ºä¸º:</p>
<p>$$<br>\begin{align*}<br>  X &amp;= Aw^2 + Bw + C \\<br>  ~ &amp;= (a_1v + a_0)w^2 + (b_1v + b_0)w + (c_1v + c_0) \\<br>  ~ &amp;= ((a_{11}u + a_{10})v + (a_{01}u + a_{00}))w^2 + ((b_{11}u + b_{10})v + (b_{01}u + b_{00}))w + ((c_{11}u + c_{10})v + (c_{01}u + c_{00})) \\<br>  ~ &amp;= a_{11}uvw^2 + a_{10}vw^2 + a_{01}uw^2 + a_{00}w^2 + b_{11}uvw + b_{10}vw + b_{01}uw + b_{00}w + c_{11}uv + c_{10}v + c_{01}u + c_{00} \\<br>  ~ &amp;= a_{11}w^{11} + a_{10}w^5 + a_{01}w^8 + a_{00}w^2 + b_{11}w^{10} + b_{10}w^4 + b_{01}w^7 + b_{00}w + c_{11}w^9 + c_{10}w^3 + c_{01}w^6 + c_{00} \\<br>  ~ &amp;= (((a_{11}, a_{10}), (a_{01}, a_{00})), ((b_{11}, b_{10}), (b_{01}, b_{00})), ((c_{11}, c_{10}), (c_{01}, c_{00}))) \\<br>  ~ &amp;= (a_{11}, b_{11}, c_{11}, a_{01}, b_{01}, c_{01}, a_{10}, b_{10}, c_{10}, a_{00}, b_{00}, c_{00})<br>\end{align*}<br>$$</p>
<p>å¹‚æ¬¡ä¸ç³»æ•°è½¬æ¢å…³ç³»å¦‚ä¸‹:</p>
<p>$$<br>\begin{align*}<br>&amp;(  &amp;11&amp;, &amp;10&amp;,    &amp;9&amp;,  &amp;8&amp;,      &amp;7&amp;,  &amp;6&amp;,    &amp;5&amp;,  &amp;4&amp;,      &amp;3&amp;,  &amp;2&amp;,    &amp;1&amp;,  &amp;0&amp;  &amp;) \\<br>&amp;(((&amp;11&amp;,  &amp;5&amp;), ( &amp;8&amp;,  &amp;2&amp;)), ((&amp;10&amp;,  &amp;4&amp;), ( &amp;7&amp;,  &amp;1&amp;)), (( &amp;9&amp;,  &amp;3&amp;), ( &amp;6&amp;,  &amp;0&amp;))&amp;)<br>\end{align*}<br>$$</p>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹, å¦‚æœé‡‡ç”¨ç¬¬äºŒç§æ–¹å¼è¡¨ç¤ºæ‰©åŸŸå…ƒç´ , åœ¨éœ€è¦å°†ä½ç»´å…ƒç´ ç›´æ¥æ‰©å±•æˆé«˜ç»´å…ƒç´ æ—¶, ä½ç»´å…ƒç´ ä¿ç•™åœ¨å³ä¾§, å·¦ä¾§éƒ¨åˆ†ç½®é›¶.</p>
<h2 id="BN-æ›²çº¿ä¸Š-R-ate-å¯¹çš„è®¡ç®—"><a href="#BN-æ›²çº¿ä¸Š-R-ate-å¯¹çš„è®¡ç®—" class="headerlink" title="BN æ›²çº¿ä¸Š R-ate å¯¹çš„è®¡ç®—"></a>BN æ›²çº¿ä¸Š R-ate å¯¹çš„è®¡ç®—</h2><h3 id="æ¶‰åŠçš„ç¾¤"><a href="#æ¶‰åŠçš„ç¾¤" class="headerlink" title="æ¶‰åŠçš„ç¾¤"></a>æ¶‰åŠçš„ç¾¤</h3><p>SM9 çš„åŒçº¿æ€§å¯¹æ¶‰åŠä¸‰ä¸ªç¾¤çš„è¿ç®—, $\mathbb{G}_1$, $\mathbb{G}_2$ å’Œ $\mathbb{G}_T$.</p>
<p>å…¶ä¸­ $\mathbb{G}_1$, $\mathbb{G}_2$ åˆ†åˆ«æ˜¯ $F_{q}$, $F_{q^2}$ <strong>æ¤­åœ†æ›²çº¿ä¸Šçš„ç‚¹ç¾¤</strong>, è€Œ $\mathbb{G}_T$ æ˜¯ $F_{q^{12}}$ ä¸Šçš„<strong>åŸŸå…ƒç´ ç¾¤</strong>.</p>
<h3 id="æ‰­æ›²çº¿"><a href="#æ‰­æ›²çº¿" class="headerlink" title="æ‰­æ›²çº¿"></a>æ‰­æ›²çº¿</h3><p>R-ate å¯¹çš„è®¡ç®—ä¸º $f = R_a(P, Q)$, å…¶ä¸­ $P \in E(F_{q}), Q \in E&#39;(F_{q^2}), f \in F_{q^{12}}$.</p>
<p>è¿™é‡Œè¾“å…¥çš„ $Q$ åŸæœ¬åº”è¯¥æ˜¯ $E(F_{q^{12}})$ ä¸Šçš„å…ƒç´ , ä½†æ˜¯ BN æ›²çº¿å­˜åœ¨ä¸€æ¡æ‰­æ›²çº¿ $E&#39;(F_{q^2})$, èƒ½å¤Ÿå°†åŸæœ¬éœ€è¦åœ¨ $F_{q^{12}}$ ä¸Šè¿›è¡Œçš„æ¤­åœ†æ›²çº¿ç‚¹è¿ç®—è½¬æ¢åˆ° $F_{q^2}$ ä¸Šçš„æ¤­åœ†æ›²çº¿è¿›è¡Œ, ä»è€Œé™ä½è®¡ç®—é‡.</p>
<p>è½¬æ¢å‡½æ•°ä¸æ‰­æ›²çº¿å‚æ•° $\beta$ æœ‰å…³, è®°ä¸º $\phi: E&#39; \rightarrow E: (x, y) \mapsto (\frac{x}{\beta^{\frac{1}{3}}}, \frac{y}{\beta^{\frac{1}{2}}})$.</p>
<p>æ‰€ä»¥, åœ¨ R-ate å¯¹çš„è®¡ç®—è¿‡ç¨‹ä¸­, å¯¹äºéœ€è¦ $Q$ çš„è¿ç®—ä¸­, <strong>åªæœ‰æ¤­åœ†æ›²çº¿ä¸Šçš„ç‚¹è¿ç®—æ˜¯ç›´æ¥ä½¿ç”¨ $Q$ è¿›è¡Œè®¡ç®—çš„</strong>, å…¶ä½™è®¡ç®—éƒ½éœ€è¦å…ˆå°† $Q$ ä½¿ç”¨ $\phi$ å‡½æ•°è½¬æ¢åˆ° $E(F_{q^{12}})$ ä¸Šå†è¿›è¡Œè®¡ç®—.</p>
<h3 id="R-ate-è®¡ç®—"><a href="#R-ate-è®¡ç®—" class="headerlink" title="R-ate è®¡ç®—"></a>R-ate è®¡ç®—</h3><p>é™¤äº†å¯¹ $Q$ è¿›è¡Œç‚¹è¿ç®—æ—¶åœ¨ $F_{q^2}$ ä¸Šè¿›è¡Œ, å…¶ä½™çš„è®¡ç®—éƒ½åœ¨ $F_{q^{12}}$ ä¸Šè¿›è¡Œ.</p>
<p>ä¾‹å¦‚è®¡ç®— $g$ å‡½æ•°æ—¶, æ­£ç¡®çš„åšæ³•æ˜¯è®¡ç®— $g_{\phi(T), \phi(T)}(P&#39;)$ å’Œ $g_{\phi(T), \phi(Q)}(P&#39;)$, å…¶ä¸­ $P&#39;$ æ˜¯å°† $P$ ç›´æ¥æ‰©å±•åˆ° $E(F_{q^{12}})$ çš„ç‚¹.</p>
<p>ä»¥åŠåé¢è®¡ç®— Frobenius è‡ªåŒæ€çš„ $\pi_q$ å’Œ $\pi_{q^2}$ æ—¶, éœ€è¦è¿›è¡Œè½¬æ¢è®¡ç®— $Q_1 = \phi^{-1}(\pi_q(\phi(Q)))$ å’Œ $Q_2 = \phi^{-1}(\pi_{q^2}(\phi(Q)))$.</p>
<h2 id="Frobenius-ä¼˜åŒ–"><a href="#Frobenius-ä¼˜åŒ–" class="headerlink" title="Frobenius ä¼˜åŒ–"></a>Frobenius ä¼˜åŒ–</h2><p>Frobenius è¿ç®—å®šä¹‰ä¸º: $\pi_q(x, y) = (x^q, y^q)$, å…¶ä¸­ $x, y$ å¯ä»¥æ˜¯æ‰©åŸŸä¸Šçš„å…ƒç´ .</p>
<p>è®¾ $x = a_nx^n + a_{n-1}x^{n-1} + \cdots + a_1$, åˆ™:</p>
<p>$$<br>\begin{align*}<br>  x^q &amp;= (a_nx_n + a_{n-1}x_{n-1} + \cdots + a_1)^q \\<br>  ~ &amp;= \sum{(C_{q}^{i}C_{q-i}^{j}C_{q-i-j}^{k} \cdots )(a_nx_n)^i(a_{n-1}x_{n-1})^j(a_{n-2}x_{n-2})^k \cdots}<br>\end{align*}<br>$$</p>
<p>å½“ $q$ ä¸ºç´ æ•°æ—¶, ç”±è´¹é©¬å°å®šç†å¯ä»¥çŸ¥é“ $a^{q} \equiv a \mod q$, ä¸”å½“ $(C_{q}^{i}C_{q-i}^{j}C_{q-i-j}^{k} \cdots )$ ä¸ä¸º 1 æ—¶å¿…ä¸º $q$ çš„å€æ•° (è¢« $q$ æ•´é™¤).</p>
<p>æ‰€ä»¥åœ¨è¿›è¡Œæ¨¡ $q$ è¿ç®—å, $x^q = a_nx_n^q + a_{n-1}x_{n-1}^q + \cdots + a_1$.</p>
<p>å¯ä»¥çœ‹å‡ºæ¥ Frobenius è¿ç®—å°±æ˜¯åœ¨åŸæœ‰çš„ç³»æ•°ä¸Šä¹˜ä¸Šäº†ä¸€ä¸ªå¯¹åº”å…ƒç´ çš„ $q$ æ¬¡æ–¹, åœ¨æ‰©åŸŸå…ƒç´ ç¡®å®šçš„æƒ…å†µä¸‹, è¿™äº›å€¼æ˜¯å¯ä»¥è¢«æå‰è®¡ç®—å‡ºæ¥çš„, å› æ­¤å°†ä¼šè¢«ç®€åŒ–æˆ $n$ æ¬¡æ‰©åŸŸä¹˜æ³•å’Œ $n - 1$ æ¬¡æ‰©åŸŸåŠ æ³•.</p>
<p>è¿›ä¸€æ­¥, ç”±æ–‡çŒ® <span class="exturl" data-url="aHR0cHM6Ly9kb2kub3JnLzEwLjExMDkvSUNDU0QuMjAxOS44ODQyOTA4">Simplification and Hardware Parallel Design of Frobenius Mapping Algorithm Based on SM9<i class="fa fa-external-link-alt"></i></span> å¯ä»¥å¾—åˆ°é’ˆå¯¹ SM9 å‚æ•°çš„ç‰¹å®šä¼˜åŒ–ç­–ç•¥, å³æ¯ä¸€é¡¹å‰é¢ä»…ä»…æ˜¯ä¹˜äº†ä¸€ä¸ªå¸¸æ•°, æ‰€ä»¥å¯ä»¥å°†å¸¸æ•°å€¼å…¨éƒ¨è¿›è¡Œé¢„è®¡ç®—ä»è€Œæé«˜åç»­è®¡ç®—é€Ÿåº¦, æ­¤æ—¶åªéœ€è¦ $n - 1$ æ¬¡ $F_{q}$ ä¸Šçš„ä¹˜æ³•å°±èƒ½å®Œæˆè¿ç®—.</p>
<h2 id="FinalExp-ä¼˜åŒ–"><a href="#FinalExp-ä¼˜åŒ–" class="headerlink" title="FinalExp ä¼˜åŒ–"></a>FinalExp ä¼˜åŒ–</h2><p>åœ¨ R-ate å¯¹è®¡ç®—çš„æœ€å, æœ‰ä¸€æ­¥ $f = f^{\frac{q^{12} - 1}{r}}$.</p>
<p>è¿™æ˜¯ä¸€æ­¥åœ¨ $F_{q^{12}}$ ä¸Šçš„æŒ‡æ•°è¿ç®—, å¹¶ä¸”æŒ‡æ•°éå¸¸å¤§, å¸¸è§„è¿ç®—æ—¶é—´å¼€é”€éå¸¸å¤¸å¼ . ç”±æ–‡çŒ® <span class="exturl" data-url="aHR0cHM6Ly9kb2kub3JnLzEwLjEwMDcvOTc4LTMtNjQyLTAzMjk4LTFfNg==">On the Final Exponentiation for Calculating Pairings on Ordinary Elliptic Curves<i class="fa fa-external-link-alt"></i></span> å¯ä»¥å¾—åˆ°å¯¹ BN æ›²çº¿çš„ç‰¹å®šä¼˜åŒ–:</p>
<p>$$<br>\frac{q^{12} - 1}{r} = (q^6 - 1)(q^2 + 1)(\frac{q^4 - q^2 + 1}{r})<br>$$</p>
<p>å‰åŠéƒ¨åˆ†çš„ $(q^6 - 1)(q^2 + 1)$ ç§°ä¸º &quot;ç®€å•éƒ¨åˆ†&quot;, å› ä¸ºå¯ä»¥é€šè¿‡ Frobenius å’Œæ¨¡é€†è¿ç®—å¿«é€Ÿå¾—åˆ°ç»“æœ (å¹¶ä¸” $q^6$ å¯ä»¥ä»…é€šè¿‡å…±è½­å’Œå–è´Ÿå¾—åˆ°ç»“æœ).</p>
<p>ååŠéƒ¨åˆ†çš„ $\frac{q^4 - q^2 + 1}{r}$ ç§°ä¸º &quot;å›°éš¾éƒ¨åˆ†&quot;, æ–‡çŒ®ä¸­æ ¹æ® BN æ›²çº¿ $q$ å’Œ $r$ å…³äº $t$ çš„è¡¨è¾¾å¼ç»§ç»­åˆ†è§£å¾—åˆ°:</p>
<p>$$<br>\frac{q^4 - q^2 + 1}{r} = \lambda_3q^3 + \lambda_2q^2 + \lambda_1q + \lambda<br>$$</p>
<p>å…¶ä¸­:</p>
<p>$$<br>\left\{<br>\begin{align*}<br>  \lambda_3 &amp;= 1 \\<br>  \lambda_2 &amp;= 6t^2 + 1 \\<br>  \lambda_1 &amp;= -36t^3 - 18t^2 - 12t + 1 \\<br>  \lambda_0 &amp;= -36t^3 - 30t^2 - 18t - 2<br>\end{align*}<br>\right.<br>$$</p>
<p>å› æ­¤å›°éš¾éƒ¨åˆ†çš„æŒ‡æ•°å¯ä»¥è¡¨ç¤ºä¸º:</p>
<p>$$<br>\begin{align*}<br>  \frac{q^4 - q^2 + 1}{r} = (6t^2q^2 + q^3 + q^2 + q) - (36(t^3 + t^3q) + 30t^2 + 18(t^2q + t) + 12tq + 2)<br>\end{align*}<br>$$</p>
<p>æ‹¬å·å†…åªéœ€è¦ä¾æ¬¡ç®—å‡ºå’Œ $t, q$ æœ‰å…³çš„ $f$ æŒ‡æ•°è¿ç®—ç»“æœå³å¯, å¹¶ä¸” $q$ å¯ä»¥ç”¨ Frobenius è¿ç®—å¾—åˆ°, æœ€åè´Ÿå·çš„å†…å®¹ä¸€èµ·æ±‚ä¸€æ¬¡é€†å°±è¡Œ.</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>èŠ±äº†ä¸€ç‚¹ç¯‡å¹…è®°å½•äº†ä¸€ä¸‹è‡ªå·±åœ¨å®ç° SM9 ç®—æ³•ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³è¿‡ç¨‹, ç»™è‡ªå·±è¡¥å……äº†å¾ˆå¤šåŸºç¡€çš„å¯†ç å­¦çŸ¥è¯†, å¾ˆå¤šå†…å®¹å¯¹äºé¢†åŸŸå†…äººæ¥è¯´æ˜¯åŸºç¡€ä¸­çš„åŸºç¡€, ä½†æ˜¯åˆè§è¿˜æ˜¯å®¹æ˜“è®©äººæ™•å¤´è½¬å‘.</p>
<p>å…³äº SM9 çš„ä¼˜åŒ–æ–¹æ³•è¿˜æœ‰å¾ˆå¤š, è¿™é‡Œåªç®€å•æäº†ä¸€äº›, è‡ªå·±å®ç°çš„æ—¶å€™ä¹Ÿæ˜¯å°½å¯èƒ½çš„åŠ è¿›å»èƒ½çœ‹æ‡‚çš„ä¼˜åŒ–æ–¹æ³•äº†<del>æ¯•ç«Ÿæ²¡ä¸“é—¨ç ”ç©¶è¿™æ–¹é¢, ä¸èƒ½ä¸€ä¸Šæ¥å°±æŒ‘æˆ˜åœ°ç‹±éš¾åº¦å‰¯æœ¬</del>.</p>
<p>å®ç°è¿‡ç¨‹ä¸­ä¹Ÿå‚è€ƒäº†å¼€æºçš„å›½å¯†åº“ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2d1YW56aGkvR21TU0w=">GmSSL<i class="fa fa-external-link-alt"></i></span>, æ¯•ç«Ÿè°ƒè¯•çš„æ—¶å€™æ²¡æœ‰æ ‡å‡†ç­”æ¡ˆçœŸçš„å¾ˆç—›è‹¦.</p>
<p>æœ€åæ”¾ä¸Šè‡ªå·±å®ç°çš„å›½å¯†ç®—æ³•åº“ <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3d3LXJtL2dtYWxn">gmalg<i class="fa fa-external-link-alt"></i></span>, ä¸€ä¸ªä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“çº¯ Python å®ç°çš„å›½å¯†ç®—æ³•åº“, å°±ä¸è€ƒè™‘æ€§èƒ½äº†, ä¸»è¦æ˜¯å­¦ä¹ å›½å¯†ç®—æ³•åŸç†<del>èƒ½ç”¨å°±è¡Œ</del>.</p>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>SM9</tag>
        <tag>åŒçº¿æ€§å¯¹</tag>
        <tag>R-ate</tag>
        <tag>Frobenius</tag>
        <tag>FinalExp</tag>
      </tags>
  </entry>
  <entry>
    <title>Transformer çš„è®­ç»ƒä¸æ¨ç†</title>
    <url>//posts/2023/08/29/transformer/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ Transformer è®­ç»ƒå’Œé¢„æµ‹è¿‡ç¨‹çš„ä¸€äº›ç»†èŠ‚ç†è§£è®°å½•, åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9qYWxhbW1hci5naXRodWIuaW8vaWxsdXN0cmF0ZWQtdHJhbnNmb3JtZXIv">The Illustrated Transformer<i class="fa fa-external-link-alt"></i></span>, æœ¬æ–‡å†…ç¬¦å·ä¹Ÿæ²¿ç”¨æ­¤æ–‡.</p>
<p>ä¸»è¦æ˜¯å¯¹äº Decoder éƒ¨åˆ†è®­ç»ƒå’Œé¢„æµ‹æ—¶çš„åŒºåˆ«ä»¥åŠå¹¶è¡ŒåŒ–åŸç†çš„æ€»ç»“.</p>
<span id="more"></span>

<h2 id="æ•°æ®æµåŠ¨å›é¡¾"><a href="#æ•°æ®æµåŠ¨å›é¡¾" class="headerlink" title="æ•°æ®æµåŠ¨å›é¡¾"></a>æ•°æ®æµåŠ¨å›é¡¾</h2><p><img data-src="https://jalammar.github.io/images/t/transformer_resideual_layer_norm_3.png" alt="framework"></p>
<p>è¿™å¼ å›¾æ˜¯ä¸€ä¸ªç®€ç•¥çš„ Transformer æ•´ä½“æ¡†æ¶å›¾.</p>
<p>å¯¹äº Encoder éƒ¨åˆ†, è¾“å…¥æ˜¯ <code>(B, T, E)</code> çš„å½¢çŠ¶, å…¶ä¸­ <code>B</code> æ˜¯æ‰¹å¤§å°, <code>T</code> æ˜¯æœ€å¤§å¥é•¿, <code>E</code> æ˜¯è¯å‘é‡é•¿åº¦; è¾“å‡ºå½¢çŠ¶å’Œè¾“å…¥ç›¸åŒ, ä¹Ÿæ˜¯ <code>(B, T, E)</code>, å¹¶ä¸”è¿™åŒä¸€ä»½æ•°æ®å¯¹åº”æ¥ä¸‹æ¥ Decoder å…¶ä¸­ä¸€å±‚æ³¨æ„åŠ›çš„ <code>Key</code> å’Œ <code>Value</code> è¾“å…¥.</p>
<p>è€Œå¯¹äº Decoder éƒ¨åˆ†, åŒæ ·è®¾è¾“å…¥å½¢çŠ¶æ˜¯ <code>(B, T, E)</code>, é‚£ä¹ˆå®ƒçš„è¾“å‡ºå½¢çŠ¶ä¹Ÿæ˜¯å’Œè¾“å…¥å½¢çŠ¶ä¸€æ ·ä¸º <code>(B, T, E)</code>.</p>
<p>æœ€åçš„ Liner å’Œ Softmax åˆ™æ˜¯å°† Decoder çš„ <code>(B, T, E)</code> æ˜ å°„åˆ°è¯å…¸å¤§å°çš„æ¦‚ç‡çŸ©é˜µ <code>(B, T, vocab_size)</code>.</p>
<h2 id="è®­ç»ƒè¿‡ç¨‹"><a href="#è®­ç»ƒè¿‡ç¨‹" class="headerlink" title="è®­ç»ƒè¿‡ç¨‹"></a>è®­ç»ƒè¿‡ç¨‹</h2><p>Encoder éƒ¨åˆ†å¾ˆç®€å•, åœ¨è®­ç»ƒå’Œé¢„æµ‹ä¸Šæ²¡æœ‰ä»€ä¹ˆç†è§£ä¸Šçš„é—®é¢˜, ä¸»è¦æ˜¯ Decoder éƒ¨åˆ†æ˜¯å¦‚ä½•åšåˆ°å¹¶è¡ŒåŒ–çš„.</p>
<p>å‰é¢è¯´åˆ°, å¯¹äº Decoder è€Œè¨€, è¾“å…¥å’Œè¾“å‡ºçš„å½¢çŠ¶éƒ½æ˜¯ä¸€æ ·çš„ <code>(B, T, E)</code>, é‚£ä¹ˆé¦–å…ˆè¦çŸ¥é“çš„æ˜¯, æ­¤å¤„çš„å¹¶è¡ŒåŒ–, æ˜¯åœ¨è®­ç»ƒæ—¶å°†ä¸åŒæ—¶é—´æ­¥çš„è¾“å‡ºå¹¶è¡ŒåŒ–äº†.</p>
<p>å¯¹äº <code>t</code> ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥ $[x_0, x_1, \ldots, x_{t-1}]$, Decoder çš„è¾“å‡ºæ˜¯ $[y_1, y_2, \ldots, y_t]$, è€Œå®ƒä»¬çš„å¯¹åº”å…³ç³»å¦‚ä¸‹æ‰€ç¤º:</p>
<p>$$<br>\begin{bmatrix}<br>  x_0 &amp; ~ &amp; ~ &amp; ~ \\<br>  x_0 &amp; x_1 &amp; ~ &amp; ~ \\<br>  \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\<br>  x_0 &amp; x_1 &amp; \ldots &amp; x_{t-1}<br>\end{bmatrix} \Rightarrow \begin{bmatrix}<br>  y_1 \\<br>  y_2 \\<br>  \vdots \\<br>  y_t<br>\end{bmatrix}<br>$$</p>
<p>è€Œå®ç°è¿™ç§å¹¶è¡Œçš„å…³é”®æ˜¯ Masked-Attension, è¿™ä¸ªç½‘ä¸Šæœ‰å¾ˆå¤šä¸¾ä¾‹, ç®€å•æ¥è¯´å°±æ˜¯å¯¹äº $y_i$, é€šè¿‡ Mask è®©å®ƒåªåŒ…å«äº† $[x_0, x_1, \ldots, x_{i-1}]$ çš„ä¿¡æ¯.</p>
<p>æœ€åæŠŠè¿™ <code>t</code> ä¸ªæ—¶åˆ»çš„ä¸åŒé•¿åº¦çš„è¾“å…¥åºåˆ— &quot;å &quot; åœ¨ä¸€èµ·, å¾—åˆ°äº†ç­‰é•¿çš„ä¾æ¬¡æ’åœ¨ä¸€èµ·çš„ä¸åŒæ—¶åˆ»çš„è¾“å‡º.</p>
<h2 id="é¢„æµ‹è¿‡ç¨‹"><a href="#é¢„æµ‹è¿‡ç¨‹" class="headerlink" title="é¢„æµ‹è¿‡ç¨‹"></a>é¢„æµ‹è¿‡ç¨‹</h2><p>é€šè¿‡å‰é¢çš„è®­ç»ƒè¿‡ç¨‹å¯ä»¥çŸ¥é“, ä»åŸç†ä¸Šæ¥è¯´, è™½ç„¶ Decoder çš„è¾“å…¥å’Œè¾“å‡ºå½¢çŠ¶ç›¸åŒ, ä½†æ˜¯æ¯ä¸ªæ—¶é—´æ­¥çš„è¾“å…¥åºåˆ—åªæœ‰ä¸€ä¸ªè¾“å‡ºç¬¦å·, ä¹Ÿå°±æ˜¯é¢„æµ‹å‡ºæ¥çš„ä¸‹ä¸€ä¸ªè¾“å…¥ç¬¦å·, å› æ­¤ Decoder åœ¨é¢„æµ‹æ—¶, æ˜¯ä¸²è¡Œçš„å¾ªç¯è¿‡ç¨‹, ç›´åˆ°å‡ºç°ç»ˆæ­¢ç¬¦.</p>
<p><img data-src="https://jalammar.github.io/images/t/transformer_decoding_2.gif" alt="decoder"></p>
<p>é‚£ä¹ˆæ¥çœ‹è¿™å¼ å›¾, é¢„æµ‹æ—¶, Decoder ä¸€å¼€å§‹çš„è¾“å…¥ <code>(B, T, E)</code> é‡Œé¢, åªæœ‰ç¬¬ä¸€ä¸ªç¬¦å·æ˜¯æœ‰æ•ˆçš„, å¹¶ä¸”æ˜¯å¼€å§‹ç¬¦, éšåè¿›è¡Œé¢„æµ‹, å¾—åˆ°äº†è¾“å‡ºæ•°æ® <code>(B, T, E)</code>, ä½†æ˜¯åªéœ€è¦å–è¾“å‡ºçš„ç¬¬ä¸€ä¸ªç¬¦å·, å¹¶ä¸”ä¹Ÿåªæœ‰è¿™ä¸ªç¬¦å·æœ‰æ•ˆ, å®ƒå°†ä½œä¸ºä¸‹ä¸€ä¸ªè¦æ‹¼åœ¨è¾“å…¥åºåˆ—åé¢çš„ç¬¬äºŒä¸ªç¬¦å·.</p>
<p>éšåé‡å¤ä¸Šè¿°æ­¥éª¤, å¯¹äº <code>t</code> æ—¶åˆ»çš„æ“ä½œ, è¾“å…¥çš„ <code>(B, T, E)</code> å†…åªæœ‰å‰ <code>t</code> ä¸ªç¬¦å·æœ‰æ•ˆ, è€Œå¾—åˆ°è¾“å‡ºåºåˆ— <code>(B, T, E)</code> åä¹Ÿåªæœ‰å‰ <code>t</code> ä¸ªç¬¦å·æœ‰æ•ˆ, å¹¶ä¸”ç¬¬ <code>t</code> ä¸ªç¬¦å·å°±æ˜¯ä¸‹ä¸€ä¸ªè¦æ¥åœ¨è¾“å…¥åºåˆ—åçš„é¢„æµ‹ç¬¦å·, è€Œå‰ <code>t - 1</code> ä¸ªç¬¦å·å¯ä»¥å¿½ç•¥ä¸è¦, å› ä¸ºå®ƒå°±æ˜¯ä¹‹å‰å·²ç»ä½¿ç”¨è¿‡çš„å·²ç»æ”¾åœ¨è¾“å…¥åºåˆ—é‡Œçš„ç¬¦å· (å› ä¸ºç¬¬ <code>i</code> ä¸ªè¾“å‡ºç¬¦å·åªå—å‰ <code>i - 1</code> ä¸ªè¾“å…¥ç¬¦å·çš„å½±å“, å› æ­¤è¾“å…¥åºåˆ—å˜é•¿ä¹Ÿä¸å½±å“æ›¾ç»çš„è¾“å‡ºç¬¦å·ç»“æœ, åªæœ‰æœ€åçš„ç¬¬ <code>t</code> ä¸ªè¾“å‡ºç¬¦å·æ˜¯æ–°å†…å®¹).</p>
<p>å¾ªç¯æ•´ä¸ªè¿‡ç¨‹, ç›´åˆ°é‡è§ç»ˆæ­¢ç¬¦, å°±å¯ä»¥è§£ç å‡ºå®Œæ•´çš„é¢„æµ‹ç»“æœ.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9qYWxhbW1hci5naXRodWIuaW8vaWxsdXN0cmF0ZWQtdHJhbnNmb3JtZXIv">The Illustrated Transformer<i class="fa fa-external-link-alt"></i></span></li>
</ol>
]]></content>
      <categories>
        <category>é˜…è¯»ç¬”è®°</category>
      </categories>
      <tags>
        <tag>NLP</tag>
        <tag>Transformer</tag>
      </tags>
  </entry>
</search>
